<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Intelligence Dashboard</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #334155;
            line-height: 1.6;
            zoom: 0.9;
            min-height: 100vh;
        }

        /* Sidebar Navigation */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 111.11vh; /* Make sure sidebar takes full scaled height */
            min-height: 111.11vh;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            color: white;
            z-index: 1000;
            overflow-y: auto;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .nav-items {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem 0;
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid #334155;
        }

        .logo {
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 1.6rem;
            font-weight: 800;
            color: #fbbf24;
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
        }
        
        .logo::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60%;
            height: 2px;
            background: linear-gradient(90deg, #fbbf24 0%, transparent 100%);
            border-radius: 1px;
        }

        .tagline {
            font-size: 0.875rem;
            color: #94a3b8;
        }

        .nav-menu {
            padding: 1rem 0;
        }

        .nav-item {
            margin: 0.25rem 1rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.875rem 1rem;
            color: #cbd5e1;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s ease;
            position: relative;
        }

        .nav-link:hover {
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
            transform: translateX(4px);
        }

        .nav-link.active {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #1e293b;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
        }

        .nav-icon {
            width: 20px;
            margin-right: 0.75rem;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .top-bar {
            background: white;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .page-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: #64748b;
            font-size: 1rem;
        }

        .content-area {
            padding: 2rem;
        }

        /* Metrics Cards */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
            margin-top: 2rem;
        }
        
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            min-height: 140px;
            position: relative;
        }

        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }
        
        .metric-icon.revenue {
            background: linear-gradient(135deg, #059669, #10b981);
        }
        
        .metric-icon.opex {
            background: linear-gradient(135deg, #dc2626, #ef4444);
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .metric-header {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        .metric-top-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            margin-bottom: 1rem;
        }
        
        .metric-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .metric-title-section {
            /* Title stays at top */
            margin-bottom: auto; /* This pushes the values section to bottom */
        }

        .metric-values-section {
            margin-top: auto;
        }

        .metric-title, .metric-title-with-selector {
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748b;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
        }
        
        .metric-title-with-selector {
            margin: 0;
        }
        
        .metric-title-text {
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748b;
            letter-spacing: 0.5px;
        }

        .metric-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748b;
            letter-spacing: 0.5px;
        }

        .metric-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
            flex-shrink: 0;
            /* This keeps the icon at top-right */
        }
        
        .metric-icon::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0.3));
            border-radius: 10px;
            z-index: 0;
        }

        .metric-icon i {
            position: relative;
            z-index: 1;
        }

        .icon-cash { 
            background: linear-gradient(135deg, #059669 0%, #10b981 50%, #34d399 100%);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        .icon-ar { 
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .icon-revenue { 
            background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 50%, #a78bfa 100%);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        .icon-health { 
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 50%, #fcd34d 100%);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
        }
        
        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }
        
        .metric-change {
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .positive { color: #10b981; }
        .negative { color: #ef4444; }
        .neutral { color: #64748b; }


        /* Time Period Selector */
        .time-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .time-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e2e8f0;
            background: white;
            color: #64748b;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .time-btn.active {
            border-color: #fbbf24;
            background: #fbbf24;
            color: #1e293b;
        }

        .time-btn:hover:not(.active) {
            border-color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }

        /* Dashboard Sections */
        .dashboard-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 1.5rem 0;
            padding: 0;
        }

        .section-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .section-actions .btn {
            white-space: nowrap;
        }

        .section-icon {
            color: #3b82f6;
        }

        .section-summary {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }     

        .summary-amount {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .summary-change {
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .summary-change.positive {
            color: #059669;
        }
        
        .summary-change.negative {
            color: #dc2626;
        }

        /* Replace the previous breakdown CSS with this */
        .breakdown-analysis-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .analysis-section-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .analysis-header {
            background: white;
            padding: 1.5rem 2rem;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .analysis-chart-container {
            background: white;
            padding: 2rem;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .analysis-metrics-container {
            background: white;
            padding: 1.5rem 2rem;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .chart-header-simple {
            margin-bottom: 1.5rem;
        }
        
        .chart-header-simple h5 {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 0.25rem 0;
        }
        
        .chart-header-simple p {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0;
        }
        
        .analysis-header h4 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .metrics-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            padding: 1.5rem 2rem;
            border-top: 1px solid #e2e8f0;
        }

        .metric-item {
            text-align: center;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
        }

        .chart-area {
            padding: 1rem 2rem 2rem;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #1e293b;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Right-Side Chat Container */
        .chat-container-right {
            position: fixed;
            top: 0.5cm;
            right: 0.5cm;
            bottom: 0.5cm;
            width: 480px; /* Increased from 400px */
            z-index: 2000;
            transform: translateX(100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            visibility: hidden;
        }

        @media (max-width: 1400px) {
            .chat-container-right {
                width: 420px; /* Slightly smaller for medium screens */
            }
        }
        
        .chat-container-right.active {
            transform: translateX(0);
            opacity: 1;
            visibility: visible;
        }
        
        /* Add slide-out class for closing animation */
        .chat-container-right.closing {
            transform: translateX(100%);
            opacity: 0;
        }
        
        .chat-trigger-floating {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: none;
            border-radius: 50%;
            box-shadow: 0 8px 32px rgba(30, 41, 59, 0.4);
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .chat-trigger-floating:hover {
            transform: scale(1.1);
            background: linear-gradient(135deg, #334155 0%, #475569 100%);
            box-shadow: 0 12px 40px rgba(30, 41, 59, 0.6);
        }
        
        .chat-trigger-floating i {
            color: #fbbf24;
            font-size: 24px;
        }
        
        /* Chat Modal Overlay */
        .chat-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        
        .chat-modal-overlay.active {
            display: flex;
        }
        
        .chat-modal {
            width: 90%;
            max-width: 600px;
            height: 80vh;
            max-height: 700px;
            margin: auto;
            position: relative;
        }
        /* AI Chat Sidebar */
        .ai-assistant-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
            border: 1px solid #e2e8f0;
        }

        .chat-header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
            position: relative;
            padding-right: 3.5rem; /* Reduced padding for close button */
        }

        .chat-header-text {
            flex: 1; /* Take up available space */
        }

        .chat-close-btn {
            position: absolute;
            top: 50%;
            right: 1rem;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
            z-index: 10;
        }

        .chat-close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        @media (max-width: 1200px) {
            .chat-container-right {
                width: 380px;
            }
        }
        
        @media (max-width: 768px) {
            .chat-container-right {
                top: 0;
                right: 0;
                bottom: 0;
                left: 0;
                width: 100%;
                border-radius: 0;
            }
            
            .ai-assistant-section {
                border-radius: 0;
                height: 100vh;
            }
        }

        .chat-header-icon {
            width: 32px;
            height: 32px;
            background: #fbbf24;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1e293b;
            font-size: 14px;
        }

        .chat-header-text h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .chat-header-text p {
            margin: 0;
            font-size: 12px;
            opacity: 0.8;
        }

        .chat-status {
            position: absolute;
            top: 50%;
            right: 3.5rem; /* Position between text and close button */
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            display: flex;
            gap: 0.75rem;
            animation: messageSlideIn 0.3s ease-out;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .message.ai .message-avatar {
            background: #fbbf24;
            color: #1e293b;
        }

        .message.user .message-avatar {
            background: #1e293b;
            color: white;
        }

        .message-content {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.6;
        }

        .message.ai .message-content {
            background: white;
            color: #1e293b;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 4px;
        }

        .message.user .message-content {
            background: #1e293b;
            color: white;
            border-bottom-right-radius: 4px;
            font-weight: 500;
            letter-spacing: 0.2px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 0.25rem;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            border-bottom-left-radius: 4px;
            max-width: 80px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #94a3b8;
            border-radius: 50%;
            animation: typingPulse 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        .suggestions-container {
            padding: 1.5rem;
            background: linear-gradient(145deg, #f8fafc 0%, #f1f5f9 100%);
            border-top: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
        }

        .suggestions-title {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .suggestions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .suggestion-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            font-size: 12px;
            color: #475569;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .suggestion-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #fbbf24;
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .suggestion-item:hover {
            background: #fbbf24;
            border-color: #f59e0b;
            color: #1e293b;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
        }

        .suggestion-item:hover::before {
            transform: scaleY(1);
        }

        .chat-input-container {
            padding: 1rem;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            resize: none;
            font-size: 14px;
            line-height: 1.4;
            max-height: 80px;
            transition: border-color 0.2s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: #fbbf24;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
        }

        .chat-send-btn {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border: none;
            border-radius: 12px; /* Rounded square instead of circle */
            color: #1e293b;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 4px 12px rgba(251, 191, 36, 0.25),
                0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .chat-send-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .chat-send-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 
                0 8px 24px rgba(251, 191, 36, 0.4),
                0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .chat-send-btn:hover:not(:disabled)::before {
            opacity: 1;
        }

        .chat-send-btn:active {
            transform: translateY(-1px) scale(1.02);
            transition: all 0.1s ease;
        }

        .chat-send-btn:disabled {
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
            color: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .chat-send-btn svg {
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
        }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
            color: #64748b;
        }

        .empty-state-icon {
            width: 64px;
            height: 64px;
            background: #f1f5f9;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #fbbf24;
            margin-bottom: 1rem;
        }

        .empty-state h4 {
            margin: 0 0 0.5rem 0;
            font-size: 16px;
            color: #1e293b;
        }

        .empty-state p {
            margin: 0;
            font-size: 14px;
        }

        /* Animations */
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes typingPulse {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Scrollbar Styling */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Cash Flow Chart Placeholder */
        .chart-container {
            height: 300px;
            background: #f8fafc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            border: 2px dashed #cbd5e1;
        }

        /* Feature placeholder styling */
        .feature-placeholder {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }

        .placeholder-icon {
            font-size: 3rem;
            color: #cbd5e1;
            margin-bottom: 1rem;
        }

        .placeholder-text {
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }

        .placeholder-subtext {
            font-size: 0.875rem;
            color: #94a3b8;
        }

        .sidebar-toggle {
            position: absolute;
            top: 2rem;
            right: 1rem;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border: 2px solid #1e293b;
            border-radius: 8px;
            color: #1e293b;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .sidebar-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }
        
        .sidebar.collapsed {
            width: 60px;
            overflow: visible;
        }
        
        .sidebar.collapsed .logo,
        .sidebar.collapsed .tagline {
            display: none;
        }
        
        .sidebar.collapsed .nav-link {
            justify-content: center;
            padding: 0.875rem 0;
            position: relative;
        }
        
        .sidebar.collapsed .nav-link .nav-icon {
            margin-right: 0;
            width: 20px;
            text-align: center;
        }
        
        .sidebar.collapsed .nav-link span {
            display: none;
        }

        .sidebar.collapsed .nav-link:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 70px;
            top: 50%;
            transform: translateY(-50%);
            background: #1e293b;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            white-space: nowrap;
            z-index: 1002;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: all 0.3s ease;
        }
        
        .modal-overlay.show .modal {
            transform: scale(1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #64748b;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.875rem;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #fbbf24;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
        }
        
        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: #f8fafc;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #fbbf24;
            background: #fffbeb;
        }
        
        .upload-area.dragover {
            border-color: #fbbf24;
            background: #fffbeb;
        }

        .currency-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .currency-toggle {
            display: flex;
            background: #f1f5f9;
            border-radius: 6px;
            padding: 2px;
        }
        
        .currency-option {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s ease;
        }
        
        .currency-option.active {
            background: #fbbf24;
            color: #1e293b;
        }

        /* AP/AR Table Specific Styles - Fixed Version */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            max-width: 100%;
            background: white;
            position: relative;
        }
        
        .table-container .financial-table {
            width: 100%;
            min-width: 1200px;
            border-collapse: collapse;
            background: white;
            table-layout: auto; /* Changed from fixed to auto for better flexibility */
        }
        
        /* Set minimum widths instead of fixed widths */
        .table-container .financial-table th:nth-child(1) { min-width: 55px; width: 55px; }   /* Type */
        .table-container .financial-table th:nth-child(2) { min-width: 100px; width: 100px; } /* Reference */
        .table-container .financial-table th:nth-child(3) { min-width: 140px; width: 140px; } /* Company */
        .table-container .financial-table th:nth-child(4) { min-width: 245px; width: 245px; } /* Description */
        .table-container .financial-table th:nth-child(5) { min-width: 100px; width: 100px; } /* Amount */
        .table-container .financial-table th:nth-child(6) { min-width: 110px; width: 110px; } /* Invoice Date */
        .table-container .financial-table th:nth-child(7) { min-width: 110px; width: 110px; } /* Due Date */
        .table-container .financial-table th:nth-child(8) { min-width: 100px; width: 100px; }   /* Days */
        .table-container .financial-table th:nth-child(9) { min-width: 80px; width: 80px; }   /* Status */
        .table-container .financial-table th:nth-child(10) { min-width: 90px; width: 90px; }  /* Actions */
        
        .table-container .financial-table th {
            background: #f8fafc !important;
            padding: 0.75rem 0.5rem !important;
            text-align: left !important;
            font-weight: 600 !important;
            color: #475569 !important;
            border-bottom: 1px solid #e2e8f0 !important;
            font-size: 0.875rem !important;
            position: sticky;
            top: 0;
            z-index: 1;
            resize: horizontal; /* Allow column resizing */
            overflow: hidden;
        }
        
        .table-container .financial-table td {
            padding: 0.75rem 0.5rem !important;
            border-bottom: 1px solid #f1f5f9 !important;
            font-size: 0.875rem !important;
            text-align: left !important;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #334155 !important;
        }
        
        /* Center align only the Actions column */
        .table-container .financial-table th:nth-child(10),
        .table-container .financial-table td:nth-child(10) {
            text-align: center !important;
        }
        
        /* Remove the debugging borders */
        .table-container .financial-table {
            border: 1px solid #e2e8f0 !important; /* Back to normal border */
        }
        
        .table-container .financial-table th {
            border-right: 1px solid #e2e8f0 !important; /* Add column separators */
        }
        
        .table-container .financial-table td {
            border-right: 1px solid #f1f5f9 !important; /* Add column separators */
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            margin: 0 2px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            transition: opacity 0.2s ease;
            border-radius: 8px;
        }
        
        .action-btn:hover::before {
            opacity: 1;
        }
        
        .action-btn.edit {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            color: #0369a1;
            border: 1px solid #bae6fd;
        }
        
        .action-btn.edit::before {
            background: linear-gradient(135deg, #0369a1 0%, #0284c7 100%);
        }
        
        .action-btn.edit:hover {
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(3, 105, 161, 0.3);
        }
        
        .action-btn.delete {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .action-btn.delete::before {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
        }
        
        .action-btn.delete:hover {
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        
        .action-btn i {
            position: relative;
            z-index: 1;
        }
        
        /* Add tooltip styles */
        .action-btn {
            position: relative;
        }
        
        .action-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            margin-bottom: 4px;
            z-index: 1000;
        }
        
        .action-btn:hover::after {
            opacity: 1;
            visibility: visible;
        }

        .status-unpaid {
            background: #fef3c7;
            color: #92400e;
        }

        .summary-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.25rem;
        }
        
        .badge-overdue {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .badge-positive {
            background: #dcfce7;
            color: #166534;
        }
        
        .badge-negative {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .badge-neutral {
            background: #f1f5f9;
            color: #475569;
        }

        .metric-primary {
            margin-bottom: 0.75rem;
        }
        
        .metric-secondary {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .metric-value-small {
            font-size: 1.25rem;
            font-weight: 600;
            color: #64748b;
        }
        
        .metric-label {
            font-size: 0.75rem;
            color: #94a3b8;
            letter-spacing: 0.5px;
            display: block;
            margin-top: 0.25rem;
        }
        
        .ccc-disclaimer {
            font-size: 0.75rem;
            color: #64748b;
            background: #f8fafc;
            padding: 0.75rem;
            border-radius: 6px;
            border-left: 3px solid #fbbf24;
            margin-bottom: 1rem;
        }
        
        .ccc-display {
            background: #f0f9ff;
            color: #0369a1;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid #bae6fd;
            cursor: help; /* Shows it has tooltip info */
        }

        /* Multi-Select Filter Styles */
        .multi-select-container {
            position: relative;
            display: inline-block;
        }
        
        .multi-select-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 0.5rem 0.75rem;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            color: #374151;
            cursor: pointer;
            min-width: 120px;
            transition: all 0.2s ease;
        }
        
        .multi-select-trigger:hover {
            border-color: #9ca3af;
        }
        
        .multi-select-trigger.active {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            margin-top: 2px;
        }
        
        .multi-select-dropdown.show {
            display: block;
        }
        
        .multi-select-controls {
            display: flex;
            gap: 8px;
            padding: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .select-all-btn, .clear-all-btn {
            flex: 1;
            padding: 4px 8px;
            font-size: 0.75rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .select-all-btn {
            background: #eff6ff;
            color: #1d4ed8;
        }
        
        .select-all-btn:hover {
            background: #dbeafe;
        }
        
        .clear-all-btn {
            background: #f3f4f6;
            color: #374151;
        }
        
        .clear-all-btn:hover {
            background: #e5e7eb;
        }
        
        .multi-select-options {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .multi-select-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .multi-select-option:hover {
            background: #f9fafb;
        }
        
        .multi-select-option input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }
        
        .multi-select-option span {
            font-size: 0.875rem;
            color: #374151;
        }

        /* Enhanced Status Badge Styles */
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            text-align: center;
            min-width: 60px;
        }
        
        .status-unpaid {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fbbf24;
        }
        
        .status-paid {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        
        .status-overdue {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        
        .status-partial {
            background: #e0e7ff;
            color: #3730a3;
            border: 1px solid #6366f1;
        }

        /* Enhanced Summary Cards Styles */
        .enhanced-summary .metric-card.enhanced-card {
            position: relative;
            padding: 1.5rem;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            transition: all 0.2s ease;
            overflow: hidden;
        }
        
        .enhanced-summary .metric-card.enhanced-card:hover {
            border-color: #cbd5e1;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transform: translateY(-1px);
        }
        
        .card-accent {
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }
        
        .accent-blue {
            background: linear-gradient(180deg, #3b82f6, #1e40af);
        }
        
        .accent-orange {
            background: linear-gradient(180deg, #f59e0b, #d97706);
        }
        
        .accent-green {
            background: linear-gradient(180deg, #10b981, #059669);
        }
        
        .card-main {
            width: 100%;
        }
        
        .metric-title-group {
            margin-bottom: 1rem;
        }
        
        .metric-title-group .metric-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.25rem;
        }
        
        .metric-subtitle {
            font-size: 0.75rem;
            color: #9ca3af;
            font-weight: 500;
        }
        
        .metric-primary-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .metric-value-large {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            line-height: 1.2;
        }
        
        .metric-breakdown {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-start;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .breakdown-label {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
        }
        
        .breakdown-value {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
        }
        
        .aging-indicator {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            background: #fef3c7;
            color: #92400e;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            border: 1px solid #fbbf24;
            width: auto;
            max-width: fit-content;
            white-space: nowrap;
        }
        
        .efficiency-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            background: #e0f2fe;
            color: #0c4a6e;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid #0ea5e9;
            align-self: flex-start;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .enhanced-summary {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            .metric-value-large {
                font-size: 1.25rem;
            }
        }

        /* Enhanced Top Bar with Date */
        .top-bar-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
        }
        
        .date-display {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            color: #1e40af;
            font-weight: 500;
            min-width: fit-content;
            white-space: nowrap;
            margin-bottom: -0.5rem;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .top-bar-content {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .date-display {
                align-self: flex-end;
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
        }

        /* Cash Flow Forecast Styles */
        .cashflow-forecast-container {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }
        
        /* Redesigned Forecast Controls */
        .forecast-controls-redesigned {
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 1.5rem;
        }
        
        .horizontal-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .summary-card-horizontal {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }
        
        .summary-card-horizontal:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }
        
        .card-header-horizontal {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .card-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
        }
        
        .runway-icon {
            background: rgba(59, 130, 246, 0.1);
            color: #1e40af;
        }
        
        .burn-icon {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }
        
        .health-icon {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        
        .card-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }
        
        .metrics-horizontal {
            display: flex;
            justify-content: space-between;
            gap: 0.75rem;
        }
        
        .metric-compact {
            text-align: center;
            flex: 1;
        }
        
        .metric-label {
            display: block;
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .metric-number {
            display: block;
            font-size: 1rem;
            font-weight: 700;
            color: #111827;
            line-height: 1.2;
        }
        
        /* Health Card Horizontal */
        .health-content-horizontal {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        
        .trend-indicator-large {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            font-weight: 600;
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
        }
        
        .trend-indicator-large i {
            font-size: 0.75rem;
        }
        
        .trend-indicator-large.improving {
            color: #059669;
            background: #f0fdf4;
            border-color: #bbf7d0;
        }
        
        .trend-indicator-large.declining {
            color: #dc2626;
            background: #fef2f2;
            border-color: #fecaca;
        }
        
        .trend-indicator-large.stable {
            color: #6b7280;
            background: #f9fafb;
            border-color: #e5e7eb;
        }
        
        .trend-indicator-large.stable i {
            transform: rotate(90deg);
        }
        
        .payment-summary {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
            flex: 1;
        }
        
        .payment-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
        }
        
        .payment-label {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .payment-amount {
            font-size: 0.75rem;
            font-weight: 600;
            color: #111827;
            text-align: right;
        }
        
        /* Controls Section */
        .forecast-actions {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .control-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }
        
        .currency-input-group {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .currency-symbol {
            padding: 0.5rem 0.75rem;
            background: #f9fafb;
            border-right: 1px solid #d1d5db;
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
        }
        
        .currency-input {
            border: none;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            width: 150px;
            outline: none;
        }
        
        .currency-input:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .horizontal-summary {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .health-content-horizontal {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }
            
            .payment-summary {
                align-self: stretch;
            }
            
            .payment-item {
                text-align: left;
            }
        }
        
        @media (max-width: 768px) {
            .forecast-controls-redesigned {
                padding: 1rem;
            }
            
            .forecast-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .metrics-horizontal {
                gap: 0.5rem;
            }
            
            .metric-number {
                font-size: 0.8rem;
            }
            
            .payment-amount {
                font-size: 0.7rem;
            }
        }
        
        .chart-wrapper {
            padding: 2rem;
            height: 400px;
            position: relative;
        }
        
        #cashflowChart {
            width: 100% !important;
            height: 100% !important;
        }
        
        .chart-insights {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .chart-legend {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #374151;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        
        .insights-panel {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .insight-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .insight-item i {
            color: #3b82f6;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .forecast-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .forecast-summary {
                justify-content: space-around;
            }
            
            .chart-wrapper {
                padding: 1rem;
                height: 300px;
            }
            
            .chart-insights {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        .trend-indicator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .trend-indicator i {
            font-size: 0.75rem;
        }
        
        .trend-indicator.improving {
            color: #10b981;
        }
        
        .trend-indicator.declining {
            color: #ef4444;
        }
        
        .trend-indicator.stable {
            color: #6b7280;
        }
        
        .trend-indicator.stable i {
            transform: rotate(90deg);
        }
        
        @media (max-width: 768px) {
            .forecast-summary {
                flex-direction: column;
                gap: 1rem;
            }
            
            .summary-values {
                flex-direction: column;
                gap: 0.25rem;
            }
            
            .summary-value {
                font-size: 0.8rem;
            }
        }

        /* AP/AR Tab Navigation Styles */
        .ap-ar-tabs {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            margin-bottom: 2rem;
        }
        
        .tab-nav {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .tab-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .tab-btn:hover {
            background: rgba(59, 130, 246, 0.05);
            color: #1e40af;
        }
        
        .tab-btn.active {
            background: white;
            color: #1e40af;
            font-weight: 600;
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #1e40af);
        }
        
        .tab-btn i {
            font-size: 0.875rem;
        }
        
        .tab-content {
            display: none;
            padding: 1.5rem;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Aging Analysis Specific Styles */
        .aging-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .aging-summary-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }
        
        .aging-bucket-title {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 0.5rem;
            letter-spacing: 0.5px;
        }
        
        .aging-amount {
            font-size: 1.25rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 0.25rem;
        }
        
        .aging-count {
            font-size: 0.75rem;
            color: #9ca3af;
        }
        
        .aging-tables-container {
            display: block;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .aging-table-section {
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            margin-bottom: 1.5rem; /* Add space between tables */
            width: 100%;
        }

        .aging-table-section .aging-table th {
            background: #f9fafb;
            padding: 1rem 0.75rem;
            text-align: center;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            font-size: 0.875rem;
            letter-spacing: 0.5px;
            height: 3rem;
            vertical-align: middle;
        }

        .aging-table-section .aging-table th:first-child {
            text-align: left;
            min-width: 200px;
        }
        
        .aging-table-section .aging-table th:last-child {
            text-align: center;
            min-width: 120px;
        }

        .aging-table-section .aging-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.875rem;
            height: 3.5rem;
            vertical-align: middle;
        }
        
        .aging-table-header {
            background: #f8fafc;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .aging-table-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }
        
        /* Enhanced Aging Table Styles */
        .aging-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .aging-table th {
            background: #f9fafb;
            padding: 1rem 0.75rem;
            text-align: center;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            font-size: 0.875rem;
            letter-spacing: 0.5px;
            height: 3rem; /* Fixed height for consistency */
            vertical-align: middle;
        }
        
        .aging-table th:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: #f9fafb;
            z-index: 2;
            min-width: 200px;
        }
        
        .aging-table th:last-child {
            text-align: center;
            min-width: 120px;
        }
        
        .aging-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.875rem;
            height: 3.5rem; /* Fixed height for consistency */
            vertical-align: middle;
        }
        
        .aging-table tbody tr:hover {
            background: #f8fafc;
        }
        
        /* Company Cell Styling */
        .company-cell {
            text-align: left !important;
            min-width: 200px;
        }
        
        .aging-table tbody tr:hover .company-cell {
            background: #f8fafc;
        }
        
        .company-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }
        
        .company-name {
            font-weight: 500;
            color: #1f2937;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }
        
        /* Priority Badges */
        .priority-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.625rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        
        .high-priority {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .medium-priority {
            background: #fef3c7;
            color: #d97706;
            border: 1px solid #fed7aa;
        }
        
        .low-priority {
            background: #dbeafe;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
        }
        
        /* Amount Cell Styling */
        .amount-cell {
            text-align: right !important;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
        }
        
        .total-cell {
            background: #f8fafc !important;
            font-weight: 700;
            color: #1e40af;
            border-left: 2px solid #e2e8f0;
        }
        
        .zero-amount {
            color: #9ca3af;
            font-weight: normal;
        }
        
        /* Aging Bucket Colors */
        .aging-bucket-0-30 {
            color: #059669;
        }
        
        .aging-bucket-30-60 {
            color: #f59e0b;
        }
        
        .aging-bucket-60-90 {
            color: #ea580c;
        }
        
        .aging-bucket-90-120 {
            color: #dc2626;
        }
        
        .aging-bucket-120-plus {
            color: #991b1b;
            font-weight: 700;
        }
        
        /* Action Buttons */
        .actions-cell {
            text-align: center !important;
            padding: 0.5rem !important;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.25rem;
            justify-content: center;
            align-items: center;
        }
        
        .action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.75rem;
        }
        
        .email-btn {
            background: #dbeafe;
            color: #1d4ed8;
        }
        
        .email-btn:hover {
            background: #bfdbfe;
            color: #1e3a8a;
        }
        
        .mark-paid-btn {
            background: #dcfce7;
            color: #15803d;
        }
        
        .mark-paid-btn:hover {
            background: #bbf7d0;
            color: #14532d;
        }
        
        /* Email Modal Styles */
        .email-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .email-modal {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .email-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .email-modal-header h4 {
            margin: 0;
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .email-modal-body {
            padding: 1.5rem;
        }
        
        .email-modal-body label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        
        .email-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
        
        .email-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .email-preview {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            font-size: 0.875rem;
            line-height: 1.5;
            color: #4b5563;
        }
        
        .email-modal-footer {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
            border-radius: 0 0 8px 8px;
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1001;
            max-width: 350px;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast-success {
            border-left: 4px solid #10b981;
        }
        
        .toast-success i {
            color: #10b981;
        }
        
        .toast-info {
            border-left: 4px solid #3b82f6;
        }
        
        .toast-info i {
            color: #3b82f6;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .aging-table th:first-child {
                min-width: 150px;
            }
            
            .company-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .email-modal {
                width: 95%;
                margin: 1rem;
            }
            
            .priority-badge {
                font-size: 0.5rem;
                padding: 0.125rem 0.25rem;
            }

            .aging-charts-container {
                grid-template-columns: 1fr; /* Stack on mobile */
                gap: 1rem;
            }
            
            .aging-chart-card {
                min-height: 400px;
            }
            
            .aging-chart-canvas {
                height: 300px !important;
            }
        }

        .collection-efficiency-excellent { color: #059669 !important; font-weight: 700; }
        .collection-efficiency-good { color: #10b981 !important; font-weight: 600; }
        .collection-efficiency-fair { color: #f59e0b !important; font-weight: 600; }
        .collection-efficiency-poor { color: #ef4444 !important; font-weight: 600; }
        .collection-efficiency-bad { color: #dc2626 !important; font-weight: 700; }

        .payment-trend-improving { color: #059669 !important; }
        .payment-trend-stable { color: #111827 !important; }
        .payment-trend-declining { color: #dc2626 !important; }

        /* Top Bar Right Section */
        .top-bar-right {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-end;
        }
        
        /* Connection Status Styles */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s ease;
        }
        
        .connection-status.connected {
            background: #f0fdf4;
            border-color: #bbf7d0;
            color: #166534;
        }
        
        .connection-status.disconnected {
            background: #fef2f2;
            border-color: #fecaca;
            color: #991b1b;
        }
        
        .connection-status i {
            font-size: 0.75rem;
        }
        
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #94a3b8;
            transition: background-color 0.2s ease;
        }
        
        .connection-status.connected .connection-dot {
            background: #22c55e;
        }
        
        .connection-status.disconnected .connection-dot {
            background: #ef4444;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .top-bar-right {
                align-items: flex-start;
                gap: 0.375rem;
            }
            
            .connection-status {
                font-size: 0.7rem;
                padding: 0.25rem 0.5rem;
            }
            
            .connection-dot {
                width: 6px;
                height: 6px;
            }
        }

        /* Cash Flow Scenarios Styles */
        .scenarios-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .scenarios-left {
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }
        
        .scenarios-right {
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }
        
        .scenarios-header {
            background: #f8fafc;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .scenario-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 0.5rem;
        }
        
        .scenario-actions .btn {
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #9ca3af;
            border-color: #9ca3af;
        }
        
        .scenarios-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 0.5rem 0;
        }
        
        .scenarios-subtitle {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0;
        }
        
        .transactions-list {
            max-height: 500px;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .transaction-group {
            margin-bottom: 1.5rem;
        }
        
        .group-header {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .group-header.ap-header {
            color: #dc2626;
        }
        
        .group-header.ar-header {
            color: #059669;
        }
        
        .week-group {
            margin-bottom: 1rem;
        }
        
        .week-label {
            font-size: 0.75rem;
            color: #9ca3af;
            font-weight: 500;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .transaction-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: move;
            transition: all 0.15s ease;
            user-select: none;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .transaction-card:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
            transform: scale(1.01);
        }
        
        .transaction-card.dragging {
            opacity: 0.7;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }
        
        .transaction-card.ap-card {
            border-left: 3px solid #dc2626;
        }
        
        .transaction-card.ar-card {
            border-left: 3px solid #059669;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.25rem;
        }
        
        .card-company {
            font-weight: 600;
            color: #111827;
            font-size: 0.875rem;
        }
        
        .card-amount {
            font-weight: 700;
            color: #111827;
            font-size: 0.875rem;
        }
        
        .card-description {
            color: #6b7280;
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }
        
        .card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: #9ca3af;
        }
        
        .drag-handle {
            color: #9ca3af;
            font-size: 0.875rem;
            cursor: grab;
            flex-shrink: 0;
            margin-top: 0.125rem;
            opacity: 0.7;
            transition: opacity 0.15s ease;
        }

        .transaction-card:hover .drag-handle {
            opacity: 1;
            color: #6b7280;
        }

        .card-content {
            flex: 1;
            min-width: 0; /* Allows text to wrap properly */
        }
        
        .scenario-forecast {
            height: 250px; /* Reduced to fit better */
            margin-bottom: 1rem;
            background: #f8fafc;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e2e8f0;
        }
        
        .scenario-impact {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
        }

        .week-drop-zones {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            flex: 1;
        }

        .drop-zones-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        
        .impact-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
        }
        
        .impact-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.4rem; 
            padding: 0.5rem 0.75rem; 
            border-radius: 6px;
            font-size: 0.875rem;
            line-height: 1.1; 
            transition: all 0.15s ease;
        }
        
        .impact-item.risk {
            background: rgba(239, 68, 68, 0.05);
            border-left: 3px solid #ef4444;
            color: #7f1d1d;
        }
        
        .impact-item.benefit {
            background: rgba(16, 185, 129, 0.05);
            border-left: 3px solid #10b981;
            color: #064e3b;
        }
        
        .impact-item.neutral {
            background: rgba(107, 114, 128, 0.05);
            border-left: 3px solid #6b7280;
            color: #374151;
        }
        
        .impact-icon {
            flex-shrink: 0;
            font-size: 1rem;
            width: 1.25rem;
            text-align: center;
        }
        
        /* Drop Zones */
        .week-dropzone {
            background: white;
            border: 2px dashed #d1d5db;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
            transition: all 0.15s ease;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            cursor: pointer;
        }
        
        .week-dropzone:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }

        .week-dropzone.highlight {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
            animation: pulse-border 2s infinite;
        }

        .week-dropzone.drag-over {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
            border-style: solid;
            transform: scale(1.02);
        }
        
        .week-dropzone-label {
            text-align: center;
            color: #9ca3af;
            font-size: 0.75rem;
            padding: 1rem;
            font-style: italic;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .scenarios-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .scenario-forecast {
                height: 250px;
            }
        }

        /* Mini transaction cards in drop zones */
        .dropped-transactions {
            min-height: 20px;
            margin: 0.25rem 0;
        }
        
        .mini-transaction-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            margin-bottom: 0.25rem;
            font-size: 0.7rem;
            border-left: 2px solid #3b82f6;
        }
        
        .mini-transaction-card.ap-card {
            border-left-color: #dc2626;
        }
        
        .mini-transaction-card.ar-card {
            border-left-color: #059669;
        }
        
        .mini-vendor {
            font-weight: 600;
            color: #374151;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .mini-amount {
            font-weight: 700;
            color: #1f2937;
            font-size: 0.65rem;
        }
        
        .week-dropzone .drop-indicator {
            font-size: 0.7rem;
            color: #9ca3af;
            opacity: 0;
            transition: opacity 0.15s ease;
        }
        
        .week-dropzone:empty .drop-indicator,
        .week-dropzone.highlight .drop-indicator {
            opacity: 1;
        }

        /* New Scenarios Layout */
        .scenarios-new-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            padding: 1rem;
        }
        
        /* Full Width Chart */
        .scenario-chart-section {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }
        
        .scenario-chart-full {
            padding: 1rem;
            background: #f8fafc;
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Buckets Grid */
        .buckets-section {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            padding: 1.5rem;
        }
        
        .buckets-header {
            margin-bottom: 1.5rem;
        }
        
        .buckets-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 0.5rem 0;
        }
        
        .buckets-subtitle {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0;
        }
        
        .buckets-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }
        
        .week-bucket {
            background: #f9fafb;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 1rem;
            min-height: 120px;
            transition: all 0.15s ease;
            position: relative;
        }
        
        .week-bucket:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        
        .week-bucket.drag-over {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
            border-style: solid;
            transform: scale(1.02);
        }
        
        .bucket-header {
            font-weight: 600;
            font-size: 0.875rem;
            color: #374151;
            margin-bottom: 0.5rem;
            text-align: center;
        }
        
        .bucket-subtitle {
            font-size: 0.75rem;
            color: #9ca3af;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        
        .parked-bucket {
            background: #fef3c7;
            border-color: #f59e0b;
            grid-column: span 3; /* Spans exactly 3 columns */
            width: 100%; /* Full width of the 3 columns */
        }

        .parked-bucket .bucket-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* Two columns for cards */
            gap: 0.5rem; 
            align-items: start;
        }
        
        .parked-bucket .bucket-header {
            color: #92400e;
        }
        
        .bucket-content {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        /* Transaction Cards in Buckets */
        .bucket-transaction-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 0.5rem;
            cursor: grab;
            transition: all 0.15s ease;
            user-select: none;
        }
        
        .bucket-transaction-card:hover {
            border-color: #3b82f6;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }
        
        .bucket-transaction-card:active {
            cursor: grabbing;
        }
        
        .bucket-transaction-card.dragging {
            opacity: 0.6;
            transform: scale(1.02);
            z-index: 1000;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .bucket-transaction-card.ap-card {
            border-left: 3px solid #dc2626;
        }
        
        .bucket-transaction-card.ar-card {
            border-left: 3px solid #059669;
        }
        
        .bucket-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.25rem;
        }
        
        .bucket-vendor-name {
            font-weight: 600;
            font-size: 0.75rem;
            color: #374151;
            line-height: 1.2;
        }
        
        .bucket-amount {
            font-weight: 700;
            font-size: 0.75rem;
            white-space: nowrap;
            margin-left: 0.25rem;
        }
        
        .bucket-transaction-card.ap-card .bucket-amount {
            color: #dc2626;
        }
        
        .bucket-transaction-card.ar-card .bucket-amount {
            color: #059669;
        }
        
        .bucket-description {
            font-size: 0.7rem;
            color: #6b7280;
            line-height: 1.2;
        }
        
        /* Change Log */
        .change-log-section {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            padding: 1.5rem;
        }
        
        .change-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .change-log-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }
        
        .change-log-content {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log-item {
            display: flex;
            align-items: flex-start;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            font-size: 0.875rem;
            line-height: 1.4;
            border-left: 3px solid #6b7280;
        }
        
        .log-item.moved {
            background: rgba(59, 130, 246, 0.05);
            border-left-color: #3b82f6;
            color: #1e40af;
        }
        
        .log-item.neutral {
            background: rgba(107, 114, 128, 0.05);
            border-left-color: #6b7280;
            color: #374151;
        }
        
        /* Impact Analysis */
        .impact-analysis-section {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            padding: 1.5rem;
        }
        
        .impact-header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .impact-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }
        
        .impact-content {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        /* Small button style */
        .btn-small {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }
        
        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .buckets-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .parked-bucket {
                grid-column: span 3;
                width: 100%;
            }
            
            .parked-bucket .bucket-content {
                grid-template-columns: 1fr 1fr; /* Keep 2 columns even on smaller screens */
            }
        }
        
        @media (max-width: 768px) {
            .buckets-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .parked-bucket {
                grid-column: span 2;
                width: 100%;
            }
            
            .parked-bucket .bucket-content {
                grid-template-columns: 1fr; /* Single column on mobile */
            }
        }

        /* Financial Statements Specific Styles */
        .financial-tabs {
            margin-top: 1rem;
        }
        
        .balance-indicator {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .balance-status {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .balance-status.balanced {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        
        .balance-status.unbalanced {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .trial-balance-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .balance-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }
        
        .balance-label {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }
        
        .balance-amount {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
        }
        
        .report-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        .report-card h4 {
            margin: 0 0 1rem 0;
            color: #1e293b;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }
        
        .account-input-group {
            display: flex;
            gap: 0.5rem;
        }
        
        .account-input-group .form-select {
            flex: 1;
        }
        
        .linking-section {
            margin-bottom: 2rem;
        }
        
        .linking-section h4 {
            margin-bottom: 1rem;
            color: #1e293b;
        }
        
        .linking-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
        }
        
        .linking-item {
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .linking-item:hover {
            background: #f8fafc;
            border-color: #3b82f6;
        }
        
        .linking-item.selected {
            background: #dbeafe;
            border-color: #3b82f6;
        }
        
        .bulk-actions {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .bulk-info {
            font-weight: 500;
            color: #374151;
        }
        
        .bulk-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .link-icon {
            color: #3b82f6;
            margin-right: 0.25rem;
        }
        
        .unbalanced-row {
            border-left: 3px solid #ef4444 !important;
            background: rgba(239, 68, 68, 0.05) !important;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .trial-balance-summary {
                grid-template-columns: 1fr;
            }
            
            .reports-grid {
                grid-template-columns: 1fr;
            }
            
            .bulk-actions {
                flex-direction: column;
                gap: 1rem;
            }
        }

        /* Add these to your existing styles */
        .report-section {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .report-line {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }
        
        .report-total {
            border-top: 2px solid #1e293b;
            margin-top: 1rem;
            padding-top: 0.5rem;
            background: #f8fafc;
        }
        
        .account-info {
            display: flex;
            flex-direction: column;
        }
        
        .account-code {
            font-weight: 600;
            font-size: 0.875rem;
            color: #1e293b;
        }
        
        .account-name {
            font-size: 0.75rem;
            color: #64748b;
        }

        .filters-section-horizontal {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .filter-row {
            display: flex;
            align-items: end;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            min-width: 150px;
        }
        
        .filter-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }
        
        .filter-group .form-select,
        .filter-group .form-input {
            font-size: 0.875rem;
            padding: 0.5rem;
        }
        
        /* Full Width Tables */
        .table-container-full-width {
            width: 100%;
            overflow-x: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
        }
        
        .data-table-full {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .data-table-full th {
            background: #f8fafc;
            padding: 1rem 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .data-table-full td {
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }
        
        .data-table-full tbody tr:hover {
            background: #f8fafc;
        }
        
        /* Account Display - Single Line */
        .account-display {
            font-weight: 500;
            color: #1e293b;
        }
        
        /* Reports Audit Layout */
        .reports-audit-layout {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 3rem;
        }
        
        .report-statement {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            page-break-inside: avoid;
        }
        
        .report-header {
            background: #1e293b;
            color: white;
            padding: 1.5rem;
            text-align: center;
        }
        
        .report-header h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .report-date {
            margin: 0;
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .report-content {
            padding: 2rem;
        }
        
        /* Report Sections */
        .report-section {
            margin-bottom: 1.5rem;
        }
        
        .report-section:last-child {
            margin-bottom: 0;
        }
        
        .report-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.75rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .report-subsection {
            margin-left: 1rem;
            margin-bottom: 1rem;
        }
        
        .report-subsection-title {
            font-size: 1rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .report-line {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            border-bottom: 1px dotted #e2e8f0;
        }
        
        .report-line:last-child {
            border-bottom: none;
        }
        
        .report-line.total-line {
            font-weight: 600;
            border-top: 2px solid #1e293b;
            border-bottom: 2px solid #1e293b;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        
        .report-line.subtotal-line {
            font-weight: 500;
            border-top: 1px solid #64748b;
            margin-top: 0.25rem;
            padding-top: 0.25rem;
        }
        
        .account-item {
            margin-left: 1.5rem;
            font-size: 0.875rem;
            color: #64748b;
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                min-width: auto;
            }
            
            .reports-audit-layout {
                max-width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .table-container-full-width {
                font-size: 0.75rem;
            }
            
            .data-table-full th,
            .data-table-full td {
                padding: 0.5rem 0.25rem;
            }
            
            .report-content {
                padding: 1rem;
            }
        }

        .report-line.final-total-line {
            font-weight: 700;
            font-size: 1.1rem;
            border-top: 3px double #1e293b;
            border-bottom: 3px double #1e293b;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            background: #f8fafc;
        }

        /* Print-specific styles - much more direct approach */
        @media print {
            /* Hide the page header elements by targeting their likely containers */
            body > div:first-child,
            body > header,
            .app-header,
            .page-header {
                display: none !important;
            }
            
            /* Hide navigation and UI elements */
            .sidebar,
            .tab-nav,
            .section-actions,
            .section-header,
            button,
            .btn,
            .filters-section,
            .bulk-actions {
                display: none !important;
            }
            
            /* Clean page setup */
            html, body {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
            }
            
            /* Make sure only financial statements show */
            body * {
                visibility: hidden;
            }
            
            .reports-audit-layout,
            .reports-audit-layout *,
            .report-statement,
            .report-statement * {
                visibility: visible !important;
            }
            
            /* Position reports at top of page */
            .reports-audit-layout {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                padding: 20px !important;
                box-sizing: border-box !important;
            }
            
            /* Style statements */
            .report-statement {
                page-break-inside: avoid;
                margin-bottom: 40px;
                background: white !important;
            }
            
            .report-statement:nth-child(2) {
                page-break-before: always;
            }
            
            .report-statement:nth-child(3) {
                page-break-before: always;
            }
            
            /* Ensure proper text colors */
            .report-content,
            .report-content * {
                color: black !important;
                background: transparent !important;
            }
            
            .report-header h4 {
                background: #2c3e50 !important;
                color: white !important;
            }
        }

        .period-selector {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            background: white;
            margin-left: 0.5rem;
        }
        
        .date-input-small {
            font-size: 0.75rem;
            padding: 0.25rem;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            margin: 0 0.25rem;
            width: 120px;
        }
        
        .period-selector-container {
            position: relative;
        }
        
        .period-selector-enhanced {
            appearance: none;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.25rem 1.5rem 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            min-width: 100px;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1rem;
        }
        
        .period-selector-enhanced:hover {
            border-color: #c5c9d4;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .period-selector-enhanced:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .selector-arrow {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.625rem;
            color: #9ca3af;
            pointer-events: none;
        }
        
        .custom-date-range {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        
        .date-range-inputs {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .date-input-enhanced {
            flex: 1;
            min-width: 100px;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.75rem;
            background: white;
        }
        
        .date-separator {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
        }

        .title-and-selector {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .metric-title-wrapper {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .revenue-title-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .period-selector-fixed {
            appearance: none;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.25rem 1.75rem 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            min-width: 100px;
            position: relative;
            z-index: 10;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1rem;
            margin-top: -10px;
        }

        .period-selector-fixed:hover {
            border-color: #c5c9d4;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .period-selector-fixed:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Special styling for Altman Z-Score card */
        .metric-card.altman-z-score {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid rgba(251, 191, 36, 0.3);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .metric-card.altman-z-score .metric-value-large {
            color: #fbbf24; /* Gold color instead of white */
            font-weight: 700; /* Bolder weight */
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); /* Stronger shadow */
        }

        .metric-card.altman-z-score .breakdown-value {
            color: #fbbf24;
            font-weight: 600;
        }
        
        .metric-card.altman-z-score::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at top right, rgba(251, 191, 36, 0.1), transparent 70%);
            pointer-events: none;
        }
        
        .metric-card.altman-z-score .metric-title {
            color: #fbbf24;
            font-weight: 600;
        }
        
        .metric-card.altman-z-score .metric-value {
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .metric-card.altman-z-score .metric-change {
            color: #cbd5e1;
            opacity: 0.9;
        }
        
        .metric-card.altman-z-score .metric-icon {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }
        
        /* Add subtle glow effect */
        .metric-card.altman-z-score:hover {
            box-shadow: 0 8px 32px rgba(251, 191, 36, 0.2);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        /* Period type radio group styling */
        .period-type-group {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .period-type-group input[type="radio"] {
            margin: 0 0.25rem 0 0;
        }
        
        .period-type-group label {
            color: #374151;
            font-size: 0.875rem;
            font-weight: 500;
            margin: 0;
        }
        
        /* Comparison table - extends your existing financial-table styles */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            background: white;
        }
        
        .comparison-table th {
            min-width: 100px;
            white-space: nowrap;
        }
        
        .comparison-table th:first-child {
            min-width: 200px;
        }
        
        .comparison-table td {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid #f3f4f6;
            text-align: right;
            font-weight: 500;
        }
        
        .comparison-table td:first-child {
            text-align: left;
            font-weight: 600;
            color: #1f2937;
        }
        
        .comparison-table tbody tr:hover {
            background: #f9fafb;
        }

        .value-cell.prominent {
            font-weight: 600;
            background: #f8fafc;
        }
        
        .value-cell.margin {
            font-style: italic;
            color: #6b7280;
            font-size: 0.85rem;
        }

        .line-item-cell.margin {
            font-style: italic;
            color: #6b7280;
            font-size: 0.85rem;
            padding-left: 2rem !important;
        }
        
        .change-cell.change-cell-prominent {
            font-weight: 600;
        }
        
        .change-cell.change-cell-margin {
            font-style: italic;
            font-size: 0.8rem;
            color: #6b7280;
        }
        
        /* Value formatting - using your existing color scheme */
        .positive-change {
            color: #059669;
        }
        
        .negative-change {
            color: #dc2626;
        }
        
        .neutral-change {
            color: #6b7280;
        }

        .period-selector-section {
            margin-bottom: 2rem;
        }
        
        .period-selector-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .selector-header {
            margin-bottom: 1.5rem;
        }
        
        .selector-header h4 {
            margin: 0;
            color: #1e293b;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .selector-header i {
            color: #fbbf24;
            margin-right: 0.5rem;
        }
        
        .period-type-selector {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .period-radio {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
            color: #374151;
        }
        
        .period-radio input[type="radio"] {
            margin-right: 0.5rem;
            accent-color: #fbbf24;
        }
        
        .period-selectors {
            display: flex;
            align-items: end;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .period-group {
            display: flex;
            flex-direction: column;
            min-width: 180px;
        }
        
        .period-group label {
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .vs-indicator {
            padding: 0 1rem;
            font-weight: 600;
            color: #6b7280;
            align-self: center;
            margin-top: 1.5rem;
        }
        
        .yoy-option {
            margin-top: 0.5rem;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            font-size: 0.875rem;
            color: #374151;
            cursor: pointer;
        }
        
        .checkbox-label input[type="checkbox"] {
            margin-right: 0.5rem;
            accent-color: #fbbf24;
        }
        
        .yoy-period {
            margin-left: 0.5rem;
            color: #6b7280;
            font-style: italic;
        }
        
        /* P&L Comparison Table Styles */
        .comparison-table-container {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .comparison-table th {
            background: #1e293b;
            color: white;
            padding: 1rem 0.75rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.8rem;
            border-bottom: 2px solid #334155;
            white-space: nowrap;
        }
        
        .comparison-table th:first-child {
            text-align: left;
            min-width: 200px;
        }
        
        .comparison-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }
        
        .comparison-table tbody tr:hover {
            background: #f8fafc;
        }
        
        /* Line Item Styles */
        .line-item-cell {
            font-weight: 600;
            color: #1e293b;
            padding-left: 1rem !important;
        }
        
        .line-item-prominent {
            font-weight: 700;
            color: #1e293b;
            font-size: 0.95rem;
            background: linear-gradient(90deg, #f8fafc 0%, #ffffff 100%);
            border-top: 2px solid #e2e8f0;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .line-item-margin {
            font-weight: 500;
            color: #6b7280;
            font-size: 0.8rem;
            font-style: italic;
            padding-left: 2rem !important;
            background: #f9fafb;
        }
        
        /* Value Cell Styles */
        .value-cell {
            text-align: right;
            font-weight: 500;
            font-family: 'SF Mono', 'Monaco', monospace;
        }
        
        .value-cell-prominent {
            text-align: right;
            font-weight: 700;
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 0.95rem;
            background: linear-gradient(90deg, #f8fafc 0%, #ffffff 100%);
            border-top: 2px solid #e2e8f0;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .value-cell-margin {
            text-align: right;
            font-weight: 500;
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 0.8rem;
            color: #6b7280;
            background: #f9fafb;
        }
        
        /* Change Cell Styles */
        .change-cell {
            text-align: right;
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', monospace;
        }
        
        .change-cell-prominent {
            text-align: right;
            font-weight: 700;
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 0.95rem;
            background: linear-gradient(90deg, #f8fafc 0%, #ffffff 100%);
            border-top: 2px solid #e2e8f0;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .change-cell-margin {
            text-align: right;
            font-weight: 500;
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 0.8rem;
            color: #6b7280;
            background: #f9fafb;
        }
        
        .change-positive {
            color: #059669;
        }
        
        .change-negative {
            color: #dc2626;
        }
        
        .change-neutral {
            color: #6b7280;
        }
        
        /* Waterfall Charts Section */
        .waterfall-section {
            margin-top: 2rem;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }
        
        .chart-container {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            min-height: 400px;  /* Increased height for the container */
        }
        
        .chart-header {
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .chart-header h4 {
            margin: 0 0 0.5rem 0;
            color: #1e293b;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .chart-header p {
            margin: 0;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .chart-header-top {
            margin-bottom: 1rem;
            text-align: left;
            padding: 0;
        }
        
        .chart-header-top h4 {
            margin: 0 0 0.25rem 0;
            color: #1e293b;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .chart-header-top p {
            margin: 0;
            color: #6b7280;
            font-size: 0.8rem;
        }

        .waterfall-chart-area {
            display: flex;
            align-items: end;
            justify-content: space-between;
            height: 200px;
            margin-bottom: 1rem;
            padding: 0 10px;
            position: relative;
        }

        .waterfall-column {
            flex: 1;
            max-width: 60px;
            margin: 0 2px;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .waterfall-bar-container {
            flex: 1;
            position: relative;
            margin-bottom: 10px;
        }
        
        .waterfall-chart {
            flex: 1;
            min-height: 350px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .waterfall-labels {
            text-align: center;
            min-height: 60px;
        }
        
        .waterfall-label {
            font-size: 0.7rem;
            color: #374151;
            font-weight: 500;
            margin-bottom: 0.25rem;
            line-height: 1.1;
            word-break: break-word;
        }
        
        /* Executive Summary */
        .executive-summary {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .summary-header h4 {
            margin: 0 0 1rem 0;
            color: #1e293b;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .summary-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .summary-item {
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #fbbf24;
        }
        
        .summary-item h5 {
            margin: 0 0 0.5rem 0;
            color: #1e293b;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .summary-item p {
            margin: 0;
            color: #374151;
            font-size: 0.875rem;
        }
        
        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #fbbf24;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1400px) {
            .charts-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 900px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .period-selectors {
                flex-direction: column;
                align-items: stretch;
            }
            
            .vs-indicator {
                align-self: center;
                margin: 0.5rem 0;
            }

            .waterfall-label {
                font-size: 0.65rem;
            }
            
            .waterfall-value {
                font-size: 0.6rem;
            }
        }
        
        @media (max-width: 768px) {
            .comparison-table {
                font-size: 0.75rem;
            }
            
            .comparison-table th,
            .comparison-table td {
                padding: 0.5rem 0.25rem;
            }
            
            .period-type-selector {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        .waterfall-connector {
            height: 2px;
            background: #d1d5db;
            margin: 0 -10px;
            align-self: center;
        }

        .waterfall-base {
            background: linear-gradient(135deg, #64748b, #475569);
        }
        
        .waterfall-positive {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .waterfall-negative {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .waterfall-total {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border: 2px solid #f59e0b;
        }
        
        .waterfall-bar:hover::after {
            content: attr(data-value);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 1000;
        }

        /* Financing-specific styles */
        .financing-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .financing-option button {
            width: 100%;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            text-align: center;
        }
        
        .financing-option i {
            font-size: 1.5rem;
        }
        
        .scenario-transactions-list {
            margin: 1.5rem 0;
            min-height: 200px;
        }
        
        .no-scenarios {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px dashed #e2e8f0;
        }
        
        .scenario-financing-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: white;
            transition: box-shadow 0.2s ease;
        }
        
        .scenario-financing-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .financing-icon {
            font-size: 1.5rem;
            color: #3b82f6;
            width: 40px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .financing-details {
            flex: 1;
        }
        
        .financing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .financing-header h5 {
            margin: 0;
            color: #1e293b;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .financing-amount {
            font-weight: 600;
            color: #059669;
            font-size: 0.9rem;
        }
        
        .financing-terms {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }
        
        .term-item {
            font-size: 0.75rem;
            color: #6b7280;
            background: #f3f4f6;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            white-space: nowrap;
        }
        
        .financing-purpose {
            font-size: 0.875rem;
            color: #374151;
            font-style: italic;
        }
        
        .remove-scenario-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .remove-scenario-btn:hover {
            background: #dc2626;
        }
        
        .scenario-impact-summary {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .scenario-impact-summary h5 {
            margin: 0 0 1rem 0;
            color: #1e293b;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .impact-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .impact-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .metric-sublabel {
            font-size: 0.75rem;
            color: #9ca3af;
        }
        
        .metric-value {
            font-weight: 600;
            color: #059669;
            font-size: 0.9rem;
        }

        .insights-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .insights-header h4 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #ffffff;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .insights-grid {
            padding: 1.5rem 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .insight-card {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .insight-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        .insight-icon.revenue {
            background: linear-gradient(135deg, #059669, #10b981);
        }
        
        .insight-icon.opex {
            background: linear-gradient(135deg, #dc2626, #ef4444);
        }
        
        .insight-content h5 {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 0.25rem 0;
        }
        
        .insight-content p {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0;
        }
        
        .insight-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }
        
        .insight-description {
            color: #6b7280;
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        @media (max-width: 1200px) {
            .breakdown-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .scenario-financing-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .scenario-financing-section h4 {
            margin: 0 0 0.5rem 0;
            color: #1e293b;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .section-description {
            color: #6b7280;
            font-size: 0.875rem;
            margin: 0 0 1.5rem 0;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .financing-options-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .financing-terms {
                gap: 0.5rem;
            }
            
            .financing-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }
            
            .impact-metrics {
                grid-template-columns: 1fr;
            }
            
            .scenario-financing-item {
                padding: 0.75rem;
                gap: 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .financing-options-grid {
                grid-template-columns: 1fr;
            }
        }

        .add-financing-container {
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .parked-financing-section {
            margin: 2rem 0;
        }
        
        .parked-financing-section h5 {
            margin: 0 0 1rem 0;
            color: #1e293b;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .parked-items-container {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            min-height: 100px;
            background: #fafafa;
        }
        
        .parked-financing-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            margin: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            opacity: 0.7;
            transition: all 0.2s ease;
        }
        
        .parked-financing-item.active {
            opacity: 1;
            border-color: #059669;
            background: #f0fdf4;
        }
        
        .financing-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        .action-btn {
            background: #f3f4f6;
            border: none;
            border-radius: 4px;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 32px;
            height: 32px;
            display: inline-block;
            margin-right: 0.25rem;
            align-items: center;
            justify-content: center;
        }

        .action-btn:last-child {
            margin-right: 0;
        }
        
        .action-btn.activate {
            color: #059669;
        }
        
        .action-btn.activate:hover {
            background: #f0fdf4;
        }
        
        .action-btn.deactivate {
            color: #f59e0b;
        }
        
        .action-btn.deactivate:hover {
            background: #fffbeb;
        }
        
        .action-btn.remove {
            color: #ef4444;
        }
        
        .action-btn.remove:hover {
            background: #fef2f2;
        }

        /* Financing item styling in timeline */
        [data-financing="true"] {
            border-left: 4px solid #10b981 !important;
            background: linear-gradient(90deg, #ecfdf5 0%, #f0fdf4 100%) !important;
        }
        
        [data-financing="true"] .company-name::before {
            content: " ";
            margin-right: 0.25rem;
        }
        
        /* Financing items in parked section */
        .scenario-transaction[data-financing="true"] {
            border-left: 4px solid #10b981;
            background: linear-gradient(90deg, #ecfdf5 0%, #f0fdf4 100%);
        }
        
        .scenario-transaction[data-financing="true"] .transaction-type {
            background: #10b981;
            color: white;
        }

        /* Financing transaction cards */
        .financing-transaction {
            border-left: 4px solid #10b981 !important;
            background: linear-gradient(90deg, #ecfdf5 0%, #f0fdf4 100%) !important;
        }
        
        .financing-type {
            background: #10b981 !important;
            color: white !important;
        }
        
        .financing-amount {
            color: #059669 !important;
            font-weight: 600 !important;
        }
        
        .financing-transaction:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2) !important;
        }

        /* Fix financing modal styling */
        #financingModal.modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
        }

        /* Revenue & OPEX Breakdown Styles */
        .breakdown-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .breakdown-panel {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .panel-subtitle {
            color: #64748b;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }
        
        .no-data-message {
            text-align: center;
            padding: 3rem;
            color: #64748b;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .breakdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .breakdown-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
        }
        
        .breakdown-subtitle {
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 0.25rem;
        }
        
        .breakdown-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .breakdown-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .breakdown-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .breakdown-summary-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin: 0 2rem 2rem 2rem;
            padding: 0;
        }

        .breakdown-summary-row .summary-card {
            margin: 0; /* Remove any default margins */
        }

        .breakdown-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .breakdown-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        .breakdown-section {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1rem 0;
            border-bottom: 1px solid #e2e8f0; /* Optional: adds visual separation */
        }
        
        .section-subtitle {
            color: #64748b;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }
        
        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .breakdown-table th,
        .breakdown-table td {
            padding: 0.75rem 0.5rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .breakdown-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        /* Reports Sub-tabs - follows existing tab-nav pattern */
        .reports-tab-nav {
            display: flex;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }
        
        .reports-tab-btn {
            flex: 1;
            padding: 1rem 1.5rem;
            border: none;
            background: transparent;
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .reports-tab-btn:hover {
            background: rgba(59, 130, 246, 0.05);
            color: #1e40af;
        }
        
        .reports-tab-btn.active {
            background: white;
            color: #1e40af;
            font-weight: 600;
        }
        
        .reports-tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #1e40af);
        }
        
        .reports-tab-btn i {
            font-size: 0.875rem;
        }
        
        .reports-tab-content {
            display: none;
        }
        
        .reports-tab-content.active {
            display: block;
        }

        /* Add this to your existing styles */
        .pro-upgrade-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            padding: 1.5rem;
            z-index: 10;
        }
        
        .pro-upgrade-overlay .upgrade-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
            opacity: 0.8;
        }
        
        .pro-upgrade-overlay .upgrade-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #fbbf24;
        }
        
        .pro-upgrade-overlay .upgrade-description {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-bottom: 1rem;
            line-height: 1.4;
        }
        
        .pro-upgrade-overlay .upgrade-cta-btn {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1e293b;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
        }
        
        .pro-upgrade-overlay .upgrade-cta-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(251, 191, 36, 0.4);
        }

        /* Revenue OPEX Breakdown - New unique classes only */
        .insights-section-rodb {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .table-footer {
            background: #f8fafc;
            border-top: 2px solid #e2e8f0;
            font-weight: 600;
        }
        
        .amount-positive {
            color: #059669;
        }
        
        .amount-negative {
            color: #dc2626;
        }

        /* Revenue OPEX Breakdown - Full Width Layout (New unique classes only) */
        .ro-analysis-panel-full {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        #forecastTrendingContainer.ro-analysis-panel-full {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        
        .ro-analysis-content-full {
            padding: 0 1.5rem 1.5rem;
        }
        
        .ro-analysis-subtitle {
            color: #64748b;
            font-size: 0.875rem;
            margin-bottom: 1rem;
            margin-top: 0;
        }
        
        .ro-table-container-full {
            width: 100%;
            overflow-x: auto;
        }
        
        .ro-financial-table-full {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            background: white;
        }
        
        .ro-financial-table-full th {
            background: #f8fafc;
            padding: 1rem 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .ro-financial-table-full td {
            padding: 0.875rem 0.75rem;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .ro-account-name-cell {
            font-weight: 500;
            color: #1e293b;
        }
        
        .ro-amount-cell {
            text-align: right;
            font-family: 'SF Mono', Monaco, monospace;
            color: #374151;
        }
        
        .ro-change-cell {
            text-align: right;
            font-family: 'SF Mono', Monaco, monospace;
            font-weight: 500;
        }
        
        .ro-change-cell.positive {
            color: #059669;
        }
        
        .ro-change-cell.negative {
            color: #dc2626;
        }
        
        .ro-percent-cell {
            text-align: right;
            color: #6b7280;
            font-weight: 500;
        }
        
        .ro-total-row-single {
            background: #f8fafc;
            border-top: 2px solid #e2e8f0;
        }
        
        .ro-total-row-single .ro-total-amount {
            color: #1e293b;
            font-weight: 700;
        }
        
        .ro-total-row-single .ro-total-change {
            font-weight: 700;
        }
        
        /* Full Width Insights Section - Revenue OPEX specific */
        .ro-insights-section-full {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .ro-insights-header-full {
            background: #f8fafc;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .ro-insights-content-full {
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        .ro-insight-card-full {
            display: flex;
            gap: 1.5rem;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            background: #fafbfc;
        }
        
        .ro-insight-card-full.positive {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }
        
        .ro-insight-card-full.negative {
            background: #fef2f2;
            border-color: #fecaca;
        }
        
        .ro-insight-card-full.warning {
            background: #fffbeb;
            border-color: #fed7aa;
        }
        
        .ro-insight-icon-full {
            font-size: 2rem;
            line-height: 1;
        }
        
        .ro-insight-content-full {
            flex: 1;
        }
        
        .ro-insight-title-full {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        .ro-insight-description-full {
            color: #64748b;
            line-height: 1.5;
            font-size: 0.875rem;
        }
        
        #trendingChart {
            max-height: 400px;
            width: 100% !important;
        }

        .trending-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1.5rem 2rem;
        }
        
        .trending-title-section h4 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 0.25rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .trending-subtitle {
            color: #64748b;
            font-size: 0.875rem;
            margin: 0;
        }
        
        .trending-chart-divider {
            height: 1px;
            background: linear-gradient(90deg, #e2e8f0 0%, #cbd5e1 50%, #e2e8f0 100%);
            margin: 0 2rem;
        }
        
        .trending-chart-container {
            padding: 2rem;
            height: 450px;
            background: #fafbfc;
            margin-bottom: 2rem;
            width: 100%;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .trending-chart-container canvas {
            max-width: 100%;
            height: auto;
        }

        #multiYearTrendingSection .breakdown-summary-row {
            margin-top: 1.5rem;
            margin-bottom: 2rem;
        }
        
        /* Forecasting Module - Unique Classes */
        .forecasting-module-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .industry-context-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .industry-context-selector label {
            font-weight: 600;
            color: #374151;
        }
        
        .industry-context-dropdown {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            min-width: 180px;
        }
        
        .custom-industry-field {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin-left: 0.5rem;
            min-width: 150px;
        }
        
        .forecast-time-selector {
            display: flex;
            gap: 0.5rem;
            margin: 1.5rem 0;
            border-bottom: 2px solid #f3f4f6;
        }
        
        .forecast-period-button {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            color: #6b7280;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .forecast-period-button.active {
            color: #1e40af;
            border-bottom-color: #1e40af;
            background: rgba(30, 64, 175, 0.05);
        }
        
        .forecast-period-button:hover {
            color: #1e40af;
            background: rgba(30, 64, 175, 0.05);
        }
        
        .market-context-panel {
            background: linear-gradient(135deg, #1e293b, #475569);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }
        
        .market-intelligence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .market-intelligence-header h4 {
            margin: 0;
            font-size: 1.1rem;
        }
        
        .market-intel-status {
            font-size: 0.875rem;
            opacity: 0.8;
        }
        
        .market-intel-placeholder {
            text-align: center;
            opacity: 0.7;
            font-style: italic;
        }
        
        .forecasting-workspace {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .forecast-workspace-view {
            padding: 2rem;
        }
        
        .forecast-planning-grid {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .forecast-columns-header {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f3f4f6;
        }
        
        .forecast-column h4 {
            margin: 0 0 0.25rem 0;
            color: #1f2937;
        }
        
        .forecast-column-subtitle {
            margin: 0;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .forecast-planning-section {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .forecast-section-header {
            background: #f9fafb;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .forecast-section-header h5 {
            margin: 0;
            color: #374151;
            font-weight: 600;
        }
        
        .forecast-data-row {
            display: grid;
            grid-template-columns: 200px 1fr 1fr 1fr;
            gap: 2rem;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f3f4f6;
            align-items: center;
        }
        
        .forecast-data-row:last-child {
            border-bottom: none;
        }
        
        .forecast-expense-label {
            font-weight: 500;
            color: #374151;
        }
        
        .forecast-historical-data .amount {
            font-weight: 600;
            color: #1f2937;
        }
        
        .forecast-growth-indicator {
            display: block;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        .forecast-growth-indicator.positive {
            color: #059669;
        }
        
        .forecast-growth-indicator.negative {
            color: #dc2626;
        }
        
        .forecast-input-group {
            position: relative;
        }
        
        .forecast-number-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
        }
        
        .forecast-number-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .forecast-growth-controls {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }
        
        .forecast-growth-preset {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border: 1px solid #d1d5db;
            background: #f9fafb;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .forecast-growth-preset:hover {
            background: #e5e7eb;
        }
        
        .ai-insight-card {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 1rem;
        }
        
        .ai-insight-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #1e40af;
        }
        
        .ai-insight-text {
            margin: 0 0 0.75rem 0;
            font-size: 0.875rem;
            color: #1f2937;
            line-height: 1.4;
        }
        
        .ai-confidence-meter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
        }
        
        .ai-confidence-bar {
            flex: 1;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .ai-confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #f59e0b, #10b981);
            transition: width 0.3s ease;
        }
        
        .forecast-mini-insight {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #374151;
            padding: 0.5rem;
            background: #f9fafb;
            border-radius: 6px;
        }
        
        .forecast-mini-insight.warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .forecast-results-summary {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .forecast-summary-line {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .forecast-summary-line:last-child {
            border-bottom: none;
        }
        
        .forecast-total-line {
            font-weight: 700;
            font-size: 1.1rem;
            border-top: 2px solid #1e40af;
            margin-top: 0.5rem;
            padding-top: 1rem;
        }
        
        .forecast-margin-line {
            color: #059669;
        }
        
        /* Multi-Year Planning View */
        .multi-year-planning-grid {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        
        .multi-year-columns {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1.5rem;
        }
        
        .multi-year-column {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        .multi-year-column h4 {
            text-align: center;
            margin: 0 0 1rem 0;
            color: #1f2937;
        }
        
        .multi-year-inputs {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .multi-year-inputs label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }
        
        .multi-year-calculated {
            font-weight: 600;
            color: #059669;
        }
        
        .multi-year-ai-insights {
            background: #fefce8;
            border: 1px solid #fde047;
            border-radius: 12px;
            padding: 1.5rem;
        }
        
        .ai-insight-card.large {
            background: none;
            border: none;
            padding: 0;
        }
        
        .forecast-growth-chart {
            display: flex;
            align-items: end;
            gap: 0.5rem;
            height: 60px;
            margin-top: 1rem;
        }
        
        .forecast-chart-bar {
            flex: 1;
            background: linear-gradient(to top, #3b82f6, #60a5fa);
            border-radius: 2px 2px 0 0;
            min-height: 8px;
        }
        
        /* Scenario Planning Module */
        .scenario-planning-module {
            margin-top: 2rem;
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
        }
        
        .scenario-planning-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .scenario-selector-controls {
            display: flex;
            gap: 0.5rem;
        }
        
        .scenario-selector-button {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        
        .scenario-selector-button.active {
            background: #1e40af;
            color: white;
            border-color: #1e40af;
        }
        
        .scenario-comparison-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        
        .scenario-planning-card {
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .scenario-planning-card.active {
            border-color: #1e40af;
            background: #f0f9ff;
        }
        
        .scenario-planning-card h5 {
            margin: 0 0 1rem 0;
            color: #1f2937;
        }
        
        .scenario-metrics-display {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .scenario-metrics-display .metric {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #374151;
        }
        
        .scenario-metrics-display .metric span {
            font-weight: 600;
        }
        
        /* Intelligence Grid for Market Data */
        .intelligence-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .intel-metric {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .intel-label {
            opacity: 0.8;
        }
        
        .intel-value {
            font-weight: 600;
        }
        
        .intel-insight {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .scenario-card.active {
            border-color: #1e40af;
            background: #f0f9ff;
        }
        
        .scenario-card h5 {
            margin: 0 0 1rem 0;
            color: #1f2937;
        }
        
        .scenario-metrics {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .scenario-metrics .metric {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #374151;
        }
        
        .scenario-metrics .metric span {
            font-weight: 600;
        }

        /* AI-Driven Forecasting Styles */
        .ai-forecast-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .industry-context {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .industry-context label {
            font-weight: 600;
            color: #374151;
        }
        
        .industry-select {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            min-width: 200px;
            font-size: 0.875rem;
        }
        
        .ai-status-panel {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }
        
        .ai-status-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .ai-status-icon {
            font-size: 1.5rem;
        }
        
        .ai-status-text h4 {
            margin: 0 0 0.25rem 0;
            font-size: 1.1rem;
        }
        
        .ai-status-text p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.875rem;
        }
        
        .market-context-summary {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        
        .context-header {
            margin-bottom: 0.75rem;
        }
        
        .context-header h4 {
            margin: 0;
            color: #374151;
            font-size: 1rem;
        }
        
        .forecast-period-selector {
            margin-bottom: 2rem;
        }
        
        .period-tabs {
            display: flex;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }
        
        .period-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            color: #64748b;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .period-tab:hover {
            background: rgba(59, 130, 246, 0.05);
            color: #1e40af;
        }
        
        .period-tab.active {
            background: white;
            color: #1e40af;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .forecast-table-container {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 2rem;
            overflow: hidden;
        }
        
        .forecast-table-container.active {
            display: block;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .table-header h4 {
            margin: 0;
            color: #1f2937;
            font-size: 1.1rem;
        }
        
        .table-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .forecast-table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .forecast-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            min-width: 1200px;
        }
        
        .forecast-table th {
            background: #f9fafb;
            color: #374151;
            font-weight: 600;
            padding: 0.75rem 0.5rem;
            text-align: center;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        .line-item-header {
            text-align: left !important;
            min-width: 200px;
            background: #f1f5f9 !important;
        }
        
        .month-header, .quarter-header, .year-header {
            min-width: 80px;
        }
        
        .total-header, .change-header, .cagr-header {
            min-width: 100px;
            background: #fef3c7 !important;
        }
        
        .ai-confidence-header {
            min-width: 120px;
            background: #f0f9ff !important;
        }
        
        .forecast-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #f3f4f6;
            text-align: center;
        }
        
        .section-header-row td {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            text-align: left;
            padding: 0.75rem 1rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .line-item {
            text-align: left;
            font-weight: 500;
            color: #374151;
            min-width: 200px;
            padding-left: 1rem;
        }
        
        .forecast-cell {
            background: #fefefe;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            font-family: 'SF Mono', 'Monaco', monospace;
            text-align: right;
        }
        
        .forecast-cell:hover {
            background: #f0f9ff;
            border-color: #bae6fd;
        }
        
        .forecast-cell:focus {
            outline: none;
            background: #f0f9ff;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        .total-cell {
            background: #fef3c7;
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', monospace;
            text-align: right;
        }
        
        .total-prominent {
            background: #fde047;
            font-weight: 700;
            font-size: 0.95rem;
        }
        
        .net-income-cell {
            background: #dcfce7;
            font-weight: 600;
            color: #166534;
            font-family: 'SF Mono', 'Monaco', monospace;
            text-align: right;
        }
        
        .net-income-prominent {
            background: #bbf7d0;
            font-weight: 700;
            font-size: 0.95rem;
        }
        
        .margin-cell {
            background: #f0fdf4;
            font-weight: 500;
            color: #166534;
            font-family: 'SF Mono', 'Monaco', monospace;
            text-align: right;
        }
        
        .margin-prominent {
            background: #dcfce7;
            font-weight: 600;
        }
        
        .confidence-cell {
            background: #f0f9ff;
            padding: 0.5rem;
        }
        
        .confidence-bar {
            width: 60px;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.25rem;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #f59e0b, #10b981);
            transition: width 0.3s ease;
        }
        
        .confidence-text {
            font-size: 0.75rem;
            font-weight: 500;
            color: #374151;
        }
        
        .total-section-row td {
            background: #fef3c7;
            font-weight: 600;
            border-top: 2px solid #f59e0b;
        }
        
        .net-income-row td {
            background: #dcfce7;
            font-weight: 600;
            border-top: 2px solid #10b981;
        }
        
        .margin-row td {
            background: #f0fdf4;
            font-weight: 500;
        }
        
        .total-line, .net-income-line, .margin-line {
            font-weight: 600;
        }
        
        .placeholder-row td {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
            font-style: italic;
        }
        
        .placeholder-text {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .ai-insights-summary {
            background: #fefce8;
            border: 1px solid #fde047;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .insights-header {
            margin-bottom: 1rem;
        }

        .insights-header-AIinsight {
            margin-bottom: 1rem;
            color: white;
        }
        
        .insights-header h4 {
            margin: 0;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .insight-item {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #fde047;
        }
        
        .insight-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .insight-content {
            color: #6b7280;
            font-size: 0.875rem;
            line-height: 1.4;
        }
        
        /* Change indicators for YoY columns */
        .change-positive {
            color: #059669;
            font-weight: 600;
        }
        
        .change-negative {
            color: #dc2626;
            font-weight: 600;
        }
        
        .change-neutral {
            color: #6b7280;
            font-weight: 500;
        }
        
        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .forecast-table {
                min-width: 1000px;
            }
            
            .month-header, .quarter-header {
                min-width: 70px;
            }
        }
        
        @media (max-width: 768px) {
            .ai-forecast-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .industry-context {
                flex-direction: column;
                align-items: stretch;
            }
            
            .industry-select {
                min-width: auto;
            }
            
            .period-tabs {
                flex-direction: column;
            }
            
            .table-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
        }

        /* Context metrics styling */
        .context-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .context-metric {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .metric-label {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .metric-value {
            font-weight: 600;
            color: #1f2937;
        }
        
        .context-insight {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(59, 130, 246, 0.1);
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            color: #1e40af;
            grid-column: 1 / -1;
            margin-top: 0.5rem;
        }

        /* P&L Forecasting Styles - All Unique Classes */
        .forecasting-ai-controls {
            display: flex;
            align-items: end;
            justify-content: space-between;
            gap: 1rem;
            padding: 1rem 1.5rem;
            flex-wrap: wrap;
        }

        .forecasting-ai-controls-left {
            display: flex;
            align-items: end;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .forecasting-ai-controls-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .industry-input-wrapper,
        .context-input-wrapper {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        
        .industry-input-wrapper label,
        .context-input-wrapper label {
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .context-input-wrapper {
            flex: 1;
            margin-left: 0;
        }
        
        .context-input-wrapper input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
        }
        
        .context-input-wrapper input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .forecasting-ai-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .context-input-wrapper {
                margin-left: 0 !important;
                margin-top: 1rem;
            }
        }
        
        .industry-input-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .industry-input-wrapper label {
            font-weight: 600;
            color: #374151;
        }
        
        .industry-input-select {
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.875rem;
            min-width: 220px;
            transition: border-color 0.2s ease;
        }

        .industry-input-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        .forecast-status-info {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        
        .status-indicators {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .actual-status-indicator, .forecast-status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .actual-dot {
            background: #374151;
        }
        
        .forecast-dot {
            background: #3b82f6;
        }
        
        .pl-forecast-container {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 2rem;
            overflow: hidden;
        }
        
        .pl-table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .pl-table-header h4 {
            margin: 0;
            color: #1f2937;
            font-size: 1.1rem;
        }
        
        .pl-table-controls {
            display: flex;
            gap: 0.5rem;
        }
        
        .pl-table-scroll {
            overflow-x: auto;
            max-height: 800px;
            overflow-y: auto;
        }
        
        .pl-forecast-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            min-width: 1400px;
            border-radius: 0;
        }

        .pl-forecast-table th:first-child,
        .pl-forecast-table td:first-child {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            min-width: 280px !important;
            width: 280px !important;
        }
        
        .pl-forecast-table th:last-child,
        .pl-forecast-table td:last-child {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        
        .pl-forecast-table th {
            background: #f9fafb;
            color: #374151;
            font-weight: 600;
            padding: 0.75rem 0.5rem;
            text-align: center;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        .pl-line-item-header {
            text-align: left !important;
            min-width: 200px;
            background: #f1f5f9 !important;
            padding-left: 12px;
            font-weight: 500;
        }
        
        .pl-month-header {
            min-width: 85px;
        }
        
        .pl-actual-header {
            background: #374151 !important;
            color: white !important;
        }
        
        .pl-forecast-header {
            background: #3b82f6 !important;
            color: white !important;
        }
        
        .pl-total-header, .pl-percentage-header {
            min-width: 100px;
            background: #fef3c7 !important;
        }
        
        .pl-forecast-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #f3f4f6;
            text-align: center;
        }
        
        .pl-section-header-row td {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            text-align: left;
            padding: 0.75rem 1rem;
            border-bottom: 2px solid #e2e8f0;
            border-top: 2px solid #e2e8f0;
        }
        
        .pl-section-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .pl-line-item {
            text-align: left !important;
            padding-left: 1rem;
            font-weight: 500;
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
            min-width: 280px;
            white-space: nowrap;
        }

        .pl-line-item.bold {
            font-weight: 700;
            background: #e2e8f0;
        }
        
        /* Actual vs Forecast Cell Styling */
        .pl-actual-cell {
            background: #374151;
            color: white;
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', monospace;
            text-align: right;
            cursor: not-allowed;
        }
        
        .pl-forecast-cell {
            text-align: right;
            padding: 8px 16px;
            border: 1px solid #e2e8f0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .pl-forecast-cell.bold {
            font-weight: 700;
            background: #f1f5f9;
        }
        
        .pl-forecast-cell:hover {
            background: #f0f9ff;
            border-color: #bae6fd;
        }
        
        .pl-forecast-cell:focus {
            outline: none;
            background: #f0f9ff;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        .pl-calculated-cell {
            background: #f3f4f6;
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', monospace;
            text-align: right;
            color: #374151;
        }
        
        .pl-total-cell {
            text-align: right;
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            background: #fef3c7;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .percentage-row {
            background: #f0f9ff !important;
            font-style: italic;
            color: #1e40af;
        }
        
        .percentage-row .pl-line-item {
            background: #f0f9ff !important;
            font-style: italic;
            color: #1e40af;
            padding-left: 2rem; /* Indent percentage rows */
        }
        
        .percentage-row .pl-forecast-cell,
        .percentage-row .pl-total-cell {
            background: #f0f9ff !important;
            color: #1e40af;
            font-style: italic;
            font-weight: 500;
        }
        
        .pl-total-prominent {
            background: #fde047 !important;
            font-weight: 700 !important;
            font-size: 0.95rem !important;
            color: #92400e !important; /* Dark brown text */
        }
        
        .pl-percentage-cell {
            background: #fef3c7;
            font-weight: 500;
            font-family: 'SF Mono', 'Monaco', monospace;
            text-align: right;
            color: #92400e;
        }
        
        /* P&L Specific Row Styling */
        .pl-revenue-row .pl-line-item {
            color: #1e40af;
            font-weight: 600;
        }
        
        .pl-cogs-row .pl-line-item {
            color: #dc2626;
            font-weight: 600;
        }
        
        .pl-opex-row .pl-line-item {
            color: #7c2d12;
            font-weight: 600;
        }
        
        .pl-gross-profit td {
            background: #dcfce7 !important;
            font-weight: 700;
            color: #166534;
        }
        
        .pl-gross-cell {
            background: #dcfce7 !important;
            font-weight: 700;
            color: #166534;
            font-family: 'SF Mono', 'Monaco', monospace;
            text-align: right;
        }
        
        .pl-gross-prominent {
            background: #bfdbfe !important;
            font-weight: 700 !important;
            color: #1d4ed8 !important; /* Dark blue text */
        }
        
        .pl-net-income td {
            background: #dcfce7 !important;
            font-weight: 700;
            color: #166534;
        }
        
        .pl-net-cell {
            background: #bbf7d0 !important;
            font-weight: 700;
            color: #166534;
            font-family: 'SF Mono', 'Monaco', monospace;
            text-align: right;
        }
        
        .pl-net-prominent {
            background: #dcfce7 !important;
            font-weight: 700 !important;
            color: #166534 !important; /* Dark green text */
        }
        
        /* Total Row Styling */
        .pl-total-row td {
            background: #fef3c7 !important;
            font-weight: 700;
            border-top: 2px solid #f59e0b;
            border-bottom: 2px solid #f59e0b;
        }
        
        .pl-calculated-row td {
            background: #f3f4f6 !important;
            font-weight: 700;
            border-top: 1px solid #d1d5db;
        }
        
        .pl-total-line, .pl-calculated-line, .pl-net-income-line {
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.025em;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .pl-forecast-table {
                min-width: 1200px;
            }
            
            .pl-month-header {
                min-width: 70px;
            }
        }
        
        @media (max-width: 768px) {
            .forecasting-ai-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .industry-input-wrapper {
                flex-direction: column;
                align-items: stretch;
            }
            
            .industry-input-select {
                min-width: auto;
            }
            
            .pl-table-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .status-indicators {
                flex-direction: column;
                gap: 1rem;
            }
        }

        /* Period Selector Tabs */
        .forecast-period-tabs {
            display: flex;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }
        
        .period-tab-btn {
            flex: 1;
            padding: 1rem 1.5rem;
            border: none;
            background: transparent;
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .period-tab-btn:hover {
            background: rgba(59, 130, 246, 0.05);
            color: #1e40af;
        }
        
        .period-tab-btn.active {
            background: white;
            color: #1e40af;
            font-weight: 600;
        }

        .period-tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #1e40af);
        }
        
        .period-tab-btn i {
            font-size: 0.875rem;
        }
        
        .quarter-header, .year-header, .change-header {
            min-width: 90px;
        }
        
        .placeholder-row td {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
            font-style: italic;
        }
        
        .placeholder-text {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        /* New Margin Row Styling */
        .pl-margin-row td {
            background: #f1f5f9 !important;
            font-style: italic;
            color: #64748b;
            font-weight: 500;
        }
        
        .pl-margin-line {
            font-weight: 600 !important;
            color: #475569 !important;
        }
        
        .pl-margin-cell {
            font-family: 'SF Mono', 'Monaco', monospace;
            text-align: right;
            font-weight: 600;
            color: #475569;
        }
        
        .pl-margin-prominent {
            background: #e2e8f0 !important;
            font-weight: 700 !important;
            color: #1e293b !important; /* Dark slate text */
        }
        
        /* EBITDA Specific Styling */
        .pl-ebitda td {
            background: #dbeafe !important;
            font-weight: 700;
            color: #1d4ed8;
        }
        
        .pl-ebitda-cell {
            font-family: 'SF Mono', 'Monaco', monospace;
            text-align: right;
        }
        
        .pl-ebitda-prominent {
            background: #bfdbfe !important;
            font-weight: 700 !important;
            color: #1d4ed8 !important; /* Dark blue text */
        }
        
        /* EBIT Specific Styling */
        .pl-ebit td {
            background: #fef3c7 !important;
            font-weight: 600;
            color: #92400e;
        }
        
        .pl-ebit-cell {
            font-family: 'SF Mono', 'Monaco', monospace;
            text-align: right;
        }
        
        .pl-ebit-prominent {
            background: #fde047 !important;
            font-weight: 700 !important;
            color: #92400e !important; /* Dark brown text */
        }

        /* AI Insights Container Styling */
        .ai-insights-container {
            margin-top: 2rem;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .insights-header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .insights-header h4 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }
        
        .insights-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
        }
        
        .confidence-badge {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            border: 1px solid rgba(34, 197, 94, 0.3);
            font-weight: 600;
        }
        
        .forecast-date {
            color: #cbd5e1;
        }
        
        .insights-content {
            padding: 1.5rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 1200px) {
            .insights-content {
                grid-template-columns: 1fr 1fr 1fr 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .insights-content {
                grid-template-columns: 1fr;
            }
        }
        
        .insight-card {
            background: white;
            border-radius: 8px;
            padding: 1.25rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #f1f5f9;
            transition: all 0.2s ease;
        }
        
        .insight-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .insight-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .insight-icon {
            font-size: 1.1rem;
        }
        
        .key-trends-card .insight-icon { color: #3b82f6; }
        .risk-factors-card .insight-icon { color: #f59e0b; }
        .opportunities-card .insight-icon { color: #10b981; }
        .methodology-card .insight-icon { color: #8b5cf6; }
        
        .insight-header h5 {
            margin: 0;
            font-weight: 600;
            color: #1e293b;
        }
        
        .insight-text {
            color: #475569;
            line-height: 1.6;
            font-size: 0.95rem;
        }
        
        .insights-actions {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        .btn.btn-outline {
            background: transparent;
            border: 1px solid #cbd5e1;
            color: #64748b;
        }
        
        .btn.btn-outline:hover {
            background: #f1f5f9;
            border-color: #94a3b8;
        }

        /* Add this to your existing CSS in the <style> section */
        .pl-table-scroll {
            overflow-x: auto;
            max-height: 800px;
            overflow-y: auto;
            position: relative;
        }
        
        .pl-forecast-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            min-width: 1400px;
            position: relative;
            border-radius: 0;
        }
        
        /* Freeze the first column (Line Item) */
        .pl-line-item-header,
        .pl-line-item {
            position: sticky;
            left: 0;
            background: #f1f5f9 !important;
            z-index: 2;
            border-right: 2px solid #e2e8f0;
            min-width: 200px;
            max-width: 200px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        
        /* Ensure headers have higher z-index than regular cells */
        .pl-forecast-table th.pl-line-item-header {
            z-index: 3;
            background: #e2e8f0 !important;
        }
        
        /* Section headers also need to be sticky */
        .pl-section-header-row td {
            position: sticky;
            left: 0;
            background: #f8fafc !important;
            z-index: 2;
            border-right: 2px solid #e2e8f0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        /* AI Insights Container - New Design */
        .ai-insights-container {
            margin-top: 2rem;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
            overflow: hidden;
            animation: slideInUp 0.4s ease-out;
        }
        
        @keyframes slideInUp {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        /* AI Insights Header - Fixed Design */
        .insights-header-AIinsight {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .insights-header-AIinsight h4 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            font-size: 1.125rem;
            color: white;
        }
        
        .insights-header-AIinsight .fas {
            color: #60a5fa;
            font-size: 1.2rem;
        }
        
        .insights-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
            font-size: 0.9rem;
        }
        
        /* Enhanced Confidence Badge */
        .confidence-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.375rem 0.875rem;
            border-radius: 20px;
            border: none;
            font-weight: 600;
            font-size: 0.8rem;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        .forecast-date {
            color: #cbd5e1;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        /* Enhanced Insights Content */
        .insights-content {
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            background: #fafbfc;
        }
        
        /* Better Insight Cards - Header on Top */
        .insight-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .insight-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        }
        
        .insight-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            border-color: #d1d5db;
        }
        
        /* Card-specific accent colors */
        .key-trends-card::before {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        }
        
        .risk-factors-card::before {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }
        
        .opportunities-card::before {
            background: linear-gradient(90deg, #10b981, #059669);
        }
        
        .methodology-card::before {
            background: linear-gradient(90deg, #8b5cf6, #7c3aed);
        }
        
        /* Header at Top of Card */
        .insight-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            margin: 0;
        }
        
        .insight-icon {
            font-size: 1.1rem;
            padding: 0.375rem;
            border-radius: 6px;
        }
        
        /* Icon specific styling */
        .key-trends-card .insight-icon { 
            color: #3b82f6; 
            background: #eff6ff;
        }
        
        .risk-factors-card .insight-icon { 
            color: #f59e0b; 
            background: #fffbeb;
        }
        
        .opportunities-card .insight-icon { 
            color: #10b981; 
            background: #ecfdf5;
        }
        
        .methodology-card .insight-icon { 
            color: #8b5cf6; 
            background: #f5f3ff;
        }
        
        .insight-header h5 {
            margin: 0;
            font-weight: 600;
            color: #1e293b;
            font-size: 0.95rem;
        }
        
        /* Content Area - Clean and Spacious */
        .insight-text {
            padding: 1.5rem;
            color: #475569;
            line-height: 1.6;
            font-size: 0.925rem;
            flex: 1;
        }
        
        /* Enhanced Actions Section */
        .insights-actions {
            padding: 1.25rem 2rem;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }
        
        .insights-actions .btn {
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn.btn-outline {
            background: white;
            border: 1px solid #d1d5db;
            color: #6b7280;
        }
        
        .btn.btn-outline:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
            color: #374151;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .insights-content {
                grid-template-columns: 1fr;
                padding: 1.5rem;
            }
            
            .insights-header-AIinsight {
                padding: 1rem 1.5rem;
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .insights-meta {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-start;
            }
            
            .insights-actions {
                padding: 1rem 1.5rem;
                flex-wrap: wrap;
            }
        }

        /* Navigation Bottom Section */
        .nav-bottom {
            margin-top: auto;
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Updated Connection Status for Navigation */
        .nav-bottom .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.2s ease;
            width: 100%;
            justify-content: flex-start;
        }
        
        .nav-bottom .connection-status.connected {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.3);
            color: #86efac;
        }
        
        .nav-bottom .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }
        
        .nav-bottom .connection-status i {
            font-size: 0.75rem;
            opacity: 0.9;
        }
        
        .nav-bottom .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            transition: background-color 0.2s ease;
            margin-left: auto;
        }
        
        .nav-bottom .connection-status.connected .connection-dot {
            background: #22c55e;
        }
        
        .nav-bottom .connection-status.disconnected .connection-dot {
            background: #ef4444;
        }

        #forecastTrendingContainer {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        }

        /* 2026 Forecast Specific Styling */
        .growth-assumptions-row td {
            background: #f0f9ff !important;
            border: 1px solid #bfdbfe !important;
            font-weight: 600 !important;
            color: #1e40af !important;
        }
        
        .projected-totals-row td {
            background: #f8fafc !important;
            border: 1px solid #e2e8f0 !important;
            font-weight: 600 !important;
            padding: 0.75rem 0.5rem !important;
        }

        /* Enhanced 2026 Table Styling */
        .forecast-data-row:hover {
            background: #f8fafc !important;
        }
        
        .section-header {
            background: #ffffff !important;
            font-weight: 600 !important;
            color: #374151 !important;
            border-top: 2px solid #e2e8f0 !important;
            border-bottom: 1px solid #e2e8f0 !important;
        }
        
        .calculated-row {
            border-top: 2px solid #d1d5db !important;
            border-bottom: 2px solid #d1d5db !important;
        }

        /* Modern Section Headers */
        .modern-section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            margin-bottom: 2rem;
            color: white;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem 2.5rem;
            gap: 2rem;
        }
        
        .header-left h2.section-main-title {
            margin: 0 0 0.5rem 0;
            font-size: 2rem;
            font-weight: 700;
            color: white;
        }
        
        .header-left .section-description {
            margin: 0;
            font-size: 1rem;
            opacity: 0.9;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        
        /* Balance indicator in header */
        .balance-indicator .balance-status {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }
        
        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .header-content {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
                gap: 1.5rem;
            }
            
            .header-right {
                justify-content: center;
            }

            .forecasting-ai-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .forecasting-ai-controls-left,
            .forecasting-ai-controls-right {
                justify-content: flex-start;
            }
        }

        #plForecast2026Table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            min-width: 1400px;
            background: white;
        }
        
        #plForecast2026Table th,
        #plForecast2026Table td {
            border: 1px solid #e5e7eb;
            text-align: center;
            vertical-align: middle;
        }
        
        #plForecast2026Table .line-item {
            text-align: left !important;
            font-weight: 500;
            color: #374151;
            padding: 0.75rem 1rem;
            background: #f8fafc;
            border-right: 2px solid #e2e8f0;
        }
        
        #plForecast2026Table .forecast-cell {
            padding: 0.5rem;
            text-align: right;
            font-family: 'SF Mono', 'Monaco', monospace;
            background: white;
        }
        
        #plForecast2026Table .total-cell {
            padding: 0.5rem;
            text-align: right;
            font-family: 'SF Mono', 'Monaco', monospace;
            background: #fef3c7;
            font-weight: 600;
        }
        
        #plForecast2026Table .calculated-cell {
            padding: 0.5rem;
            text-align: right;
            font-family: 'SF Mono', 'Monaco', monospace;
            background: #dbeafe;
            font-weight: 600;
        }
        
        #plForecast2026Table .total-prominent {
            background: #fde047 !important;
            font-weight: 700;
            font-size: 0.95rem;
        }
        
        #plForecast2026Table .calculated-prominent {
            background: #bfdbfe !important;
            font-weight: 700;
            font-size: 0.95rem;
        }
        
        #plForecast2026Table .section-header {
            background: #f8fafc !important;
            font-weight: 600;
            color: #374151;
            text-align: left !important;
            padding: 0.75rem 1rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        #plForecast2026Table .pl-margin-row td {
            background: #f1f5f9 !important;
            font-style: italic;
            color: #64748b;
            font-weight: 500;
            padding: 0.5rem;
        }
        
        #plForecast2026Table .pl-margin-cell {
            text-align: right !important;
            font-family: 'SF Mono', 'Monaco', monospace;
            font-weight: 600;
            color: #475569;
        }
        
        #plForecast2026Table .pl-margin-prominent {
            background: #e2e8f0 !important;
            font-weight: 700;
        }
        
        /* 2026 table headers */
        #plForecast2026Table thead th {
            background: #f9fafb;
            color: #374151;
            font-weight: 600;
            padding: 0.75rem 0.5rem;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 5;
        }
        
        #plForecast2026Table .pl-line-item-header {
            text-align: left !important;
            min-width: 200px;
            background: #f1f5f9 !important;
        }
        
        #plForecast2026Table .pl-month-header {
            min-width: 80px;
            background: #f9fafb;
        }
        
        #plForecast2026Table .pl-total-header {
            min-width: 100px;
            background: #fef3c7 !important;
            font-weight: 700;
        }

        /* Multi-Year Specific Styles */
        .multi-year-tables-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            margin-top: 1.5rem;
        }
        
        .year-section {
            background: #ffffff;
            border-radius: 0; /* Remove curved edges */
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
        }
        
        .year-header {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #3b82f6;
        }
        
        .year-header h5 {
            margin: 0;
            color: #1e40af;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .pl-table-scroll {
            overflow-x: auto;
            width: fit-content; /* Make container only as wide as needed */
            max-width: 100%;
        }
        
        .pl-quarter-header {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            font-weight: 600;
            text-align: center;
            padding: 12px 16px;
            border: 1px solid #2563eb;
            min-width: 120px;
            border-radius: 0; /* Remove curved edges */
        }
        
        /* Responsive adjustments for quarterly view */
        @media (max-width: 1200px) {
            .multi-year-tables-container {
                gap: 1.5rem;
            }
            
            .year-section {
                padding: 1rem;
            }
            
            .pl-quarter-header {
                min-width: 80px;
                font-size: 0.85rem;
            }
        }

        .pl-year-header {
            background-color: #f8f9fa;
            font-weight: 600;
            text-align: center;
            padding: 12px 8px;
            border: 1px solid #dee2e6;
            min-width: 100px;
        }
        
        .pl-growth-header {
            background-color: #e8f5e8;
            font-weight: 600;
            text-align: center;
            padding: 12px 8px;
            border: 1px solid #dee2e6;
            min-width: 80px;
            font-size: 0.9rem;
        }
        
        .pl-cagr-header {
            background-color: #fff3cd;
            font-weight: 600;
            text-align: center;
            padding: 12px 8px;
            border: 1px solid #dee2e6;
            min-width: 80px;
            font-size: 0.9rem;
        }
        
        .pl-year-cell, .pl-growth-cell, .pl-cagr-cell {
            text-align: right;
            padding: 8px;
            border: 1px solid #dee2e6;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .pl-growth-cell {
            background-color: #f8fff8;
        }
        
        .pl-growth-cell.positive {
            color: #28a745;
            font-weight: 600;
        }
        
        .pl-growth-cell.negative {
            color: #dc3545;
            font-weight: 600;
        }
        
        .pl-cagr-cell {
            background-color: #fffbf0;
            font-weight: 600;
        }
        
        .pl-section-header td {
            background-color: #e9ecef;
            font-weight: 700;
            padding: 8px;
            border: 1px solid #dee2e6;
            color: #495057;
            font-size: 0.9rem;
            text-align: left !important;
        }
        
        .pl-summary-row:hover {
            background-color: #f8f9fa;
        }
        
        .percentage::after {
            content: '%';
        }

        .aging-chart-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            width: 100%;
            height: 450px; /* Increased to accommodate legend */
            display: flex;
            flex-direction: column;
        }

        .aging-chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
            text-align: center;
            flex-shrink: 0;
        }
        
        .aging-chart-canvas {
            flex-grow: 1;
            position: relative;
            max-height: 300px;
        }

        .aging-charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Equal width columns */
            gap: 2rem;
            margin-bottom: 2rem;
            align-items: start;
            width: 100%;
            max-width: 1200px; /* Prevent too wide on large screens */
            margin-left: 2rem;
            margin-right: 2rem;
        }

        /* Total Row Styling for Aging Tables */
        .aging-total-row {
            background: #f8fafc !important;
            border-top: 2px solid #e2e8f0 !important;
            font-weight: 600;
        }
        
        .aging-total-row:hover {
            background: #f8fafc !important; /* Don't change on hover */
        }
        
        .total-label-cell {
            text-align: left !important;
            font-weight: 700;
            color: #1e40af;
            font-size: 0.875rem;
            letter-spacing: 0.5px;
            padding: 1rem 0.75rem !important;
        }
        
        .total-amount {
            font-weight: 700 !important;
            background: #f1f5f9 !important;
            border: 1px solid #e2e8f0;
        }
        
        .grand-total {
            background: #dbeafe !important;
            color: #1e40af !important;
            font-weight: 800 !important;
            font-size: 0.95rem;
            border: 2px solid #bfdbfe !important;
        }
        
        /* Ensure total row stands out */
        .aging-table-section .aging-table .aging-total-row td {
            border-bottom: none !important;
            border-top: 2px solid #cbd5e1 !important;
        }
        
        /* Make sure amounts in total row are properly aligned */
        .aging-total-row .amount-cell {
            text-align: right !important;
            vertical-align: middle;
        }

        #scenarioAnalysisWrapper .scenario-comparison-table-wrapper {
            overflow-x: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        
        #scenarioAnalysisWrapper .scenario-comparison-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1800px; /* Force horizontal scroll */
        }
        
        /* General header and cell styling */
        #scenarioAnalysisWrapper .scenario-comparison-table th,
        #scenarioAnalysisWrapper .scenario-comparison-table td {
            padding: 0.75rem 1rem;
            white-space: nowrap;
            vertical-align: middle;
        }
        
        /* Freeze the first column ("Financial Item") */
        #scenarioAnalysisWrapper .scenario-comparison-table th:first-child,
        #scenarioAnalysisWrapper .scenario-comparison-table td:first-child {
            position: sticky;
            left: 0;
            z-index: 2;
            background-color: #ffffff;
            text-align: left;
            font-weight: 600;
            width: 200px;
            min-width: 200px;
            border-right: 2px solid #e2e8f0;
        }
        
        /* Header Styling */
        #scenarioAnalysisWrapper .scenario-comparison-table thead {
            position: sticky;
            top: 0;
            z-index: 3;
            background-color: #f8fafc;
        }
        
        #scenarioAnalysisWrapper .year-header th {
            border-bottom: 2px solid #e2e8f0;
            font-size: 0.9rem;
            color: #1e293b;
            text-align: center;
        }
        
        #scenarioAnalysisWrapper .sub-header th {
            font-size: 0.8rem;
            font-weight: 500;
            color: #475569;
            text-align: right;
            border-bottom: 1px solid #e2e8f0;
        }
        
        /* UNIFORM COLUMN WIDTHS */
        #scenarioAnalysisWrapper .base-col,
        #scenarioAnalysisWrapper .scenario-col,
        #scenarioAnalysisWrapper .change-col {
            width: 180px; /* Set a uniform width for all data columns */
            min-width: 180px;
            text-align: right;
        }
        
        /* Styling for Readability */
        #scenarioAnalysisWrapper .change-col {
            border-right: 2px solid #e2e8f0;
        }
        
        #scenarioAnalysisWrapper tbody tr:hover td,
        #scenarioAnalysisWrapper tbody tr:hover th {
            background-color: #f0f9ff;
        }
        
        /* COLORING FIX for "Change" column */
        #scenarioAnalysisWrapper .positive {
            color: #10b981 !important; /* Green for good changes */
            font-weight: 600;
        }
        #scenarioAnalysisWrapper .negative {
            color: #ef4444 !important; /* Red for bad changes */
            font-weight: 600;
        }
        #scenarioAnalysisWrapper .neutral {
            color: #64748b; /* Neutral for no change */
        }
        
        .scenario-status {
            display: flex;
            align-items: baseline; /* This is the fix */
            gap: 0.5rem;
            background: #f0f9ff; 
            border: 1px solid #bae6fd; 
            padding: 0.75rem; 
            border-radius: 8px;
        }

        /* --- ADD this CSS block for the new Scenario Control Panel --- */

        #scenarioControlPanel {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        #scenarioControlPanel .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        #scenarioControlPanel .panel-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        #scenarioControlPanel .panel-title i {
            color: #1e40af;
            font-size: 1.25rem;
        }
        
        #scenarioControlPanel .panel-title h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        #scenarioControlPanel .panel-content {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        #scenarioControlPanel .scenario-status {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
        }
        
        #scenarioControlPanel .timeframe-selector {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        #scenarioControlPanel .filter-label {
            font-weight: 500;
            color: #475569;
            font-size: 0.875rem;
        }
        
        #scenarioControlPanel .year-toggle-group {
            display: flex;
            gap: 0.5rem;
        }
        
        #scenarioControlPanel .scenario-year-btn {
            background-color: #ffffff;
            border: 1px solid #d1d5db;
            color: #4b5563;
            padding: 0.5rem 1rem;
            border-radius: 20px; /* Pill shape */
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        #scenarioControlPanel .scenario-year-btn .check-icon {
            display: none; /* Hide checkmark by default */
            color: #ffffff;
            font-size: 0.8rem;
        }
        
        #scenarioControlPanel .scenario-year-btn.active {
            background-color: #1e40af;
            border-color: #1e40af;
            color: #ffffff;
            box-shadow: 0 4px 8px rgba(30, 64, 175, 0.2);
        }
        
        #scenarioControlPanel .scenario-year-btn.active .check-icon {
            display: inline-block; /* Show checkmark when active */
        }
        
        #scenarioControlPanel .scenario-year-btn:hover:not(.active) {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        #scenarioControlPanel .scenario-actions .btn {
            font-size: 0.875rem;
        }

        /* --- ADD this CSS for the impact breakdown --- */
        .impact-breakdown {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .breakdown-year-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
        }
        
        .breakdown-year-label {
            color: #475569;
            font-weight: 500;
        }
        
        .breakdown-year-value {
            font-weight: 600;
        }

        /* Save Scenario Modal - Unique Styles */
        .save-scenario-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
        }
        
        .save-scenario-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .save-scenario-modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 480px;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .save-scenario-overlay.show .save-scenario-modal {
            transform: scale(1) translateY(0);
        }
        
        .save-scenario-header {
            padding: 24px 24px 16px 24px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .save-scenario-title {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .save-scenario-close {
            background: #f8fafc;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            transition: all 0.2s ease;
        }
        
        .save-scenario-close:hover {
            background: #e2e8f0;
            color: #475569;
        }
        
        .save-scenario-body {
            padding: 16px 24px 24px 24px;
        }
        
        .save-scenario-group {
            margin-bottom: 20px;
        }
        
        .save-scenario-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
        }
        
        .save-scenario-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }
        
        .save-scenario-input:focus {
            outline: none;
            border-color: #fbbf24;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
        }
        
        .save-scenario-textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }
        
        .save-scenario-footer {
            padding: 16px 24px 24px 24px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .save-scenario-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .save-scenario-btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
        }
        
        .save-scenario-btn-secondary:hover {
            background: #e2e8f0;
            color: #334155;
        }
        
        .save-scenario-btn-primary {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #1e293b;
        }
        
        .save-scenario-btn-primary:hover {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
        }

        /* Load Scenarios Modal - Unique Styles */
        .load-scenarios-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
        }
        
        .load-scenarios-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .load-scenarios-modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .load-scenarios-overlay.show .load-scenarios-modal {
            transform: scale(1) translateY(0);
        }
        
        .load-scenarios-header {
            padding: 24px 24px 16px 24px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .load-scenarios-title {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .load-scenarios-close {
            background: #f8fafc;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            transition: all 0.2s ease;
        }
        
        .load-scenarios-close:hover {
            background: #e2e8f0;
            color: #475569;
        }
        
        .load-scenarios-body {
            padding: 16px 24px;
            max-height: 50vh;
            overflow-y: auto;
        }
        
        .scenario-list-item {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .scenario-list-item:hover {
            border-color: #fbbf24;
            background: #fffbeb;
            transform: translateY(-1px);
        }
        
        .scenario-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .scenario-item-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 1rem;
        }
        
        .scenario-item-date {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        .scenario-item-description {
            color: #475569;
            font-size: 0.875rem;
            line-height: 1.4;
            margin-bottom: 8px;
        }
        
        .scenario-item-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .scenario-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .scenario-load-btn {
            background: #fbbf24;
            color: #1e293b;
        }
        
        .scenario-load-btn:hover {
            background: #f59e0b;
        }
        
        .scenario-delete-btn {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .scenario-delete-btn:hover {
            background: #fecaca;
        }

        /* Budget Management Unique Styles */
        .budget-mgmt-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .budget-mgmt-meta {
            padding: 1rem 0;
        }
        
        /* Budget Table Unique Styles */
        .budget-table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .budget-detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            background: white;
        }
        
        .budget-detail-table th {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 0.75rem 0.5rem;
            text-align: center;
            font-weight: 600;
            color: #475569;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .budget-line-header {
            min-width: 200px;
            text-align: left !important;
        }
        
        .budget-month-header {
            min-width: 80px;
        }
        
        .budget-total-header {
            min-width: 100px;
            background: #059669 !important;
            color: white !important;
            font-weight: 700;
            text-align: center;
            white-space: nowrap;
        }
        
        .budget-actions-header {
            width: 60px;
        }
        
        /* Budget Category Rows */
        .budget-category-row {
            background: #f1f5f9;
            border-top: 2px solid #cbd5e1;
        }
        
        .budget-category-cell {
            padding: 0.75rem;
            font-weight: 600;
            color: #1e293b;
            border: 1px solid #e2e8f0;
            position: relative; 
            overflow: visible;
        }
        
        .budget-category-toggle {
            cursor: pointer;
            margin-right: 0.5rem;
            color: #64748b;
            transition: transform 0.2s ease;
        }
        
        .budget-category-toggle.collapsed i {
            transform: rotate(-90deg);
        }
        
        .budget-category-title {
            color: #1e293b;
        }
        
        .budget-category-total {
            text-align: center;
            font-weight: 600;
            color: #059669;
            border: 1px solid #e2e8f0;
        }
        
        /* Budget Line Item Rows */
        .budget-line-row {
            transition: background-color 0.2s ease;
        }
        
        .budget-line-row:hover {
            background: #fafafa;
        }
        
        .budget-line-row.hidden {
            display: none;
        }
        
        .budget-line-cell {
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
        }
        
        .budget-line-name {
            padding-left: 2rem;
            font-weight: 500;
            color: #374151;
        }
        
        .budget-amount-input {
            width: 80px;
            padding: 0.25rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            text-align: right;
            font-size: 0.875rem;
        }
        
        .budget-amount-input:focus {
            outline: none;
            border-color: #fbbf24;
            box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.1);
        }
        
        /* Budget Summary Rows */
        .budget-summary-row {
            background: #fef9e7;
            border-top: 1px solid #fbbf24;
        }
        
        .budget-final-row {
            background: #f0f9f4;
            border-top: 2px solid #059669;
        }
        
        .budget-summary-label {
            padding: 0.75rem;
            font-weight: 700;
            color: #1e293b;
            border: 1px solid #e2e8f0;
        }
        
        .budget-summary-cell {
            padding: 0.75rem 0.5rem;
            text-align: center;
            font-weight: 600;
            color: #059669;
            border: 1px solid #e2e8f0;
        }
        
        .budget-summary-total {
            padding: 0.75rem 0.5rem;
            text-align: center;
            font-weight: 700;
            color: #059669;
            background: #fef3c7;
            border: 1px solid #fbbf24;
        }
        
        /* Budget Action Buttons */
        .budget-line-actions {
            display: flex;
            gap: 0.25rem;
            justify-content: center;
        }
        
        .budget-action-btn {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .budget-action-btn:hover {
            background: #f1f5f9;
            color: #475569;
        }
        
        .budget-action-btn.delete:hover {
            background: #fef2f2;
            color: #dc2626;
        }

        /* Enhanced Budget Controls */
        #budgetControlPanel {
            background: white;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .budget-controls-new {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .budget-controls-new .budget-controls-left {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .budget-controls-new .budget-selector-group,
        .budget-controls-new .budget-status-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .budget-controls-new .budget-selector-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .budget-controls-new .budget-year-select {
            padding: 0.6rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            font-weight: 500;
            color: #1e293b;
            min-width: 200px;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .budget-controls-new .budget-year-select:focus {
            outline: none;
            border-color: #fbbf24;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
        }

        .budget-controls-new .priority-badge {
            padding: 0.6rem 1rem;
            border: 2px solid transparent;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            min-width: 100px;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .budget-controls-new .priority-badge.draft {
            background: #fef3c7;
            color: #92400e;
            border-color: #fbbf24;
        }
        
        .budget-controls-new .priority-badge.active {
            background: #d1fae5;
            color: #065f46;
            border-color: #10b981;
        }
        
        .budget-controls-new .priority-badge.completed {
            background: #dbeafe;
            color: #1e40af;
            border-color: #3b82f6;
        }
        
        /* Enhanced buttons */
        .btn-add-line {
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .btn-save-budget {
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .btn-add-line:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .btn-save-budget:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
        }
        
        /* Enhanced Budget Summary Cards */
        .budget-summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .budget-summary-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }
        
        .budget-summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
        }
        
        .budget-summary-card h4 {
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        
        .budget-summary-card .amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        
        .budget-summary-card .vs-forecast {
            color: #059669;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        /* Enhanced Table Headers */
        #budgets-section .budget-detail-table thead {
            position: sticky;
            top: 0;
            z-index: 20;
        }
        
        #budgets-section .budget-detail-table thead th {
            background: #1f293b; /* Dark background for high contrast */
            color: #F8FAFC !important; /* White text, forced */
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 1rem 0.75rem;
            border-bottom: 2px solid #fbbf24; /* Gold accent border */
            border-right: 1px solid #475569; /* Separator line */
            position: sticky;
            top: 0;
            z-index: 3;
        }

        #budgets-section .budget-detail-table thead th:last-child {
            border-right: none;
        }
        
        .budget-detail-table thead th::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
        }
        
        /* Enhanced Section Headers */
        .budget-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .budget-section-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #1f2937;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .budget-section-title i {
            color: #fbbf24;
            font-size: 1.25rem;
        }
        
        .budget-meta-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .budget-meta-info span {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .budget-meta-info i {
            color: #9ca3af;
        }

        /* Freeze the first column (LINE ITEM) */
        .budget-detail-table th:first-child,
        .budget-detail-table td:first-child {
            position: sticky;
            left: 0;
            z-index: 2;
            background: white;
            border-right: 2px solid #e2e8f0;
            min-width: 200px;
            max-width: 200px;
        }
        
        .budget-detail-table th:first-child {
            background: #1f293b;
            z-index: 4;
        }
        
        /* Category subtotal rows */
        .budget-category-subtotal {
            background: #f1f5f9 !important;
            border-top: 2px solid #cbd5e1;
            border-bottom: 2px solid #cbd5e1;
            font-weight: 600;
        }
        
        .budget-category-subtotal td {
            padding: 0.75rem;
            color: #1e293b;
            text-align: center;
            border: 1px solid #cbd5e1;
        }
        
        .budget-category-subtotal td:first-child {
            text-align: right;
            padding-right: 1rem;
            background: #f1f5f9 !important;
        }
        
        /* Fix the total column header */
        .budget-total-header {
            background: #059669 !important;
            color: white !important;
            font-weight: 700;
            text-align: center;
            white-space: nowrap;
        }
        
        /* Fix the total column cells */
        .budget-total-cell {
            background: #f0fdf4;
            color: #059669;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
            padding: 0.75rem 0.5rem;
            border-left: 2px solid #059669;
        }
        
        /* Final totals styling */
        .budget-final-row .budget-total-cell {
            background: #065f46;
            color: white;
            font-weight: 700;
        }

        .category-target-input {
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: nowrap;
            position: relative; /* Add this */
            z-index: 10; /* Add this */
        }

        .category-target-input label {
            font-size: 0.75rem;
            white-space: nowrap;
            min-width: 40px;
        }
        
        .target-input {
            width: 135px;
            padding: 0.25rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .btn-ai-allocate {
            padding: 0.4rem 0.8rem;
            background: #fbbf24;
            color: #1e293b;
            border: none;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            min-width: 100px;
            position: relative; /* Add this */
            z-index: 10; /* Add this to bring it to front */
        }
        
        .btn-ai-allocate:hover:not(:disabled) {
            background: #f59e0b;
            transform: translateY(-1px);
        }
        
        .btn-ai-allocate:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .ai-rationale-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 1rem auto;
        }
        
        .allocation-breakdown {
            display: grid;
            grid-template-columns: 1fr 80px;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .breakdown-item {
            display: contents;
        }
        
        .percentage {
            font-weight: 600;
            color: #059669;
            text-align: right;
        }

        .ai-rationale-explanation {
            margin-top: 2rem;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
        }
        
        .rationale-container {
            max-width: 100%;
        }
        
        .rationale-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #fbbf24;
        }
        
        .rationale-header h4 {
            margin: 0 0 0.5rem 0;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .allocation-summary-info {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            font-size: 0.875rem;
        }
        
        .summary-item {
            color: #64748b;
        }
        
        .rationale-content {
            display: grid;
            gap: 1.5rem;
        }
        
        .rationale-section {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .rationale-section h5 {
            margin: 0 0 0.75rem 0;
            color: #374151;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .rationale-section p {
            margin: 0;
            line-height: 1.6;
            color: #4b5563;
        }
        
        .assumptions-list {
            margin: 0;
            padding-left: 1.5rem;
            color: #4b5563;
        }
        
        .assumptions-list li {
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }
        
        .allocation-breakdown-grid {
            display: grid;
            grid-template-columns: 2fr 80px 120px;
            gap: 0.5rem;
            align-items: center;
        }
        
        .breakdown-item {
            display: contents;
        }
        
        .account-info {
            color: #374151;
            font-weight: 500;
        }
        
        .percentage {
            color: #059669;
            font-weight: 600;
            text-align: center;
        }
        
        .amount {
            color: #059669;
            font-weight: 600;
            text-align: right;
        }
        
        @media (max-width: 768px) {
            .allocation-summary-info {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .allocation-breakdown-grid {
                grid-template-columns: 1fr;
                gap: 0.25rem;
            }
            
            .breakdown-item {
                display: block;
                padding: 0.5rem;
                background: #f9fafb;
                border-radius: 4px;
                margin-bottom: 0.5rem;
            }
        }

        .comparison-options {
            margin-bottom: 1.5rem;
        }
        
        .options-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
        }
        
        .options-section h5 {
            margin: 0 0 0.75rem 0;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .checkbox-group {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        
        .checkbox-group .checkbox-label {
            display: flex;
            align-items: center;
            font-size: 0.875rem;
            color: #374151;
            cursor: pointer;
            font-weight: 500;
        }
        
        .checkbox-group .checkbox-label input[type="checkbox"] {
            margin-right: 0.5rem;
            accent-color: #fbbf24;
        }

        /* Update this CSS section */
        .suggestions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem 0;
        }
        
        .suggestions-toggle {
            background: none;
            border: none;
            color: #64748b;
            font-size: 14px;
            cursor: pointer;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .suggestions-toggle:hover {
            background: #f1f5f9;
            color: #334155;
        }
        
        .suggestions-toggle i {
            transition: transform 0.2s ease;
        }
        
        /* When collapsed, rotate arrow 180 degrees (down arrow becomes up arrow) */
        .suggestions-container.collapsed .suggestions-toggle i {
            transform: rotate(180deg);
        }
        
        .suggestions-container.collapsed .suggestions-grid {
            display: none;
        }
        
        /* Minimize space when collapsed */
        .suggestions-container.collapsed {
            margin-bottom: 0;
        }
        
        .suggestions-container.collapsed .suggestions-header {
            margin-bottom: 0;
            padding: 0.25rem 0;
        }
        
        /* Update existing suggestions-container to have transition */
        .suggestions-container {
            transition: margin-bottom 0.3s ease;
        }

        /* Industry Benchmarking Specific Styles */
        .benchmark-data-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6b7280;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        
        .benchmark-data-info i {
            color: #3b82f6;
        }
        
        .benchmark-industry-card .metric-content {
            padding: 0;
        }
        
        .industry-checkbox-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.25rem;
            padding: 0.75rem;
        }
        
        .industry-checkbox {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            color: #374151;
            padding: 0.125rem 0.25rem;
            border-radius: 4px;
            transition: background-color 0.2s;
            position: relative;
            z-index: 999;
        }
        
        .industry-checkbox input[type="checkbox"] {
            accent-color: #fbbf24;
            position: relative;
            z-index: 999;
        }

        .industry-checkbox:hover {
            background-color: #f8fafc;
        }
        
        .company-metrics-summary {
            padding: 1rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .metric-loading {
            text-align: center;
            color: #9ca3af;
            font-style: italic;
        }
        
        /* Benchmark Gauges Grid */
        .benchmark-gauges-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .gauge-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .gauge-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .gauge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .gauge-header h5 {
            margin: 0;
            color: #1e293b;
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        .gauge-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .gauge-chart {
            height: 120px;
            margin: 1rem 0;
        }
        
        .gauge-percentile {
            text-align: center;
            font-size: 0.875rem;
            font-weight: 600;
            padding: 0.5rem;
            border-radius: 6px;
        }
        
        .gauge-percentile.excellent {
            background: #dcfce7;
            color: #166534;
        }
        
        .gauge-percentile.good {
            background: #fef3c7;
            color: #92400e;
        }
        
        .gauge-percentile.needs-improvement {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* AI Advisor Styles */
        .ai-advisor-container {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .ai-advisor-content {
            line-height: 1.6;
            color: #374151;
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .benchmark-gauges-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .benchmark-gauges-grid {
                grid-template-columns: 1fr;
            }
            
            .industry-checkbox-grid {
                grid-template-columns: 1fr;
            }
        }

        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .section-actions {
            display: flex;
            gap: 0.5rem;
        }

        .icon-working-capital { 
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 50%, #c084fc 100%);
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
        }
        .icon-budget { 
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 50%, #fcd34d 100%);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
        }
        .icon-industry { 
            background: linear-gradient(135deg, #10b981 0%, #34d399 50%, #6ee7b7 100%);
            box-shadow: 0 4px 12px rgba(52, 211, 153, 0.3);
        }

        /* Risk & Alert Summary Panel Styles */
        .risk-alerts-container {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .alert-category-card {
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }
        
        .alert-category-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .alert-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
        }
        
        .alert-category-header h5 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .alert-count {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 500;
        }
        
        .alert-items {
            padding: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            margin-bottom: 0.75rem;
            transition: all 0.2s ease;
        }
        
        .alert-item:last-child {
            margin-bottom: 0;
        }
        
        .alert-item:hover {
            border-color: #cbd5e1;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .alert-severity {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-top: 0.5rem;
            flex-shrink: 0;
        }
        
        .alert-severity.high {
            background: #ef4444;
        }
        
        .alert-severity.medium {
            background: #f59e0b;
        }
        
        .alert-severity.low {
            background: #10b981;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }
        
        .alert-description {
            font-size: 0.8rem;
            color: #64748b;
            line-height: 1.4;
        }
        
        .alert-value {
            font-size: 0.8rem;
            font-weight: 600;
            color: #374151;
            margin-top: 0.25rem;
        }
        
        .no-alerts {
            text-align: center;
            color: #64748b;
            font-size: 0.875rem;
            padding: 2rem 1rem;
        }
        
        .no-alerts i {
            font-size: 2rem;
            color: #10b981;
            margin-bottom: 0.5rem;
            display: block;
        }

        /* Simplified P&L Comparison Styles */
        .period-selector-dashboard {
            display: flex;
            align-items: center;
        }
        
        .period-selector-dashboard select {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 0.875rem;
            color: #374151;
            min-width: 140px;
        }
        
        .simplified-pl-container {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .simplified-pl-table-wrapper {
            overflow-x: auto;
        }
        
        .simplified-pl-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .simplified-pl-table th {
            background: #f8fafc;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .simplified-pl-table th:last-child {
            text-align: right;
        }
        
        .simplified-pl-table td {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }
        
        .simplified-pl-table tbody tr:hover {
            background: #f8fafc;
        }
        
        .pl-line-item {
            font-weight: 600;
            color: #1e293b;
        }
        
        .pl-value {
            text-align: right;
            font-weight: 500;
            color: #374151;
        }
        
        .pl-variance {
            text-align: right;
            font-weight: 600;
        }
        
        .pl-variance.positive {
            color: #059669;
        }
        
        .pl-variance.negative {
            color: #dc2626;
        }
        
        .pl-variance.neutral {
            color: #6b7280;
        }
        
        /* Dashboard Trending Chart Styles */
        .dashboard-trending-container {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .dashboard-trending-chart {
            margin-bottom: 1.5rem;
        }
        
        .trending-insights-dashboard {
            background: #f8fafc;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #e2e8f0;
        }
        
        .trending-insights-dashboard h5 {
            margin: 0 0 0.75rem 0;
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .insight-item-dashboard {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .insight-item-dashboard:last-child {
            margin-bottom: 0;
        }
        
        .insight-icon-dashboard {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: white;
            flex-shrink: 0;
            margin-top: 0.125rem;
        }
        
        .insight-icon-dashboard.revenue {
            background: #10b981;
        }
        
        .insight-icon-dashboard.expense {
            background: #ef4444;
        }
        
        .insight-icon-dashboard.trend {
            background: #3b82f6;
        }
        
        .insight-text-dashboard {
            color: #374151;
        }

        .page-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid #e2e8f0;
            background: white;
            cursor: pointer;
            margin: 0 2px;
        }
        
        .page-btn.active {
            background: #fbbf24;
            color: white;
            border-color: #fbbf24;
        }
        
        .page-btn:hover:not(.active) {
            background: #f8fafc;
        }

        .btn.dark-icon i {
            color: #1f2937;
        }
        
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <div class="logo">MontPro</div>
            <div class="tagline">Financial Intelligence Hub</div>
        </div>
        <button class="sidebar-toggle" onclick="toggleSidebar()">
            <i class="fas fa-chevron-left"></i>
        </button>
        <div class="nav-menu">
            <div class="nav-item">
                <a href="#dashboard" class="nav-link active" data-section="dashboard" data-tooltip="Dashboard Overview">
                    <i class="nav-icon fas fa-tachometer-alt"></i>
                    <span>Dashboard Overview</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="#ap-ar" class="nav-link" data-section="ap-ar" data-tooltip="AP/AR Tracking">
                    <i class="nav-icon fas fa-exchange-alt"></i>
                    <span>AP/AR Tracking</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="#statements" class="nav-link" data-section="statements" data-tooltip="Financial Statements">
                    <i class="nav-icon fas fa-chart-column"></i>
                    <span>Financial Statements</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="#reports" class="nav-link" data-section="reports" data-tooltip="Reports & Analytics">
                    <i class="nav-icon fas fa-chart-bar"></i>
                    <span>Reports & Analytics</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="#budgets" class="nav-link" data-section="budgets" data-tooltip="Budgets & Planning">
                    <i class="nav-icon fas fa-calendar-alt"></i>
                    <span>Budgeting & Planning</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="#forecasting" class="nav-link" data-section="forecasting" data-tooltip="Forecasting">
                    <i class="nav-icon fas fa-chart-line"></i>
                    <span>Forecasting</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="#scenarios" class="nav-link" data-section="scenarios" data-tooltip="Scenario Analysis">
                    <i class="nav-icon fas fa-project-diagram"></i>
                    <span>Scenario Analysis</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="#benchmarking" class="nav-link" data-section="benchmarking" data-tooltip="Industry Benchmarking">
                    <i class="nav-icon fas fa-code-compare"></i>
                    <span>Industry Benchmarking</span>
                </a>
            </div>
        </div>
        <div class="nav-bottom">
            <div class="connection-status" id="connectionStatus">
                <i class="fas fa-database"></i>
                <span id="connectionText">Connecting...</span>
                <div class="connection-dot" id="connectionDot"></div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Bar -->
        <header class="top-bar">
            <div class="top-bar-content">
                <div>
                    <h1 class="page-title">Dashboard Overview</h1>
                    <p class="page-subtitle">Real-time financial insights and cash flow management</p>
                </div>
                <div class="top-bar-right">
                    <!-- Date and Connection Status in same line -->
                    <div style="display: flex; align-items: center; gap: 1rem; margin-right: 1rem;">
                        <div class="date-display">
                            <span id="currentDate"></span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="section-content">
                <!-- Key Metrics Cards - Updated 3+1, 3+1 Layout -->
                <div class="dashboard-cards-container" style="display: grid; grid-template-columns: 1fr 1fr 1fr 300px; grid-template-rows: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem; margin-top: 2rem;">
                    <!-- Row 1: Cards 1-3 -->
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-top-section">
                                <div class="metric-title">Cash & Liquidity</div>
                                <div class="metric-icon icon-cash">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                            </div>
                            <div class="metric-content">
                                <div class="metric-values-section">
                                    <div class="metric-value-large" id="cashValue">Rp 0</div>
                                    <div class="metric-change positive" id="cashChange">+12.5% vs last period</div>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-top-section">
                                <div class="metric-title">Revenue Performance (YTD)</div>
                                <div class="metric-icon icon-ar">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                            </div>
                            <div class="metric-content">
                                <div class="metric-values-section">
                                    <div class="metric-value-large" id="revenuePerformanceValue">Rp 0</div>
                                    <div class="metric-change positive" id="revenuePerformanceChange">+15% vs last period</div>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-top-section">
                                <div class="metric-title">Net Income Margin (YTD)</div>
                                <div class="metric-icon icon-opex">
                                    <i class="fas fa-percent"></i>
                                </div>
                            </div>
                            <div class="metric-content">
                                <div class="metric-values-section">
                                    <div class="metric-value-large" id="profitabilityValue">0%</div>
                                    <div class="metric-change positive" id="profitabilityChange">+2.1% vs last period</div>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <!-- Altman Z-Score Card - Spans both rows -->
                    <div class="metric-card altman-zscore-card" style="grid-row: 1 / 3; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white;">
                        <div class="metric-header" style="height: 100%;">
                            <div class="metric-top-section">
                                <div class="metric-title" style="color: #fbbf24; font-size: 1rem; font-weight: 700;">Financial Health Score</div>
                                <div class="metric-icon" style="background: rgba(251, 191, 36, 0.2); color: #fbbf24;">
                                    <i class="fas fa-heartbeat"></i>
                                </div>
                            </div>
                            <div class="metric-content" style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                                <div class="zscore-display" style="margin: 1rem 0;">
                                    <div class="metric-value-large" id="healthScoreValue" style="font-size: 3rem; color: #fbbf24; margin-bottom: 0.5rem;">0.0</div>
                                    <div class="zscore-status" id="healthScoreStatus" style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">Analyzing...</div>
                                </div>
                                <div class="zscore-breakdown" style="width: 100%;">
                                    <div class="zscore-bar-container" style="background: rgba(255, 255, 255, 0.1); height: 8px; border-radius: 4px; margin-bottom: 1rem; position: relative;">
                                        <div class="zscore-bar" id="healthScoreBar" style="background: #fbbf24; height: 100%; border-radius: 4px; width: 0%; transition: width 0.3s ease;"></div>
                                    </div>
                                    <div class="zscore-description" id="healthScoreDescription" style="font-size: 0.875rem; color: #cbd5e1; line-height: 1.4;">
                                        Altman Z-Score measures financial distress risk using working capital, retained earnings, and profitability ratios.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <!-- Row 2: Cards 4-6 -->
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-top-section">
                                <div class="metric-title">Working Capital</div>
                                <div class="metric-icon icon-working-capital">
                                    <i class="fas fa-balance-scale"></i>
                                </div>
                            </div>
                            <div class="metric-content">
                                <div class="metric-values-section">
                                    <div class="metric-value-large" id="workingCapitalValue">Rp 0</div>
                                    <div class="metric-change positive" id="workingCapitalChange">Healthy ratio</div>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-top-section">
                                <div class="metric-title">Budget Variance</div>
                                <div class="metric-icon icon-budget">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                            </div>
                            <div class="metric-content">
                                <div class="metric-values-section">
                                    <div class="metric-value-large" id="budgetVarianceValue">0%</div>
                                    <div class="metric-change neutral" id="budgetVarianceChange">On track</div>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-top-section">
                                <div class="metric-title">Industry Position</div>
                                <div class="metric-icon icon-industry">
                                    <i class="fas fa-trophy"></i>
                                </div>
                            </div>
                            <div class="metric-content">
                                <div class="metric-values-section">
                                    <div class="metric-value-large" id="industryPositionValue">0th</div>
                                    <div class="metric-change neutral" id="industryPositionChange">Percentile</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 13-Week Cash Flow Forecast -->
                <div class="dashboard-section">
                    <div class="section-header">
                        <h3 class="section-title">13-Week Rolling Cash Flow Forecast</h3>
                        <div class="section-actions">
                            <button class="btn btn-secondary" onclick="downloadDashboardPDF()">
                                <i class="fas fa-download"></i>
                                Export to PDF
                            </button>
                            <button class="btn btn-secondary" onclick="copyDashboardPDF()">
                                <i class="fas fa-copy"></i>
                                Copy to Clipboard
                            </button>
                        </div>
                    </div>
                    <div class="cashflow-forecast-container">
                        <!-- Controls Section -->
                        <div class="forecast-controls-redesigned">
                            <!-- Horizontal Summary Cards -->
                            <div class="horizontal-summary">
                                <!-- Cash Runway -->
                                <div class="summary-card-horizontal runway-card">
                                    <div class="card-header-horizontal">
                                        <div class="card-icon runway-icon">
                                            <i class="fas fa-hourglass-half"></i>
                                        </div>
                                        <div class="card-title">Cash Runway</div>
                                    </div>
                                    <div class="metrics-horizontal">
                                        <div class="metric-compact">
                                            <span class="metric-label">Days</span>
                                            <span class="metric-number" id="cashRunwayDays">56</span>
                                        </div>
                                        <div class="metric-compact">
                                            <span class="metric-label">Weeks</span>
                                            <span class="metric-number" id="cashRunwayWeeks">8</span>
                                        </div>
                                        <div class="metric-compact">
                                            <span class="metric-label">Months</span>
                                            <span class="metric-number" id="cashRunwayMonths">2</span>
                                        </div>
                                    </div>
                                </div>
                            
                                <!-- Cash Burn Rate -->
                                <div class="summary-card-horizontal burn-card">
                                    <div class="card-header-horizontal">
                                        <div class="card-icon burn-icon">
                                            <i class="fas fa-fire"></i>
                                        </div>
                                        <div class="card-title">Cash Burn Rate</div>
                                    </div>
                                    <div class="metrics-horizontal">
                                        <div class="metric-compact">
                                            <span class="metric-label">Daily</span>
                                            <span class="metric-number" id="dailyBurn">Rp  219,780</span>
                                        </div>
                                        <div class="metric-compact">
                                            <span class="metric-label">Weekly</span>
                                            <span class="metric-number" id="weeklyBurn">Rp  1,538,462</span>
                                        </div>
                                        <div class="metric-compact">
                                            <span class="metric-label">Monthly</span>
                                            <span class="metric-number" id="monthlyBurn">Rp  6,661,538</span>
                                        </div>
                                    </div>
                                </div>
                            
                                <!-- Cash Flow Health -->
                                <div class="summary-card-horizontal health-card">
                                    <div class="card-header-horizontal">
                                        <div class="card-icon health-icon">
                                            <i class="fas fa-chart-line"></i>
                                        </div>
                                        <div class="card-title">Cash Flow Health</div>
                                    </div>
                                    <div class="health-content-horizontal">
                                        <div class="trend-display-horizontal">
                                            <span class="trend-indicator-large" id="cashFlowTrend">
                                                <i class="fas fa-arrow-down"></i> Declining
                                            </span>
                                        </div>
                                        <div class="payment-summary">
                                            <div class="payment-row">
                                                <span class="payment-label">Largest Payment:</span>
                                                <span class="payment-amount" id="biggestPayment">Rp  30,000,000</span>
                                            </div>
                                            <div class="payment-row">
                                                <span class="payment-label">Largest Collection:</span>
                                                <span class="payment-amount" id="largestCollection">No collections due</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="forecast-assumptions" style="background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                                <div style="display: flex; align-items: flex-start; gap: 0.5rem;">
                                    <i class="fas fa-info-circle" style="color: #3b82f6; margin-top: 0.2rem;"></i>
                                    <div>
                                        <strong style="color: #1e293b;">Forecast Assumptions:</strong>
                                        <ul style="margin: 0.5rem 0 0 0; padding-left: 1.2rem; font-size: 0.875rem; color: #475569;">
                                            <li>Overdue AR assumed will be collected within 4 weeks</li>
                                            <li>Overdue AP assumed will be paid within 2 weeks</li>
                                            <li>Future transactions use actual due dates</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        
                            <!-- Controls Below -->
                            <div class="forecast-actions">
                                <div class="control-group">
                                    <label for="startingCash" class="control-label">Starting Cash Position</label>
                                    <div class="currency-input-group">
                                        <span class="currency-symbol">Rp </span>
                                        <input type="text" id="startingCash" class="currency-input" placeholder="100,000,000" value="10,000,000">
                                    </div>
                                </div>
                                <div class="control-group">
                                    <button class="btn btn-secondary" onclick="refreshForecast()">
                                        <i class="fas fa-sync-alt"></i>
                                        Refresh Forecast
                                    </button>
                                </div>
                            </div>
                        </div>
                    
                        <!-- Chart Canvas -->
                        <div class="scenario-chart-full">
                            <canvas id="cashflowChart" width="800" height="400"></canvas>
                        </div>
                    
                        <!-- Legend and Insights -->
                        <div class="chart-insights">
                            <div class="chart-legend">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #3b82f6;"></div>
                                    <span>Projected Cash Position</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #10b981;"></div>
                                    <span>Cash Inflows (AR Collections)</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #ef4444;"></div>
                                    <span>Cash Outflows (AP Payments)</span>
                                </div>
                            </div>
                            <div class="insights-panel" id="forecastInsights">
                                <div class="insight-item">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Forecast based on current AP/AR due dates</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk & Alert Summary Panel -->
                <div class="dashboard-section" style="margin-top: 2rem;">
                    <div class="section-header">
                        <h4><i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i> Risk & Alert Summary</h4>
                        <button class="btn btn-secondary" onclick="refreshRiskAlerts()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    
                    <div class="risk-alerts-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <!-- Cash Flow Alerts -->
                        <div class="alert-category-card">
                            <div class="alert-category-header">
                                <div class="alert-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white;">
                                    <i class="fas fa-water"></i>
                                </div>
                                <div>
                                    <h5>Cash Flow Alerts</h5>
                                    <span class="alert-count" id="cashFlowAlertCount">Loading...</span>
                                </div>
                            </div>
                            <div class="alert-items" id="cashFlowAlerts">
                                <!-- Cash flow alerts will be populated here -->
                            </div>
                        </div>
                        
                        <!-- AP/AR Alerts -->
                        <div class="alert-category-card">
                            <div class="alert-category-header">
                                <div class="alert-icon" style="background: linear-gradient(135deg, #3b82f6, #1e40af); color: white;">
                                    <i class="fas fa-receipt"></i>
                                </div>
                                <div>
                                    <h5>AP/AR Alerts</h5>
                                    <span class="alert-count" id="aparAlertCount">Loading...</span>
                                </div>
                            </div>
                            <div class="alert-items" id="aparAlerts">
                                <!-- AP/AR alerts will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Budget Variance Alerts -->
                        <div class="alert-category-card">
                            <div class="alert-category-header">
                                <div class="alert-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                                <div>
                                    <h5>Budget Variance Alerts</h5>
                                    <span class="alert-count" id="budgetAlertCount">Loading...</span>
                                </div>
                            </div>
                            <div class="alert-items" id="budgetAlerts">
                                <!-- Budget alerts will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Financial Health Alerts -->
                        <div class="alert-category-card">
                            <div class="alert-category-header">
                                <div class="alert-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white;">
                                    <i class="fas fa-heartbeat"></i>
                                </div>
                                <div>
                                    <h5>Financial Health Alerts</h5>
                                    <span class="alert-count" id="healthAlertCount">Loading...</span>
                                </div>
                            </div>
                            <div class="alert-items" id="healthAlerts">
                                <!-- Health alerts will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Simplified P&L Comparison -->
                <div class="dashboard-section" style="margin-top: 2rem;">
                    <div class="section-header">
                        <h4>Performance vs Budget</h4>
                        <div class="period-selector-dashboard">
                            <select id="dashboardPeriodSelect" onchange="updateDashboardPL()">
                                <option value="MTD">Month to Date</option>
                                <option value="QTD">Quarter to Date</option>
                                <option value="YTD" selected>Year to Date</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="simplified-pl-container">
                        <div class="simplified-pl-table-wrapper">
                            <table class="simplified-pl-table">
                                <thead>
                                    <tr>
                                        <th>Line Item</th>
                                        <th>Actual</th>
                                        <th>Budget</th>
                                        <th>Variance</th>
                                        <th>Variance %</th>
                                    </tr>
                                </thead>
                                <tbody id="simplifiedPLBody">
                                    <!-- Content will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Revenue & OPEX Trending Chart -->
                <div class="dashboard-section" style="margin-top: 2rem;">
                    <div class="section-header">
                        <h4><i class="fas fa-trending-up" style="color: #10b981;"></i> Revenue & OPEX Trending</h4>
                        <button class="btn btn-secondary" onclick="exportTrendingChart()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                    
                    <div class="dashboard-trending-container">
                        <div class="dashboard-trending-chart">
                            <canvas id="dashboardTrendingChart" width="800" height="400"></canvas>
                        </div>
                        
                        <!-- Trending Insights -->
                        <div class="trending-insights-dashboard" id="dashboardTrendingInsights">
                            <!-- Insights will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- AP/AR Section -->
            <div id="ap-ar-section" class="section-content" style="display: none;">
                <!-- Enhanced Summary Cards -->
                <div class="metrics-grid enhanced-summary" style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); margin-bottom: 2rem; gap: 1.5rem;">
                    <!-- AR Card -->
                    <div class="metric-card enhanced-card">
                        <div class="card-accent accent-blue"></div>
                        <div class="metric-header">
                            <div class="card-main">
                                <div class="metric-title-group">
                                    <div class="metric-title">Accounts Receivable</div>
                                    <div class="metric-subtitle">Money Coming In</div>
                                </div>
                                <div class="metric-primary-group">
                                    <span class="metric-value-large" id="totalARAll">Rp  0</span>
                                    <div class="metric-breakdown">
                                        <span class="breakdown-item">
                                            <span class="breakdown-label">Overdue: </span>
                                            <span class="breakdown-value" id="totalAR">Rp 0</span>
                                        </span>
                                        <span class="aging-indicator" id="arAging">0 overdue(s)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <!-- AP Card -->
                    <div class="metric-card enhanced-card">
                        <div class="card-accent accent-orange"></div>
                        <div class="metric-header">
                            <div class="card-main">
                                <div class="metric-title-group">
                                    <div class="metric-title">Accounts Payable</div>
                                    <div class="metric-subtitle">Money Going Out</div>
                                </div>
                                <div class="metric-primary-group">
                                    <span class="metric-value-large" id="totalAPAll">Rp  0</span>
                                    <div class="metric-breakdown">
                                        <span class="breakdown-item">
                                            <span class="breakdown-label">Overdue: </span>
                                            <span class="breakdown-value" id="totalAP">Rp 0</span>
                                        </span>
                                        <span class="aging-indicator" id="apAging">0 overdue(s)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <!-- Cash Position Card -->
                    <div class="metric-card enhanced-card">
                        <div class="card-accent accent-green"></div>
                        <div class="metric-header">
                            <div class="card-main">
                                <div class="metric-title-group">
                                    <div class="metric-title">Cash Position & Efficiency</div>
                                    <div class="metric-subtitle">Net Impact & Cycle</div>
                                </div>
                                <div class="metric-primary-group">
                                    <span class="metric-value-large" id="netCashImpact">Rp  0</span>
                                    <div class="metric-breakdown">
                                        <span class="breakdown-item">
                                            <span class="breakdown-label" id="cashImpactChange">Net Cash Impact</span>
                                        </span>
                                        <span class="efficiency-indicator" id="cccDisplay">CCC: -- days</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add this after the summary cards -->
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f8fafc; border-radius: 6px; border-left: 3px solid #fbbf24;">
                    <p style="font-size: 0.75rem; color: #64748b; margin: 0;">
                        <strong>CCC Calculation Note:</strong> This is a simplified Cash Conversion Cycle calculation. 
                        DSO and DPO are based on average days outstanding for unpaid/overdue transactions only. 
                        Traditional CCC calculations use revenue, COGS, and inventory data which are not available in this AP/AR module.
                    </p>
                </div>

                <div class="ap-ar-tabs">
                    <div class="tab-nav">
                        <button class="tab-btn active" onclick="switchAPARTab('transactions')" data-tab="transactions">
                            <i class="fas fa-list"></i>
                            AP/AR Transactions
                        </button>
                        <button class="tab-btn" onclick="switchAPARTab('aging')" data-tab="aging">
                            <i class="fas fa-chart-bar"></i>
                            AP/AR Aging
                        </button>
                        <button class="tab-btn" onclick="switchAPARTab('scenarios')" data-tab="scenarios">
                            <i class="fas fa-project-diagram"></i>
                            Cash Flow Scenarios
                        </button>
                    </div>

                    <div class="tab-content active" id="transactions-tab">
                        <!-- Actions and Filters -->
                        <div class="dashboard-section">
                            <div class="section-header">
                                <h3 class="section-title">AP/AR Transactions</h3>
                                <div class="section-actions">
                                    <button class="btn btn-secondary" onclick="exportAPARToCSV()">
                                        <i class="fas fa-file-csv"></i>
                                        Export to CSV
                                    </button>
                                    <button class="btn btn-secondary" onclick="openUploadModal()">
                                        <i class="fas fa-file-upload"></i>
                                        Upload CSV/Excel
                                    </button>
                                    <button class="btn btn-primary" onclick="openAddModal()">
                                        <i class="fas fa-plus"></i>
                                        Add Transaction
                                    </button>
                                </div>
                            </div>
                    
                            <!-- Filters -->
                            <div class="filters-section" style="margin-bottom: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                                <select id="typeFilter" class="filter-input">
                                    <option value="">All Types</option>
                                    <option value="AR">Accounts Receivable</option>
                                    <option value="AP">Accounts Payable</option>
                                </select>
                                <div class="multi-select-container">
                                    <button class="multi-select-trigger" id="statusFilterTrigger">
                                        <span id="statusFilterText">All Status</span>
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                    <div class="multi-select-dropdown" id="statusFilterDropdown">
                                        <div class="multi-select-controls">
                                            <button type="button" class="select-all-btn" onclick="selectAllStatus()">Select All</button>
                                            <button type="button" class="clear-all-btn" onclick="clearAllStatus()">Clear All</button>
                                        </div>
                                        <div class="multi-select-options">
                                            <label class="multi-select-option">
                                                <input type="checkbox" value="Unpaid" onchange="updateStatusFilter()">
                                                <span>Unpaid</span>
                                            </label>
                                            <label class="multi-select-option">
                                                <input type="checkbox" value="Paid" onchange="updateStatusFilter()">
                                                <span>Paid</span>
                                            </label>
                                            <label class="multi-select-option">
                                                <input type="checkbox" value="Overdue" onchange="updateStatusFilter()">
                                                <span>Overdue</span>
                                            </label>
                                            <label class="multi-select-option">
                                                <input type="checkbox" value="Partial" onchange="updateStatusFilter()">
                                                <span>Partial</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <input type="date" id="dateFromFilter" class="filter-input" placeholder="From Date">
                                <span style="color: #64748b; font-size: 0.875rem;">to</span>
                                <input type="date" id="dateToFilter" class="filter-input" placeholder="To Date">
                                <button class="btn btn-secondary" onclick="clearFilters()">
                                    <i class="fas fa-times"></i>
                                    Clear
                                </button>
                            </div>
                    
                            <!-- AP/AR Table -->
                            <div class="table-container">
                                <table id="aparTable" class="financial-table">
                                    <thead>
                                        <tr>
                                            <th>Type</th>
                                            <th>Reference</th>
                                            <th>Company</th>
                                            <th>Description</th>
                                            <th>Amount</th>
                                            <th>Invoice Date</th>
                                            <th>Due Date</th>
                                            <th>Days</th>
                                            <th>Status</th>
                                            <th>Link to GL</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="aparTableBody">
                                        <!-- Transactions will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                            <!-- Add this after the table container -->
                            <div style="margin-top: 1rem; color: #94a3b8; font-size: 0.875rem;">
                                <span>* Due date calculated from invoice date + payment terms</span>
                            </div>
                        </div>
                    </div>
                    <!-- Aging Analysis Tab Content (new) -->
                    <div class="tab-content" id="aging-tab">
                        <!-- Aging Charts -->
                        <div class="aging-charts-container">
                            <div class="aging-chart-card">
                                <div class="aging-chart-title">Accounts Receivable Aging</div>
                                <canvas id="arAgingChart" class="aging-chart-canvas"></canvas>
                            </div>
                            <div class="aging-chart-card">
                                <div class="aging-chart-title">Accounts Payable Aging</div>
                                <canvas id="apAgingChart" class="aging-chart-canvas"></canvas>
                            </div>
                        </div>
                    
                        <!-- Aging Tables -->
                        <div class="aging-tables-container">
                            <!-- AR Aging Table -->
                            <div class="aging-table-section">
                                <div class="aging-table-header">
                                    <h4 class="aging-table-title">
                                        <i class="fas fa-arrow-right" style="color: #10b981; margin-right: 0.5rem;"></i>
                                        Accounts Receivable Aging
                                    </h4>
                                </div>
                                <div style="overflow-x: auto;">
                                    <table class="aging-table">
                                        <thead>
                                            <tr>
                                                <th style="text-align: left;">Customer</th>
                                                <th style="text-align: center;">0-30</th>
                                                <th style="text-align: center;">30-60</th>
                                                <th style="text-align: center;">60-90</th>
                                                <th style="text-align: center;">90-120</th>
                                                <th style="text-align: center;">120+</th>
                                                <th style="text-align: center;">Total</th>
                                                <th style="text-align: center;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="arAgingTableBody">
                                            <!-- AR aging data will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                    
                            <!-- AP Aging Table -->
                            <div class="aging-table-section">
                                <div class="aging-table-header">
                                    <h4 class="aging-table-title">
                                        <i class="fas fa-arrow-left" style="color: #ef4444; margin-right: 0.5rem;"></i>
                                        Accounts Payable Aging
                                    </h4>
                                </div>
                                <div style="overflow-x: auto;">
                                    <table class="aging-table">
                                        <thead>
                                            <tr>
                                                <th style="text-align: left;">Vendor</th>
                                                <th style="text-align: center;">0-30</th>
                                                <th style="text-align: center;">30-60</th>
                                                <th style="text-align: center;">60-90</th>
                                                <th style="text-align: center;">90-120</th>
                                                <th style="text-align: center;">120+</th>
                                                <th style="text-align: center;">Total</th>
                                                <th style="text-align: center;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="apAgingTableBody">
                                            <!-- AP aging data will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    
                        <!-- Additional Analytics -->
                        <div class="aging-analytics-section" style="margin-top: 2rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div class="aging-summary-card">
                                    <div class="aging-bucket-title">DSO (Days Sales Outstanding)</div>
                                    <div class="aging-amount" id="avgDaysToPay">-- days</div>
                                    <div class="aging-count">Average collection period</div>
                                </div>
                                <div class="aging-summary-card">
                                    <div class="aging-bucket-title">Collection Efficiency</div>
                                    <div class="aging-amount" id="collectionEfficiency">--%</div>
                                    <div class="aging-count">On-time collection rate</div>
                                </div>
                                <div class="aging-summary-card">
                                    <div class="aging-bucket-title">AR Risk Exposure</div>
                                    <div class="aging-amount aging-bucket-90-120" id="riskExposure">Rp  0</div>
                                    <div class="aging-count">90+ days outstanding</div>
                                </div>
                                <div class="aging-summary-card">
                                    <div class="aging-bucket-title">Cash Flow Health</div>
                                    <div class="aging-amount" id="paymentTrend">Stable</div>
                                    <div class="aging-count">Last 30 days</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cash Flow Scenarios Tab Content (new simplified structure) -->
                    <div class="tab-content" id="scenarios-tab">
                        <div class="scenarios-new-container">
                            <!-- Full Width Chart -->
                            <div class="scenario-chart-section">
                                <div class="scenarios-header">
                                    <h4 class="scenarios-title">13-Week Cash Flow Impact</h4>
                                    <p class="scenarios-subtitle">Real-time scenario analysis  Drag transactions between weeks</p>

                                    <!-- Add realistic assumptions explanation -->
                                    <div class="scenario-assumptions" style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 6px; padding: 0.75rem; margin: 0.5rem 0; font-size: 0.8rem;">
                                        <div style="display: flex; align-items: flex-start; gap: 0.5rem;">
                                            <i class="fas fa-lightbulb" style="color: #0ea5e9; margin-top: 0.1rem;"></i>
                                            <div style="color: #0c4a6e;">
                                                <strong>Default Placement Logic:</strong>
                                                <span style="margin-left: 0.5rem;">Overdue AR  Weeks 1-4 based on aging  Overdue AP  Weeks 1-2  Future items  Actual due dates</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="color-legend" style="background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 6px; padding: 0.75rem; margin: 0.5rem 0;">
                                        <div style="display: flex; align-items: center; gap: 1.5rem; font-size: 0.8rem; color: #475569;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <div style="width: 14px; height: 14px; background: #ef4444; border-radius: 3px;"></div>
                                                <span><strong>Red (AP):</strong> Money going out - amounts we need to pay</span>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <div style="width: 14px; height: 14px; background: #10b981; border-radius: 3px;"></div>
                                                <span><strong>Green (AR):</strong> Money coming in - amounts we will receive</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="scenario-actions"></div>
                                </div>
                                <div class="scenario-chart-full">
                                    <canvas id="scenarioImpactChart" width="800" height="300"></canvas>
                                </div>
                            </div>
                            
                            <!-- Transaction Buckets Grid -->
                            <div class="buckets-section">
                                <div class="buckets-header">
                                    <h4 class="buckets-title">Transaction Timeline</h4>
                                    <p class="buckets-subtitle">Drag cards between weeks to see cash flow impact</p>
                                </div>
                                
                                <div class="buckets-grid" id="bucketsGrid">
                                    <!-- Weeks 1-12 (3 rows of 4) -->
                                    <!-- Row 1 -->
                                    <div class="week-bucket" data-week="1">
                                        <div class="bucket-header">Week 1</div>
                                        <div class="bucket-content" id="bucket-week-1"></div>
                                    </div>
                                    <div class="week-bucket" data-week="2">
                                        <div class="bucket-header">Week 2</div>
                                        <div class="bucket-content" id="bucket-week-2"></div>
                                    </div>
                                    <div class="week-bucket" data-week="3">
                                        <div class="bucket-header">Week 3</div>
                                        <div class="bucket-content" id="bucket-week-3"></div>
                                    </div>
                                    <div class="week-bucket" data-week="4">
                                        <div class="bucket-header">Week 4</div>
                                        <div class="bucket-content" id="bucket-week-4"></div>
                                    </div>
                                    
                                    <!-- Row 2 -->
                                    <div class="week-bucket" data-week="5">
                                        <div class="bucket-header">Week 5</div>
                                        <div class="bucket-content" id="bucket-week-5"></div>
                                    </div>
                                    <div class="week-bucket" data-week="6">
                                        <div class="bucket-header">Week 6</div>
                                        <div class="bucket-content" id="bucket-week-6"></div>
                                    </div>
                                    <div class="week-bucket" data-week="7">
                                        <div class="bucket-header">Week 7</div>
                                        <div class="bucket-content" id="bucket-week-7"></div>
                                    </div>
                                    <div class="week-bucket" data-week="8">
                                        <div class="bucket-header">Week 8</div>
                                        <div class="bucket-content" id="bucket-week-8"></div>
                                    </div>
                                    
                                    <!-- Row 3 -->
                                    <div class="week-bucket" data-week="9">
                                        <div class="bucket-header">Week 9</div>
                                        <div class="bucket-content" id="bucket-week-9"></div>
                                    </div>
                                    <div class="week-bucket" data-week="10">
                                        <div class="bucket-header">Week 10</div>
                                        <div class="bucket-content" id="bucket-week-10"></div>
                                    </div>
                                    <div class="week-bucket" data-week="11">
                                        <div class="bucket-header">Week 11</div>
                                        <div class="bucket-content" id="bucket-week-11"></div>
                                    </div>
                                    <div class="week-bucket" data-week="12">
                                        <div class="bucket-header">Week 12</div>
                                        <div class="bucket-content" id="bucket-week-12"></div>
                                    </div>
                                    
                                    <!-- Row 4 (2 buckets centered) -->
                                    <div class="week-bucket" data-week="13">
                                        <div class="bucket-header">Week 13</div>
                                        <div class="bucket-content" id="bucket-week-13"></div>
                                    </div>
                                    <div class="week-bucket parked-bucket" data-week="parked">
                                        <div class="bucket-header">Parked</div>
                                        <div class="bucket-subtitle">Beyond 13 weeks</div>
                                        <div class="bucket-content" id="bucket-week-parked"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Change Log -->
                            <div class="change-log-section">
                                <div class="change-log-header">
                                    <h4 class="change-log-title">Change Log</h4>
                                    <button class="btn btn-secondary btn-small" onclick="resetScenario()">
                                        <i class="fas fa-undo"></i> Reset All
                                    </button>
                                </div>
                                <div class="change-log-content" id="changeLogContent">
                                    <div class="log-item neutral">
                                        <span>Move transactions between weeks to see changes</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Impact Analysis -->
                            <div class="impact-analysis-section">
                                <div class="impact-header">
                                    <h4 class="impact-title">Impact Analysis</h4>
                                </div>
                                <div class="impact-content" id="impactAnalysisContent">
                                    <div class="impact-item neutral">
                                        <span class="impact-icon"></span>
                                        <span>Move transactions to see potential impacts</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="scenario-financing-section">
                            <h4><i class="fas fa-plus-circle"></i> What-if Financing Options</h4>
                            <p class="section-description">Simulate financing options to improve cash flow without affecting your actual AP/AR data</p>
                            
                            <div class="add-financing-container">
                                <button class="btn btn-primary" onclick="openFinancingModal()">
                                    <i class="fas fa-plus"></i> Add Financing/Investment
                                </button>
                            </div>
                            
                            <!-- Impact Summary only -->
                            <div class="scenario-impact-summary">
                                <h5>Projected Impact</h5>
                                <div class="impact-metrics">
                                    <div class="impact-metric">
                                        <span class="metric-label">Cash Position Improvement:</span>
                                        <span id="cashImprovementAmount" class="metric-value">+Rp 0</span>
                                    </div>
                                    <div class="impact-metric">
                                        <span class="metric-label">Extended Runway:</span>
                                        <span id="runwayExtension" class="metric-value">+0 days</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Statements Section (add this to your main dashboard.html) -->
            <div id="statements-section" class="section-content" style="display: none;">
                <div class="dashboard-section">
                    <div class="modern-section-header">
                        <div class="header-content">
                            <div class="header-left">
                                <p class="section-description">Generate income statements, balance sheets, and cash flow reports</p>
                            </div>
                            <div class="header-right">
                                <div class="balance-indicator" id="balanceIndicator">
                                    <span class="balance-status balanced" id="balanceStatus">
                                        <i class="fas fa-check-circle"></i>
                                        Trial Balance: In Balance
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
            
                    <!-- Financial Statements Tabs -->
                    <div class="financial-tabs">
                        <div class="tab-nav">
                            <button class="tab-btn active" onclick="switchFinancialTab('financial-transactions')" data-tab="financial-transactions">
                                <i class="fas fa-list"></i>
                                GL Transactions
                            </button>
                            <button class="tab-btn" onclick="switchFinancialTab('trial-balance')" data-tab="trial-balance">
                                <i class="fas fa-balance-scale"></i>
                                Trial Balance
                            </button>
                            <button class="tab-btn" onclick="switchFinancialTab('reports')" data-tab="reports">
                                <i class="fas fa-chart-line"></i>
                                Financial Statements
                            </button>
                        </div>

                        <!-- Transactions Tab -->
                        <div class="tab-content active" id="financial-transactions-tab">
                            <div class="dashboard-section">
                                <div class="section-header">
                                    <h3 class="section-title">General Ledger Transactions</h3>
                                    <div class="section-actions">
                                        <button class="btn btn-secondary" onclick="exportFinancialToCSV()">
                                            <i class="fas fa-file-csv"></i>
                                            Export to CSV
                                        </button>
                                        <button class="btn btn-secondary" onclick="openFinancialUploadModal()">
                                            <i class="fas fa-file-upload"></i>
                                            Upload CSV
                                        </button>
                                        <button class="btn btn-primary" onclick="openAddFinancialModal()">
                                            <i class="fas fa-plus"></i>
                                            Add Transaction
                                        </button>
                                    </div>
                                </div>
                        
                                <!-- UPDATED: Horizontal Filters Section -->
                                <div class="table-pagination-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0.75rem 1rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                                    <div class="pagination-info" style="color: #64748b; font-size: 0.875rem;">
                                        <span id="transactionCount">Showing 0-0 of 0 transactions</span>
                                    </div>
                                    <div class="pagination-controls" style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="color: #64748b; font-size: 0.875rem;">Show:</span>
                                        <select id="transactionPageSize" onchange="changePageSize()" 
                                                style="padding: 0.375rem 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; background: white; font-size: 0.875rem; min-width: 80px;">
                                            <option value="25">25</option>
                                            <option value="50" selected>50</option>
                                            <option value="100">100</option>
                                            <option value="200">200</option>
                                        </select>
                                        <span style="color: #64748b; font-size: 0.875rem;">per page</span>
                                    </div>
                                </div>
                                <div class="filters-section-horizontal">
                                    <div class="filter-row">
                                        <div class="filter-group">
                                            <label for="periodFilter">Period:</label>
                                            <select id="periodFilter" class="form-select" onchange="renderFinancialTable()">
                                                <option value="">All Time</option>
                                                <option value="MTD">Month to Date</option>
                                                <option value="QTD">Quarter to Date</option>
                                                <option value="YTD">Year to Date</option>
                                                <option value="custom">Custom Range</option>
                                            </select>
                                        </div>
                        
                                        <div class="filter-group" id="customDateRange" style="display: none;">
                                            <label for="dateFromFinancial">From:</label>
                                            <input type="date" id="dateFromFinancial" class="form-input" onchange="renderFinancialTable()">
                                            <label for="dateToFinancial">To:</label>
                                            <input type="date" id="dateToFinancial" class="form-input" onchange="renderFinancialTable()">
                                        </div>
                        
                                        <div class="filter-group">
                                            <label for="categoryFilter">Category:</label>
                                            <select id="categoryFilter" class="form-select" onchange="renderFinancialTable()">
                                                <option value="">All Categories</option>
                                                <option value="Asset">Assets</option>
                                                <option value="Liability">Liabilities</option>
                                                <option value="Equity">Equity</option>
                                                <option value="Revenue">Revenue</option>
                                                <option value="Expense">Expenses</option>
                                            </select>
                                        </div>
                        
                                        <div class="filter-group">
                                            <label for="accountFilter">Account:</label>
                                            <select id="accountFilter" class="form-select" onchange="renderFinancialTable()">
                                                <option value="">All Accounts</option>
                                                <!-- Populated dynamically -->
                                            </select>
                                        </div>
                        
                                        <div class="filter-group">
                                            <button class="btn btn-secondary" onclick="clearFinancialFilters()">
                                                <i class="fas fa-times"></i>
                                                Clear
                                            </button>
                                        </div>
                                    </div>
                                </div>
                        
                                <!-- Bulk Actions -->
                                <div class="bulk-actions" id="bulkActions" style="display: none;">
                                    <div class="bulk-info">
                                        <span id="selectedCount">0</span> transactions selected
                                    </div>
                                    <div class="bulk-buttons">
                                        <button class="btn btn-secondary" onclick="bulkUnlink()">
                                            <i class="fas fa-unlink"></i>
                                            Unlink Selected
                                        </button>
                                        <button class="action-btn delete" onclick="bulkDeleteFinancial()" style="width: auto; padding: 8px 16px;">
                                            <i class="fas fa-trash" style="margin-right: 6px;"></i>
                                            Delete Selected
                                        </button>
                                    </div>
                                </div>
                        
                                <!-- UPDATED: Full Width Transaction Table -->
                                <div class="table-container-full-width">
                                    <table class="data-table-full" id="financialTable">
                                        <thead>
                                            <tr>
                                                <th style="width: 50px;">
                                                    <input type="checkbox" id="selectAllFinancial" onchange="toggleSelectAllFinancial()">
                                                </th>
                                                <th style="width: 120px;">Date</th>
                                                <th style="width: 200px;">Account</th>
                                                <th>Description</th>
                                                <th style="width: 120px;">Debit</th>
                                                <th style="width: 120px;">Credit</th>
                                                <th style="width: 120px;">Reference</th>
                                                <th style="width: 80px;">Link</th>
                                                <th style="width: 120px;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="financialTableBody">
                                            <!-- Populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                                <!-- Add this after the GL transactions table -->
                                <div class="table-pagination-footer" style="display: flex; justify-content: center; align-items: center; margin-top: 1rem; gap: 1rem;">
                                    <button id="prevPageBtn" onclick="previousPage()" class="btn btn-secondary" disabled>Previous</button>
                                    <div class="page-numbers" id="pageNumbers"></div>
                                    <button id="nextPageBtn" onclick="nextPage()" class="btn btn-secondary">Next</button>
                                </div>
                            </div>
                        </div>
            
                        <!-- Trial Balance Tab -->
                        <div class="tab-content" id="trial-balance-tab">
                            <div class="dashboard-section">
                                <div class="section-header">
                                    <h3 class="section-title">Trial Balance</h3>
                                    <div class="section-actions">
                                        <button class="btn btn-primary" onclick="autoBalanceEntries()" id="autoBalanceBtn" style="display: none;">
                                            <i class="fas fa-magic"></i>
                                            Create Balancing Entry
                                        </button>
                                    </div>
                                </div>
                        
                                <div class="trial-balance-summary" id="trialBalanceSummary">
                                    <div class="balance-card">
                                        <div class="balance-label">Total Debits</div>
                                        <div class="balance-amount" id="totalDebits">Rp  0</div>
                                    </div>
                                    <div class="balance-card">
                                        <div class="balance-label">Total Credits</div>
                                        <div class="balance-amount" id="totalCredits">Rp  0</div>
                                    </div>
                                    <div class="balance-card">
                                        <div class="balance-label">Difference</div>
                                        <div class="balance-amount" id="balanceDifference">Rp  0</div>
                                    </div>
                                </div>
                        
                                <!-- UPDATED: Full Width Trial Balance Table -->
                                <div class="table-container-full-width">
                                    <table class="data-table-full" id="trialBalanceTable">
                                        <thead>
                                            <tr>
                                                <th style="width: 150px;">Account Code</th>
                                                <th>Account Name</th>
                                                <th style="width: 150px;">Debit Balance</th>
                                                <th style="width: 150px;">Credit Balance</th>
                                            </tr>
                                        </thead>
                                        <tbody id="trialBalanceTableBody">
                                            <!-- Populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
            
                        <!-- Reports Tab -->
                        <div class="tab-content" id="reports-tab">
                            <div class="dashboard-section">
                                <div class="section-header">
                                    <h3 class="section-title">Financial Reports</h3>
                                    <div class="section-actions">
                                        <button class="btn btn-secondary" onclick="exportReportsToPDF()">
                                            <i class="fas fa-file-pdf"></i>
                                            Export to PDF
                                        </button>
                                    </div>
                                </div>
                        
                                <!-- UPDATED: Audit-style Reports Layout -->
                                <div class="reports-audit-layout">
                                    
                                    <!-- Balance Sheet -->
                                    <div class="report-statement">
                                        <div class="report-header">
                                            <h4>Balance Sheet</h4>
                                            <p class="report-date">As of <span id="reportDate1"></span></p>
                                        </div>
                                        
                                        <div class="report-content" id="balanceSheetDetailed">
                                            <!-- Generated by JavaScript -->
                                        </div>
                                    </div>
                        
                                    <!-- Income Statement -->
                                    <div class="report-statement">
                                        <div class="report-header">
                                            <h4>Income Statement</h4>
                                            <p class="report-date">For the period ending <span id="reportDate2"></span></p>
                                        </div>
                                        
                                        <div class="report-content" id="incomeStatementDetailed">
                                            <!-- Generated by JavaScript -->
                                        </div>
                                    </div>
                        
                                    <!-- Cash Flow Statement -->
                                    <div class="report-statement">
                                        <div class="report-header">
                                            <h4>Cash Flow Statement</h4>
                                            <p class="report-date">For the period ending <span id="reportDate3"></span></p>
                                        </div>
                                        
                                        <!-- ADD THIS NEW SECTION HERE -->
                                        <div style="padding: 1rem; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                                            <label for="beginningCashBalance" style="font-weight: 500; margin-right: 1rem;">Beginning Cash Balance:</label>
                                            <input type="number" id="beginningCashBalance" class="form-input" onchange="generateCashFlowStatement()" step="0.01" style="width: 200px; display: inline-block;">
                                        </div>
                                        <!-- END NEW SECTION -->
                                        
                                        <div class="report-content" id="cashFlowStatementDetailed">
                                            <!-- Generated by JavaScript -->
                                        </div>
                                    </div>
                        
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Add Financial Transaction Modal -->
            <div class="modal-overlay" id="addFinancialModal">
                <div class="modal">
                    <div class="modal-header">
                        <h3 class="modal-title">Add Financial Transaction</h3>
                        <button class="modal-close" onclick="closeAddFinancialModal()">&times;</button>
                    </div>
                    <form id="addFinancialForm" onsubmit="addFinancialTransaction(event)">
                        <div class="form-group">
                            <label class="form-label">Transaction Date</label>
                            <input type="date" class="form-input" id="financialDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Reference</label>
                            <input type="text" class="form-input" id="financialReference" placeholder="REF-001">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-input" id="financialDescription" required placeholder="Transaction description">
                        </div>
                    
                        <!-- Balance Indicator -->
                        <div class="balance-indicator" id="journalBalance" style="margin: 1rem 0; padding: 0.75rem; background: #f8fafc; border-radius: 6px; text-align: center;">
                            <span id="balanceStatus">Debits: Rp 0 | Credits: Rp 0 | <span style="color: #ef4444;">Out of Balance</span></span>
                        </div>
                    
                        <!-- Debit Line -->
                        <div class="journal-line" style="border: 1px solid #e2e8f0; border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
                            <h4 style="margin-bottom: 0.75rem; color: #059669;">Debit Entry</h4>
                            <div class="form-group">
                                <label class="form-label">Account</label>
                                <select class="form-select" id="debitAccount" required onchange="updateBalance()">
                                    <option value="">Select Account</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-input" id="debitAmount" step="0.01" min="0" oninput="updateBalance()" required>
                            </div>
                        </div>
                    
                        <!-- Credit Line -->
                        <div class="journal-line" style="border: 1px solid #e2e8f0; border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
                            <h4 style="margin-bottom: 0.75rem; color: #dc2626;">Credit Entry</h4>
                            <div class="form-group">
                                <label class="form-label">Account</label>
                                <select class="form-select" id="creditAccount" required onchange="updateBalance()">
                                    <option value="">Select Account</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-input" id="creditAmount" step="0.01" min="0" oninput="updateBalance()" required>
                            </div>
                        </div>
                    
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeAddFinancialModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary" id="saveJournalButton" disabled>Add Journal Entry</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- New GL Account Modal -->
            <div class="modal-overlay" id="newAccountModal">
                <div class="modal">
                    <div class="modal-header">
                        <h3 class="modal-title">Create New GL Account</h3>
                        <button class="modal-close" onclick="closeNewAccountModal()">&times;</button>
                    </div>
                    <form id="newAccountForm" onsubmit="createNewAccount(event)">
                        <div class="form-group">
                            <label class="form-label">Account Code</label>
                            <input type="text" class="form-input" id="newAccountCode" pattern="[0-9]{4}" maxlength="4" required>
                            <small class="form-help">4-digit account code (e.g., 5010)</small>
                        </div>
            
                        <div class="form-group">
                            <label class="form-label">Account Name</label>
                            <input type="text" class="form-input" id="newAccountName" required>
                        </div>
            
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="newAccountCategory" required>
                                <option value="">Select Category</option>
                                <option value="Asset">Asset</option>
                                <option value="Liability">Liability</option>
                                <option value="Equity">Equity</option>
                                <option value="Revenue">Revenue</option>
                                <option value="Expense">Expense</option>
                            </select>
                        </div>
            
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeNewAccountModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Create Account</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Upload Financial CSV Modal -->
            <div class="modal-overlay" id="uploadFinancialModal">
                <div class="modal">
                    <div class="modal-header">
                        <h3 class="modal-title">Upload Financial Transactions</h3>
                        <button class="modal-close" onclick="closeFinancialUploadModal()">&times;</button>
                    </div>
                    <div class="modal-content">
                        <div class="upload-instructions">
                            <p><strong>CSV Format Required:</strong></p>
                            <p>Date, Account_Code, Account_Name, Description, Debit, Credit, Reference, Notes</p>
                            <button class="btn btn-secondary" onclick="downloadFinancialTemplate()">
                                <i class="fas fa-download"></i>
                                Download Template
                            </button>
                        </div>
                        
                        <div class="file-upload-area" onclick="document.getElementById('financialFileInput').click()">
                            <input type="file" id="financialFileInput" accept=".csv" onchange="handleFinancialFileUpload(event)" style="display: none;">
                            <div class="upload-placeholder">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Choose CSV file or drag and drop</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GL Account Selection Modal for AP/AR Linking -->
            <div class="modal-overlay" id="glAccountSelectionModal">
                <div class="modal">
                    <div class="modal-header">
                        <h3 class="modal-title">Create GL Entries</h3>
                        <button class="modal-close" onclick="closeGLAccountSelectionModal()">&times;</button>
                    </div>
                    <div class="modal-content">
                        <div class="linking-section">
                            <h4>Selected AP/AR Transaction</h4>
                            <div class="linking-list" id="selectedAPARForGL">
                                <!-- Will be populated -->
                            </div>
                        </div>
                        
                        <div class="linking-section">
                            <h4 id="balancingAccountTitle">Select Balancing Account</h4>
                            <p id="balancingAccountHelp" style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">
                                <!-- Will be populated with help text -->
                            </p>
                            
                            <!-- Quick Select Buttons -->
                            <div class="quick-select-accounts" id="quickSelectAccounts" style="margin-bottom: 1rem;">
                                <!-- Will be populated with suggested accounts -->
                            </div>
                            
                            <!-- Manual Account Selection -->
                            <div class="manual-account-selection">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Or select manually:</label>
                                <select id="manualAccountSelect" class="form-select" style="width: 100%;">
                                    <option value="">Choose an account...</option>
                                    <!-- Will be populated with all GL accounts -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button class="btn btn-secondary" onclick="closeGLAccountSelectionModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="confirmGLCreation()" id="createGLButton">Create GL Entries</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AP/AR Creation Modal for GL Linking -->
            <div class="modal-overlay" id="aparCreationModal">
                <div class="modal">
                    <div class="modal-header">
                        <h3 class="modal-title">Create AP/AR Entry</h3>
                        <button class="modal-close" onclick="closeAPARCreationModal()">&times;</button>
                    </div>
                    <div class="modal-content">
                        <div class="linking-section">
                            <h4>Selected GL Transaction</h4>
                            <div class="linking-list" id="selectedGLForAPAR">
                                <!-- Will be populated -->
                            </div>
                        </div>
                        
                        <div class="linking-section">
                            <h4>Create AP/AR Transaction</h4>
                            <form id="aparCreationForm">
                                <div class="form-row" style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="flex: 1;">
                                        <label class="form-label">Transaction Type</label>
                                        <select id="aparType" class="form-select" required>
                                            <option value="">Select Type</option>
                                            <option value="AR">Accounts Receivable (AR)</option>
                                            <option value="AP">Accounts Payable (AP)</option>
                                        </select>
                                    </div>
                                    <div style="flex: 1;">
                                        <label class="form-label">Company</label>
                                        <input type="text" id="aparCompany" class="form-input" placeholder="Company name" required>
                                    </div>
                                </div>
                                
                                <div class="form-row" style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="flex: 1;">
                                        <label class="form-label">Reference</label>
                                        <input type="text" id="aparReference" class="form-input" placeholder="INV-001, BILL-001, etc.">
                                    </div>
                                    <div style="flex: 1;">
                                        <label class="form-label">Amount</label>
                                        <input type="number" id="aparAmount" class="form-input" placeholder="0" readonly>
                                    </div>
                                </div>
                                
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label class="form-label">Description</label>
                                    <input type="text" id="aparDescription" class="form-input" placeholder="Transaction description" required>
                                </div>
                                
                                <div class="form-row" style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="flex: 1;">
                                        <label class="form-label">Invoice Date</label>
                                        <input type="date" id="aparInvoiceDate" class="form-input" required>
                                    </div>
                                    <div style="flex: 1;">
                                        <label class="form-label">Payment Terms (days)</label>
                                        <select id="aparPaymentTerms" class="form-select">
                                            <option value="30">Net 30</option>
                                            <option value="15">Net 15</option>
                                            <option value="7">Net 7</option>
                                            <option value="0">Due on Receipt</option>
                                            <option value="60">Net 60</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <select id="aparStatus" class="form-select">
                                        <option value="Unpaid">Unpaid</option>
                                        <option value="Partial">Partially Paid</option>
                                        <option value="Paid">Paid</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        
                        <div class="form-actions">
                            <button class="btn btn-secondary" onclick="closeAPARCreationModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="confirmAPARCreation()" id="createAPARButton">Create AP/AR Entry</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports & Analytics Section -->
            <div id="reports-section" class="section-content" style="display: none;">
                <div class="dashboard-section">
                
                    <!-- Sub-tabs within Reports & Analytics -->
                    <div class="reports-tab-nav">
                        <button class="reports-tab-btn active" onclick="switchReportsTab('pnl-comparison')" data-tab="pnl-comparison">
                            <i class="fas fa-chart-line"></i>
                            P&L Comparison
                        </button>
                        <button class="reports-tab-btn" onclick="switchReportsTab('revenue-opex-breakdown')" data-tab="revenue-opex-breakdown">
                            <i class="fas fa-chart-pie"></i>
                            Revenue & OPEX Breakdown
                        </button>
                        <button class="reports-tab-btn" onclick="switchReportsTab('trending-analysis')" data-tab="trending-analysis">
                            <i class="fas fa-trending-up"></i>
                            Trending Analysis
                        </button>
                    </div>
                
                    <!-- Tab Content 1: P&L Comparison (your existing content) -->
                    <div class="reports-tab-content active" id="pnl-comparison-tab">
                        <!-- Enhanced Period Selector -->
                        <div class="period-selector-section">
                            <div class="period-selector-card">
                                <div class="selector-header" style="display: flex; justify-content: space-between; align-items: center;">
                                    <h4><i class="fas fa-calendar-alt"></i> Compare Periods</h4>
                                    <div class="header-right">
                                        <div class="header-actions">
                                            <button class="btn btn-primary dark-icon" onclick="generateComparisonReport()">
                                                <i class="fas fa-chart-line"></i>
                                                Generate Report
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="period-options">
                                    <div class="period-type-selector">
                                        <label class="period-radio">
                                            <input type="radio" name="periodType" value="mom" onchange="updatePeriodType('mom')">
                                            <span>Month-over-Month</span>
                                        </label>
                                        <label class="period-radio">
                                            <input type="radio" name="periodType" value="qoq" onchange="updatePeriodType('qoq')">
                                            <span>Quarter-over-Quarter</span>
                                        </label>
                                        <label class="period-radio">
                                            <input type="radio" name="periodType" value="yoy" onchange="updatePeriodType('yoy')">
                                            <span>Year-over-Year</span>
                                        </label>
                                        <label class="period-radio">
                                            <input type="radio" name="periodType" value="custom" checked onchange="updatePeriodType('custom')">
                                            <span>Custom Comparison</span>
                                        </label>
                                    </div>
                                    
                                    <div class="period-selectors">
                                        <div class="period-group">
                                            <label>Current Period:</label>
                                            <select id="currentPeriod" class="form-select" onchange="updatePeriodSelection()">
                                                <!-- Options populated by JavaScript -->
                                            </select>
                                        </div>
                                        <div class="vs-indicator">vs</div>
                                        <div class="period-group">
                                            <label>Previous Period:</label>
                                            <select id="previousPeriod" class="form-select" onchange="updatePeriodSelection()">
                                                <!-- Options populated by JavaScript -->
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="yoy-option">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="includeYoY" checked onchange="updatePeriodSelection()">
                                            <span>Auto-include YoY:</span>
                                            <span id="yoyPeriodDisplay" class="yoy-period">Dec 2023 (if available)</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="comparison-options">
                                    <div class="options-section">
                                        <h5>Comparison Options</h5>
                                        <div class="checkbox-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" id="includeBudget" checked onchange="updateComparisonOptions()">
                                                <span>vs Budget</span>
                                            </label>
                                            <label class="checkbox-label">
                                                <input type="checkbox" id="includePreviousMonth" checked onchange="updateComparisonOptions()">
                                                <span>vs Previous Month</span>
                                            </label>
                                            <label class="checkbox-label">
                                                <input type="checkbox" id="includeLastYear" checked onchange="updateComparisonOptions()">
                                                <span>vs Last Year</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                
                        <!-- Loading State -->
                        <div id="comparisonLoading" class="loading-state" style="display: none;">
                            <div class="loading-spinner"></div>
                            <p>Generating P&L comparison...</p>
                        </div>
                
                        <!-- P&L Comparison Table -->
                        <div id="comparisonTableContent" class="comparison-table-container">
                            <!-- Content will be populated by JavaScript -->
                        </div>
                
                        <!-- Waterfall Charts Section -->
                        <div id="waterfallChartsSection" class="waterfall-section" style="display: none;">
                            <div class="charts-grid">
                                <div class="chart-container">
                                    <div id="revenueWaterfallChart" class="waterfall-chart"></div>
                                </div>
                                <div class="chart-container">
                                    <div id="grossProfitWaterfallChart" class="waterfall-chart"></div>
                                </div>
                                <div class="chart-container">
                                    <div id="opexWaterfallChart" class="waterfall-chart"></div>
                                </div>
                                <div class="chart-container">
                                    <div id="ebitdaWaterfallChart" class="waterfall-chart"></div>
                                </div>
                            </div>
                        </div>
                
                        <!-- Executive Summary -->
                        <div id="executiveSummary" class="executive-summary" style="display: none;">
                            <div class="summary-header">
                                <h4><i class="fas fa-bullseye"></i> Executive Summary</h4>
                            </div>
                            <div id="executiveSummaryContent" class="summary-content">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                
                    <!-- Tab Content 2: Revenue & OPEX Breakdown -->
                    <div class="reports-tab-content" id="revenue-opex-breakdown-tab" style="display: none;">
                        <!-- Period Controls -->
                        <div class="period-selector-section">
                            <div class="period-selector-card">
                                <div class="selector-header">
                                    <h4><i class="fas fa-calendar-alt"></i> Analysis Period</h4>
                                </div>
                                <div class="period-options">
                                    <div class="period-type-selector">
                                        <label class="period-radio">
                                            <input type="radio" name="breakdownPeriodType" value="month" checked>
                                            <span>Monthly</span>
                                        </label>
                                        <label class="period-radio">
                                            <input type="radio" name="breakdownPeriodType" value="quarter">
                                            <span>Quarterly</span>
                                        </label>
                                        <label class="period-radio">
                                            <input type="radio" name="breakdownPeriodType" value="year">
                                            <span>Yearly</span>
                                        </label>
                                    </div>
                                    <div class="period-selectors">
                                        <div class="period-group">
                                            <label>Select Period:</label>
                                            <select id="breakdownPeriod" class="form-select">
                                                <option value="2025-07">July 2025</option>
                                                <option value="2025-06">June 2025</option>
                                                <option value="2025-05">May 2025</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    
                        <!-- Summary Cards Row -->
                        <div class="breakdown-summary-row">
                            <div class="summary-card revenue">
                                <div class="summary-header">
                                    <h4><i class="fas fa-chart-line"></i> Total Revenue</h4>
                                    <span class="summary-amount" id="totalRevenue">Rp 0</span>
                                </div>
                                <div class="summary-change positive" id="revenueChange">+0% vs previous period</div>
                            </div>
                            <div class="summary-card opex">
                                <div class="summary-header">
                                    <h4><i class="fas fa-chart-bar"></i> Total OPEX</h4>
                                    <span class="summary-amount" id="totalOpex">Rp 0</span>
                                </div>
                                <div class="summary-change negative" id="opexChange">+0% vs previous period</div>
                            </div>
                            <div class="summary-card efficiency">
                                <div class="summary-header">
                                    <h4><i class="fas fa-percentage"></i> OPEX Ratio</h4>
                                    <span class="summary-amount" id="opexRatio">0%</span>
                                </div>
                                <div class="summary-change" id="opexRatioChange">of total revenue</div>
                            </div>
                        </div>
                    
                        <!-- Full Width Revenue Analysis -->
                        <div class="ro-analysis-panel-full">
                            <div class="analysis-header">
                                <h4><i class="fas fa-chart-line"></i> Revenue Analysis</h4>
                                <button class="btn btn-secondary" onclick="exportRevenueBreakdown()">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                            <div class="ro-analysis-content-full">
                                <p class="ro-analysis-subtitle">Distribution across income streams</p>
                                <div id="revenueBreakdownTable"></div>
                            </div>
                        </div>
                        
                        <!-- Full Width OPEX Analysis -->
                        <div class="ro-analysis-panel-full">
                            <div class="analysis-header">
                                <h4><i class="fas fa-chart-bar"></i> OPEX Analysis</h4>
                                <button class="btn btn-secondary" onclick="exportOpexBreakdown()">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                            <div class="ro-analysis-content-full">
                                <p class="ro-analysis-subtitle">Operating expenses by department</p>
                                <div id="opexBreakdownTable"></div>
                            </div>
                        </div>
                    
                        <!-- Full Width Insights Section -->
                        <div class="ro-insights-section-full">
                            <div class="ro-insights-header-full">
                                <i class="fas fa-lightbulb"></i>
                                <span>Key Insights & Recommendations</span>
                            </div>
                            <div class="ro-insights-content-full" id="revenueOpexInsights">
                                <!-- Insights will be populated here -->
                            </div>
                        </div>
                    </div>
                
                    <!-- Tab Content 3: Trending Analysis -->
                    <div class="reports-tab-content" id="trending-analysis-tab" style="display: none;">
                        <!-- Period Control -->
                        <div class="period-selector-section">
                            <div class="period-selector-card">
                                <div class="selector-header">
                                    <h4><i class="fas fa-chart-line"></i> Trending Period</h4>
                                </div>
                                <div class="period-options">
                                    <div class="period-selectors">
                                        <div class="period-group">
                                            <label>Months to Include:</label>
                                            <select id="trendingMonths" class="form-select" onchange="generateTrendingAnalysis()">
                                                <option value="3">3 months + current</option>
                                                <option value="6" selected>6 months + current</option>
                                                <option value="12">12 months + current</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    
                        <!-- Summary Cards -->
                        <div class="metrics-grid" style="margin-bottom: 2rem;">
                            <div class="metric-card enhanced-card">
                                <div class="card-accent accent-blue"></div>
                                <div class="metric-header">
                                    <div class="card-main">
                                        <div class="metric-title-group">
                                            <div class="metric-title">Revenue CMGR</div>
                                            <div class="metric-subtitle">Monthly Growth Rate</div>
                                        </div>
                                        <div class="metric-primary-group">
                                            <span class="metric-value-large" id="revenueTrendValue">+0%</span>
                                            <div class="metric-breakdown">
                                                <span class="breakdown-item">
                                                    <span class="breakdown-label">Velocity: </span>
                                                    <span class="breakdown-value" id="revenueVelocity">Steady</span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="metric-card enhanced-card">
                                <div class="card-accent accent-orange"></div>
                                <div class="metric-header">
                                    <div class="card-main">
                                        <div class="metric-title-group">
                                            <div class="metric-title">OPEX CMGR</div>
                                            <div class="metric-subtitle">Monthly Growth Rate</div>
                                        </div>
                                        <div class="metric-primary-group">
                                            <span class="metric-value-large" id="opexTrendValue">+0%</span>
                                            <div class="metric-breakdown">
                                                <span class="breakdown-item">
                                                    <span class="breakdown-label">Efficiency: </span>
                                                    <span class="breakdown-value" id="opexEfficiency">Stable</span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="metric-card enhanced-card">
                                <div class="card-accent accent-green"></div>
                                <div class="metric-header">
                                    <div class="card-main">
                                        <div class="metric-title-group">
                                            <div class="metric-title">Margin Trend</div>
                                            <div class="metric-subtitle">Gross Margin</div>
                                        </div>
                                        <div class="metric-primary-group">
                                            <span class="metric-value-large" id="marginTrendValue">0%</span>
                                            <div class="metric-breakdown">
                                                <span class="breakdown-item">
                                                    <span class="breakdown-label">Direction: </span>
                                                    <span class="breakdown-value" id="marginDirection">Stable</span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="metric-card enhanced-card">
                                <div class="card-accent accent-blue"></div>
                                <div class="metric-header">
                                    <div class="card-main">
                                        <div class="metric-title-group">
                                            <div class="metric-title">Current Month</div>
                                            <div class="metric-subtitle">July 2025 Progress</div>
                                        </div>
                                        <div class="metric-primary-group">
                                            <span class="metric-value-large" id="currentMonthProgress">0%</span>
                                            <div class="metric-breakdown">
                                                <span class="breakdown-item">
                                                    <span class="breakdown-label">Projected: </span>
                                                    <span class="breakdown-value" id="currentMonthProjected">Rp 0M</span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    
                        <!-- Main Trending Chart -->
                        <div class="ro-analysis-panel-full">
                            <div class="trending-chart-header">
                                <div class="trending-title-section">
                                    <h4>Revenue & OPEX Trending Analysis</h4>
                                    <p class="trending-subtitle">Historical performance with current month projection</p>
                                </div>
                                <button class="btn btn-secondary" onclick="exportTrendingChart()">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                            <div class="trending-chart-divider"></div>
                            <div class="trending-chart-container">
                                <canvas id="trendingChart" width="800" height="400"></canvas>
                            </div>
                        </div>
                    
                        <!-- Full Width Insights Section -->
                        <div class="ro-insights-section-full">
                            <div class="ro-insights-header-full">
                                <span>Trending Insights & Analysis</span>
                            </div>
                            <div class="ro-insights-content-full" id="trendingInsights">
                                <!-- Insights will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budgets & Planning Section -->
            <div id="budgets-section" class="section-content" style="display: none;">
                <!-- Budget Management Header Card -->
                <div id="budgetControlPanel">
                    <div class="budget-controls-new">
                        <div class="budget-controls-left">
                            <div class="budget-selector-group">
                                <label for="budgetYearSelect" class="budget-selector-label">Budget Year</label>
                                <select id="budgetYearSelect" class="budget-year-select" onchange="loadBudgetYear()">
                                    <option value="">Select Budget Year</option>
                                    </select>
                            </div>
                            <div class="budget-status-group">
                                <label class="budget-selector-label">Status</label>
                                <span id="budgetStatus" class="priority-badge draft">Draft</span>
                            </div>
                        </div>
                        <div class="budget-controls-right">
                            <button class="btn btn-secondary btn-add-line" onclick="addBudgetLine()">
                                <i class="fas fa-plus"></i> Add Line Item
                            </button>
                            <button class="btn btn-primary btn-save-budget" onclick="saveBudget()">
                                <i class="fas fa-save"></i> Save Budget
                            </button>
                        </div>
                    </div>
                </div>
            
                <!-- Budget Summary Cards -->
                <div class="metrics-grid" style="margin-bottom: 2rem;">
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">Total Revenue</div>
                            <i class="fas fa-chart-line metric-icon"></i>
                        </div>
                        <div class="metric-value" id="budgetTotalRevenue">Rp 0</div>
                        <div class="metric-change positive" id="budgetRevenueChange">vs Forecast</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">Total Expenses</div>
                            <i class="fas fa-chart-bar metric-icon"></i>
                        </div>
                        <div class="metric-value" id="budgetTotalExpenses">Rp 0</div>
                        <div class="metric-change" id="budgetExpenseChange">vs Forecast</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">Net Profit</div>
                            <i class="fas fa-trophy metric-icon"></i>
                        </div>
                        <div class="metric-value" id="budgetNetProfit">Rp 0</div>
                        <div class="metric-change" id="budgetProfitChange">vs Forecast</div>
                    </div>
                </div>
            
                <!-- Detailed Budget Breakdown -->
                <div class="content-card">
                    <div class="budget-section-header">
                        <h2 class="budget-section-title">
                            <i class="fas fa-calculator"></i>
                            Detailed Budget Breakdown
                        </h2>
                        <div class="budget-meta-info">
                            <span id="budgetSource">
                                <i class="fas fa-info-circle"></i>
                                Source: Manual
                            </span>
                            <span id="budgetLastUpdated">
                                <i class="fas fa-clock"></i>
                                Last Updated: Today
                            </span>
                        </div>
                    </div>
                    
                    <div class="panel-content">
                        <div class="budget-table-wrapper">
                            <table class="budget-detail-table" id="budgetTable">
                                <thead>
                                    <tr>
                                        <th class="budget-line-header">Line Item</th>
                                        <th class="budget-month-header">Jan</th>
                                        <th class="budget-month-header">Feb</th>
                                        <th class="budget-month-header">Mar</th>
                                        <th class="budget-month-header">Apr</th>
                                        <th class="budget-month-header">May</th>
                                        <th class="budget-month-header">Jun</th>
                                        <th class="budget-month-header">Jul</th>
                                        <th class="budget-month-header">Aug</th>
                                        <th class="budget-month-header">Sep</th>
                                        <th class="budget-month-header">Oct</th>
                                        <th class="budget-month-header">Nov</th>
                                        <th class="budget-month-header">Dec</th>
                                        <th class="budget-total-header">Total</th>
                                        <th class="budget-actions-header"></th>
                                    </tr>
                                </thead>
                                <tbody id="budgetTableBody">
                                    <!-- Revenue Section -->
                                    <tr class="budget-category-row" data-category="revenue">
                                        <td class="budget-category-cell">
                                            <span class="budget-category-toggle" onclick="toggleBudgetCategory('revenue')">
                                                <i class="fas fa-chevron-down"></i>
                                            </span>
                                            <strong class="budget-category-title">REVENUE</strong>
                                            <div class="category-target-input">
                                                <label>Target:</label>
                                                <input type="number" id="revenueTarget" class="target-input" 
                                                       placeholder="e.g., 10000000000" onchange="enableAIReallocation()">
                                                <button class="btn-ai-allocate" onclick="aiAllocateCategory('revenue')">
                                                    <i class="fas fa-magic"></i> AI Allocate
                                                </button>
                                            </div>
                                        </td>
                                        <td colspan="14" class="budget-category-total" id="revenueCategoryTotal">Rp 0</td>
                                    </tr>
                                    
                                    <!-- Revenue line items will be inserted here -->
                                    
                                    <!-- COGS Section -->
                                    <tr class="budget-category-row" data-category="cogs">
                                        <td class="budget-category-cell">
                                            <span class="budget-category-toggle" onclick="toggleBudgetCategory('cogs')">
                                                <i class="fas fa-chevron-down"></i>
                                            </span>
                                            <strong class="budget-category-title">COST OF GOODS SOLD</strong>
                                            <div class="category-target-input">
                                                <label>Target:</label>
                                                <input type="number" id="cogsTarget" class="target-input" 
                                                       placeholder="e.g., 2000000000" onchange="enableAIReallocation()">
                                                <button class="btn-ai-allocate" onclick="aiAllocateCategory('cogs')">
                                                    <i class="fas fa-magic"></i> AI Allocate
                                                </button>
                                            </div>
                                        </td>
                                        <td colspan="14" class="budget-category-total" id="cogsCategoryTotal">Rp 0</td>
                                    </tr>
                                    
                                    <!-- COGS line items will be inserted here -->
                                    
                                    <!-- OpEx Section -->
                                    <tr class="budget-category-row" data-category="opex">
                                        <td class="budget-category-cell">
                                            <span class="budget-category-toggle" onclick="toggleBudgetCategory('opex')">
                                                <i class="fas fa-chevron-down"></i>
                                            </span>
                                            <strong class="budget-category-title">OPERATING EXPENSES</strong>
                                            <div class="category-target-input">
                                                <label>Target:</label>
                                                <input type="number" id="opexTarget" class="target-input" 
                                                       placeholder="e.g., 3000000000" onchange="enableAIReallocation()">
                                                <button class="btn-ai-allocate" onclick="aiAllocateCategory('opex')">
                                                    <i class="fas fa-magic"></i> AI Allocate
                                                </button>
                                            </div>
                                        </td>
                                        <td colspan="14" class="budget-category-total" id="opexCategoryTotal">Rp 0</td>
                                    </tr>
                                    
                                    <!-- OpEx line items will be inserted here -->
                                    
                                    <!-- Summary Rows -->
                                    <tr class="budget-summary-row">
                                        <td class="budget-summary-label"><strong>GROSS PROFIT</strong></td>
                                        <td class="budget-summary-cell" id="grossProfitJan">Rp 0</td>
                                        <td class="budget-summary-cell" id="grossProfitFeb">Rp 0</td>
                                        <td class="budget-summary-cell" id="grossProfitMar">Rp 0</td>
                                        <td class="budget-summary-cell" id="grossProfitApr">Rp 0</td>
                                        <td class="budget-summary-cell" id="grossProfitMay">Rp 0</td>
                                        <td class="budget-summary-cell" id="grossProfitJun">Rp 0</td>
                                        <td class="budget-summary-cell" id="grossProfitJul">Rp 0</td>
                                        <td class="budget-summary-cell" id="grossProfitAug">Rp 0</td>
                                        <td class="budget-summary-cell" id="grossProfitSep">Rp 0</td>
                                        <td class="budget-summary-cell" id="grossProfitOct">Rp 0</td>
                                        <td class="budget-summary-cell" id="grossProfitNov">Rp 0</td>
                                        <td class="budget-summary-cell" id="grossProfitDec">Rp 0</td>
                                        <td class="budget-summary-total" id="grossProfitTotal">Rp 0</td>
                                        <td></td>
                                    </tr>
                                    
                                    <tr class="budget-summary-row budget-final-row">
                                        <td class="budget-summary-label"><strong>NET PROFIT</strong></td>
                                        <td class="budget-summary-cell" id="netProfitJan">Rp 0</td>
                                        <td class="budget-summary-cell" id="netProfitFeb">Rp 0</td>
                                        <td class="budget-summary-cell" id="netProfitMar">Rp 0</td>
                                        <td class="budget-summary-cell" id="netProfitApr">Rp 0</td>
                                        <td class="budget-summary-cell" id="netProfitMay">Rp 0</td>
                                        <td class="budget-summary-cell" id="netProfitJun">Rp 0</td>
                                        <td class="budget-summary-cell" id="netProfitJul">Rp 0</td>
                                        <td class="budget-summary-cell" id="netProfitAug">Rp 0</td>
                                        <td class="budget-summary-cell" id="netProfitSep">Rp 0</td>
                                        <td class="budget-summary-cell" id="netProfitOct">Rp 0</td>
                                        <td class="budget-summary-cell" id="netProfitNov">Rp 0</td>
                                        <td class="budget-summary-cell" id="netProfitDec">Rp 0</td>
                                        <td class="budget-summary-total" id="netProfitTotal">Rp 0</td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Forecasting Section -->
            <div id="forecasting-section" class="section-content" style="display: none;">
                <div class="dashboard-section">             
                    <!-- Period Info -->
                    <div class="forecast-status-info">
                        <div class="status-indicators">
                            <div class="actual-status-indicator">
                                <span class="status-dot actual-dot"></span>
                                <span>Jan-Jun 2025: Actual (from Supabase)</span>
                            </div>
                            <div class="forecast-status-indicator">
                                <span class="status-dot forecast-dot"></span>
                                <span>Jul-Dec 2025: Forecast (AI + Editable)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Period Selector Tabs -->
                    <div class="forecast-period-tabs">
                        <button class="period-tab-btn active" data-period="current-year">
                            <i class="fas fa-calendar"></i>
                            2025 Monthly (Jul-Dec)
                        </button>
                        <button class="period-tab-btn" data-period="next-year">
                            <i class="fas fa-calendar-alt"></i>
                            2026 Full Year
                        </button>
                        <button class="period-tab-btn" data-period="multi-year">
                            <i class="fas fa-chart-line"></i>
                            2027-2030 Quarterly
                        </button>
                        <button class="period-tab-btn" data-period="summary">
                            <i class="fas fa-table"></i>
                            Annual Summary
                        </button>
                    </div>
                
                    <!-- Main P&L Table -->
                    <div class="pl-forecast-container" id="current-year-container">
                        <div class="pl-table-header">
                            <h4>2025 P&L Forecast - Actual vs Budget</h4>
                            <div class="pl-table-controls">
                                <button class="btn btn-secondary" onclick="refreshActualData()">
                                    <i class="fas fa-sync"></i> Refresh Actuals
                                </button>
                                <button class="btn btn-secondary" onclick="copyPLForecastTable()">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <button class="btn btn-secondary" onclick="exportPLForecast()">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>

                        <!-- Update the 2025 forecasting controls -->
                        <div class="forecasting-ai-controls">
                            <div class="forecasting-ai-controls-left">
                                <div class="industry-input-wrapper">
                                    <label for="forecastIndustrySelect">Industry Context:</label>
                                    <select id="forecastIndustrySelect" class="industry-input-select">
                                        <option value="">Select Industry for AI Context</option>
                                        <option value="saas">SaaS / Technology</option>
                                        <option value="retail">Retail / E-commerce</option>
                                        <option value="consulting">Consulting / Services</option>
                                        <option value="manufacturing">Manufacturing</option>
                                        <option value="healthcare">Healthcare</option>
                                        <option value="fintech">FinTech</option>
                                    </select>
                                </div>
                                <div class="industry-input-wrapper">
                                    <label for="forecastStyleSelect">Forecast Style:</label>
                                    <select id="forecastStyleSelect" class="industry-input-select">
                                        <option value="normal">Normal Growth</option>
                                        <option value="aggressive">Aggressive Growth</option>
                                        <option value="pessimistic">Conservative/Pessimistic</option>
                                    </select>
                                </div>
                                <button class="btn btn-outline" onclick="loadLatestForecastFromSupabase()">
                                    <i class="fas fa-history"></i>
                                    Load Latest Forecast
                                </button>
                            </div>
                            <div class="forecasting-ai-controls-right">
                                <button class="btn btn-outline" onclick="convertForecastToBudget(event)">
                                    <i class="fas fa-download"></i> Convert to Budget
                                </button>
                                <button class="btn btn-primary" id="generateAIForecast">
                                    <i class="fas fa-brain"></i>
                                    Generate AI Forecast
                                </button>
                            </div>
                        </div>
                        
                        <div class="pl-table-scroll">
                            <table class="pl-forecast-table" id="plForecastTable">
                                <thead>
                                    <tr>
                                        <th class="pl-line-item-header">Line Item</th>
                                        <th class="pl-total-header" id="dynamic-month-headers">Loading...</th>
                                        <th class="pl-total-header">2025 Total</th>
                                        <th class="pl-percentage-header">% of Revenue</th>
                                    </tr>
                                </thead>
                                <tbody id="plForecastBody">
                                    <tr class="placeholder-row">
                                        <td colspan="15" class="placeholder-text">
                                            <i class="fas fa-brain"></i>
                                            Select an industry and generate AI forecast to view projections
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- AI Insights Section - Add this after the P&L forecast table -->
                    <div class="ai-insights-container" id="aiInsightsContainer" style="display: none;">
                        <div class="insights-header-AIinsight">
                            <h4><i class="fas fa-brain"></i> AI Analysis & Insights</h4>
                            <div class="insights-meta">
                                <span class="confidence-badge" id="confidenceBadge">Confidence: 85%</span>
                                <span class="forecast-date" id="forecastDate">Generated: Today</span>
                            </div>
                        </div>
                        
                        <div class="insights-content">
                            <div class="insight-card key-trends-card">
                                <div class="insight-header">
                                    <i class="fas fa-chart-line insight-icon"></i>
                                    <h5>Key Trends</h5>
                                </div>
                                <div class="insight-text" id="keyTrendsText">
                                    AI analysis will appear here...
                                </div>
                            </div>
                            
                            <div class="insight-card risk-factors-card">
                                <div class="insight-header">
                                    <i class="fas fa-exclamation-triangle insight-icon"></i>
                                    <h5>Risk Factors</h5>
                                </div>
                                <div class="insight-text" id="riskFactorsText">
                                    Risk analysis will appear here...
                                </div>
                            </div>
                            
                            <div class="insight-card opportunities-card">
                                <div class="insight-header">
                                    <i class="fas fa-lightbulb insight-icon"></i>
                                    <h5>Opportunities</h5>
                                </div>
                                <div class="insight-text" id="opportunitiesText">
                                    Growth opportunities will appear here...
                                </div>
                            </div>
                            
                            <div class="insight-card methodology-card">
                                <div class="insight-header">
                                    <i class="fas fa-cogs insight-icon"></i>
                                    <h5>Methodology</h5>
                                </div>
                                <div class="insight-text" id="methodologyText">
                                    Forecasting methodology will appear here...
                                </div>
                            </div>
                        </div>
                        
                        <div class="insights-actions">
                            <button class="btn btn-secondary" onclick="exportInsightsToPDF()">
                                <i class="fas fa-file-pdf"></i> Export Insights
                            </button>
                            <button class="btn btn-secondary" onclick="copyInsightsToClipboard()">
                                <i class="fas fa-copy"></i> Copy Analysis
                            </button>
                            <button class="btn btn-outline" onclick="hideInsights()">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>

                    <!-- Forecast Trending Chart - Reusing existing styling -->
                    <div class="ro-analysis-panel-full" id="forecastTrendingContainer" style="display: none;">
                        <div class="trending-chart-header">
                            <div class="trending-title-section">
                                <h4>Financial Performance Trends</h4>
                                <p class="trending-subtitle">Revenue, COGS, Gross Profit & EBITDA progression with forecast</p>
                            </div>
                            <button class="btn btn-secondary" onclick="exportForecastTrendingChart()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                        <div class="trending-chart-divider"></div>
                        <div class="trending-chart-container">
                            <canvas id="forecastTrendingChart" width="800" height="400"></canvas>
                        </div>
                        
                        <!-- Enhanced Metrics Summary -->
                        <div class="breakdown-summary-row" style="margin-top: 1.5rem;">
                            <div class="summary-card revenue">
                                <div class="summary-header">
                                    <h4>Revenue Growth</h4>
                                    <span class="summary-amount" id="forecastRevenueGrowth">+0%</span>
                                </div>
                                <div class="summary-change positive" id="revenueGrowthDirection">Year-over-year</div>
                            </div>
                            <div class="summary-card efficiency">
                                <div class="summary-header">
                                    <h4>Gross Margin</h4>
                                    <span class="summary-amount" id="forecastGrossMargin">0%</span>
                                </div>
                                <div class="summary-change" id="grossMarginTrend">Average forecast</div>
                            </div>
                            <div class="summary-card opex">
                                <div class="summary-header">
                                    <h4>EBITDA Margin</h4>
                                    <span class="summary-amount" id="forecastEbitdaMargin">0%</span>
                                </div>
                                <div class="summary-change" id="ebitdaMarginTrend">Forecast average</div>
                            </div>
                        </div>
                    </div>

                    <!-- 2026 Full Year Table -->
                    <div class="pl-forecast-container" id="next-year-container" style="display: none;">
                        <div class="pl-table-header">
                            <h4>2026 Full Year Forecast</h4>
                            <div class="pl-table-controls">
                                <button class="btn btn-secondary" onclick="copyPLForecastTable('2026')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <button class="btn btn-secondary" onclick="exportPLForecast('2026')">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>

                        <div class="forecasting-ai-controls">
                            <div class="forecasting-ai-controls-left">
                                <div class="industry-input-wrapper">
                                    <label for="forecast2026IndustrySelect">Industry Context:</label>
                                    <select id="forecast2026IndustrySelect" class="industry-input-select">
                                        <option value="">Select Industry for AI Context</option>
                                        <option value="saas">SaaS / Technology</option>
                                        <option value="retail">Retail / E-commerce</option>
                                        <option value="consulting">Consulting / Services</option>
                                        <option value="manufacturing">Manufacturing</option>
                                        <option value="healthcare">Healthcare</option>
                                        <option value="fintech">FinTech</option>
                                    </select>
                                </div>
                                <div class="industry-input-wrapper">
                                    <label for="forecast2026StyleSelect">Forecast Style:</label>
                                    <select id="forecast2026StyleSelect" class="industry-input-select">
                                        <option value="normal">Normal Growth</option>
                                        <option value="aggressive">Aggressive Growth</option>
                                        <option value="pessimistic">Conservative/Pessimistic</option>
                                    </select>
                                </div>
                                <div class="context-input-wrapper">
                                    <label for="forecast2026Context">Additional Context:</label>
                                    <input type="text" id="forecast2026Context" placeholder="e.g., Expanding to new markets, launching new product..." style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px;">
                                </div>
                                <button class="btn btn-outline" onclick="loadLatest2026ForecastFromSupabase()">
                                    <i class="fas fa-history"></i>
                                    Load Latest Forecast
                                </button>
                            </div>
                            <div class="forecasting-ai-controls-right">
                                <button class="btn btn-outline" onclick="convert2026ForecastToBudget(event)">
                                    <i class="fas fa-download"></i> Convert to Budget
                                </button>
                                <button class="btn btn-primary" id="generateAI2026Forecast">
                                    <i class="fas fa-brain"></i>
                                    Generate AI Forecast
                                </button>
                            </div>
                        </div>
                        
                        <div class="pl-table-scroll">
                            <table class="pl-forecast-table" id="plForecast2026Table">
                                <thead>
                                    <tr>
                                        <th class="pl-line-item-header">Line Item</th>
                                        <th class="pl-month-header">Jan</th>
                                        <th class="pl-month-header">Feb</th>
                                        <th class="pl-month-header">Mar</th>
                                        <th class="pl-month-header">Apr</th>
                                        <th class="pl-month-header">May</th>
                                        <th class="pl-month-header">Jun</th>
                                        <th class="pl-month-header">Jul</th>
                                        <th class="pl-month-header">Aug</th>
                                        <th class="pl-month-header">Sep</th>
                                        <th class="pl-month-header">Oct</th>
                                        <th class="pl-month-header">Nov</th>
                                        <th class="pl-month-header">Dec</th>
                                        <th class="pl-total-header">2026 Total</th>
                                    </tr>
                                </thead>
                                <tbody id="plForecast2026Body">
                                    <tr class="placeholder-row">
                                        <td colspan="14" class="placeholder-text">
                                            <i class="fas fa-brain"></i>
                                            Generate AI forecast to view 2026 projections
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Multi-Year Quarterly Table -->
                    <div class="pl-forecast-container" id="multi-year-container" style="display: none;">
                        <div class="pl-table-header">
                            <h4>Multi-Year Quarterly Forecast (2027-2030)</h4>
                            <div class="pl-table-controls">
                                <button class="btn btn-secondary" onclick="copyPLForecastTable('multiyear')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <button class="btn btn-secondary" onclick="exportPLForecast('multiyear')">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                    
                        <!-- Multi-Year AI Controls -->
                        <div class="forecasting-ai-controls">
                            <div class="forecasting-ai-controls-left">
                                <div class="industry-input-wrapper">
                                    <label for="forecastMultiYearIndustrySelect">Industry Context:</label>
                                    <select id="forecastMultiYearIndustrySelect" class="industry-input-select">
                                        <option value="">Select Industry for AI Context</option>
                                        <option value="saas">SaaS / Technology</option>
                                        <option value="retail">Retail / E-commerce</option>
                                        <option value="consulting">Consulting / Services</option>
                                        <option value="manufacturing">Manufacturing</option>
                                        <option value="healthcare">Healthcare</option>
                                        <option value="fintech">FinTech</option>
                                    </select>
                                </div>
                                <div class="industry-input-wrapper">
                                    <label for="forecastMultiYearStyleSelect">Forecast Style:</label>
                                    <select id="forecastMultiYearStyleSelect" class="industry-input-select">
                                        <option value="normal">Normal Growth</option>
                                        <option value="aggressive">Aggressive Growth</option>
                                        <option value="pessimistic">Conservative/Pessimistic</option>
                                    </select>
                                </div>
                                <div class="context-input-wrapper">
                                    <label for="forecastMultiYearContext">Additional Context:</label>
                                    <input type="text" id="forecastMultiYearContext" placeholder="e.g., Major expansion plans, new product launches, market shifts..." style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px;">
                                </div>
                                <button class="btn btn-outline" onclick="loadLatestMultiYearForecastFromSupabase()">
                                    <i class="fas fa-history"></i>
                                    Load Latest Forecast
                                </button>
                            </div>
                            <div class="forecasting-ai-controls-right">
                                <button class="btn btn-outline" onclick="convertMultiYearForecastToBudget(event)">
                                    <i class="fas fa-download"></i> Convert to Budget
                                </button>
                                <button class="btn btn-primary" id="generateAIMultiYearForecast">
                                    <i class="fas fa-brain"></i>
                                    Generate AI Forecast
                                </button>
                            </div>
                        </div>
                        
                        <!-- Multi-Year Tables by Year -->
                        <div class="multi-year-tables-container">
                            <!-- 2027 Table -->
                            <div class="year-section">
                                <div class="year-header">
                                    <h5>2027 Quarterly Forecast</h5>
                                </div>
                                <div class="pl-table-scroll">
                                    <table class="pl-forecast-table" id="plForecast2027Table">
                                        <thead>
                                            <tr>
                                                <th class="pl-line-item-header">Line Item</th>
                                                <th class="pl-quarter-header">Q1 2027</th>
                                                <th class="pl-quarter-header">Q2 2027</th>
                                                <th class="pl-quarter-header">Q3 2027</th>
                                                <th class="pl-quarter-header">Q4 2027</th>
                                                <th class="pl-total-header">2027 Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="plForecast2027Body">
                                            <tr class="placeholder-row">
                                                <td colspan="6" class="placeholder-text">
                                                    <i class="fas fa-brain"></i>
                                                    Generate AI forecast to view 2027 projections
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                    
                            <!-- 2028 Table -->
                            <div class="year-section">
                                <div class="year-header">
                                    <h5>2028 Quarterly Forecast</h5>
                                </div>
                                <div class="pl-table-scroll">
                                    <table class="pl-forecast-table" id="plForecast2028Table">
                                        <thead>
                                            <tr>
                                                <th class="pl-line-item-header">Line Item</th>
                                                <th class="pl-quarter-header">Q1 2028</th>
                                                <th class="pl-quarter-header">Q2 2028</th>
                                                <th class="pl-quarter-header">Q3 2028</th>
                                                <th class="pl-quarter-header">Q4 2028</th>
                                                <th class="pl-total-header">2028 Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="plForecast2028Body">
                                            <tr class="placeholder-row">
                                                <td colspan="6" class="placeholder-text">
                                                    <i class="fas fa-brain"></i>
                                                    Generate AI forecast to view 2028 projections
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                    
                            <!-- 2029 Table -->
                            <div class="year-section">
                                <div class="year-header">
                                    <h5>2029 Quarterly Forecast</h5>
                                </div>
                                <div class="pl-table-scroll">
                                    <table class="pl-forecast-table" id="plForecast2029Table">
                                        <thead>
                                            <tr>
                                                <th class="pl-line-item-header">Line Item</th>
                                                <th class="pl-quarter-header">Q1 2029</th>
                                                <th class="pl-quarter-header">Q2 2029</th>
                                                <th class="pl-quarter-header">Q3 2029</th>
                                                <th class="pl-quarter-header">Q4 2029</th>
                                                <th class="pl-total-header">2029 Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="plForecast2029Body">
                                            <tr class="placeholder-row">
                                                <td colspan="6" class="placeholder-text">
                                                    <i class="fas fa-brain"></i>
                                                    Generate AI forecast to view 2029 projections
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                    
                            <!-- 2030 Table -->
                            <div class="year-section">
                                <div class="year-header">
                                    <h5>2030 Quarterly Forecast</h5>
                                </div>
                                <div class="pl-table-scroll">
                                    <table class="pl-forecast-table" id="plForecast2030Table">
                                        <thead>
                                            <tr>
                                                <th class="pl-line-item-header">Line Item</th>
                                                <th class="pl-quarter-header">Q1 2030</th>
                                                <th class="pl-quarter-header">Q2 2030</th>
                                                <th class="pl-quarter-header">Q3 2030</th>
                                                <th class="pl-quarter-header">Q4 2030</th>
                                                <th class="pl-total-header">2030 Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="plForecast2030Body">
                                            <tr class="placeholder-row">
                                                <td colspan="6" class="placeholder-text">
                                                    <i class="fas fa-brain"></i>
                                                    Generate AI forecast to view 2030 projections
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Multi-Year Trending Chart Section -->
                    <div class="ro-analysis-panel-full" id="multiYearTrendingSection" style="display: none; margin-top: 2rem;">
                        <div class="trending-chart-header">
                            <div class="trending-title-section">
                                <h4>Multi-Year Quarterly Trending Analysis (2027-2030)</h4>
                                <p class="trending-subtitle">Quarterly performance projection across 4 years</p>
                            </div>
                            <button class="btn btn-secondary" onclick="exportMultiYearTrendingChart()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                        <div class="trending-chart-divider"></div>
                        
                        <!-- Chart Container - NO summary cards inside -->
                        <div class="trending-chart-container">
                            <canvas id="multiYearTrendingChart" width="800" height="400"></canvas>
                        </div>
                        
                        <!-- Summary Cards OUTSIDE the chart container -->
                        <div class="breakdown-summary-row" style="margin-top: 1.5rem;">
                            <div class="summary-card revenue">
                                <div class="summary-header">
                                    <h4><i class="fas fa-chart-line"></i> CAGR (2027-2030)</h4>
                                    <span class="summary-amount" id="multiYearRevenueCAGR">+0%</span>
                                </div>
                                <div class="summary-change positive" id="multiYearCAGRDirection">Compound Growth</div>
                            </div>
                            <div class="summary-card efficiency">
                                <div class="summary-header">
                                    <h4><i class="fas fa-percentage"></i> Avg Gross Margin</h4>
                                    <span class="summary-amount" id="multiYearGrossMargin">0%</span>
                                </div>
                                <div class="summary-change" id="multiYearGrossMarginTrend">4-Year Average</div>
                            </div>
                            <div class="summary-card opex">
                                <div class="summary-header">
                                    <h4><i class="fas fa-chart-bar"></i> Avg EBITDA Margin</h4>
                                    <span class="summary-amount" id="multiYearEbitdaMargin">0%</span>
                                </div>
                                <div class="summary-change" id="multiYearEbitdaMarginTrend">4-Year Average</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Annual Summary Table -->
                    <div class="pl-forecast-container" id="summary-container" style="display: none;">
                        <div class="pl-table-header">
                            <h4>Annual Growth Summary (2025-2030)</h4>
                            <div class="pl-table-controls">
                                <button class="btn btn-secondary" onclick="copyPLForecastTable('summary')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <button class="btn btn-secondary" onclick="exportPLForecast('summary')">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                        
                        <div class="pl-table-scroll">
                            <table class="pl-forecast-table" id="plForecastSummaryTable">
                                <thead>
                                    <tr>
                                        <th class="pl-line-item-header">P&L Line Items</th>
                                        <th class="pl-year-header">2025</th>
                                        <th class="pl-year-header">2026</th>
                                        <th class="pl-growth-header">YoY Growth</th>
                                        <th class="pl-year-header">2027</th>
                                        <th class="pl-growth-header">YoY Growth</th>
                                        <th class="pl-year-header">2028</th>
                                        <th class="pl-growth-header">YoY Growth</th>
                                        <th class="pl-year-header">2029</th>
                                        <th class="pl-growth-header">YoY Growth</th>
                                        <th class="pl-year-header">2030</th>
                                        <th class="pl-growth-header">YoY Growth</th>
                                        <th class="pl-cagr-header">6-Yr CAGR</th>
                                    </tr>
                                </thead>
                                <tbody id="plSummaryTableBody">
                                    <!-- Revenue Section -->
                                    <tr class="pl-section-header">
                                        <td colspan="13"><strong>REVENUE</strong></td>
                                    </tr>
                                    <tr data-account="total-revenue" class="pl-summary-row revenue-row">
                                        <td class="pl-line-item-header">Total Revenue</td>
                                        <td class="pl-year-cell" data-year="2025">-</td>
                                        <td class="pl-year-cell" data-year="2026">-</td>
                                        <td class="pl-growth-cell" data-growth="2026">-</td>
                                        <td class="pl-year-cell" data-year="2027">-</td>
                                        <td class="pl-growth-cell" data-growth="2027">-</td>
                                        <td class="pl-year-cell" data-year="2028">-</td>
                                        <td class="pl-growth-cell" data-growth="2028">-</td>
                                        <td class="pl-year-cell" data-year="2029">-</td>
                                        <td class="pl-growth-cell" data-growth="2029">-</td>
                                        <td class="pl-year-cell" data-year="2030">-</td>
                                        <td class="pl-growth-cell" data-growth="2030">-</td>
                                        <td class="pl-cagr-cell" data-cagr="total-revenue">-</td>
                                    </tr>
                                    
                                    <!-- COGS Section -->
                                    <tr class="pl-section-header">
                                        <td colspan="13"><strong>COST OF GOODS SOLD</strong></td>
                                    </tr>
                                    <tr data-account="total-cogs" class="pl-summary-row cogs-row">
                                        <td class="pl-line-item-header">Total COGS</td>
                                        <td class="pl-year-cell" data-year="2025">-</td>
                                        <td class="pl-year-cell" data-year="2026">-</td>
                                        <td class="pl-growth-cell" data-growth="2026">-</td>
                                        <td class="pl-year-cell" data-year="2027">-</td>
                                        <td class="pl-growth-cell" data-growth="2027">-</td>
                                        <td class="pl-year-cell" data-year="2028">-</td>
                                        <td class="pl-growth-cell" data-growth="2028">-</td>
                                        <td class="pl-year-cell" data-year="2029">-</td>
                                        <td class="pl-growth-cell" data-growth="2029">-</td>
                                        <td class="pl-year-cell" data-year="2030">-</td>
                                        <td class="pl-growth-cell" data-growth="2030">-</td>
                                        <td class="pl-cagr-cell" data-cagr="total-cogs">-</td>
                                    </tr>
                                    
                                    <!-- Gross Profit Section -->
                                    <tr class="pl-section-header">
                                        <td colspan="13"><strong>GROSS PROFIT</strong></td>
                                    </tr>
                                    <tr data-account="gross-profit" class="pl-summary-row profit-row">
                                        <td class="pl-line-item-header">Gross Profit</td>
                                        <td class="pl-year-cell" data-year="2025">-</td>
                                        <td class="pl-year-cell" data-year="2026">-</td>
                                        <td class="pl-growth-cell" data-growth="2026">-</td>
                                        <td class="pl-year-cell" data-year="2027">-</td>
                                        <td class="pl-growth-cell" data-growth="2027">-</td>
                                        <td class="pl-year-cell" data-year="2028">-</td>
                                        <td class="pl-growth-cell" data-growth="2028">-</td>
                                        <td class="pl-year-cell" data-year="2029">-</td>
                                        <td class="pl-growth-cell" data-growth="2029">-</td>
                                        <td class="pl-year-cell" data-year="2030">-</td>
                                        <td class="pl-growth-cell" data-growth="2030">-</td>
                                        <td class="pl-cagr-cell" data-cagr="gross-profit">-</td>
                                    </tr>
                                    <tr data-account="gross-margin" class="pl-summary-row margin-row">
                                        <td class="pl-line-item-header">Gross Margin %</td>
                                        <td class="pl-year-cell percentage" data-year="2025">-</td>
                                        <td class="pl-year-cell percentage" data-year="2026">-</td>
                                        <td class="pl-growth-cell percentage" data-growth="2026">-</td>
                                        <td class="pl-year-cell percentage" data-year="2027">-</td>
                                        <td class="pl-growth-cell percentage" data-growth="2027">-</td>
                                        <td class="pl-year-cell percentage" data-year="2028">-</td>
                                        <td class="pl-growth-cell percentage" data-growth="2028">-</td>
                                        <td class="pl-year-cell percentage" data-year="2029">-</td>
                                        <td class="pl-growth-cell percentage" data-growth="2029">-</td>
                                        <td class="pl-year-cell percentage" data-year="2030">-</td>
                                        <td class="pl-growth-cell percentage" data-growth="2030">-</td>
                                        <td class="pl-cagr-cell percentage" data-cagr="gross-margin">-</td>
                                    </tr>
                                    
                                    <!-- Operating Expenses Section -->
                                    <tr class="pl-section-header">
                                        <td colspan="13"><strong>OPERATING EXPENSES</strong></td>
                                    </tr>
                                    <tr data-account="total-opex" class="pl-summary-row opex-row">
                                        <td class="pl-line-item-header">Total OPEX</td>
                                        <td class="pl-year-cell" data-year="2025">-</td>
                                        <td class="pl-year-cell" data-year="2026">-</td>
                                        <td class="pl-growth-cell" data-growth="2026">-</td>
                                        <td class="pl-year-cell" data-year="2027">-</td>
                                        <td class="pl-growth-cell" data-growth="2027">-</td>
                                        <td class="pl-year-cell" data-year="2028">-</td>
                                        <td class="pl-growth-cell" data-growth="2028">-</td>
                                        <td class="pl-year-cell" data-year="2029">-</td>
                                        <td class="pl-growth-cell" data-growth="2029">-</td>
                                        <td class="pl-year-cell" data-year="2030">-</td>
                                        <td class="pl-growth-cell" data-growth="2030">-</td>
                                        <td class="pl-cagr-cell" data-cagr="total-opex">-</td>
                                    </tr>
                                    
                                    <!-- EBITDA Section -->
                                    <tr class="pl-section-header">
                                        <td colspan="13"><strong>EBITDA</strong></td>
                                    </tr>
                                    <tr data-account="ebitda" class="pl-summary-row ebitda-row">
                                        <td class="pl-line-item-header">EBITDA</td>
                                        <td class="pl-year-cell" data-year="2025">-</td>
                                        <td class="pl-year-cell" data-year="2026">-</td>
                                        <td class="pl-growth-cell" data-growth="2026">-</td>
                                        <td class="pl-year-cell" data-year="2027">-</td>
                                        <td class="pl-growth-cell" data-growth="2027">-</td>
                                        <td class="pl-year-cell" data-year="2028">-</td>
                                        <td class="pl-growth-cell" data-growth="2028">-</td>
                                        <td class="pl-year-cell" data-year="2029">-</td>
                                        <td class="pl-growth-cell" data-growth="2029">-</td>
                                        <td class="pl-year-cell" data-year="2030">-</td>
                                        <td class="pl-growth-cell" data-growth="2030">-</td>
                                        <td class="pl-cagr-cell" data-cagr="ebitda">-</td>
                                    </tr>
                                    <tr data-account="ebitda-margin" class="pl-summary-row margin-row">
                                        <td class="pl-line-item-header">EBITDA Margin %</td>
                                        <td class="pl-year-cell percentage" data-year="2025">-</td>
                                        <td class="pl-year-cell percentage" data-year="2026">-</td>
                                        <td class="pl-growth-cell percentage" data-growth="2026">-</td>
                                        <td class="pl-year-cell percentage" data-year="2027">-</td>
                                        <td class="pl-growth-cell percentage" data-growth="2027">-</td>
                                        <td class="pl-year-cell percentage" data-year="2028">-</td>
                                        <td class="pl-growth-cell percentage" data-growth="2028">-</td>
                                        <td class="pl-year-cell percentage" data-year="2029">-</td>
                                        <td class="pl-growth-cell percentage" data-growth="2029">-</td>
                                        <td class="pl-year-cell percentage" data-year="2030">-</td>
                                        <td class="pl-growth-cell percentage" data-growth="2030">-</td>
                                        <td class="pl-cagr-cell percentage" data-cagr="ebitda-margin">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="annual-summary-insights-section" style="margin-top: 2rem;">
    
                            <!-- Enhanced Summary Cards Grid (6 cards) -->
                            <div class="breakdown-summary-row" style="grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;">
                                <div class="summary-card revenue">
                                    <div class="summary-header">
                                        <h4>6-Year CAGR</h4>
                                        <span class="summary-amount" id="annualSummaryCAGR">+0%</span>
                                    </div>
                                    <div class="summary-change positive" id="cagrDirection">Revenue Growth</div>
                                </div>
                                <div class="summary-card efficiency">
                                    <div class="summary-header">
                                        <h4>Avg Gross Margin</h4>
                                        <span class="summary-amount" id="annualSummaryGrossMargin">0%</span>
                                    </div>
                                    <div class="summary-change" id="avgGrossMarginTrend">6-Year Average</div>
                                </div>
                                <div class="summary-card opex">
                                    <div class="summary-header">
                                        <h4>Avg EBITDA Margin</h4>
                                        <span class="summary-amount" id="annualSummaryEbitdaMargin">0%</span>
                                    </div>
                                    <div class="summary-change" id="avgEbitdaMarginTrend">6-Year Average</div>
                                </div>
                            </div>
                        
                            <!-- Second Row of Summary Cards -->
                            <div class="breakdown-summary-row" style="grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;">
                                <div class="summary-card growth">
                                    <div class="summary-header">
                                        <h4>Total Growth</h4>
                                        <span class="summary-amount" id="annualSummaryTotalGrowth">+0%</span>
                                    </div>
                                    <div class="summary-change positive" id="totalGrowthDirection">2025 vs 2030</div>
                                </div>
                                <div class="summary-card efficiency">
                                    <div class="summary-header">
                                        <h4>Operating Leverage</h4>
                                        <span class="summary-amount" id="annualSummaryOpLeverage">0x</span>
                                    </div>
                                    <div class="summary-change" id="opLeverageTrend">Revenue vs OPEX</div>
                                </div>
                                <div class="summary-card profitability">
                                    <div class="summary-header">
                                        <h4>Profit Growth</h4>
                                        <span class="summary-amount" id="annualSummaryProfitGrowth">+0%</span>
                                    </div>
                                    <div class="summary-change positive" id="profitGrowthDirection">EBITDA CAGR</div>
                                </div>
                            </div>

                            <!-- Strategic Insights Panel (reusing existing structure) -->
                            <div class="ai-insights-container" id="annualSummaryInsightsContainer" style="display: block;">
                                <div class="insights-header-AIinsight">
                                    <h4><i class="fas fa-brain"></i> 6-Year Strategic Analysis & Growth Insights</h4>
                                    <div class="insights-meta">
                                        <span class="confidence-badge">Analysis: Comprehensive</span>
                                        <span class="forecast-date">Generated: Now</span>
                                    </div>
                                </div>
                                
                                <div class="insights-content">
                                    <div class="insight-card key-trends-card">
                                        <div class="insight-header">
                                            <i class="fas fa-chart-line insight-icon"></i>
                                            <h5>Growth Trajectory Analysis</h5>
                                        </div>
                                        <div class="insight-text" id="annualGrowthTrends">
                                            Analyzing 6-year growth patterns and performance trajectory...
                                        </div>
                                    </div>
                                    
                                    <div class="insight-card opportunities-card">
                                        <div class="insight-header">
                                            <i class="fas fa-lightbulb insight-icon"></i>
                                            <h5>Strategic Opportunities</h5>
                                        </div>
                                        <div class="insight-text" id="annualStrategicOpportunities">
                                            Identifying key opportunities for sustainable growth and market expansion...
                                        </div>
                                    </div>
                                    
                                    <div class="insight-card methodology-card">
                                        <div class="insight-header">
                                            <i class="fas fa-cogs insight-icon"></i>
                                            <h5>Performance Highlights</h5>
                                        </div>
                                        <div class="insight-text" id="annualPerformanceHighlights">
                                            Key performance metrics and operational efficiency improvements...
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="insights-actions">
                                    <button class="btn btn-secondary" onclick="exportAnnualSummaryToPDF()">
                                        <i class="fas fa-file-pdf"></i> Export Summary
                                    </button>
                                    <button class="btn btn-secondary" onclick="copyAnnualSummaryToClipboard()">
                                        <i class="fas fa-copy"></i> Copy Analysis
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scenario Analysis Section - Add this to your scenarios section in dashboard.html -->
            <div id="scenarios-section" class="section-content" style="display: none;">
                <!-- Scenario Header -->
                <div class="content-card" id="scenarioControlPanel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-project-diagram"></i>
                            <h3>Scenario Control Panel</h3>
                        </div>
                        <div class="scenario-actions">
                            <button class="btn btn-secondary" style="margin-right: 1rem;" onclick="loadSavedScenarios()">
                                <i class="fas fa-folder-open"></i> Load Saved
                            </button>
                            <button class="btn btn-primary" onclick="saveCurrentScenario()">
                                <i class="fas fa-save"></i> Save Scenario
                            </button>
                        </div>
                    </div>
                
                    <div class="panel-content">
                        <div class="timeframe-selector">
                            <label class="filter-label">Impact Timeframe (Years):</label>
                            <div class="year-toggle-group">
                                <button class="btn scenario-year-btn active" data-year="2026" onclick="toggleYear(2026)">
                                    <span class="year-text">2026</span>
                                    <i class="fas fa-check-circle check-icon"></i>
                                </button>
                                <button class="btn scenario-year-btn active" data-year="2027" onclick="toggleYear(2027)">
                                    <span class="year-text">2027</span>
                                    <i class="fas fa-check-circle check-icon"></i>
                                </button>
                                <button class="btn scenario-year-btn active" data-year="2028" onclick="toggleYear(2028)">
                                    <span class="year-text">2028</span>
                                    <i class="fas fa-check-circle check-icon"></i>
                                </button>
                                <button class="btn scenario-year-btn active" data-year="2029" onclick="toggleYear(2029)">
                                    <span class="year-text">2029</span>
                                    <i class="fas fa-check-circle check-icon"></i>
                                </button>
                                <button class="btn scenario-year-btn active" data-year="2030" onclick="toggleYear(2030)">
                                    <span class="year-text">2030</span>
                                    <i class="fas fa-check-circle check-icon"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="content-card">
                    <div class="card-header">
                        <h3>Quick Scenario Actions</h3>
                        <p class="card-subtitle">Apply common business scenarios instantly</p>
                    </div>
                    <div class="card-content">
                        <!-- Favorable Scenarios -->
                        <div class="filter-section">
                            <h4 class="filter-label" style="color: #059669;">Favorable Scenarios</h4>
                            <div class="filter-row" style="gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                                <button class="btn btn-outline" onclick="applyQuickScenario('revenue_boost')" style="border-color: #059669; color: #059669;">
                                    <i class="fas fa-arrow-up"></i> Revenue Boost +20%
                                </button>
                                <button class="btn btn-outline" onclick="applyQuickScenario('cost_reduction')" style="border-color: #059669; color: #059669;">
                                    <i class="fas fa-arrow-down"></i> Cost Reduction -10%
                                </button>
                                <button class="btn btn-outline" onclick="applyQuickScenario('new_product')" style="border-color: #059669; color: #059669;">
                                    <i class="fas fa-plus"></i> New Product Launch
                                </button>
                                <button class="btn btn-outline" onclick="applyQuickScenario('market_expansion')" style="border-color: #059669; color: #059669;">
                                    <i class="fas fa-expand"></i> Market Expansion
                                </button>
                            </div>
                        </div>
            
                        <!-- Unfavorable Scenarios -->
                        <div class="filter-section">
                            <h4 class="filter-label" style="color: #dc2626;">Unfavorable Scenarios</h4>
                            <div class="filter-row" style="gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn btn-outline" onclick="applyQuickScenario('price_drop')" style="border-color: #dc2626; color: #dc2626;">
                                    <i class="fas fa-arrow-down"></i> Price Drop -15%
                                </button>
                                <button class="btn btn-outline" onclick="applyQuickScenario('supply_constraints')" style="border-color: #dc2626; color: #dc2626;">
                                    <i class="fas fa-exclamation-triangle"></i> Supply Constraints +25%
                                </button>
                                <button class="btn btn-outline" onclick="applyQuickScenario('contract_lost')" style="border-color: #dc2626; color: #dc2626;">
                                    <i class="fas fa-times"></i> Key Contract Lost -30%
                                </button>
                                <button class="btn btn-outline" onclick="applyQuickScenario('economic_downturn')" style="border-color: #dc2626; color: #dc2626;">
                                    <i class="fas fa-chart-line-down"></i> Economic Downturn -20%
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="content-card">
                    <div class="card-header">
                        <h3>Custom Adjustments</h3>
                        <p class="card-subtitle">Fine-tune specific financial parameters</p>
                    </div>
                    <div class="card-content">
                        <div class="metrics-grid">
                            <!-- Revenue Adjustments -->
                            <div class="metric-card">
                                <div class="metric-header">
                                    <div class="metric-title">Revenue</div>  
                                </div>
                                <div class="metric-content">
                                    <div class="filter-section">
                                        <label class="filter-label">Growth Rate (%)</label>
                                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                                            <input type="range" id="revenueSlider" class="scenario-slider" min="-50" max="100" value="0" oninput="updateCustomScenario('revenue', this.value)" style="flex: 1;">
                                            <input type="number" id="revenueInput" class="filter-input" min="-50" max="100" value="0" oninput="updateCustomScenarioFromInput('revenue', this.value)" style="width: 80px;">
                                            <span>%</span>
                                        </div>
                                        <div class="slider-value"></div>
                                    </div>
                                </div>
                            </div>
            
                            <!-- COGS Adjustments -->
                            <div class="metric-card">
                                <div class="metric-header">
                                    <div class="metric-title">Cost of Goods Sold</div>
                                </div>
                                <div class="metric-content">
                                    <div class="filter-section">
                                        <label class="filter-label">Change (%)</label>
                                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                                            <input type="range" id="cogsSlider" class="scenario-slider" min="-50" max="100" value="0" oninput="updateCustomScenario('cogs', this.value)" style="flex: 1;">
                                            <input type="number" id="cogsInput" class="filter-input" min="-50" max="100" value="0" oninput="updateCustomScenarioFromInput('cogs', this.value)" style="width: 80px;">
                                            <span>%</span>
                                        </div>
                                        <div class="slider-value"></div>
                                    </div>
                                </div>
                            </div>
            
                            <!-- Operating Expenses -->
                            <div class="metric-card">
                                <div class="metric-header">
                                    <div class="metric-title">Operating Expenses</div>
                                </div>
                                <div class="metric-content">
                                    <div class="filter-section">
                                        <label class="filter-label">Change (%)</label>
                                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                                            <input type="range" id="opexSlider" class="scenario-slider" min="-50" max="100" value="0" oninput="updateCustomScenario('opex', this.value)" style="flex: 1;">
                                            <input type="number" id="opexInput" class="filter-input" min="-50" max="100" value="0" oninput="updateCustomScenarioFromInput('opex', this.value)" style="width: 80px;">
                                            <span>%</span>
                                        </div>
                                        <div class="slider-value"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Apply Scenario Button -->
                        <div class="filter-section" style="margin-top: 2rem; text-align: center;">
                            <button class="btn btn-primary" onclick="applyCurrentScenario()" style="font-size: 1rem; padding: 0.75rem 2rem;">
                                <i class="fas fa-check"></i> Apply Scenario to Selected Years
                            </button>
                            <p style="font-size: 0.875rem; color: #64748b; margin-top: 0.5rem;">
                                This will log your current adjustments as events and reset the sliders
                            </p>
                        </div>
                        
                        <!-- Section Divider -->
                        <hr style="margin: 2rem 0; border: 1px solid #d1d5db;">
            
                        <!-- One-time Events -->
                        <div class="filter-section" style="margin-top: 1rem;">
                            <h4 class="filter-label">One-time Events</h4>
                            <div class="filter-row" style="gap: 1rem;">
                                <div class="input-group">
                                    <label class="filter-label">Description</label>
                                    <input type="text" id="eventDescription" class="filter-input" placeholder="e.g., Equipment purchase, Legal settlement">
                                </div>
                                <div class="input-group">
                                    <label class="filter-label">P&L Line</label>
                                    <select id="eventPLLine" class="filter-input">
                                        <option value="revenue">Revenue</option>
                                        <option value="cogs">Cost of Goods Sold</option>
                                        <option value="opex">Operating Expenses</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="filter-label">Amount</label>
                                    <input type="number" id="eventAmount" class="filter-input" placeholder="0">
                                </div>
                                <div class="input-group">
                                    <label class="filter-label">Year</label>
                                    <select id="eventYear" class="filter-input">
                                        <option value="2026">2026</option>
                                        <option value="2027">2027</option>
                                        <option value="2028">2028</option>
                                        <option value="2029">2029</option>
                                        <option value="2030">2030</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="addOneTimeEvent()" style="align-self: flex-end;">
                                    <i class="fas fa-plus"></i> Add Event
                                </button>
                            </div>
                        </div>
            
                        <!-- Added Events Display -->
                        <div id="oneTimeEvents" class="filter-section" style="margin-top: 1rem; display: none;">
                            <h4 class="filter-label">Added Events</h4>
                            <div id="eventsList" class="events-list"></div>
                        </div>
            
                        <!-- Reset Button -->
                        <div class="filter-section" style="margin-top: 1rem; text-align: center;">
                            <button class="btn btn-secondary" onclick="resetAllScenarios()">
                                <i class="fas fa-undo"></i> Reset All Scenarios
                            </button>
                        </div>
                    </div>
                </div>
            
                <!-- P&L Comparison -->
                <div class="content-card">
                    <div class="card-header">
                        <h3>Financial Impact Analysis</h3>
                    </div>
                    <div class="card-content">
                        <!-- Active Scenario Indicator -->
                        <div class="filter-section" style="margin-bottom: 1rem;">
                            <div class="scenario-status">
                                <span class="filter-label">Active Scenario: </span>
                                <span id="activeScenarioName" class="metric-value">Base Case</span>
                            </div>
                        </div>
            
                        <!-- P&L Comparison Table -->
                        <div id="scenarioAnalysisWrapper">
                            <div class="table-container scenario-comparison-table-wrapper">
                                <table class="financial-table scenario-comparison-table">
                                    <thead id="scenarioComparisonHeader">
                                        </thead>
                                    <tbody id="scenarioComparisonBody">
                                        </tbody>
                                </table>
                            </div>
                        </div>
            
                        <!-- Summary Impact Cards -->
                        <div class="metrics-grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                            <div class="metric-card enhanced-card">
                                <div class="metric-header">
                                    <div class="card-main">
                                        <div class="metric-title-group">
                                            <div class="metric-title">Total Revenue Impact</div>
                                        </div>
                                        <div class="metric-primary-group">
                                            <span class="metric-value-large" id="overallRevenueImpact">+Rp 3.6B</span>
                                            <div class="metric-change positive" id="overallRevenueImpactPercent">+20.0%</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="impact-breakdown" id="revenueImpactBreakdown">
                                </div>
                            </div>
                        
                            <div class="metric-card enhanced-card">
                                <div class="metric-header">
                                    <div class="card-main">
                                        <div class="metric-title-group">
                                            <div class="metric-title">Net Income Impact</div>
                                        </div>
                                        <div class="metric-primary-group">
                                            <span class="metric-value-large" id="overallNetIncomeImpact">+Rp 3.6B</span>
                                            <div class="metric-change positive" id="overallNetIncomeImpactPercent">+117.6%</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="impact-breakdown" id="netIncomeImpactBreakdown">
                                </div>
                            </div>
                        
                            <div class="metric-card enhanced-card">
                                <div class="metric-header">
                                    <div class="card-main">
                                        <div class="metric-title-group">
                                            <div class="metric-title">Adjusted EBITDA Margin</div>
                                        </div>
                                        <div class="metric-primary-group">
                                            <span class="metric-value-large" id="overallMarginValue">30.8%</span>
                                            <div class="metric-change positive" id="overallMarginImpact">+13.8pp</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="impact-breakdown" id="marginImpactBreakdown">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Save Scenario Modal (reusing existing modal styles) -->
            <div id="saveScenarioModal" class="save-scenario-overlay">
                <div class="save-scenario-modal">
                    <div class="save-scenario-header">
                        <h3 class="save-scenario-title">Save Scenario</h3>
                        <button class="save-scenario-close" onclick="closeSaveScenarioModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="save-scenario-body">
                        <div class="save-scenario-group">
                            <label class="save-scenario-label">Scenario Name</label>
                            <input type="text" id="scenarioName" class="save-scenario-input" placeholder="e.g., Q2 Expansion Plan">
                        </div>
                        <div class="save-scenario-group">
                            <label class="save-scenario-label">Description (Optional)</label>
                            <textarea id="scenarioDescription" class="save-scenario-input save-scenario-textarea" rows="3" placeholder="Brief description of this scenario..."></textarea>
                        </div>
                    </div>
                    <div class="save-scenario-footer">
                        <button class="save-scenario-btn save-scenario-btn-secondary" onclick="closeSaveScenarioModal()">Cancel</button>
                        <button class="save-scenario-btn save-scenario-btn-primary" onclick="confirmSaveScenario()">Save Scenario</button>
                    </div>
                </div>
            </div>
            
            <!-- Industry Benchmarking Section (Main Navigation) -->
            <div id="benchmarking-section" class="section-content" style="display: none;">
                <!-- Header Section -->
                <div class="modern-section-header">
                    <div class="header-content">
                        <div class="header-right">
                            <div class="header-actions">
                                <div class="benchmark-data-info">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Last updated: <span id="lastBenchmarkUpdate">Loading...</span></span>
                                </div>
                                <button class="btn btn-secondary" onclick="refreshBenchmarkData()" id="refreshBenchmarkBtn">
                                    <i class="fas fa-sync-alt"></i>
                                    Refresh Data
                                </button>
                                <button class="btn btn-secondary" onclick="exportBenchmarkExcel()">
                                    <i class="fas fa-file-excel"></i>
                                    Export Excel
                                </button>
                                <button class="btn btn-primary" onclick="exportBenchmarkPDF()">
                                    <i class="fas fa-file-pdf"></i>
                                    Export PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            
                <!-- Time Period & Industry Selection -->
                <div class="dashboard-section">
                    <div class="metrics-grid">
                        <!-- Time Period Selector -->
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-title">Analysis Period</div>
                                <div class="metric-icon">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                            </div>
                            <div class="metric-content">
                                <select id="benchmarkPeriodSelect" class="period-selector-fixed" onchange="calculateCompanyMetrics()">
                                    <option value="MTD">Month to Date</option>
                                    <option value="QTD">Quarter to Date</option>
                                    <option value="YTD" selected>Year to Date</option>
                                    <option value="YEARLY">Full Year</option>
                                </select>
                            </div>
                        </div>
            
                        <!-- Industry Selection -->
                        <div class="metric-card benchmark-industry-card">
                            <div class="metric-header">
                                <div class="metric-title">Benchmark Industries</div>
                                <div class="metric-icon">
                                    <i class="nav-icon fas fa-code-compare"></i>
                                </div>
                            </div>
                            <div class="metric-content">
                                <div class="industry-checkbox-grid">
                                    <label class="industry-checkbox">
                                        <input type="checkbox" value="banking" onchange="updateIndustrySelection()">
                                        <span>Banking</span>
                                    </label>
                                    <label class="industry-checkbox">
                                        <input type="checkbox" value="telecommunications" onchange="updateIndustrySelection()">
                                        <span>Telecommunications</span>
                                    </label>
                                    <label class="industry-checkbox">
                                        <input type="checkbox" value="consumer_goods" onchange="updateIndustrySelection()">
                                        <span>Consumer Goods</span>
                                    </label>
                                    <label class="industry-checkbox">
                                        <input type="checkbox" value="retail" onchange="updateIndustrySelection()">
                                        <span>Retail</span>
                                    </label>
                                    <label class="industry-checkbox">
                                        <input type="checkbox" value="technology" onchange="updateIndustrySelection()">
                                        <span>Technology</span>
                                    </label>
                                    <label class="industry-checkbox">
                                        <input type="checkbox" value="healthcare" onchange="updateIndustrySelection()">
                                        <span>Healthcare</span>
                                    </label>
                                    <label class="industry-checkbox">
                                        <input type="checkbox" value="property" onchange="updateIndustrySelection()">
                                        <span>Property</span>
                                    </label>
                                </div>
                            </div>
                        </div>
            
                        <!-- Company Metrics Summary -->
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-title">Your Company Metrics</div>
                                <div class="metric-icon">
                                    <i class="fas fa-building"></i>
                                </div>
                            </div>
                            <div class="metric-content">
                                <div class="company-metrics-summary" id="companyMetricsSummary">
                                    <div class="metric-loading">Calculating metrics...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            
                <!-- Financial Ratios Gauge Charts -->
                <div class="dashboard-section" id="benchmarkGaugesSection" style="display: none;">
                    <div class="section-header">
                        <h4><i class="fas fa-tachometer-alt"></i> Performance vs Industry Benchmarks</h4>
                    </div>
                    <div class="benchmark-gauges-grid">
                        <!-- Row 1: Profitability & Returns -->
                        <div class="gauge-card" id="gauge-roe">
                            <div class="gauge-header">
                                <h5>Return on Equity</h5>
                                <span class="gauge-value" id="roe-value">-</span>
                            </div>
                            <div class="gauge-chart" id="roe-gauge"></div>
                            <div class="gauge-percentile" id="roe-percentile">-</div>
                        </div>
                        <div class="gauge-card" id="gauge-roa">
                            <div class="gauge-header">
                                <h5>Return on Assets</h5>
                                <span class="gauge-value" id="roa-value">-</span>
                            </div>
                            <div class="gauge-chart" id="roa-gauge"></div>
                            <div class="gauge-percentile" id="roa-percentile">-</div>
                        </div>
                        <div class="gauge-card" id="gauge-ebitda">
                            <div class="gauge-header">
                                <h5>EBITDA Margin</h5>
                                <span class="gauge-value" id="ebitda-value">-</span>
                            </div>
                            <div class="gauge-chart" id="ebitda-gauge"></div>
                            <div class="gauge-percentile" id="ebitda-percentile">-</div>
                        </div>
            
                        <!-- Row 2: Margins & Efficiency -->
                        <div class="gauge-card" id="gauge-net-margin">
                            <div class="gauge-header">
                                <h5>Net Profit Margin</h5>
                                <span class="gauge-value" id="net-margin-value">-</span>
                            </div>
                            <div class="gauge-chart" id="net-margin-gauge"></div>
                            <div class="gauge-percentile" id="net-margin-percentile">-</div>
                        </div>
                        <div class="gauge-card" id="gauge-gross-margin">
                            <div class="gauge-header">
                                <h5>Gross Profit Margin</h5>
                                <span class="gauge-value" id="gross-margin-value">-</span>
                            </div>
                            <div class="gauge-chart" id="gross-margin-gauge"></div>
                            <div class="gauge-percentile" id="gross-margin-percentile">-</div>
                        </div>
                        <div class="gauge-card" id="gauge-asset-turnover">
                            <div class="gauge-header">
                                <h5>Asset Turnover</h5>
                                <span class="gauge-value" id="asset-turnover-value">-</span>
                            </div>
                            <div class="gauge-chart" id="asset-turnover-gauge"></div>
                            <div class="gauge-percentile" id="asset-turnover-percentile">-</div>
                        </div>
            
                        <!-- Row 3: Financial Health & Risk -->
                        <div class="gauge-card" id="gauge-current-ratio">
                            <div class="gauge-header">
                                <h5>Current Ratio</h5>
                                <span class="gauge-value" id="current-ratio-value">-</span>
                            </div>
                            <div class="gauge-chart" id="current-ratio-gauge"></div>
                            <div class="gauge-percentile" id="current-ratio-percentile">-</div>
                        </div>
                        <div class="gauge-card" id="gauge-quick-ratio">
                            <div class="gauge-header">
                                <h5>Quick Ratio</h5>
                                <span class="gauge-value" id="quick-ratio-value">-</span>
                            </div>
                            <div class="gauge-chart" id="quick-ratio-gauge"></div>
                            <div class="gauge-percentile" id="quick-ratio-percentile">-</div>
                        </div>
                        <div class="gauge-card" id="gauge-debt-equity">
                            <div class="gauge-header">
                                <h5>Debt-to-Equity</h5>
                                <span class="gauge-value" id="debt-equity-value">-</span>
                            </div>
                            <div class="gauge-chart" id="debt-equity-gauge"></div>
                            <div class="gauge-percentile" id="debt-equity-percentile">-</div>
                        </div>
                    </div>
                </div>
            
                <!-- Detailed Comparison Table -->
                <div class="dashboard-section" id="benchmarkTableSection" style="display: none;">
                    <div class="section-header">
                        <h4><i class="fas fa-table"></i> Detailed Industry Comparison</h4>
                    </div>
                    <div class="table-container">
                        <table class="financial-table" id="benchmarkComparisonTable">
                            <thead>
                                <tr>
                                    <th>Financial Metric</th>
                                    <th>Your Company</th>
                                    <th>Percentile</th>
                                    <!-- Industry columns will be dynamically added -->
                                </tr>
                            </thead>
                            <tbody id="benchmarkTableBody">
                                <!-- Table rows will be dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            
                <!-- AI Strategic Advisor -->
                <div class="dashboard-section" id="strategicAdvisorSection" style="display: none;">
                    <div class="section-header">
                        <h4><i class="fas fa-lightbulb"></i> AI Strategic Advisor</h4>
                        <div class="section-actions">
                            <button class="btn btn-primary" onclick="generateStrategicInsights()" id="generateInsightsBtn">
                                <i class="fas fa-brain"></i>
                                Generate AI Insights
                            </button>
                        </div>
                    </div>
                    <div class="ai-advisor-container">
                        <div class="loading-state" id="advisorLoading" style="display: none;">
                            <div class="loading-spinner"></div>
                            <p>Analyzing your performance and generating strategic recommendations...</p>
                        </div>
                        <div class="ai-advisor-content" id="advisorContent">
                            <div style="text-align: center; color: #6b7280; padding: 2rem;">
                                <i class="fas fa-brain" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <p>Click "Generate AI Insights" to analyze your financial performance and get strategic recommendations.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- AI Chat Toggle -->
    <button class="chat-trigger-floating" onclick="toggleChatPanel()">
        <i class="fas fa-comments"></i>
    </button>
    
    <!-- Chat Modal Overlay -->
    <div class="chat-container-right" id="chatContainerRight">
        <div class="ai-assistant-section">
            <!-- Chat Header with Close Button -->
            <div class="chat-header">
                <div class="chat-header-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="chat-header-text">
                    <h3>AI Financial Assistant</h3>
                    <p>Your personal financial data analyst</p>
                </div>
                <div class="chat-status">
                    <div class="status-dot"></div>
                    <span>Online</span>
                </div>
                <button class="chat-close-btn" onclick="toggleChatPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
    
            <!-- Chat Messages -->
            <div class="chat-messages" id="chatMessages">
                <!-- Empty State -->
                <div class="empty-state" id="emptyState">
                    <div class="empty-state-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <h4>Start a conversation</h4>
                    <p>Ask me anything about your financial data and I'll provide insights based on your real-time information.</p>
                </div>
    
                <!-- Messages will be dynamically added here -->
            </div>
    
            <!-- Dynamic Suggestions -->
            <div class="suggestions-container" id="suggestionsContainer">
                <div class="suggestions-header">
                    <div class="suggestions-title">Quick Questions</div>
                    <button class="suggestions-toggle" id="suggestionsToggle" onclick="toggleSuggestions()">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="suggestions-grid" id="suggestionsGrid">
                    <!-- Dynamic suggestions based on current tab -->
                </div>
            </div>
    
            <!-- Chat Input -->
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea 
                        class="chat-input" 
                        id="chatInput"
                        placeholder="Ask about your financial data..."
                        rows="1"
                    ></textarea>
                    <button class="chat-send-btn" id="chatSendBtn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M22 2L11 13"/>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>

        // Initialize Supabase
        const SUPABASE_URL = 'https://brawqzylfyuotgxqmtox.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJyYXdxenlsZnl1b3RneHFtdG94Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg1MTU0NTUsImV4cCI6MjA2NDA5MTQ1NX0.P4qazlzBHk66eItqBRK-6k2ll2I1d754ke5_r_hNxos'
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        // User access levels and navigation control
        let userProfile = null;
        let scenarioState = {
            baseCase: null,
            currentScenario: null,
            affectedYears: [2026, 2027, 2028, 2029, 2030],
            adjustments: {
                revenue: 0,
                cogs: 0,
                opex: 0
            },
            oneTimeEvents: [],
            scenarioName: 'Base Case'
        };

        window.initializeScenarios = initializeScenarios;
        window.initializeScenarioAnalysis = initializeScenarioAnalysis;
        window.toggleYear = toggleYear;
        window.updateCustomScenario = updateCustomScenario;
        window.updateCustomScenarioFromInput = updateCustomScenarioFromInput;
        window.applyQuickScenario = applyQuickScenario;
        
        const ACCESS_LEVELS = {
            basic: {
                name: 'Basic',
                allowedSections: ['dashboard', 'ap-ar'],
                features: ['Dashboard Overview', 'AP/AR Tracking']
            },
            pro: {
                name: 'Pro',
                allowedSections: ['dashboard', 'ap-ar', 'statements', 'reports'],
                features: ['Everything in Basic', 'Financial Statements', 'Reports & Analytics']
            },
            enterprise: {
                name: 'Enterprise',
                allowedSections: ['dashboard', 'ap-ar', 'statements', 'reports', 'budgets', 'forecasting', 'scenarios', 'benchmarking'],
                features: ['Everything in Pro', 'Forecasting', 'Scenario Analysis', 'Industry Benchmarking']
            }
        };
        
        // Load user profile and access level
        async function loadUserProfile() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return null;
        
                console.log('Loading profile for user:', user.id);
        
                // Try to get existing profile first
                let { data, error } = await supabase
                    .from('user_profiles_meridash')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();
        
                if (error) {
                    console.error('Error loading user profile:', error);
                    
                    // If we get any error, just use a fallback profile
                    // The trigger should have created the profile already
                    data = {
                        user_id: user.id,
                        email: user.email,
                        access_level: 'basic',
                        is_active: true,
                        subscription_status: 'trial'
                    };
                    
                    console.log('Using fallback profile');
                } else {
                    console.log('Successfully loaded profile:', data);
                }
        
                userProfile = data;
                updateNavigationAccess();
                return data;
                
            } catch (error) {
                console.error('Error in loadUserProfile:', error);
                
                // Fallback profile for any errors
                const fallbackProfile = {
                    user_id: 'unknown',
                    email: 'unknown@email.com',
                    access_level: 'basic',
                    is_active: true,
                    subscription_status: 'trial'
                };
                userProfile = fallbackProfile;
                updateNavigationAccess();
                return fallbackProfile;
            }
        }
        
        // Update navigation based on access level
        function updateNavigationAccess() {
            if (!userProfile) return;
            
            const allowedSections = ACCESS_LEVELS[userProfile.access_level].allowedSections;
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                const link = item.querySelector('.nav-link');
                const section = link.getAttribute('data-section');
                
                if (!allowedSections.includes(section)) {
                    // Disable restricted sections
                    item.style.opacity = '0.5';
                    item.style.pointerEvents = 'none';
                    link.style.cursor = 'not-allowed';
                    
                    // Add upgrade tooltip
                    const upgradeTooltip = document.createElement('div');
                    upgradeTooltip.innerHTML = ' Upgrade to Pro';
                    upgradeTooltip.style.cssText = `
                        position: absolute;
                        background: #1e293b;
                        color: white;
                        padding: 0.5rem;
                        border-radius: 4px;
                        font-size: 0.75rem;
                        pointer-events: none;
                        opacity: 0;
                        transition: opacity 0.2s;
                        z-index: 1000;
                        top: 0;
                        left: 100%;
                        margin-left: 0.5rem;
                        white-space: nowrap;
                    `;
                    
                    item.style.position = 'relative';
                    item.appendChild(upgradeTooltip);
                    
                    item.addEventListener('mouseenter', () => {
                        upgradeTooltip.style.opacity = '1';
                    });
                    
                    item.addEventListener('mouseleave', () => {
                        upgradeTooltip.style.opacity = '0';
                    });
                    
                    // Show upgrade modal on click
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        showUpgradeModal();
                    });
                }
            });
            
            // Update user info in header
            updateUserInfo();

            const altmanProOverlay = document.getElementById('altmanProOverlay');
            if (altmanProOverlay) {
                if (userProfile.access_level === 'basic') {
                    altmanProOverlay.style.display = 'flex';
                } else {
                    altmanProOverlay.style.display = 'none';
                }
            }
        }
        
        // Show upgrade modal
        function showUpgradeModal() {
            const modalHTML = `
                <div id="upgradeModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%;">
                        <h2 style="color: #1e293b; margin-bottom: 1rem;">Upgrade to Pro</h2>
                        <p style="color: #6b7280; margin-bottom: 1.5rem;">Unlock advanced financial analysis tools and reporting features.</p>
                        
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h3 style="color: #1e293b; margin-bottom: 0.5rem;">Pro Features:</h3>
                            <ul style="color: #374151; margin: 0; padding-left: 1.5rem;">
                                <li>Financial Statements Generation</li>
                                <li>Advanced Reports & Analytics</li>
                                <li>Credit Analysis Tools</li>
                                <li>Export & PDF Reports</li>
                            </ul>
                        </div>
                        
                        <div style="display: flex; gap: 1rem;">
                            <button onclick="closeUpgradeModal()" style="flex: 1; background: #e5e7eb; color: #374151; padding: 0.75rem; border: none; border-radius: 6px; cursor: pointer;">Maybe Later</button>
                            <button onclick="upgradeAccount()" style="flex: 1; background: #fbbf24; color: #1e293b; padding: 0.75rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">Upgrade Now</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function closeUpgradeModal() {
            const modal = document.getElementById('upgradeModal');
            if (modal) modal.remove();
        }
        
        async function upgradeAccount() {
            try {
                // For now, just upgrade to Pro automatically
                // In production, you'd integrate with payment processing
                const { data, error } = await supabase
                    .from('user_profiles_meridash')
                    .update({ access_level: 'pro', updated_at: new Date().toISOString() })
                    .eq('user_id', userProfile.user_id);
        
                if (error) throw error;
        
                // Refresh profile and navigation
                await loadUserProfile();
                closeUpgradeModal();
                
                // Show success message
                const successDiv = document.createElement('div');
                successDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #10b981;
                    color: white;
                    padding: 1rem;
                    border-radius: 8px;
                    z-index: 1000;
                `;
                successDiv.textContent = ' Upgraded to Pro! All features unlocked.';
                document.body.appendChild(successDiv);
                
                setTimeout(() => successDiv.remove(), 3000);
                
            } catch (error) {
                alert('Upgrade failed: ' + error.message);
            }
        }
        
        // Update user info in header
        function updateUserInfo() {
            const topBarRight = document.querySelector('.top-bar-right');
            
            // Remove existing user info
            const existingUserInfo = document.getElementById('userInfo');
            if (existingUserInfo) existingUserInfo.remove();
            
            if (userProfile) {
                const userInfoHTML = `
                    <div id="userInfo" style="display: flex; align-items: center; gap: 1rem;">
                        <!-- Single line: Email + Plan + Upgrade -->
                        <div style="
                            display: flex; 
                            align-items: center; 
                            gap: 0.75rem; 
                            padding: 0.5rem 0.75rem; 
                            background: #f8fafc; 
                            border-radius: 8px; 
                            border: 1px solid #e2e8f0;
                        ">
                            <!-- Email -->
                            <span style="font-size: 0.875rem; font-weight: 600; color: #1e293b;">
                                ${userProfile.email}
                            </span>
                            
                            <!-- Plan Badge -->
                            <span style="
                                padding: 0.25rem 0.5rem; 
                                background: ${userProfile.access_level === 'basic' ? '#f3f4f6' : '#d1fae5'}; 
                                color: ${userProfile.access_level === 'basic' ? '#6b7280' : '#065f46'}; 
                                border-radius: 4px; 
                                font-size: 0.75rem; 
                                font-weight: 500;
                                border: 1px solid ${userProfile.access_level === 'basic' ? '#d1d5db' : '#10b981'};
                            ">
                                ${ACCESS_LEVELS[userProfile.access_level].name}
                            </span>
                            
                            <!-- Upgrade Button (only for basic users) -->
                            ${userProfile.access_level === 'basic' ? `
                                <button onclick="showUpgradeModal()" style="
                                    background: #fbbf24; 
                                    color: #1e293b; 
                                    border: 1px; 
                                    padding: 0.25rem 0.5rem; 
                                    border-radius: 4px; 
                                    font-size: 0.75rem; 
                                    font-weight: 600; 
                                    cursor: pointer;
                                    transition: all 0.2s ease;
                                " onmouseover="this.style.background='#f59e0b'" onmouseout="this.style.background='#fbbf24'">
                                    Upgrade to Pro
                                </button>
                            ` : ''}
                        </div>
                        
                        <!-- Logout Button - Normal height -->
                        <button onclick="handleLogout()" style="
                            background: #ef4444; 
                            color: white; 
                            border: none; 
                            padding: 0.5rem 0.75rem; 
                            border-radius: 8px; 
                            cursor: pointer; 
                            font-size: 0.875rem;
                            font-weight: 500;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                            Logout
                        </button>
                    </div>
                `;
                
                topBarRight.insertAdjacentHTML('afterbegin', userInfoHTML);
            }
        }
        
        // Logout function
        async function handleLogout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                // Clear user data
                userProfile = null;
                financialTransactions = [];
                aparTransactions = [];
                
                // Show login form
                showLoginForm();
                
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        // Updated initialization with profile loading
        async function initializeApp() {
            try {
                // First remove any existing login modal
                const existingModal = document.getElementById('loginModal');
                if (existingModal) {
                    existingModal.remove();
                    // Restore both body and html scrolling
                    document.body.style.overflow = '';
                    document.documentElement.style.overflow = '';
                }
                
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error || !user) {
                    // No user logged in, show login form
                    showLoginForm();
                    return;
                }
                
                // User is logged in, load their profile and data
                console.log('User logged in:', user.email);

                await loadUserProfile();
                await loadFinancialTransactions();
                await loadAPARData();
                await loadGLAccounts();
                
                // Initialize enhanced dashboard with risk alerts and all components
                console.log('Initializing enhanced dashboard...');
                await initializeDashboardData();
                
            } catch (error) {
                console.error('Auth check failed:', error);
                showLoginForm();
            }
        }
        
        async function showLoginForm() {
            // Store original body overflow and hide scrolling completely
            document.documentElement.style.overflow = 'hidden';
            document.body.style.overflow = 'hidden';
            
            const landingHTML = `
                <div id="loginModal" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); z-index: 9999; overflow-y: auto; overflow-x: hidden; transform: scale(1.111); transform-origin: top left;">
                    
                    <!-- Header -->
                    <header style="position: sticky; top: 0; left: 0; right: 0; z-index: 10; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-bottom: 1px solid #334155;">
                        <div style="max-width: 1200px; margin: 0 auto; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center;">
                            <!-- Logo - Top Left -->
                            <div style="display: flex; align-items: center;">
                                <div class="logo" style="font-size: 1.5rem; color: #fbbf24; margin: 0;">MontPro Financier</div>
                            </div>
                            
                            <!-- Sign In Button - Top Right -->
                            <button onclick="signInWithGoogle()" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #1e293b; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3); display: flex; align-items: center; gap: 0.5rem;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(251, 191, 36, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(251, 191, 36, 0.3)'">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                Sign In with Google
                            </button>
                        </div>
                    </header>
        
                    <!-- Main Content -->
                    <main style="min-height: 100vh; display: flex; flex-direction: column;">
                        
                        <!-- Hero Section -->
                        <section style="flex: 1; display: flex; align-items: center; padding: 4rem 2rem 2rem;">
                            <div style="max-width: 800px; margin: 0 auto; text-align: center;">
                                
                                <!-- Badge -->
                                <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; font-weight: 600; display: inline-block; margin-bottom: 2rem;">
                                    Financial Intelligence Hub
                                </div>
                                
                                <!-- Main Headline -->
                                <h1 style="font-size: 4rem; font-weight: 800; color: #1e293b; line-height: 1.1; margin-bottom: 2rem;">
                                    MontPro Financier.<br>
                                    <span style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">The Virtual CFO.</span>
                                </h1>
                                
                                <!-- Subheading -->
                                <p style="font-size: 1.5rem; color: #64748b; margin-bottom: 3rem; line-height: 1.6; max-width: 600px; margin-left: auto; margin-right: auto;">
                                    Turning financial data into strategic decisions and unlocking growth capital.
                                </p>
                                
                                <!-- CTA Buttons -->
                                <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 4rem;">
                                    <button onclick="signInWithGoogle()" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #1e293b; border: none; padding: 1.25rem 2.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3); font-size: 1.125rem;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(251, 191, 36, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(251, 191, 36, 0.3)'">
                                        <i class="fas fa-rocket" style="margin-right: 0.5rem;"></i>
                                        Start Free Trial
                                    </button>
                                    <button onclick="document.getElementById('features').scrollIntoView({behavior: 'smooth'})" style="background: white; color: #64748b; border: 2px solid #e2e8f0; padding: 1.25rem 2.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 1.125rem;" onmouseover="this.style.borderColor='#fbbf24'; this.style.color='#1e293b'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.color='#64748b'">
                                        View Features
                                    </button>
                                </div>
                                
                                <!-- Trust Indicators -->
                                <div style="display: flex; align-items: center; justify-content: center; gap: 3rem; color: #64748b; font-size: 0.875rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fas fa-clock" style="color: #10b981;"></i>
                                        5-minute setup
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fas fa-users" style="color: #10b981;"></i>
                                        Trusted by CFOs
                                    </div>
                                </div>
                            </div>
                        </section>
        
                        <!-- Features Section -->
                        <section id="features" style="background: white; padding: 4rem 2rem; border-top: 1px solid #e2e8f0;">
                            <div style="max-width: 1200px; margin: 0 auto;">
                                <div style="text-align: center; margin-bottom: 3rem;">
                                    <h2 style="font-size: 2.5rem; font-weight: 700; color: #1e293b; margin-bottom: 1rem;">Real-Time Financial Clarity at Your Fingertips</h2>
                                    <p style="font-size: 1.125rem; color: #64748b; max-width: 600px; margin-bottom: 1rem; margin: 0 auto;">MontPro Financier is an integrated, AI-driven Financial Command Center. It connects to business datasets and transforms it into a real-time dashboard and advisor.</p>
                                    <p style="font-size: 1.3rem; font-weight: 500; color: #fbbf24; max-width: 600px; margin: 0 auto;">Just like having a seasoned CFO in your team!</p>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                                    
                                    <!-- Feature 1 -->
                                    <div style="background: #f8fafc; padding: 2rem; border-radius: 12px; border: 1px solid #e2e8f0; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 10px 25px rgba(0, 0, 0, 0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                        <div style="width: 3rem; height: 3rem; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem;">
                                            <i class="fas fa-chart-line" style="color: #1e293b; font-size: 1.25rem;"></i>
                                        </div>
                                        <h3 style="font-size: 1.25rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem;">All-in-One Dashboard</h3>
                                        <p style="color: #64748b; line-height: 1.6;">Get instant visibility into your financial performance with customizable dashboards and automated reporting.</p>
                                    </div>
                                    
                                    <!-- Feature 2 -->
                                    <div style="background: #f8fafc; padding: 2rem; border-radius: 12px; border: 1px solid #e2e8f0; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 10px 25px rgba(0, 0, 0, 0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                        <div style="width: 3rem; height: 3rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem;">
                                            <i class="fas fa-brain" style="color: white; font-size: 1.25rem;"></i>
                                        </div>
                                        <h3 style="font-size: 1.25rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem;">AI-Powered Insights</h3>
                                        <p style="color: #64748b; line-height: 1.6;">Leverage artificial intelligence for forecasting, anomaly detection, and strategic financial recommendations.</p>
                                    </div>
                                    
                                    <!-- Feature 3 -->
                                    <div style="background: #f8fafc; padding: 2rem; border-radius: 12px; border: 1px solid #e2e8f0; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 10px 25px rgba(0, 0, 0, 0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                        <div style="width: 3rem; height: 3rem; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem;">
                                            <i class="fas fa-file-invoice-dollar" style="color: white; font-size: 1.25rem;"></i>
                                        </div>
                                        <h3 style="font-size: 1.25rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem;">Complete Financial Suite</h3>
                                        <p style="color: #64748b; line-height: 1.6;">Manage AP/AR, generate financial statements, track budgets, and analyze performance all in one platform.</p>
                                    </div>
                                </div>
                            </div>
                        </section>
        
                        <!-- Social Proof Section -->
                        <section style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 3rem 2rem; color: white;">
                            <div style="max-width: 800px; margin: 0 auto; text-align: center;">
                                <div style="display: flex; justify-content: center; align-items: center; gap: 3rem; margin-bottom: 2rem;">
                                    <div>
                                        <div style="font-size: 2rem; font-weight: 700; color: #fbbf24;">15+</div>
                                        <div style="font-size: 0.875rem; color: #94a3b8;">Years Finance Leadership</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 2rem; font-weight: 700; color: #fbbf24;">5min</div>
                                        <div style="font-size: 0.875rem; color: #94a3b8;">Average Setup Time</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 2rem; font-weight: 700; color: #fbbf24;">24/7</div>
                                        <div style="font-size: 0.875rem; color: #94a3b8;">Real-time Updates</div>
                                    </div>
                                </div>
                                
                                <blockquote style="font-size: 1.125rem; font-style: italic; margin-bottom: 1rem; color: #e2e8f0;">
                                    "Built From a CFO's Real World Experience."
                                </blockquote>
                                <div style="font-size: 0.875rem; color: #94a3b8;"> Ardhi A. Pradhana, Founder & CEO</div>
                            </div>
                        </section>
        
                        <!-- CTA Section -->
                        <section style="background: #f8fafc; padding: 4rem 2rem; text-align: center;">
                            <div style="max-width: 600px; margin: 0 auto;">
                                <h2 style="font-size: 2.5rem; font-weight: 700; color: #1e293b; margin-bottom: 1rem;">Ready to transform your financial future?</h2>
                                <p style="font-size: 1.125rem; color: #64748b; margin-bottom: 2rem;">Join forward-thinking businesses using MontPro to gain financial clarity and control.</p>
                                
                                <button onclick="signInWithGoogle()" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #1e293b; border: none; padding: 1rem 2rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3); font-size: 1.125rem;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(251, 191, 36, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(251, 191, 36, 0.3)'">
                                    <i class="fas fa-rocket" style="margin-right: 0.5rem;"></i>
                                    Start Your Free Trial
                                </button>
                                
                                <p style="font-size: 0.875rem; color: #94a3b8; margin-top: 1rem;">No credit card required  14-day free trial  Full access</p>
                            </div>
                        </section>
                    </main>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', landingHTML);
        }
        
        async function signInWithGoogle() {
            try {
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: 'https://financier.montpro.xyz/dashboard.html'
                    }
                });
                
                if (error) throw error;
                
            } catch (error) {
                console.error('Google sign-in error:', error);
                alert('Sign-in failed: ' + error.message);
            }
        }
        
        initializeApp();

        // Listen for auth state changes
        supabase.auth.onAuthStateChange((event, session) => {
            console.log('Auth state changed:', event, session);
            
            if (event === 'SIGNED_IN') {
                // Remove login modal and initialize app
                const existingModal = document.getElementById('loginModal');
                if (existingModal) {
                    existingModal.remove();
                }
                initializeApp();
            } else if (event === 'SIGNED_OUT') {
                showLoginForm();
            }
        });
        
        // AP/AR Data Management
        let aparTransactions = [];
        let scenarioFinancingItems = [];
        let scenarioCashImpact = 0;
        let scenarioImpactChartInstance = null;

        // ====== DYNAMIC DATE MANAGEMENT SYSTEM ======
        function getDateContext() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1; // 1-12
            const currentDay = now.getDate();
            
            // Rule: Only COMPLETED months are actuals
            // Since we're in August, only Jan-July are completed (actuals)
            const actualEndMonth = currentMonth - 1; // Previous month is the last completed month
            const forecastStartMonth = currentMonth; // Current month starts forecast
            
            // Generate dynamic years (current + 5 years ahead)
            const years = {
                current: currentYear,
                next: currentYear + 1,
                forecast: Array.from({length: 4}, (_, i) => currentYear + 2 + i) // Y+2 to Y+5
            };
            
            return {
                currentYear,
                currentMonth,
                currentDay,
                actualEndMonth,
                forecastStartMonth,
                years,
                monthNames: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
            };
        }

        // Generate dynamic table headers
        function generateDynamicHeaders() {
            const dateContext = getDateContext();
            const { currentYear, actualEndMonth, monthNames } = dateContext;
            
            let headersHTML = '';
            
            // Generate 12 months with proper actual/forecast classification
            for (let month = 1; month <= 12; month++) {
                const monthName = monthNames[month - 1];
                const isActual = month <= actualEndMonth;
                const headerClass = isActual ? 'pl-actual-header' : 'pl-forecast-header';
                
                headersHTML += `<th class="pl-month-header ${headerClass}">${monthName} ${currentYear}</th>`;
            }
            
            // Add total column
            headersHTML += `<th class="pl-total-header">${currentYear} Total</th>`;
            
            return headersHTML;
        }
        
        // Update headers when page loads
        function updateTableHeaders() {
            const headerElement = document.getElementById('dynamic-month-headers');
            if (headerElement) {
                headerElement.outerHTML = generateDynamicHeaders();
            }
        }
        
        function initializeCashFlowScenario() {
            console.log(" Initializing Cash Flow Scenario module...");
            // Load AP/AR data into the buckets
            loadScenarioTransactions();
            // Set up the drag-and-drop functionality
            setupBucketDragAndDrop();
            // Create the cash flow chart
            updateScenarioImpactChart();
            // Update the impact and change log sections
            updateImpactAnalysis();
            updateChangeLogDisplay();
        }

        // Add this function globally (outside any other function)
        function assignOverdueToRealisticWeek(transaction, dueDate) {
            if (!dueDate) return 'parked'; // No due date - still use parked
            
            const today = new Date();
            const transactionDueDate = new Date(dueDate);
            
            // If transaction is not overdue, calculate which week it falls in
            if (transactionDueDate >= today) {
                const diffTime = transactionDueDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const week = Math.ceil(diffDays / 7);
                
                // If it falls within 13 weeks, use that week
                if (week <= 13) {
                    return week;
                } else {
                    // Too far in future, place in week 13
                    return 13;
                }
            }
            
            // For overdue transactions, use realistic collection/payment assumptions
            const weeksOverdue = Math.floor((today - transactionDueDate) / (7 * 24 * 60 * 60 * 1000));
            
            if (transaction.type === 'AR') {
                // Overdue AR: Spread across weeks 1-4 based on how overdue
                if (weeksOverdue <= 2) return 1;      // Recently overdue
                else if (weeksOverdue <= 4) return 2; // Moderately overdue  
                else if (weeksOverdue <= 8) return 3; // Quite overdue
                else return 4;                        // Very overdue
            } else if (transaction.type === 'AP') {
                // Overdue AP: Spread across weeks 1-2 (we need to pay sooner)
                if (weeksOverdue <= 4) return 1;      // Pay soon
                else return 2;                        // Pay very soon
            }
            
            // Default fallback for edge cases
            return 1;
        }

        // AP/AR to GL Linking Functions - GLOBAL SCOPE
        function linkAPARToGL(aparId) {
            console.log('linkAPARToGL called with ID:', aparId);
            
            // Find the transaction
            const aparTransaction = aparTransactions.find(t => t.id === aparId);
            if (!aparTransaction) {
                alert('Transaction not found');
                return;
            }
            
            // Open the NEW account selection modal instead of old linking modal
            openGLAccountSelectionModal(aparId);
        }

        // NEW: Open GL Account Selection Modal
        function openGLAccountSelectionModal(aparId) {
            const aparTransaction = aparTransactions.find(t => t.id === aparId);
            if (!aparTransaction) return;
            
            // Show the modal
            const modal = document.getElementById('glAccountSelectionModal');
            modal.classList.add('active');
            modal.style.visibility = 'visible';
            modal.style.opacity = '1';
            
            // Populate the selected AP/AR transaction
            populateSelectedAPARForGL(aparTransaction);
            
            // Setup account selection based on transaction type
            setupAccountSelection(aparTransaction);
            
            // Store the current AP/AR ID for later use
            window.currentAPARId = aparId;
        }
        
        // NEW: Close GL Account Selection Modal
        function closeGLAccountSelectionModal() {
            const modal = document.getElementById('glAccountSelectionModal');
            modal.classList.remove('active');
            modal.style.visibility = 'hidden';
            modal.style.opacity = '0';
            
            // Clear stored ID
            window.currentAPARId = null;
        }
        
        // NEW: Populate selected AP/AR transaction display
        function populateSelectedAPARForGL(transaction) {
            const container = document.getElementById('selectedAPARForGL');
            container.innerHTML = `
                <div class="linking-item selected">
                    <div class="linking-item-header">
                        <strong>${transaction.type} - ${transaction.company}</strong>
                        <span class="amount">${formatCurrencyFull(transaction.amount, transaction.currency || 'IDR')}</span>
                    </div>
                    <div class="linking-item-details">
                        ${transaction.description} | ${formatDateIndonesian(transaction.invoice_date)}
                    </div>
                </div>
            `;
        }

        // NEW: Setup account selection based on transaction type
        function setupAccountSelection(transaction) {
            const titleElement = document.getElementById('balancingAccountTitle');
            const helpElement = document.getElementById('balancingAccountHelp');
            const quickSelectContainer = document.getElementById('quickSelectAccounts');
            const manualSelect = document.getElementById('manualAccountSelect');
            
            // Clear previous content
            quickSelectContainer.innerHTML = '';
            manualSelect.innerHTML = '<option value="">Choose an account...</option>';
            
            if (transaction.type === 'AR') {
                // For Accounts Receivable - need Revenue account to balance
                titleElement.textContent = 'Select Revenue Account';
                helpElement.textContent = 'This AR transaction will create: Debit Accounts Receivable + Credit Revenue Account';
                
                // Quick select revenue accounts
                const revenueAccounts = [
                    { code: '4010', name: 'Sales Revenue' },
                    { code: '4020', name: 'Service Revenue' },
                    { code: '4030', name: 'Interest Income' },
                    { code: '4040', name: 'Other Revenue' }
                ];
                
                quickSelectContainer.innerHTML = revenueAccounts.map(account => `
                    <button class="btn btn-sm btn-outline-primary quick-select-btn" 
                            onclick="selectQuickAccount('${account.code}', '${account.name}')"
                            style="margin: 0.25rem;">
                        ${account.code} - ${account.name}
                    </button>
                `).join('');
                
                // Populate manual select with all revenue accounts (4xxx)
                populateManualSelect(['4010', '4020', '4030', '4040', '4050']);
                
            } else if (transaction.type === 'AP') {
                // For Accounts Payable - need Expense account to balance  
                titleElement.textContent = 'Select Expense Account';
                helpElement.textContent = 'This AP transaction will create: Debit Expense Account + Credit Accounts Payable';
                
                // Quick select expense accounts
                const expenseAccounts = [
                    { code: '5100', name: 'Office Expenses' },
                    { code: '5200', name: 'Marketing Expenses' },
                    { code: '5400', name: 'Professional Services' },
                    { code: '5500', name: 'Office Supplies' },
                    { code: '5800', name: 'Travel and Entertainment' }
                ];
                
                quickSelectContainer.innerHTML = expenseAccounts.map(account => `
                    <button class="btn btn-sm btn-outline-primary quick-select-btn" 
                            onclick="selectQuickAccount('${account.code}', '${account.name}')"
                            style="margin: 0.25rem;">
                        ${account.code} - ${account.name}
                    </button>
                `).join('');
                
                // Populate manual select with all expense accounts (5xxx)
                populateManualSelect(['5100', '5110', '5120', '5200', '5210', '5220', '5300', '5400', '5500', '5600', '5700', '5800', '5900']);
            }
        }
        
        // NEW: Populate manual account dropdown
        function populateManualSelect(accountCodes) {
            const manualSelect = document.getElementById('manualAccountSelect');
            
            // Add accounts that exist in our GL accounts list
            accountCodes.forEach(code => {
                const account = glAccounts.find(acc => acc.account_code === code);
                if (account) {
                    const option = document.createElement('option');
                    option.value = account.account_code;
                    option.textContent = `${account.account_code} - ${account.account_name}`;
                    manualSelect.appendChild(option);
                }
            });
        }
        
        // NEW: Handle quick select button clicks
        function selectQuickAccount(accountCode, accountName) {
            // Remove active class from all quick select buttons
            document.querySelectorAll('.quick-select-btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
            });
            
            // Add active class to clicked button
            event.target.classList.remove('btn-outline-primary');
            event.target.classList.add('btn-primary');
            
            // Set the manual select to match
            document.getElementById('manualAccountSelect').value = accountCode;
            
            // Store selected account for later use
            window.selectedBalancingAccount = { code: accountCode, name: accountName };
            
            console.log('Selected balancing account:', accountCode, accountName);
        }
        
        // NEW: Handle manual dropdown selection
        document.addEventListener('DOMContentLoaded', function() {
            const manualSelect = document.getElementById('manualAccountSelect');
            if (manualSelect) {
                manualSelect.addEventListener('change', function() {
                    if (this.value) {
                        const account = glAccounts.find(acc => acc.account_code === this.value);
                        if (account) {
                            // Clear quick select buttons
                            document.querySelectorAll('.quick-select-btn').forEach(btn => {
                                btn.classList.remove('btn-primary');
                                btn.classList.add('btn-outline-primary');
                            });
                            
                            // Store selected account
                            window.selectedBalancingAccount = { 
                                code: account.account_code, 
                                name: account.account_name 
                            };
                            
                            console.log('Manual selected balancing account:', account.account_code, account.account_name);
                        }
                    }
                });
            }
        });

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Dashboard initializing...');
            
            // Initialize date display
            initializeDateDisplay();

            updateTableHeaders();
            
            // Initialize connection status
            updateConnectionStatus();
            
            // Start connection monitoring
            startConnectionMonitoring();
            
            // Initialize period selector for revenue
            const periodSelector = document.getElementById('dashboardPeriodFilter');
            if (periodSelector) {
                periodSelector.addEventListener('change', function() {
                    const customRange = document.getElementById('customRevenueDateRange');
                    if (customRange) {
                        customRange.style.display = this.value === 'custom' ? 'block' : 'none';
                    }
                    initializeDashboardData();
                });
            }
            
            // Initialize custom date range inputs
            const dateFromInput = document.getElementById('revenueDateFrom');
            const dateToInput = document.getElementById('revenueDateTo');
            if (dateFromInput && dateToInput) {
                dateFromInput.addEventListener('change', updateDashboardWithRealData);
                dateToInput.addEventListener('change', updateDashboardWithRealData);
            }
            
            // Initialize financial period filter for GL transactions
            checkPeriodFilter();
            
            // Initialize currency formatting for inputs
            const startingCashInput = document.getElementById('startingCash');
            if (startingCashInput) {
                startingCashInput.addEventListener('input', formatCurrencyInput);
                startingCashInput.addEventListener('blur', async function() {
                    const amount = getStartingCash();
                    await saveStartingCash(amount);
                    refreshForecast();
                });
            }
            
            try {
                // Load all data from database using correct function names
                console.log('Loading AP/AR transactions...');
                await loadAPARData(); // Correct function name
                
                console.log('Loading financial transactions...');
                await loadFinancialTransactions();
                
                console.log('Loading GL accounts...');
                await loadGLAccounts();
                
                // Initialize cash flow forecast
                console.log('Initializing cash flow forecast...');
                await initializeCashFlowForecast();
                
                // Populate account dropdowns
                populateAccountDropdowns();
                populateAccountFilters();
                
                // Update dashboard with loaded data
                console.log('Updating dashboard with real data...');
                initializeDashboardData();
                
                // Initialize AP/AR summary
                updateAPARSummary();
                
                // Render initial tables
                renderAPARTable();
                renderFinancialTable();
                updateTrialBalance();
                
                console.log('Dashboard initialization complete!');
                
            } catch (error) {
                console.error('Error during dashboard initialization:', error);
                
                // Handle authentication errors specifically
                if (error.message?.includes('JWT') || error.code === 'PGRST116') {
                    console.log('Authentication required - RLS blocking access');
                    
                    // Show authentication error message
                    const authErrorDiv = document.createElement('div');
                    authErrorDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #fef3c7;
                        color: #92400e;
                        padding: 1rem;
                        border-radius: 8px;
                        border: 1px solid #fde68a;
                        z-index: 1000;
                        max-width: 350px;
                    `;
                    authErrorDiv.innerHTML = `
                        <strong>Authentication Required</strong><br>
                        Please log in to access your financial data.<br>
                        <small>Row Level Security is protecting your data.</small>
                    `;
                    document.body.appendChild(authErrorDiv);
                    
                    // Auto-remove after 15 seconds
                    setTimeout(() => {
                        if (authErrorDiv.parentNode) {
                            authErrorDiv.parentNode.removeChild(authErrorDiv);
                        }
                    }, 15000);
                    
                    // You can add login redirect here later
                    // window.location.href = 'login.html';
                    
                } else {
                    // Show general error message
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #fee2e2;
                        color: #991b1b;
                        padding: 1rem;
                        border-radius: 8px;
                        border: 1px solid #fecaca;
                        z-index: 1000;
                        max-width: 300px;
                    `;
                    errorDiv.innerHTML = `
                        <strong>Initialization Error</strong><br>
                        Some features may not work properly.<br>
                        <small>${error.message}</small>
                    `;
                    document.body.appendChild(errorDiv);
                    
                    // Auto-remove error message after 10 seconds
                    setTimeout(() => {
                        if (errorDiv.parentNode) {
                            errorDiv.parentNode.removeChild(errorDiv);
                        }
                    }, 10000);
                }
            }
            
            setTimeout(() => {
                console.log('=== DEBUGGING REVENUE AFTER LOAD ===');
                console.log('Financial transactions loaded:', financialTransactions?.length || 0);
                if (financialTransactions && financialTransactions.length > 0) {
                    console.log('Sample transaction:', financialTransactions[0]);
                    console.log('All categories:', [...new Set(financialTransactions.map(t => t.category))]);
                    console.log('All account names:', [...new Set(financialTransactions.map(t => t.account_name))]);
                }
                initializeDashboardData();
            }, 2000);
        });

        // NEW: Confirm and create GL entries
        async function confirmGLCreation() {
            // Validate selection
            if (!window.selectedBalancingAccount) {
                alert('Please select a balancing account first.');
                return;
            }
            
            if (!window.currentAPARId) {
                alert('No AP/AR transaction selected.');
                return;
            }
            
            const aparTransaction = aparTransactions.find(t => t.id === window.currentAPARId);
            if (!aparTransaction) {
                alert('AP/AR transaction not found.');
                return;
            }
            
            try {
                // Disable button to prevent double-clicking
                const createButton = document.getElementById('createGLButton');
                createButton.disabled = true;
                createButton.textContent = 'Creating...';
                
                console.log('Creating GL entries for:', aparTransaction.type, aparTransaction.company);
                
                // Create the two GL transactions based on transaction type
                let glTransaction1, glTransaction2;
                
                if (aparTransaction.type === 'AR') {
                    // AR: Debit Accounts Receivable + Credit Revenue
                    glTransaction1 = {
                        transaction_date: aparTransaction.invoice_date,
                        account_code: '1100', // Accounts Receivable
                        account_name: 'Accounts Receivable',
                        description: `AR: ${aparTransaction.company} - ${aparTransaction.description}`,
                        debit_amount: aparTransaction.amount,
                        credit_amount: 0,
                        reference: aparTransaction.reference || '',
                        notes: `Linked to AP/AR transaction: ${aparTransaction.id}`,
                        category: 'Asset',
                        source: 'linked_from_apar',
                        ap_ar_transaction_id: aparTransaction.id,
                        is_linked: true
                    };
                    
                    glTransaction2 = {
                        transaction_date: aparTransaction.invoice_date,
                        account_code: window.selectedBalancingAccount.code,
                        account_name: window.selectedBalancingAccount.name,
                        description: `Revenue: ${aparTransaction.company} - ${aparTransaction.description}`,
                        debit_amount: 0,
                        credit_amount: aparTransaction.amount,
                        reference: aparTransaction.reference || '',
                        notes: `Linked to AP/AR transaction: ${aparTransaction.id}`,
                        category: 'Revenue',
                        source: 'linked_from_apar',
                        ap_ar_transaction_id: aparTransaction.id,
                        is_linked: true
                    };
                    
                } else if (aparTransaction.type === 'AP') {
                    // AP: Debit Expense + Credit Accounts Payable
                    glTransaction1 = {
                        transaction_date: aparTransaction.invoice_date,
                        account_code: window.selectedBalancingAccount.code,
                        account_name: window.selectedBalancingAccount.name,
                        description: `Expense: ${aparTransaction.company} - ${aparTransaction.description}`,
                        debit_amount: aparTransaction.amount,
                        credit_amount: 0,
                        reference: aparTransaction.reference || '',
                        notes: `Linked to AP/AR transaction: ${aparTransaction.id}`,
                        category: 'Expense',
                        source: 'linked_from_apar',
                        ap_ar_transaction_id: aparTransaction.id,
                        is_linked: true
                    };
                    
                    glTransaction2 = {
                        transaction_date: aparTransaction.invoice_date,
                        account_code: '2010', // Accounts Payable
                        account_name: 'Accounts Payable',
                        description: `AP: ${aparTransaction.company} - ${aparTransaction.description}`,
                        debit_amount: 0,
                        credit_amount: aparTransaction.amount,
                        reference: aparTransaction.reference || '',
                        notes: `Linked to AP/AR transaction: ${aparTransaction.id}`,
                        category: 'Liability',
                        source: 'linked_from_apar',
                        ap_ar_transaction_id: aparTransaction.id,
                        is_linked: true
                    };
                }
                
                // Save both GL transactions to database
                console.log('Saving GL transaction 1:', glTransaction1);
                const savedGL1 = await saveFinancialTransaction(glTransaction1);
                
                console.log('Saving GL transaction 2:', glTransaction2);
                const savedGL2 = await saveFinancialTransaction(glTransaction2);
                
                // Update the AP/AR transaction to mark it as linked
                await updateTransaction(aparTransaction.id, {
                    linked_financial_id: savedGL1.id, // Link to first GL transaction
                    source: aparTransaction.source || 'manual' // Preserve existing source
                });
                
                // Close modal and refresh tables
                closeGLAccountSelectionModal();
                
                // Refresh both tables
                await loadFinancialTransactions();
                await loadAPARData();
                renderAPARTable();
                
                alert(`Successfully created GL entries!\n\nCreated:\n- ${glTransaction1.account_name} (${glTransaction1.debit_amount > 0 ? 'Debit' : 'Credit'}): ${formatCurrencyFull(aparTransaction.amount, 'IDR')}\n- ${glTransaction2.account_name} (${glTransaction2.debit_amount > 0 ? 'Debit' : 'Credit'}): ${formatCurrencyFull(aparTransaction.amount, 'IDR')}`);
                
            } catch (error) {
                console.error('Error creating GL entries:', error);
                alert('Error creating GL entries: ' + error.message);
            } finally {
                // Re-enable button
                const createButton = document.getElementById('createGLButton');
                if (createButton) {
                    createButton.disabled = false;
                    createButton.textContent = 'Create GL Entries';
                }
            }
        }
        
        function unlinkAPARFromGL(aparId) {
            if (!confirm('Are you sure you want to unlink this AP/AR transaction from GL?')) return;
            
            unlinkAPARTransaction(aparId);
        }
        
        async function unlinkAPARTransaction(aparId) {
            try {
                const aparTransaction = aparTransactions.find(t => t.id === aparId);
                
                // Update AP/AR transaction
                await updateTransaction(aparId, {
                    linked_financial_id: null
                });
                
                // Update GL transaction if linked
                if (aparTransaction.linked_financial_id) {
                    await updateFinancialTransaction(aparTransaction.linked_financial_id, {
                        ap_ar_transaction_id: null,
                        is_linked: false
                    });
                }
                
                // Refresh both tables
                renderAPARTable();
                renderFinancialTable();
                
                alert('Transaction unlinked successfully!');
                
            } catch (error) {
                console.error('Error unlinking transaction:', error);
                alert('Error unlinking transaction: ' + error.message);
            }
        }
        
        // Store period selections before navigation
        let storedPeriodSelections = {
            current: null,
            previous: null,
            includeYoY: false
        };
        
        // Navigation handling
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Store current report settings before leaving
                if (document.querySelector('.nav-link.active')?.dataset.section === 'reports') {
                    const currentSelect = document.getElementById('currentPeriod');
                    const previousSelect = document.getElementById('previousPeriod');
                    const includeYoYCheck = document.getElementById('includeYoY');
                    
                    if (currentSelect && previousSelect) {
                        storedPeriodSelections = {
                            current: currentSelect.value,
                            previous: previousSelect.value,
                            includeYoY: includeYoYCheck ? includeYoYCheck.checked : false
                        };
                        console.log('Stored period selections:', storedPeriodSelections);
                    }
                }
                
                // Remove active class from all links
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                
                // Add active class to clicked link
                this.classList.add('active');
                
                // Hide all sections
                document.querySelectorAll('.section-content').forEach(section => {
                    section.style.display = 'none';
                });
                
                // Show selected section
                const sectionId = this.dataset.section + '-section';
                const section = document.getElementById(sectionId);
                if (section) {
                    section.style.display = 'block';
                }
                
                // Update page title
                const titles = {
                    'dashboard': 'Dashboard Overview',
                    'ap-ar': 'AP/AR Tracking', 
                    'statements': 'Financial Statements',
                    'reports': 'Reports & Analytics', 
                    'budgets': 'Budgeting & Planning', 
                    'forecasting': 'Forecasting & Analytics',
                    'benchmarking': 'Industry Benchmarking',
                    'scenarios': 'Scenario Analysis'
                };
        
                const subtitles = {
                    'dashboard': 'Real-time financial insights and cash flow management',
                    'ap-ar': 'Track overdue payments and manage cash cycles',
                    'statements': 'Generate income statements, balance sheets, and cash flow reports',
                    'reports': 'Period-to-period variance analysis and business intelligence', 
                    'budgets': 'Refine your budgets for better control of your performance', 
                    'forecasting': 'Multi-year P&L forecasting with AI-powered insights and growth analysis',
                    'benchmarking': 'Compare your financial performance against industry peers and get strategic recommendations',
                    'scenarios': 'What-if modeling and strategic financial planning'
                };
                
                const pageTitle = document.querySelector('.page-title');
                const pageSubtitle = document.querySelector('.page-subtitle'); // or whatever class your subtitle uses
                pageTitle.textContent = titles[this.dataset.section] || 'Dashboard';
                if (pageSubtitle) {
                    pageSubtitle.textContent = subtitles[this.dataset.section] || 'Real-time financial insights and cash flow management';
                }
                
                if (this.dataset.section === 'dashboard') {
                    setTimeout(() => {
                        initializeDashboardData();
                    }, 100);
                }
        
                if (this.dataset.section === 'ap-ar') {
                    setTimeout(() => {
                        updateOverdueStatuses();
                        // Refresh AP/AR data when section becomes visible
                        updateAPARSummary();
                        renderAPARTable();
                        
                        const typeFilter = document.getElementById('typeFilter');
                        const statusFilter = document.getElementById('statusFilter');
                        const dateFromFilter = document.getElementById('dateFromFilter');
                        const dateToFilter = document.getElementById('dateToFilter');
                        
                        if (typeFilter) typeFilter.addEventListener('change', renderAPARTable);
                        if (statusFilter) statusFilter.addEventListener('change', renderAPARTable);
                        if (dateFromFilter) dateFromFilter.addEventListener('change', renderAPARTable);
                        if (dateToFilter) dateToFilter.addEventListener('change', renderAPARTable);
                    }, 100);
                }
                
                if (this.dataset.section === 'reports') {
                    setTimeout(() => {
                        // Check if we have stored period selections to restore
                        if (storedPeriodSelections.current) {
                            console.log('Restoring period selections:', storedPeriodSelections);
                            
                            // First initialize normally
                            initializeReportsAnalytics();
                            
                            // Then restore stored selections after a brief delay
                            setTimeout(() => {
                                const currentSelect = document.getElementById('currentPeriod');
                                const previousSelect = document.getElementById('previousPeriod');
                                const includeYoYCheck = document.getElementById('includeYoY');
                                
                                if (currentSelect && previousSelect) {
                                    currentSelect.value = storedPeriodSelections.current;
                                    previousSelect.value = storedPeriodSelections.previous;
                                    if (includeYoYCheck) includeYoYCheck.checked = storedPeriodSelections.includeYoY;
                                    
                                    console.log('Applied stored selections, regenerating report...');
                                    
                                    // Regenerate report with restored settings
                                    generateComparisonReport();
                                }
                            }, 200);
                        } else {
                            // First time visiting reports, initialize normally
                            initializeReportsAnalytics();
                        }
                    }, 100);
                }

                if (this.dataset.section === 'budgets') {
                    initializeBudgetsSection();
                }

                if (this.dataset.section === 'scenarios') {
                    initializeScenarios();
                }

                if (this.dataset.section === 'benchmarking') {
                    // Initialize Industry Benchmarking
                    setTimeout(() => {
                        initializeIndustryBenchmarking();
                    }, 100);
                }
            });
        });

        // Time period selector
        document.querySelectorAll('.time-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Here you would trigger data refresh based on selected period
                console.log('Selected period:', this.dataset.period);
            });
        });

        // AI Chat functionality
        function toggleAIChat() {
            const sidebar = document.getElementById('aiChatSidebar');
            const toggle = document.querySelector('.ai-chat-toggle');
            
            sidebar.classList.toggle('open');
            
            // Hide/show toggle button
            if (sidebar.classList.contains('open')) {
                toggle.style.display = 'none';
            } else {
                toggle.style.display = 'flex';
            }
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleBtn = document.querySelector('.sidebar-toggle i');
            
            sidebar.classList.toggle('collapsed');
            
            if (sidebar.classList.contains('collapsed')) {
                mainContent.style.marginLeft = '60px';
                toggleBtn.className = 'fas fa-chevron-right';
            } else {
                mainContent.style.marginLeft = '280px';
                toggleBtn.className = 'fas fa-chevron-left';
            }
        }

        class AIFinancialChat {
            constructor() {
                this.sessionId = this.getOrCreateSessionId();
                this.currentTab = 'dashboard'; // Will be set dynamically
                this.isLoading = false;
                this.chatHistory = [];
                
                this.initializeElements();
                this.setupEventListeners();
                this.loadChatHistory();
                this.updateSuggestions();
            }
            
            getOrCreateSessionId() {
                let sessionId = localStorage.getItem('montpro_session_id');
                if (!sessionId) {
                    sessionId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                    localStorage.setItem('montpro_session_id', sessionId);
                }
                return sessionId;
            }
            
            initializeElements() {
                this.chatMessages = document.getElementById('chatMessages');
                this.chatInput = document.getElementById('chatInput');
                this.sendBtn = document.getElementById('chatSendBtn');
                this.suggestionsGrid = document.getElementById('suggestionsGrid');
                this.emptyState = document.getElementById('emptyState');
            }
            
            // In your AIFinancialChat class, update the setupEventListeners method:
            setupEventListeners() {
                // Send button click
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                
                // Enter key to send (Shift+Enter for new line)
                this.chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // Auto-resize textarea
                this.chatInput.addEventListener('input', () => {
                    this.chatInput.style.height = 'auto';
                    this.chatInput.style.height = Math.min(this.chatInput.scrollHeight, 80) + 'px';
                });
                
                // Suggestion clicks - FIXED TO PREVENT DUPLICATES
                this.suggestionsGrid.addEventListener('click', (e) => {
                    if (e.target.classList.contains('suggestion-item') && !this.isLoading) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const suggestionText = e.target.textContent.trim();
                        this.chatInput.value = suggestionText;
                        
                        setTimeout(() => {
                            this.sendMessage();
                        }, 100);
                    }
                });
            }
            
            async loadChatHistory() {
                try {
                    const { data, error } = await supabase
                        .from('chat_history_meridash')
                        .select('*')
                        .eq('session_id', this.sessionId)
                        .order('timestamp', { ascending: true })
                        .limit(30);
                    
                    if (error) throw error;
                    
                    this.chatHistory = data || [];
                    this.renderMessages();
                } catch (error) {
                    console.error('Error loading chat history:', error);
                }
            }
            
            async saveChatHistory(userMessage, aiResponse) {
                try {
                    await supabase.from('chat_history_meridash').insert([
                        {
                            session_id: this.sessionId,
                            message_type: 'user',
                            message_content: userMessage,
                            current_tab: this.currentTab,
                            timestamp: new Date().toISOString()
                        },
                        {
                            session_id: this.sessionId,
                            message_type: 'ai',
                            message_content: aiResponse,
                            current_tab: this.currentTab,
                            timestamp: new Date().toISOString()
                        }
                    ]);
                } catch (error) {
                    console.error('Error saving chat history:', error);
                }
            }
            
            updateSuggestions() {
                const suggestions = this.getSuggestionsForTab(this.currentTab);
                this.suggestionsGrid.innerHTML = suggestions.map(suggestion => 
                    `<div class="suggestion-item">${suggestion}</div>`
                ).join('');
            }
            
            getSuggestionsForTab(tab) {
                const suggestionMap = {
                    'dashboard': [
                        'What is my current cash position?',
                        'Show me my financial health summary',
                        'What is my cash runway?',
                        'How is my revenue trending?'
                    ],
                    'ap-ar': [
                        'Which customers have overdue payments?',
                        'What is my collection forecast?',
                        'Show me largest outstanding invoices',
                        'What is my average collection period?'
                    ],
                    'statements': [
                        'Analyze my income statement trends',
                        'Compare this quarter vs last quarter',
                        'What are my biggest expense categories?',
                        'Show me profit margin analysis'
                    ],
                    'forecasting': [
                        'Predict my cash flow for next quarter',
                        'What if revenue drops by 20%?',
                        'Show me seasonal trends',
                        'Forecast my working capital needs'
                    ],
                    'benchmarking': [
                        'How do I compare to industry averages?',
                        'What is my company valuation?',
                        'Show me key ratio analysis',
                        'Compare my growth rate to peers'
                    ],
                    'reports': [
                        'Generate executive summary',
                        'Create investor pitch analysis',
                        'What trends should I highlight?',
                        'Show me KPI dashboard'
                    ]
                };
                
                return suggestionMap[tab] || suggestionMap['dashboard'];
            }
            
            async sendMessage() {
                const message = this.chatInput.value.trim();
                if (!message || this.isLoading) return;
                
                // Clear input and disable send button
                this.chatInput.value = '';
                this.chatInput.style.height = 'auto';
                this.setLoading(true);
                
                // Add user message
                this.addMessage('user', message);
                
                // Show typing indicator
                this.showTypingIndicator();
                
                try {
                    // Send to backend
                    const response = await this.sendToBackend(message);
                    
                    // Remove typing indicator
                    this.hideTypingIndicator();
                    
                    // Add AI response
                    this.addMessage('ai', response);
                    
                    // Save to chat history
                    await this.saveChatHistory(message, response);
                    
                } catch (error) {
                    console.error('Error sending message:', error);
                    this.hideTypingIndicator();
                    this.addMessage('ai', 'I apologize, but I encountered an error processing your request. Please try again.');
                } finally {
                    this.setLoading(false);
                }
            }
            
            async sendToBackend(message) {
                const webhookUrl = 'https://n8n.srv909550.hstgr.cloud/webhook/meridash_chat_assistant';
                
                const payload = {
                    user_message: message,
                    session_id: this.sessionId,
                    current_tab: this.currentTab,
                    timestamp: new Date().toISOString()
                };
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error('Backend request failed');
                }
                
                const data = await response.json();
                return data.ai_response || 'I received your message but couldn\'t generate a response.';
            }
            
            addMessage(type, content) {
                // Hide empty state
                if (this.emptyState) {
                    this.emptyState.style.display = 'none';
                }
                
                const messageElement = document.createElement('div');
                messageElement.className = `message ${type}`;
                
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // Parse markdown formatting
                const formattedContent = content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n/g, '<br>');
                
                messageElement.innerHTML = `
                    <div class="message-avatar">
                        <i class="fas fa-${type === 'user' ? 'user' : 'robot'}"></i>
                    </div>
                    <div class="message-content">
                        ${formattedContent}
                        <div class="message-time">${time}</div>
                    </div>
                `;
                
                this.chatMessages.appendChild(messageElement);
                this.scrollToBottom();
                
                // Add to chat history
                this.chatHistory.push({ type, content, timestamp: new Date().toISOString() });
            }
            
            showTypingIndicator() {
                const typingElement = document.createElement('div');
                typingElement.className = 'message ai';
                typingElement.id = 'typingIndicator';
                
                typingElement.innerHTML = `
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="typing-indicator">
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                `;
                
                this.chatMessages.appendChild(typingElement);
                this.scrollToBottom();
            }
            
            hideTypingIndicator() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }
            
            setLoading(loading) {
                this.isLoading = loading;
                this.sendBtn.disabled = loading;
                this.chatInput.disabled = loading;
            }
            
            scrollToBottom() {
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }
            
            renderMessages() {
                this.chatMessages.innerHTML = '';
                
                if (this.chatHistory.length === 0) {
                    this.chatMessages.appendChild(this.emptyState);
                    return;
                }
                
                this.chatHistory.forEach(message => {
                    this.addMessage(message.type, message.content);
                });
            }
            
            async saveChatHistory(userMessage, aiResponse) {
                try {
                    // TODO: Save to Supabase
                    // await supabase.from('chat_history_meridash').insert([
                    //     {
                    //         session_id: this.sessionId,
                    //         message_type: 'user',
                    //         message_content: userMessage,
                    //         current_tab: this.currentTab,
                    //         timestamp: new Date().toISOString()
                    //     },
                    //     {
                    //         session_id: this.sessionId,
                    //         message_type: 'ai',
                    //         message_content: aiResponse,
                    //         current_tab: this.currentTab,
                    //         timestamp: new Date().toISOString()
                    //     }
                    // ]);
                } catch (error) {
                    console.error('Error saving chat history:', error);
                }
            }
            
            // Method to update current tab context
            setCurrentTab(tabName) {
                this.currentTab = tabName;
                this.updateSuggestions();
            }
        }
        
        // Initialize chat when page loads
        let aiChat;
        document.addEventListener('DOMContentLoaded', () => {
            aiChat = new AIFinancialChat();
        });
        
        // Expose function to update tab context from main dashboard
        window.updateChatContext = function(tabName) {
            if (aiChat) {
                aiChat.setCurrentTab(tabName);
            }
        };

        // AP/AR Data Management   
        async function loadAPARData() {
            try {
                const { data, error } = await supabase
                    .from('ap_ar_transactions_meridash')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                aparTransactions = data || [];
                console.log('Loaded transactions:', aparTransactions.length);
                
                // Only update UI if we're on the AP/AR section
                if (document.getElementById('aparTableBody')) {
                    updateAPARSummary();
                    renderAPARTable();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading transactions: ' + error.message);
            }
            initializeDashboardData();
        }
        
        async function saveTransaction(transaction) {
            try {
                // Add user_id to the transaction
                const transactionWithUser = {
                    ...transaction,
                    user_id: (await supabase.auth.getUser()).data.user?.id
                };
        
                const { data, error } = await supabase
                    .from('ap_ar_transactions_meridash')
                    .insert([transactionWithUser])
                    .select();
                
                if (error) throw error;
                
                // Add to local array
                aparTransactions.unshift(data[0]);
                updateAPARSummary();
                renderAPARTable();
                
                return data[0];
            } catch (error) {
                console.error('Error saving transaction:', error);
                alert('Error saving transaction: ' + error.message);
                throw error;
            }
        }
        
        async function updateTransaction(id, updates) {
            try {
                const { data, error } = await supabase
                    .from('ap_ar_transactions_meridash')
                    .update(updates)
                    .eq('id', id)
                    .select();
                
                if (error) throw error;
                
                // Update local array
                const index = aparTransactions.findIndex(t => t.id === id);
                if (index !== -1) {
                    aparTransactions[index] = data[0];
                }
                
                updateAPARSummary();
                renderAPARTable();
                
                return data[0];
            } catch (error) {
                console.error('Error updating transaction:', error);
                alert('Error updating transaction: ' + error.message);
                throw error;
            }
        }
        
        async function deleteTransactionFromDB(id) {
            try {
                const { error } = await supabase
                    .from('ap_ar_transactions_meridash')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                // Remove from local array
                aparTransactions = aparTransactions.filter(t => t.id !== id);
                updateAPARSummary();
                renderAPARTable();
                
            } catch (error) {
                console.error('Error deleting transaction:', error);
                alert('Error deleting transaction: ' + error.message);
                throw error;
            }
        }
        
        function updateAPARSummary() {
            // Calculate ALL unpaid transactions (total AR/AP)
            const allUnpaidAR = aparTransactions.filter(t => t.type === 'AR' && t.status !== 'Paid');
            const allUnpaidAP = aparTransactions.filter(t => t.type === 'AP' && t.status !== 'Paid');
            
            const totalARAll = allUnpaidAR.reduce((sum, t) => sum + t.amount, 0);
            const totalAPAll = allUnpaidAP.reduce((sum, t) => sum + t.amount, 0);
            
            // Calculate ONLY overdue transactions
            const overdueAR = allUnpaidAR.filter(t => {
                let dueDate = t.due_date;
                if (!dueDate && t.payment_terms && t.invoice_date) {
                    const invoiceDate = new Date(t.invoice_date);
                    dueDate = new Date(invoiceDate.getTime() + (parseInt(t.payment_terms) * 24 * 60 * 60 * 1000)).toISOString().split('T')[0];
                }
                return dueDate && new Date(dueDate) < new Date();
            });
            
            const overdueAP = allUnpaidAP.filter(t => {
                let dueDate = t.due_date;
                if (!dueDate && t.payment_terms && t.invoice_date) {
                    const invoiceDate = new Date(t.invoice_date);
                    dueDate = new Date(invoiceDate.getTime() + (parseInt(t.payment_terms) * 24 * 60 * 60 * 1000)).toISOString().split('T')[0];
                }
                return dueDate && new Date(dueDate) < new Date();
            });
            
            const totalAROverdue = overdueAR.reduce((sum, t) => sum + t.amount, 0);
            const totalAPOverdue = overdueAP.reduce((sum, t) => sum + t.amount, 0);
            
            // FIXED: Calculate netCash before using it
            const netCash = totalARAll - totalAPAll;
            
            // Calculate CCC
            const cccData = calculateCCC();
            
            // DEBUG LOGGING
            console.log('=== AR/AP SUMMARY DEBUG ===');
            console.log('All unpaid AR:', allUnpaidAR.length, 'Total:', totalARAll);
            console.log('All unpaid AP:', allUnpaidAP.length, 'Total:', totalAPAll);
            console.log('Overdue AR:', overdueAR.length, 'Total:', totalAROverdue);
            console.log('Overdue AP:', overdueAP.length, 'Total:', totalAPOverdue);
            console.log('Net Cash:', netCash);
            
            // Update display - check if elements exist
            if (document.getElementById('totalARAll')) {
                document.getElementById('totalARAll').textContent = formatCurrencyFull(totalARAll, 'IDR');
            }
            if (document.getElementById('totalAPAll')) {
                document.getElementById('totalAPAll').textContent = formatCurrencyFull(totalAPAll, 'IDR');
            }
            if (document.getElementById('totalAR')) {
                document.getElementById('totalAR').textContent = formatCurrencyFull(totalAROverdue, 'IDR');
                console.log('Updated totalAR element with:', formatCurrencyFull(totalAROverdue, 'IDR'));
            }
            if (document.getElementById('totalAP')) {
                document.getElementById('totalAP').textContent = formatCurrencyFull(totalAPOverdue, 'IDR');
                console.log('Updated totalAP element with:', formatCurrencyFull(totalAPOverdue, 'IDR'));
            }
            if (document.getElementById('netCashImpact')) {
                document.getElementById('netCashImpact').textContent = formatCurrencyFull(netCash, 'IDR');
            }
            
            // Update badges
            if (document.getElementById('arAging')) {
                const arBadge = document.getElementById('arAging');
                arBadge.textContent = `${overdueAR.length} overdue`;
                arBadge.className = `aging-indicator ${overdueAR.length > 0 ? 'badge-overdue' : 'badge-neutral'}`;
            }
            
            if (document.getElementById('apAging')) {
                const apBadge = document.getElementById('apAging');
                apBadge.textContent = `${overdueAP.length} overdue`;
                apBadge.className = `aging-indicator ${overdueAP.length > 0 ? 'badge-overdue' : 'badge-neutral'}`;
            }
            
            if (document.getElementById('cashImpactChange')) {
                const cashBadge = document.getElementById('cashImpactChange');
                cashBadge.textContent = netCash >= 0 ? 'Positive cash position' : 'Negative cash position';
                cashBadge.className = netCash >= 0 ? 'positive' : 'negative';
            }
            
            // Update CCC display
            if (document.getElementById('cccDisplay') && cccData) {
                document.getElementById('cccDisplay').textContent = `CCC: ${cccData.ccc} days*`;
                document.getElementById('cccDisplay').title = `Simplified calculation: DSO (${cccData.dso} days) - DPO (${cccData.dpo} days). Based on average days outstanding for unpaid/overdue transactions.`;
            }
        }
        
        // Modal Functions
        function openAddModal() {
            document.getElementById('addModal').classList.add('show');
            
            // Only set defaults if not editing (no editId exists)
            const isEditing = document.getElementById('addTransactionForm').dataset.editId;
            
            if (!isEditing) {
                // Set default dates - only invoice date, leave due date blank
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('transactionInvoiceDate').value = today;
                document.getElementById('transactionDueDate').value = '';
                
                // Reset form state for new transaction
                document.querySelector('.modal-title').textContent = 'Add Transaction';
                document.querySelector('#addTransactionForm button[type="submit"]').textContent = 'Add Transaction';
            }
            
            // Add event listeners (only once per modal open)
            const invoiceDateInput = document.getElementById('transactionInvoiceDate');
            const paymentTermsSelect = document.getElementById('transactionPaymentTerms');
            
            if (invoiceDateInput) {
                invoiceDateInput.removeEventListener('change', updateDueDateFromTerms);
                invoiceDateInput.addEventListener('change', updateDueDateFromTerms);
            }
            
            if (paymentTermsSelect) {
                paymentTermsSelect.removeEventListener('change', handlePaymentTermsChange);
                paymentTermsSelect.addEventListener('change', handlePaymentTermsChange);
            }
        }
        
        function closeAddModal() {
            document.getElementById('addModal').classList.remove('show');
            document.getElementById('addTransactionForm').reset();
        }
        
        function openUploadModal() {
            document.getElementById('uploadModal').classList.add('show');
        }
        
        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('show');
        }
        
        async function addTransaction(event) {
            event.preventDefault();
            
            const editId = document.getElementById('addTransactionForm').dataset.editId;
            const paymentTerms = document.getElementById('transactionPaymentTerms').value;
            const customTerms = document.getElementById('customPaymentTerms').value;
            const finalTerms = paymentTerms === 'custom' ? customTerms : paymentTerms;
            
            const transactionData = {
                type: document.getElementById('transactionType').value,
                reference: document.getElementById('transactionReference').value,
                company: document.getElementById('transactionCompany').value,
                description: document.getElementById('transactionDescription').value,
                amount: parseFloat(document.getElementById('transactionAmount').value),
                invoice_date: document.getElementById('transactionInvoiceDate').value,
                due_date: document.getElementById('transactionDueDate').value || null,
                status: document.getElementById('transactionStatus').value,
                currency: document.getElementById('transactionCurrency').value,
                payment_terms: parseInt(finalTerms)
            };
            
            try {
                if (editId) {
                    // Update existing transaction
                    await updateTransaction(editId, transactionData);
                    
                    // Reset form
                    delete document.getElementById('addTransactionForm').dataset.editId;
                    document.querySelector('.modal-title').textContent = 'Add Transaction';
                    document.querySelector('#addTransactionForm button[type="submit"]').textContent = 'Add Transaction';
                } else {
                    // Add new transaction
                    await saveTransaction(transactionData);
                }
                
                closeAddModal();
            } catch (error) {
                // Error already handled in the save/update functions
            }
        }

        function handlePaymentTermsChange() {
            const customInput = document.getElementById('customPaymentTerms');
            const paymentTermsSelect = document.getElementById('transactionPaymentTerms');
            
            if (paymentTermsSelect.value === 'custom') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                updateDueDateFromTerms();
            }
        }
        
        // Utility Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }
        
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString();
        }
        
        function calculateDaysDifference(dueDate) {
            const today = new Date();
            const due = new Date(dueDate);
            const diffTime = due - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function renderAPARTable() {
            const tbody = document.getElementById('aparTableBody');
            
            if (!tbody) return;
            
            const filteredData = getFilteredTransactions();
            
            tbody.innerHTML = filteredData.map(transaction => {
                let dueDate = transaction.due_date;
                let isCalculated = false;
                
                // Calculate due date if blank but have payment terms
                if (!dueDate && transaction.payment_terms && transaction.invoice_date) {
                    const invoiceDate = new Date(transaction.invoice_date);
                    const dueDateCalc = new Date(invoiceDate.getTime() + (parseInt(transaction.payment_terms) * 24 * 60 * 60 * 1000));
                    dueDate = dueDateCalc.toISOString().split('T')[0];
                    isCalculated = true;
                }
                
                // Determine actual status - if not paid and past due, it's overdue
                const actualStatus = transaction.status;
                
                const days = dueDate ? calculateDaysDifference(dueDate) : null;
                const daysClass = days === null ? 'days-current' : (days < 0 ? 'days-overdue' : days <= 7 ? 'days-due-soon' : 'days-current');
                const daysText = days === null ? 'No due date' : (days < 0 ? `${Math.abs(days)} overdue` : days === 0 ? 'Due today' : `${days} days`);
                
                return `
                    <tr>
                        <td><span class="type-badge type-${transaction.type.toLowerCase()}">${transaction.type}</span></td>
                        <td>${transaction.reference}</td>
                        <td title="${transaction.company}">${transaction.company}</td>
                        <td title="${transaction.description}">${transaction.description}</td>
                        <td>${formatCurrency(transaction.amount, transaction.currency || 'IDR')}</td>
                        <td>${formatDateIndonesian(transaction.invoice_date)}</td>
                        <td>${dueDate ? formatDateIndonesian(dueDate) : '-'}${isCalculated ? ' <span style="color: #94a3b8; font-size: 0.75rem;">*</span>' : ''}</td>
                        <td><span class="days-badge ${daysClass}">${daysText}</span></td>
                        <td><span class="status-badge status-${actualStatus.toLowerCase()}">${actualStatus}</span></td>
                        <td style="text-align: center;">
                            ${transaction.linked_financial_id ? 
                                `<button class="btn btn-sm btn-danger" onclick="unlinkAPARFromGL('${transaction.id}')" title="Unlink from GL">
                                    <i class="fas fa-unlink"></i>
                                </button>` : 
                                `<button class="btn btn-sm btn-primary" onclick="linkAPARToGL('${transaction.id}')" title="Link to GL">
                                    <i class="fas fa-link"></i>
                                </button>`
                            }
                        </td>
                        <td>
                            <button class="action-btn edit" onclick="editTransaction('${transaction.id}')" data-tooltip="Edit Transaction">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteTransaction('${transaction.id}')" data-tooltip="Delete Transaction">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function getFilteredTransactions() {
            let filtered = [...aparTransactions];
            
            const typeFilter = document.getElementById('typeFilter')?.value;
            const statusFilterArray = getStatusFilterValue();
            const dateFrom = document.getElementById('dateFromFilter')?.value;
            const dateTo = document.getElementById('dateToFilter')?.value;
            
            if (typeFilter) filtered = filtered.filter(t => t.type === typeFilter);
            if (statusFilterArray.length > 0) filtered = filtered.filter(t => statusFilterArray.includes(t.status));
            if (dateFrom) filtered = filtered.filter(t => t.due_date >= dateFrom);
            if (dateTo) filtered = filtered.filter(t => t.due_date <= dateTo);
            
            return filtered.sort((a, b) => new Date(a.due_date) - new Date(b.due_date));
        }
        
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());
                    const headers = lines[0].split(',').map(h => h.trim());
                    
                    const newTransactions = [];
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.trim());
                        if (values.length >= 8) {
                            newTransactions.push({
                                type: values[0],
                                description: values[1],
                                amount: parseFloat(values[2]),
                                invoice_date: values[3],
                                due_date: values[4] || null,
                                company: values[5],
                                status: values[6],
                                reference: values[7],
                                currency: 'IDR', // Default currency
                                payment_terms: 30 // Default payment terms
                            });
                        }
                    }
                    
                    // Insert all transactions
                    const { data: { user } } = await supabase.auth.getUser();
                    const userId = user?.id;
                    
                    const transactionsWithUser = newTransactions.map(transaction => ({
                        ...transaction,
                        user_id: userId
                    }));
                    
                    const { data, error } = await supabase
                        .from('ap_ar_transactions_meridash')
                        .insert(transactionsWithUser)
                        .select();
                    
                    if (error) throw error;
                    
                    // Add to local array
                    aparTransactions.unshift(...data);
                    updateAPARSummary();
                    renderAPARTable();
                    
                    closeUploadModal();
                    alert(`Successfully imported ${data.length} transactions!`);
                } catch (error) {
                    console.error('Error importing file:', error);
                    alert('Error importing file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        function downloadTemplate() {
            const csv = `Type,Description,Amount,Invoice_Date,Due_Date,Company,Status,Reference
        AR,Website Development Services,5000,2025-01-15,2025-02-14,ABC CoRp ,Overedue,INV-001
        AP,Office Supplies,250,2025-01-10,2025-02-09,OfficeMax,Overdue,BILL-501`;
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ap_ar_template.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        function clearFilters() {
            // Clear type filter
            const typeFilter = document.getElementById('typeFilter');
            if (typeFilter) typeFilter.value = '';
            
            // Clear old single status filter (if it exists)
            const oldStatusFilter = document.getElementById('statusFilter');
            if (oldStatusFilter) oldStatusFilter.value = '';
            
            // Clear multi-select status filter
            const checkboxes = document.querySelectorAll('#statusFilterDropdown input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            selectedStatuses = [];
            updateStatusFilterText();
            
            // Clear date filters
            const dateFromFilter = document.getElementById('dateFromFilter');
            const dateToFilter = document.getElementById('dateToFilter');
            if (dateFromFilter) dateFromFilter.value = '';
            if (dateToFilter) dateToFilter.value = '';
            
            // Re-render table
            renderAPARTable();
        }
        
        async function deleteTransaction(id) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                await deleteTransactionFromDB(id);
            }
        }
        
        function editTransaction(id) {
            const transaction = aparTransactions.find(t => t.id === id);
            if (!transaction) return;
            
            // Populate the form with existing data
            document.getElementById('transactionType').value = transaction.type;
            document.getElementById('transactionReference').value = transaction.reference;
            document.getElementById('transactionCompany').value = transaction.company;
            document.getElementById('transactionDescription').value = transaction.description;
            document.getElementById('transactionAmount').value = transaction.amount;
            document.getElementById('transactionInvoiceDate').value = transaction.invoice_date;
            document.getElementById('transactionDueDate').value = transaction.due_date || '';
            document.getElementById('transactionStatus').value = transaction.status;
            
            // Set currency if exists
            if (transaction.currency) {
                selectCurrency(transaction.currency);
            }
            
            // Set payment terms if exists
            if (transaction.payment_terms) {
                document.getElementById('transactionPaymentTerms').value = transaction.payment_terms;
            }
            
            // Change modal title and button text
            document.querySelector('.modal-title').textContent = 'Edit Transaction';
            document.querySelector('#addTransactionForm button[type="submit"]').textContent = 'Confirm Edit';
            
            // Store the ID for updating
            document.getElementById('addTransactionForm').dataset.editId = id;
            
            // Open modal
            openAddModal();
        }

        // Currency selection
        function selectCurrency(currency) {
            document.querySelectorAll('.currency-option').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-currency="${currency}"]`).classList.add('active');
            document.getElementById('transactionCurrency').value = currency;
        }
        
        function updateDueDateFromTerms() {
            const invoiceDate = document.getElementById('transactionInvoiceDate').value;
            const terms = document.getElementById('transactionPaymentTerms').value;
            const dueDateInput = document.getElementById('transactionDueDate');
            
            // Only auto-calculate if due date is empty
            if (invoiceDate && terms !== 'custom' && !dueDateInput.value) {
                const invoice = new Date(invoiceDate);
                const due = new Date(invoice.getTime() + (parseInt(terms) * 24 * 60 * 60 * 1000));
                dueDateInput.value = due.toISOString().split('T')[0];
            }
        }
        
        // Indonesian date format
        function formatDateIndonesian(dateString) {
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear().toString().slice(-2);
            return `${day}/${month}/${year}`;
        }
        
        // Update currency formatting
        function formatCurrency(amount, currency = 'IDR') {
            if (currency === 'IDR') {
                // Force English locale for comma thousands separator
                const formatted = new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount);
                return `Rp  ${formatted}`;
            } else {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(amount);
            }
        }

        // Specific function for AP/AR summary cards - always shows full numbers
        function formatCurrencyFull(amount, currency = 'IDR') {
            if (currency === 'IDR') {
                const formatted = new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount);
                return `Rp  ${formatted}`;
            } else {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(amount);
            }
        }

        function calculateCCC() {
            // Include both Unpaid and Overdue transactions (not Paid or Partial)
            const arTransactions = aparTransactions.filter(t => 
                t.type === 'AR' && (t.status === 'Unpaid' || t.status === 'Overdue')
            );
            const apTransactions = aparTransactions.filter(t => 
                t.type === 'AP' && (t.status === 'Unpaid' || t.status === 'Overdue')
            );
            
            if (arTransactions.length === 0 && apTransactions.length === 0) {
                return null;
            }
            
            // Calculate DSO - Average days AR has been outstanding
            const avgARDays = arTransactions.length > 0 
                ? arTransactions.reduce((sum, t) => {
                    const invoiceDate = new Date(t.invoice_date);
                    const daysOutstanding = Math.floor((new Date() - invoiceDate) / (1000 * 60 * 60 * 24));
                    return sum + daysOutstanding;
                }, 0) / arTransactions.length 
                : 0;
            
            // Calculate DPO - Average days AP has been outstanding (FIXED)
            const avgAPDays = apTransactions.length > 0
                ? apTransactions.reduce((sum, t) => {
                    const invoiceDate = new Date(t.invoice_date);
                    const daysOutstanding = Math.floor((new Date() - invoiceDate) / (1000 * 60 * 60 * 24)); // FIXED: Added * 24
                    return sum + daysOutstanding;
                }, 0) / apTransactions.length
                : 0;
            
            // Simplified CCC = DSO - DPO (no inventory component)
            const ccc = Math.round(avgARDays - avgAPDays);
            
            return {
                dso: Math.round(avgARDays),
                dpo: Math.round(avgAPDays),
                ccc: ccc
            };
        }

        async function updateOverdueStatuses() {
            try {
                console.log('Checking for overdue transactions...');
                
                // Get all unpaid transactions
                const { data: unpaidTransactions, error } = await supabase
                    .from('ap_ar_transactions_meridash')
                    .select('*')
                    .eq('status', 'Unpaid');
                
                if (error) throw error;
                
                const today = new Date();
                const overdueTransactions = [];
                
                // Check which transactions are past due
                unpaidTransactions.forEach(transaction => {
                    let dueDate = transaction.due_date;
                    
                    // Calculate due date if not explicitly set
                    if (!dueDate && transaction.payment_terms && transaction.invoice_date) {
                        const invoiceDate = new Date(transaction.invoice_date);
                        const calculatedDueDate = new Date(invoiceDate.getTime() + (parseInt(transaction.payment_terms) * 24 * 60 * 60 * 1000));
                        dueDate = calculatedDueDate.toISOString().split('T')[0];
                    }
                    
                    // If past due, mark for update
                    if (dueDate && new Date(dueDate) < today) {
                        overdueTransactions.push(transaction.id);
                    }
                });
                
                // Update overdue transactions in database
                if (overdueTransactions.length > 0) {
                    const { error: updateError } = await supabase
                        .from('ap_ar_transactions_meridash')
                        .update({ status: 'Overdue' })
                        .in('id', overdueTransactions);
                    
                    if (updateError) throw updateError;
                    
                    console.log(`Updated ${overdueTransactions.length} transactions to Overdue status`);
                    
                    // Refresh local data
                    await loadAPARData();
                }
                
            } catch (error) {
                console.error('Error updating overdue statuses:', error);
            }
        }

        // Initialize with mock data
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Meridash Dashboard Loaded');
            
            // Initialize AP/AR data if not exists (keep this localStorage logic)
            if (!localStorage.getItem('aparTransactions')) {
                initializeSampleData();
            }
            
            // Load data from Supabase and check for overdue transactions
            loadAPARData().then(() => {
                updateOverdueStatuses();
                initializeStatusFilter();
                initializeDateDisplay();
                startConnectionMonitoring();
                initializeCashFlowForecast();
                updateAgingAnalysis();
                initializeDashboardData();
            });

            loadFinancialDataGlobally().then(() => {
                console.log('Financial statements data loaded globally');
            });
            
            // Set up automatic check every 24 hours
            setInterval(updateOverdueStatuses, 24 * 60 * 60 * 1000);
            
            // Also check when user returns to the page/tab
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    // Check if it's been more than 1 hour since last check
                    const lastCheck = localStorage.getItem('lastOverdueCheck');
                    const now = Date.now();
                    
                    if (!lastCheck || (now - parseInt(lastCheck)) > (60 * 60 * 1000)) {
                        updateOverdueStatuses();
                        localStorage.setItem('lastOverdueCheck', now.toString());
                    }
                }
            });
        });

        

        // Multi-Select Status Filter Functions
        let selectedStatuses = [];
        
        function initializeStatusFilter() {
            const trigger = document.getElementById('statusFilterTrigger');
            const dropdown = document.getElementById('statusFilterDropdown');
            
            // Toggle dropdown on trigger click
            trigger.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdown.classList.toggle('show');
                trigger.classList.toggle('active');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.multi-select-container')) {
                    dropdown.classList.remove('show');
                    trigger.classList.remove('active');
                }
            });
        }
        
        function updateStatusFilter() {
            const checkboxes = document.querySelectorAll('#statusFilterDropdown input[type="checkbox"]');
            selectedStatuses = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            updateStatusFilterText();
            renderAPARTable(); // Re-render table with new filters
        }
        
        function updateStatusFilterText() {
            const textElement = document.getElementById('statusFilterText');
            
            if (selectedStatuses.length === 0) {
                textElement.textContent = 'All Status';
            } else if (selectedStatuses.length === 1) {
                textElement.textContent = selectedStatuses[0];
            } else if (selectedStatuses.length === 4) { // All options selected
                textElement.textContent = 'All Status';
            } else {
                textElement.textContent = `${selectedStatuses.length} Selected`;
            }
        }
        
        function selectAllStatus() {
            const checkboxes = document.querySelectorAll('#statusFilterDropdown input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            updateStatusFilter();
        }
        
        function clearAllStatus() {
            const checkboxes = document.querySelectorAll('#statusFilterDropdown input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateStatusFilter();
        }
        
        // Update the existing renderAPARTable function to use multi-select
        function getStatusFilterValue() {
            return selectedStatuses.length === 0 ? '' : selectedStatuses;
        }

        // Date Display Functions
        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                timeZone: 'Asia/Jakarta'
            };
            
            const dateString = now.toLocaleDateString('en-US', options);
            const dateElement = document.getElementById('currentDate');
            if (dateElement) {
                dateElement.textContent = dateString;
            }
        }
        
        // Initialize date display
        function initializeDateDisplay() {
            updateCurrentDate();
            // Update every hour to keep it current
            setInterval(updateCurrentDate, 3600000);
        }

        // Cash Flow Forecast Functions
        let cashflowChart = null;
        let forecastData = [];
        
        async function initializeCashFlowForecast() {
            // Load starting cash from Supabase first
            await loadStartingCash();
            
            // Format the starting cash input with thousand separators
            const startingCashInput = document.getElementById('startingCash');
            if (startingCashInput) {
                startingCashInput.addEventListener('input', formatCurrencyInput);
                startingCashInput.addEventListener('blur', async function() {
                    // Save to Supabase when user finishes editing
                    const amount = getStartingCash();
                    await saveStartingCash(amount);
                    refreshForecast();
                });
            }
            
            // Generate forecast data using real AP/AR data
            generateForecastData();
            createCashFlowChart();
        }
        
        // Make sure this function is called when forecast is refreshed
        function refreshForecast() {
            console.log('Refreshing forecast with real AP/AR data...');
            generateForecastData();
            createCashFlowChart();
        }
        
        function formatCurrencyInput(event) {
            let value = event.target.value.replace(/[^\d]/g, '');
            if (value) {
                value = parseInt(value).toLocaleString('en-US');
                event.target.value = value;
            }
        }
        
        function getStartingCash() {
            const input = document.getElementById('startingCash');
            const value = input.value.replace(/[^\d]/g, '');
            return parseInt(value) || 100000000;
        }
        
        function generateForecastData() {
            console.log('=== GENERATING DASHBOARD FORECAST DATA ===');
            
            const startingCash = getStartingCash();
            const today = new Date();
            forecastData = [];
            
            // Generate 13 weeks of data
            let currentCash = startingCash;
            let totalInflows = 0;
            let totalOutflows = 0;
            
            for (let week = 0; week < 13; week++) {
                const weekDate = new Date(today);
                weekDate.setDate(today.getDate() + (week * 7));
                
                // Calculate weekly cash flows from AP/AR data using working logic
                const weeklyFlows = calculateWeeklyFlows(weekDate);
                
                currentCash += weeklyFlows.inflows - weeklyFlows.outflows;
                totalInflows += weeklyFlows.inflows;
                totalOutflows += weeklyFlows.outflows;
                
                forecastData.push({
                    week: week + 1,
                    date: weekDate,
                    cashPosition: currentCash,
                    inflows: weeklyFlows.inflows,
                    outflows: weeklyFlows.outflows,
                    label: `Week ${week + 1}`
                });
            }
            
            console.log('Generated forecast data:', forecastData);
            console.log('Total inflows:', totalInflows, 'Total outflows:', totalOutflows);
            
            updateForecastSummary(totalInflows, totalOutflows);
        }
        
        function calculateWeeklyFlows(weekDate) {
            let inflows = 0;
            let outflows = 0;
            
            // Calculate which week this date represents (1-13)
            const today = new Date();
            const diffTime = weekDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const week = Math.ceil(diffDays / 7) + 1;
            
            if (!aparTransactions || aparTransactions.length === 0) {
                return { inflows, outflows };
            }
            
            // Use the SAME logic as scenarios - filter unpaid and use realistic assignment
            const unpaid = aparTransactions.filter(t => t.status !== 'Paid');
            
            unpaid.forEach(transaction => {
                // Calculate due date (same logic as scenarios)
                let dueDate = transaction.due_date;
                
                if (!dueDate && transaction.payment_terms && transaction.invoice_date) {
                    const invoiceDate = new Date(transaction.invoice_date);
                    const calculatedDueDate = new Date(invoiceDate);
                    calculatedDueDate.setDate(calculatedDueDate.getDate() + (transaction.payment_terms || 30));
                    dueDate = calculatedDueDate.toISOString().split('T')[0];
                }
                
                // Use the SAME realistic week assignment as scenarios
                const assignedWeek = assignOverdueToRealisticWeek(transaction, dueDate);
                
                // Only count this transaction if it's assigned to this week
                if (assignedWeek === week) {
                    if (transaction.type === 'AR') {
                        inflows += transaction.amount;
                    } else if (transaction.type === 'AP') {
                        outflows += transaction.amount;
                    }
                }
            });
            
            return { inflows, outflows };
        }
        
        function updateForecastSummary(totalInflows, totalOutflows) {
            const weeklyBurn = (totalOutflows - totalInflows) / 13;
            const dailyBurn = weeklyBurn / 7;
            const monthlyBurn = weeklyBurn * 4.33;
            
            // Calculate runway by finding when cash goes negative
            let runwayDays = null;
            
            for (let i = 0; i < forecastData.length; i++) {
                if (forecastData[i].cashPosition <= 0) {
                    runwayDays = i * 7;
                    break;
                }
            }
            
            let runwayWeeks, runwayMonths;
            
            if (runwayDays !== null) {
                runwayWeeks = Math.floor(runwayDays / 7);
                runwayMonths = Math.ceil(runwayWeeks / 4);
            } else {
                runwayDays = runwayWeeks = runwayMonths = '';
            }
            
            // Update runway displays (keep your existing compact format)
            const cashRunwayDaysEl = document.getElementById('cashRunwayDays');
            const cashRunwayWeeksEl = document.getElementById('cashRunwayWeeks');
            const cashRunwayMonthsEl = document.getElementById('cashRunwayMonths');
            
            if (cashRunwayDaysEl) cashRunwayDaysEl.textContent = runwayDays === '' ? 'Indefinite' : formatCompactNumber(runwayDays);
            if (cashRunwayWeeksEl) cashRunwayWeeksEl.textContent = runwayWeeks === '' ? 'Indefinite' : formatCompactNumber(runwayWeeks);
            if (cashRunwayMonthsEl) cashRunwayMonthsEl.textContent = runwayMonths === '' ? 'Indefinite' : formatCompactNumber(runwayMonths);
            
            // Update burn rate displays (keep your existing compact currency format)
            const dailyBurnEl = document.getElementById('dailyBurn');
            const weeklyBurnEl = document.getElementById('weeklyBurn');
            const monthlyBurnEl = document.getElementById('monthlyBurn');
            
            if (dailyBurnEl) dailyBurnEl.textContent = formatCompactCurrency(Math.abs(dailyBurn), 'IDR');
            if (weeklyBurnEl) weeklyBurnEl.textContent = formatCompactCurrency(Math.abs(weeklyBurn), 'IDR');
            if (monthlyBurnEl) monthlyBurnEl.textContent = formatCompactCurrency(Math.abs(monthlyBurn), 'IDR');
            
            // Update cash flow health indicators (keep your existing logic)
            const health = calculateCashFlowHealth();
            
            const trendElement = document.getElementById('cashFlowTrend');
            if (trendElement) {
                trendElement.className = `trend-indicator-large ${health.trend}`;
                
                let trendIcon = 'fas fa-arrow-right';
                let trendText = 'Stable';
                
                if (health.trend === 'improving') {
                    trendIcon = 'fas fa-arrow-up';
                    trendText = 'Improving';
                } else if (health.trend === 'declining') {
                    trendIcon = 'fas fa-arrow-down';
                    trendText = 'Declining';
                }
                
                trendElement.innerHTML = `<i class="${trendIcon}"></i> ${trendText}`;
            }
            
            // Update payment info (keep your existing compact currency format)
            const biggestPaymentEl = document.getElementById('biggestPayment');
            const largestCollectionEl = document.getElementById('largestCollection');
            
            if (biggestPaymentEl) {
                biggestPaymentEl.textContent = health.biggestPayment > 0 ? formatCompactCurrency(health.biggestPayment, 'IDR') : 'No payments due';
            }
            
            if (largestCollectionEl) {
                largestCollectionEl.textContent = health.largestCollection > 0 ? formatCompactCurrency(health.largestCollection, 'IDR') : 'No collections due';
            }
            
            console.log('=== FORECAST SUMMARY UPDATED ===');
            console.log('Total inflows:', totalInflows);
            console.log('Total outflows:', totalOutflows);
            console.log('Runway days:', runwayDays);
            console.log('Health data:', health);
        }
        
        function createCashFlowChart() {
            const ctx = document.getElementById('cashflowChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (cashflowChart) {
                cashflowChart.destroy();
            }
            
            const labels = forecastData.map(d => d.label);
            const cashPositions = forecastData.map(d => d.cashPosition);
            const inflows = forecastData.map(d => d.inflows);
            const outflows = forecastData.map(d => d.outflows);
            
            cashflowChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Cash Position',
                            data: cashPositions,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointBackgroundColor: function(context) {
                                const value = context.parsed.y;
                                return value >= 0 ? '#3b82f6' : '#ef4444';
                            },
                            pointBorderColor: function(context) {
                                const value = context.parsed.y;
                                return value >= 0 ? '#3b82f6' : '#ef4444';
                            },
                            segment: {
                                borderColor: function(context) {
                                    const current = context.p1.parsed.y;
                                    const previous = context.p0.parsed.y;
                                    // If either point is negative, make the line red
                                    if (current < 0 || previous < 0) {
                                        return '#ef4444';
                                    }
                                    return '#3b82f6';
                                }
                            }
                        },
                        {
                            label: 'Weekly Inflows',
                            data: inflows,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: false,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Weekly Outflows',
                            data: outflows,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: false,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // We have custom legend
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const formatted = new Intl.NumberFormat('id-ID', {
                                        style: 'currency',
                                        currency: 'IDR',
                                        minimumFractionDigits: 0,
                                        maximumFractionDigits: 0
                                    }).format(value);
                                    return context.dataset.label + ': ' + formatted;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Forecast Period'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Amount (IDR)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return new Intl.NumberFormat('id-ID', {
                                        style: 'currency',
                                        currency: 'IDR',
                                        notation: 'compact',
                                        maximumFractionDigits: 1
                                    }).format(value);
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }
        
        function refreshForecast() {
            generateForecastData();
            createCashFlowChart();
        }

        function calculateCashFlowHealth() {
            console.log('=== CALCULATING CASH FLOW HEALTH ===');
            
            if (!aparTransactions || aparTransactions.length === 0) {
                console.log('No aparTransactions available');
                return {
                    trend: 'stable',
                    biggestPayment: 0,
                    largestCollection: 0,
                    biggestPaymentRef: '',
                    largestCollectionRef: ''
                };
            }
            
            // Calculate cash flow trend based on actual cash position trajectory
            const firstWeekCash = forecastData[0]?.cashPosition || 0;
            const lastWeekCash = forecastData[forecastData.length - 1]?.cashPosition || 0;
            
            let trend = 'stable';
            
            // Check if cash goes negative (immediate declining trend)
            const goesNegative = forecastData.some(week => week.cashPosition < 0);
            
            if (goesNegative) {
                trend = 'declining';
            } else {
                // Compare overall trajectory
                const overallChange = (lastWeekCash - firstWeekCash) / firstWeekCash;
                
                if (overallChange > 0.1) { // More than 10% improvement
                    trend = 'improving';
                } else if (overallChange < -0.1) { // More than 10% decline
                    trend = 'declining';
                } else {
                    trend = 'stable';
                }
            }
            
            // Find biggest payment and largest collection from ALL unpaid transactions
            let biggestPayment = 0;
            let largestCollection = 0;
            let biggestPaymentRef = '';
            let largestCollectionRef = '';
            
            // Date range for filtering
            const today = new Date();
            const thirteenWeeksLater = new Date();
            thirteenWeeksLater.setDate(today.getDate() + (13 * 7));
            
            console.log('Date range:', today.toDateString(), 'to', thirteenWeeksLater.toDateString());
            
            const eligibleTransactions = aparTransactions.filter(t => t.status === 'Unpaid' || t.status === 'Overdue');
            console.log('Eligible transactions:', eligibleTransactions.length);
            
            eligibleTransactions.forEach(transaction => {
                const amount = parseFloat(transaction.amount) || 0;
                
                // Calculate due date if missing
                let dueDate = null;
                
                if (transaction.due_date) {
                    dueDate = new Date(transaction.due_date);
                } else if (transaction.invoice_date && transaction.payment_terms) {
                    // Calculate due date: invoice_date + payment_terms
                    const invoiceDate = new Date(transaction.invoice_date);
                    dueDate = new Date(invoiceDate);
                    dueDate.setDate(invoiceDate.getDate() + parseInt(transaction.payment_terms));
                    console.log(`Calculated due date for ${transaction.company}: ${dueDate.toDateString()}`);
                }
                
                // Check if transaction is within our date range OR just take the largest regardless
                let isWithinRange = true; // For now, let's include all transactions
                
                if (dueDate && !isNaN(dueDate.getTime())) {
                    isWithinRange = dueDate >= today && dueDate <= thirteenWeeksLater;
                    console.log(`${transaction.company}: Due ${dueDate.toDateString()}, Within range: ${isWithinRange}`);
                }
                
                if (isWithinRange || !dueDate) { // Include if within range OR no due date
                    if (transaction.type === 'AP' && amount > biggestPayment) {
                        biggestPayment = amount;
                        biggestPaymentRef = transaction.company || transaction.reference || 'Unknown';
                        console.log('New biggest payment:', formatCurrencyFull(biggestPayment, 'IDR'), 'to', biggestPaymentRef);
                    }
                    
                    if (transaction.type === 'AR' && amount > largestCollection) {
                        largestCollection = amount;
                        largestCollectionRef = transaction.company || transaction.reference || 'Unknown';
                        console.log('New largest collection:', formatCurrencyFull(largestCollection, 'IDR'), 'from', largestCollectionRef);
                    }
                }
            });
            
            const result = {
                trend,
                biggestPayment,
                largestCollection,
                biggestPaymentRef,
                largestCollectionRef
            };
            
            console.log('Final cash flow health result:', result);
            return result;
        }

        // Starting Cash Supabase Functions
        async function loadStartingCash() {
            try {
                const { data, error } = await supabase
                    .from('starting_cash_meridash')
                    .select('*')
                    .order('id', { ascending: false })
                    .limit(1);
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    const startingCash = data[0].amount;
                    const input = document.getElementById('startingCash');
                    if (input) {
                        // Format with thousand separators for display
                        input.value = startingCash.toLocaleString('en-US');
                    }
                    console.log('Loaded starting cash:', startingCash);
                    return startingCash;
                } else {
                    // No record exists, create default
                    await saveStartingCash(100000000);
                    return 100000000;
                }
            } catch (error) {
                console.error('Error loading starting cash:', error);
                return 100000000; // Fallback to default
            }
        }
        
        async function saveStartingCash(amount) {
            try {
                // Check if record exists
                const { data: existing, error: selectError } = await supabase
                    .from('starting_cash_meridash')
                    .select('id')
                    .limit(1);
                
                if (selectError) throw selectError;
                
                if (existing && existing.length > 0) {
                    // Update existing record
                    const { error: updateError } = await supabase
                        .from('starting_cash_meridash')
                        .update({ 
                            amount: amount,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', existing[0].id);
                    
                    if (updateError) throw updateError;
                } else {
                    // Insert new record
                    const { error: insertError } = await supabase
                        .from('starting_cash_meridash')
                        .insert([{ 
                            amount: amount,
                            currency: 'IDR'
                        }]);
                    
                    if (insertError) throw insertError;
                }
                
                console.log('Saved starting cash:', amount);
            } catch (error) {
                console.error('Error saving starting cash:', error);
            }
        }

        // Compact number formatting function
        function formatCompactNumber(number) {
            if (number === 0) return '0';
            if (number === '' || number === 'Indefinite') return number;
            
            const absNumber = Math.abs(number);
            const sign = number < 0 ? '-' : '';
            
            if (absNumber >= 1000000000) {
                // Billions
                const billions = absNumber / 1000000000;
                return sign + billions.toFixed(1) + ' Bn';
            } else if (absNumber >= 1000000) {
                // Millions
                const millions = absNumber / 1000000;
                return sign + millions.toFixed(1) + ' Mn';
            } else if (absNumber >= 1000) {
                // Thousands
                const thousands = absNumber / 1000;
                return sign + thousands.toFixed(0) + ' K';
            } else {
                // Less than 1000
                return sign + absNumber.toString();
            }
        }
        
        // Compact currency formatting function
        function formatCompactCurrency(amount, currency = 'IDR') {
            if (amount === 0) return 'Rp  0';
            if (amount === '' || amount === 'Indefinite') return amount;
            
            const absAmount = Math.abs(amount);
            const sign = amount < 0 ? '-' : '';
            const prefix = currency === 'IDR' ? 'Rp  ' : 'Rp ';
            
            if (absAmount >= 1000000000) {
                // Billions
                const billions = absAmount / 1000000000;
                return sign + prefix + billions.toFixed(1) + ' Bn';
            } else if (absAmount >= 1000000) {
                // Millions
                const millions = absAmount / 1000000;
                return sign + prefix + millions.toFixed(1) + ' Mn';
            } else if (absAmount >= 1000) {
                // Thousands
                const thousands = absAmount / 1000;
                return sign + prefix + thousands.toFixed(0) + ' K';
            } else {
                // Less than 1000
                return sign + prefix + absAmount.toLocaleString('en-US');
            }
        }

        // Generate PDF function (shared between download and copy)
        async function generateDashboardPDF() {
            // Get current date for the report
            const currentDate = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        
            // Initialize jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Page dimensions
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 20;
            const contentWidth = pageWidth - (margin * 2);
            
            // Company Header
            doc.setFillColor(30, 41, 59);
            doc.rect(0, 0, pageWidth, 40, 'F');
            
            // Company Logo/Title
            doc.setTextColor(251, 191, 36);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(24);
            doc.text('MontPro', margin, 25);
            
            doc.setTextColor(255, 255, 255);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text('Financial Intelligence Dashboard', margin, 32);
            
            // Report Title
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            doc.text('13-Week Cash Flow Forecast', margin, 55);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(`Generated on ${currentDate}`, margin, 62);
            
            let yPosition = 75;
            
            // Summary Cards Data
            const runwayDays = document.getElementById('cashRunwayDays').textContent;
            const runwayWeeks = document.getElementById('cashRunwayWeeks').textContent;
            const runwayMonths = document.getElementById('cashRunwayMonths').textContent;
            const dailyBurn = document.getElementById('dailyBurn').textContent;
            const weeklyBurn = document.getElementById('weeklyBurn').textContent;
            const monthlyBurn = document.getElementById('monthlyBurn').textContent;
            const trendText = document.getElementById('cashFlowTrend').textContent.trim();
            const biggestPayment = document.getElementById('biggestPayment').textContent;
            const largestCollection = document.getElementById('largestCollection').textContent;
            const startingCash = document.getElementById('startingCash').value;
            
            // Key Metrics Section
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text('Key Metrics', margin, yPosition);
            yPosition += 10;
            
            // Create metrics table
            const metricsData = [
                ['Starting Cash Position', `Rp  ${parseInt(startingCash.replace(/,/g, '')).toLocaleString('en-US')}`],
                ['Cash Runway', `${runwayDays} days | ${runwayWeeks} weeks | ${runwayMonths} months`],
                ['Daily Burn Rate', dailyBurn],
                ['Weekly Burn Rate', weeklyBurn],
                ['Monthly Burn Rate', monthlyBurn],
                ['Cash Flow Trend', trendText],
                ['Largest Upcoming Payment', biggestPayment],
                ['Largest Expected Collection', largestCollection]
            ];
            
            // Draw metrics table
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            
            metricsData.forEach((row, index) => {
                const rowY = yPosition + (index * 7);
                
                if (index % 2 === 0) {
                    doc.setFillColor(248, 250, 252);
                    doc.rect(margin, rowY - 2, contentWidth, 6, 'F');
                }
                
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text(row[0], margin + 2, rowY + 2);
                
                doc.setFont('helvetica', 'normal');
                doc.text(row[1], margin + 80, rowY + 2);
            });
            
            yPosition += (metricsData.length * 7) + 15;
            
            // Capture chart as image
            const chartCanvas = document.getElementById('cashflowChart');
            const chartImage = await html2canvas(chartCanvas, {
                backgroundColor: '#ffffff',
                scale: 2
            });
            
            // Add chart to PDF
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text('Cash Flow Forecast Chart', margin, yPosition);
            yPosition += 10;
            
            const chartImgData = chartImage.toDataURL('image/png');
            const chartWidth = contentWidth;
            const chartHeight = (chartImage.height * chartWidth) / chartImage.width;
            
            if (yPosition + chartHeight > pageHeight - margin) {
                doc.addPage();
                yPosition = margin;
            }
            
            doc.addImage(chartImgData, 'PNG', margin, yPosition, chartWidth, chartHeight);
            
            // Footer
            const footerY = pageHeight - 15;
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text('Generated by MontPro Financial Intelligence Dashboard', margin, footerY);
            doc.text(`Page 1 of 1`, pageWidth - margin - 20, footerY);
            
            return doc;
        }
        
        // Download PDF Function
        async function downloadDashboardPDF() {
            try {
                const downloadBtn = document.querySelector('button[onclick="downloadDashboardPDF()"]');
                const originalText = downloadBtn.innerHTML;
                downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                downloadBtn.disabled = true;
        
                const doc = await generateDashboardPDF();
                doc.save(`Cash_Flow_Forecast_${new Date().toISOString().split('T')[0]}.pdf`);
                
                downloadBtn.innerHTML = originalText;
                downloadBtn.disabled = false;
            } catch (error) {
                console.error('Error downloading PDF:', error);
                const downloadBtn = document.querySelector('button[onclick="downloadDashboardPDF()"]');
                if (downloadBtn) {
                    downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download PDF';
                    downloadBtn.disabled = false;
                }
            }
        }
        
        // Copy Dashboard Content to Clipboard Function
        async function copyDashboardPDF() {
            try {
                const copyBtn = document.querySelector('button[onclick="copyDashboardPDF()"]');
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Copying...';
                copyBtn.disabled = true;
        
                // Get current date
                const currentDate = new Date().toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
        
                // Capture chart as image with higher quality
                const chartCanvas = document.getElementById('cashflowChart');
                const chartImage = await html2canvas(chartCanvas, {
                    backgroundColor: '#ffffff',
                    scale: 3, // Higher scale for better quality
                    useCORS: true,
                    allowTaint: true
                });
        
                // Get all the data
                const runwayDays = document.getElementById('cashRunwayDays').textContent;
                const runwayWeeks = document.getElementById('cashRunwayWeeks').textContent;
                const runwayMonths = document.getElementById('cashRunwayMonths').textContent;
                const dailyBurn = document.getElementById('dailyBurn').textContent;
                const weeklyBurn = document.getElementById('weeklyBurn').textContent;
                const monthlyBurn = document.getElementById('monthlyBurn').textContent;
                const trendText = document.getElementById('cashFlowTrend').textContent.trim();
                const biggestPayment = document.getElementById('biggestPayment').textContent;
                const largestCollection = document.getElementById('largestCollection').textContent;
                const startingCash = document.getElementById('startingCash').value;
        
                // Create HTML content with embedded chart image
                const chartDataUrl = chartImage.toDataURL('image/png', 1.0);
                
                const htmlContent = `
                <div style="font-family: Arial, sans-serif; max-width: 800px;">
                    <div style="background: #1e293b; color: white; padding: 20px; text-align: center; margin-bottom: 20px;">
                        <h1 style="color: #fbbf24; margin: 0; font-size: 24px;">MontPro</h1>
                        <p style="margin: 5px 0 0 0; font-size: 12px;">Financial Intelligence Dashboard</p>
                    </div>
                    
                    <div style="padding: 0 20px;">
                        <h2 style="color: #1e293b; margin-bottom: 10px;">13-Week Cash Flow Forecast</h2>
                        <p style="color: #666; margin-bottom: 20px;">Generated on ${currentDate}</p>
                        
                        <h3 style="color: #1e293b; margin-bottom: 15px;">Key Metrics</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                            <tr style="background: #f8fafc;"><td style="padding: 8px; border: 1px solid #e2e8f0; font-weight: bold;">Starting Cash Position</td><td style="padding: 8px; border: 1px solid #e2e8f0;">Rp  ${parseInt(startingCash.replace(/,/g, '')).toLocaleString('en-US')}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #e2e8f0; font-weight: bold;">Cash Runway</td><td style="padding: 8px; border: 1px solid #e2e8f0;">${runwayDays} days | ${runwayWeeks} weeks | ${runwayMonths} months</td></tr>
                            <tr style="background: #f8fafc;"><td style="padding: 8px; border: 1px solid #e2e8f0; font-weight: bold;">Daily Burn Rate</td><td style="padding: 8px; border: 1px solid #e2e8f0;">${dailyBurn}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #e2e8f0; font-weight: bold;">Weekly Burn Rate</td><td style="padding: 8px; border: 1px solid #e2e8f0;">${weeklyBurn}</td></tr>
                            <tr style="background: #f8fafc;"><td style="padding: 8px; border: 1px solid #e2e8f0; font-weight: bold;">Monthly Burn Rate</td><td style="padding: 8px; border: 1px solid #e2e8f0;">${monthlyBurn}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #e2e8f0; font-weight: bold;">Cash Flow Trend</td><td style="padding: 8px; border: 1px solid #e2e8f0;">${trendText}</td></tr>
                            <tr style="background: #f8fafc;"><td style="padding: 8px; border: 1px solid #e2e8f0; font-weight: bold;">Largest Upcoming Payment</td><td style="padding: 8px; border: 1px solid #e2e8f0;">${biggestPayment}</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #e2e8f0; font-weight: bold;">Largest Expected Collection</td><td style="padding: 8px; border: 1px solid #e2e8f0;">${largestCollection}</td></tr>
                        </table>
                        
                        <h3 style="color: #1e293b; margin-bottom: 15px;">Cash Flow Forecast Chart</h3>
                        <img src="${chartDataUrl}" style="width: 100%; max-width: 600px; height: auto; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 20px;" alt="Cash Flow Forecast Chart">
                        
                        <p style="color: #666; font-size: 12px; margin-top: 20px;">Generated by MontPro Financial Intelligence Dashboard</p>
                    </div>
                </div>`;
        
                // Create plain text version
                const textContent = `MontPro - Financial Intelligence Dashboard
        13-Week Cash Flow Forecast
        Generated on ${currentDate}
        
        KEY METRICS:
        Starting Cash Position: Rp  ${parseInt(startingCash.replace(/,/g, '')).toLocaleString('en-US')}
        Cash Runway: ${runwayDays} days | ${runwayWeeks} weeks | ${runwayMonths} months
        Daily Burn Rate: ${dailyBurn}
        Weekly Burn Rate: ${weeklyBurn}
        Monthly Burn Rate: ${monthlyBurn}
        Cash Flow Trend: ${trendText}
        Largest Upcoming Payment: ${biggestPayment}
        Largest Expected Collection: ${largestCollection}
        
        Generated by MontPro Financial Intelligence Dashboard`;
        
                // Copy to clipboard with embedded image
                const clipboardItem = new ClipboardItem({
                    'text/html': new Blob([htmlContent], { type: 'text/html' }),
                    'text/plain': new Blob([textContent], { type: 'text/plain' })
                });
        
                await navigator.clipboard.write([clipboardItem]);
                
                copyBtn.innerHTML = originalText;
                copyBtn.disabled = false;
        
            } catch (error) {
                console.error('Error copying to clipboard:', error);
                
                const copyBtn = document.querySelector('button[onclick="copyDashboardPDF()"]');
                if (copyBtn) {
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy Content';
                    copyBtn.disabled = false;
                }
            }
        }

        // Export AP/AR transactions to CSV
        function exportAPARToCSV() {
            try {
                const exportBtn = document.querySelector('button[onclick="exportAPARToCSV()"]');
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
                exportBtn.disabled = true;
        
                // Get filtered transactions (respects current filters)
                const filteredTransactions = getFilteredTransactions();
                
                if (filteredTransactions.length === 0) {
                    exportBtn.innerHTML = originalText;
                    exportBtn.disabled = false;
                    return;
                }
        
                // CSV headers
                const headers = [
                    'Type',
                    'Reference', 
                    'Company',
                    'Description',
                    'Amount',
                    'Currency',
                    'Invoice Date',
                    'Due Date',
                    'Payment Terms',
                    'Status',
                    'Days Outstanding',
                    'Created Date'
                ];
        
                // Convert transactions to CSV format
                const csvRows = [headers.join(',')];
                
                filteredTransactions.forEach(transaction => {
                    // Calculate due date
                    let dueDate = '';
                    if (transaction.due_date) {
                        dueDate = formatDateForCSV(transaction.due_date);
                    } else if (transaction.invoice_date && transaction.payment_terms) {
                        const invoiceDate = new Date(transaction.invoice_date);
                        const calculatedDueDate = new Date(invoiceDate);
                        calculatedDueDate.setDate(calculatedDueDate.getDate() + (transaction.payment_terms || 30));
                        dueDate = formatDateForCSV(calculatedDueDate);
                    }
        
                    // Calculate days outstanding
                    let daysOutstanding = '';
                    if (dueDate && (transaction.status === 'Unpaid' || transaction.status === 'Overdue')) {
                        const today = new Date();
                        const due = new Date(dueDate);
                        const diffTime = today - due;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        daysOutstanding = diffDays > 0 ? diffDays : 0;
                    }
        
                    const row = [
                        escapeCSVField(transaction.type || ''),
                        escapeCSVField(transaction.reference || ''),
                        escapeCSVField(transaction.company || ''),
                        escapeCSVField(transaction.description || ''),
                        transaction.amount || 0,
                        transaction.currency || 'IDR',
                        formatDateForCSV(transaction.invoice_date),
                        dueDate,
                        transaction.payment_terms || 30,
                        escapeCSVField(transaction.status || ''),
                        daysOutstanding,
                        formatDateForCSV(transaction.created_at)
                    ];
                    
                    csvRows.push(row.join(','));
                });
        
                // Create and download CSV
                const csvContent = csvRows.join('\n');
                const currentDate = new Date().toISOString().split('T')[0];
                const filename = `AP_AR_Transactions_${currentDate}.csv`;
                
                downloadCSVFile(csvContent, filename);
                
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;
        
            } catch (error) {
                console.error('Error exporting CSV:', error);
                
                const exportBtn = document.querySelector('button[onclick="exportAPARToCSV()"]');
                if (exportBtn) {
                    exportBtn.innerHTML = '<i class="fas fa-file-csv"></i> Export CSV';
                    exportBtn.disabled = false;
                }
            }
        }
        
        // Helper functions for CSV export
        function formatDateForCSV(dateValue) {
            if (!dateValue) return '';
            const date = new Date(dateValue);
            if (isNaN(date.getTime())) return '';
            return date.toISOString().split('T')[0]; // YYYY-MM-DD format
        }
        
        function escapeCSVField(field) {
            if (field === null || field === undefined) return '';
            const stringField = String(field);
            if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
                return `"${stringField.replace(/"/g, '""')}"`;
            }
            return stringField;
        }
        
        function downloadCSVFile(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // Scenario Analysis - New Bucket-based Structure
        let scenarioData = [];
        let originalData = [];
        let changeLog = [];
        let isDragging = false;
        
        // Initialize scenario analysis when tab is switched
       function initializeScenarioAnalysis() {
            // Get base case data from existing forecast
            scenarioState.baseCase = getBaseCaseData();
            scenarioState.currentScenario = JSON.parse(JSON.stringify(scenarioState.baseCase));
            updateScenarioComparison();
        }
        
        function loadScenarioTransactions() {
            if (!aparTransactions || aparTransactions.length === 0) {
                console.warn("AP/AR data not available for scenarios.");
                return;
            }
            
            // Filter for only unpaid transactions
            const unpaidTransactions = aparTransactions.filter(
                t => t.status === 'Unpaid' || t.status === 'Overdue'
            );
        
            // Convert to the scenario data format and assign to weeks
            originalData = unpaidTransactions.map(transaction => {
                let dueDate = transaction.due_date;
                if (!dueDate && transaction.payment_terms && transaction.invoice_date) {
                    const invoiceDate = new Date(transaction.invoice_date);
                    dueDate = new Date(invoiceDate.getTime() + (parseInt(transaction.payment_terms) * 24 * 60 * 60 * 1000)).toISOString().split('T')[0];
                }
                const weekNumber = assignOverdueToRealisticWeek(transaction, dueDate);
                return {
                    id: transaction.id.toString(),
                    type: transaction.type,
                    vendor: transaction.company,
                    amount: Math.abs(transaction.amount),
                    description: transaction.description,
                    originalWeek: weekNumber,
                    currentWeek: weekNumber,
                };
            });
        
            scenarioData = JSON.parse(JSON.stringify(originalData));
            populateTransactionBuckets();
        }

        function generateScenarioImpactForecastData() {
            const startingCash = getStartingCash();
            let forecast = [];
            let currentCash = startingCash;
        
            for (let i = 1; i <= 13; i++) {
                const weeklyFlows = calculateScenarioWeeklyFlows(i);
                currentCash += weeklyFlows.inflows - weeklyFlows.outflows;
                forecast.push({
                    week: `Week ${i}`,
                    cashPosition: currentCash,
                });
            }
            return forecast;
        }

        function createScenarioImpactChart() {
            const forecast = generateScenarioImpactForecastData();
            const canvas = document.getElementById('scenarioImpactChart');
            if (!canvas) {
                console.error('Scenario Impact Chart canvas not found!');
                return;
            }
            const ctx = canvas.getContext('2d');
        
            if (scenarioImpactChartInstance) {
                scenarioImpactChartInstance.destroy();
            }
        
            scenarioImpactChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: forecast.map(d => d.week),
                    datasets: [{
                        label: 'Projected Cash Position',
                        data: forecast.map(d => d.cashPosition),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: (context) => context.raw >= 0 ? '#3b82f6' : '#ef4444',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `Cash: Rp ${context.raw.toLocaleString()}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: (value) => `Rp ${formatNumber(value)}`
                            }
                        }
                    }
                }
            });
        }

        function updateScenarioImpactChart() {
            createScenarioImpactChart();
        }
        
        function processTransactionsForScenario() {
            console.log('Processing', aparTransactions.length, 'transactions for scenario analysis');
            
            // Filter for unpaid transactions (same logic as other tabs)
            const unpaidTransactions = aparTransactions.filter(transaction => 
                transaction.status !== 'Paid'
            );
            
            console.log('Found', unpaidTransactions.length, 'unpaid transactions');
            
            // Convert to scenario format and assign to realistic weeks
            originalData = unpaidTransactions.map(transaction => {
                // Calculate due date if not provided (same logic as before)
                let dueDate = transaction.due_date;
                
                if (!dueDate && transaction.payment_terms && transaction.invoice_date) {
                    const invoiceDate = new Date(transaction.invoice_date);
                    const calculatedDueDate = new Date(invoiceDate);
                    calculatedDueDate.setDate(calculatedDueDate.getDate() + (transaction.payment_terms || 30));
                    dueDate = calculatedDueDate.toISOString().split('T')[0];
                }
                
                // NEW: Use realistic week assignment instead of parked
                let weekNumber = assignOverdueToRealisticWeek(transaction, dueDate);
                
                return {
                    id: transaction.id,
                    type: transaction.type,
                    vendor: transaction.company,
                    amount: Math.abs(transaction.amount),
                    description: transaction.description,
                    originalWeek: weekNumber,
                    currentWeek: weekNumber,
                    category: transaction.category || 'General',
                    dueDate: dueDate
                };
            });
            
            // Copy to working scenario data
            scenarioData = [...originalData];
            console.log('Final scenario data:', scenarioData.length, 'transactions');
            console.log('Parked transactions:', scenarioData.filter(t => t.currentWeek === 'parked').length);
            console.log('Realistically placed transactions:', scenarioData.filter(t => t.currentWeek !== 'parked').length);
        }
        
        // NEW: Realistic week assignment function
        function assignOverdueToRealisticWeek(transaction, dueDate) {
            if (!dueDate) return 'parked'; // No due date - still use parked
            
            const today = new Date();
            const transactionDueDate = new Date(dueDate);
            
            // If transaction is not overdue, calculate which week it falls in
            if (transactionDueDate >= today) {
                const diffTime = transactionDueDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const week = Math.ceil(diffDays / 7);
                
                // If it falls within 13 weeks, use that week
                if (week <= 13) {
                    return week;
                } else {
                    // Too far in future, place in week 13
                    return 13;
                }
            }
            
            // For overdue transactions, use realistic collection/payment assumptions
            const weeksOverdue = Math.floor((today - transactionDueDate) / (7 * 24 * 60 * 60 * 1000));
            
            if (transaction.type === 'AR') {
                // Overdue AR: Spread across weeks 1-4 based on how overdue
                if (weeksOverdue <= 2) return 1;      // Recently overdue
                else if (weeksOverdue <= 4) return 2; // Moderately overdue  
                else if (weeksOverdue <= 8) return 3; // Quite overdue
                else return 4;                        // Very overdue
            } else if (transaction.type === 'AP') {
                // Overdue AP: Spread across weeks 1-2 (we need to pay sooner)
                if (weeksOverdue <= 4) return 1;      // Pay soon
                else return 2;                        // Pay very soon
            }
            
            // Default fallback for edge cases
            return 1;
        }
        
        // Function to get real AP/AR data (connects to existing system)
        function populateTransactionBuckets() {
            // Clear all buckets first
            for (let week = 1; week <= 13; week++) {
                const bucket = document.getElementById(`bucket-week-${week}`);
                if (bucket) bucket.innerHTML = '';
            }
            
            const parkedBucket = document.getElementById('bucket-week-parked');
            if (parkedBucket) parkedBucket.innerHTML = '';
            
            // Populate buckets with transactions
            scenarioData.forEach(transaction => {
                const card = createBucketTransactionCard(transaction);
                
                if (transaction.currentWeek === 'parked' || transaction.currentWeek > 13) {
                    const parkedBucket = document.getElementById('bucket-week-parked');
                    if (parkedBucket) {
                        parkedBucket.appendChild(card);
                    }
                } else {
                    const bucket = document.getElementById(`bucket-week-${transaction.currentWeek}`);
                    if (bucket) bucket.appendChild(card);
                }
            });
        }
        
        function createBucketTransactionCard(transaction) {
            const card = document.createElement('div');
            card.className = `bucket-transaction-card ${transaction.type.toLowerCase()}-card`;
            card.draggable = true;
            card.dataset.transactionId = transaction.id;
            
            card.innerHTML = `
                <div class="bucket-card-header">
                    <div class="bucket-vendor-name">${transaction.vendor}</div>
                    <div class="bucket-amount">Rp ${formatAmount(transaction.amount)}</div>
                </div>
                <div class="bucket-description">${transaction.description}</div>
            `;
            
            return card;
        }
        
        function formatAmount(amount) {
            if (amount >= 1000000) {
                return `${(amount / 1000000).toFixed(1)}M`;
            } else if (amount >= 1000) {
                return `${(amount / 1000).toFixed(0)}K`;
            }
            return amount.toLocaleString();
        }
        
        function setupBucketDragAndDrop() {
            document.addEventListener('dragstart', handleBucketDragStart);
            document.addEventListener('dragover', handleBucketDragOver);
            document.addEventListener('dragleave', handleBucketDragLeave);  // Add this line
            document.addEventListener('drop', handleBucketDrop);
            document.addEventListener('dragend', handleBucketDragEnd);
        }
        
        function handleBucketDragStart(e) {
            if (!e.target.classList.contains('bucket-transaction-card')) return;
            
            isDragging = true;
            e.target.classList.add('dragging');
            e.dataTransfer.setData('text/plain', e.target.dataset.transactionId);
            
            // Highlight all drop zones
            document.querySelectorAll('.week-bucket').forEach(bucket => {
                bucket.classList.add('highlight');
            });

            if (e.target.dataset.financing === 'true') {
                e.target.classList.add('dragging-financing');
            }
        }
        
        function handleBucketDragOver(e) {
            if (!isDragging) return;
            e.preventDefault();
            
            // Remove drag-over from all buckets first
            document.querySelectorAll('.week-bucket').forEach(bucket => {
                bucket.classList.remove('drag-over');
            });
            
            // Add drag-over only to the current bucket being hovered
            const bucket = e.target.closest('.week-bucket');
            if (bucket) {
                bucket.classList.add('drag-over');
            }
        }

        function handleBucketDragLeave(e) {
            if (!isDragging) return;
            
            const bucket = e.target.closest('.week-bucket');
            if (bucket) {
                bucket.classList.remove('drag-over');
            }
        }
        
        function handleBucketDrop(e) {
            e.preventDefault();
            const bucket = e.target.closest('.week-bucket');
            if (!bucket) return;
        
            const transactionId = e.dataTransfer.getData('text/plain');
            const newWeek = bucket.dataset.week;
            const transaction = scenarioData.find(t => t.id === transactionId);
        
            if (transaction && transaction.currentWeek != newWeek) {
                const oldWeek = transaction.currentWeek;
                transaction.currentWeek = newWeek;
        
                addToChangeLog(transaction, oldWeek, newWeek);
                populateTransactionBuckets(); // Re-render the cards in their new positions
                updateScenarioImpactChart(); // Update the main cash flow chart
                updateImpactAnalysis();      // <-- FIX: This call updates the Impact Analysis card.
                calculateScenarioImpact();   // <-- FIX: This call updates the Projected Impact card.
            }
            bucket.classList.remove('drag-over');
        }
        
        function handleBucketDragEnd(e) {
            if (!e.target.classList.contains('bucket-transaction-card')) return;
            
            isDragging = false;
            e.target.classList.remove('dragging');
            
            // Remove highlights
            document.querySelectorAll('.week-bucket').forEach(bucket => {
                bucket.classList.remove('highlight', 'drag-over');
            });

            if (e.target.dataset.financing === 'true') {
                calculateScenarioImpact();
            }
            
            draggedElement = null;
        }
        
        function addToChangeLog(transaction, oldWeek, newWeek) {
            const timestamp = new Date().toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            let logMessage = '';
            const weekDisplay = (week) => week === 'parked' ? 'Parked' : `Week ${week}`;
            
            if (newWeek === 'parked') {
                logMessage = `${timestamp} - ${transaction.vendor} moved to Parked (beyond 13 weeks)`;
            } else if (oldWeek === 'parked') {
                logMessage = `${timestamp} - ${transaction.vendor} moved from Parked to ${weekDisplay(newWeek)}`;
            } else {
                logMessage = `${timestamp} - ${transaction.vendor} moved from ${weekDisplay(oldWeek)}  ${weekDisplay(newWeek)}`;
            }
            
            const logEntry = {
                id: Date.now(),
                timestamp,
                message: logMessage,
                transaction: transaction.vendor,
                oldWeek,
                newWeek,
                type: transaction.type
            };
            
            changeLog.unshift(logEntry); // Add to beginning
            updateChangeLogDisplay();
        }
        
        function updateChangeLogDisplay() {
            const logContent = document.getElementById('changeLogContent');
            if (!logContent) return;
            
            if (changeLog.length === 0) {
                logContent.innerHTML = `
                    <div class="log-item neutral">
                        <span>Move transactions between weeks to see changes</span>
                    </div>
                `;
                return;
            }
            
            logContent.innerHTML = changeLog.slice(0, 10).map(entry => `
                <div class="log-item moved">
                    <span>${entry.message}</span>
                </div>
            `).join('');
        }
        
        function clearChangeLog() {
            changeLog = [];
            updateChangeLogDisplay();
        }
        
        function updateImpactAnalysis() {
            const impactContent = document.getElementById('impactAnalysisContent');
            if (!impactContent) return;
        
            // Find all transactions that have been moved from their original week.
            const changes = scenarioData.filter(t => t.currentWeek !== t.originalWeek);
        
            if (changes.length === 0) {
                impactContent.innerHTML = `
                    <div class="impact-item neutral">
                        <span class="impact-icon"></span>
                        <span>Move transactions to see potential impacts</span>
                    </div>
                `;
                return;
            }
        
            let impactsHTML = '';
            changes.forEach(change => {
                const isDelayed = (change.currentWeek === 'parked') || 
                                  (change.currentWeek > change.originalWeek);
                
                let impactType = isDelayed ? 'risk' : 'benefit';
                let icon = isDelayed ? '' : '';
                let text = '';
        
                if (change.type === 'AP') { // Accounts Payable (Money Out)
                    text = isDelayed ? 
                        `Payment to <strong>${change.vendor}</strong> delayed, improving short-term cash. Check any potential penalties` :
                        `Payment to <strong>${change.vendor}</strong> accelerated, check for early payment discounts.`;
                } else { // Accounts Receivable (Money In)
                     text = isDelayed ? 
                        `Collection from <strong>${change.vendor}</strong> delayed, negatively impacting cash flow.` :
                        `Collection from <strong>${change.vendor}</strong> accelerated, improving cash position.`;
                     if(isDelayed) impactType = 'risk'; else impactType = 'benefit';
                }
                
                impactsHTML += `
                    <div class="impact-item ${impactType}">
                        <span class="impact-icon">${icon}</span>
                        <span>${text}</span>
                    </div>
                `;
            });
            impactContent.innerHTML = impactsHTML;
        }
        
        function resetScenario() {
            console.log('Resetting scenario...');
            console.log('Original data:', originalData);
            
            // Reset data to original state - deep copy to avoid reference issues
            scenarioData = originalData.map(transaction => ({
                ...transaction,
                currentWeek: transaction.originalWeek
            }));
            
            console.log('Reset scenario data:', scenarioData);
            
            // Clear change log
            changeLog = [];
            
            // Update all displays
            populateTransactionBuckets();
            updateChangeLogDisplay();
            updateImpactAnalysis();
            updateScenarioChart();
            
            // Reset bucket colors to original state
            document.querySelectorAll('.week-bucket').forEach(bucket => {
                bucket.style.background = '';
                bucket.style.color = '';
                bucket.classList.remove('drag-over', 'highlight');
            });
            
            console.log('Scenario reset completed');
        }
        
        // Chart functions (reusing dashboard chart logic)
        function updateScenarioChart() {
            console.log('Updating scenario chart...');
            generateScenarioForecastData();
            createScenarioCashFlowChart();
        }
        
        function generateScenarioForecastData() {
            console.log('Generating scenario forecast data...');
            
            // Use the same logic as your existing generateForecastData but with scenario data
            const startingCash = getStartingCash();
            const today = new Date();
            window.scenarioForecastData = [];
            
            let currentCash = startingCash;
            
            for (let week = 0; week < 13; week++) {
                const weekDate = new Date(today);
                weekDate.setDate(today.getDate() + (week * 7));
                
                // Calculate weekly flows based on scenario data
                const weeklyFlows = calculateScenarioWeeklyFlows(week + 1);
                
                currentCash += weeklyFlows.inflows - weeklyFlows.outflows;
                
                window.scenarioForecastData.push({
                    week: week + 1,
                    date: weekDate,
                    cashPosition: currentCash,
                    inflows: weeklyFlows.inflows,
                    outflows: weeklyFlows.outflows,
                    label: `Week ${week + 1}`
                });
            }
            
            console.log('Generated scenario forecast data:', window.scenarioForecastData);
            return window.scenarioForecastData;
        }
        
        function createScenarioCashFlowChart() {
            console.log('Creating scenario cash flow chart...');
            
            // THIS IS THE CORRECTED LINE - it now targets the new ID.
            const ctx = document.getElementById('scenarioImpactChart').getContext('2d');
        
            const forecast = generateScenarioForecastData(); // This function is correct.
        
            if (scenarioChart) {
                scenarioChart.destroy(); // Destroy previous instance.
            }
        
            scenarioChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: forecast.map(d => d.week),
                    datasets: [{
                        label: 'Projected Cash Position',
                        data: forecast.map(d => d.cashPosition),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: (context) => context.raw >= 0 ? '#3b82f6' : '#ef4444',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `Cash: Rp ${context.raw.toLocaleString()}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                // Using your existing formatNumber function for consistency
                                callback: (value) => `Rp ${formatNumber(value)}`
                            }
                        }
                    }
                }
            });
        }
        function createScenarioChartJS() {
            const ctx = document.getElementById('scenarioForecastChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (window.scenarioChart) {
                window.scenarioChart.destroy();
            }
            
            const data = window.scenarioForecastData || [];
            if (data.length === 0) {
                console.log('No scenario data to chart');
                return;
            }
            
            const labels = data.map(d => d.label || `Week ${d.week}`);
            const cashPositions = data.map(d => d.cashPosition);
            
            window.scenarioChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Scenario Cash Position',
                        data: cashPositions,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: function(context) {
                            const value = context.parsed.y;
                            return value >= 0 ? '#3b82f6' : '#ef4444';
                        },
                        pointBorderColor: function(context) {
                            const value = context.parsed.y;
                            return value >= 0 ? '#3b82f6' : '#ef4444';
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Scenario: 13-Week Cash Flow Forecast',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return formatCompactCurrency(value, 'IDR');
                                }
                            },
                            grid: {
                                color: '#e5e7eb'
                            }
                        },
                        x: {
                            grid: {
                                color: '#e5e7eb'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
            
            console.log('Chart.js scenario chart created successfully');
        }
        
        function createScenarioCanvasChart() {
            // Your existing canvas drawing code here as fallback
            const canvas = document.getElementById('scenarioForecastChart');
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#6b7280';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Scenario Chart Loading...', canvas.width / 2, canvas.height / 2);
        }
        
        function formatCurrency(value) {
            if (value >= 1000000000) {
                return `Rp ${(value / 1000000000).toFixed(1)}B`;
            } else if (value >= 1000000) {
                return `Rp ${(value / 1000000).toFixed(1)}M`;
            } else if (value >= 1000) {
                return `Rp ${(value / 1000).toFixed(0)}K`;
            }
            return `Rp ${Math.round(value).toLocaleString()}`;
        }

        function calculateScenarioWeeklyFlows(week) {
            let inflows = 0;
            let outflows = 0;
            
            // Calculate based on current scenario data - exclude parked transactions
            scenarioData.forEach(transaction => {
                if (transaction.currentWeek == week && transaction.currentWeek !== 'parked') {
                    if (transaction.type === 'AR') {
                        inflows += transaction.amount;
                    } else {
                        outflows += transaction.amount;
                    }
                }
            });
            
            return { inflows, outflows };
        }

        // Track if changes have been made
        let hasScenarioChanges = false;
        
        function addToChangeLog(transaction, oldWeek, newWeek) {
            const timestamp = new Date().toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            let logMessage = '';
            const weekDisplay = (week) => week === 'parked' ? 'Parked' : `Week ${week}`;
            
            if (newWeek === 'parked') {
                logMessage = `${timestamp} - ${transaction.vendor} moved to Parked (beyond 13 weeks)`;
            } else if (oldWeek === 'parked') {
                logMessage = `${timestamp} - ${transaction.vendor} moved from Parked to ${weekDisplay(newWeek)}`;
            } else {
                logMessage = `${timestamp} - ${transaction.vendor} moved from ${weekDisplay(oldWeek)}  ${weekDisplay(newWeek)}`;
            }
            
            const logEntry = {
                id: Date.now(),
                timestamp,
                message: logMessage,
                transaction: transaction.vendor,
                oldWeek,
                newWeek,
                type: transaction.type
            };
            
            changeLog.unshift(logEntry);
            hasScenarioChanges = true;
            updateChangeLogDisplay();
            updateApplyButton();
        }
        
        function updateApplyButton() {
            const applyBtn = document.getElementById('applyChangesBtn');
            if (applyBtn) {
                applyBtn.disabled = !hasScenarioChanges;
            }
        }
        
        function resetScenario() {
            console.log('Resetting scenario...');
            
            // Reset data to original state
            scenarioData = originalData.map(transaction => ({
                ...transaction,
                currentWeek: transaction.originalWeek
            }));
            
            // Clear change log and reset flags
            changeLog = [];
            hasScenarioChanges = false;
            
            // Update displays
            populateTransactionBuckets();
            updateChangeLogDisplay();
            updateImpactAnalysis();
            updateScenarioChart();
            updateApplyButton();
            
            // Reset bucket colors
            document.querySelectorAll('.week-bucket').forEach(bucket => {
                bucket.style.background = '';
                bucket.style.color = '';
                bucket.classList.remove('drag-over', 'highlight');
            });
            
            console.log('Scenario reset completed');
        }
        
        // Update the switchAPARTab function to initialize the new scenario analysis
        function switchAPARTab(tabName) {
            const section = document.getElementById('ap-ar-section');
            section.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            section.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            section.querySelector('#' + tabName + '-tab').classList.add('active');
            section.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        
            if (tabName === 'aging') {
                updateAgingAnalysis();
            }
        
            // When the scenarios tab is clicked...
            if (tabName === 'scenarios') {
                setTimeout(() => {
                    // ...call the NEW, dedicated function.
                    initializeCashFlowScenario(); // <-- THIS IS THE ONLY LINE TO CHANGE
                }, 100);
            }
        }
        
        // Calculate aging for transactions
        function calculateAging(transactions) {
            const today = new Date();
            const aging = {
                '0-30': { transactions: [], total: 0 },
                '30-60': { transactions: [], total: 0 },
                '60-90': { transactions: [], total: 0 },
                '90-120': { transactions: [], total: 0 },
                '120+': { transactions: [], total: 0 }
            };
        
            transactions.forEach(transaction => {
                if (transaction.status === 'Paid') return; // Skip paid transactions
                
                // Calculate due date
                let dueDate;
                if (transaction.due_date) {
                    dueDate = new Date(transaction.due_date);
                } else if (transaction.invoice_date && transaction.payment_terms) {
                    const invoiceDate = new Date(transaction.invoice_date);
                    dueDate = new Date(invoiceDate);
                    dueDate.setDate(dueDate.getDate() + (transaction.payment_terms || 30));
                } else {
                    return; // Skip if no due date can be calculated
                }
        
                // Calculate days outstanding
                const diffTime = today - dueDate;
                const daysOutstanding = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
                // Categorize into aging buckets
                let bucket;
                if (daysOutstanding <= 30) {
                    bucket = '0-30';
                } else if (daysOutstanding <= 60) {
                    bucket = '30-60';
                } else if (daysOutstanding <= 90) {
                    bucket = '60-90';
                } else if (daysOutstanding <= 120) {
                    bucket = '90-120';
                } else {
                    bucket = '120+';
                }
        
                aging[bucket].transactions.push({
                    ...transaction,
                    daysOutstanding: daysOutstanding
                });
                aging[bucket].total += transaction.amount;
            });
        
            return aging;
        }
        
        // Update aging analysis with better error handling
        function updateAgingAnalysis() {
            console.log('=== UPDATING AGING ANALYSIS ===');
            console.log('aparTransactions:', aparTransactions?.length || 0);
            
            if (!aparTransactions || aparTransactions.length === 0) {
                console.warn('No aparTransactions available, showing empty state');
                showEmptyAgingState();
                return;
            }
        
            try {
                // Separate AR and AP transactions
                const arTransactions = aparTransactions.filter(t => t.type === 'AR');
                const apTransactions = aparTransactions.filter(t => t.type === 'AP');
                
                console.log('AR transactions:', arTransactions.length);
                console.log('AP transactions:', apTransactions.length);
        
                // Calculate aging for both
                const arAging = calculateAging(arTransactions);
                const apAging = calculateAging(apTransactions);
                
                console.log('Calculated aging data:', { arAging, apAging });
        
                // Update aging tables
                updateAgingTables(arAging, apAging);
                
                // Update additional analytics
                updateAdditionalAnalytics(arTransactions, apTransactions);
                
                // Create charts with validation
                createAgingChartsWithValidation(arAging, apAging);
                
            } catch (error) {
                console.error('Error in updateAgingAnalysis:', error);
                showEmptyAgingState('Error processing aging data');
            }
        }
        
        // Add this new function to handle empty/error states
        function showEmptyAgingState(message = 'No aging data available') {
            console.log('Showing empty aging state:', message);
            
            // Clear aging tables
            const arTableBody = document.getElementById('arAgingTableBody');
            const apTableBody = document.getElementById('apAgingTableBody');
            
            if (arTableBody) {
                arTableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: #6b7280; padding: 2rem;">${message}</td></tr>`;
            }
            if (apTableBody) {
                apTableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: #6b7280; padding: 2rem;">${message}</td></tr>`;
            }
            
            // Show message on charts
            showAgingChartError(message);
        }
        
        // Add this improved chart creation function
        function createAgingChartsWithValidation(arAging, apAging) {
            console.log('Creating aging charts with validation...');
            
            if (!arAging || !apAging) {
                console.error('Missing aging data for charts');
                showAgingChartError('Unable to create charts - missing data');
                return;
            }
            
            const buckets = ['0-30', '30-60', '60-90', '90-120', '120+'];
            const bucketLabels = ['0-30 Days', '30-60 Days', '60-90 Days', '90-120 Days', '120+ Days'];
            
            try {
                // AR Chart with data validation
                const arData = buckets.map(bucket => {
                    const bucketData = arAging[bucket];
                    return (bucketData && typeof bucketData.total === 'number') ? bucketData.total : 0;
                });
                
                // AP Chart with data validation
                const apData = buckets.map(bucket => {
                    const bucketData = apAging[bucket];
                    return (bucketData && typeof bucketData.total === 'number') ? bucketData.total : 0;
                });
                
                console.log('Chart data prepared:', { arData, apData });
                
                // Only create charts if canvas elements exist
                const arCanvas = document.getElementById('arAgingChart');
                const apCanvas = document.getElementById('apAgingChart');
                
                if (arCanvas && apCanvas) {
                    createAgingChart('arAgingChart', 'Accounts Receivable', arData, bucketLabels, '#10b981');
                    createAgingChart('apAgingChart', 'Accounts Payable', apData, bucketLabels, '#ef4444');
                    console.log('Aging charts created successfully');
                } else {
                    console.error('Chart canvas elements not found');
                    showAgingChartError('Chart containers not found');
                }
                
            } catch (error) {
                console.error('Error creating aging charts:', error);
                showAgingChartError('Failed to create charts');
            }
        }
        
        // Add the error display function
        function showAgingChartError(message) {
            const canvases = ['arAgingChart', 'apAgingChart'];
            
            canvases.forEach(canvasId => {
                const canvas = document.getElementById(canvasId);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    
                    // Clear canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Set text style
                    ctx.fillStyle = '#6b7280';
                    ctx.font = '14px Inter, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    // Draw message
                    ctx.fillText(message, canvas.width / 2, canvas.height / 2);
                }
            });
        }
        
        // Update summary cards
        function updateAgingSummaryCards(arAging, apAging) {
            const buckets = ['0-30', '30-60', '60-90', '90-120', '120+'];
            
            buckets.forEach(bucket => {
                const totalAmount = arAging[bucket].total + apAging[bucket].total;
                const totalCount = arAging[bucket].transactions.length + apAging[bucket].transactions.length;
                
                document.getElementById(`aging-${bucket.replace('+', '-plus')}-amount`).textContent = 
                    formatCompactCurrency(totalAmount, 'IDR');
                document.getElementById(`aging-${bucket.replace('+', '-plus')}-count`).textContent = 
                    `${totalCount} transactions`;
            });
        }
        
        // Update aging tables
        function updateAgingTables(arAging, apAging) {
            updateAgingTable('arAgingTableBody', arAging, 'AR');
            updateAgingTable('apAgingTableBody', apAging, 'AP');
        }
        
        // Updated updateAgingTable function with total row
        function updateAgingTable(tableBodyId, aging, type) {
            const tableBody = document.getElementById(tableBodyId);
            tableBody.innerHTML = '';
        
            // Group by company/vendor
            const companyTotals = {};
            
            Object.keys(aging).forEach(bucket => {
                aging[bucket].transactions.forEach(transaction => {
                    const company = transaction.company || 'Unknown';
                    if (!companyTotals[company]) {
                        companyTotals[company] = {
                            '0-30': 0, '30-60': 0, '60-90': 0, '90-120': 0, '120+': 0, total: 0,
                            transactions: [] // Store transactions for actions
                        };
                    }
                    companyTotals[company][bucket] += transaction.amount;
                    companyTotals[company].total += transaction.amount;
                    companyTotals[company].transactions.push({...transaction, bucket});
                });
            });
        
            // Sort by total amount descending
            const sortedCompanies = Object.entries(companyTotals)
                .sort((a, b) => b[1].total - a[1].total);
        
            // Add company rows with improved formatting
            sortedCompanies.forEach(([company, amounts]) => {
                const row = document.createElement('tr');
                
                // Determine priority level based on overdue amounts
                const overdueAmount = amounts['60-90'] + amounts['90-120'] + amounts['120+'];
                const priorityLevel = getPriorityLevel(overdueAmount, amounts.total);
                
                row.innerHTML = `
                    <td class="company-cell">
                        <div class="company-info">
                            <span class="company-name">${company}</span>
                            ${priorityLevel.badge}
                        </div>
                    </td>
                    <td class="amount-cell ${getBucketClass('0-30')}">${formatCleanAmount(amounts['0-30'])}</td>
                    <td class="amount-cell ${getBucketClass('30-60')}">${formatCleanAmount(amounts['30-60'])}</td>
                    <td class="amount-cell ${getBucketClass('60-90')}">${formatCleanAmount(amounts['60-90'])}</td>
                    <td class="amount-cell ${getBucketClass('90-120')}">${formatCleanAmount(amounts['90-120'])}</td>
                    <td class="amount-cell ${getBucketClass('120+')}">${formatCleanAmount(amounts['120+'])}</td>
                    <td class="amount-cell total-cell">${formatCleanAmount(amounts.total)}</td>
                    <td class="actions-cell">
                        <div class="action-buttons">
                            ${overdueAmount > 0 ? `
                                <button class="action-btn email-btn" onclick="sendEmailReminder('${company}', '${type}')" title="Send Email Reminder">
                                    <i class="fas fa-envelope"></i>
                                </button>
                            ` : ''}
                            <button class="action-btn mark-paid-btn" onclick="markAsPaid('${company}', '${type}')" title="Mark as Paid">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        
            // ADD TOTAL ROW
            if (sortedCompanies.length > 0) {
                const totalRow = document.createElement('tr');
                totalRow.className = 'aging-total-row';
                
                // Calculate column totals
                const columnTotals = {
                    '0-30': 0, '30-60': 0, '60-90': 0, '90-120': 0, '120+': 0, total: 0
                };
                
                sortedCompanies.forEach(([company, amounts]) => {
                    columnTotals['0-30'] += amounts['0-30'];
                    columnTotals['30-60'] += amounts['30-60'];
                    columnTotals['60-90'] += amounts['60-90'];
                    columnTotals['90-120'] += amounts['90-120'];
                    columnTotals['120+'] += amounts['120+'];
                    columnTotals.total += amounts.total;
                });
                
                totalRow.innerHTML = `
                    <td class="total-label-cell">
                        <strong>TOTAL ${type}</strong>
                    </td>
                    <td class="amount-cell total-amount ${getBucketClass('0-30')}">${formatCleanAmount(columnTotals['0-30'])}</td>
                    <td class="amount-cell total-amount ${getBucketClass('30-60')}">${formatCleanAmount(columnTotals['30-60'])}</td>
                    <td class="amount-cell total-amount ${getBucketClass('60-90')}">${formatCleanAmount(columnTotals['60-90'])}</td>
                    <td class="amount-cell total-amount ${getBucketClass('90-120')}">${formatCleanAmount(columnTotals['90-120'])}</td>
                    <td class="amount-cell total-amount ${getBucketClass('120+')}">${formatCleanAmount(columnTotals['120+'])}</td>
                    <td class="amount-cell grand-total">${formatCleanAmount(columnTotals.total)}</td>
                    <td class="actions-cell"></td>
                `;
                
                tableBody.appendChild(totalRow);
            }
        }

        function getPriorityLevel(overdueAmount, totalAmount) {
            const overduePercentage = totalAmount > 0 ? (overdueAmount / totalAmount) * 100 : 0;
            
            if (overdueAmount > 50000000 || overduePercentage > 50) { // 50M+ or 50%+ overdue
                return {
                    level: 'high',
                    badge: '<span class="priority-badge high-priority">HIGH RISK</span>'
                };
            } else if (overdueAmount > 10000000 || overduePercentage > 25) { // 10M+ or 25%+ overdue
                return {
                    level: 'medium',
                    badge: '<span class="priority-badge medium-priority">WATCH</span>'
                };
            } else if (overdueAmount > 0) {
                return {
                    level: 'low',
                    badge: '<span class="priority-badge low-priority">FOLLOW UP</span>'
                };
            }
            
            return { level: 'none', badge: '' };
        }

        function getBucketClass(bucket) {
            return `aging-bucket-${bucket.replace('+', '-plus').replace('-', '-')}`;
        }

        function formatCleanAmount(amount) {
            if (amount === 0) return '<span class="zero-amount">-</span>';
            
            const formatted = formatCompactCurrency(amount, 'IDR');
            // Remove "Rp" prefix for cleaner look, add it back in shorter format
            return formatted.replace('Rp ', 'Rp&nbsp;').replace(' Mn', 'M').replace(' Bn', 'B');
        }

        function sendEmailReminder(company, type) {
            // Simple modal for email input
            const modal = document.createElement('div');
            modal.className = 'email-modal-overlay';
            modal.innerHTML = `
                <div class="email-modal">
                    <div class="email-modal-header">
                        <h4>Send Payment Reminder</h4>
                        <button class="modal-close" onclick="closeEmailModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="email-modal-body">
                        <label for="reminderEmail">Email Address:</label>
                        <input type="email" id="reminderEmail" placeholder="Enter email address" class="email-input">
                        <div class="email-preview">
                            <strong>Subject:</strong> Payment Reminder - ${company}<br>
                            <strong>Message:</strong> This is a friendly reminder about your outstanding ${type === 'AR' ? 'invoice' : 'payment'} with us.
                        </div>
                    </div>
                    <div class="email-modal-footer">
                        <button class="btn btn-secondary" onclick="closeEmailModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="openEmailClient('${company}', '${type}')">Send Reminder</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function openEmailClient(company, type) {
            const email = document.getElementById('reminderEmail').value;
            if (!email) {
                alert('Please enter an email address');
                return;
            }
            
            const subject = `Payment Reminder - ${company}`;
            const body = `Dear ${company},\n\nThis is a friendly reminder about your outstanding ${type === 'AR' ? 'invoice' : 'payment'} with us.\n\nPlease contact us if you have any questions.\n\nBest regards,\nYour Finance Team`;
            
            const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink);
            
            closeEmailModal();
        }
        
        function closeEmailModal() {
            const modal = document.querySelector('.email-modal-overlay');
            if (modal) {
                modal.remove();
            }
        }
        
        async function markAsPaid(company, type) {
            if (confirm(`Mark all outstanding ${type === 'AR' ? 'receivables' : 'payables'} for ${company} as paid?`)) {
                try {
                    // Find transactions to update
                    const transactionsToUpdate = aparTransactions.filter(transaction => 
                        transaction.company === company && 
                        transaction.type === type && 
                        transaction.status !== 'Paid'
                    );
        
                    if (transactionsToUpdate.length === 0) {
                        showToast(`No outstanding ${type} transactions found for ${company}`, 'info');
                        return;
                    }
        
                    // Update each transaction in the database
                    for (const transaction of transactionsToUpdate) {
                        const updates = {
                            status: 'Paid',
                            last_payment_date: new Date().toISOString().split('T')[0],
                            paid_amount: transaction.amount // Set paid amount to full amount
                        };
        
                        // Update in Supabase
                        await updateTransaction(transaction.id, updates);
                    }
        
                    // Update both the aging analysis AND the main AP/AR transactions table
                    updateAgingAnalysis();
                    
                    // Refresh the main AP/AR table 
                    renderAPARTable();
                    
                    // Update the summary cards
                    updateAPARSummary();
                    
                    // Show success message
                    showToast(`Successfully marked ${transactionsToUpdate.length} ${company} ${type} transaction(s) as paid`, 'success');
                    
                } catch (error) {
                    console.error('Error marking transactions as paid:', error);
                    showToast(`Error updating transactions: ${error.message}`, 'error');
                }
            }
        }
        
        // Toast notification function
        function showToast(message, type = 'info') {
            // Remove any existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const iconMap = {
                'success': 'check-circle',
                'error': 'exclamation-circle',
                'info': 'info-circle'
            };
            
            toast.innerHTML = `
                <div class="toast-content">
                    <i class="fas fa-${iconMap[type] || 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Remove after 4 seconds (6 seconds for errors)
            const duration = type === 'error' ? 6000 : 4000;
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }
            }, duration);
        }
        
        // Update additional analytics
        function updateAdditionalAnalytics(arTransactions, apTransactions) {
            // Calculate actual average days to pay for AR (based on current outstanding)
            const unpaidAR = arTransactions.filter(t => t.status === 'Unpaid' || t.status === 'Overdue');
            let dso = 0;
            if (unpaidAR.length > 0) {
                // Use the SAME calculation as CCC - from invoice date, not due date
                const totalDays = unpaidAR.reduce((sum, t) => {
                    const invoiceDate = new Date(t.invoice_date);
                    const daysOutstanding = Math.floor((new Date() - invoiceDate) / (1000 * 60 * 60 * 24));
                    return sum + daysOutstanding;
                }, 0);
                dso = Math.round(totalDays / unpaidAR.length);
            }
        
            // Calculate collection efficiency (paid on time vs total)
            const totalARTransactions = arTransactions.length;
            const onTimeTransactions = arTransactions.filter(t => {
                if (t.status === 'Paid') return true; // Assume paid transactions were eventually collected
                if (t.status === 'Unpaid' || t.status === 'Overdue') {
                    // Check if still within terms
                    const today = new Date();
                    let dueDate;
                    if (t.due_date) {
                        dueDate = new Date(t.due_date);
                    } else if (t.invoice_date) {
                        const invoiceDate = new Date(t.invoice_date);
                        dueDate = new Date(invoiceDate);
                        dueDate.setDate(dueDate.getDate() + (t.payment_terms || 30));
                    } else {
                        return false;
                    }
                    return today <= dueDate; // Still on time
                }
                return false;
            }).length;
            
            const collectionEfficiency = totalARTransactions > 0 ? Math.round((onTimeTransactions / totalARTransactions) * 100) : 0;
        
            // Calculate risk exposure (90+ days)
            const riskExposure = arTransactions
                .filter(t => t.status !== 'Paid')
                .reduce((sum, transaction) => {
                    const today = new Date();
                    let dueDate;
                    if (transaction.due_date) {
                        dueDate = new Date(transaction.due_date);
                    } else if (transaction.invoice_date) {
                        const invoiceDate = new Date(transaction.invoice_date);
                        dueDate = new Date(invoiceDate);
                        dueDate.setDate(dueDate.getDate() + (transaction.payment_terms || 30));
                    } else {
                        return sum;
                    }
                    
                    const daysOutstanding = Math.ceil((today - dueDate) / (1000 * 60 * 60 * 24));
                    return daysOutstanding >= 90 ? sum + transaction.amount : sum;
                }, 0);
        
            // Calculate payment trend based on aging distribution
            const aging = calculateAging(arTransactions);
            const totalOutstanding = Object.values(aging).reduce((sum, bucket) => sum + bucket.total, 0);
            const highRiskAmount = aging['90-120'].total + aging['120+'].total;
            const riskPercentage = totalOutstanding > 0 ? (highRiskAmount / totalOutstanding) * 100 : 0;
            
            let paymentTrend = 'Stable';
            if (riskPercentage > 30) {
                paymentTrend = 'Declining';
            } else if (riskPercentage < 10) {
                paymentTrend = 'Improving';
            }
        
            // Update display
            document.getElementById('avgDaysToPay').textContent = dso > 0 ? `${dso}` : '--';
            // Collection efficiency with color coding
            let efficiencyClass = 'collection-efficiency-bad';
            if (collectionEfficiency >= 80) {
                efficiencyClass = 'collection-efficiency-excellent';
            } else if (collectionEfficiency >= 60) {
                efficiencyClass = 'collection-efficiency-good';
            } else if (collectionEfficiency >= 40) {
                efficiencyClass = 'collection-efficiency-fair';
            } else if (collectionEfficiency >= 20) {
                efficiencyClass = 'collection-efficiency-poor';
            }
            
            const efficiencyElement = document.getElementById('collectionEfficiency');
            efficiencyElement.textContent = `${collectionEfficiency}%`;
            efficiencyElement.className = `aging-amount ${efficiencyClass}`;
            
            document.getElementById('riskExposure').textContent = formatCompactCurrency(riskExposure, 'IDR');
            // Payment trend with color coding
            let trendClass = 'payment-trend-stable';
            if (paymentTrend === 'Improving') {
                trendClass = 'payment-trend-improving';
            } else if (paymentTrend === 'Declining') {
                trendClass = 'payment-trend-declining';
            }
            
            const trendElement = document.getElementById('paymentTrend');
            trendElement.textContent = paymentTrend;
            trendElement.className = `aging-amount ${trendClass}`;
        }
        
        // Create aging charts
        function createAgingCharts(arAging, apAging) {
            const buckets = ['0-30', '30-60', '60-90', '90-120', '120+'];
            const bucketLabels = ['0-30 Days', '30-60 Days', '60-90 Days', '90-120 Days', '120+ Days'];
            
            // AR Chart
            const arData = buckets.map(bucket => arAging[bucket].total);
            createAgingChart('arAgingChart', 'Accounts Receivable', arData, bucketLabels, '#10b981');
            
            // AP Chart
            const apData = buckets.map(bucket => apAging[bucket].total);
            createAgingChart('apAgingChart', 'Accounts Payable', apData, bucketLabels, '#ef4444');
        }
        
        function createAgingChart(canvasId, title, data, labels, color) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
        
            // Destroy any existing chart on this canvas to prevent conflicts
            if (window[canvasId + 'Instance']) {
                window[canvasId + 'Instance'].destroy();
            }
        
            const totalAmount = data.reduce((sum, value) => sum + value, 0);
        
            // This is a custom Chart.js plugin to draw the total value in the middle
            const centerTextPlugin = {
                id: 'centerText',
                afterDraw: (chart) => {
                    const { ctx, chartArea: { top, width, height } } = chart;
                    ctx.save();
        
                    // Main Total Value
                    ctx.font = 'bold 1.75rem Inter, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = '#1e293b';
                    // Use your existing formatNumber function for consistency
                    const formattedTotal = 'Rp ' + formatNumber(totalAmount);
                    ctx.fillText(formattedTotal, width / 2, height / 2 + top - 10);
        
                    // Subtitle
                    ctx.font = '0.9rem Inter, sans-serif';
                    ctx.fillStyle = '#64748b';
                    ctx.fillText('Total', width / 2, height / 2 + top + 20);
                    ctx.restore();
                }
            };
        
            window[canvasId + 'Instance'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#10b981', // 0-30 Days (Green)
                            '#f59e0b', // 30-60 Days (Yellow)
                            '#ea580c', // 60-90 Days (Orange)
                            '#dc2626', // 90-120 Days (Red)
                            '#991b1b'  // 120+ Days (Dark Red)
                        ],
                        borderColor: '#ffffff',
                        borderWidth: 4,      // Creates a nice visual separation between slices
                        hoverOffset: 10,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%', // This makes the doughnut ring thinner
                    plugins: {
                        centerText: centerTextPlugin, // Enable our custom plugin
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                boxWidth: 10,
                                font: { size: 12 },
                                // Custom label shows percentage and value
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        const percentage = totalAmount > 0 ? (value / totalAmount * 100).toFixed(1) : 0;
                                        return {
                                            text: `${label} (${percentage}%)`,
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            hidden: isNaN(value),
                                            index: i
                                        };
                                    });
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#ffffff',
                            bodyColor: '#cbd5e1',
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                // Tooltip shows both amount and percentage
                                label: function(context) {
                                    const value = context.parsed;
                                    const percentage = totalAmount > 0 ? (value / totalAmount * 100).toFixed(1) : 0;
                                    return ` ${context.label}: Rp ${formatNumber(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                },
                plugins: [centerTextPlugin] // IMPORTANT: Register the custom plugin
            });
        
            // Helper function for compact number formatting
            function formatNumber(num) {
                const absNum = Math.abs(num);
                if (absNum >= 1e9) return (num / 1e9).toFixed(1) + 'B';
                if (absNum >= 1e6) return (num / 1e6).toFixed(1) + 'M';
                if (absNum >= 1e3) return (num / 1e3).toFixed(0) + 'K';
                return num.toLocaleString('id-ID');
            }
        }

        // Connection Status Functions
        function checkSupabaseConnection() {
            updateConnectionStatus('connecting', 'Connecting...');
            
            // Test connection with a simple query
            supabase
                .from('ap_ar_transactions_meridash')
                .select('count', { count: 'exact', head: true })
                .limit(1)
                .then(({ error }) => {
                    if (error) {
                        console.error('Supabase connection error:', error);
                        updateConnectionStatus('disconnected', 'Disconnected');
                    } else {
                        updateConnectionStatus('connected', 'Connected');
                    }
                })
                .catch((error) => {
                    console.error('Supabase connection failed:', error);
                    updateConnectionStatus('disconnected', 'Disconnected');
                });
        }
        
        function updateConnectionStatus(status, text) {
            const statusElement = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');
            
            if (statusElement && textElement) {
                // Remove existing status classes
                statusElement.classList.remove('connected', 'disconnected', 'connecting');
                
                // Add new status class
                statusElement.classList.add(status);
                
                // Update text
                textElement.textContent = text;
            }
        }
        
        // Check connection periodically
        function startConnectionMonitoring() {
            // Initial check
            checkSupabaseConnection();
            
            // Check every 30 seconds
            setInterval(checkSupabaseConnection, 30000);
        }

        // Financial Statements Management
        let financialTransactions = [];
        let glAccounts = [];
        let selectedFinancialTransactions = [];
        let isEditingFinancial = false;
        let editingFinancialId = null;
        let currentFinancialPage = 1;
        let financialPageSize = 50;
        let totalFinancialTransactions = 0;
          
        // Load GL Accounts from Supabase
        async function loadGLAccounts() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return [];
        
                const { data: accounts, error } = await supabase
                    .from('gl_accounts_meridash')
                    .select('*')
                    .eq('user_id', user.id)
                    .eq('is_active', true)
                    .order('account_code');
        
                if (error) throw error;
                
                window.glAccounts = accounts || [];
                return accounts || [];
                
            } catch (error) {
                console.error('Error loading GL accounts:', error);
                return [];
            }
        }
        
        // Make sure GL accounts are loaded when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadGLAccounts();
        });
        
        // Load Financial Transactions from Supabase
        async function loadFinancialTransactions() {
            try {
                console.log('=== LOADING FINANCIAL TRANSACTIONS DEBUG ===');
                
                const { data, error } = await supabase
                    .from('financial_transactions_meridash')
                    .select('*')
                    .order('transaction_date', { ascending: false });
                
                console.log('Financial query result:', { data, error });
                
                if (error) {
                    console.error('Financial transactions error details:', error);
                    throw error;
                }
                
                financialTransactions = data || [];
                console.log('Loaded financial transactions:', financialTransactions.length);
                
                renderFinancialTable();
                updateTrialBalance();
            } catch (error) {
                console.error('Error loading financial transactions:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                financialTransactions = [];
                renderFinancialTable();
                updateTrialBalance();
            }
        }
        
        // Tab Switching
        function switchFinancialTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('#statements-section .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('#statements-section .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked button
            document.querySelector(`#statements-section [data-tab="${tabName}"]`).classList.add('active');
            
            // Initialize specific tab content
            switch(tabName) {
                case 'trial-balance':
                    updateTrialBalance();
                    break;
                case 'reports':
                    generateReports();
                    break;
            }
        }
        
        // Render Financial Transactions Table
        function renderFinancialTable() {
            const tbody = document.getElementById('financialTableBody');
            
            if (!tbody) return;
            
            const filteredData = getFilteredFinancialTransactions();
            totalFinancialTransactions = filteredData.length;
            
            // Calculate pagination
            const startIndex = (currentFinancialPage - 1) * financialPageSize;
            const endIndex = startIndex + financialPageSize;
            const paginatedData = filteredData.slice(startIndex, endIndex);
            
            tbody.innerHTML = paginatedData.map(transaction => {
                const isLinked = transaction.is_linked || transaction.ap_ar_transaction_id;
                
                return `
                    <tr data-id="${transaction.id}">
                        <td>
                            <input type="checkbox" class="transaction-checkbox" value="${transaction.id}" 
                                   onchange="updateSelectedFinancialTransactions()">
                        </td>
                        <td>${formatDateIndonesian(transaction.transaction_date)}</td>
                        <td>
                            <span class="account-display">${transaction.account_code} - ${transaction.account_name}</span>
                        </td>
                        <td title="${transaction.description}">${transaction.description}</td>
                        <td>${transaction.debit_amount > 0 ? formatCurrency(transaction.debit_amount, 'IDR') : '-'}</td>
                        <td>${transaction.credit_amount > 0 ? formatCurrency(transaction.credit_amount, 'IDR') : '-'}</td>
                        <td>${transaction.reference || '-'}</td>
                        <td style="text-align: center;">
                            ${isLinked ? 
                                `<button class="btn btn-sm btn-danger" onclick="unlinkTransaction('${transaction.id}')" title="Unlink from AP/AR">
                                    <i class="fas fa-unlink"></i>
                                </button>` : 
                                `<button class="btn btn-sm btn-primary" onclick="linkSingleTransaction('${transaction.id}')" title="Link to AP/AR">
                                    <i class="fas fa-link"></i>
                                </button>`
                            }
                        </td>
                        <td>
                            <button class="action-btn edit" onclick="editFinancialTransaction('${transaction.id}')" data-tooltip="Edit Transaction">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteFinancialTransaction('${transaction.id}')" data-tooltip="Delete Transaction">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Update pagination controls
            updateFinancialPagination();
        }

        function updateFinancialPagination() {
            const totalPages = Math.ceil(totalFinancialTransactions / financialPageSize);
            const startItem = totalFinancialTransactions === 0 ? 0 : (currentFinancialPage - 1) * financialPageSize + 1;
            const endItem = Math.min(currentFinancialPage * financialPageSize, totalFinancialTransactions);
            
            // Update count display with better formatting
            const transactionCountEl = document.getElementById('transactionCount');
            if (transactionCountEl) {
                if (totalFinancialTransactions === 0) {
                    transactionCountEl.textContent = 'No transactions found';
                } else {
                    transactionCountEl.innerHTML = `Showing <strong>${startItem}-${endItem}</strong> of <strong>${totalFinancialTransactions}</strong> transactions`;
                }
            }
            
            // Update page buttons
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            
            if (prevBtn) prevBtn.disabled = currentFinancialPage === 1;
            if (nextBtn) nextBtn.disabled = currentFinancialPage === totalPages || totalPages === 0;
            
            // Update page numbers
            renderPageNumbers(totalPages);
        }
        
        function renderPageNumbers(totalPages) {
            const pageNumbers = document.getElementById('pageNumbers');
            if (!pageNumbers) return;
            
            let html = '';
            const maxVisible = 5;
            let startPage = Math.max(1, currentFinancialPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            
            if (endPage - startPage + 1 < maxVisible) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-btn ${i === currentFinancialPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }
            
            pageNumbers.innerHTML = html;
        }
        
        function changePageSize() {
            financialPageSize = parseInt(document.getElementById('transactionPageSize').value);
            currentFinancialPage = 1; // Reset to first page
            renderFinancialTable();
        }
        
        function previousPage() {
            if (currentFinancialPage > 1) {
                currentFinancialPage--;
                renderFinancialTable();
            }
        }
        
        function nextPage() {
            const totalPages = Math.ceil(totalFinancialTransactions / financialPageSize);
            if (currentFinancialPage < totalPages) {
                currentFinancialPage++;
                renderFinancialTable();
            }
        }
        
        function goToPage(page) {
            currentFinancialPage = page;
            renderFinancialTable();
        }
        
        function getFilteredFinancialTransactions() {
            let filtered = [...financialTransactions];
            
            const periodFilter = document.getElementById('periodFilter')?.value;
            const categoryFilter = document.getElementById('categoryFilter')?.value;
            const accountFilter = document.getElementById('accountFilter')?.value;
            const dateFrom = document.getElementById('dateFromFinancial')?.value;
            const dateTo = document.getElementById('dateToFinancial')?.value;
            
            // Period filtering (same logic as AP/AR date filtering)
            if (periodFilter && periodFilter !== 'custom') {
                const today = new Date();
                let startDate;
                
                switch(periodFilter) {
                    case 'MTD':
                        startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                        break;
                    case 'QTD':
                        const quarter = Math.floor(today.getMonth() / 3);
                        startDate = new Date(today.getFullYear(), quarter * 3, 1);
                        break;
                    case 'YTD':
                        startDate = new Date(today.getFullYear(), 0, 1);
                        break;
                }
                
                if (startDate) {
                    filtered = filtered.filter(t => new Date(t.transaction_date) >= startDate);
                }
            }
            
            // Custom date range
            if (periodFilter === 'custom' && dateFrom && dateTo) {
                filtered = filtered.filter(t => {
                    const transDate = new Date(t.transaction_date);
                    return transDate >= new Date(dateFrom) && transDate <= new Date(dateTo);
                });
            }
            
            // Category filtering
            if (categoryFilter) {
                filtered = filtered.filter(t => t.category === categoryFilter);
            }
            
            // Account filtering
            if (accountFilter) {
                filtered = filtered.filter(t => t.account_code === accountFilter);
            }
            
            return filtered;
        }
        
        function updateSelectedFinancialTransactions() {
            const checkboxes = document.querySelectorAll('.transaction-checkbox:checked');
            selectedFinancialTransactions = Array.from(checkboxes).map(cb => cb.value);
            
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');
            
            if (selectedFinancialTransactions.length > 0) {
                bulkActions.style.display = 'flex';
                selectedCount.textContent = selectedFinancialTransactions.length;
            } else {
                bulkActions.style.display = 'none';
            }
        }
        
        // Period filter change handler
        function checkPeriodFilter() {
            const periodFilter = document.getElementById('periodFilter');
            const customDateRange = document.getElementById('customDateRange');
            
            if (periodFilter && customDateRange) {
                periodFilter.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customDateRange.style.display = 'flex';
                    } else {
                        customDateRange.style.display = 'none';
                    }
                    renderFinancialTable();
                });
            }
        }
        
        // Populate account dropdowns
        function populateAccountDropdowns() {
            const accountSelects = ['financialAccount', 'accountFilter'];
            
            accountSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                // Keep existing options for filter
                if (selectId === 'accountFilter') {
                    const currentOptions = select.innerHTML;
                    select.innerHTML = `<option value="">All Accounts</option>`;
                } else {
                    select.innerHTML = '<option value="">Select Account</option>';
                }
                
                glAccounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.account_code;
                    option.textContent = `${account.account_code} - ${account.account_name}`;
                    option.dataset.category = account.category;
                    select.appendChild(option);
                });
            });
        }
        
        // Account dropdown populations
        function populateAccountFilters() {
            const accountFilter = document.getElementById('accountFilter');
            if (!accountFilter) return;
            
            accountFilter.innerHTML = '<option value="">All Accounts</option>';
            
            glAccounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account.account_code;
                option.textContent = `${account.account_code} - ${account.account_name}`;
                accountFilter.appendChild(option);
            });
        }
        
        // Clear filters
        function clearFinancialFilters() {
            document.getElementById('periodFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('accountFilter').value = '';
            document.getElementById('dateFromFinancial').value = '';
            document.getElementById('dateToFinancial').value = '';
            document.getElementById('customDateRange').style.display = 'none';
            renderFinancialTable();
        }

        function exportReportsToPDF() {
            // First, ensure we have financial data loaded
            if (!financialTransactions || financialTransactions.length === 0) {
                alert('No financial data available. Please add some transactions first.');
                return;
            }
            
            // Generate fresh reports with current data
            generateReports();
            
            // Wait a moment for the reports to fully render
            setTimeout(() => {
                // Double-check that reports have content
                const balanceSheet = document.getElementById('balanceSheetDetailed');
                const incomeStatement = document.getElementById('incomeStatementDetailed');
                
                if (!balanceSheet.innerHTML.trim() || !incomeStatement.innerHTML.trim()) {
                    alert('Reports are being generated. Please try again in a moment.');
                    return;
                }
                
                // Trigger the print dialog
                window.print();
            }, 1000); // Increased delay to ensure reports are fully generated
        }
        
        // Modal Functions
        function openAddFinancialModal() {
            const modal = document.getElementById('addFinancialModal');
            if (modal) {
                modal.classList.add('active');
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';
                
                // Set default date
                document.getElementById('financialDate').value = new Date().toISOString().split('T')[0];
                
                // Populate both account dropdowns
                populateJournalAccountDropdowns();
                
                // Reset form
                document.getElementById('addFinancialForm').reset();
                document.getElementById('financialDate').value = new Date().toISOString().split('T')[0];
                
                // Reset balance indicator
                updateBalance();
            }
        }
        
        function closeAddFinancialModal() {
            const modal = document.getElementById('addFinancialModal');
            if (modal) {
                modal.classList.remove('active');
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
            }
            
            clearFinancialForm();
            isEditingFinancial = false;
            editingFinancialId = null;
        }

        function populateJournalAccountDropdowns() {
            const debitSelect = document.getElementById('debitAccount');
            const creditSelect = document.getElementById('creditAccount');
            
            if (!debitSelect || !creditSelect) return;
            
            // Clear existing options (except first)
            debitSelect.innerHTML = '<option value="">Select Account</option>';
            creditSelect.innerHTML = '<option value="">Select Account</option>';
            
            // Add accounts to both dropdowns
            glAccounts.forEach(account => {
                const option1 = new Option(`${account.account_code} - ${account.account_name}`, account.account_code);
                const option2 = new Option(`${account.account_code} - ${account.account_name}`, account.account_code);
                
                debitSelect.add(option1);
                creditSelect.add(option2);
            });
        }
        
        function clearFinancialForm() {
            document.getElementById('addFinancialForm').reset();
            document.getElementById('financialDate').value = new Date().toISOString().split('T')[0];
        }
        
        // Amount input handler (ensure only one amount is entered)
        function handleAmountInput(type) {
            const debitInput = document.getElementById('financialDebit');
            const creditInput = document.getElementById('financialCredit');
            
            if (type === 'debit' && debitInput.value) {
                creditInput.value = '';
            } else if (type === 'credit' && creditInput.value) {
                debitInput.value = '';
            }
        }
        
        // Account selection handler
        function updateAccountDetails() {
            const accountSelect = document.getElementById('financialAccount');
            const selectedOption = accountSelect.selectedOptions[0];
            
            if (selectedOption && selectedOption.dataset.category) {
                // Auto-suggest debit/credit based on account type
                const category = selectedOption.dataset.category;
                showAccountGuidance(category);
            }
        }
        
        function showAccountGuidance(category) {
            const guidance = {
                'Asset': 'Assets typically have debit balances. Increases are debits.',
                'Expense': 'Expenses typically have debit balances. Increases are debits.',
                'Liability': 'Liabilities typically have credit balances. Increases are credits.',
                'Equity': 'Equity typically has credit balances. Increases are credits.',
                'Revenue': 'Revenue typically has credit balances. Increases are credits.'
            };
            
            // You can show this guidance in a tooltip or small text below the form
            console.log('Account guidance:', guidance[category]);
        }
        
        // Add/Edit Financial Transaction
        async function addFinancialTransaction(event) {
            event.preventDefault();
            
            // Get form data
            const transactionDate = document.getElementById('financialDate').value;
            const reference = document.getElementById('financialReference').value || '';
            const description = document.getElementById('financialDescription').value;
            const debitAccountCode = document.getElementById('debitAccount').value;
            const creditAccountCode = document.getElementById('creditAccount').value;
            const amount = parseFloat(document.getElementById('debitAmount').value);
            
            // Validation
            if (!transactionDate || !description || !debitAccountCode || !creditAccountCode || !amount) {
                alert('Please fill in all required fields.');
                return;
            }
            
            if (amount <= 0) {
                alert('Amount must be greater than zero.');
                return;
            }
            
            // Get account details
            const debitAccount = glAccounts.find(acc => acc.account_code === debitAccountCode);
            const creditAccount = glAccounts.find(acc => acc.account_code === creditAccountCode);
            
            if (!debitAccount || !creditAccount) {
                alert('Please select valid accounts.');
                return;
            }
            
            try {
                // Create debit transaction
                const debitTransaction = {
                    transaction_date: transactionDate,
                    account_code: debitAccountCode,
                    account_name: debitAccount.account_name,
                    description: description,
                    debit_amount: amount,
                    credit_amount: 0,
                    reference: reference,
                    notes: `Journal Entry - Debit`,
                    category: debitAccount.category,
                    source: 'Manual Journal'
                };
                
                // Create credit transaction
                const creditTransaction = {
                    transaction_date: transactionDate,
                    account_code: creditAccountCode,
                    account_name: creditAccount.account_name,
                    description: description,
                    debit_amount: 0,
                    credit_amount: amount,
                    reference: reference,
                    notes: `Journal Entry - Credit`,
                    category: creditAccount.category,
                    source: 'Manual Journal'
                };
                
                // Save both transactions
                await saveFinancialTransaction(debitTransaction);
                await saveFinancialTransaction(creditTransaction);
                
                alert('Journal entry added successfully!');
                closeAddFinancialModal();
                await loadFinancialTransactions();
                updateTrialBalance();
                
            } catch (error) {
                console.error('Error saving journal entry:', error);
                alert('Error saving journal entry: ' + error.message);
            }
        }

        function updateBalance() {
            const debitAmount = parseFloat(document.getElementById('debitAmount').value) || 0;
            const creditAmount = parseFloat(document.getElementById('creditAmount').value) || 0;
            
            const balanceStatus = document.getElementById('balanceStatus');
            const saveButton = document.getElementById('saveJournalButton');
            
            const isBalanced = debitAmount > 0 && creditAmount > 0 && debitAmount === creditAmount;
            
            if (isBalanced) {
                balanceStatus.innerHTML = `Debits: ${formatCurrency(debitAmount, 'IDR')} | Credits: ${formatCurrency(creditAmount, 'IDR')} | <span style="color: #059669;"> Balanced</span>`;
                saveButton.disabled = false;
                saveButton.textContent = 'Add Journal Entry';
            } else {
                balanceStatus.innerHTML = `Debits: ${formatCurrency(debitAmount, 'IDR')} | Credits: ${formatCurrency(creditAmount, 'IDR')} | <span style="color: #ef4444;">Out of Balance</span>`;
                saveButton.disabled = true;
                saveButton.textContent = 'Balance Required';
            }
        }
        
        // Save transaction to Supabase
        async function saveFinancialTransaction(transaction) {
            try {
                // Add user_id to the transaction
                const transactionWithUser = {
                    ...transaction,
                    user_id: (await supabase.auth.getUser()).data.user?.id
                };
        
                const { data, error } = await supabase
                    .from('financial_transactions_meridash')
                    .insert([transactionWithUser])
                    .select();
                
                if (error) throw error;
                
                // Add to local array
                financialTransactions.unshift(data[0]);
                
                // Log audit trail
                await logAuditTrail('financial_transactions_meridash', data[0].id, 'INSERT', null, data[0]);
                
                return data[0];
            } catch (error) {
                console.error('Error saving financial transaction:', error);
                throw error;
            }
        }
        
        // Update transaction in Supabase
        async function updateFinancialTransaction(id, updates) {
            try {
                const oldData = financialTransactions.find(t => t.id === id);
                
                const { data, error } = await supabase
                    .from('financial_transactions_meridash')
                    .update(updates)
                    .eq('id', id)
                    .select();
                
                if (error) throw error;
                
                // Update local array
                const index = financialTransactions.findIndex(t => t.id === id);
                if (index !== -1) {
                    financialTransactions[index] = data[0];
                }
                
                // Log audit trail
                await logAuditTrail('financial_transactions_meridash', id, 'UPDATE', oldData, data[0]);
                
                return data[0];
            } catch (error) {
                console.error('Error updating financial transaction:', error);
                throw error;
            }
        }
        
        // Edit transaction
        function editFinancialTransaction(id) {
            const transaction = financialTransactions.find(t => t.id === id);
            if (!transaction) return;
            
            isEditingFinancial = true;
            editingFinancialId = id;
            
            // Populate form
            document.getElementById('financialDate').value = transaction.transaction_date;
            document.getElementById('financialAccount').value = transaction.account_code;
            document.getElementById('financialDescription').value = transaction.description;
            document.getElementById('financialDebit').value = transaction.debit_amount || '';
            document.getElementById('financialCredit').value = transaction.credit_amount || '';
            document.getElementById('financialReference').value = transaction.reference || '';
            document.getElementById('financialNotes').value = transaction.notes || '';
            
            // Update modal title
            document.querySelector('#addFinancialModal .modal-title').textContent = 'Edit Financial Transaction';
            
            openAddFinancialModal();
        }
        
        // Delete transaction
        async function deleteFinancialTransaction(id) {
            // Prevent multiple simultaneous deletions
            if (window.deletingTransaction) {
                return;
            }
            
            if (!confirm('Are you sure you want to delete this transaction?')) {
                return;
            }
            
            try {
                // Set flag to prevent multiple deletions
                window.deletingTransaction = true;
                
                const transaction = financialTransactions.find(t => t.id === id);
                if (!transaction) {
                    throw new Error('Transaction not found');
                }
                
                const { error } = await supabase
                    .from('financial_transactions_meridash')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                // Remove from local array
                const index = financialTransactions.findIndex(t => t.id === id);
                if (index !== -1) {
                    financialTransactions.splice(index, 1);
                }
                
                // Log audit trail
                await logAuditTrail('financial_transactions_meridash', id, 'DELETE', transaction, null);
                
                // Refresh displays
                renderFinancialTable();
                updateTrialBalance();
                
            } catch (error) {
                console.error('Error deleting financial transaction:', error);
                alert('Error deleting transaction: ' + error.message);
            } finally {
                // Always clear the flag
                window.deletingTransaction = false;
            }
        }
        
        // Trial Balance Functions
        function updateTrialBalance() {
            const accounts = {};
            
            // Group transactions by account
            financialTransactions.forEach(transaction => {
                const accountCode = transaction.account_code;
                
                if (!accounts[accountCode]) {
                    accounts[accountCode] = {
                        account_code: accountCode,
                        account_name: transaction.account_name,
                        category: transaction.category,
                        debit_balance: 0,
                        credit_balance: 0
                    };
                }
                
                accounts[accountCode].debit_balance += transaction.debit_amount || 0;
                accounts[accountCode].credit_balance += transaction.credit_amount || 0;
            });
            
            // Calculate net balances and totals
            let totalDebits = 0;
            let totalCredits = 0;
            
            const trialBalanceData = Object.values(accounts).map(account => {
                const netBalance = account.debit_balance - account.credit_balance;
                
                if (netBalance > 0) {
                    account.final_debit = netBalance;
                    account.final_credit = 0;
                    totalDebits += netBalance;
                } else if (netBalance < 0) {
                    account.final_debit = 0;
                    account.final_credit = Math.abs(netBalance);
                    totalCredits += Math.abs(netBalance);
                } else {
                    account.final_debit = 0;
                    account.final_credit = 0;
                }
                
                return account;
            });
            
            // Update trial balance display
            renderTrialBalanceTable(trialBalanceData);
            updateTrialBalanceSummary(totalDebits, totalCredits);
        }
        
        function renderTrialBalanceTable(data) {
            const tbody = document.getElementById('trialBalanceTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = data.map(account => `
                <tr>
                    <td>${account.account_code}</td>
                    <td>${account.account_name}</td>
                    <td>${account.final_debit > 0 ? formatCurrencyFull(account.final_debit, 'IDR') : '-'}</td>
                    <td>${account.final_credit > 0 ? formatCurrencyFull(account.final_credit, 'IDR') : '-'}</td>
                </tr>
            `).join('');
        }
        
        function updateTrialBalanceSummary(totalDebits, totalCredits) {
            document.getElementById('totalDebits').textContent = formatCurrencyFull(totalDebits, 'IDR');
            document.getElementById('totalCredits').textContent = formatCurrencyFull(totalCredits, 'IDR');
            
            const difference = totalDebits - totalCredits;
            document.getElementById('balanceDifference').textContent = formatCurrencyFull(Math.abs(difference), 'IDR');
            document.getElementById('balanceDifference').style.color = difference !== 0 ? '#ef4444' : '#10b981';
            
            // Update balance indicator
            updateBalanceIndicator(difference);
            
            // Show/hide auto-balance button
            const autoBalanceBtn = document.getElementById('autoBalanceBtn');
            if (autoBalanceBtn) {
                if (Math.abs(difference) > 0.01) { // Allow for small rounding differences
                    autoBalanceBtn.style.display = 'block';
                } else {
                    autoBalanceBtn.style.display = 'none';
                }
            }
        }
        
        function updateBalanceIndicator(difference = null) {
            const indicator = document.getElementById('balanceStatus');
            if (!indicator) return;
            
            if (difference === null) {
                // Calculate difference
                const accounts = {};
                financialTransactions.forEach(transaction => {
                    const code = transaction.account_code;
                    if (!accounts[code]) accounts[code] = { debits: 0, credits: 0 };
                    accounts[code].debits += transaction.debit_amount || 0;
                    accounts[code].credits += transaction.credit_amount || 0;
                });
                
                let totalDebits = 0, totalCredits = 0;
                Object.values(accounts).forEach(account => {
                    const net = account.debits - account.credits;
                    if (net > 0) totalDebits += net;
                    else totalCredits += Math.abs(net);
                });
                
                difference = totalDebits - totalCredits;
            }
            
            if (Math.abs(difference) < 0.01) {
                indicator.className = 'balance-status balanced';
                indicator.innerHTML = '<i class="fas fa-check-circle"></i> Trial Balance: In Balance';
            } else {
                indicator.className = 'balance-status unbalanced';
                indicator.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Trial Balance: Out of balance by ${formatCurrency(Math.abs(difference), 'IDR')}`;
            }
        }
    
        // ENHANCED: Smart auto-balance with pattern analysis
        async function autoBalanceEntries() {
            // Calculate detailed imbalance analysis
            const analysis = analyzeTrialBalanceImbalance();
            
            if (Math.abs(analysis.totalImbalance) < 0.01) {
                alert('Trial balance is already balanced!');
                return;
            }
            
            // Show smart balance suggestion modal
            showSmartBalanceModal(analysis);
        }
        
        // NEW: Analyze imbalance patterns and suggest solutions
        function analyzeTrialBalanceImbalance() {
            const accounts = {};
            const categoryTotals = {
                'Asset': { debit: 0, credit: 0 },
                'Liability': { debit: 0, credit: 0 },
                'Equity': { debit: 0, credit: 0 },
                'Revenue': { debit: 0, credit: 0 },
                'Expense': { debit: 0, credit: 0 }
            };
            
            // Group transactions by account and category
            financialTransactions.forEach(transaction => {
                const code = transaction.account_code;
                if (!accounts[code]) {
                    accounts[code] = {
                        account_code: code,
                        account_name: transaction.account_name,
                        category: transaction.category,
                        debit_total: 0,
                        credit_total: 0
                    };
                }
                
                accounts[code].debit_total += transaction.debit_amount || 0;
                accounts[code].credit_total += transaction.credit_amount || 0;
                
                // Add to category totals
                const category = transaction.category;
                if (categoryTotals[category]) {
                    categoryTotals[category].debit += transaction.debit_amount || 0;
                    categoryTotals[category].credit += transaction.credit_amount || 0;
                }
            });
            
            // Calculate net balances
            let totalDebits = 0, totalCredits = 0;
            const accountBalances = Object.values(accounts).map(account => {
                const netBalance = account.debit_total - account.credit_total;
                account.net_balance = netBalance;
                
                if (netBalance > 0) {
                    totalDebits += netBalance;
                } else {
                    totalCredits += Math.abs(netBalance);
                }
                
                return account;
            });
            
            const totalImbalance = totalDebits - totalCredits;
            
            // Smart pattern analysis
            const suggestions = generateSmartSuggestions(accountBalances, categoryTotals, totalImbalance);
            
            return {
                totalImbalance,
                totalDebits,
                totalCredits,
                accountBalances,
                categoryTotals,
                suggestions
            };
        }
        
        // FIXED: Generate smart balancing suggestions
        function generateSmartSuggestions(accountBalances, categoryTotals, imbalance) {
            const suggestions = [];
            const isCreditNeeded = imbalance > 0; // FIXED: If debits > credits, we need a credit to balance
            const amount = Math.abs(imbalance);
            
            // Pattern 1: High AR activity suggests missing Revenue
            const arAccount = accountBalances.find(acc => acc.account_code === '1100');
            if (arAccount && arAccount.net_balance > amount * 0.5) {
                suggestions.push({
                    type: 'revenue_from_ar',
                    title: 'Revenue from AR Activity',
                    description: `High AR balance (${formatCurrencyFull(arAccount.net_balance, 'IDR')}) suggests missing revenue entries`,
                    accounts: [
                        { code: '4010', name: 'Sales Revenue', action: isCreditNeeded ? 'credit' : 'debit' }, // FIXED
                        { code: '4020', name: 'Service Revenue', action: isCreditNeeded ? 'credit' : 'debit' } // FIXED
                    ],
                    confidence: 'high'
                });
            }
            
            // Pattern 2: High AP activity suggests missing Expenses
            const apAccount = accountBalances.find(acc => acc.account_code === '2010');
            if (apAccount && Math.abs(apAccount.net_balance) > amount * 0.5) {
                suggestions.push({
                    type: 'expense_from_ap',
                    title: 'Expenses from AP Activity',
                    description: `High AP balance (${formatCurrencyFull(Math.abs(apAccount.net_balance), 'IDR')}) suggests missing expense entries`,
                    accounts: [
                        { code: '5100', name: 'Office Expenses', action: isCreditNeeded ? 'credit' : 'debit' }, // FIXED
                        { code: '5400', name: 'Professional Services', action: isCreditNeeded ? 'credit' : 'debit' }, // FIXED
                        { code: '5500', name: 'Office Supplies', action: isCreditNeeded ? 'credit' : 'debit' } // FIXED
                    ],
                    confidence: 'high'
                });
            }
            
            // Pattern 3: Cash activity suggests bank transactions
            const cashAccount = accountBalances.find(acc => acc.account_code === '1010');
            if (cashAccount && Math.abs(cashAccount.net_balance) > amount * 0.3) {
                suggestions.push({
                    type: 'cash_activity',
                    title: 'Cash-Related Balancing',
                    description: `Significant cash activity suggests bank transactions or cash adjustments`,
                    accounts: [
                        { code: '1010', name: 'Cash and Cash Equivalents', action: isCreditNeeded ? 'credit' : 'debit' }, // FIXED
                        { code: '3040', name: 'Retained Earnings', action: isCreditNeeded ? 'credit' : 'debit' } // FIXED
                    ],
                    confidence: 'medium'
                });
            }
            
            // Pattern 4: Generic balancing entry (fallback) - FIXED LOGIC
            suggestions.push({
                type: 'generic_balance',
                title: 'General Balancing Entry',
                description: 'Create a balancing entry to resolve the imbalance',
                accounts: isCreditNeeded ? [
                    { code: '3040', name: 'Retained Earnings', action: 'credit' },
                    { code: '4040', name: 'Other Revenue', action: 'credit' },
                    { code: '1010', name: 'Cash and Cash Equivalents', action: 'credit' }
                ] : [
                    { code: '3040', name: 'Retained Earnings', action: 'debit' },
                    { code: '1010', name: 'Cash and Cash Equivalents', action: 'debit' },
                    { code: '5900', name: 'Other Expenses', action: 'debit' }
                ],
                confidence: 'low'
            });
            
            return suggestions.sort((a, b) => {
                const confidenceOrder = { 'high': 3, 'medium': 2, 'low': 1 };
                return confidenceOrder[b.confidence] - confidenceOrder[a.confidence];
            });
        }
        
        // FIXED: Smart balance modal with corrected logic
        function showSmartBalanceModal(analysis) {
            const { totalImbalance, suggestions } = analysis;
            const isCreditNeeded = totalImbalance > 0; // FIXED
            const amount = Math.abs(totalImbalance);
            
            // Create enhanced modal content
            const modalContent = `
                <div class="modal-overlay active" id="smartBalanceModal">
                    <div class="modal" style="max-width: 700px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Smart Trial Balance Correction</h3>
                            <button class="modal-close" onclick="closeSmartBalanceModal()">&times;</button>
                        </div>
                        <div class="modal-content">
                            <div class="imbalance-summary" style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <i class="fas fa-exclamation-triangle" style="color: #dc2626;"></i>
                                    <strong style="color: #dc2626;">Trial Balance Imbalance Detected</strong>
                                </div>
                                <p style="margin: 0; color: #7f1d1d;">
                                    Your books are out of balance by <strong>${formatCurrencyFull(amount, 'IDR')}</strong>. 
                                    ${isCreditNeeded ? 'Debits exceed credits' : 'Credits exceed debits'} - 
                                    a ${isCreditNeeded ? 'credit' : 'debit'} entry is needed.
                                </p>
                            </div>
                            
                            <h4 style="margin-bottom: 1rem;">Suggested Corrections:</h4>
                            <div class="suggestions-container" id="suggestionsContainer">
                                ${generateSuggestionsHTML(suggestions, amount)}
                            </div>
                            
                            <div class="bulk-balance-option" style="margin-top: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                                <h5 style="margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-layer-group"></i>
                                    Bulk Balancing Entry
                                </h5>
                                <p style="margin: 0 0 1rem 0; color: #64748b; font-size: 0.875rem;">
                                    Create a single balancing entry if none of the above suggestions apply:
                                </p>
                                <div style="display: flex; gap: 1rem; align-items: end;">
                                    <div style="flex: 1;">
                                        <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; font-size: 0.875rem;">Account:</label>
                                        <select id="bulkBalanceAccount" class="form-select">
                                            <option value="">Select Account</option>
                                        </select>
                                    </div>
                                    <div style="flex: 1;">
                                        <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; font-size: 0.875rem;">Description:</label>
                                        <input type="text" id="bulkBalanceDescription" class="form-input" value="Trial balance correction" placeholder="Description">
                                    </div>
                                    <button class="btn btn-secondary" onclick="createBulkBalancingEntry(${totalImbalance})" style="white-space: nowrap;">
                                        Create Entry
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary" onclick="closeSmartBalanceModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="showTrialBalanceDetails()">View Detailed Breakdown</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to DOM
            document.body.insertAdjacentHTML('beforeend', modalContent);
            
            // Force modal to be visible (same fix as other modals)
            const modal = document.getElementById('smartBalanceModal');
            if (modal) {
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';
            }
            
            // Populate bulk balance account dropdown
            populateBulkBalanceAccounts(isCreditNeeded); // FIXED: Pass correct variable
        }
        
        // NEW: Generate suggestions HTML
        function generateSuggestionsHTML(suggestions, amount) {
            return suggestions.map((suggestion, index) => {
                const confidenceColor = {
                    'high': '#10b981',
                    'medium': '#f59e0b', 
                    'low': '#6b7280'
                };
                
                const confidenceIcon = {
                    'high': 'fa-star',
                    'medium': 'fa-star-half-alt',
                    'low': 'fa-star'
                };
                
                return `
                    <div class="suggestion-card" style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; transition: all 0.2s;">
                        <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 0.75rem;">
                            <div>
                                <h6 style="margin: 0 0 0.25rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    ${suggestion.title}
                                    <span style="display: flex; align-items: center; gap: 0.25rem; color: ${confidenceColor[suggestion.confidence]}; font-size: 0.75rem;">
                                        <i class="fas ${confidenceIcon[suggestion.confidence]}" style="font-size: 0.625rem;"></i>
                                        ${suggestion.confidence} confidence
                                    </span>
                                </h6>
                                <p style="margin: 0; color: #64748b; font-size: 0.875rem;">${suggestion.description}</p>
                            </div>
                        </div>
                        <div class="suggested-accounts" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            ${suggestion.accounts.map(account => `
                                <button class="btn btn-sm btn-outline-primary suggested-account-btn" 
                                        onclick="createSuggestedEntry('${account.code}', '${account.name}', '${account.action}', ${amount})"
                                        style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span>${account.code} - ${account.name}</span>
                                    <span style="background: ${account.action === 'debit' ? '#dbeafe' : '#dcfce7'}; 
                                                 color: ${account.action === 'debit' ? '#1e40af' : '#166534'}; 
                                                 padding: 0.125rem 0.375rem; border-radius: 4px; font-size: 0.75rem;">
                                        ${account.action.toUpperCase()}
                                    </span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // FIXED: Populate bulk balance accounts
        function populateBulkBalanceAccounts(isCreditNeeded) { // FIXED: Parameter name
            const select = document.getElementById('bulkBalanceAccount');
            if (!select) return;
            
            // FIXED: Show appropriate accounts based on what's needed
            const suggestedAccounts = isCreditNeeded ? 
                glAccounts.filter(acc => acc.category === 'Liability' || acc.category === 'Equity' || acc.category === 'Revenue') :
                glAccounts.filter(acc => acc.category === 'Asset' || acc.category === 'Expense');
            
            select.innerHTML = '<option value="">Select Account</option>';
            
            // Add a separator and most common balancing accounts at top
            const commonAccounts = [
                { code: '3040', name: 'Retained Earnings' },
                { code: '1010', name: 'Cash and Cash Equivalents' }
            ].filter(acc => suggestedAccounts.find(sa => sa.account_code === acc.code));
            
            if (commonAccounts.length > 0) {
                commonAccounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.code;
                    option.textContent = ` ${account.code} - ${account.name}`;
                    select.appendChild(option);
                });
                
                // Add separator
                const separator = document.createElement('option');
                separator.disabled = true;
                separator.textContent = '';
                select.appendChild(separator);
            }
            
            // Add all other accounts
            suggestedAccounts.forEach(account => {
                if (!commonAccounts.find(ca => ca.code === account.account_code)) {
                    const option = document.createElement('option');
                    option.value = account.account_code;
                    option.textContent = `${account.account_code} - ${account.account_name}`;
                    select.appendChild(option);
                }
            });
        }
        
        // NEW: Close smart balance modal
        function closeSmartBalanceModal() {
            const modal = document.getElementById('smartBalanceModal');
            if (modal) {
                modal.remove();
            }
        }

        // NEW: Create suggested balancing entry
        async function createSuggestedEntry(accountCode, accountName, action, amount) {
            if (!confirm(`Create ${action} entry of ${formatCurrencyFull(amount, 'IDR')} to ${accountCode} - ${accountName}?`)) {
                return;
            }
            
            try {
                const account = glAccounts.find(acc => acc.account_code === accountCode);
                if (!account) {
                    alert('Account not found in chart of accounts.');
                    return;
                }
                
                const balancingTransaction = {
                    transaction_date: new Date().toISOString().split('T')[0],
                    account_code: accountCode,
                    account_name: accountName,
                    description: `Smart balance correction - ${account.category.toLowerCase()} adjustment`,
                    debit_amount: action === 'debit' ? amount : 0,
                    credit_amount: action === 'credit' ? amount : 0,
                    reference: `SMART-BAL-${Date.now()}`,
                    category: account.category,
                    source: 'Smart-Balance',
                    notes: 'Automatically suggested balancing entry based on transaction pattern analysis'
                };
                
                // Show loading state
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
                button.disabled = true;
                
                await saveFinancialTransaction(balancingTransaction);
                
                closeSmartBalanceModal();
                await loadFinancialTransactions();
                
                // Show success message with details
                alert(` Smart balancing entry created successfully!\n\n` +
                      `Account: ${accountCode} - ${accountName}\n` +
                      `${action === 'debit' ? 'Debit' : 'Credit'}: ${formatCurrencyFull(amount, 'IDR')}\n` +
                      `Description: ${balancingTransaction.description}`);
                
            } catch (error) {
                console.error('Error creating suggested entry:', error);
                alert('Error creating balancing entry: ' + error.message);
                
                // Restore button state
                if (button) {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            }
        }
        
        // FIXED: Create bulk balancing entry
        async function createBulkBalancingEntry(imbalance) {
            const accountCode = document.getElementById('bulkBalanceAccount').value;
            const description = document.getElementById('bulkBalanceDescription').value;
            
            if (!accountCode) {
                alert('Please select an account for the balancing entry.');
                return;
            }
            
            if (!description.trim()) {
                alert('Please provide a description for the balancing entry.');
                return;
            }
            
            const account = glAccounts.find(acc => acc.account_code === accountCode);
            if (!account) {
                alert('Selected account not found in chart of accounts.');
                return;
            }
            
            const amount = Math.abs(imbalance);
            const isCreditNeeded = imbalance > 0; // FIXED
            
            if (!confirm(`Create bulk balancing entry?\n\n` +
                        `Account: ${accountCode} - ${account.account_name}\n` +
                        `${isCreditNeeded ? 'Credit' : 'Debit'}: ${formatCurrencyFull(amount, 'IDR')}\n` + // FIXED
                        `Description: ${description}`)) {
                return;
            }
            
            try {
                const balancingTransaction = {
                    transaction_date: new Date().toISOString().split('T')[0],
                    account_code: accountCode,
                    account_name: account.account_name,
                    description: description,
                    debit_amount: isCreditNeeded ? 0 : amount, // FIXED
                    credit_amount: isCreditNeeded ? amount : 0, // FIXED
                    reference: `BULK-BAL-${Date.now()}`,
                    category: account.category,
                    source: 'Bulk-Balance',
                    notes: 'Manual bulk balancing entry to correct trial balance'
                };
                
                await saveFinancialTransaction(balancingTransaction);
                
                closeSmartBalanceModal();
                await loadFinancialTransactions();
                
                alert(` Bulk balancing entry created successfully!\n\n` +
                      `The trial balance should now be corrected.`);
                
            } catch (error) {
                console.error('Error creating bulk balancing entry:', error);
                alert('Error creating balancing entry: ' + error.message);
            }
        }
        
        // NEW: Show trial balance details breakdown
        function showTrialBalanceDetails() {
            closeSmartBalanceModal();
            
            // Switch to the trial balance tab to show details
            switchFinancialTab('trial-balance');
            
            // Highlight the imbalanced accounts
            setTimeout(() => {
                const table = document.getElementById('trialBalanceTable');
                if (table) {
                    // Add visual highlighting to show problem areas
                    const rows = table.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        const debitCell = row.cells[2];
                        const creditCell = row.cells[3];
                        
                        if (debitCell && creditCell) {
                            const debitText = debitCell.textContent.replace(/[^\d.-]/g, '');
                            const creditText = creditCell.textContent.replace(/[^\d.-]/g, '');
                            const debitAmount = parseFloat(debitText) || 0;
                            const creditAmount = parseFloat(creditText) || 0;
                            
                            // Highlight significant balances
                            if (debitAmount > 100000 || creditAmount > 100000) {
                                row.style.backgroundColor = '#fef3c7';
                                row.style.borderLeft = '3px solid #f59e0b';
                            }
                        }
                    });
                    
                    // Scroll to table
                    table.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 300);
        }
        
        // ENHANCED: Update the close function to match new modal ID
        function closeAutoBalanceModal() {
            // Handle both old and new modal IDs for compatibility
            const oldModal = document.getElementById('autoBalanceModal');
            const newModal = document.getElementById('smartBalanceModal');
            
            if (oldModal) {
                oldModal.remove();
            }
            if (newModal) {
                newModal.remove();
            }
        }
        
        function closeAutoBalanceModal() {
            const modal = document.getElementById('autoBalanceModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Selection and bulk operations
        function updateSelectedTransactions() {
            const checkboxes = document.querySelectorAll('.transaction-checkbox:checked');
            selectedFinancialTransactions = Array.from(checkboxes).map(cb => cb.value);
            
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');
            
            if (selectedFinancialTransactions.length > 0) {
                bulkActions.style.display = 'flex';
                selectedCount.textContent = selectedFinancialTransactions.length;
            } else {
                bulkActions.style.display = 'none';
            }
        }
        
        function toggleSelectAllFinancial() {
            const selectAll = document.getElementById('selectAllFinancial');
            const checkboxes = document.querySelectorAll('.transaction-checkbox');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });
            
            updateSelectedTransactions();
        }
        
        // Bulk operations
        async function bulkDeleteFinancial() {
            if (selectedFinancialTransactions.length === 0) {
                alert('Please select transactions to delete.');
                return;
            }
            
            // Prevent multiple simultaneous bulk operations
            if (window.bulkDeleting) {
                return;
            }
            
            if (!confirm(`Delete ${selectedFinancialTransactions.length} selected transactions? This action cannot be undone.`)) {
                return;
            }
            
            try {
                // Set flag to prevent multiple bulk operations
                window.bulkDeleting = true;
                
                // Store transactions for audit trail
                const transactionsToDelete = selectedFinancialTransactions.map(id => 
                    financialTransactions.find(t => t.id === id)
                ).filter(t => t); // Remove any null/undefined
                
                // Delete all selected transactions in one operation
                const { error } = await supabase
                    .from('financial_transactions_meridash')
                    .delete()
                    .in('id', selectedFinancialTransactions);
                
                if (error) throw error;
                
                // Remove from local array
                financialTransactions = financialTransactions.filter(t => 
                    !selectedFinancialTransactions.includes(t.id)
                );
                
                // Log audit trail for each deleted transaction
                for (const transaction of transactionsToDelete) {
                    await logAuditTrail('financial_transactions_meridash', transaction.id, 'DELETE', transaction, null);
                }
                
                // Clear selection and update UI
                selectedFinancialTransactions = [];
                updateSelectedFinancialTransactions();
                
                // Refresh displays
                renderFinancialTable();
                updateTrialBalance();
                
                alert(`Successfully deleted ${transactionsToDelete.length} transactions.`);
                
            } catch (error) {
                console.error('Error deleting transactions:', error);
                alert('Error deleting transactions: ' + error.message);
            } finally {
                // Always clear the flag
                window.bulkDeleting = false;
            }
        }
        
        // UPDATED: Financial Statements to AP/AR linking  
        function linkSingleTransaction(financialId) {
            console.log('linkSingleTransaction called with ID:', financialId);
            
            // Find the transaction
            const transaction = financialTransactions.find(t => t.id === financialId);
            if (!transaction) {
                alert('Transaction not found');
                return;
            }
            
            // Open the NEW AP/AR creation modal
            openAPARCreationModal(financialId);
        }

        // NEW: Open AP/AR Creation Modal
        function openAPARCreationModal(financialId) {
            const transaction = financialTransactions.find(t => t.id === financialId);
            if (!transaction) return;
            
            // Show the modal
            const modal = document.getElementById('aparCreationModal');
            modal.classList.add('active');
            modal.style.visibility = 'visible';
            modal.style.opacity = '1';
            
            // Populate the selected GL transaction
            populateSelectedGLForAPAR(transaction);
            
            // Pre-populate form with GL data
            populateAPARForm(transaction);
            
            // Store the current GL ID for later use
            window.currentGLId = financialId;
        }
        
        // NEW: Close AP/AR Creation Modal
        function closeAPARCreationModal() {
            const modal = document.getElementById('aparCreationModal');
            modal.classList.remove('active');
            modal.style.visibility = 'hidden';
            modal.style.opacity = '0';
            
            // Clear form
            document.getElementById('aparCreationForm').reset();
            
            // Clear stored ID
            window.currentGLId = null;
        }
        
        // NEW: Populate selected GL transaction display
        function populateSelectedGLForAPAR(transaction) {
            const container = document.getElementById('selectedGLForAPAR');
            const amount = transaction.debit_amount || transaction.credit_amount;
            
            container.innerHTML = `
                <div class="linking-item selected">
                    <div class="linking-item-header">
                        <strong>${transaction.account_code} - ${transaction.account_name}</strong>
                        <span class="amount">${formatCurrencyFull(amount, 'IDR')}</span>
                    </div>
                    <div class="linking-item-details">
                        ${transaction.description} | ${formatDateIndonesian(transaction.transaction_date)}
                    </div>
                </div>
            `;
        }
        
        // NEW: Pre-populate AP/AR form with GL data
        function populateAPARForm(transaction) {
            const amount = transaction.debit_amount || transaction.credit_amount;
            
            // Set amount (readonly)
            document.getElementById('aparAmount').value = amount;
            
            // Set invoice date to GL transaction date
            document.getElementById('aparInvoiceDate').value = transaction.transaction_date;
            
            // Pre-fill description from GL
            document.getElementById('aparDescription').value = transaction.description;
            
            // Pre-fill reference if available
            document.getElementById('aparReference').value = transaction.reference || '';
            
            // Smart suggestion for transaction type based on GL account
            const accountCode = transaction.account_code;
            const typeSelect = document.getElementById('aparType');
            
            if (accountCode.startsWith('1100')) {
                // Accounts Receivable account - suggest AR
                typeSelect.value = 'AR';
            } else if (accountCode.startsWith('2010')) {
                // Accounts Payable account - suggest AP
                typeSelect.value = 'AP';
            } else if (accountCode.startsWith('4')) {
                // Revenue account - suggest AR
                typeSelect.value = 'AR';
            } else if (accountCode.startsWith('5')) {
                // Expense account - suggest AP
                typeSelect.value = 'AP';
            }
            
            console.log('Pre-populated form for GL transaction:', transaction.account_code);
        }

        // NEW: Confirm and create AP/AR entry
        async function confirmAPARCreation() {
            // Validate form
            const aparType = document.getElementById('aparType').value;
            const aparCompany = document.getElementById('aparCompany').value;
            const aparDescription = document.getElementById('aparDescription').value;
            const aparInvoiceDate = document.getElementById('aparInvoiceDate').value;
            
            if (!aparType || !aparCompany || !aparDescription || !aparInvoiceDate) {
                alert('Please fill in all required fields.');
                return;
            }
            
            if (!window.currentGLId) {
                alert('No GL transaction selected.');
                return;
            }
            
            const glTransaction = financialTransactions.find(t => t.id === window.currentGLId);
            if (!glTransaction) {
                alert('GL transaction not found.');
                return;
            }
            
            try {
                // Disable button to prevent double-clicking
                const createButton = document.getElementById('createAPARButton');
                createButton.disabled = true;
                createButton.textContent = 'Creating...';
                
                console.log('Creating AP/AR entry for GL transaction:', glTransaction.account_code);
                
                // Calculate due date
                const invoiceDate = new Date(aparInvoiceDate);
                const paymentTerms = parseInt(document.getElementById('aparPaymentTerms').value);
                const dueDate = new Date(invoiceDate.getTime() + (paymentTerms * 24 * 60 * 60 * 1000));
                
                // Create the AP/AR transaction
                const aparTransaction = {
                    type: aparType,
                    reference: document.getElementById('aparReference').value || '',
                    company: aparCompany,
                    description: aparDescription,
                    amount: parseFloat(document.getElementById('aparAmount').value),
                    currency: 'IDR',
                    invoice_date: aparInvoiceDate,
                    due_date: dueDate.toISOString().split('T')[0],
                    payment_terms: paymentTerms,
                    status: document.getElementById('aparStatus').value,
                    source: 'linked_from_gl',
                    linked_financial_id: glTransaction.id
                };
                
                console.log('Saving AP/AR transaction:', aparTransaction);
                
                // Save AP/AR transaction to database
                const savedAPAR = await saveTransaction(aparTransaction);
                
                // Update the GL transaction to mark it as linked
                await updateFinancialTransaction(glTransaction.id, {
                    ap_ar_transaction_id: savedAPAR.id,
                    is_linked: true,
                    source: glTransaction.source || 'manual' // Preserve existing source
                });
                
                // Close modal and refresh tables
                closeAPARCreationModal();
                
                // Refresh both tables
                await loadFinancialTransactions();
                await loadAPARData();
                renderAPARTable();
                renderFinancialTable();
                
                alert(`Successfully created ${aparType} entry!\n\nCreated:\n- ${aparType}: ${aparCompany}\n- Amount: ${formatCurrencyFull(aparTransaction.amount, 'IDR')}\n- Due: ${formatDateIndonesian(dueDate.toISOString().split('T')[0])}`);
                
            } catch (error) {
                console.error('Error creating AP/AR entry:', error);
                alert('Error creating AP/AR entry: ' + error.message);
            } finally {
                // Re-enable button
                const createButton = document.getElementById('createAPARButton');
                if (createButton) {
                    createButton.disabled = false;
                    createButton.textContent = 'Create AP/AR Entry';
                }
            }
        }
        
        // Unlink transactions
        async function unlinkTransaction(financialId) {
            if (!confirm('Are you sure you want to unlink this transaction?')) return;
            
            try {
                const transaction = financialTransactions.find(t => t.id === financialId);
                
                // Update financial transaction
                await updateFinancialTransaction(financialId, {
                    ap_ar_transaction_id: null,
                    is_linked: false
                });
                
                // Update AP/AR transaction if linked
                if (transaction.ap_ar_transaction_id) {
                    const { error } = await supabase
                        .from('ap_ar_transactions_meridash')
                        .update({ linked_financial_id: null })
                        .eq('id', transaction.ap_ar_transaction_id);
                    
                    if (error) throw error;
                }
                
                // Refresh BOTH tables - this was missing!
                await loadFinancialTransactions();
                await loadAPARData(); // This line was missing!
                
                // Also refresh AP/AR table rendering if we're on that tab
                renderAPARTable();
                
                alert('Transaction unlinked successfully!');
                
            } catch (error) {
                console.error('Error unlinking transaction:', error);
                alert('Error unlinking transaction: ' + error.message);
            }
        }
        
        // Bulk unlink
        async function bulkUnlink() {
            if (selectedFinancialTransactions.length === 0) {
                alert('Please select transactions to unlink.');
                return;
            }
            
            if (!confirm(`Unlink ${selectedFinancialTransactions.length} selected transactions?`)) return;
            
            try {
                // Process all transactions without individual confirmations
                for (const id of selectedFinancialTransactions) {
                    const transaction = financialTransactions.find(t => t.id === id);
                    if (!transaction) continue;
                    
                    // Update financial transaction (remove the individual confirmation)
                    await updateFinancialTransaction(id, {
                        ap_ar_transaction_id: null,
                        is_linked: false
                    });
                    
                    // Update AP/AR transaction if linked
                    if (transaction.ap_ar_transaction_id) {
                        const { error } = await supabase
                            .from('ap_ar_transactions_meridash')
                            .update({ linked_financial_id: null })
                            .eq('id', transaction.ap_ar_transaction_id);
                        
                        if (error) throw error;
                    }
                }
                
                // Refresh data once after all operations
                await loadFinancialTransactions();
                await loadAPARData();
                renderAPARTable();
                renderFinancialTable();
                
                // Clear selection
                selectedFinancialTransactions = [];
                updateSelectedTransactions();
                
                // Single success message
                alert('Selected transactions unlinked successfully!');
                
            } catch (error) {
                console.error('Error unlinking transactions:', error);
                alert('Error unlinking transactions: ' + error.message);
            }
        }
        
        // GL Account Creation
        function openNewAccountModal() {
            document.getElementById('newAccountModal').classList.add('active');
        }
        
        function closeNewAccountModal() {
            document.getElementById('newAccountModal').classList.remove('active');
            document.getElementById('newAccountForm').reset();
        }
        
        async function createNewAccount(event) {
            event.preventDefault();
            
            const accountData = {
                account_code: document.getElementById('newAccountCode').value,
                account_name: document.getElementById('newAccountName').value,
                category: document.getElementById('newAccountCategory').value,
                is_custom: true
            };
            
            try {
                // Check if account code already exists
                const existing = glAccounts.find(acc => acc.account_code === accountData.account_code);
                if (existing) {
                    alert('Account code already exists. Please choose a different code.');
                    return;
                }
                
                const { data, error } = await supabase
                    .from('gl_accounts_meridash')
                    .insert([accountData])
                    .select();
                
                if (error) throw error;
                
                // Add to local array
                glAccounts.push(data[0]);
                glAccounts.sort((a, b) => a.account_code.localeCompare(b.account_code));
                
                // Update dropdowns
                populateAccountDropdowns();
                
                // Select the new account in the main form
                document.getElementById('financialAccount').value = accountData.account_code;
                
                closeNewAccountModal();
                alert('New account created successfully!');
            } catch (error) {
                console.error('Error creating account:', error);
                alert('Error creating account: ' + error.message);
            }
        }
        
        // File Upload Functions
        function openFinancialUploadModal() {
            console.log('Opening financial upload modal...');
            const modal = document.getElementById('uploadFinancialModal');
            if (modal) {
                modal.classList.add('show'); // CHANGED TO 'show'
                console.log('Modal opened successfully');
            } else {
                console.error('Upload modal not found!');
                alert('Upload modal not found. Please check the HTML structure.');
            }
        }
        
        function closeFinancialUploadModal() {
            const modal = document.getElementById('uploadFinancialModal');
            if (modal) {
                modal.classList.remove('show'); // CHANGED TO 'show'
                document.getElementById('financialFileInput').value = '';
            }
        }
        
        function downloadFinancialTemplate() {
            const csv = `Date,Account_Code,Account_Name,Description,Debit,Credit,Reference,Notes
        2025-01-15,1010,Cash and Cash Equivalents,Bank deposit,5000,,DEP-001,Initial deposit
        2025-01-15,4010,Sales Revenue,Product sales,,5000,INV-001,Cash sale
        2025-01-16,5100,Salaries and Wages,Monthly salaries,3000,,PAY-001,January payroll
        2025-01-16,1010,Cash and Cash Equivalents,Salary payment,,3000,PAY-001,Payment to employees`;
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'financial_transactions_template.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        async function handleFinancialFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                alert('Please upload a CSV file.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        alert('CSV file appears to be empty or invalid.');
                        return;
                    }
                    
                    // Parse header
                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    
                    // Expected headers
                    const expectedHeaders = ['Date', 'Account_Code', 'Account_Name', 'Description', 'Debit', 'Credit', 'Reference', 'Notes'];
                    const missingHeaders = expectedHeaders.filter(h => !headers.includes(h));
                    
                    if (missingHeaders.length > 0) {
                        alert(`Missing required columns: ${missingHeaders.join(', ')}`);
                        return;
                    }
                    
                    // Parse data
                    const newTransactions = [];
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                        
                        if (values.length < expectedHeaders.length) continue;
                        
                        const transaction = {};
                        headers.forEach((header, index) => {
                            transaction[header] = values[index];
                        });
                        
                        // Validate and format data
                        const formattedTransaction = {
                            transaction_date: formatDateForDatabase(transaction.Date), // FIXED LINE
                            account_code: transaction.Account_Code,
                            account_name: transaction.Account_Name,
                            description: transaction.Description,
                            debit_amount: parseFloat(transaction.Debit) || 0,
                            credit_amount: parseFloat(transaction.Credit) || 0,
                            reference: transaction.Reference,
                            notes: transaction.Notes,
                            source: 'CSV Import'
                        };
                        
                        // Validate account exists or create it
                        let account = glAccounts.find(acc => acc.account_code === transaction.Account_Code);
                        if (!account) {
                            // Determine category based on account code
                            let category = 'Asset';
                            const code = parseInt(transaction.Account_Code);
                            if (code >= 2000 && code < 3000) category = 'Liability';
                            else if (code >= 3000 && code < 4000) category = 'Equity';
                            else if (code >= 4000 && code < 5000) category = 'Revenue';
                            else if (code >= 5000) category = 'Expense';
                            
                            formattedTransaction.category = category;
                            
                            // Create account if it doesn't exist
                            const newAccount = {
                                account_code: transaction.Account_Code,
                                account_name: transaction.Account_Name,
                                category: category,
                                is_custom: true,
                                user_id: (await supabase.auth.getUser()).data.user?.id
                            };
                            
                            try {
                                const { data: accountData, error: accountError } = await supabase
                                    .from('gl_accounts_meridash')
                                    .insert([newAccount])
                                    .select();
                                
                                if (!accountError) {
                                    glAccounts.push(accountData[0]);
                                }
                            } catch (error) {
                                console.log('Account might already exist:', error);
                            }
                        } else {
                            formattedTransaction.category = account.category;
                        }
                        
                        newTransactions.push(formattedTransaction);
                    }
                    
                    // Insert all transactions
                    const { data: { user } } = await supabase.auth.getUser();
                    const userId = user?.id;
                    
                    const transactionsWithUser = newTransactions.map(transaction => ({  // CHANGED FROM validTransactions
                        ...transaction,
                        user_id: userId
                    }));
                    
                    const { data, error } = await supabase
                        .from('financial_transactions_meridash')
                        .insert(transactionsWithUser)
                        .select();
                    
                    if (error) throw error;
                    
                    // Update local arrays
                    financialTransactions.unshift(...data);
                    
                    closeFinancialUploadModal();
                    renderFinancialTable();
                    updateTrialBalance();
                    populateAccountDropdowns();
                    
                    alert(`Successfully imported ${data.length} transactions!`);
                } catch (error) {
                    console.error('Error importing file:', error);
                    alert('Error importing file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        // Export Functions
        function exportFinancialToCSV() {
            const filteredData = getFilteredFinancialTransactions();
            
            if (filteredData.length === 0) {
                alert('No data to export.');
                return;
            }
            
            // CSV headers
            const headers = [
                'Date',
                'Account Code',
                'Account Name',
                'Description',
                'Debit',
                'Credit',
                'Reference',
                'Category',
                'Source',
                'Notes',
                'Linked'
            ];
            
            // Convert data to CSV format
            const csvRows = [headers.join(',')];
            
            filteredData.forEach(transaction => {
                const row = [
                    escapeCSVField(formatDateForCSV(transaction.transaction_date)),
                    escapeCSVField(transaction.account_code),
                    escapeCSVField(transaction.account_name),
                    escapeCSVField(transaction.description),
                    transaction.debit_amount || '',
                    transaction.credit_amount || '',
                    escapeCSVField(transaction.reference),
                    escapeCSVField(transaction.category),
                    escapeCSVField(transaction.source),
                    escapeCSVField(transaction.notes),
                    transaction.is_linked ? 'Yes' : 'No'
                ];
                csvRows.push(row.join(','));
            });
            
            const csvContent = csvRows.join('\n');
            const filename = `financial_transactions_${new Date().toISOString().split('T')[0]}.csv`;
            
            downloadCSVFile(csvContent, filename);
        }
        
        // Reports Generation
        function generateReports() {
            // Set current date for reports
            const currentDate = new Date().toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('reportDate1').textContent = currentDate;
            document.getElementById('reportDate2').textContent = currentDate;
            document.getElementById('reportDate3').textContent = currentDate;
            document.getElementById('beginningCashBalance').value = getStartingCash();
            
            // Generate all three reports
            generateBalanceSheet();
            generateIncomeStatement();
            generateCashFlowStatement();
            initializeDashboardData();
        }
        
        function generateIncomeStatement() {
            // GET FILTERED TRANSACTIONS BASED ON PERIOD SELECTOR
            const filteredTransactions = getFilteredFinancialTransactions();
            const cleanTransactions = filteredTransactions.filter(tx => 
                tx.source !== 'Smart-Balance' && 
                !tx.description?.includes('Smart balance correction')
            );
            console.log('Generating Income Statement with filtered transactions:', filteredTransactions.length);
            
            // Use FILTERED transactions for period-specific income statement
            const revenueTransactions = cleanTransactions.filter(t => t.category === 'Revenue');
            const expenseTransactions = cleanTransactions.filter(t => t.category === 'Expense');
            
            const revenueAccounts = groupTransactionsByAccount(revenueTransactions);
            const expenseAccounts = groupTransactionsByAccount(expenseTransactions);
            
            let totalRevenue = 0;
            let totalExpenses = 0;
            
            // Calculate revenue (credits increase revenue)
            Object.values(revenueAccounts).forEach(account => {
                const balance = account.credit_total - account.debit_total;
                totalRevenue += balance;
            });
            
            // Calculate expenses (debits increase expenses)
            Object.values(expenseAccounts).forEach(account => {
                const balance = account.debit_total - account.credit_total;
                totalExpenses += balance;
            });
            
            const netIncome = totalRevenue - totalExpenses;
            
            const incomeStatement = `
                <div class="report-section">
                    <div class="report-section-title">REVENUE</div>
                    ${generateAccountLines(revenueAccounts, ['4010', '4020', '4030', '4040', '4050'], 'credit')}
                    
                    <div class="report-line subtotal-line">
                        <span>Total Revenue</span>
                        <span>${formatCurrencyFull(totalRevenue, 'IDR')}</span>
                    </div>
                </div>
                
                <div class="report-section">
                    <div class="report-section-title">EXPENSES</div>
                    
                    <div class="report-subsection">
                        <div class="report-subsection-title">Cost of Goods Sold</div>
                        ${generateAccountLines(expenseAccounts, ['5010', '5020', '5030'], 'debit')}
                    </div>
                    
                    <div class="report-subsection">
                        <div class="report-subsection-title">Operating Expenses</div>
                        ${generateAccountLines(expenseAccounts, ['5100', '5110', '5120', '5200', '5210', '5220', '5300', '5400', '5500', '5600', '5700', '5800', '5900'], 'debit')}
                    </div>
                    
                    <div class="report-line subtotal-line">
                        <span>Total Expenses</span>
                        <span>${formatCurrencyFull(totalExpenses, 'IDR')}</span>
                    </div>
                </div>
                
                <div class="report-line total-line">
                    <span>NET INCOME</span>
                    <span>${formatCurrencyFull(netIncome, 'IDR')}</span>
                </div>
            `;
            
            document.getElementById('incomeStatementDetailed').innerHTML = incomeStatement;
        }
        
        function generateBalanceSheet() {
            // For Balance Sheet: Use ALL transactions up to the END of the selected period
            const periodInfo = getCurrentTransactionPeriod();
            let balanceSheetTransactions = financialTransactions;
            
            // If there's a period selected, only include transactions up to the END date
            if (periodInfo.period && periodInfo.period !== '') {
                const endDate = getPeriodEndDate(periodInfo);
                if (endDate) {
                    balanceSheetTransactions = financialTransactions.filter(t => {
                        const transDate = new Date(t.transaction_date);
                        return transDate <= endDate;
                    });
                    console.log(`Balance Sheet: Using transactions up to ${endDate.toDateString()}`);
                }
            }
            
            const assetTransactions = balanceSheetTransactions.filter(t => t.category === 'Asset');
            const liabilityTransactions = balanceSheetTransactions.filter(t => t.category === 'Liability');
            const equityTransactions = balanceSheetTransactions.filter(t => t.category === 'Equity');
            
            // Group by account
            const assetAccounts = groupTransactionsByAccount(assetTransactions);
            const liabilityAccounts = groupTransactionsByAccount(liabilityTransactions);
            const equityAccounts = groupTransactionsByAccount(equityTransactions);
            
            let totalAssets = 0;
            let totalLiabilities = 0;
            let totalEquity = 0;
            
            // Calculate asset totals
            Object.values(assetAccounts).forEach(account => {
                const balance = account.debit_total - account.credit_total;
                totalAssets += balance;
            });
            
            // Calculate liability totals
            Object.values(liabilityAccounts).forEach(account => {
                const balance = account.credit_total - account.debit_total;
                totalLiabilities += balance;
            });
            
            // Calculate previous period retained earnings (excluding current period)
            let previousRetainedEarnings = 0;
            Object.values(equityAccounts).forEach(account => {
                const balance = account.credit_total - account.debit_total;
                if (account.account_code === '3040' || account.account_name.toLowerCase().includes('retained earnings')) {
                    previousRetainedEarnings += balance;
                } else {
                    totalEquity += balance;
                }
            });
            
            // Get current period net income from Income Statement (using filtered transactions)
            const currentNetIncome = getCurrentPeriodNetIncome();
            
            // Calculate total equity including current period
            const totalEquityWithCurrent = totalEquity + previousRetainedEarnings + currentNetIncome;
            
            const balanceSheet = `
                <div class="report-section">
                    <div class="report-section-title">ASSETS</div>
                    
                    <div class="report-subsection">
                        <div class="report-subsection-title">Current Assets</div>
                        ${generateAccountLines(assetAccounts, ['1000', '1100', '1200', '1300', '1400'], 'debit')}
                    </div>
                    
                    <div class="report-subsection">
                        <div class="report-subsection-title">Fixed Assets</div>
                        ${generateAccountLines(assetAccounts, ['1500', '1510', '1600', '1610', '1700', '1710', '1800', '1900'], 'debit')}
                    </div>
                    
                    <div class="report-line total-line">
                        <span>TOTAL ASSETS</span>
                        <span>${formatCurrencyFull(totalAssets, 'IDR')}</span>
                    </div>
                </div>
                
                <div class="report-section">
                    <div class="report-section-title">LIABILITIES</div>
                    
                    <div class="report-subsection">
                        <div class="report-subsection-title">Current Liabilities</div>
                        ${generateAccountLines(liabilityAccounts, ['2010', '2020', '2030', '2040', '2050'], 'credit')}
                    </div>
                    
                    <div class="report-subsection">
                        <div class="report-subsection-title">Long-term Liabilities</div>
                        ${generateAccountLines(liabilityAccounts, ['2100', '2200', '2300'], 'credit')}
                    </div>
                    
                    <div class="report-line subtotal-line">
                        <span>Total Liabilities</span>
                        <span>${formatCurrencyFull(totalLiabilities, 'IDR')}</span>
                    </div>
                </div>
                
                <div class="report-section">
                    <div class="report-section-title">EQUITY</div>
                    ${generateEquityAccountLines(equityAccounts, ['3010', '3020', '3030'])}
                    
                    ${previousRetainedEarnings !== 0 ? `
                        <div class="report-line">
                            <span class="account-item">Previous Period Retained Earnings</span>
                            <span>${formatCurrencyFull(previousRetainedEarnings, 'IDR')}</span>
                        </div>
                    ` : ''}
                    
                    ${currentNetIncome !== 0 ? `
                        <div class="report-line">
                            <span class="account-item">Current Period Net Income</span>
                            <span>${formatCurrencyFull(currentNetIncome, 'IDR')}</span>
                        </div>
                    ` : ''}
                    
                    <div class="report-line subtotal-line">
                        <span>Total Equity</span>
                        <span>${formatCurrencyFull(totalEquityWithCurrent, 'IDR')}</span>
                    </div>
                </div>
                
                <div class="report-line total-line">
                    <span>TOTAL LIABILITIES + EQUITY</span>
                    <span>${formatCurrencyFull(totalLiabilities + totalEquityWithCurrent, 'IDR')}</span>
                </div>
            `;
            
            document.getElementById('balanceSheetDetailed').innerHTML = balanceSheet;
        }

        function getCurrentTransactionPeriod() {
            const periodFilter = document.getElementById('periodFilter')?.value;
            const dateFrom = document.getElementById('dateFromFinancial')?.value;
            const dateTo = document.getElementById('dateToFinancial')?.value;
            
            return {
                period: periodFilter,
                customFrom: dateFrom,
                customTo: dateTo
            };
        }
        
        function getPeriodEndDate(periodInfo) {
            const today = new Date();
            
            if (periodInfo.period === 'custom' && periodInfo.customTo) {
                return new Date(periodInfo.customTo);
            }
            
            switch(periodInfo.period) {
                case 'MTD':
                    return new Date(today.getFullYear(), today.getMonth() + 1, 0); // Last day of current month
                case 'QTD':
                    const quarter = Math.floor(today.getMonth() / 3);
                    return new Date(today.getFullYear(), (quarter + 1) * 3, 0); // Last day of current quarter
                case 'YTD':
                    return new Date(today.getFullYear(), 11, 31); // Dec 31 of current year
                default:
                    return today;
            }
        }
        
        // NEW: Helper function to get current period net income
        function getCurrentPeriodNetIncome() {
            // Get net income from the income statement calculation
            const revenueTransactions = financialTransactions.filter(t => t.category === 'Revenue');
            const expenseTransactions = financialTransactions.filter(t => t.category === 'Expense');
            
            const revenueAccounts = groupTransactionsByAccount(revenueTransactions);
            const expenseAccounts = groupTransactionsByAccount(expenseTransactions);
            
            let totalRevenue = 0;
            let totalExpenses = 0;
            
            // Calculate revenue (credits increase revenue)
            Object.values(revenueAccounts).forEach(account => {
                const balance = account.credit_total - account.debit_total;
                totalRevenue += balance;
            });
            
            // Calculate expenses (debits increase expenses)
            Object.values(expenseAccounts).forEach(account => {
                const balance = account.debit_total - account.credit_total;
                totalExpenses += balance;
            });
            
            return totalRevenue - totalExpenses;
        }
        
        // NEW: Generate equity account lines (excluding retained earnings)
        function generateEquityAccountLines(accountsGroup, accountCodes) {
            let lines = '';
            
            accountCodes.forEach(code => {
                if (accountsGroup[code]) {
                    const account = accountsGroup[code];
                    const balance = account.credit_total - account.debit_total;
                    
                    if (Math.abs(balance) > 0.01) {
                        lines += `
                            <div class="report-line">
                                <span class="account-item">${account.account_code} - ${account.account_name}</span>
                                <span>${formatCurrencyFull(Math.abs(balance), 'IDR')}</span>
                            </div>
                        `;
                    }
                }
            });
            
            return lines || '<div class="report-line"><span class="account-item">No equity accounts recorded</span><span>Rp  0</span></div>';
        }
        
        function generateCashFlowStatement() {
            const beginningBalance = parseFloat(document.getElementById('beginningCashBalance').value) || getStartingCash();
            
            // USE FILTERED TRANSACTIONS for period-specific cash flow
            const filteredTransactions = getFilteredFinancialTransactions();
            console.log('Generating Cash Flow Statement with filtered transactions:', filteredTransactions.length);
            
            // DEBUG: Show all account codes available
            const allAccountCodes = [...new Set(filteredTransactions.map(t => t.account_code))].filter(Boolean);
            console.log('Available account codes in filtered transactions:', allAccountCodes);
            
            // DEBUG: Show sample transaction structure
            if (filteredTransactions.length > 0) {
                console.log('Sample transaction structure:', filteredTransactions[0]);
            }
            
            // Calculate net income from filtered transactions
            const revenueTransactions = filteredTransactions.filter(t => t.category === 'Revenue');
            const expenseTransactions = filteredTransactions.filter(t => t.category === 'Expense');
            
            let totalRevenue = 0;
            let totalExpenses = 0;
            
            revenueTransactions.forEach(t => {
                const creditAmount = parseFloat(t.credit_amount) || parseFloat(t.credit) || 0;
                const debitAmount = parseFloat(t.debit_amount) || parseFloat(t.debit) || 0;
                totalRevenue += creditAmount - debitAmount;
            });
            
            expenseTransactions.forEach(t => {
                const debitAmount = parseFloat(t.debit_amount) || parseFloat(t.debit) || 0;
                const creditAmount = parseFloat(t.credit_amount) || parseFloat(t.credit) || 0;
                totalExpenses += debitAmount - creditAmount;
            });
            
            const netIncome = totalRevenue - totalExpenses;
            console.log('Calculated Net Income for Cash Flow:', netIncome);
            
            // Operating Activities (based on filtered transactions)
            const operatingAccounts = {
                'Net Income': netIncome,
                'Depreciation & Amortization': getAccountBalanceFromFiltered(['5600', '5610'], filteredTransactions),
                'Changes in Accounts Receivable': -getAccountBalanceFromFiltered(['1100'], filteredTransactions),
                'Changes in Accounts Payable': getAccountBalanceFromFiltered(['2010'], filteredTransactions),
                'Changes in Accrued Expenses': getAccountBalanceFromFiltered(['2020'], filteredTransactions)
            };
            
            console.log('Operating accounts calculated:', operatingAccounts);
            
            // Investing Activities (based on filtered transactions)
            const investingAccounts = {
                'Purchase of Equipment': -getAccountBalanceFromFiltered(['1500'], filteredTransactions),
                'Purchase of Vehicles': -getAccountBalanceFromFiltered(['1600'], filteredTransactions),
                'Purchase of Buildings': -getAccountBalanceFromFiltered(['1700'], filteredTransactions),
                'Purchase of Intangible Assets': -getAccountBalanceFromFiltered(['1900'], filteredTransactions)
            };
            
            console.log('Investing accounts calculated:', investingAccounts);
            
            // Financing Activities (based on filtered transactions)
            const financingAccounts = {
                'Proceeds from Long-term Debt': getAccountBalanceFromFiltered(['2200'], filteredTransactions),
                'Owner\'s Capital Contributions': getAccountBalanceFromFiltered(['3010'], filteredTransactions),
                'Owner\'s Drawings': -getAccountBalanceFromFiltered(['3050'], filteredTransactions)
            };
            
            console.log('Financing accounts calculated:', financingAccounts);
            
            let operatingCashFlow = Object.values(operatingAccounts).reduce((sum, val) => sum + val, 0);
            let investingCashFlow = Object.values(investingAccounts).reduce((sum, val) => sum + val, 0);
            let financingCashFlow = Object.values(financingAccounts).reduce((sum, val) => sum + val, 0);
            
            console.log('Cash flow totals:', {
                operating: operatingCashFlow,
                investing: investingCashFlow,
                financing: financingCashFlow
            });
            
            const netCashFlow = operatingCashFlow + investingCashFlow + financingCashFlow;
            const endingBalance = beginningBalance + netCashFlow;
            
            const cashFlowStatement = `
                <div class="report-line">
                    <span>Beginning Cash Balance</span>
                    <span>${formatCurrencyFull(beginningBalance, 'IDR')}</span>
                </div>
                
                <div class="report-section">
                    <div class="report-section-title">CASH FLOWS FROM OPERATING ACTIVITIES</div>
                    ${generateCashFlowLines(operatingAccounts)}
                    <div class="report-line subtotal-line">
                        <span>Net Cash from Operating Activities</span>
                        <span>${formatCurrencyFull(operatingCashFlow, 'IDR')}</span>
                    </div>
                </div>
                
                <div class="report-section">
                    <div class="report-section-title">CASH FLOWS FROM INVESTING ACTIVITIES</div>
                    ${generateCashFlowLines(investingAccounts)}
                    <div class="report-line subtotal-line">
                        <span>Net Cash from Investing Activities</span>
                        <span>${formatCurrencyFull(investingCashFlow, 'IDR')}</span>
                    </div>
                </div>
                
                <div class="report-section">
                    <div class="report-section-title">CASH FLOWS FROM FINANCING ACTIVITIES</div>
                    ${generateCashFlowLines(financingAccounts)}
                    <div class="report-line subtotal-line">
                        <span>Net Cash from Financing Activities</span>
                        <span>${formatCurrencyFull(financingCashFlow, 'IDR')}</span>
                    </div>
                </div>
                
                <div class="report-line total-line">
                    <span>Net Change in Cash</span>
                    <span>${formatCurrencyFull(netCashFlow, 'IDR')}</span>
                </div>
                <div class="report-line total-line">
                    <span>Ending Cash Balance</span>
                    <span>${formatCurrencyFull(endingBalance, 'IDR')}</span>
                </div>
            `;
            
            document.getElementById('cashFlowStatementDetailed').innerHTML = cashFlowStatement;
        }

        function getAccountBalanceFromFiltered(accountCodes, filteredTransactions, type = 'positive') {
            let total = 0;
            
            console.log('Getting account balance for codes:', accountCodes);
            console.log('From filtered transactions:', filteredTransactions.length);
            
            accountCodes.forEach(code => {
                const transactions = filteredTransactions.filter(t => t.account_code === code);
                console.log(`Account code ${code}: found ${transactions.length} transactions`);
                
                transactions.forEach(t => {
                    // Use the same field names as your groupTransactionsByAccount function
                    const debitAmount = parseFloat(t.debit_amount) || parseFloat(t.debit) || 0;
                    const creditAmount = parseFloat(t.credit_amount) || parseFloat(t.credit) || 0;
                    const amount = debitAmount - creditAmount;
                    total += amount;
                    
                    if (amount !== 0) {
                        console.log(`  Transaction: ${t.account_name}, Debit: ${debitAmount}, Credit: ${creditAmount}, Net: ${amount}`);
                    }
                });
            });
            
            console.log(`Total for codes ${accountCodes}: ${total}`);
            return type === 'negative' ? -Math.abs(total) : total;
        }

        function groupTransactionsByAccount(transactions) {
            const accounts = {};
            
            transactions.forEach(transaction => {
                const accountCode = transaction.account_code;
                
                if (!accounts[accountCode]) {
                    accounts[accountCode] = {
                        account_code: accountCode,
                        account_name: transaction.account_name,
                        debit_total: 0,
                        credit_total: 0
                    };
                }
                
                accounts[accountCode].debit_total += transaction.debit_amount || 0;
                accounts[accountCode].credit_total += transaction.credit_amount || 0;
            });
            
            return accounts;
        }

        function generateReports() {
            // Set current date for reports
            const currentDate = new Date().toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('reportDate1').textContent = currentDate;
            document.getElementById('reportDate2').textContent = currentDate;
            document.getElementById('reportDate3').textContent = currentDate;
            document.getElementById('beginningCashBalance').value = getStartingCash();
            
            // Generate all three reports
            generateBalanceSheet();
            generateIncomeStatement();
            generateCashFlowStatement();
        }

        
        function generateAccountLines(accountsGroup, accountCodes, balanceType = 'debit') {
            let lines = '';
            
            accountCodes.forEach(code => {
                if (accountsGroup[code]) {
                    const account = accountsGroup[code];
                    let balance;
                    
                    if (balanceType === 'credit') {
                        balance = account.credit_total - account.debit_total;
                    } else {
                        balance = account.debit_total - account.credit_total;
                    }
                    
                    if (balance > 0) {
                        lines += `
                            <div class="report-line account-item">
                                <span>${account.account_code} - ${account.account_name}</span>
                                <span>${formatCurrencyFull(balance, 'IDR')}</span>
                            </div>
                        `;
                    }
                }
            });
            
            // If no accounts found with balances, show a message
            if (lines === '') {
                lines = `
                    <div class="report-line account-item">
                        <span>No transactions recorded</span>
                        <span>Rp 0</span>
                    </div>
                `;
            }
            
            return lines; // THIS WAS MISSING!
        }

        function generateCashFlowLines(accountsGroup) {
            let lines = '';
            
            Object.entries(accountsGroup).forEach(([name, amount]) => {
                if (amount !== 0) {
                    lines += `
                        <div class="report-line account-item">
                            <span>${name}</span>
                            <span>${formatCurrencyFull(amount, 'IDR')}</span>
                        </div>
                    `;
                }
            });
            
            return lines;
        }
        
        function generateCashFlowLines(cashFlowItems) {
            let lines = '';
            
            Object.entries(cashFlowItems).forEach(([item, amount]) => {
                if (Math.abs(amount) > 0.01) {
                    lines += `
                        <div class="report-line">
                            <span class="account-item">${item}</span>
                            <span>${formatCurrencyFull(amount, 'IDR')}</span>
                        </div>
                    `;
                }
            });
            
            return lines || '<div class="report-line"><span class="account-item">No cash flows recorded</span><span>Rp  0</span></div>';
        }
        
        function getAccountBalanceForCashFlow(accountCodes) {
            let total = 0;
            const filteredTransactions = getFilteredFinancialTransactions(); // Add this line
            
            accountCodes.forEach(code => {
                const transactions = filteredTransactions.filter(t => t.account_code === code); // Change this line
                transactions.forEach(t => {
                    total += (t.debit_amount || 0) - (t.credit_amount || 0);
                });
            });
            
            return total;
        }
        
        function getAccountBalanceChange(accountCode, type = 'positive') {
            const filteredTransactions = getFilteredFinancialTransactions(); // Add this line
            const transactions = filteredTransactions.filter(t => t.account_code === accountCode); // Change this line
            let change = 0;
            
            transactions.forEach(t => {
                change += (t.debit_amount || 0) - (t.credit_amount || 0);
            });
            
            return type === 'negative' ? -Math.abs(change) : change;
        }
        
        function netIncomeCalculation() {
            const filteredTransactions = getFilteredFinancialTransactions();
            const revenueTransactions = financialTransactions.filter(t => t.category === 'Revenue');
            const expenseTransactions = financialTransactions.filter(t => t.category === 'Expense');
            
            let totalRevenue = 0;
            let totalExpenses = 0;
            
            revenueTransactions.forEach(t => {
                totalRevenue += (t.credit_amount || 0) - (t.debit_amount || 0);
            });
            
            expenseTransactions.forEach(t => {
                totalExpenses += (t.debit_amount || 0) - (t.credit_amount || 0);
            });
            
            return totalRevenue - totalExpenses;
        }
        
        // Utility function for escaping CSV fields (reuse from existing code)
        function escapeCSVField(field) {
            if (field === null || field === undefined) return '';
            const stringField = String(field);
            if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
                return `"${stringField.replace(/"/g, '""')}"`;
            }
            return stringField;
        }
        
        function formatDateForCSV(date) {
            if (!date) return '';
            return new Date(date).toISOString().split('T')[0]; // YYYY-MM-DD format
        }
        
        function downloadCSVFile(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        async function loadFinancialDataGlobally() {
            try {
                const { data: financialData, error: financialError } = await supabase
                    .from('financial_transactions_meridash')
                    .select('*')
                    .order('transaction_date', { ascending: false });
                
                if (financialError) throw financialError;
                
                financialTransactions = financialData || [];
                console.log('Loaded financial transactions globally:', financialTransactions.length);
                
                // Also load GL accounts globally
                const { data: glData, error: glError } = await supabase
                    .from('gl_accounts_meridash')
                    .select('*')
                    .eq('is_active', true)
                    .order('account_code');
                
                if (glError) throw glError;
                
                glAccounts = glData || [];
                console.log('Loaded GL accounts globally:', glAccounts.length);

                // Initialize UI with loaded data
                populateAccountDropdowns();
                renderFinancialTable();
                updateTrialBalance();
                
            } catch (error) {
                console.error('Error loading financial data globally:', error);
            }
        }

        // UPDATE DASHBOARD WITH REAL FINANCIAL DATA
        function updateDashboardWithRealData() {
            console.log('=== UPDATING DASHBOARD WITH REAL AP/AR AND GL DATA ===');
            console.log('AP/AR transactions:', aparTransactions.length);
            console.log('Financial transactions:', financialTransactions.length);
            
            try {
                // Calculate metrics from AP/AR data (for cash and working capital)
                const metrics = calculateDashboardMetrics();
                console.log('Calculated metrics:', metrics);
                
                // Update the dashboard cards with both AP/AR and GL data
                updateDashboardCardsWithGL(metrics);
                
                // Update cash flow forecast
                refreshForecast();
                
                console.log('Dashboard successfully updated with real data');
                
            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }
        
        function calculateDashboardMetrics() {
            console.log('=== CALCULATING DASHBOARD METRICS FROM REAL DATA ===');
            console.log('AP/AR transactions:', aparTransactions.length);
            
            // 1. Calculate current cash position using the same logic as AP/AR tab
            // Get all unpaid transactions (both Unpaid and Overdue status)
            const allUnpaidAR = aparTransactions.filter(t => 
                t.type === 'AR' && (t.status === 'Unpaid' || t.status === 'Overdue')
            );
            const allUnpaidAP = aparTransactions.filter(t => 
                t.type === 'AP' && (t.status === 'Unpaid' || t.status === 'Overdue')
            );
            
            const totalARAll = allUnpaidAR.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            const totalAPAll = allUnpaidAP.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            // Current cash = same as netCashImpact calculation
            const currentCash = totalARAll - totalAPAll;
            
            // 2. Calculate overdue positions
            const overdueAR = aparTransactions
                .filter(t => t.type === 'AR' && t.status === 'Overdue')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            const overdueAP = aparTransactions
                .filter(t => t.type === 'AP' && t.status === 'Overdue')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            const netOverduePosition = overdueAR - overdueAP;
            
            // 3. Calculate revenue from AR transactions
            const selectedPeriod = document.getElementById('dashboardPeriodFilter')?.value || 'YTD';
            const periodRevenue = calculateARRevenue(selectedPeriod);
            
            const metrics = {
                currentCash,
                netOverduePosition,
                fullAR: totalARAll,
                fullAP: totalAPAll,
                overdueAR,
                overdueAP,
                periodRevenue,
                selectedPeriod,
                healthScore: 2.45,
                altmanRating: 'Good',
                riskLevel: 'Low Risk',
                recommendation: 'Upgrade to Pro for full financial analysis'
            };
            
            console.log('Final calculated metrics:', metrics);
            console.log('Current cash (totalARAll - totalAPAll):', formatCurrencyFull(currentCash, 'IDR'));
            console.log('Net overdue position:', formatCurrencyFull(netOverduePosition, 'IDR'));
            console.log('Period revenue:', formatCurrencyFull(periodRevenue, 'IDR'));
            
            return metrics;
        }
        
        function calculateARRevenue(periodFilter) {
            console.log('=== CALCULATING AR REVENUE FOR PERIOD ===');
            console.log('Period filter:', periodFilter);
            
            if (!aparTransactions || aparTransactions.length === 0) {
                return 0;
            }
            
            // For YTD, include ALL AR transactions regardless of status
            if (periodFilter === 'YTD') {
                const allARRevenue = aparTransactions
                    .filter(t => t.type === 'AR')
                    .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                
                console.log('YTD AR Revenue (all transactions):', allARRevenue);
                return allARRevenue;
            }
            
            // For other periods, filter by date
            const today = new Date();
            let startDate;
            
            switch(periodFilter) {
                case 'MTD':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    break;
                case 'QTD':
                    const quarter = Math.floor(today.getMonth() / 3);
                    startDate = new Date(today.getFullYear(), quarter * 3, 1);
                    break;
                case 'L30D':
                    startDate = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
                    break;
                case 'L90D':
                    startDate = new Date(today.getTime() - (90 * 24 * 60 * 60 * 1000));
                    break;
                default:
                    startDate = new Date(today.getFullYear(), 0, 1); // YTD fallback
            }
            
            const arTransactions = aparTransactions.filter(t => {
                if (t.type !== 'AR') return false;
                const invoiceDate = new Date(t.invoice_date);
                return invoiceDate >= startDate && invoiceDate <= today;
            });
            
            const revenue = arTransactions.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            console.log(`${periodFilter} AR Revenue (filtered):`, revenue);
            console.log(`Filtered transactions:`, arTransactions.length);
            
            return revenue;
        }
        
        function calculatePeriodRevenue(periodFilter) {
            console.log('=== CALCULATING PERIOD REVENUE (Using Financial Statements Logic) ===');
            console.log('Period filter:', periodFilter);
            console.log('Financial transactions total:', financialTransactions?.length || 0);
            
            if (!financialTransactions || financialTransactions.length === 0) {
                console.log('No financial transactions available');
                return 0;
            }
            
            // STEP 1: Filter revenue transactions (same as financial statements)
            const revenueTransactions = financialTransactions.filter(t => t.category === 'Revenue');
            console.log('Revenue transactions found:', revenueTransactions.length);
            
            if (revenueTransactions.length === 0) {
                console.log('No revenue transactions found');
                return 0;
            }
            
            // STEP 2: Apply date filtering BEFORE grouping
            let filteredRevenueTransactions = revenueTransactions;
            
            if (periodFilter && periodFilter !== 'custom') {
                const today = new Date();
                let startDate;
                
                switch(periodFilter) {
                    case 'MTD':
                        startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                        break;
                    case 'QTD':
                        const quarter = Math.floor(today.getMonth() / 3);
                        startDate = new Date(today.getFullYear(), quarter * 3, 1);
                        break;
                    case 'YTD':
                        startDate = new Date(today.getFullYear(), 0, 1);
                        break;
                    case 'L30D':
                        startDate = new Date(today);
                        startDate.setDate(today.getDate() - 30);
                        break;
                    case 'L90D':
                        startDate = new Date(today);
                        startDate.setDate(today.getDate() - 90);
                        break;
                }
                
                console.log('Date range:', {
                    periodFilter,
                    startDate: startDate?.toDateString(),
                    endDate: today.toDateString()
                });
                
                if (startDate) {
                    const beforeFilter = filteredRevenueTransactions.length;
                    filteredRevenueTransactions = filteredRevenueTransactions.filter(t => {
                        const transDate = new Date(t.transaction_date);
                        const isInPeriod = transDate >= startDate && transDate <= today;
                        console.log(`${t.account_name} (${t.transaction_date}): ${isInPeriod ? 'INCLUDED' : 'EXCLUDED'}`);
                        return isInPeriod;
                    });
                    console.log(`Date filtered (${periodFilter}): ${beforeFilter} -> ${filteredRevenueTransactions.length} transactions`);
                    
                    // REMOVED THE FALLBACK LOGIC - Let it show 0 if no transactions in period
                    // This ensures the period selector actually affects the value
                }
            }
            
            // Handle custom date range
            if (periodFilter === 'custom') {
                const dateFrom = document.getElementById('revenueDateFrom')?.value;
                const dateTo = document.getElementById('revenueDateTo')?.value;
                
                console.log('Custom date range:', dateFrom, 'to', dateTo);
                
                if (dateFrom && dateTo) {
                    const beforeFilter = filteredRevenueTransactions.length;
                    filteredRevenueTransactions = filteredRevenueTransactions.filter(t => {
                        const transDate = new Date(t.transaction_date);
                        const fromDate = new Date(dateFrom);
                        const toDate = new Date(dateTo);
                        const isInRange = transDate >= fromDate && transDate <= toDate;
                        console.log(`${t.account_name} (${t.transaction_date}): ${isInRange ? 'INCLUDED' : 'EXCLUDED'}`);
                        return isInRange;
                    });
                    console.log(`Custom range filtered: ${beforeFilter} -> ${filteredRevenueTransactions.length} transactions`);
                }
            }
            
            // STEP 3: Group by account (SAME AS FINANCIAL STATEMENTS)
            const revenueAccounts = groupTransactionsByAccount(filteredRevenueTransactions);
            console.log('Revenue accounts after grouping:', Object.keys(revenueAccounts));
            
            // STEP 4: Calculate total revenue (SAME AS FINANCIAL STATEMENTS)
            let totalRevenue = 0;
            Object.values(revenueAccounts).forEach(account => {
                const balance = account.credit_total - account.debit_total;
                totalRevenue += balance;
                console.log(`${account.account_name}: Credits ${account.credit_total} - Debits ${account.debit_total} = ${balance}`);
            });
            
            console.log(`Final calculated revenue for ${periodFilter}:`, totalRevenue);
            return totalRevenue;
        }

        function calculatePreviousPeriodComparison(currentValue, metric, period) {
            console.log('=== CALCULATING PREVIOUS PERIOD COMPARISON ===');
            console.log('Current value:', currentValue, 'Metric:', metric, 'Period:', period);
            
            if (!financialTransactions || financialTransactions.length === 0) {
                console.log('No financial transactions for comparison');
                return {
                    changePercent: '0.0',
                    isPositive: false,
                    previousPeriod: getPreviousPeriodName(period),
                    hasPreviousData: false
                };
            }
            
            const today = new Date();
            let currentStart, currentEnd, previousStart, previousEnd;
            
            switch(period) {
                case 'MTD':
                    // Current: 1st of this month to today
                    currentStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    currentEnd = new Date(today);
                    
                    // Previous: Same days in previous month
                    previousStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    previousEnd = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                    break;
                    
                case 'QTD':
                    // Current: 1st of this quarter to today
                    const currentQuarter = Math.floor(today.getMonth() / 3);
                    currentStart = new Date(today.getFullYear(), currentQuarter * 3, 1);
                    currentEnd = new Date(today);
                    
                    // Previous: Same period in previous quarter
                    const previousQuarter = currentQuarter - 1;
                    if (previousQuarter < 0) {
                        // Previous year's Q4
                        previousStart = new Date(today.getFullYear() - 1, 9, 1); // October 1st
                        previousEnd = new Date(today.getFullYear() - 1, 9 + (today.getMonth() % 3), today.getDate());
                    } else {
                        previousStart = new Date(today.getFullYear(), previousQuarter * 3, 1);
                        previousEnd = new Date(today.getFullYear(), previousQuarter * 3 + (today.getMonth() % 3), today.getDate());
                    }
                    break;
                    
                case 'YTD':
                    // Current: Jan 1st this year to today
                    currentStart = new Date(today.getFullYear(), 0, 1);
                    currentEnd = new Date(today);
                    
                    // Previous: Jan 1st last year to same date last year
                    previousStart = new Date(today.getFullYear() - 1, 0, 1);
                    previousEnd = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
                    break;
                    
                case 'L30D':
                    // Current: Last 30 days
                    currentEnd = new Date(today);
                    currentStart = new Date(today);
                    currentStart.setDate(today.getDate() - 30);
                    
                    // Previous: 30 days before that (days 31-60 ago)
                    previousEnd = new Date(currentStart);
                    previousStart = new Date(currentStart);
                    previousStart.setDate(currentStart.getDate() - 30);
                    break;
                    
                case 'L90D':
                    // Current: Last 90 days
                    currentEnd = new Date(today);
                    currentStart = new Date(today);
                    currentStart.setDate(today.getDate() - 90);
                    
                    // Previous: 90 days before that (days 91-180 ago)
                    previousEnd = new Date(currentStart);
                    previousStart = new Date(currentStart);
                    previousStart.setDate(currentStart.getDate() - 90);
                    break;
                    
                case 'custom':
                    // For custom, we can't calculate previous period without knowing the range
                    const dateFrom = document.getElementById('revenueDateFrom')?.value;
                    const dateTo = document.getElementById('revenueDateTo')?.value;
                    
                    if (!dateFrom || !dateTo) {
                        return {
                            changePercent: '0.0',
                            isPositive: false,
                            previousPeriod: 'previous period',
                            hasPreviousData: false
                        };
                    }
                    
                    currentStart = new Date(dateFrom);
                    currentEnd = new Date(dateTo);
                    
                    // Calculate the duration and go back the same period
                    const durationMs = currentEnd.getTime() - currentStart.getTime();
                    previousEnd = new Date(currentStart);
                    previousStart = new Date(currentStart.getTime() - durationMs);
                    break;
                    
                default:
                    console.log('Unknown period:', period);
                    return {
                        changePercent: '0.0',
                        isPositive: false,
                        previousPeriod: 'previous period',
                        hasPreviousData: false
                    };
            }
            
            console.log('Current period:', currentStart, 'to', currentEnd);
            console.log('Previous period:', previousStart, 'to', previousEnd);
            
            // Calculate previous period value based on metric type
            let previousValue = 0;
            
            if (metric === 'revenue') {
                // Filter revenue transactions for previous period
                const previousRevenueTransactions = financialTransactions.filter(t => {
                    if (t.category !== 'Revenue') return false;
                    const transDate = new Date(t.transaction_date);
                    return transDate >= previousStart && transDate <= previousEnd;
                });
                
                // Calculate previous revenue
                previousValue = previousRevenueTransactions.reduce((sum, t) => {
                    return sum + (parseFloat(t.credit || 0) - parseFloat(t.debit || 0));
                }, 0);
                
                console.log('Previous revenue transactions:', previousRevenueTransactions.length);
                console.log('Previous revenue value:', previousValue);
                
            } else if (metric === 'cash') {
                // For cash, we'd need to calculate the cash position at the previous period end
                // This is more complex as it requires calculating cumulative cash flow
                // For now, we'll use a simplified approach
                previousValue = currentValue * 0.95; // Placeholder - you can enhance this
                
            } else if (metric === 'healthScore') {
                // Health score comparison would need historical calculation
                // For now, return no comparison
                previousValue = currentValue;
            }
            
            // Calculate percentage change
            const hasPreviousData = previousValue !== 0;
            const changePercent = hasPreviousData ? 
                ((currentValue - previousValue) / Math.abs(previousValue) * 100) : 0;
            
            console.log('Comparison result:', {
                currentValue,
                previousValue,
                changePercent: changePercent.toFixed(1),
                isPositive: changePercent >= 0,
                hasPreviousData
            });
            
            return {
                changePercent: changePercent.toFixed(1),
                isPositive: changePercent >= 0,
                previousPeriod: getPreviousPeriodName(period),
                hasPreviousData,
                previousValue
            };
        }
        
        function getPreviousPeriodName(period) {
            const today = new Date();
            
            switch(period) {
                case 'MTD':
                    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    return lastMonth.toLocaleDateString('en-US', { month: 'short' });
                    
                case 'QTD':
                    const currentQuarter = Math.floor(today.getMonth() / 3) + 1;
                    const previousQuarter = currentQuarter === 1 ? 4 : currentQuarter - 1;
                    const previousYear = currentQuarter === 1 ? today.getFullYear() - 1 : today.getFullYear();
                    return `Q${previousQuarter} ${previousYear}`;
                    
                case 'YTD':
                    return (today.getFullYear() - 1).toString();
                    
                case 'L30D':
                    return 'previous 30 days';
                    
                case 'L90D':
                    return 'previous 90 days';
                    
                case 'custom':
                    return 'previous period';
                    
                default:
                    return 'last period';
            }
        }
        
        function calculateRatioBasedHealthScore() {
            console.log('=== CALCULATING ALTMAN Z-SCORE ===');
            
            // Get financial data from your existing system
            const financialData = extractFinancialMetrics();
            
            if (!financialData || !financialData.isValid) {
                console.log('Insufficient financial data for Altman Z-Score calculation');
                return {
                    zScore: 0,
                    rating: 'Insufficient Data',
                    riskLevel: 'high',
                    breakdown: {},
                    recommendation: 'Please ensure complete financial statements are available'
                };
            }
            
            // Calculate the 5 Altman Z-Score components
            const components = calculateZScoreComponents(financialData);
            
            // Calculate weighted Z-Score using Altman's formula
            // Z = 1.2*X1 + 1.4*X2 + 3.3*X3 + 0.6*X4 + 1.0*X5
            const zScore = 
                (1.2 * components.workingCapitalToAssets) +
                (1.4 * components.retainedEarningsToAssets) +
                (3.3 * components.ebitToAssets) +
                (0.6 * components.marketValueEquityToLiabilities) +
                (1.0 * components.salesToAssets);
            
            // Determine risk rating based on Z-Score thresholds
            const rating = getZScoreRating(zScore);
            const riskLevel = getZScoreRiskLevel(zScore);
            
            console.log('Altman Z-Score calculated:', {
                zScore: zScore.toFixed(2),
                rating,
                riskLevel,
                components
            });
            
            return {
                zScore: Math.max(0, zScore), // Ensure non-negative for display
                rating,
                riskLevel,
                breakdown: components,
                recommendation: getZScoreRecommendation(zScore, rating)
            };
        }
        
        function extractFinancialMetrics() {
            console.log('=== EXTRACTING FINANCIAL METRICS FOR Z-SCORE ===');
            
            try {
                // Check if we have financial transactions
                if (!financialTransactions || financialTransactions.length === 0) {
                    console.log('No financial transactions available');
                    return { isValid: false };
                }
                
                // Calculate balances by category from financial transactions
                const balances = calculateAccountBalances();
                
                // Extract key financial statement components
                const totalAssets = balances.totalAssets || 0;
                const totalLiabilities = balances.totalLiabilities || 0; 
                const totalEquity = balances.totalEquity || 0;
                
                // Current Assets (account codes 1000-1999, typically current)
                const currentAssets = calculateCurrentAssets(balances);
                
                // Current Liabilities (account codes 2000-2499, typically current)
                const currentLiabilities = calculateCurrentLiabilities(balances);
                
                // Revenue (for the selected period)
                const selectedPeriod = document.getElementById('dashboardPeriodFilter')?.value || 'YTD';
                const revenue = calculatePeriodRevenue(selectedPeriod);
                
                // Net Income (Revenue - Expenses for the period)
                const expenses = calculatePeriodExpenses(selectedPeriod);
                const netIncome = revenue - expenses;
                
                // Retained Earnings (approximated as total equity minus current period net income)
                const retainedEarnings = Math.max(0, totalEquity - netIncome);
                
                // EBIT (approximated as net income + interest expense)
                const interestExpense = calculateInterestExpense(selectedPeriod);
                const ebit = netIncome + interestExpense;
                
                // Working Capital
                const workingCapital = Math.max(-totalAssets, currentAssets - currentLiabilities);
                
                // Market Value of Equity (for SMEs, use book value)
                const marketValueEquity = Math.max(1, totalEquity); // Ensure positive value
                
                const financialData = {
                    workingCapital,
                    totalAssets,
                    retainedEarnings,
                    ebit,
                    marketValueEquity,
                    totalLiabilities: Math.max(1, totalLiabilities), // Ensure positive for ratio calculation
                    revenue,
                    currentAssets,
                    currentLiabilities,
                    totalEquity,
                    netIncome,
                    isValid: totalAssets > 0 && revenue >= 0 // Basic validity check
                };
                
                console.log('Extracted financial metrics:', financialData);
                return financialData;
                
            } catch (error) {
                console.error('Error extracting financial metrics:', error);
                return { isValid: false };
            }
        }

        function calculateAccountBalances() {
            const balances = {
                totalAssets: 0,
                totalLiabilities: 0,
                totalEquity: 0,
                assetAccounts: {},
                liabilityAccounts: {},
                equityAccounts: {}
            };
            
            // Group transactions by account and calculate net balances
            const accountBalances = {};
            
            financialTransactions.forEach(transaction => {
                const accountCode = transaction.account_code;
                const debit = parseFloat(transaction.debit_amount || transaction.debit || 0);
                const credit = parseFloat(transaction.credit_amount || transaction.credit || 0);
                const netAmount = debit - credit;
                
                if (!accountBalances[accountCode]) {
                    accountBalances[accountCode] = {
                        balance: 0,
                        category: transaction.category || getAccountCategory(accountCode)
                    };
                }
                
                accountBalances[accountCode].balance += netAmount;
            });
            
            // Sum up by category
            Object.values(accountBalances).forEach(account => {
                switch (account.category) {
                    case 'Asset':
                        balances.totalAssets += account.balance;
                        break;
                    case 'Liability':
                        balances.totalLiabilities += (account.balance < 0 ? Math.abs(account.balance) : account.balance);
                        break;
                    case 'Equity':
                        balances.totalEquity += (account.balance < 0 ? Math.abs(account.balance) : account.balance);
                        break;
                }
            });
            
            return balances;
        }

        function getAccountCategory(accountCode) {
            const code = parseInt(accountCode) || 0;
            if (code >= 1000 && code < 2000) return 'Asset';
            if (code >= 2000 && code < 3000) return 'Liability';
            if (code >= 3000 && code < 4000) return 'Equity';
            if (code >= 4000 && code < 5000) return 'Revenue';
            if (code >= 5000) return 'Expense';
            return 'Asset'; // Default
        }
        
        // Helper function to calculate current assets (typically 1000-1499)
        function calculateCurrentAssets(balances) {
            if (!balances || !balances.accountBalances) return 0;
            
            // Current assets typically include accounts 1000-1999
            let currentAssets = 0;
            balances.accountBalances.forEach(account => {
                const code = parseInt(account.account_code);
                if (code >= 1000 && code < 2000) {
                    // For asset accounts, debit increases balance
                    currentAssets += account.debit_total - account.credit_total;
                }
            });
            
            return Math.max(0, currentAssets);
        }
        
        // Helper function to calculate current liabilities (typically 2000-2499)
        function calculateCurrentLiabilities(balances) {
            if (!balances || !balances.accountBalances) return 0;
            
            // Current liabilities typically include accounts 2000-2499
            let currentLiabilities = 0;
            balances.accountBalances.forEach(account => {
                const code = parseInt(account.account_code);
                if (code >= 2000 && code < 2500) {
                    // For liability accounts, credit increases balance
                    currentLiabilities += account.credit_total - account.debit_total;
                }
            });
            
            return Math.max(0, currentLiabilities);
        }
        
        function calculateZScoreComponents(data) {
            // X1: Working Capital / Total Assets
            const workingCapitalToAssets = data.totalAssets > 0 ? 
                data.workingCapital / data.totalAssets : 0;
            
            // X2: Retained Earnings / Total Assets  
            const retainedEarningsToAssets = data.totalAssets > 0 ? 
                data.retainedEarnings / data.totalAssets : 0;
            
            // X3: EBIT / Total Assets
            const ebitToAssets = data.totalAssets > 0 ? 
                data.ebit / data.totalAssets : 0;
            
            // X4: Market Value of Equity / Total Liabilities
            const marketValueEquityToLiabilities = data.totalLiabilities > 0 ? 
                data.marketValueEquity / data.totalLiabilities : 0.6; // Default to 1 if no liabilities
            
            // X5: Sales / Total Assets
            const salesToAssets = data.totalAssets > 0 ? 
                (data.revenue * 12) / data.totalAssets : 0;
            
            return {
                workingCapitalToAssets: Math.max(-1, Math.min(1, workingCapitalToAssets)), // Cap extreme values
                retainedEarningsToAssets: Math.max(-1, Math.min(1, retainedEarningsToAssets)),
                ebitToAssets: Math.max(-0.5, Math.min(0.5, ebitToAssets)),
                marketValueEquityToLiabilities: Math.max(0.1, Math.min(10, marketValueEquityToLiabilities)),
                salesToAssets: Math.max(0, Math.min(3, salesToAssets))
            };

            console.log('Z-Score component details:', {
                workingCapital: data.workingCapital,
                totalAssets: data.totalAssets,
                totalLiabilities: data.totalLiabilities,
                marketValueEquity: data.marketValueEquity,
                revenue: data.revenue,
                ebit: data.ebit
            });
        }
        
        function getZScoreRating(zScore) {
            if (zScore >= 3.0) return ': Investment Grade';
            if (zScore >= 2.6) return ': Financially Strong';
            if (zScore >= 1.8) return ': Stable & Creditworthy';
            if (zScore >= 1.1) return ': Needs Monitoring';
            if (zScore >= 0.5) return ': High Risk';
            return 'Distressed';
        }
        
        function getZScoreRiskLevel(zScore) {
            if (zScore >= 3.0) return 'very-low';
            if (zScore >= 1.8) return 'low';
            if (zScore >= 1.1) return 'moderate';
            if (zScore >= 0.5) return 'high';
            return 'critical';
        }
        
        function getZScoreRecommendation(zScore, rating) {
            if (zScore >= 3.0) {
                return 'Prime candidate for loans, investments, and business expansion. Consider leveraging strong position for growth opportunities.';
            } else if (zScore >= 1.8) {
                return 'Eligible for most financing options. Maintain current financial discipline and monitor key performance indicators regularly.';
            } else if (zScore >= 1.1) {
                return 'Moderate credit risk detected. Focus on increasing revenue, improving cash flow, and reducing unnecessary expenses.';
            } else if (zScore >= 0.5) {
                return 'High bankruptcy risk. Urgent actions needed: restructure debt, improve working capital, and secure additional funding sources.';
            } else {
                return 'Critical financial distress. Immediate professional financial consultation recommended. Consider debt restructuring or capital injection.';
            }
        }

        // Real waterfall impact calculation functions
        function calculateRealWaterfallImpacts(currentPeriodData, previousPeriodData) {
            const impacts = {
                revenue: calculateRevenueImpacts(currentPeriodData, previousPeriodData),
                cogs: calculateCogsImpacts(currentPeriodData, previousPeriodData),
                opex: calculateOpexImpacts(currentPeriodData, previousPeriodData)
            };
            return impacts;
        }
        
        function calculateRevenueImpacts(current, previous) {
            const impacts = {
                salesRevenue: getAccountChange(current, previous, 4010),
                serviceRevenue: getAccountChange(current, previous, 4020),
                otherIncome: getAccountChange(current, previous, 4050),
                salesDiscounts: getAccountChange(current, previous, 4060) * -1, // Negative impact
                returnsAllowances: getAccountChange(current, previous, 4070) * -1, // Negative impact
                interestIncome: getAccountChange(current, previous, 4030)
            };
            return impacts;
        }
        
        function calculateCogsImpacts(current, previous) {
            const impacts = {
                directCogs: getAccountChange(current, previous, 5010),
                purchaseDiscounts: getAccountChange(current, previous, 5020) * -1, // Savings
                freightIn: getAccountChange(current, previous, 5030),
                directLabor: getAccountRangeChange(current, previous, 5100, 5130)
            };
            return impacts;
        }
        
        function calculateOpexImpacts(current, previous) {
            const impacts = {
                facilities: getAccountRangeChange(current, previous, 5200, 5250),
                marketing: getAccountRangeChange(current, previous, 5300, 5330),
                professional: getAccountRangeChange(current, previous, 5400, 5430),
                operations: getAccountRangeChange(current, previous, 5500, 5999)
            };
            return impacts;
        }
        
        function getAccountChange(currentData, previousData, accountCode) {
            const current = getAccountBalance(currentData, accountCode);
            const previous = getAccountBalance(previousData, accountCode);
            return current - previous;
        }
        
        function getAccountRangeChange(currentData, previousData, startCode, endCode) {
            let currentTotal = 0;
            let previousTotal = 0;
            
            for (let code = startCode; code <= endCode; code++) {
                currentTotal += getAccountBalance(currentData, code);
                previousTotal += getAccountBalance(previousData, code);
            }
            
            return currentTotal - previousTotal;
        }
        
        function getAccountBalance(periodData, accountCode) {
            if (!periodData || !periodData.transactions) return 0;
            
            return periodData.transactions
                .filter(t => parseInt(t.account_code) === accountCode || parseInt(t.Account_Code) === accountCode)
                .reduce((sum, t) => {
                    // Handle both field naming conventions
                    const debit = parseFloat(t.debit_amount || t.Debit || 0);
                    const credit = parseFloat(t.credit_amount || t.Credit || 0);
                    
                    // For revenue accounts (4000s), credits increase the balance
                    if (accountCode >= 4000 && accountCode < 5000) {
                        return sum + (credit - debit);
                    }
                    // For expense accounts (5000s), debits increase the balance
                    else if (accountCode >= 5000) {
                        return sum + (debit - credit);
                    }
                    
                    return sum + (debit - credit);
                }, 0);
        }
        
        // Helper functions for period-based calculations
        function calculatePeriodExpenses(period) {
            if (!financialTransactions || financialTransactions.length === 0) {
                return 0;
            }
            
            const expenseTransactions = financialTransactions.filter(t => t.category === 'Expense');
            
            // Apply date filtering based on period
            const filteredTransactions = filterTransactionsByPeriod(expenseTransactions, period);
            
            return filteredTransactions.reduce((sum, t) => {
                return sum + (parseFloat(t.debit || 0) - parseFloat(t.credit || 0));
            }, 0);
        }
        
        function calculateInterestExpense(period) {
            if (!financialTransactions || financialTransactions.length === 0) {
                return 0;
            }
            
            // Find interest expense transactions (account codes typically 5300-5399)
            const interestTransactions = financialTransactions.filter(t => {
                const accountCode = t.account_code || '';
                return accountCode.startsWith('53') && t.category === 'Expense';
            });
            
            const filteredTransactions = filterTransactionsByPeriod(interestTransactions, period);
            
            return filteredTransactions.reduce((sum, t) => {
                return sum + (parseFloat(t.debit || 0) - parseFloat(t.credit || 0));
            }, 0);
        }
        
        function filterTransactionsByPeriod(transactions, period) {
            if (!period || period === 'custom') return transactions;
            
            const today = new Date();
            let startDate;
            
            switch(period) {
                case 'MTD':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    break;
                case 'QTD':
                    const quarter = Math.floor(today.getMonth() / 3);
                    startDate = new Date(today.getFullYear(), quarter * 3, 1);
                    break;
                case 'YTD':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    break;
                case 'L30D':
                    startDate = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
                    break;
                case 'L90D':
                    startDate = new Date(today.getTime() - (90 * 24 * 60 * 60 * 1000));
                    break;
                default:
                    return transactions;
            }
            
            return transactions.filter(t => {
                const transDate = new Date(t.transaction_date);
                return transDate >= startDate && transDate <= today;
            });
        }

        // NEW: Calculate Revenue Performance from GL Accounts
        function calculateRevenuePerformanceFromGL(periodType = 'YTD') {
            if (!financialTransactions || financialTransactions.length === 0) {
                console.log('No financial transactions available for revenue calculation');
                return { currentRevenue: 0, previousRevenue: 0, growthPercent: 0 };
            }
            
            const today = new Date();
            let currentStartDate, currentEndDate, previousStartDate, previousEndDate;
            
            // Define date ranges based on period type
            switch(periodType) {
                case 'MTD':
                    currentStartDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    currentEndDate = today;
                    previousStartDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    previousEndDate = new Date(today.getFullYear(), today.getMonth(), 0); // Last day of previous month
                    break;
                case 'QTD':
                    const currentQuarter = Math.floor(today.getMonth() / 3);
                    currentStartDate = new Date(today.getFullYear(), currentQuarter * 3, 1);
                    currentEndDate = today;
                    previousStartDate = new Date(today.getFullYear(), (currentQuarter - 1) * 3, 1);
                    previousEndDate = new Date(today.getFullYear(), currentQuarter * 3, 0);
                    break;
                case 'YTD':
                default:
                    currentStartDate = new Date(today.getFullYear(), 0, 1);
                    currentEndDate = today;
                    previousStartDate = new Date(today.getFullYear() - 1, 0, 1);
                    previousEndDate = new Date(today.getFullYear() - 1, 11, 31);
                    break;
            }
            
            // Filter transactions for current period AND exclude smart balance
            const currentPeriodTransactions = financialTransactions.filter(transaction => {
                const transactionDate = new Date(transaction.transaction_date);
                const isInDateRange = transactionDate >= currentStartDate && transactionDate <= currentEndDate;
                const isNotSmartBalance = transaction.source !== 'Smart-Balance' && 
                                        !transaction.description?.includes('Smart balance correction');
                return isInDateRange && isNotSmartBalance;
            });
            
            // Filter transactions for previous period AND exclude smart balance
            const previousPeriodTransactions = financialTransactions.filter(transaction => {
                const transactionDate = new Date(transaction.transaction_date);
                const isInDateRange = transactionDate >= previousStartDate && transactionDate <= previousEndDate;
                const isNotSmartBalance = transaction.source !== 'Smart-Balance' && 
                                        !transaction.description?.includes('Smart balance correction');
                return isInDateRange && isNotSmartBalance;
            });
            
            // Calculate revenue for both periods using GL revenue accounts (4000-4999)
            const currentRevenue = calculateGLRevenue(currentPeriodTransactions);
            const previousRevenue = calculateGLRevenue(previousPeriodTransactions);
            
            // Calculate growth percentage
            const growthPercent = previousRevenue > 0 ? 
                ((currentRevenue - previousRevenue) / previousRevenue) * 100 : 0;
            
            console.log('Revenue Performance Calculation:', {
                periodType,
                currentRevenue,
                previousRevenue,
                growthPercent: growthPercent.toFixed(1) + '%'
            });
            
            return {
                currentRevenue,
                previousRevenue,
                growthPercent
            };
        }
        
        // Helper function to calculate revenue from GL accounts
        function calculateGLRevenue(transactions) {
            let grossRevenue = 0;
            let discounts = 0;
            
            transactions.forEach(transaction => {
                const debitAmount = Math.abs(parseFloat(transaction.debit_amount) || 0);
                const creditAmount = Math.abs(parseFloat(transaction.credit_amount) || 0);
                const accountCode = parseInt(transaction.account_code) || 0;
                const accountName = (transaction.account_name || '').toLowerCase();
                
                // Process revenue accounts (4000-4999)
                if (accountCode >= 4000 && accountCode < 5000) {
                    // Revenue accounts: Credits increase revenue
                    const amount = creditAmount - debitAmount;
                    
                    // Check if it's a contra-revenue account (returns, allowances, discounts)
                    if (accountName.includes('return') || accountName.includes('allowance') || 
                        accountName.includes('discount') || accountCode === 4070 || accountCode === 4060) {
                        discounts += Math.abs(amount);
                    } else {
                        grossRevenue += Math.abs(amount);
                    }
                }
            });
            
            // Net Revenue = Gross Revenue - Discounts/Returns/Allowances
            const netRevenue = grossRevenue - discounts;
            
            console.log('GL Revenue Calculation:', {
                grossRevenue,
                discounts,
                netRevenue,
                transactionsProcessed: transactions.length
            });
            
            return netRevenue;
        }

        async function calculateDashboardBudgetVariance() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return { variance: 0, status: 'No budget data' };
                
                // Get current period (YTD)
                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth() + 1;
                
                // Define monthsToInclude for YTD
                const monthsToInclude = [];
                for (let i = 1; i <= currentMonth; i++) {
                    monthsToInclude.push(i);
                }
                
                // Get YTD actual data
                const ytdActualData = calculateFinancialDataFromTransactions(
                    getTransactionsForPeriodFixed('YTD', 'custom'), 'YTD', 'custom'
                );
                
                // Get YTD budget data from the correct table (budgets, not budget_entries)
                const { data: budgetData, error } = await supabase
                    .from('budgets')
                    .select('*')
                    .eq('user_id', user.id)
                    .eq('budget_year', currentYear)
                    .in('budget_month', monthsToInclude);
                    
                if (error) {
                    console.error('Error fetching budget data:', error);
                    return { variance: 0, status: 'Budget data error' };
                }
                
                if (!budgetData || budgetData.length === 0) {
                    return { variance: 0, status: 'No budget set' };
                }
                
                // Calculate YTD budget totals using the correct structure
                const ytdBudgetData = calculateBudgetTotalsFromBudgetsTable(budgetData);
                
                // Calculate key variances
                const revenueVariance = ytdBudgetData.revenue !== 0 ? 
                    ((ytdActualData.netRevenue - ytdBudgetData.revenue) / ytdBudgetData.revenue) * 100 : 0;
                const opexVariance = ytdBudgetData.opex !== 0 ? 
                    ((ytdActualData.opex - ytdBudgetData.opex) / ytdBudgetData.opex) * 100 : 0;
                const ebitdaVariance = ytdBudgetData.ebitda !== 0 ? 
                    ((ytdActualData.ebitda - ytdBudgetData.ebitda) / ytdBudgetData.ebitda) * 100 : 0;
                
                // Overall variance (weighted average)
                const overallVariance = (revenueVariance * 0.4 + opexVariance * -0.3 + ebitdaVariance * 0.3);
                
                let status;
                if (Math.abs(overallVariance) <= 5) status = 'On track';
                else if (overallVariance > 5) status = 'Above budget';
                else status = 'Below budget';
                
                return {
                    variance: overallVariance,
                    status,
                    details: {
                        revenueVariance,
                        opexVariance,
                        ebitdaVariance,
                        actual: ytdActualData,
                        budget: ytdBudgetData
                    }
                };
                
            } catch (error) {
                console.error('Error calculating budget variance:', error);
                return { variance: 0, status: 'Calculation error' };
            }
        }

        function calculateBudgetTotalsFromBudgetsTable(budgetData, periodType = 'YTD') {
            const totals = { revenue: 0, cogs: 0, opex: 0, ebitda: 0 };
            
            // Get current date info for period calculations
            const today = new Date();
            const currentMonth = today.getMonth() + 1; // 1-based month
            let monthsToSum = [];
            
            // Determine which months to include based on period type
            switch(periodType) {
                case 'MTD':
                    monthsToSum = [currentMonth];
                    break;
                case 'QTD':
                    const currentQuarter = Math.floor((currentMonth - 1) / 3);
                    const quarterStartMonth = currentQuarter * 3 + 1;
                    for (let i = quarterStartMonth; i <= currentMonth; i++) {
                        monthsToSum.push(i);
                    }
                    break;
                case 'YTD':
                default:
                    for (let i = 1; i <= currentMonth; i++) {
                        monthsToSum.push(i);
                    }
                    break;
            }
            
            console.log(`Budget calculation for ${periodType}: Including months ${monthsToSum.join(', ')}`);
            
            // Only sum budget entries for the relevant months
            budgetData.forEach(entry => {
                const amount = parseFloat(entry.amount) || 0;
                const budgetMonth = parseInt(entry.budget_month);
                const category = entry.category;
                
                // Only include this entry if its month is in our target period
                if (monthsToSum.includes(budgetMonth)) {
                    console.log(`Including budget: Month ${budgetMonth}, Category ${category}, Amount ${amount}`);
                    switch(category) {
                        case 'revenue':
                            totals.revenue += amount;
                            break;
                        case 'cogs':
                            totals.cogs += amount;
                            break;
                        case 'opex':
                            totals.opex += amount;
                            break;
                    }
                } else {
                    console.log(`Excluding budget: Month ${budgetMonth} not in period ${periodType}`);
                }
            });
            
            totals.ebitda = totals.revenue - totals.cogs - totals.opex;
            
            console.log(`Final budget totals for ${periodType}:`, totals);
            return totals;
        }
        
        async function updateDashboardCardsWithGL(metrics) {
            console.log('=== UPDATING DASHBOARD CARDS WITH COMPLETE DATA ===');
            console.log('Metrics to update:', metrics);
            
            // Get the dashboard cards container
            const dashboardSection = document.getElementById('dashboard-section');
            if (!dashboardSection) {
                console.error('Dashboard section not found');
                return;
            }
            
            // Card 1: Cash & Liquidity (keep existing AP/AR logic)
            const cashElement = document.getElementById('cashValue');
            const cashChangeElement = document.getElementById('cashChange');
            
            if (cashElement) {
                cashElement.textContent = formatCurrencyFull(metrics.currentCash, 'IDR');
            }
            if (cashChangeElement) {
                const changePercent = metrics.currentCash >= 0 ? '+12.5%' : '-8.2%';
                cashChangeElement.textContent = `${changePercent} vs last period`;
                cashChangeElement.className = `metric-change ${metrics.currentCash >= 0 ? 'positive' : 'negative'}`;
            }
            
            // Card 2: Revenue Performance (using GL accounts)
            const revenueElement = document.getElementById('revenuePerformanceValue');
            const revenueChangeElement = document.getElementById('revenuePerformanceChange');
            
            if (revenueElement) {
                // Get YTD transactions but exclude smart balance corrections
                const allYTDTransactions = getTransactionsForPeriodFixed('YTD', 'custom');
                const filteredTransactions = allYTDTransactions.filter(tx => 
                    tx.source !== 'Smart-Balance' && 
                    !tx.description?.includes('Smart balance correction')
                );
                
                const currentYearData = calculateFinancialDataFromTransactions(filteredTransactions, 'YTD', 'custom');
                
                revenueElement.textContent = formatCurrencyFull(currentYearData.netRevenue, 'IDR');
                console.log('Revenue Performance - using netRevenue (excluding smart balance):', currentYearData.netRevenue);
            }
            
            if (revenueChangeElement) {
                // Calculate YoY growth using the same logic (also exclude smart balance)
                const currentYearTransactions = getTransactionsForPeriodFixed('YTD', 'custom').filter(tx => 
                    tx.source !== 'Smart-Balance' && 
                    !tx.description?.includes('Smart balance correction')
                );
                
                const lastYearTransactions = financialTransactions.filter(transaction => {
                    const transactionDate = new Date(transaction.transaction_date);
                    const lastYear = new Date().getFullYear() - 1;
                    const startDate = new Date(lastYear, 0, 1);
                    const endDate = new Date(lastYear, new Date().getMonth(), new Date().getDate());
                    const isInRange = transactionDate >= startDate && transactionDate <= endDate;
                    const isNotSmartBalance = transaction.source !== 'Smart-Balance' && 
                                            !transaction.description?.includes('Smart balance correction');
                    return isInRange && isNotSmartBalance;
                });
                
                const currentYearRevenue = calculateFinancialDataFromTransactions(currentYearTransactions, 'YTD', 'custom').netRevenue;
                const lastYearRevenue = calculateFinancialDataFromTransactions(lastYearTransactions, 'YTD', 'custom').netRevenue;
                
                const growthPercent = lastYearRevenue > 0 ? ((currentYearRevenue - lastYearRevenue) / lastYearRevenue) * 100 : 0;
                revenueChangeElement.textContent = `${growthPercent >= 0 ? '+' : ''}${growthPercent.toFixed(1)}% vs last year`;
                revenueChangeElement.className = `metric-change ${growthPercent >= 0 ? 'positive' : 'negative'}`;
            }
            
            // Card 3: Profitability (calculate Net Income Margin)
            const profitabilityElement = document.getElementById('profitabilityValue');
            const profitabilityChangeElement = document.getElementById('profitabilityChange');
            
            if (profitabilityElement && profitabilityChangeElement) {
                const currentYearTransactions = getTransactionsForPeriodFixed('YTD', 'custom');
                const currentYearData = calculateFinancialDataFromTransactions(currentYearTransactions);
                
                // Net Income Margin = Net Income / Net Revenue * 100
                const netIncomeMargin = currentYearData.netRevenue > 0 ? 
                    (currentYearData.netIncome / currentYearData.netRevenue) * 100 : 0;
                    
                profitabilityElement.textContent = `${netIncomeMargin.toFixed(1)}%`;
                profitabilityChangeElement.textContent = netIncomeMargin >= 10 ? 'Strong margin' : netIncomeMargin >= 5 ? 'Good margin' : 'Monitor margin';
                profitabilityChangeElement.className = `metric-change ${netIncomeMargin >= 10 ? 'positive' : netIncomeMargin >= 5 ? 'neutral' : 'negative'}`;
                
                console.log('Profitability calculation:', {
                    netIncome: currentYearData.netIncome,
                    netRevenue: currentYearData.netRevenue,
                    netIncomeMargin: netIncomeMargin
                });
            }
            
            // Card 4: Working Capital (calculate from current balance sheet data)
            const workingCapitalElement = document.getElementById('workingCapitalValue');
            const workingCapitalChangeElement = document.getElementById('workingCapitalChange');
            
            if (workingCapitalElement && workingCapitalChangeElement) {
                // Simple working capital calculation (Current Assets - Current Liabilities)
                // For now, use a basic calculation from available data
                const workingCapital = metrics.currentCash + (metrics.currentCash * 0.3); // Simplified
                const currentRatio = workingCapital > 0 ? 1.5 : 0.8; // Simplified calculation
                
                workingCapitalElement.textContent = formatCurrencyFull(workingCapital, 'IDR');
                workingCapitalChangeElement.textContent = currentRatio >= 1.2 ? 'Healthy ratio' : 'Monitor liquidity';
                workingCapitalChangeElement.className = `metric-change ${currentRatio >= 1.2 ? 'positive' : 'neutral'}`;
            }
            
            // Card 5: Budget Variance (show Revenue Variance specifically)
            const budgetVarianceElement = document.getElementById('budgetVarianceValue');
            const budgetVarianceChangeElement = document.getElementById('budgetVarianceChange');
            
            if (budgetVarianceElement && budgetVarianceChangeElement) {
                try {
                    const budgetVariance = await calculateDashboardBudgetVariance();
                    
                    if (budgetVariance.details && budgetVariance.details.revenueVariance !== undefined) {
                        const revenueVariance = budgetVariance.details.revenueVariance;
                        
                        budgetVarianceElement.textContent = `${revenueVariance >= 0 ? '+' : ''}${revenueVariance.toFixed(1)}%`;
                        budgetVarianceChangeElement.textContent = `Revenue vs Budget`;
                        
                        // Color coding based on variance
                        if (Math.abs(revenueVariance) <= 5) {
                            budgetVarianceChangeElement.className = 'metric-change positive';
                        } else if (revenueVariance > 5) {
                            budgetVarianceChangeElement.className = 'metric-change positive';
                        } else {
                            budgetVarianceChangeElement.className = 'metric-change negative';
                        }
                        
                        console.log('Budget Variance (Revenue):', revenueVariance);
                    } else {
                        budgetVarianceElement.textContent = 'N/A';
                        budgetVarianceChangeElement.textContent = budgetVariance.status;
                        budgetVarianceChangeElement.className = 'metric-change neutral';
                    }
                } catch (error) {
                    console.error('Error calculating budget variance for card:', error);
                    budgetVarianceElement.textContent = 'N/A';
                    budgetVarianceChangeElement.textContent = 'Budget data error';
                    budgetVarianceChangeElement.className = 'metric-change neutral';
                }
            }
            
            // Card 6: Industry Position (NEW: using industry benchmarking data)
            const industryPositionElement = document.getElementById('industryPositionValue');
            const industryPositionChangeElement = document.getElementById('industryPositionChange');
            
            if (industryPositionElement && industryPositionChangeElement) {
                try {
                    const industryPosition = calculateDashboardIndustryPosition();
                    
                    if (industryPosition.percentile !== 0 && industryPosition.status !== 'Set up benchmarking') {
                        industryPositionElement.textContent = `${industryPosition.percentile}th`;
                        industryPositionChangeElement.textContent = industryPosition.status;
                        
                        // Color coding based on percentile
                        if (industryPosition.percentile >= 75) {
                            industryPositionChangeElement.className = 'metric-change positive';
                        } else if (industryPosition.percentile >= 50) {
                            industryPositionChangeElement.className = 'metric-change neutral';
                        } else {
                            industryPositionChangeElement.className = 'metric-change negative';
                        }
                    } else if (industryPosition.status === 'Set up benchmarking') {
                        industryPositionElement.textContent = '--';
                        industryPositionChangeElement.innerHTML = '<a href="#" onclick="switchToIndustryBenchmarking()" style="color: inherit; text-decoration: underline;">Set up benchmarking</a>';
                        industryPositionChangeElement.className = 'metric-change neutral';
                    } else {
                        industryPositionElement.textContent = 'N/A';
                        industryPositionChangeElement.textContent = industryPosition.status;
                        industryPositionChangeElement.className = 'metric-change neutral';
                    }
                } catch (error) {
                    console.error('Error calculating industry position:', error);
                    industryPositionElement.textContent = 'Error';
                    industryPositionChangeElement.textContent = 'Check industry data';
                    industryPositionChangeElement.className = 'metric-change neutral';
                }
            }
            
            // Card 7: Altman Z-Score (enhance existing functionality)
            const healthScoreElement = document.getElementById('healthScoreValue');
            const healthScoreStatusElement = document.getElementById('healthScoreStatus');
            const healthScoreBarElement = document.getElementById('healthScoreBar');
            const healthScoreDescriptionElement = document.getElementById('healthScoreDescription');
            
            if (healthScoreElement && healthScoreStatusElement) {
                // Calculate Altman Z-Score using current financial data
                const zScore = calculateAltmanZScore();
                
                healthScoreElement.textContent = zScore.toFixed(1);
                
                // Determine status and color based on Z-Score
                let status, barWidth, statusColor;
                if (zScore >= 3.0) {
                    status = 'Safe Zone';
                    barWidth = '100%';
                    statusColor = '#10b981';
                } else if (zScore >= 1.8) {
                    status = 'Grey Zone';
                    barWidth = '60%';
                    statusColor = '#fbbf24';
                } else {
                    status = 'Distress Zone';
                    barWidth = '30%';
                    statusColor = '#ef4444';
                }
                
                healthScoreStatusElement.textContent = status;
                healthScoreStatusElement.style.color = statusColor;
                
                if (healthScoreBarElement) {
                    healthScoreBarElement.style.width = barWidth;
                    healthScoreBarElement.style.background = statusColor;
                }
                
                if (healthScoreDescriptionElement) {
                    healthScoreDescriptionElement.textContent = 
                        `Score: ${zScore.toFixed(1)} indicates ${status.toLowerCase()}. Based on working capital, retained earnings, and profitability ratios.`;
                }
            }
            
            console.log('Dashboard successfully updated with complete GL, budget, and industry data');
        }

        function getCurrentYTDPeriod() {
            const today = new Date();
            return `${today.getFullYear()}-01-01_to_${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }

        function switchToIndustryBenchmarking() {
            // Find the Industry Benchmarking tab and click it
            const benchmarkingTab = document.querySelector('[data-section="benchmarking"]');
            if (benchmarkingTab) {
                benchmarkingTab.click();
            }
        }

        function calculateCompanyFinancialMetrics() {
            try {
                // Get current year financial data
                const currentYearData = calculateFinancialDataFromTransactions(
                    getTransactionsForPeriodFixed('YTD', 'custom'), 'YTD', 'custom'
                );
                
                // Calculate key financial ratios
                const metrics = {};
                
                // Profitability Ratios
                metrics.gross_margin = currentYearData.netRevenue > 0 ? 
                    (currentYearData.grossProfit / currentYearData.netRevenue) * 100 : 0;
                metrics.ebitda_margin = currentYearData.netRevenue > 0 ? 
                    (currentYearData.ebitda / currentYearData.netRevenue) * 100 : 0;
                metrics.net_margin = currentYearData.netRevenue > 0 ? 
                    (currentYearData.netIncome / currentYearData.netRevenue) * 100 : 0;
                
                // Simplified ratios (would need proper balance sheet data for accuracy)
                // Using available cash flow and revenue data for approximations
                const estimatedAssets = currentYearData.netRevenue * 0.8; // Simplified
                const estimatedEquity = estimatedAssets * 0.6; // Simplified
                
                metrics.roe = estimatedEquity > 0 ? 
                    (currentYearData.netIncome / estimatedEquity) * 100 : 0;
                metrics.roa = estimatedAssets > 0 ? 
                    (currentYearData.netIncome / estimatedAssets) * 100 : 0;
                metrics.asset_turnover = estimatedAssets > 0 ? 
                    currentYearData.netRevenue / estimatedAssets : 0;
                
                // Liquidity ratios (simplified using available data)
                const currentAssets = Math.max(currentYearData.netRevenue * 0.2, 100000000); // Simplified
                const currentLiabilities = currentAssets * 0.7; // Simplified
                
                metrics.current_ratio = currentLiabilities > 0 ? currentAssets / currentLiabilities : 1.5;
                metrics.quick_ratio = currentLiabilities > 0 ? (currentAssets * 0.8) / currentLiabilities : 1.2;
                
                // Leverage ratio (simplified)
                const totalDebt = estimatedAssets * 0.3; // Simplified
                metrics.debt_to_equity = estimatedEquity > 0 ? totalDebt / estimatedEquity : 0.5;
                
                // Store metrics globally for industry comparison
                window.companyFinancialMetrics = metrics;
                
                console.log('Company financial metrics calculated:', metrics);
                return metrics;
                
            } catch (error) {
                console.error('Error calculating company financial metrics:', error);
                window.companyFinancialMetrics = {};
                return {};
            }
        }

        async function initializeDashboardData() {
            try {
                console.log('=== INITIALIZING ENHANCED DASHBOARD ===');

                if (!financialTransactions || financialTransactions.length === 0) {
                    console.log(' Financial transactions not loaded yet');
                    setTimeout(initializeDashboardData, 1000);
                    return;
                }
                
                if (!aparTransactions || aparTransactions.length === 0) {
                    console.log(' AP/AR transactions not loaded yet');
                    setTimeout(initializeDashboardData, 1000);
                    return;
                }
                
                console.log(' All data loaded, proceeding with initialization...');
                
                // Step 1: Calculate company financial metrics for industry comparison
                calculateCompanyFinancialMetrics();
                
                // Step 2: Load industry benchmarking data if available
                if (window.selectedIndustries && window.selectedIndustries.length > 0) {
                    await loadIndustryBenchmarks();
                }
                
                // Step 3: Calculate AP/AR metrics for cash and working capital
                const metrics = calculateDashboardMetrics();
                
                // Step 4: Update all dashboard cards with complete data
                await updateDashboardCardsWithGL(metrics);
                
                // Step 5: Initialize all dashboard components
                initializeDashboardComponents();
                
                // Step 6: Update cash flow forecast
                refreshForecast();
                
                console.log('Enhanced dashboard initialization complete');
                
            } catch (error) {
                console.error('Error initializing enhanced dashboard:', error);
                
                // Fallback: Initialize basic dashboard if enhanced fails
                try {
                    const basicMetrics = calculateDashboardMetrics();
                    await updateDashboardCardsWithGL(basicMetrics);
                    refreshForecast();
                } catch (fallbackError) {
                    console.error('Fallback initialization also failed:', fallbackError);
                }
            }
        }
        
        // Helper function to calculate Altman Z-Score
        function calculateAltmanZScore() {
            try {
                // Get YTD financial data
                const ytdTransactions = getTransactionsForPeriodFixed('YTD', 'custom');
                if (!ytdTransactions || ytdTransactions.length === 0) {
                    console.log('No YTD transactions available for Z-Score calculation');
                    return 1.8; // Default safe value
                }
        
                // Calculate balance sheet components from transactions
                const balanceSheet = calculateBalanceSheetFromTransactions(ytdTransactions);
                const incomeStatement = calculateIncomeStatementFromTransactions(ytdTransactions);
                
                console.log('Z-Score Balance Sheet:', balanceSheet);
                console.log('Z-Score Income Statement:', incomeStatement);
        
                // Altman Z-Score Formula: Z = 1.2A + 1.4B + 3.3C + 0.6D + 1.0E
                
                // A = Working Capital / Total Assets
                const workingCapital = balanceSheet.currentAssets - balanceSheet.currentLiabilities;
                const ratioA = balanceSheet.totalAssets > 0 ? workingCapital / balanceSheet.totalAssets : 0;
                
                // B = Retained Earnings / Total Assets  
                const ratioB = balanceSheet.totalAssets > 0 ? balanceSheet.retainedEarnings / balanceSheet.totalAssets : 0;
                
                // C = EBIT / Total Assets
                const ebit = incomeStatement.netRevenue - incomeStatement.totalExpenses + incomeStatement.interestExpense; // Add back interest to get EBIT
                const ratioC = balanceSheet.totalAssets > 0 ? ebit / balanceSheet.totalAssets : 0;
                
                // D = Market Value of Equity / Total Liabilities (simplified as Book Value for private companies)
                const bookValueEquity = balanceSheet.totalAssets - balanceSheet.totalLiabilities;
                const ratioD = balanceSheet.totalLiabilities > 0 ? bookValueEquity / balanceSheet.totalLiabilities : 1;
                
                // E = Sales / Total Assets
                const ratioE = balanceSheet.totalAssets > 0 ? incomeStatement.netRevenue / balanceSheet.totalAssets : 0;
                
                // Calculate Z-Score
                const zScore = (1.2 * ratioA) + (1.4 * ratioB) + (3.3 * ratioC) + (0.6 * ratioD) + (1.0 * ratioE);
                
                console.log('Z-Score Components:', {
                    ratioA: ratioA.toFixed(3),
                    ratioB: ratioB.toFixed(3), 
                    ratioC: ratioC.toFixed(3),
                    ratioD: ratioD.toFixed(3),
                    ratioE: ratioE.toFixed(3),
                    workingCapital: workingCapital,
                    totalAssets: balanceSheet.totalAssets,
                    zScore: zScore.toFixed(2)
                });
                
                return Math.max(0, zScore);
                
            } catch (error) {
                console.error('Error calculating Altman Z-Score:', error);
                return 1.8; // Return safe default
            }
        }

        function calculateBalanceSheetFromTransactions(transactions) {
            let currentAssets = 0;
            let totalAssets = 0;
            let currentLiabilities = 0; 
            let totalLiabilities = 0;
            let retainedEarnings = 0;
            
            transactions.forEach(tx => {
                const debit = parseFloat(tx.debit_amount || 0);
                const credit = parseFloat(tx.credit_amount || 0);
                const netAmount = debit - credit;
                
                // Assets (normally debit balance)
                if (tx.account_code.startsWith('1')) {
                    totalAssets += netAmount;
                    // Current assets (1000-1999)
                    if (tx.account_code.startsWith('10') || tx.account_code.startsWith('11') || tx.account_code.startsWith('12')) {
                        currentAssets += netAmount;
                    }
                }
                // Liabilities (normally credit balance, so we reverse)
                else if (tx.account_code.startsWith('2')) {
                    totalLiabilities -= netAmount; // Reverse for credit balance
                    // Current liabilities (2000-2999) 
                    if (tx.account_code.startsWith('20') || tx.account_code.startsWith('21') || tx.account_code.startsWith('22')) {
                        currentLiabilities -= netAmount; // Reverse for credit balance
                    }
                }
                // Equity - Retained Earnings (3040)
                else if (tx.account_code === '3040') {
                    retainedEarnings -= netAmount; // Reverse for credit balance
                }
            });
            
            return {
                currentAssets,
                totalAssets,
                currentLiabilities, 
                totalLiabilities,
                retainedEarnings
            };
        }

        function calculateIncomeStatementFromTransactions(transactions) {
            let netRevenue = 0;
            let totalExpenses = 0;
            let interestExpense = 0;
            
            transactions.forEach(tx => {
                const debit = parseFloat(tx.debit_amount || 0);
                const credit = parseFloat(tx.credit_amount || 0);
                
                // Revenue accounts (4000s) - normally credit balance
                if (tx.account_code.startsWith('4')) {
                    netRevenue += credit - debit;
                }
                // Expense accounts (5000s) - normally debit balance  
                else if (tx.account_code.startsWith('5')) {
                    totalExpenses += debit - credit;
                    // Interest expense (5900s)
                    if (tx.account_code.startsWith('59')) {
                        interestExpense += debit - credit;
                    }
                }
            });
            
            return {
                netRevenue,
                totalExpenses,
                interestExpense
            };
        }
        
        // Add this function to update cash flow forecast metrics
        function updateCashFlowMetrics(metrics) {
            console.log('=== UPDATING CASH FLOW METRICS WITH REAL DATA ===');
            
            // Calculate realistic burn rate from your actual AP data
            const monthlyAP = aparTransactions
                .filter(t => t.type === 'AP' && (t.status === 'Unpaid' || t.status === 'Overdue'))
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            // Spread AP payments over 3 months for realistic burn rate
            const monthlyBurnRate = monthlyAP / 3;
            const weeklyBurnRate = monthlyBurnRate / 4.33; // Average weeks per month
            const dailyBurnRate = monthlyBurnRate / 30;
            
            // Calculate realistic runway based on current cash and burn rate
            const currentCash = metrics.currentCash;
            let runwayDays, runwayWeeks, runwayMonths;
            
            if (currentCash <= 0 || monthlyBurnRate <= 0) {
                runwayDays = 0;
                runwayWeeks = 0;
                runwayMonths = 0;
            } else {
                runwayDays = Math.floor(currentCash / dailyBurnRate);
                runwayWeeks = Math.floor(runwayDays / 7);
                runwayMonths = Math.floor(runwayDays / 30);
            }
            
            console.log('Calculated runway:', {
                currentCash: formatCurrencyFull(currentCash, 'IDR'),
                monthlyBurn: formatCurrencyFull(monthlyBurnRate, 'IDR'),
                dailyBurn: formatCurrencyFull(dailyBurnRate, 'IDR'),
                runwayDays
            });
            
            // Update runway display
            const cashRunwayDays = document.getElementById('cashRunwayDays');
            const cashRunwayWeeks = document.getElementById('cashRunwayWeeks');
            const cashRunwayMonths = document.getElementById('cashRunwayMonths');
            
            if (cashRunwayDays) cashRunwayDays.textContent = runwayDays;
            if (cashRunwayWeeks) cashRunwayWeeks.textContent = runwayWeeks;
            if (cashRunwayMonths) cashRunwayMonths.textContent = runwayMonths;
            
            // Update burn rates with realistic calculations
            const dailyBurnElement = document.getElementById('dailyBurn');
            const weeklyBurnElement = document.getElementById('weeklyBurn');
            const monthlyBurnElement = document.getElementById('monthlyBurn');
            
            if (dailyBurnElement) dailyBurnElement.textContent = formatCurrencyFull(dailyBurnRate, 'IDR');
            if (weeklyBurnElement) weeklyBurnElement.textContent = formatCurrencyFull(weeklyBurnRate, 'IDR');
            if (monthlyBurnElement) monthlyBurnElement.textContent = formatCurrencyFull(monthlyBurnRate, 'IDR');
            
            // Update cash flow health indicators with REAL upcoming payments
            updateCashFlowHealthIndicators(metrics);
            
            // Update cash flow trend
            const trendElement = document.getElementById('cashFlowTrend');
            if (trendElement) {
                if (currentCash > 0 && runwayMonths > 6) {
                    trendElement.textContent = 'Improving';
                    trendElement.className = 'trend-indicator improving';
                } else if (currentCash > 0 && runwayMonths > 3) {
                    trendElement.textContent = 'Stable';
                    trendElement.className = 'trend-indicator stable';
                } else {
                    trendElement.textContent = 'Declining';
                    trendElement.className = 'trend-indicator declining';
                }
            }
            
            console.log('Updated cash flow metrics:', {
                runway: `${runwayDays} days / ${runwayWeeks} weeks / ${runwayMonths} months`,
                dailyBurn: formatCurrencyFull(dailyBurnRate, 'IDR'),
                monthlyBurn: formatCurrencyFull(monthlyBurnRate, 'IDR')
            });
        }
        
        // Add this function to update cash flow health indicators
        function updateCashFlowHealthIndicators(metrics) {
            console.log('=== UPDATING CASH FLOW HEALTH INDICATORS ===');
            
            // Use the existing calculateCashFlowHealth function
            const healthData = calculateCashFlowHealth();
            
            console.log('Cash flow health data:', healthData);
            
            // Update largest payment
            const biggestPaymentElement = document.getElementById('biggestPayment');
            if (biggestPaymentElement) {
                if (healthData.biggestPayment > 0) {
                    const paymentText = `${formatCurrencyFull(healthData.biggestPayment, 'IDR')} to ${healthData.biggestPaymentRef}`;
                    biggestPaymentElement.textContent = paymentText;
                    console.log('Updated largest payment:', paymentText);
                } else {
                    biggestPaymentElement.textContent = 'No payments due';
                    console.log('No payments due');
                }
            }
            
            // Update largest collection
            const largestCollectionElement = document.getElementById('largestCollection');
            if (largestCollectionElement) {
                if (healthData.largestCollection > 0) {
                    const collectionText = `${formatCurrencyFull(healthData.largestCollection, 'IDR')} from ${healthData.largestCollectionRef}`;
                    largestCollectionElement.textContent = collectionText;
                    console.log('Updated largest collection:', collectionText);
                } else {
                    largestCollectionElement.textContent = 'No collections due';
                    console.log('No collections due');
                }
            }
            
            // Update trend indicator
            const trendElement = document.getElementById('cashFlowTrend');
            if (trendElement) {
                let trendText = healthData.trend.charAt(0).toUpperCase() + healthData.trend.slice(1);
                trendElement.textContent = trendText;
                trendElement.className = `trend-indicator ${healthData.trend}`;
                console.log('Updated trend:', trendText);
            }
            
            console.log('=== CASH FLOW HEALTH INDICATORS UPDATE COMPLETE ===');
        }

        function getRiskClass(riskLevel) {
            switch(riskLevel) {
                case 'very-low': return 'excellent';
                case 'low': return 'positive';
                case 'moderate': return 'neutral';
                case 'high': return 'negative';
                case 'critical': return 'critical';
                default: return 'neutral';
            }
        }
        
        function getRiskDescription(riskLevel) {
            switch(riskLevel) {
                case 'very-low': return 'Excellent for lending/investment';
                case 'low': return 'Safe for credit extension';
                case 'moderate': return 'Requires closer monitoring';
                case 'high': return 'Credit review recommended';
                case 'critical': return 'Immediate attention required';
                default: return 'Insufficient data';
            }
        }

        function showZScoreBreakdown() {
            const altmanResult = calculateRatioBasedHealthScore();
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.8); z-index: 1000;
                display: flex; align-items: center; justify-content: center;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white; border-radius: 12px; padding: 30px;
                    max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #1e293b;">Altman Z-Score Breakdown</h3>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #1e293b;">
                            Z-Score: ${altmanResult.zScore.toFixed(2)}
                        </div>
                        <div style="color: #64748b; margin-top: 5px;">
                            Rating: ${altmanResult.rating} | Risk: ${getRiskDescription(altmanResult.riskLevel)}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #1e293b; margin-bottom: 15px;">Components Breakdown:</h4>
                        ${generateComponentsHTML(altmanResult.breakdown)}
                    </div>
                    
                    <div style="padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <strong>Recommendation:</strong><br>
                        ${altmanResult.recommendation}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function generateComponentsHTML(breakdown) {
            const components = [
                { name: 'Working Capital / Total Assets', value: breakdown.workingCapitalToAssets, weight: 1.2 },
                { name: 'Retained Earnings / Total Assets', value: breakdown.retainedEarningsToAssets, weight: 1.4 },
                { name: 'EBIT / Total Assets', value: breakdown.ebitToAssets, weight: 3.3 },
                { name: 'Market Value Equity / Total Liabilities', value: breakdown.marketValueEquityToLiabilities, weight: 0.6 },
                { name: 'Sales / Total Assets', value: breakdown.salesToAssets, weight: 1.0 }
            ];
            
            return components.map(comp => `
                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e2e8f0;">
                    <div>
                        <div style="font-weight: 500;">${comp.name}</div>
                        <div style="font-size: 12px; color: #64748b;">Weight: ${comp.weight}</div>
                    </div>
                    <div style="text-align: right;">
                        <div>${comp.value.toFixed(3)}</div>
                        <div style="font-size: 12px; color: #64748b;">
                            = ${(comp.value * comp.weight).toFixed(3)}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Audit Trail Function
        async function logAuditTrail(tableName, recordId, action, oldValues, newValues) {
            try {
                const auditData = {
                    table_name: tableName,
                    record_id: recordId,
                    action: action,
                    old_values: oldValues,
                    new_values: newValues,
                    user_info: 'System User',
                    user_id: (await supabase.auth.getUser()).data.user?.id
                };
                
                const { error } = await supabase
                    .from('audit_logs_meridash')
                    .insert([auditData]);
                
                if (error) throw error;
            } catch (error) {
                console.error('Error logging audit trail:', error);
            }
        }

        // Add this function to handle date formatting
        function formatDateForDatabase(dateString) {
            if (!dateString) return null;
            
            // Handle different date formats
            let date;
            
            // Check if it's already in YYYY-MM-DD format
            if (dateString.match(/^\d{4}-\d{2}-\d{2}Rp /)) {
                return dateString;
            }
            
            // Handle DD/MM/YYYY format
            if (dateString.match(/^\d{1,2}\/\d{1,2}\/\d{4}Rp /)) {
                const [day, month, year] = dateString.split('/');
                date = new Date(year, month - 1, day);
            }
            // Handle MM/DD/YYYY format
            else if (dateString.match(/^\d{1,2}-\d{1,2}-\d{4}Rp /)) {
                const [month, day, year] = dateString.split('-');
                date = new Date(year, month - 1, day);
            }
            // Try to parse as general date
            else {
                date = new Date(dateString);
            }
            
            // Validate date and return in YYYY-MM-DD format
            if (isNaN(date.getTime())) {
                console.error('Invalid date:', dateString);
                return null;
            }
            
            return date.toISOString().split('T')[0]; // Returns YYYY-MM-DD format
        }

        function ensureFreshReports() {
            // Auto-refresh reports when tab becomes visible
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        const reportsTab = document.getElementById('reports-tab');
                        if (reportsTab && reportsTab.style.display !== 'none' && reportsTab.classList.contains('active')) {
                            generateReports();
                        }
                    }
                });
            });

            const reportsTab = document.getElementById('reports-tab');
            if (reportsTab) {
                observer.observe(reportsTab, { attributes: true, attributeFilter: ['style', 'class'] });
            }
        }

        // Add these JavaScript functions to the <script> section in dashboard.html

        // Reports & Analytics Variables
        let comparisonData = {
            current: null,
            previous: null,
            lastYear: null
        };
        
        let availablePeriods = [];
        
        // Initialize Reports & Analytics when page loads
        function initializeReportsAnalytics() {
            hideOldYoYCheckbox();
            populateAvailablePeriods();
            setDefaultPeriods();
            updatePeriodSelection();
        }
        
        // Populate available periods from financial data
        function populateAvailablePeriods() {
            // Generate last 24 months for demo
            const periods = [];
            const today = new Date();
            
            for (let i = 0; i < 24; i++) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const period = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const displayName = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                
                periods.push({
                    value: period,
                    display: displayName,
                    date: date
                });
            }
            
            availablePeriods = periods;
            
            // Populate select dropdowns
            const currentSelect = document.getElementById('currentPeriod');
            const previousSelect = document.getElementById('previousPeriod');
            
            periods.forEach(period => {
                const option1 = new Option(period.display, period.value);
                const option2 = new Option(period.display, period.value);
                currentSelect.appendChild(option1);
                previousSelect.appendChild(option2);
            });
        }
        
        // Set default periods (current month and previous month)
        function setDefaultPeriods() {
            const currentSelect = document.getElementById('currentPeriod');
            const previousSelect = document.getElementById('previousPeriod');
            
            if (availablePeriods.length >= 2) {
                currentSelect.value = availablePeriods[0].value; // Current month
                previousSelect.value = availablePeriods[1].value; // Previous month
            }
            
            updateYoYDisplay();
        }

        // Update YoY display text
        function updateYoYDisplay() {
            const currentPeriod = document.getElementById('currentPeriod').value;
            const yoyDisplay = document.getElementById('yoyPeriodDisplay');
            
            if (currentPeriod) {
                const [year, month] = currentPeriod.split('-').map(Number);
                const lastYear = year - 1;
                const lastYearPeriod = `${lastYear}-${String(month).padStart(2, '0')}`;
                
                const monthName = new Date(lastYear, month - 1).toLocaleDateString('en-US', { month: 'long' });
                yoyDisplay.textContent = `${monthName} ${lastYear} (if available)`;
            }
        }
        
        // Update period selection and trigger comparison
        function updatePeriodSelection() {
            const currentPeriod = document.getElementById('currentPeriod').value;
            const previousPeriod = document.getElementById('previousPeriod').value;
            const periodType = document.querySelector('input[name="periodType"]:checked')?.value || 'mom';
            
            console.log('Period Selection Debug:', {
                currentPeriod,
                previousPeriod, 
                periodType
            });
            
            updateYoYDisplay();
            generateComparisonReport();
        }

        // Generate P&L comparison report
        async function generateComparisonReport() {
            const periodType = document.querySelector('input[name="periodType"]:checked')?.value || 'custom';
            
            let currentPeriod, previousPeriod;
            
            console.log('=== GENERATE COMPARISON REPORT ===');
            console.log('Selected period type:', periodType);
            
            // Auto-calculate periods for MoM, QoQ, YoY
            if (periodType === 'mom') {
                const today = new Date();
                const currentMonth = today.getMonth() + 1;
                const currentYear = today.getFullYear();
                
                currentPeriod = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
                
                let prevMonth = currentMonth - 1;
                let prevYear = currentYear;
                if (prevMonth === 0) {
                    prevMonth = 12;
                    prevYear -= 1;
                }
                previousPeriod = `${prevYear}-${String(prevMonth).padStart(2, '0')}`;
                
            } else if (periodType === 'qoq') {
                const today = new Date();
                const currentMonth = today.getMonth() + 1;
                const currentYear = today.getFullYear();
                
                // Current quarter end month
                const currentQuarter = Math.floor((currentMonth - 1) / 3);
                const currentQuarterEndMonth = (currentQuarter + 1) * 3;
                currentPeriod = `${currentYear}-${String(Math.min(currentQuarterEndMonth, currentMonth)).padStart(2, '0')}`;
                
                // Previous quarter end month
                let prevQuarterEndMonth = currentQuarterEndMonth - 3;
                let prevYear = currentYear;
                if (prevQuarterEndMonth <= 0) {
                    prevQuarterEndMonth += 12;
                    prevYear -= 1;
                }
                previousPeriod = `${prevYear}-${String(prevQuarterEndMonth).padStart(2, '0')}`;
                
            } else if (periodType === 'yoy') {
                const today = new Date();
                const currentMonth = today.getMonth() + 1;
                const currentYear = today.getFullYear();
                
                currentPeriod = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
                previousPeriod = `${currentYear - 1}-${String(currentMonth).padStart(2, '0')}`;
                
            } else if (periodType === 'custom') {
                currentPeriod = document.getElementById('currentPeriod').value;
                previousPeriod = document.getElementById('previousPeriod').value;
            }
            
            console.log('Calculated periods:', {
                periodType,
                currentPeriod,
                previousPeriod
            });
            
            if (!currentPeriod || !previousPeriod) {
                console.warn('Periods not calculated:', { currentPeriod, previousPeriod });
                alert('Could not calculate periods for comparison. Please check your data.');
                return;
            }
            
            // Update the dropdowns to show calculated periods
            if (periodType !== 'custom') {
                const currentSelect = document.getElementById('currentPeriod');
                const previousSelect = document.getElementById('previousPeriod');
                if (currentSelect) currentSelect.value = currentPeriod;
                if (previousSelect) previousSelect.value = previousPeriod;
            }
            
            showComparisonLoadingState(true);
            
            try {
                // Get detailed transactions for current and previous periods using the correct period type
                const currentPeriodTransactions = getTransactionsForPeriodFixed(currentPeriod, periodType);
                const previousPeriodTransactions = getTransactionsForPeriodFixed(previousPeriod, periodType);
                
                console.log('Filtered transactions:', {
                    current: currentPeriodTransactions.length,
                    previous: previousPeriodTransactions.length
                });
                
                // Calculate financial data from transactions
                const currentData = calculateFinancialDataFromTransactions(currentPeriodTransactions, currentPeriod, periodType);
                const previousData = calculateFinancialDataFromTransactions(previousPeriodTransactions, previousPeriod, periodType);
                
                // Get last year data if needed
                let lastYearData = null;
                const includeLastYear = document.getElementById('includeLastYear')?.checked;
                if (includeLastYear) {
                    const [year, month] = currentPeriod.split('-').map(Number);
                    const lastYear = year - 1;
                    const lastYearPeriod = `${lastYear}-${String(month).padStart(2, '0')}`;
                    
                    const lastYearTransactions = getTransactionsForPeriodFixed(lastYearPeriod, periodType);
                    if (lastYearTransactions.length > 0) {
                        lastYearData = calculateFinancialDataFromTransactions(lastYearTransactions, lastYearPeriod, periodType);
                    }
                }
                
                // Get budget data for current period
                const budgetData = await getBudgetDataForPeriod(currentPeriod, periodType);
                
                // Store global comparison data
                comparisonData = {
                    current: {
                        ...currentData,
                        transactions: currentPeriodTransactions
                    },
                    previous: {
                        ...previousData,
                        transactions: previousPeriodTransactions
                    },
                    lastYear: lastYearData,
                    budget: budgetData,
                    currentPeriod: currentPeriod,
                    previousPeriod: previousPeriod,
                    periodType: periodType,
                    currentPeriodName: formatPeriodName(currentPeriod, periodType),
                    previousPeriodName: formatPeriodName(previousPeriod, periodType),
                    lastYearPeriodName: lastYearData ? 
                        formatPeriodName(`${year-1}-${String(month).padStart(2, '0')}`, periodType) : null
                };
                
                console.log('Comparison data prepared:', comparisonData);
                
                renderComparisonTable();
                renderWaterfallCharts();
                renderExecutiveSummary();
                
                document.getElementById('waterfallChartsSection').style.display = 'block';
                document.getElementById('executiveSummary').style.display = 'block';
                
            } catch (error) {
                console.error('Error generating comparison report:', error);
                document.getElementById('comparisonTableContent').innerHTML = 
                    '<div class="error-message">Error generating report. Please try again.</div>';
            } finally {
                showComparisonLoadingState(false);
            }
        }
        // Add this new function
        async function getBudgetDataForPeriod(currentPeriod, periodType) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return null;
                
                const today = new Date();
                const currentYear = today.getFullYear();
                let monthsToInclude = [];
                
                console.log('=== GET BUDGET DATA FOR PERIOD ===');
                console.log('Current Period:', currentPeriod);
                console.log('Period Type:', periodType);
                
                // Determine which months to include based on period type
                switch(periodType) {
                    case 'MTD':
                    case 'mom':
                        monthsToInclude = [today.getMonth() + 1];
                        break;
                    case 'QTD':
                    case 'qoq':
                        const currentQuarter = Math.floor(today.getMonth() / 3);
                        for (let i = 0; i < 3; i++) {
                            const month = currentQuarter * 3 + i + 1;
                            if (month <= today.getMonth() + 1) {
                                monthsToInclude.push(month);
                            }
                        }
                        break;
                    case 'YTD':
                    case 'yoy':
                    default:
                        for (let i = 1; i <= today.getMonth() + 1; i++) {
                            monthsToInclude.push(i);
                        }
                        break;
                }
                
                console.log('Months to include:', monthsToInclude);
                
                // Get budget data from the correct table (budgets)
                const { data: budgetData, error } = await supabase
                    .from('budgets')
                    .select('*')
                    .eq('user_id', user.id)
                    .eq('budget_year', currentYear)
                    .in('budget_month', monthsToInclude);
                    
                if (error) {
                    console.error('Error fetching budget data:', error);
                    return null;
                }
                
                console.log('Raw budget data fetched:', budgetData);
                
                // Calculate budget totals using the same logic as dashboard
                const totals = { 
                    revenue: 0, 
                    grossRevenue: 0,
                    netRevenue: 0,
                    cogs: 0, 
                    opex: 0, 
                    ebitda: 0,
                    grossProfit: 0,
                    ebit: 0,
                    netIncome: 0
                };
                
                if (budgetData && budgetData.length > 0) {
                    budgetData.forEach(entry => {
                        const amount = parseFloat(entry.amount) || 0;
                        const category = entry.category;
                        
                        console.log(`Processing budget entry: Month ${entry.budget_month}, Category ${category}, Amount ${amount}`);
                        
                        switch(category) {
                            case 'revenue':
                                totals.revenue += amount;
                                totals.grossRevenue += amount;
                                totals.netRevenue += amount; // Assuming no discounts in budget
                                break;
                            case 'cogs':
                                totals.cogs += amount;
                                break;
                            case 'opex':
                                totals.opex += amount;
                                break;
                        }
                    });
                    
                    // Calculate derived budget values
                    totals.grossProfit = totals.netRevenue - totals.cogs;
                    totals.ebitda = totals.grossProfit - totals.opex;
                    totals.ebit = totals.ebitda; // Assuming no depreciation in budget
                    totals.netIncome = totals.ebit; // Assuming no interest/tax in budget
                }
                
                console.log('Final calculated budget totals:', totals);
                return totals;
                
            } catch (error) {
                console.error('Error in getBudgetDataForPeriod:', error);
                return null;
            }
        }

        function updateComparisonOptions() {
            // Hide the auto YoY option since we have manual control now
            hideOldYoYCheckbox();
            
            // Regenerate the table when options change
            if (comparisonData && comparisonData.current && comparisonData.previous) {
                renderComparisonTable();
            }
        }
        
        // Add this helper function
        function calculateFinancialDataFromBudget(budgetData, accountMapping) {
            const mappingByCode = {};
            accountMapping.forEach(mapping => {
                mappingByCode[mapping.account_code] = mapping.category;
            });
            
            let grossRevenue = 0;
            let discounts = 0;
            let cogs = 0;
            let opex = 0;
            
            budgetData.forEach(item => {
                const category = mappingByCode[item.account_code];
                const amount = parseFloat(item.amount || 0);
                
                if (category === 'revenue') {
                    if (item.account_code === '4060' || item.account_code === '4070') {
                        discounts += amount;
                    } else {
                        grossRevenue += amount;
                    }
                } else if (category === 'cogs') {
                    cogs += amount;
                } else if (category === 'opex') {
                    opex += amount;
                }
            });
            
            const netRevenue = grossRevenue - discounts;
            const grossProfit = netRevenue - cogs;
            const ebitda = grossProfit - opex;
            
            return {
                grossRevenue,
                discounts,
                netRevenue,
                cogs,
                grossProfit,
                opex,
                ebitda,
                ebit: ebitda, // Simplified for now
                netIncome: ebitda // Simplified for now
            };
        }

        function getTransactionsForPeriodFixed(periodKey, periodType) {
            if (!financialTransactions || financialTransactions.length === 0) {
                console.log('No financial transactions available');
                return [];
            }
            
            const today = new Date();
            let startDate, endDate;
            
            // Handle date range format like "2025-01-01_to_2025-07-21"
            if (periodKey.includes('_to_')) {
                const [startDateStr, endDateStr] = periodKey.split('_to_');
                startDate = new Date(startDateStr);
                endDate = new Date(endDateStr);
            }
            // Handle special period keys like 'YTD', 'MTD', 'QTD'
            else if (periodKey === 'YTD') {
                startDate = new Date(today.getFullYear(), 0, 1);
                endDate = today;
            } else if (periodKey === 'MTD') {
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                endDate = today;
            } else if (periodKey === 'QTD') {
                const currentQuarter = Math.floor(today.getMonth() / 3);
                startDate = new Date(today.getFullYear(), currentQuarter * 3, 1);
                endDate = today;
            } else {
                // Handle "YYYY-MM" format
                const parts = periodKey.split('-');
                if (parts.length !== 2) {
                    console.error('Invalid periodKey format:', periodKey);
                    return [];
                }
                
                const [year, month] = parts.map(Number);
                
                if (isNaN(year) || isNaN(month) || year < 1900 || year > 2100 || month < 1 || month > 12) {
                    console.error('Invalid year or month:', year, month);
                    return [];
                }
                
                if (periodType === 'qoq') {
                    // Quarter-to-Date: From start of quarter to end of specified month
                    const quarterStartMonth = Math.floor((month - 1) / 3) * 3;
                    startDate = new Date(year, quarterStartMonth, 1);
                    endDate = new Date(year, month, 0);
                    
                } else if (periodType === 'yoy') {
                    // Year-to-Date: From January to end of specified month
                    startDate = new Date(year, 0, 1);
                    endDate = new Date(year, month, 0);
                    
                } else if (periodType === 'mom') {
                    // Month-over-Month: Just the specific month
                    startDate = new Date(year, month - 1, 1);
                    endDate = new Date(year, month, 0);
                } else {
                    // DEFAULT CASE - Add this to handle 'custom' and other period types
                    startDate = new Date(year, month - 1, 1);
                    endDate = new Date(year, month, 0);
                }
            }
            
            // Validate the created dates
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                console.error('Invalid dates created:', {
                    startDate: startDate,
                    endDate: endDate,
                    periodKey: periodKey,
                    periodType: periodType
                });
                return [];
            }
            
            console.log(`Filtering transactions for ${periodKey} (${periodType}):`, {
                startDate: startDate.toISOString().split('T')[0],
                endDate: endDate.toISOString().split('T')[0]
            });
            
            const filteredTransactions = financialTransactions.filter(transaction => {
                if (!transaction.transaction_date) return false;
                
                const transactionDate = new Date(transaction.transaction_date);
                
                if (isNaN(transactionDate.getTime())) {
                    console.warn('Invalid transaction date:', transaction.transaction_date);
                    return false;
                }
                
                return transactionDate >= startDate && transactionDate <= endDate;
            });
            
            console.log(`Found ${filteredTransactions.length} transactions for period ${periodKey}`);
            return filteredTransactions;
        }

        function calculateFinancialDataFromTransactions(transactions, period, periodType) {
            const data = {
                grossRevenue: 0,
                discounts: 0,
                netRevenue: 0,
                cogs: 0,
                grossProfit: 0,
                opex: 0,
                ebitda: 0,
                ebit: 0,
                netIncome: 0
            };
            
            let depreciation = 0;
            let interestExpense = 0;
            let taxExpense = 0;
            
            transactions.forEach(transaction => {
                const accountCode = parseInt(transaction.account_code) || 0;
                const debit = parseFloat(transaction.debit_amount || transaction.Debit || 0);
                const credit = parseFloat(transaction.credit_amount || transaction.Credit || 0);
                
                if (accountCode >= 4000 && accountCode < 5000) {
                    // Revenue accounts
                    if (accountCode === 4060 || accountCode === 4070) {
                        // Discounts and returns (negative revenue)
                        data.discounts += debit;
                    } else {
                        // Regular revenue
                        data.grossRevenue += credit;
                    }
                } else if (accountCode >= 5000 && accountCode < 5200) {
                    // COGS accounts
                    data.cogs += debit;
                } else if (accountCode >= 5200) {
                    // OPEX accounts
                    data.opex += debit;
                    
                    // Track specific expense types for EBIT calculation
                    if (accountCode === 5600 || accountCode === 5610) {
                        // Depreciation and Amortization
                        depreciation += debit;
                    } else if (accountCode === 5700) {
                        // Interest Expense
                        interestExpense += debit;
                    } else if (accountCode === 6010) {
                        // Tax Expense
                        taxExpense += debit;
                    }
                }
            });
            
            data.netRevenue = data.grossRevenue - data.discounts;
            data.grossProfit = data.netRevenue - data.cogs;
            data.ebitda = data.grossProfit - data.opex;
            
            // Calculate EBIT (EBITDA - Depreciation & Amortization)
            data.ebit = data.ebitda - depreciation;
            
            // Calculate Net Income (EBIT - Interest Expense - Tax Expense)
            data.netIncome = data.ebit - interestExpense - taxExpense;
            
            console.log('Financial Data Calculated:', {
                period,
                grossRevenue: data.grossRevenue,
                netRevenue: data.netRevenue,
                grossProfit: data.grossProfit,
                opex: data.opex,
                ebitda: data.ebitda,
                ebit: data.ebit,
                netIncome: data.netIncome,
                depreciation,
                interestExpense,
                taxExpense
            });
            
            return data;
        }
        
        // Helper function to get transactions for a specific period
        function getTransactionsForPeriod(periodKey, periodType) {
            if (!financialTransactions || financialTransactions.length === 0) {
                console.log('No financial transactions available');
                return [];
            }
            
            // Parse the period key to get date range
            let startDate, endDate;
            
            if (periodType === 'monthly') {
                // MTD vs previous month logic here
                // ... existing monthly logic
            } else if (periodType === 'quarterly') {
                // QTD vs previous quarter logic here  
                // ... existing quarterly logic
            } else if (periodType === 'yearly') {
                // YTD vs previous year logic here
                // ... existing yearly logic
            } else if (periodType === 'custom') {
                // Handle custom period selection (like "2025-02", "2025-01")
                let year, month;
                
                if (periodKey.includes('-')) {
                    [year, month] = periodKey.split('-');
                    year = parseInt(year);
                    month = parseInt(month);
                    
                    // Create date range for the specific month
                    startDate = new Date(year, month - 1, 1);
                    endDate = new Date(year, month, 0);
                } else {
                    console.warn('Unexpected custom period format:', periodKey);
                    return financialTransactions;
                }
            } else {
                console.warn('Unknown period type:', periodType);
                return financialTransactions;
            }
            
            console.log(`Filtering transactions for period ${periodKey} (${periodType}):`, {
                startDate: startDate.toISOString().split('T')[0],
                endDate: endDate.toISOString().split('T')[0]
            });
            
            // Filter transactions by date range
            const filteredTransactions = financialTransactions.filter(transaction => {
                if (!transaction.transaction_date) return false;
                
                const transactionDate = new Date(transaction.transaction_date);
                const transactionYear = transactionDate.getFullYear();
                const transactionMonth = transactionDate.getMonth();
                
                const startYear = startDate.getFullYear();
                const startMonth = startDate.getMonth();
                
                // For monthly periods (both monthly and custom), use month/year match
                if (periodType === 'monthly' || periodType === 'custom') {
                    return transactionYear === startYear && transactionMonth === startMonth;
                }
                
                // Date range comparison for quarterly/yearly
                return transactionDate >= startDate && transactionDate <= endDate;
            });
            
            console.log(`Found ${filteredTransactions.length} transactions for period ${periodKey}`);
            return filteredTransactions;
        }
        
        // Get last year period
        function getLastYearPeriod(period) {
            const [year, month] = period.split('-').map(Number);
            return `${year - 1}-${String(month).padStart(2, '0')}`;
        }
        
        // Update period type selection with QTD/YTD logic
        function updatePeriodType(type) {
            const currentSelect = document.getElementById('currentPeriod');
            const previousSelect = document.getElementById('previousPeriod');
            
            if (type === 'mom' && availablePeriods.length >= 2) {
                currentSelect.value = availablePeriods[0].value;
                previousSelect.value = availablePeriods[1].value;
            } else if (type === 'qoq' && availablePeriods.length >= 4) {
                currentSelect.value = availablePeriods[0].value;
                previousSelect.value = availablePeriods[3].value; // 3 months ago
            } else if (type === 'yoy' && availablePeriods.length >= 12) {
                currentSelect.value = availablePeriods[0].value;
                previousSelect.value = availablePeriods[12].value; // 12 months ago
            }
            
            updatePeriodSelection();
        }
        
        // Fetch financial data with QTD/YTD logic
        async function fetchFinancialDataForComparisonPeriod(period) {
            try {
                console.log('Fetching financial data for period:', period);
                
                const [year, month] = period.split('-').map(Number);
                const periodType = document.querySelector('input[name="periodType"]:checked').value;
                
                let startDate, endDate;
                
                if (periodType === 'mom') {
                    // Month-over-Month: Just the selected month
                    startDate = `${year}-${String(month).padStart(2, '0')}-01`;
                    endDate = new Date(year, month, 0).toISOString().split('T')[0];
                } else if (periodType === 'qoq') {
                    // Quarter-to-Date: From start of quarter to selected month
                    const quarterStartMonth = Math.floor((month - 1) / 3) * 3 + 1;
                    startDate = `${year}-${String(quarterStartMonth).padStart(2, '0')}-01`;
                    endDate = new Date(year, month, 0).toISOString().split('T')[0];
                } else if (periodType === 'yoy') {
                    // Year-to-Date: From January to selected month
                    startDate = `${year}-01-01`;
                    endDate = new Date(year, month, 0).toISOString().split('T')[0];
                } else {
                    // Custom: Just the selected month (default)
                    startDate = `${year}-${String(month).padStart(2, '0')}-01`;
                    endDate = new Date(year, month, 0).toISOString().split('T')[0];
                }
                
                console.log(`Period type: ${periodType}, Date range: ${startDate} to ${endDate}`);
                
                const { data, error } = await supabase
                    .from('financial_transactions_meridash')
                    .select('*')
                    .gte('transaction_date', startDate)
                    .lte('transaction_date', endDate);
                
                if (error) throw error;
                
                return processFinancialDataForComparison(data || [], period, periodType);
                
            } catch (error) {
                console.error('Error fetching financial data:', error);
                return null;
            }
        }
        
        // Process financial data with period type context
        function processFinancialDataForComparison(transactions, period, periodType = 'mom') {
            if (!transactions || transactions.length === 0) {
                return {
                    grossRevenue: 0,
                    discounts: 0,
                    netRevenue: 0,
                    cogs: 0,
                    grossProfit: 0,
                    opex: 0,
                    ebitda: 0,
                    ebit: 0,
                    depreciation: 0,
                    interestExpense: 0,
                    incomeTaxExpense: 0,
                    extraordinaryItems: 0,
                    netIncome: 0
                };
            }
        
            // Initialize P&L data structure
            const pnlData = {
                grossRevenue: 0,
                discounts: 0,
                netRevenue: 0,
                cogs: 0,
                grossProfit: 0,
                opex: 0,
                ebitda: 0,
                ebit: 0,
                depreciation: 0,
                interestExpense: 0,
                incomeTaxExpense: 0,
                extraordinaryItems: 0,
                netIncome: 0
            };
        
            // Process transactions into categories
            transactions.forEach(transaction => {
                const debitAmount = Math.abs(parseFloat(transaction.debit_amount) || parseFloat(transaction.debit) || 0);
                const creditAmount = Math.abs(parseFloat(transaction.credit_amount) || parseFloat(transaction.credit) || 0);
                const accountCode = transaction.account_code || '';
                const accountName = (transaction.account_name || '').toLowerCase();
                
                // Calculate net amount based on account type
                let amount = 0;
                
                if (accountCode.toString().startsWith('4')) {
                    // Revenue accounts: Credits increase revenue
                    amount = creditAmount - debitAmount;
                } else if (accountCode.toString().startsWith('5') || accountCode.toString().startsWith('6')) {
                    // Expense accounts: Debits increase expenses
                    amount = debitAmount - creditAmount;
                }
        
                // Categorize based on account code ranges
                if (accountCode.toString().startsWith('4')) {
                    // 4xxx = Revenue accounts
                    if (accountName.includes('return') || accountName.includes('allowance') || 
                        accountName.includes('discount') || accountCode === 4070) {
                        pnlData.discounts += Math.abs(amount);
                    } else {
                        pnlData.grossRevenue += Math.abs(amount);
                    }
                    
                } else if (accountCode >= 5010 && accountCode <= 5030) {
                    // 5010-5030 = Cost of Goods Sold
                    pnlData.cogs += Math.abs(amount);
                    
                } else if (accountCode >= 5100 && accountCode <= 5599) {
                    // 5100-5599 = Operating Expenses (excluding depreciation and interest)
                    if (accountCode === 5600 || accountCode === 5610) {
                        // Depreciation and Amortization
                        pnlData.depreciation += Math.abs(amount);
                    } else {
                        pnlData.opex += Math.abs(amount);
                    }
                    
                } else if (accountCode >= 5700 && accountCode <= 5720) {
                    // 5700-5720 = Interest and Financial Expenses
                    if (accountCode === 5700) {
                        pnlData.interestExpense += Math.abs(amount);
                    } else {
                        pnlData.opex += Math.abs(amount); // Other financial expenses as OPEX
                    }
                    
                } else if (accountCode >= 5800 && accountCode <= 5970) {
                    // 5800-5970 = Other Operating Expenses
                    pnlData.opex += Math.abs(amount);
                    
                } else if (accountCode >= 6010 && accountCode <= 6030) {
                    // 6xxx = Non-operating expenses
                    if (accountCode === 6010) {
                        pnlData.incomeTaxExpense += Math.abs(amount);
                    } else {
                        pnlData.extraordinaryItems += Math.abs(amount);
                    }
                    
                } else if (accountName.includes('expense') || accountName.includes('opex')) {
                    // Catch any other expenses by name
                    pnlData.opex += Math.abs(amount);
                }
            });
        
            // Calculate derived metrics
            pnlData.netRevenue = pnlData.grossRevenue - pnlData.discounts;
            pnlData.grossProfit = pnlData.netRevenue - pnlData.cogs;
            pnlData.ebitda = pnlData.grossProfit - pnlData.opex;
            pnlData.ebit = pnlData.ebitda - pnlData.depreciation;
            pnlData.netIncome = pnlData.ebit - pnlData.interestExpense - pnlData.incomeTaxExpense - pnlData.extraordinaryItems;
        
            // Debug logging
            console.log(`P&L for period ${period}:`, {
                grossRevenue: pnlData.grossRevenue,
                discounts: pnlData.discounts,
                netRevenue: pnlData.netRevenue,
                cogs: pnlData.cogs,
                grossProfit: pnlData.grossProfit,
                opex: pnlData.opex,
                ebitda: pnlData.ebitda,
                depreciation: pnlData.depreciation,
                ebit: pnlData.ebit,
                interestExpense: pnlData.interestExpense,
                incomeTaxExpense: pnlData.incomeTaxExpense,
                extraordinaryItems: pnlData.extraordinaryItems,
                netIncome: pnlData.netIncome
            });
        
            return pnlData;
        }
        
        // Format period name with type context
        function formatPeriodName(period, periodType = 'mom') {
            // Handle undefined or empty period
            if (!period || period === '') {
                return 'Select Period';
            }
            
            // Handle period format validation
            if (!period.includes('-')) {
                console.warn('Invalid period format:', period);
                return period; // Return as-is if not in expected format
            }
            
            const [year, month] = period.split('-').map(Number);
            
            // Validate year and month
            if (!year || !month || month < 1 || month > 12) {
                console.warn('Invalid year/month:', { year, month, period });
                return period;
            }
            
            const date = new Date(year, month - 1);
            const monthName = date.toLocaleDateString('en-US', { month: 'short' });
            
            if (periodType === 'qoq') {
                const quarter = Math.floor((month - 1) / 3) + 1;
                return `Q${quarter} ${year}`;
            } else if (periodType === 'yoy') {
                return `YTD ${monthName} ${year}`;
            } else {
                return `${monthName} ${year}`;
            }
        }
        
        // Generate table rows with new structure (no icons, prominent lines, margin rows)
        function generateTableRows(current, previous, lastYear) {
            const lineItems = [
                { key: 'grossRevenue', label: 'Gross Revenue', type: 'regular' },
                { key: 'discounts', label: 'Discounts', type: 'regular' },
                { key: 'netRevenue', label: 'Net Revenue', type: 'prominent' },
                { key: 'grossToNetMargin', label: 'Gross to Net %', type: 'margin' },
                { key: 'cogs', label: 'COGS', type: 'regular' },
                { key: 'grossProfit', label: 'Gross Profit', type: 'prominent' },
                { key: 'grossProfitMargin', label: 'Gross Profit Margin %', type: 'margin' },
                { key: 'opex', label: 'OPEX', type: 'regular' },
                { key: 'opexToSalesMargin', label: 'OPEX to Sales %', type: 'margin' },
                { key: 'ebitda', label: 'EBITDA', type: 'prominent' },
                { key: 'ebitdaMargin', label: 'EBITDA Margin %', type: 'margin' },
                { key: 'ebit', label: 'EBIT', type: 'regular' },
                { key: 'netIncome', label: 'Net Income', type: 'prominent' },
                { key: 'netIncomeMargin', label: 'Net Income Margin %', type: 'margin' }
            ];
            
            return lineItems.map(item => {
                let currentValue, previousValue, lastYearValue;
                
                // Calculate values including margin rows
                if (item.key === 'grossToNetMargin') {
                    currentValue = current.grossRevenue !== 0 ? (current.netRevenue / current.grossRevenue) * 100 : 0;
                    previousValue = previous.grossRevenue !== 0 ? (previous.netRevenue / previous.grossRevenue) * 100 : 0;
                    lastYearValue = lastYear && lastYear.grossRevenue !== 0 ? (lastYear.netRevenue / lastYear.grossRevenue) * 100 : null;
                } else if (item.key === 'grossProfitMargin') {
                    currentValue = current.netRevenue !== 0 ? (current.grossProfit / current.netRevenue) * 100 : 0;
                    previousValue = previous.netRevenue !== 0 ? (previous.grossProfit / previous.netRevenue) * 100 : 0;
                    lastYearValue = lastYear && lastYear.netRevenue !== 0 ? (lastYear.grossProfit / lastYear.netRevenue) * 100 : null;
                } else if (item.key === 'opexToSalesMargin') {
                    currentValue = current.netRevenue !== 0 ? (current.opex / current.netRevenue) * 100 : 0;
                    previousValue = previous.netRevenue !== 0 ? (previous.opex / previous.netRevenue) * 100 : 0;
                    lastYearValue = lastYear && lastYear.netRevenue !== 0 ? (lastYear.opex / lastYear.netRevenue) * 100 : null;
                } else if (item.key === 'ebitdaMargin') {
                    currentValue = current.netRevenue !== 0 ? (current.ebitda / current.netRevenue) * 100 : 0;
                    previousValue = previous.netRevenue !== 0 ? (previous.ebitda / previous.netRevenue) * 100 : 0;
                    lastYearValue = lastYear && lastYear.netRevenue !== 0 ? (lastYear.ebitda / lastYear.netRevenue) * 100 : null;
                } else if (item.key === 'netIncomeMargin') {
                    currentValue = current.netRevenue !== 0 ? (current.netIncome / current.netRevenue) * 100 : 0;
                    previousValue = previous.netRevenue !== 0 ? (previous.netIncome / previous.netRevenue) * 100 : 0;
                    lastYearValue = lastYear && lastYear.netRevenue !== 0 ? (lastYear.netIncome / lastYear.netRevenue) * 100 : null;
                } else {
                    currentValue = current[item.key] || 0;
                    previousValue = previous[item.key] || 0;
                    lastYearValue = lastYear ? (lastYear[item.key] || 0) : null;
                }
                
                const momChange = currentValue - previousValue;
                const momPercent = previousValue !== 0 ? (momChange / Math.abs(previousValue)) * 100 : 0;
                
                const yoyChange = lastYearValue !== null ? currentValue - lastYearValue : null;
                const yoyPercent = lastYearValue !== null && lastYearValue !== 0 ? 
                    (yoyChange / Math.abs(lastYearValue)) * 100 : null;
                
                // Determine cell classes based on type
                const cellClass = item.type === 'prominent' ? 'prominent' : 
                                 item.type === 'margin' ? 'margin' : 'regular';
                
                // Format values based on type
                const formatValue = (val) => {
                    if (item.type === 'margin') {
                        return val !== null ? `${val.toFixed(1)}%` : 'N/A';
                    } else {
                        return val !== null ? formatCurrency(val) : 'N/A';
                    }
                };
                
                const formatChange = (change, isPercent = false) => {
                    if (change === null) return 'N/A';
                    if (item.type === 'margin') {
                        return isPercent ? formatPercent(change, true) : `${change >= 0 ? '+' : ''}${change.toFixed(1)}pp`;
                    } else {
                        return isPercent ? formatPercent(change, true) : formatCurrency(change, true);
                    }
                };
                
                return `
                    <tr>
                        <td class="line-item-cell line-item-${cellClass}">${item.label}</td>
                        <td class="value-cell value-cell-${cellClass}">${formatValue(currentValue)}</td>
                        <td class="value-cell value-cell-${cellClass}">${formatValue(previousValue)}</td>
                        <td class="change-cell change-cell-${cellClass} ${getChangeClass(momChange)}">${formatChange(momChange)}</td>
                        <td class="change-cell change-cell-${cellClass} ${getChangeClass(momChange)}">${formatChange(momPercent, true)}</td>
                        <td class="value-cell value-cell-${cellClass}">${lastYearValue !== null ? formatValue(lastYearValue) : 'N/A'}</td>
                        <td class="change-cell change-cell-${cellClass} ${yoyChange !== null ? getChangeClass(yoyChange) : ''}">${yoyChange !== null ? formatChange(yoyChange) : 'N/A'}</td>
                        <td class="change-cell change-cell-${cellClass} ${yoyChange !== null ? getChangeClass(yoyChange) : ''}">${yoyPercent !== null ? formatChange(yoyPercent, true) : 'N/A'}</td>
                    </tr>
                `;
            }).join('');
        }

        function hideOldYoYCheckbox() {
            const autoYoYOption = document.querySelector('.yoy-option');
            if (autoYoYOption) {
                autoYoYOption.style.display = 'none';
            }
        }
        
        // Update table rendering to remove Margins column
        function renderComparisonTable() {
            const { current, previous, lastYear, budget, currentPeriodName, previousPeriodName, lastYearPeriodName } = comparisonData;
            
            if (!current || !previous) {
                document.getElementById('comparisonTableContent').innerHTML = 
                    '<div class="error-message">Unable to load comparison data</div>';
                return;
            }
            
            // Get checkbox states
            const includeBudget = document.getElementById('includeBudget')?.checked || false;
            const includePreviousMonth = document.getElementById('includePreviousMonth')?.checked || false;
            const includeLastYear = document.getElementById('includeLastYear')?.checked || false;
            
            // Build table header based on selected options
            let headerHTML = `
                <tr>
                    <th>Line Item</th>
                    <th>${currentPeriodName || 'Current'}<br>(Current)</th>
            `;
            
            if (includeBudget) {
                headerHTML += `<th>Budget<br>(Budget)</th>`;
                headerHTML += `<th>vs Budget Value<br>Change</th>`;
                headerHTML += `<th>vs Budget %<br>Change</th>`;
            }
            
            if (includePreviousMonth) {
                headerHTML += `<th>${previousPeriodName || 'Previous'}<br>(Previous)</th>`;
                headerHTML += `<th>MoM Value<br>Change</th>`;
                headerHTML += `<th>MoM %<br>Change</th>`;
            }
            
            // ALWAYS show last year columns when checkbox is checked, regardless of data availability
            if (includeLastYear) {
                headerHTML += `<th>${lastYearPeriodName || 'Last Year'}<br>(Last Year)</th>`;
                headerHTML += `<th>YoY Value<br>Change</th>`;
                headerHTML += `<th>YoY %<br>Change</th>`;
            }
            
            headerHTML += `</tr>`;
            
            const tableHTML = `
                <table class="comparison-table">
                    <thead>
                        ${headerHTML}
                    </thead>
                    <tbody>
                        ${generateTableRowsWithBudget(current, previous, lastYear, budget, includeBudget, includePreviousMonth, includeLastYear)}
                    </tbody>
                </table>
            `;
            
            document.getElementById('comparisonTableContent').innerHTML = tableHTML;
        }

        function generateTableRowsWithBudget(current, previous, lastYear, budget, includeBudget, includePreviousMonth, includeLastYear) {
            const lineItems = [
                { key: 'grossRevenue', label: 'Gross Revenue', type: 'regular' },
                { key: 'discounts', label: 'Discounts', type: 'regular' },
                { key: 'netRevenue', label: 'Net Revenue', type: 'prominent' },
                { key: 'grossToNetMargin', label: 'Gross to Net %', type: 'margin' },
                { key: 'cogs', label: 'COGS', type: 'regular' },
                { key: 'grossProfit', label: 'Gross Profit', type: 'prominent' },
                { key: 'grossProfitMargin', label: 'Gross Profit Margin %', type: 'margin' },
                { key: 'opex', label: 'OPEX', type: 'regular' },
                { key: 'opexToSalesMargin', label: 'OPEX to Sales %', type: 'margin' },
                { key: 'ebitda', label: 'EBITDA', type: 'prominent' },
                { key: 'ebitdaMargin', label: 'EBITDA Margin %', type: 'margin' },
                { key: 'ebit', label: 'EBIT', type: 'regular' },
                { key: 'netIncome', label: 'Net Income', type: 'prominent' },
                { key: 'netIncomeMargin', label: 'Net Income Margin %', type: 'margin' }
            ];
            
            return lineItems.map(item => {
                let currentValue, previousValue, lastYearValue, budgetValue;
                
                // Calculate values including margin rows
                if (item.key === 'grossToNetMargin') {
                    currentValue = current.grossRevenue !== 0 ? (current.netRevenue / current.grossRevenue) * 100 : 0;
                    previousValue = previous.grossRevenue !== 0 ? (previous.netRevenue / previous.grossRevenue) * 100 : 0;
                    lastYearValue = lastYear && lastYear.grossRevenue !== 0 ? (lastYear.netRevenue / lastYear.grossRevenue) * 100 : null;
                    budgetValue = budget && budget.grossRevenue !== 0 ? (budget.netRevenue / budget.grossRevenue) * 100 : null;
                } else if (item.key === 'grossProfitMargin') {
                    currentValue = current.netRevenue !== 0 ? (current.grossProfit / current.netRevenue) * 100 : 0;
                    previousValue = previous.netRevenue !== 0 ? (previous.grossProfit / previous.netRevenue) * 100 : 0;
                    lastYearValue = lastYear && lastYear.netRevenue !== 0 ? (lastYear.grossProfit / lastYear.netRevenue) * 100 : null;
                    budgetValue = budget && budget.netRevenue !== 0 ? (budget.grossProfit / budget.netRevenue) * 100 : null;
                } else if (item.key === 'opexToSalesMargin') {
                    currentValue = current.netRevenue !== 0 ? (current.opex / current.netRevenue) * 100 : 0;
                    previousValue = previous.netRevenue !== 0 ? (previous.opex / previous.netRevenue) * 100 : 0;
                    lastYearValue = lastYear && lastYear.netRevenue !== 0 ? (lastYear.opex / lastYear.netRevenue) * 100 : null;
                    budgetValue = budget && budget.netRevenue !== 0 ? (budget.opex / budget.netRevenue) * 100 : null;
                } else if (item.key === 'ebitdaMargin') {
                    currentValue = current.netRevenue !== 0 ? (current.ebitda / current.netRevenue) * 100 : 0;
                    previousValue = previous.netRevenue !== 0 ? (previous.ebitda / previous.netRevenue) * 100 : 0;
                    lastYearValue = lastYear && lastYear.netRevenue !== 0 ? (lastYear.ebitda / lastYear.netRevenue) * 100 : null;
                    budgetValue = budget && budget.netRevenue !== 0 ? (budget.ebitda / budget.netRevenue) * 100 : null;
                } else if (item.key === 'netIncomeMargin') {
                    currentValue = current.netRevenue !== 0 ? (current.netIncome / current.netRevenue) * 100 : 0;
                    previousValue = previous.netRevenue !== 0 ? (previous.netIncome / previous.netRevenue) * 100 : 0;
                    lastYearValue = lastYear && lastYear.netRevenue !== 0 ? (lastYear.netIncome / lastYear.netRevenue) * 100 : null;
                    budgetValue = budget && budget.netRevenue !== 0 ? (budget.netIncome / budget.netRevenue) * 100 : null;
                } else {
                    currentValue = current[item.key] || 0;
                    previousValue = previous[item.key] || 0;
                    lastYearValue = lastYear ? (lastYear[item.key] || 0) : null;
                    budgetValue = budget ? (budget[item.key] || 0) : null;
                }
                
                // Calculate changes
                const budgetChange = budgetValue !== null ? currentValue - budgetValue : null;
                const budgetPercent = budgetValue !== null && budgetValue !== 0 ? (budgetChange / Math.abs(budgetValue)) * 100 : null;
                
                const momChange = currentValue - previousValue;
                const momPercent = previousValue !== 0 ? (momChange / Math.abs(previousValue)) * 100 : 0;
                
                const yoyChange = lastYearValue !== null ? currentValue - lastYearValue : null;
                const yoyPercent = lastYearValue !== null && lastYearValue !== 0 ? 
                    (yoyChange / Math.abs(lastYearValue)) * 100 : null;
                
                // Determine cell classes based on type
                const cellClass = item.type === 'prominent' ? 'prominent' : 
                                 item.type === 'margin' ? 'margin' : 'regular';
                
                // Format values using existing functions
                const formatValueForType = (val) => {
                    if (val === null || val === undefined) return 'N/A';
                    if (item.type === 'margin') {
                        return `${val.toFixed(1)}%`;
                    } else {
                        return formatCurrency(val);
                    }
                };
                
                const formatChangeForType = (change, isPercent = false) => {
                    if (change === null || change === undefined) return 'N/A';
                    if (item.type === 'margin') {
                        return isPercent ? `${change >= 0 ? '+' : ''}${change.toFixed(1)}%` : `${change >= 0 ? '+' : ''}${change.toFixed(1)}pp`;
                    } else {
                        return isPercent ? `${change >= 0 ? '+' : ''}${change.toFixed(1)}%` : formatCurrency(change, true);
                    }
                };
                
                // Build row HTML
                let rowHTML = `
                    <tr class="comparison-row">
                        <td class="line-item-cell ${cellClass}">${item.label}</td>
                        <td class="value-cell ${cellClass}">${formatValueForType(currentValue)}</td>
                `;
                
                if (includeBudget) {
                    rowHTML += `
                        <td class="value-cell ${cellClass}">${formatValueForType(budgetValue)}</td>
                        <td class="change-cell change-cell-${cellClass} ${budgetChange !== null ? getChangeClass(budgetChange) : ''}">${formatChangeForType(budgetChange)}</td>
                        <td class="change-cell change-cell-${cellClass} ${budgetPercent !== null ? getChangeClass(budgetPercent) : ''}">${formatChangeForType(budgetPercent, true)}</td>
                    `;
                }
                
                if (includePreviousMonth) {
                    rowHTML += `
                        <td class="value-cell ${cellClass}">${formatValueForType(previousValue)}</td>
                        <td class="change-cell change-cell-${cellClass} ${getChangeClass(momChange)}">${formatChangeForType(momChange)}</td>
                        <td class="change-cell change-cell-${cellClass} ${getChangeClass(momPercent)}">${formatChangeForType(momPercent, true)}</td>
                    `;
                }
                
                if (includeLastYear) {
                    rowHTML += `
                        <td class="value-cell ${cellClass}">${formatValueForType(lastYearValue)}</td>
                        <td class="change-cell change-cell-${cellClass} ${yoyChange !== null ? getChangeClass(yoyChange) : ''}">${formatChangeForType(yoyChange)}</td>
                        <td class="change-cell change-cell-${cellClass} ${yoyPercent !== null ? getChangeClass(yoyPercent) : ''}">${formatChangeForType(yoyPercent, true)}</td>
                    `;
                }
                
                rowHTML += `</tr>`;
                return rowHTML;
            }).join('');
        }
        
        // Format currency with Indonesian Rupiah
        function formatCurrency(amount, showSign = false) {
            const absAmount = Math.abs(amount);
            const sign = amount >= 0 ? (showSign ? '+' : '') : '-';
            
            if (absAmount >= 1000000000) {
                return `${sign}Rp ${(absAmount / 1000000000).toFixed(1)}B`;
            } else if (absAmount >= 1000000) {
                return `${sign}Rp ${(absAmount / 1000000).toFixed(1)}M`;
            } else if (absAmount >= 1000) {
                return `${sign}Rp ${(absAmount / 1000).toFixed(1)}K`;
            } else {
                return `${sign}Rp ${absAmount.toLocaleString('id-ID')}`;
            }
        }
        
        // Format percentage
        function formatPercent(percent, showSign = false) {
            const sign = percent >= 0 ? (showSign ? '+' : '') : '';
            return `${sign}${percent.toFixed(1)}%`;
        }
        
        // Get CSS class for change indicators
        function getChangeClass(change) {
            if (change > 0) return 'change-positive';
            if (change < 0) return 'change-negative';
            return 'change-neutral';
        }
        
        // Enhanced waterfall charts using Chart.js
        function renderWaterfallCharts() {
            const { current, previous } = comparisonData;
            
            if (!current || !previous) {
                hideWaterfallCharts();
                return;
            }
            
            // Show the charts section
            document.getElementById('waterfallChartsSection').style.display = 'block';
            
            // Render each waterfall chart
            renderRevenueWaterfallChart();
            renderGrossProfitWaterfallChart();
            renderOpexWaterfallChart();
            renderEbitdaWaterfallChart();
        }
        
        function hideWaterfallCharts() {
            document.getElementById('waterfallChartsSection').style.display = 'none';
        }
        
        // Revenue Bridge Analysis
        function renderRevenueWaterfallChart() {
            const { current, previous } = comparisonData;
            
            if (!current || !previous) {
                showNoDataMessage('revenueWaterfallChart', 'No comparison data available');
                return;
            }
            
            // Calculate real impacts
            const impacts = calculateRealWaterfallImpacts(current, previous);
            const revenueImpacts = impacts.revenue;
            
            // For periods where previous is 0, show absolute values for current period
            const showAbsolute = previous.netRevenue === 0;
            
            const waterfallData = showAbsolute ? [
                // Show absolute values when starting from zero
                { label: 'Sales Revenue', value: getAccountBalance(current, 4010), type: 'positive' },
                { label: 'Service Revenue', value: getAccountBalance(current, 4020), type: 'positive' },
                { label: 'Other Income', value: getAccountBalance(current, 4050), type: 'positive' },
                { label: 'Interest Income', value: getAccountBalance(current, 4030), type: 'positive' },
                { label: 'Sales Discounts', value: -getAccountBalance(current, 4060), type: 'negative' },
                { label: 'Returns & Allowances', value: -getAccountBalance(current, 4070), type: 'negative' },
                { label: 'Current Total', value: current.netRevenue, type: 'total' }
            ] : [
                // Show changes when comparing periods
                { label: 'Previous', value: previous.netRevenue, type: 'base' },
                { label: 'Sales Revenue', value: revenueImpacts.salesRevenue, type: revenueImpacts.salesRevenue >= 0 ? 'positive' : 'negative' },
                { label: 'Service Revenue', value: revenueImpacts.serviceRevenue, type: revenueImpacts.serviceRevenue >= 0 ? 'positive' : 'negative' },
                { label: 'Other Income', value: revenueImpacts.otherIncome, type: revenueImpacts.otherIncome >= 0 ? 'positive' : 'negative' },
                { label: 'Interest Income', value: revenueImpacts.interestIncome, type: revenueImpacts.interestIncome >= 0 ? 'positive' : 'negative' },
                { label: 'Sales Discounts', value: revenueImpacts.salesDiscounts, type: 'negative' },
                { label: 'Returns & Allowances', value: revenueImpacts.returnsAllowances, type: 'negative' },
                { label: 'Current', value: current.netRevenue, type: 'total' }
            ];
            
            createWaterfallChart('revenueWaterfallChart', waterfallData, 'Revenue Bridge Analysis');
        }
        
        function renderGrossProfitWaterfallChart() {
            const { current, previous } = comparisonData;
            
            if (!current || !previous) {
                showNoDataMessage('grossProfitWaterfallChart', 'No comparison data available');
                return;
            }
            
            const impacts = calculateRealWaterfallImpacts(current, previous);
            const revenueImpacts = impacts.revenue;
            const cogsImpacts = impacts.cogs;
            
            // Revenue impact (positive)
            const totalRevenueImpact = Object.values(revenueImpacts).reduce((sum, val) => sum + val, 0);
            
            const waterfallData = [
                { label: 'Previous', value: previous.grossProfit, type: 'base' },
                { label: 'Revenue Growth', value: totalRevenueImpact, type: totalRevenueImpact >= 0 ? 'positive' : 'negative' },
                { label: 'Direct COGS', value: -cogsImpacts.directCogs, type: cogsImpacts.directCogs <= 0 ? 'positive' : 'negative' },
                { label: 'Purchase Savings', value: cogsImpacts.purchaseDiscounts, type: 'positive' },
                { label: 'Freight Costs', value: -cogsImpacts.freightIn, type: cogsImpacts.freightIn <= 0 ? 'positive' : 'negative' },
                { label: 'Direct Labor', value: -cogsImpacts.directLabor, type: cogsImpacts.directLabor <= 0 ? 'positive' : 'negative' },
                { label: 'Current', value: current.grossProfit, type: 'total' }
            ];
            
            createWaterfallChart('grossProfitWaterfallChart', waterfallData, 'Gross Profit Bridge');
        }
        
        function renderOpexWaterfallChart() {
            const { current, previous } = comparisonData;
            
            if (!current || !previous) {
                showNoDataMessage('opexWaterfallChart', 'No comparison data available');
                return;
            }
            
            const impacts = calculateRealWaterfallImpacts(current, previous);
            const opexImpacts = impacts.opex;
            
            const waterfallData = [
                { label: 'Previous', value: previous.opex, type: 'base' },
                { label: 'Facilities', value: opexImpacts.facilities, type: 'negative' },
                { label: 'Marketing', value: opexImpacts.marketing, type: 'negative' },
                { label: 'Professional Services', value: opexImpacts.professional, type: 'negative' },
                { label: 'Operations', value: opexImpacts.operations, type: 'negative' },
                { label: 'Current', value: current.opex, type: 'total' }
            ];
            
            createWaterfallChart('opexWaterfallChart', waterfallData, 'OPEX Bridge');
        }
        
        function renderEbitdaWaterfallChart() {
            const { current, previous } = comparisonData;
            
            if (current.ebitda === 0) {
                showNoDataMessage('ebitdaWaterfallChart', 'Insufficient EBITDA data for analysis');
                return;
            }
            
            const revenueImpact = current.netRevenue - previous.netRevenue;
            const cogsImpact = -(current.cogs - previous.cogs);
            const opexImpact = -(current.opex - previous.opex);
            
            const waterfallData = [
                { label: 'Previous', value: previous.ebitda, type: 'base' },
                { label: 'Revenue', value: revenueImpact, type: revenueImpact > 0 ? 'positive' : 'negative' },
                { label: 'COGS', value: cogsImpact, type: cogsImpact > 0 ? 'positive' : 'negative' },
                { label: 'OPEX', value: opexImpact, type: opexImpact > 0 ? 'positive' : 'negative' },
                { label: 'Margin', value: (revenueImpact + cogsImpact) * 0.1, type: (revenueImpact + cogsImpact) > 0 ? 'positive' : 'negative' },
                { label: 'Leverage', value: opexImpact * 0.2, type: opexImpact > 0 ? 'positive' : 'negative' },
                { label: 'Efficiency', value: (revenueImpact - Math.abs(opexImpact)) * 0.05, type: 'positive' },
                { label: 'Current', value: current.ebitda, type: 'total' }
            ];
            
            createWaterfallChart('ebitdaWaterfallChart', waterfallData, 'EBITDA Bridge');
        }
        
        // D3.js Waterfall Chart Implementation - Improved Layout
        function createWaterfallChart(containerId, data, title) {
            console.log('Creating waterfall chart for:', containerId, data);
            
            if (typeof d3 === 'undefined') {
                console.error('D3.js is not loaded!');
                showNoDataMessage(containerId, 'D3.js library not loaded');
                return;
            }
            
            const container = document.getElementById(containerId);
            if (!container) {
                console.error('Container not found:', containerId);
                return;
            }
            
            // Clear any existing chart
            d3.select(`#${containerId}`).selectAll("*").remove();
            
            // Improved dimensions - wider and taller
            const margin = { top: 40, right: 20, bottom: 80, left: 50 };
            const width = 500 - margin.left - margin.right;  // Increased from 400
            const height = 350 - margin.top - margin.bottom;  // Increased from 300
            
            // Create SVG
            const svg = d3.select(`#${containerId}`)
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .style("background", "white");
            
            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            
            // Add title
            svg.append("text")
                .attr("x", (width + margin.left + margin.right) / 2)
                .attr("y", 20)
                .attr("text-anchor", "middle")
                .style("font-size", "14px")
                .style("font-weight", "bold")
                .style("fill", "#1e293b")
                .text(title);
            
            // Calculate cumulative values for waterfall effect
            let cumulative = 0;
            const processedData = data.map((d, i) => {
                let start, end;
                
                if (i === 0 || d.type === 'total') {
                    start = 0;
                    end = d.value;
                    cumulative = d.value;
                } else {
                    start = cumulative;
                    end = cumulative + d.value;
                    cumulative += d.value;
                }
                
                return {
                    ...d,
                    start: Math.min(start, end),
                    end: Math.max(start, end),
                    height: Math.abs(end - start)
                };
            });
            
            // Scales
            const xScale = d3.scaleBand()
                .domain(processedData.map(d => d.label))
                .range([0, width])
                .padding(0.15);  // Reduced padding for more space
            
            const yScale = d3.scaleLinear()
                .domain(d3.extent(processedData.flatMap(d => [d.start, d.end])))
                .nice()
                .range([height, 0]);
            
            // Color mapping
            const getColor = (type) => {
                switch(type) {
                    case 'base': return '#64748b';
                    case 'positive': return '#10b981';
                    case 'negative': return '#ef4444';
                    case 'total': return '#f59e0b';
                    default: return '#64748b';
                }
            };
            
            // Draw connecting lines
            for (let i = 0; i < processedData.length - 1; i++) {
                const current = processedData[i];
                const next = processedData[i + 1];
                
                if (current.type !== 'total' && next.type !== 'base') {
                    g.append("line")
                        .attr("x1", xScale(current.label) + xScale.bandwidth())
                        .attr("y1", yScale(current.end))
                        .attr("x2", xScale(next.label))
                        .attr("y2", yScale(next.start))
                        .attr("stroke", "#d1d5db")
                        .attr("stroke-width", 1)
                        .attr("stroke-dasharray", "3,3");
                }
            }
            
            // Draw bars
            const bars = g.selectAll(".bar")
                .data(processedData)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => xScale(d.label))
                .attr("y", d => yScale(d.end))
                .attr("width", xScale.bandwidth())
                .attr("height", d => yScale(d.start) - yScale(d.end))
                .attr("fill", d => getColor(d.type))
                .attr("stroke", d => getColor(d.type))
                .attr("stroke-width", 1);
            
            // Add value labels on bars - Improved formatting (no "Rp")
            g.selectAll(".label")
                .data(processedData)
                .enter().append("text")
                .attr("class", "label")
                .attr("x", d => xScale(d.label) + xScale.bandwidth() / 2)
                .attr("y", d => yScale(d.end) - 5)
                .attr("text-anchor", "middle")
                .style("font-size", "9px")  // Smaller font
                .style("font-weight", "bold")
                .style("fill", "#374151")
                .text(d => {
                    // Remove "Rp" prefix and make more compact
                    const absAmount = Math.abs(d.value);
                    if (absAmount >= 1000000) {
                        return `${(absAmount / 1000000).toFixed(1)}M`;
                    } else if (absAmount >= 1000) {
                        return `${(absAmount / 1000).toFixed(1)}K`;
                    } else {
                        return absAmount.toString();
                    }
                });
            
            // Add x-axis with rotated labels
            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(xScale))
                .selectAll("text")
                .style("font-size", "9px")  // Smaller font
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");
            
            // Add y-axis
            g.append("g")
                .call(d3.axisLeft(yScale).tickFormat(d => {
                    // Compact y-axis labels
                    const absAmount = Math.abs(d);
                    if (absAmount >= 1000000) {
                        return `${d >= 0 ? '' : '-'}${(absAmount / 1000000).toFixed(0)}M`;
                    } else if (absAmount >= 1000) {
                        return `${d >= 0 ? '' : '-'}${(absAmount / 1000).toFixed(0)}K`;
                    } else {
                        return d.toString();
                    }
                }))
                .selectAll("text")
                .style("font-size", "9px");
            
            // Add tooltips
            bars.on("mouseover", function(event, d) {
                const tooltip = d3.select("body").append("div")
                    .attr("class", "d3-tooltip")
                    .style("position", "absolute")
                    .style("background", "rgba(0,0,0,0.8)")
                    .style("color", "white")
                    .style("padding", "8px")
                    .style("border-radius", "4px")
                    .style("font-size", "12px")
                    .style("pointer-events", "none")
                    .style("z-index", "1000");
                
                tooltip.html(`<strong>${d.label}</strong><br/>${formatCurrency(d.value)}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 10) + "px");
                
                d3.select(this).attr("opacity", 0.8);
            })
            .on("mouseout", function() {
                d3.selectAll(".d3-tooltip").remove();
                d3.select(this).attr("opacity", 1);
            });
        }
        
        // Show "no data" message - Fixed to preserve container
        function showNoDataMessage(canvasId, message) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error('Canvas not found for showNoDataMessage:', canvasId);
                return;
            }
            
            // Clear the canvas content but keep the canvas element itself
            canvas.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 300px; color: #6b7280;">
                    <i class="fas fa-chart-bar" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                    <p style="margin: 0; font-style: italic;">${message}</p>
                </div>
            `;
        }
        
        // Render executive summary
        function renderExecutiveSummary() {
            const { current, previous } = comparisonData;
            if (!current || !previous) return;
            
            const summaryContainer = document.getElementById('executiveSummary');
            if (!summaryContainer) return;
            
            // Calculate key insights
            const revenueGrowth = ((current.netRevenue - previous.netRevenue) / previous.netRevenue) * 100;
            const grossMarginCurrent = (current.grossProfit / current.netRevenue) * 100;
            const grossMarginPrevious = (previous.grossProfit / previous.netRevenue) * 100;
            const grossMarginChange = grossMarginCurrent - grossMarginPrevious;
            
            const opexGrowth = ((current.opex - previous.opex) / previous.opex) * 100;
            const ebitdaMarginCurrent = (current.ebitda / current.netRevenue) * 100;
            const ebitdaMarginPrevious = (previous.ebitda / previous.netRevenue) * 100;
            
            const revenuePerRupiah = current.netRevenue / current.opex; // Revenue efficiency
            const burnMultiple = current.opex / (current.netRevenue - previous.netRevenue || 1); // Capital efficiency
            
            summaryContainer.innerHTML = `
                <div class="executive-summary">
                    <div class="summary-header">
                        <h4>Executive Summary</h4>
                    </div>
                    <div class="summary-content">
                        
                        <div class="summary-item ${revenueGrowth > 15 ? 'positive' : revenueGrowth > 5 ? 'neutral' : 'negative'}">
                            <h5>Growth Momentum</h5>
                            <p>${revenueGrowth.toFixed(1)}% revenue growth ${revenueGrowth > 20 ? 'indicates strong market traction' : revenueGrowth > 10 ? 'shows healthy expansion' : 'suggests need for growth acceleration'}. ${revenueGrowth > 15 ? 'Consider scaling successful channels.' : 'Focus on customer acquisition and retention strategies.'}</p>
                        </div>
                        
                        <div class="summary-item ${grossMarginChange > 2 ? 'positive' : grossMarginChange > 0 ? 'neutral' : 'negative'}">
                            <h5>Margin Excellence</h5>
                            <p>Gross margin ${grossMarginChange > 0 ? 'improved' : 'declined'} by ${Math.abs(grossMarginChange).toFixed(1)}pp to ${grossMarginCurrent.toFixed(1)}%. ${grossMarginCurrent > 70 ? 'Strong pricing power maintained.' : grossMarginCurrent > 50 ? 'Healthy margins with room for optimization.' : 'Focus on cost reduction and pricing strategy.'} ${grossMarginChange < -2 ? 'Investigate cost pressures immediately.' : ''}</p>
                        </div>
                        
                        <div class="summary-item ${opexGrowth < revenueGrowth ? 'positive' : opexGrowth < revenueGrowth * 1.5 ? 'neutral' : 'negative'}">
                            <h5>Operational Leverage</h5>
                            <p>${opexGrowth < revenueGrowth ? 'Positive operating leverage achieved' : 'Operating expenses growing faster than revenue'}. OPEX increased ${opexGrowth.toFixed(1)}% vs ${revenueGrowth.toFixed(1)}% revenue growth. ${opexGrowth > revenueGrowth * 1.2 ? 'Urgent cost discipline needed.' : opexGrowth < revenueGrowth ? 'Maintain this efficient scaling.' : 'Monitor expense growth closely.'}</p>
                        </div>
                        
                        <div class="summary-item ${ebitdaMarginCurrent > 15 ? 'positive' : ebitdaMarginCurrent > 5 ? 'neutral' : 'negative'}">
                            <h5>Profitability Outlook</h5>
                            <p>EBITDA margin of ${ebitdaMarginCurrent.toFixed(1)}% ${ebitdaMarginCurrent > ebitdaMarginPrevious ? 'expanded' : 'contracted'} ${Math.abs(ebitdaMarginCurrent - ebitdaMarginPrevious).toFixed(1)}pp. ${ebitdaMarginCurrent > 20 ? 'Excellent profitability profile.' : ebitdaMarginCurrent > 10 ? 'Solid path to profitability.' : ebitdaMarginCurrent > 0 ? 'Focus on margin expansion.' : 'Prioritize unit economics improvement.'}</p>
                        </div>
                        
                        <div class="summary-item">
                            <h5>Strategic Priorities</h5>
                            <p>${generateStrategicRecommendations(revenueGrowth, grossMarginChange, opexGrowth, ebitdaMarginCurrent)}</p>
                        </div>
                        
                    </div>
                </div>
            `;
        }
        
        // Add helper function for strategic recommendations
        function generateStrategicRecommendations(revenueGrowth, marginChange, opexGrowth, ebitdaMargin) {
            const recommendations = [];
            
            if (revenueGrowth < 10) {
                recommendations.push("accelerate customer acquisition");
            }
            if (marginChange < -1) {
                recommendations.push("address cost pressures");
            }
            if (opexGrowth > revenueGrowth * 1.2) {
                recommendations.push("implement cost discipline");
            }
            if (ebitdaMargin < 10) {
                recommendations.push("optimize unit economics");
            }
            
            if (recommendations.length === 0) {
                return "Strong performance across all metrics. Focus on scaling successful strategies and maintaining operational efficiency.";
            }
            
            return `Key focus areas: ${recommendations.join(", ")}. Consider quarterly OKRs targeting these priorities.`;
        }
        
        function renderRevenueOpexBreakdown() {
            const { current, previous } = comparisonData;
            
            const container = document.getElementById('revenue-opex-breakdown-tab');
            if (!container) {
                console.error('Revenue OPEX breakdown container not found');
                return;
            }
            
            if (!current || !previous) {
                container.innerHTML = '<div class="no-data-message">Please generate a comparison report first from the P&L Comparison tab.</div>';
                return;
            }
            
            // Calculate metrics
            const revenueGrowth = ((current.netRevenue - previous.netRevenue) / previous.netRevenue) * 100;
            const opexGrowth = ((current.opex - previous.opex) / previous.opex) * 100;
            const opexRatio = (current.opex / current.netRevenue) * 100;
            
            container.innerHTML = `
                <!-- Top Metrics - Using existing metrics-grid and metric-card -->
                <div class="metrics-grid" style="margin-bottom: 2rem;">
                    <div class="metric-card enhanced-card">
                        <div class="card-accent accent-blue"></div>
                        <div class="metric-header">
                            <div class="card-main">
                                <div class="metric-title-group">
                                    <div class="metric-title">Total Revenue</div>
                                    <div class="metric-subtitle">Current Period</div>
                                </div>
                                <div class="metric-primary-group">
                                    <span class="metric-value-large">Rp ${(current.netRevenue / 1000000).toFixed(1)}M</span>
                                    <div class="metric-breakdown">
                                        <span class="breakdown-item">
                                            <span class="breakdown-label">Change: </span>
                                            <span class="breakdown-value ${revenueGrowth >= 0 ? 'positive' : 'negative'}">
                                                ${revenueGrowth >= 0 ? '+' : ''}${revenueGrowth.toFixed(1)}%
                                            </span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metric-card enhanced-card">
                        <div class="card-accent accent-orange"></div>
                        <div class="metric-header">
                            <div class="card-main">
                                <div class="metric-title-group">
                                    <div class="metric-title">Total OPEX</div>
                                    <div class="metric-subtitle">Operating Expenses</div>
                                </div>
                                <div class="metric-primary-group">
                                    <span class="metric-value-large">Rp ${(current.opex / 1000000).toFixed(1)}M</span>
                                    <div class="metric-breakdown">
                                        <span class="breakdown-item">
                                            <span class="breakdown-label">Change: </span>
                                            <span class="breakdown-value ${opexGrowth <= 0 ? 'positive' : 'negative'}">
                                                ${opexGrowth >= 0 ? '+' : ''}${opexGrowth.toFixed(1)}%
                                            </span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metric-card enhanced-card">
                        <div class="card-accent accent-green"></div>
                        <div class="metric-header">
                            <div class="card-main">
                                <div class="metric-title-group">
                                    <div class="metric-title">OPEX Ratio</div>
                                    <div class="metric-subtitle">of Total Revenue</div>
                                </div>
                                <div class="metric-primary-group">
                                    <span class="metric-value-large">${opexRatio.toFixed(1)}%</span>
                                    <div class="metric-breakdown">
                                        <span class="breakdown-item">
                                            <span class="breakdown-label">Efficiency: </span>
                                            <span class="breakdown-value">${opexRatio < 30 ? 'Good' : opexRatio < 50 ? 'Fair' : 'Poor'}</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analysis Tables - Using existing breakdown-analysis-grid -->
                <div class="breakdown-analysis-grid">
                    <div class="analysis-section-container">
                        <div class="analysis-header">
                            <h4><i class="fas fa-chart-line"></i> Revenue Analysis</h4>
                            <button class="btn btn-secondary" onclick="exportRevenueBreakdown()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                        <div class="analysis-chart-container">
                            <div class="chart-header-simple">
                                <p>Distribution across income streams</p>
                            </div>
                            <div id="revenueBreakdownTable"></div>
                        </div>
                    </div>
                    
                    <div class="analysis-section-container">
                        <div class="analysis-header">
                            <h4><i class="fas fa-chart-bar"></i> OPEX Analysis</h4>
                            <button class="btn btn-secondary" onclick="exportOpexBreakdown()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                        <div class="analysis-chart-container">
                            <div class="chart-header-simple">
                                <p>Operating expenses by department</p>
                            </div>
                            <div id="opexBreakdownTable"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Insights Section - Using existing insights classes -->
                <div class="ai-insights-container">
                    <div class="insights-header-AIinsight">
                        <h4><i class="fas fa-lightbulb"></i> Key Insights & Recommendations</h4>
                    </div>
                    <div class="insights-grid" id="revenueOpexInsights">
                        <!-- Insights will be populated here -->
                    </div>
                </div>
            `;
            
            // Generate tables and insights
            generateRevenueBreakdownTable();
            generateOpexBreakdownTable();
            generateRevenueOpexInsights();
        }

        function generateRevenueOpexBreakdown() {
            renderRevenueOpexBreakdown();
        }
        
        function generateRevenueAnalysisTable() {
            generateRevenueBreakdownTable(); // Call the corrected function name
        }
        
        function generateRevenueBreakdownTable() {
            const { current, previous } = comparisonData;
            
            const revenueAccounts = [
                { code: 4010, name: 'Sales Revenue' },
                { code: 4020, name: 'Service Revenue' },
                { code: 4030, name: 'Interest Income' },
                { code: 4050, name: 'Other Income' },
                { code: 4060, name: 'Sales Discounts', isNegative: true },
                { code: 4070, name: 'Sales Returns', isNegative: true }
            ];
            
            let tableHTML = `
                <div class="ro-table-container-full">
                    <table class="ro-financial-table-full">
                        <thead>
                            <tr>
                                <th style="width: 30%;">Revenue Source</th>
                                <th style="width: 18%;">Current</th>
                                <th style="width: 18%;">Previous</th>
                                <th style="width: 18%;">Change</th>
                                <th style="width: 16%;">% Cont.</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            revenueAccounts.forEach(account => {
                const currentAmount = getAccountBalance(current, account.code);
                const previousAmount = getAccountBalance(previous, account.code);
                
                // For negative accounts (discounts, returns), show as negative values
                const displayCurrentAmount = account.isNegative ? -Math.abs(currentAmount) : currentAmount;
                const displayPreviousAmount = account.isNegative ? -Math.abs(previousAmount) : previousAmount;
                
                const change = displayCurrentAmount - displayPreviousAmount;
                const percentOfTotal = current.netRevenue > 0 ? (Math.abs(displayCurrentAmount) / current.netRevenue) * 100 : 0;
                
                if (displayCurrentAmount !== 0 || displayPreviousAmount !== 0) {
                    tableHTML += `
                        <tr>
                            <td class="ro-account-name-cell"><strong>${account.name}</strong></td>
                            <td class="ro-amount-cell">Rp ${(displayCurrentAmount / 1000000).toFixed(2)}M</td>
                            <td class="ro-amount-cell">Rp ${(displayPreviousAmount / 1000000).toFixed(2)}M</td>
                            <td class="ro-change-cell ${change >= 0 ? 'positive' : 'negative'}">
                                ${change >= 0 ? '+' : ''}${(change / 1000000).toFixed(2)}M
                            </td>
                            <td class="ro-percent-cell">${percentOfTotal.toFixed(1)}%</td>
                        </tr>
                    `;
                }
            });
            
            // Single total row that matches system total
            tableHTML += `
                    <tr class="ro-total-row-single">
                        <td class="ro-account-name-cell"><strong>Total Revenue</strong></td>
                        <td class="ro-amount-cell ro-total-amount"><strong>Rp ${(current.netRevenue / 1000000).toFixed(1)}M</strong></td>
                        <td class="ro-amount-cell ro-total-amount"><strong>Rp ${(previous.netRevenue / 1000000).toFixed(1)}M</strong></td>
                        <td class="ro-change-cell ro-total-change ${(current.netRevenue - previous.netRevenue) >= 0 ? 'positive' : 'negative'}">
                            <strong>${(current.netRevenue - previous.netRevenue) >= 0 ? '+' : ''}${((current.netRevenue - previous.netRevenue) / 1000000).toFixed(1)}M</strong>
                        </td>
                        <td class="ro-percent-cell"><strong>100.0%</strong></td>
                    </tr>
                </tbody></table>
                </div>
            `;
            
            document.getElementById('revenueBreakdownTable').innerHTML = tableHTML;
        }

        function generateRevenueOpexInsights() {
            const { current, previous } = comparisonData;
            
            const revenueGrowth = ((current.netRevenue - previous.netRevenue) / previous.netRevenue) * 100;
            const opexGrowth = ((current.opex - previous.opex) / previous.opex) * 100;
            const opexRatio = (current.opex / current.netRevenue) * 100;
            
            let insightsHTML = '';
            
            // Revenue insight
            if (revenueGrowth > 15) {
                insightsHTML += `
                    <div class="ro-insight-card-full positive">
                        <div class="ro-insight-icon-full"></div>
                        <div class="ro-insight-content-full">
                            <div class="ro-insight-title-full">Strong Revenue Growth</div>
                            <div class="ro-insight-description-full">${revenueGrowth.toFixed(1)}% revenue growth indicates excellent market traction. Consider scaling successful revenue channels and expanding market reach to capitalize on this momentum.</div>
                        </div>
                    </div>
                `;
            } else if (revenueGrowth < 5) {
                insightsHTML += `
                    <div class="ro-insight-card-full warning">
                        <div class="ro-insight-icon-full"></div>
                        <div class="ro-insight-content-full">
                            <div class="ro-insight-title-full">Revenue Growth Opportunity</div>
                            <div class="ro-insight-description-full">Revenue growth of ${revenueGrowth.toFixed(1)}% suggests need for acceleration. Focus on customer acquisition, pricing optimization, and developing new revenue streams.</div>
                        </div>
                    </div>
                `;
            } else {
                insightsHTML += `
                    <div class="ro-insight-card-full positive">
                        <div class="ro-insight-icon-full"></div>
                        <div class="ro-insight-content-full">
                            <div class="ro-insight-title-full">Steady Revenue Growth</div>
                            <div class="ro-insight-description-full">${revenueGrowth.toFixed(1)}% revenue growth shows healthy business expansion. Maintain current strategies while exploring new growth opportunities.</div>
                        </div>
                    </div>
                `;
            }
            
            // OPEX insight
            if (opexGrowth > revenueGrowth + 10) {
                insightsHTML += `
                    <div class="ro-insight-card-full negative">
                        <div class="ro-insight-icon-full"></div>
                        <div class="ro-insight-content-full">
                            <div class="ro-insight-title-full">Cost Discipline Needed</div>
                            <div class="ro-insight-description-full">OPEX grew ${opexGrowth.toFixed(1)}% vs ${revenueGrowth.toFixed(1)}% revenue growth. Implement immediate cost controls and review all non-essential expenses to improve operational efficiency.</div>
                        </div>
                    </div>
                `;
            } else if (opexGrowth < revenueGrowth) {
                insightsHTML += `
                    <div class="ro-insight-card-full positive">
                        <div class="ro-insight-icon-full"></div>
                        <div class="ro-insight-content-full">
                            <div class="ro-insight-title-full">Operational Leverage Achieved</div>
                            <div class="ro-insight-description-full">Positive operating leverage with OPEX growing slower than revenue (${opexGrowth.toFixed(1)}% vs ${revenueGrowth.toFixed(1)}%). This efficient scaling model should be maintained and replicated.</div>
                        </div>
                    </div>
                `;
            } else {
                insightsHTML += `
                    <div class="ro-insight-card-full warning">
                        <div class="ro-insight-icon-full"></div>
                        <div class="ro-insight-content-full">
                            <div class="ro-insight-title-full">Monitor Cost Growth</div>
                            <div class="ro-insight-description-full">OPEX growth (${opexGrowth.toFixed(1)}%) is tracking close to revenue growth. Monitor expenses closely to maintain profitability as you scale.</div>
                        </div>
                    </div>
                `;
            }
            
            // Additional insight based on OPEX ratio
            if (opexRatio > 50) {
                insightsHTML += `
                    <div class="ro-insight-card-full negative">
                        <div class="ro-insight-icon-full"></div>
                        <div class="ro-insight-content-full">
                            <div class="ro-insight-title-full">High OPEX Ratio Alert</div>
                            <div class="ro-insight-description-full">OPEX ratio of ${opexRatio.toFixed(1)}% indicates room for optimization. Target reducing this to below 40% through automation, process improvements, and strategic cost management.</div>
                        </div>
                    </div>
                `;
            } else if (opexRatio < 25) {
                insightsHTML += `
                    <div class="ro-insight-card-full positive">
                        <div class="ro-insight-icon-full"></div>
                        <div class="ro-insight-content-full">
                            <div class="ro-insight-title-full">Excellent Cost Control</div>
                            <div class="ro-insight-description-full">OPEX ratio of ${opexRatio.toFixed(1)}% demonstrates exceptional operational efficiency. This lean cost structure provides competitive advantage and investment flexibility.</div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('revenueOpexInsights').innerHTML = insightsHTML;
        }
        
        function generateOpexAnalysisTable() {
            generateOpexBreakdownTable(); // Call the corrected function name
        }
        
        function generateOpexBreakdownTable() {
            const { current, previous } = comparisonData;
            
            const opexCategories = [
                { name: 'Facilities', codes: [5200, 5210, 5220, 5230, 5240, 5250] },
                { name: 'Marketing', codes: [5300, 5310, 5320, 5330] },
                { name: 'Professional Services', codes: [5400, 5410, 5420, 5430] },
                { name: 'Operations', codes: [5500, 5600, 5700, 5800] }
            ];
            
            let tableHTML = `
                <div class="ro-table-container-full">
                    <table class="ro-financial-table-full">
                        <thead>
                            <tr>
                                <th style="width: 30%;">OPEX Category</th>
                                <th style="width: 18%;">Current</th>
                                <th style="width: 18%;">Previous</th>
                                <th style="width: 18%;">Change</th>
                                <th style="width: 16%;">% Cont.</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            opexCategories.forEach(category => {
                let currentTotal = 0;
                let previousTotal = 0;
                
                category.codes.forEach(code => {
                    currentTotal += getAccountBalance(current, code);
                    previousTotal += getAccountBalance(previous, code);
                });
                
                if (currentTotal > 0 || previousTotal > 0) {
                    const change = currentTotal - previousTotal;
                    const percentOfTotal = current.opex > 0 ? (currentTotal / current.opex) * 100 : 0;
                    
                    tableHTML += `
                        <tr>
                            <td class="ro-account-name-cell"><strong>${category.name}</strong></td>
                            <td class="ro-amount-cell">Rp ${(currentTotal / 1000000).toFixed(2)}M</td>
                            <td class="ro-amount-cell">Rp ${(previousTotal / 1000000).toFixed(2)}M</td>
                            <td class="ro-change-cell ${change >= 0 ? 'negative' : 'positive'}">
                                ${change >= 0 ? '+' : ''}${(change / 1000000).toFixed(2)}M
                            </td>
                            <td class="ro-percent-cell">${percentOfTotal.toFixed(1)}%</td>
                        </tr>
                    `;
                }
            });
            
            // Single total row that matches system total
            tableHTML += `
                    <tr class="ro-total-row-single">
                        <td class="ro-account-name-cell"><strong>Total OPEX</strong></td>
                        <td class="ro-amount-cell ro-total-amount"><strong>Rp ${(current.opex / 1000000).toFixed(1)}M</strong></td>
                        <td class="ro-amount-cell ro-total-amount"><strong>Rp ${(previous.opex / 1000000).toFixed(1)}M</strong></td>
                        <td class="ro-change-cell ro-total-change ${(current.opex - previous.opex) >= 0 ? 'negative' : 'positive'}">
                            <strong>${(current.opex - previous.opex) >= 0 ? '+' : ''}${((current.opex - previous.opex) / 1000000).toFixed(1)}M</strong>
                        </td>
                        <td class="ro-percent-cell"><strong>100.0%</strong></td>
                    </tr>
                </tbody></table>
                </div>
            `;
            
            document.getElementById('opexBreakdownTable').innerHTML = tableHTML;
        }
        
        function generateOpexAnalysisTable() {
            const { current, previous } = comparisonData;
            
            // OPEX categories based on your GL structure
            const opexCategories = [
                { name: 'Facilities', codes: [5200, 5210, 5220, 5230, 5240, 5250] },
                { name: 'Marketing', codes: [5300, 5310, 5320, 5330] },
                { name: 'Professional Services', codes: [5400, 5410, 5420, 5430] },
                { name: 'Operations', codes: [5500, 5600, 5700, 5800] }
            ];
            
            let tableHTML = `
                <table class="breakdown-table">
                    <thead>
                        <tr>
                            <th>OPEX Category</th>
                            <th>Current Period</th>
                            <th>Previous Period</th>
                            <th>Change</th>
                            <th>% Cont.</th>
                            <th>Vendor/Details</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            opexCategories.forEach(category => {
                let currentTotal = 0;
                let previousTotal = 0;
                let vendorInfo = [];
                
                category.codes.forEach(code => {
                    const currentAmount = getAccountBalance(current, code);
                    const previousAmount = getAccountBalance(previous, code);
                    currentTotal += currentAmount;
                    previousTotal += previousAmount;
                    
                    if (currentAmount > 0) {
                        const accountName = getAccountNameByCode(code);
                        const vendor = getVendorInfoForAccount(current, code);
                        vendorInfo.push(`${accountName}: ${vendor}`);
                    }
                });
                
                if (currentTotal > 0 || previousTotal > 0) {
                    const change = currentTotal - previousTotal;
                    const changePercent = previousTotal !== 0 ? (change / previousTotal) * 100 : 0;
                    const percentOfTotal = (currentTotal / current.opex) * 100;
                    
                    tableHTML += `
                        <tr>
                            <td><strong>${category.name}</strong></td>
                            <td>Rp ${(currentTotal / 1000000).toFixed(2)}M</td>
                            <td>Rp ${(previousTotal / 1000000).toFixed(2)}M</td>
                            <td class="${change >= 0 ? 'negative' : 'positive'}">
                                ${change >= 0 ? '+' : ''}${(change / 1000000).toFixed(2)}M (${changePercent.toFixed(1)}%)
                            </td>
                            <td>${percentOfTotal.toFixed(1)}%</td>
                            <td>${vendorInfo.slice(0, 2).join('; ')}</td>
                        </tr>
                    `;
                }
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('opexAnalysisTable').innerHTML = tableHTML;
        }
        
        // Helper functions
        function getCustomerInfoForAccount(periodData, accountCode) {
            const transactions = periodData.transactions?.filter(t => 
                parseInt(t.account_code) === accountCode && parseFloat(t.credit_amount || 0) > 0
            ) || [];
            
            if (transactions.length === 0) return 'N/A';
            
            const customers = transactions.map(t => t.description || t.reference || 'Unknown').slice(0, 2);
            return customers.join(', ');
        }
        
        function getVendorInfoForAccount(periodData, accountCode) {
            const transactions = periodData.transactions?.filter(t => 
                parseInt(t.account_code) === accountCode && parseFloat(t.debit_amount || 0) > 0
            ) || [];
            
            if (transactions.length === 0) return 'N/A';
            
            const vendors = transactions.map(t => t.description || t.reference || 'Unknown').slice(0, 1);
            return vendors.join(', ');
        }
        
        function getAccountNameByCode(accountCode) {
            const account = glAccounts.find(acc => acc.account_code === accountCode);
            return account ? account.account_name : `Account ${accountCode}`;
        }
        
        // Show/hide loading state
        function showComparisonLoadingState(show) {
            const loading = document.getElementById('comparisonLoading');
            const content = document.getElementById('comparisonTableContent');
            
            if (show) {
                loading.style.display = 'block';
                content.innerHTML = '';
                document.getElementById('waterfallChartsSection').style.display = 'none';
                document.getElementById('executiveSummary').style.display = 'none';
            } else {
                loading.style.display = 'none';
            }
        }

        function generateTrendingAnalysis() {
            const monthsToInclude = parseInt(document.getElementById('trendingMonths').value) || 6;
            
            // Calculate the trending data
            const trendingData = calculateTrendingData(monthsToInclude);

            window.trendingData = trendingData;
            
            // Update summary cards
            updateTrendingSummaryCards(trendingData);
            
            // Render the main chart
            renderTrendingChart(trendingData);
            
            // Generate insights (THIS WAS MISSING THE CALL!)
            generateTrendingInsights(trendingData);
        }
        
        function calculateTrendingData(monthsToInclude) {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1;
            
            const trendingData = {
                periods: [],
                revenue: [],
                opex: [],
                margins: [],
                currentMonthMTD: 0,
                currentMonthProjected: 0
            };
            
            // Calculate historical months
            for (let i = monthsToInclude - 1; i >= 0; i--) {
                let year = currentYear;
                let month = currentMonth - i;
                
                if (month <= 0) {
                    month += 12;
                    year -= 1;
                }
                
                const periodKey = `${year}-${String(month).padStart(2, '0')}`;
                const monthName = new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short' });
                
                // Get transactions for this period
                const transactions = getTransactionsForPeriodFixed(periodKey, 'custom');
                const financialData = calculateFinancialDataFromTransactions(transactions, periodKey, 'custom');
                
                trendingData.periods.push(monthName);
                trendingData.revenue.push(financialData.netRevenue / 1000000); // Convert to millions
                trendingData.opex.push(financialData.opex / 1000000);
                trendingData.margins.push(financialData.netRevenue > 0 ? ((financialData.netRevenue - financialData.opex) / financialData.netRevenue) * 100 : 0);
            }
            
            // Add current month (split into MTD + Projected)
            const currentPeriodKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            const currentTransactions = getTransactionsForPeriodFixed(currentPeriodKey, 'custom');
            const currentData = calculateFinancialDataFromTransactions(currentTransactions, currentPeriodKey, 'custom');
            
            // Calculate MTD and projection
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const daysPassed = today.getDate();
            const progressPercent = daysPassed / daysInMonth;
            
            trendingData.currentMonthMTD = currentData.netRevenue / 1000000;
            
            // Simple projection based on daily average
            if (progressPercent > 0) {
                const projectedTotal = trendingData.currentMonthMTD / progressPercent;
                trendingData.currentMonthProjected = projectedTotal - trendingData.currentMonthMTD;
            }
            
            // Add current month to trending data
            const currentMonthName = new Date(currentYear, currentMonth - 1).toLocaleDateString('en-US', { month: 'short' });
            trendingData.periods.push(currentMonthName + '*');
            trendingData.revenue.push(trendingData.currentMonthMTD + trendingData.currentMonthProjected);
            trendingData.opex.push(currentData.opex / 1000000 / progressPercent); // Project OPEX too
            
            return trendingData;
        }
        
        function renderTrendingChart(data) {
            const ctx = document.getElementById('trendingChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.trendingChartInstance) {
                window.trendingChartInstance.destroy();
            }
            
            const chartData = {
                labels: data.periods,
                datasets: [
                    {
                        label: 'Revenue (Millions)',
                        data: data.revenue,
                        backgroundColor: data.periods.map((period, index) => {
                            if (index === data.periods.length - 1) {
                                // Current month - different color (blue with transparency)
                                return 'rgba(59, 130, 246, 0.7)';
                            }
                            return 'rgba(16, 185, 129, 0.7)';
                        }),
                        borderWidth: 0, // Remove borders
                        type: 'bar'
                    },
                    {
                        label: 'OPEX (Millions)',
                        data: data.opex,
                        backgroundColor: data.periods.map((period, index) => {
                            if (index === data.periods.length - 1) {
                                // Current month - different color (red with transparency)
                                return 'rgba(239, 68, 68, 0.7)';
                            }
                            return 'rgba(239, 68, 68, 0.6)';
                        }),
                        borderWidth: 0, // Remove borders
                        type: 'bar'
                    },
                    {
                        label: 'Revenue Trend',
                        data: data.revenue,
                        borderColor: 'rgba(16, 185, 129, 1)',
                        backgroundColor: 'transparent',
                        borderWidth: 3,
                        type: 'line',
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgba(16, 185, 129, 1)',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    },
                    {
                        label: 'OPEX Trend',
                        data: data.opex,
                        borderColor: 'rgba(239, 68, 68, 1)',
                        backgroundColor: 'transparent',
                        borderWidth: 3,
                        type: 'line',
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgba(239, 68, 68, 1)',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }
                ]
            };
            
            const config = {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    if (context.label.includes('*')) {
                                        return '* Current month includes projection';
                                    }
                                    return '';
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += 'Rp ' + context.parsed.y.toFixed(1) + 'M';
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Month (* = includes projection)',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Amount (Millions Rp)',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                callback: function(value) {
                                    return 'Rp ' + value + 'M';
                                }
                            }
                        }
                    }
                }
            };
            
            window.trendingChartInstance = new Chart(ctx, config);
        }
        
        function updateTrendingSummaryCards(data) {
            if (data.revenue.length < 2) return;
            
            const revenueStart = data.revenue[0];
            const revenueEnd = data.revenue[data.revenue.length - 1];
            const totalMonths = data.revenue.length - 1;
            
            let revenueCMGR = 0;
            if (revenueStart > 0 && revenueEnd > 0 && totalMonths > 0) {
                revenueCMGR = (Math.pow(revenueEnd / revenueStart, 1 / totalMonths) - 1) * 100;
            } else if (revenueStart === 0 && revenueEnd > 0) {
                // Handle starting from zero case
                document.getElementById('revenueTrendValue').textContent = 'New Revenue';
                document.getElementById('revenueVelocity').textContent = 'Starting';
                return;
            }
            
            // Ensure the result is not NaN or Infinity
            if (!isFinite(revenueCMGR)) {
                revenueCMGR = 0;
            }
            
            document.getElementById('revenueTrendValue').textContent = `${revenueCMGR >= 0 ? '+' : ''}${revenueCMGR.toFixed(1)}%`;
            
            // Velocity based on CMGR
            document.getElementById('revenueVelocity').textContent = 
                revenueCMGR > 15 ? 'Exceptional' :    // >15% monthly is extraordinary
                revenueCMGR > 8 ? 'Accelerating' :    // >8% monthly is very strong  
                revenueCMGR > 3 ? 'Growing' :         // >3% monthly is healthy
                revenueCMGR > 0 ? 'Slow Growth' :     // Positive but <3% monthly
                'Declining';
            
            // OPEX CMGR: Same logic
            const opexStart = data.opex[0];
            const opexEnd = data.opex[data.opex.length - 1];
            
            let opexCMGR = 0;
            if (opexStart > 0 && totalMonths > 0) {
                opexCMGR = (Math.pow(opexEnd / opexStart, 1 / totalMonths) - 1) * 100;
            }
            
            document.getElementById('opexTrendValue').textContent = `${opexCMGR >= 0 ? '+' : ''}${opexCMGR.toFixed(1)}%`;
            document.getElementById('opexEfficiency').textContent = 
                opexCMGR < revenueCMGR - 2 ? 'Improving' :
                opexCMGR < revenueCMGR + 2 ? 'Stable' : 'Declining';
            
            // Margin trend: Calculate margin CMGR if we have margin data
            if (data.margins && data.margins.length > 1) {
                const marginStart = data.margins[0];
                const marginEnd = data.margins[data.margins.length - 2]; // Exclude current month projection
                const marginDifference = marginEnd - marginStart;
                
                document.getElementById('marginTrendValue').textContent = `${marginEnd.toFixed(1)}%`;
                document.getElementById('marginDirection').textContent = 
                    marginDifference > 2 ? 'Improving' :
                    marginDifference > -2 ? 'Stable' : 'Declining';
            } else {
                // Current margin calculation
                const currentMargin = revenueEnd > 0 ? ((revenueEnd - opexEnd) / revenueEnd) * 100 : 0;
                document.getElementById('marginTrendValue').textContent = `${currentMargin.toFixed(1)}%`;
                document.getElementById('marginDirection').textContent = 'Current';
            }
            
            // Current month progress: Days passed / Total days in month
            const today = new Date();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const daysPassed = today.getDate();
            const progressPercent = (daysPassed / daysInMonth) * 100;
            
            document.getElementById('currentMonthProgress').textContent = `${progressPercent.toFixed(0)}%`;
            document.getElementById('currentMonthProjected').textContent = `Rp ${(data.currentMonthMTD + data.currentMonthProjected).toFixed(1)}M`;
            
            console.log('CMGR Calculation Debug:', {
                revenueStart,
                revenueEnd,
                totalMonths,
                revenueCMGR: revenueCMGR.toFixed(2) + '%',
                opexCMGR: opexCMGR.toFixed(2) + '%'
            });
        }
        
        function generateTrendingInsights(data) {
            if (!data || data.revenue.length < 2) {
                document.getElementById('trendingInsights').innerHTML = `
                    <div class="ro-insight-card-full warning">
                        <div class="ro-insight-icon-full"></div>
                        <div class="ro-insight-content-full">
                            <div class="ro-insight-title-full">Insufficient Data</div>
                            <div class="ro-insight-description-full">More historical data is needed to generate meaningful trend insights. Continue using the system to build trend analysis.</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            let insightsHTML = '';
            
            // Calculate CMGR for insights
            const revenueStart = data.revenue[0];
            const revenueEnd = data.revenue[data.revenue.length - 1];
            const totalMonths = data.revenue.length - 1;
            
            let revenueCMGR = 0;
            if (revenueStart > 0 && totalMonths > 0) {
                revenueCMGR = (Math.pow(revenueEnd / revenueStart, 1 / totalMonths) - 1) * 100;
            }
            
            // Revenue CMGR insight (updated thresholds for monthly rates)
            if (revenueCMGR > 10) { // 10% monthly = very strong
                insightsHTML += `
                    <div class="ro-insight-card-full positive">
                        <div class="ro-insight-icon-full"></div>
                        <div class="ro-insight-content-full">
                            <div class="ro-insight-title-full">Exceptional Growth Rate</div>
                            <div class="ro-insight-description-full">Revenue CMGR of ${revenueCMGR.toFixed(1)}% indicates exceptional monthly growth. This ${(Math.pow(1 + revenueCMGR/100, 12) - 1)*100 > 100 ? 'extraordinary' : 'strong'} pace suggests excellent market traction and scaling opportunities.</div>
                        </div>
                    </div>
                `;
            } else if (revenueCMGR < -5) { // -5% monthly = concerning decline
                insightsHTML += `
                    <div class="ro-insight-card-full negative">
                        <div class="ro-insight-icon-full"></div>
                        <div class="ro-insight-content-full">
                            <div class="ro-insight-title-full">Declining Growth Trend</div>
                            <div class="ro-insight-description-full">Revenue CMGR of ${revenueCMGR.toFixed(1)}% indicates declining performance. Immediate strategic review needed to reverse this ${(Math.pow(1 + revenueCMGR/100, 12) - 1)*100 < -50 ? 'critical' : 'concerning'} trend.</div>
                        </div>
                    </div>
                `;
            } else {
                insightsHTML += `
                    <div class="ro-insight-card-full positive">
                        <div class="ro-insight-icon-full"></div>
                        <div class="ro-insight-content-full">
                            <div class="ro-insight-title-full">Steady Performance</div>
                            <div class="ro-insight-description-full">Revenue CMGR shows ${revenueCMGR >= 0 ? 'growth' : 'decline'} of ${revenueCMGR.toFixed(1)}% monthly. Consider strategies to accelerate growth while maintaining operational efficiency.</div>
                        </div>
                    </div>
                `;
            }
            
            // Calculate OPEX CMGR for comparison
            const opexStart = data.opex[0];
            const opexEnd = data.opex[data.opex.length - 1];
            
            let opexCMGR = 0;
            if (opexStart > 0 && totalMonths > 0) {
                opexCMGR = (Math.pow(opexEnd / opexStart, 1 / totalMonths) - 1) * 100;
            }
            
            // OPEX efficiency insight using CMGR
            if (opexCMGR > revenueCMGR + 5) { // 5% monthly difference is significant
                insightsHTML += `
                    <div class="ro-insight-card-full negative">
                        <div class="ro-insight-icon-full"></div>
                        <div class="ro-insight-content-full">
                            <div class="ro-insight-title-full">OPEX Growing Too Fast</div>
                            <div class="ro-insight-description-full">OPEX CMGR of ${opexCMGR.toFixed(1)}% exceeds revenue CMGR of ${revenueCMGR.toFixed(1)}% by ${(opexCMGR - revenueCMGR).toFixed(1)}pp monthly. This threatens profitability - implement cost discipline measures immediately.</div>
                        </div>
                    </div>
                `;
            } else if (opexCMGR < revenueCMGR - 2) { // 2% monthly difference shows good leverage
                insightsHTML += `
                    <div class="ro-insight-card-full positive">
                        <div class="ro-insight-icon-full"></div>
                        <div class="ro-insight-content-full">
                            <div class="ro-insight-title-full">Excellent Operational Leverage</div>
                            <div class="ro-insight-description-full">OPEX CMGR (${opexCMGR.toFixed(1)}%) is lower than revenue CMGR (${revenueCMGR.toFixed(1)}%), creating ${(revenueCMGR - opexCMGR).toFixed(1)}pp monthly operational leverage. This efficient scaling should be maintained.</div>
                        </div>
                    </div>
                `;
            }
            
            // Seasonality insight
            const monthlyVariation = calculateVariation(data.revenue.slice(0, -1)); // Exclude current month projection
            if (monthlyVariation > 25 && data.revenue.length > 3) {
                insightsHTML += `
                    <div class="ro-insight-card-full warning">
                        <div class="ro-insight-icon-full"></div>
                        <div class="ro-insight-content-full">
                            <div class="ro-insight-title-full">High Revenue Volatility</div>
                            <div class="ro-insight-description-full">Revenue shows ${monthlyVariation.toFixed(1)}% monthly variation, indicating high volatility. Consider diversifying revenue streams or implementing more predictable recurring revenue models.</div>
                        </div>
                    </div>
                `;
            }
            
            // Current month projection insight
            const projectionAccuracy = (data.currentMonthMTD / (data.currentMonthMTD + data.currentMonthProjected)) * 100;
            if (projectionAccuracy > 80) {
                insightsHTML += `
                    <div class="ro-insight-card-full positive">
                        <div class="ro-insight-icon-full"></div>
                        <div class="ro-insight-content-full">
                            <div class="ro-insight-title-full">Strong Month Performance</div>
                            <div class="ro-insight-description-full">Current month is ${projectionAccuracy.toFixed(0)}% complete with strong performance. Projected to reach Rp ${(data.currentMonthMTD + data.currentMonthProjected).toFixed(1)}M by month end.</div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('trendingInsights').innerHTML = insightsHTML;
        }
        
        function calculateVariation(values) {
            if (values.length === 0) return 0;
            const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
            const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
            return (Math.sqrt(variance) / mean) * 100;
        }
        
        function exportTrendingChart() {
            try {
                // Check if trending data exists
                if (!window.trendingData || !window.trendingData.periods || window.trendingData.periods.length === 0) {
                    alert('Please generate trending analysis first.');
                    return;
                }
                
                const data = window.trendingData;
                
                // Create CSV content
                let csvContent = "Period,Revenue (Millions),OPEX (Millions),Gross Margin (%)\n";
                
                // Add data rows
                for (let i = 0; i < data.periods.length; i++) {
                    const period = data.periods[i];
                    const revenue = data.revenue[i] || 0;
                    const opex = data.opex[i] || 0;
                    const margin = data.margins[i] || 0;
                    
                    csvContent += `${period},${revenue.toFixed(2)},${opex.toFixed(2)},${margin.toFixed(1)}\n`;
                }
                
                // Add summary statistics
                csvContent += "\n--- Summary Statistics ---\n";
                
                // Calculate growth rates
                if (data.revenue.length >= 2) {
                    const revenueGrowth = ((data.revenue[data.revenue.length - 1] - data.revenue[0]) / data.revenue[0]) * 100;
                    csvContent += `Revenue Growth (First to Last Period),${revenueGrowth.toFixed(1)}%\n`;
                }
                
                if (data.opex.length >= 2) {
                    const opexGrowth = ((data.opex[data.opex.length - 1] - data.opex[0]) / data.opex[0]) * 100;
                    csvContent += `OPEX Growth (First to Last Period),${opexGrowth.toFixed(1)}%\n`;
                }
                
                // Average margin
                const avgMargin = data.margins.reduce((sum, margin) => sum + margin, 0) / data.margins.length;
                csvContent += `Average Gross Margin,${avgMargin.toFixed(1)}%\n`;
                
                // Current month projections if available
                if (data.currentMonthMTD && data.currentMonthProjected) {
                    csvContent += `Current Month MTD (Millions),${(data.currentMonthMTD / 1000000).toFixed(2)}\n`;
                    csvContent += `Current Month Projected (Millions),${(data.currentMonthProjected / 1000000).toFixed(2)}\n`;
                }
                
                // Download the CSV
                downloadCSVFile(csvContent, 'Trending_Analysis_Export.csv');
                
                console.log('Trending chart data exported successfully');
                
            } catch (error) {
                console.error('Error exporting trending chart:', error);
                
                // Fallback: Try to get data directly from the chart if it exists
                try {
                    const chartCanvas = document.getElementById('trendingChart');
                    if (chartCanvas && window.trendingChartInstance) {
                        const chart = window.trendingChartInstance;
                        const chartData = chart.data;
                        
                        let csvContent = "Period,Revenue (Millions),OPEX (Millions)\n";
                        
                        chartData.labels.forEach((label, index) => {
                            const revenue = chartData.datasets[0]?.data[index] || 0;
                            const opex = chartData.datasets[1]?.data[index] || 0;
                            csvContent += `${label},${revenue},${opex}\n`;
                        });
                        
                        downloadCSVFile(csvContent, 'Trending_Analysis_Export.csv');
                        return;
                    }
                } catch (fallbackError) {
                    console.error('Fallback export also failed:', fallbackError);
                }
                
                alert('Error exporting trending chart: ' + error.message);
            }
        }

        // Initialize when reports section is accessed
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize when the reports section becomes active
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        const reportsSection = document.getElementById('reports-section');
                        if (reportsSection && reportsSection.style.display !== 'none') {
                            initializeReportsAnalytics();
                            observer.disconnect(); // Only initialize once
                        }
                    }
                });
            });
            
            const reportsSection = document.getElementById('reports-section');
            if (reportsSection) {
                observer.observe(reportsSection, { attributes: true });
            }
        });
        
        // Additional CSS for waterfall charts (add to style section)
        const additionalCSS = `
        <style>
        .waterfall-container {
            height: 280px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .waterfall-bars {
            display: flex;
            align-items: end;
            justify-content: space-around;
            height: 200px;
            margin-bottom: 1rem;
        }
        
        .waterfall-bar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
        }
        
        .waterfall-bar {
            min-height: 8px;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .waterfall-bar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .waterfall-bar.base {
            background: linear-gradient(135deg, #64748b, #475569);
        }
        
        .waterfall-bar.positive {
            background: linear-gradient(135deg, #059669, #047857);
        }
        
        .waterfall-bar.negative {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }
        
        .waterfall-bar.total {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
        }
        
        .waterfall-value {
            font-size: 0.65rem;
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', monospace;
        }

        .waterfall-value.positive {
            color: #059669;
        }
        
        .waterfall-value.negative {
            color: #dc2626;
        }
        
        /* Connector lines between bars */
        .waterfall-connector-line {
            z-index: 1;
        }
        
        .error-message {
            text-align: center;
            padding: 2rem;
            color: #dc2626;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            margin: 1rem;
        }
        </style>
        `;
        
        // Add the additional CSS to the document head
        document.head.insertAdjacentHTML('beforeend', additionalCSS);

        // Call this function when the page loads
        document.addEventListener('DOMContentLoaded', ensureFreshReports);

        // Update your existing toggleChatPanel function
        function toggleChatPanel() {
            const chatContainer = document.getElementById('chatContainerRight');
            
            if (chatContainer.classList.contains('active')) {
                chatContainer.classList.add('closing');
                setTimeout(() => {
                    chatContainer.classList.remove('active', 'closing');
                }, 400);
            } else {
                chatContainer.classList.add('active');
                
                // Restore suggestions state when opening chat
                restoreSuggestionsState();
                
                // Initialize AI chat if not already done
                if (!window.aiChat) {
                    window.aiChat = new AIFinancialChat();
                }
                
                // Focus on chat input
                setTimeout(() => {
                    const chatInput = document.getElementById('chatInput');
                    if (chatInput) chatInput.focus();
                }, 100);
            }
        }

        function initializeSampleData() {
            console.log('Initializing sample AP/AR data...');
            
            const sampleData = [
                {
                    id: 'sample_1',
                    type: 'AR',
                    description: 'Web Development Services',
                    amount: 5000000,
                    invoice_date: '2025-01-15',
                    due_date: '2025-02-14',
                    company: 'ABC Corp',
                    status: 'Overdue',
                    reference: 'INV-001',
                    currency: 'IDR',
                    payment_terms: 30
                },
                {
                    id: 'sample_2',
                    type: 'AP',
                    description: 'Office Supplies',
                    amount: 250000,
                    invoice_date: '2025-01-10',
                    due_date: '2025-02-09',
                    company: 'OfficeMax',
                    status: 'Overdue',
                    reference: 'BILL-501',
                    currency: 'IDR',
                    payment_terms: 30
                },
                {
                    id: 'sample_3',
                    type: 'AR',
                    description: 'Consulting Services',
                    amount: 3000000,
                    invoice_date: '2025-01-20',
                    due_date: '2025-02-19',
                    company: 'XYZ Ltd',
                    status: 'Pending',
                    reference: 'INV-002',
                    currency: 'IDR',
                    payment_terms: 30
                }
            ];
            
            // Store in localStorage as backup
            localStorage.setItem('aparTransactions', JSON.stringify(sampleData));
            
            // Also set global variable
            aparTransactions = sampleData;
            
            console.log('Sample data initialized:', sampleData.length, 'transactions');
        }

        // Financing Modal Functions
        function openFinancingModal() {
            // Close all other modals
            document.getElementById('addFinancialModal').classList.remove('show');
            document.getElementById('newAccountModal').classList.remove('show');
            document.getElementById('uploadFinancialModal').classList.remove('show');
            document.getElementById('glAccountSelectionModal').classList.remove('show');
            document.getElementById('aparCreationModal').classList.remove('show');
            document.getElementById('addModal').classList.remove('show');
            document.getElementById('uploadModal').classList.remove('show');

            // Show financing modal using standard modal classes
            const modal = document.getElementById('financingModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            
            // Set default available date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('financingAvailableDate').value = today;
        }
        
        function closeFinancingModal() {
            const modal = document.getElementById('financingModal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
            document.getElementById('financingForm').reset();
        }
        
        function updateFinancingDefaults() {
            const type = document.getElementById('financingType').value;
            const amountInput = document.getElementById('financingAmount');
            const termInput = document.getElementById('financingTerm');
            const rateInput = document.getElementById('financingRate');
            const purposeInput = document.getElementById('financingPurpose');
            
            // Set defaults based on financing type
            switch(type) {
                case 'loan':
                    amountInput.value = '100000000'; // 100M IDR
                    termInput.value = '24';
                    rateInput.value = '8.5';
                    purposeInput.value = 'Working capital expansion';
                    break;
                case 'credit_line':
                    amountInput.value = '50000000'; // 50M IDR
                    termInput.value = '12';
                    rateInput.value = '12.0';
                    purposeInput.value = 'Short-term liquidity';
                    break;
                case 'invoice_factoring':
                    amountInput.value = '25000000'; // 25M IDR
                    termInput.value = '3';
                    rateInput.value = '15.0';
                    purposeInput.value = 'Accelerate receivables';
                    break;
                case 'equity':
                    amountInput.value = '200000000'; // 200M IDR
                    termInput.value = '0';
                    rateInput.value = '0';
                    purposeInput.value = 'Growth capital';
                    break;
            }
        }

        function getFinancingTypeName(type) {
            const names = {
                'loan': 'Bank Loan',
                'credit_line': 'Credit Line',
                'invoice_factoring': 'Invoice Factoring',
                'equity': 'Equity Injection'
            };
            return names[type] || 'Financing';
        }
        
        function getFinancingIcon(type) {
            const icons = {
                'loan': '<i class="fas fa-building-columns"></i>',
                'credit_line': '<i class="fas fa-credit-card"></i>',
                'invoice_factoring': '<i class="fas fa-file-invoice-dollar"></i>',
                'equity': '<i class="fas fa-chart-pie"></i>'
            };
            return icons[type] || '<i class="fas fa-dollar-sign"></i>';
        }
        
        // Handle form submission
        document.addEventListener('DOMContentLoaded', function() {
            const financingForm = document.getElementById('financingForm');
            if (financingForm) {
                financingForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    addParkedFinancing();
                });
            }
        });
        
        function addParkedFinancing() {
            const financing = {
                id: 'financing_' + Date.now(),
                type: document.getElementById('financingType').value,
                amount: parseInt(document.getElementById('financingAmount').value),
                availableDate: document.getElementById('financingAvailableDate').value
            };
        
            // Create a transaction card for this financing event. It starts as "parked".
            const financingTransaction = {
                id: financing.id,
                type: 'AR', // All financing is treated as an inflow (AR)
                vendor: `${getFinancingTypeName(financing.type)}`,
                amount: financing.amount,
                description: `Financing injection of Rp ${financing.amount.toLocaleString()}`,
                originalWeek: 'parked',
                currentWeek: 'parked',
                isFinancing: true // Custom flag to identify these items
            };
        
            scenarioData.push(financingTransaction);
            populateTransactionBuckets(); // Re-render buckets to show the new card
            calculateScenarioImpact();    // <-- FIX: This call updates the Projected Impact card.
            closeFinancingModal();
        }

        function createFinancingCard(transaction) {
            const card = document.createElement('div');
            card.className = 'bucket-transaction-card ar-card';
            card.draggable = true;
            card.dataset.transactionId = transaction.id; // Changed from dataset.id
            card.dataset.financing = 'true';
            
            card.innerHTML = `
                <div class="bucket-card-header">
                    <div class="bucket-vendor-name">${transaction.vendor}</div>
                    <div class="bucket-amount">Rp ${formatAmount(transaction.amount)}</div>
                </div>
                <div class="bucket-description">${transaction.description}</div>
            `;
            
            // Add to parked bucket
            const parkedBucket = document.getElementById('bucket-week-parked');
            if (parkedBucket) {
                parkedBucket.appendChild(card);
            }
            
            return card;
        }
        function removeFinancingTransaction(id) {
            // Remove from scenario data
            if (typeof scenarioData !== 'undefined') {
                window.scenarioData = scenarioData.filter(item => item.id !== id);
            }
            
            // Remove from financing items
            scenarioFinancingItems = scenarioFinancingItems.filter(item => item.id !== id);
            
            // Remove card from DOM
            const card = document.querySelector(`[data-id="${id}"]`);
            if (card) {
                card.remove();
            }
            
            // Recalculate impact
            calculateScenarioImpact();
        }
        
        function renderParkedFinancingList() {
            const container = document.getElementById('parkedFinancingList');
            
            if (scenarioFinancingItems.length === 0) {
                container.innerHTML = `
                    <div class="no-scenarios">
                        <i class="fas fa-plus-circle"></i>
                        <p>No financing items parked yet</p>
                        <p class="text-muted">Add financing options above to park them for scenario planning</p>
                    </div>
                `;
                return;
            }
            
            const itemsHTML = scenarioFinancingItems.map(item => `
                <div class="parked-financing-item ${item.isActive ? 'active' : ''}">
                    <div class="financing-icon">
                        ${getFinancingIcon(item.type)}
                    </div>
                    <div class="financing-details">
                        <div class="financing-header">
                            <h6>${getFinancingTypeName(item.type)}</h6>
                            <span class="financing-amount">${formatCurrencyFull(item.amount, 'IDR')}</span>
                        </div>
                        <div class="financing-terms">
                            <span class="term-item">Term: ${item.term} months</span>
                            <span class="term-item">Rate: ${item.rate}%</span>
                            <span class="term-item">Available: ${new Date(item.availableDate).toLocaleDateString()}</span>
                        </div>
                        <div class="financing-purpose">${item.purpose}</div>
                    </div>
                    <div class="financing-actions">
                        <button class="action-btn ${item.isActive ? 'deactivate' : 'activate'}" 
                                onclick="toggleFinancingActive('${item.id}')" 
                                title="${item.isActive ? 'Remove from timeline' : 'Add to timeline'}">
                            <i class="fas fa-${item.isActive ? 'pause' : 'play'}"></i>
                        </button>
                        <button class="action-btn remove" onclick="removeParkedFinancing('${item.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = itemsHTML;
        }
        
        function toggleFinancingActive(id) {
            const item = scenarioFinancingItems.find(item => item.id === id);
            if (item) {
                item.isActive = !item.isActive;
                renderParkedFinancingList();
                calculateScenarioImpact();
            }
        }
        
        function removeParkedFinancing(id) {
            scenarioFinancingItems = scenarioFinancingItems.filter(item => item.id !== id);
            renderParkedFinancingList();
            calculateScenarioImpact();
        }
        
        function calculateScenarioImpact() {
            let totalCashIncrease = 0;
        
            // Find all financing items that have been moved out of the "parked" bucket.
            scenarioData.forEach(transaction => {
                if (transaction.isFinancing && transaction.currentWeek !== 'parked') {
                    totalCashIncrease += transaction.amount;
                }
            });
        
            // Calculate how many days of runway this new cash provides.
            const currentMonthlyBurn = getCurrentMonthlyBurn();
            const runwayExtensionDays = totalCashIncrease > 0 && currentMonthlyBurn > 0 
                ? Math.floor((totalCashIncrease / currentMonthlyBurn) * 30) 
                : 0;
        
            // Update the "Projected Impact" card in the UI.
            document.getElementById('cashImprovementAmount').textContent = `Rp ${totalCashIncrease.toLocaleString()}`;
            document.getElementById('runwayExtension').textContent = `+${runwayExtensionDays} days`;
        }
        
        function getCurrentMonthlyBurn() {
            if (!aparTransactions || aparTransactions.length === 0) return 10000000; // Default burn if no data
        
            const monthlyOutflows = aparTransactions
                .filter(t => t.type === 'AP' && (t.status === 'Unpaid' || t.status === 'Overdue'))
                .reduce((sum, t) => sum + Math.abs(t.amount), 0);
            
            // Assume AP data represents roughly one month of expenses for a simple burn rate.
            return monthlyOutflows > 0 ? monthlyOutflows : 10000000;
        }
        
        // Initialize
        function initializeScenarioFinancing() {
            renderParkedFinancingList();
            calculateScenarioImpact();
        }
        
        // Close panel when clicking outside
        document.addEventListener('click', function(e) {
            const chatContainer = document.getElementById('chatContainerRight');
            const chatTrigger = document.querySelector('.chat-trigger-floating');
            
            if (chatContainer.classList.contains('active') && 
                !chatContainer.contains(e.target) && 
                !chatTrigger.contains(e.target)) {
                
                // Use smooth close animation
                chatContainer.classList.add('closing');
                setTimeout(() => {
                    chatContainer.classList.remove('active', 'closing');
                }, 400);
            }
        });
        
        // Close panel with ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const chatContainer = document.getElementById('chatContainerRight');
                if (chatContainer.classList.contains('active')) {
                    chatContainer.classList.add('closing');
                    setTimeout(() => {
                        chatContainer.classList.remove('active', 'closing');
                    }, 400);
                }
            }
        });

        // AI Forecasting Functionality
        document.addEventListener('DOMContentLoaded', function() {
            initializeForecastingModule();

            setTimeout(() => {
                loadLatestForecastFromSupabase();
            }, 1000);
        });
        
        function initializeForecastingModule() {
            // Period tab switching
            document.querySelectorAll('.period-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchForecastPeriod(this.dataset.period);
                });
            });
        
            // Generate AI Forecast button
            document.getElementById('generateAIForecast').addEventListener('click', generateAIForecast);
        
            // Industry selector change
            document.getElementById('forecastIndustrySelect').addEventListener('change', function() {
                if (this.value) {
                    console.log(` Industry context selected: ${this.value}`);
                    console.log(`This context will be sent to AI agent for intelligent forecasting`);
                }
            });
        
            // Make forecast cells auto-calculate totals
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('forecast-cell')) {
                    updateForecastTotals(e.target);
                }
            });
        }
        
        function switchForecastPeriod(period) {
            // Clear ALL active states first
            document.querySelectorAll('.period-tab-btn, .period-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Add active to the correct tab
            document.querySelector(`[data-period="${period}"]`).classList.add('active');
        
            // Hide all containers first
            document.querySelectorAll('.pl-forecast-container').forEach(container => {
                container.style.display = 'none';
            });
            
            // Hide ALL insights and trending chart containers when switching tabs
            const aiInsightsContainer = document.getElementById('aiInsightsContainer');
            const forecastTrendingContainer = document.getElementById('forecastTrendingContainer');
            const ai2026InsightsContainer = document.getElementById('ai2026InsightsContainer');
            const forecast2026TrendingContainer = document.getElementById('forecast2026TrendingContainer');
            const multiYearTrendingSection = document.getElementById('multiYearTrendingSection');
            const aiMultiYearInsightsContainer = document.getElementById('aiMultiYearInsightsContainer');
            
            if (aiInsightsContainer) aiInsightsContainer.style.display = 'none';
            if (forecastTrendingContainer) forecastTrendingContainer.style.display = 'none';
            if (ai2026InsightsContainer) ai2026InsightsContainer.style.display = 'none';
            if (forecast2026TrendingContainer) forecast2026TrendingContainer.style.display = 'none';
            if (multiYearTrendingSection) multiYearTrendingSection.style.display = 'none';
            if (aiMultiYearInsightsContainer) aiMultiYearInsightsContainer.style.display = 'none';
        
            // Show the appropriate container
            const targetContainer = document.getElementById(`${period}-container`);
            if (targetContainer) {
                targetContainer.style.display = 'block';
                
                // Load content based on period
                if (period === 'next-year') {
                    // Show 2026 insights and trending if they exist
                    if (ai2026InsightsContainer) ai2026InsightsContainer.style.display = 'block';
                    if (forecast2026TrendingContainer) forecast2026TrendingContainer.style.display = 'block';
                } else if (period === 'current-year') {
                    // Show insights and chart only for current year tab
                    if (aiInsightsContainer) aiInsightsContainer.style.display = 'block';
                    if (forecastTrendingContainer) forecastTrendingContainer.style.display = 'block';
                } else if (period === 'multi-year') {
                    // Show multi-year insights and trending if they exist
                    if (multiYearTrendingSection) multiYearTrendingSection.style.display = 'block';
                    if (aiMultiYearInsightsContainer) aiMultiYearInsightsContainer.style.display = 'block';
                } else if (period === 'summary') {
                    // Populate Annual Summary table when summary tab is selected
                    setTimeout(() => {
                        populateAnnualSummaryTable();
                    }, 100);
                }
            }
        }
        
        // REAL AI FORECASTING FUNCTION - Simplified
        async function generateAIForecast() {
            console.log(' Starting REAL AI Forecast Generation...');
            
            const industry = document.getElementById('forecastIndustrySelect').value;
            const forecastStyle = document.getElementById('forecastStyleSelect').value;
            
            if (!industry) {
                alert('Please select an industry for AI context');
                return;
            }
        
            // Show loading state
            const button = document.getElementById('generateAIForecast');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating AI Forecast...';
            button.disabled = true;
        
            try {
                // FIRST: Get historical data from Supabase
                console.log(' Fetching historical data from Supabase...');
                
                const { data: historicalData, error } = await supabase
                    .from('financial_transactions_meridash')
                    .select('*')
                    .order('transaction_date', { ascending: true });
        
                if (error) {
                    throw error;
                }
        
                // Process historical data into monthly summaries
                const monthlyData = processHistoricalDataToMonthly(historicalData);
                
                // Get current date and calculate forecast period dynamically
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                const currentDay = now.getDate();
                
                const includeCurrentMonth = currentDay <= 25;
                const forecastStartMonth = includeCurrentMonth ? currentMonth : currentMonth + 1;
                const forecastEndMonth = 12;
                const totalForecastMonths = forecastEndMonth - forecastStartMonth + 1;
        
                console.log(' Forecast Period Calculation:', {
                    currentDate: `${currentYear}-${currentMonth}-${currentDay}`,
                    includeCurrentMonth,
                    forecastStartMonth,
                    forecastEndMonth,
                    totalForecastMonths,
                    historicalMonths: monthlyData.length
                });
        
                // Prepare the request payload with actual data
                const payload = {
                    historical_data: monthlyData,
                    industry: industry,
                    forecastStyle: forecastStyle,
                    forecast_months: totalForecastMonths,
                    forecast_start_month: forecastStartMonth,
                    forecast_year: currentYear,
                    include_current_month: includeCurrentMonth,
                    current_day: currentDay,
                    forecast_period: {
                        start_month: forecastStartMonth,
                        end_month: forecastEndMonth,
                        start_month_name: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][forecastStartMonth - 1],
                        end_month_name: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][forecastEndMonth - 1],
                        total_months: totalForecastMonths,
                        current_month: currentMonth,
                        current_year: currentYear,
                        current_day: currentDay,
                        include_current_month: includeCurrentMonth,
                        forecast_type: includeCurrentMonth ? "current_month_completion" : "future_months_only",
                        forecast_months: [] // We'll populate this
                    }
                };
        
                // Add forecast_months array with proper structure
                for (let i = forecastStartMonth; i <= forecastEndMonth; i++) {
                    payload.forecast_period.forecast_months.push({
                        month_number: i,
                        month_key: ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'][i - 1],
                        month_name: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][i - 1],
                        year: currentYear,
                        is_current_month: i === currentMonth,
                        is_partial_month: i === currentMonth && includeCurrentMonth
                    });
                }
        
                console.log(' Sending forecast request with historical data:', {
                    historicalDataPoints: monthlyData.length,
                    forecastPeriod: `${payload.forecast_period.start_month_name}-${payload.forecast_period.end_month_name}`,
                    industry,
                    forecastStyle
                });
        
                // Call the webhook
                const response = await fetch('https://n8n.srv909550.hstgr.cloud/webhook/ai-forecast', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
        
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
        
                const responseData = await response.json();
                console.log(' AI Forecast Result:', responseData);
                
                // Handle array response - extract first element if response is an array
                let result;
                if (Array.isArray(responseData)) {
                    console.log(' Response is array, extracting first element...');
                    result = responseData[0];
                } else {
                    result = responseData;
                }
                
                console.log(' Processed result:', result);
                
                // Process and display the results using the correct function names
                if (result && result.forecast_data) {
                    await applyAIForecastToTable(result.forecast_data, payload.forecast_period);
                    
                    // Show insights using the correct function name
                    if (result.insights) {
                        displayAIInsights(result); // Use the correct function name
                    }
                    
                    // Recalculate totals
                    recalculateEntirePL();
                    
                    // Generate trending chart
                    generateForecastTrendingChart();

                    await saveForecastToSupabase(result, payload.forecast_period);
                }
        
                // Show success notification
                showForecastLoadedNotification(new Date(), true);
        
            } catch (error) {
                console.error(' AI Forecast generation failed:', error);
                alert('Failed to generate AI forecast. Please try again.');
            } finally {
                // Reset button
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        function processHistoricalDataToMonthly(transactions) {
            const monthlyData = {};
            
            transactions.forEach(transaction => {
                const date = new Date(transaction.transaction_date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        month: monthKey,
                        year: date.getFullYear(),
                        month_number: date.getMonth() + 1,
                        revenue: 0,
                        cogs: 0,
                        opex: 0,
                        total_transactions: 0,
                        is_complete_month: true
                    };
                }
                
                const amount = parseFloat(transaction.amount) || 0;
                const accountCode = parseInt(transaction.account_code) || 0; // Convert to number
                
                // Categorize based on account code ranges
                if (accountCode >= 4000 && accountCode < 5000) {
                    // Revenue accounts (4000-4999)
                    // For revenue, we typically use credit amounts
                    const revenueAmount = parseFloat(transaction.credit_amount || transaction.Credit || 0);
                    monthlyData[monthKey].revenue += revenueAmount;
                } else if (accountCode >= 5000 && accountCode < 5200) {
                    // COGS accounts (5000-5199)
                    // For expenses, we typically use debit amounts
                    const cogsAmount = parseFloat(transaction.debit_amount || transaction.Debit || amount);
                    monthlyData[monthKey].cogs += cogsAmount;
                } else if (accountCode >= 5200) {
                    // OPEX accounts (5200+)
                    // For expenses, we typically use debit amounts
                    const opexAmount = parseFloat(transaction.debit_amount || transaction.Debit || amount);
                    monthlyData[monthKey].opex += opexAmount;
                }
                
                monthlyData[monthKey].total_transactions++;
            });
            
            // Convert to array and sort by date
            const monthlyArray = Object.values(monthlyData).sort((a, b) => {
                return new Date(a.month) - new Date(b.month);
            });
            
            console.log(' Processed historical data:', {
                totalMonths: monthlyArray.length,
                dateRange: monthlyArray.length > 0 ? 
                    `${monthlyArray[0].month} to ${monthlyArray[monthlyArray.length - 1].month}` : 'No data',
                sampleMonth: monthlyArray[0],
                totalRevenue: monthlyArray.reduce((sum, m) => sum + m.revenue, 0),
                totalCogs: monthlyArray.reduce((sum, m) => sum + m.cogs, 0),
                totalOpex: monthlyArray.reduce((sum, m) => sum + m.opex, 0)
            });
            
            return monthlyArray;
        }
        
        // Call the n8n AI forecast API
        async function callAIForecastAPI(payload) {
            const N8N_WEBHOOK_URL = 'https://n8n.srv909550.hstgr.cloud/webhook/ai-forecast';
            
            console.log(' Calling n8n with payload:', payload);
            
            const response = await fetch(N8N_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
        
            return await response.json();
        }

        // Get dynamic forecast period based on current date and whether to include current month
        function getForecastPeriodDetails(currentYear, currentMonth, currentDay, includeCurrentMonth) {
            const monthNames = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            const monthNamesDisplay = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            const startMonth = includeCurrentMonth ? currentMonth : currentMonth + 1;
            const endMonth = 12; // December
            
            // Get array of months to forecast
            const forecastMonths = [];
            for (let i = startMonth; i <= endMonth; i++) {
                const isCurrentMonth = (i === currentMonth && includeCurrentMonth);
                
                forecastMonths.push({
                    month_number: i,
                    month_key: monthNames[i - 1],
                    month_name: monthNamesDisplay[i - 1],
                    year: currentYear,
                    is_current_month: isCurrentMonth,
                    is_partial_month: isCurrentMonth,
                    days_remaining: isCurrentMonth ? getDaysRemainingInMonth(currentYear, currentMonth, currentDay) : null,
                    completion_percentage: isCurrentMonth ? (currentDay / getDaysInMonth(currentYear, currentMonth)) * 100 : null
                });
            }
            
            return {
                start_month: startMonth,
                end_month: endMonth,
                start_month_name: monthNamesDisplay[startMonth - 1],
                end_month_name: monthNamesDisplay[endMonth - 1],
                forecast_months: forecastMonths,
                total_months: endMonth - startMonth + 1,
                current_month: currentMonth,
                current_year: currentYear,
                current_day: currentDay,
                include_current_month: includeCurrentMonth,
                forecast_type: includeCurrentMonth ? 'current_month_completion' : 'future_months_only'
            };
        }

        // Prepare historical data for AI analysis (excluding current partial month)
        async function prepareHistoricalDataForAI() {
            try {
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                
                // Get historical data excluding current partial month
                const endDate = `${currentYear}-${String(currentMonth).padStart(2, '0')}-01`;
                
                // Get last 12-18 months of complete financial data
                const { data: transactions, error } = await supabase
                    .from('financial_transactions_meridash')
                    .select('*')
                    .gte('transaction_date', '2023-01-01')
                    .lt('transaction_date', endDate)
                    .order('transaction_date');
        
                if (error) throw error;
        
                // Group by month and account category
                const monthlyData = {};
                
                transactions.forEach(transaction => {
                    const date = new Date(transaction.transaction_date);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            month: monthKey,
                            year: date.getFullYear(),
                            month_number: date.getMonth() + 1,
                            revenue: 0,
                            cogs: 0,
                            opex: 0,
                            total_transactions: 0,
                            is_complete_month: true
                        };
                    }
        
                    const accountCode = transaction.account_code;
                    const debit = parseFloat(transaction.debit_amount || 0);
                    const credit = parseFloat(transaction.credit_amount || 0);
        
                    // Categorize transactions
                    if (accountCode >= 4000 && accountCode < 5000) {
                        monthlyData[monthKey].revenue += (credit - debit);
                    } else if (accountCode >= 5000 && accountCode < 5100) {
                        monthlyData[monthKey].cogs += (debit - credit);
                    } else if (accountCode >= 5100 && accountCode < 6000) {
                        monthlyData[monthKey].opex += (debit - credit);
                    }
                    
                    monthlyData[monthKey].total_transactions++;
                });
        
                // Convert to array, sort, and get last 12 complete months
                const historicalArray = Object.values(monthlyData)
                    .sort((a, b) => a.month.localeCompare(b.month))
                    .slice(-12); // Get last 12 complete months
                
                console.log('Historical data prepared for AI (complete months only):', historicalArray);
                return historicalArray;
                
            } catch (error) {
                console.error('Error preparing historical data:', error);
                return [];
            }
        }

        // Helper function to update individual forecast cells - with return value
        function updateForecastCell(accountCode, month, amount) {
            const row = document.querySelector(`tr[data-account-code="${accountCode}"]`);
            if (row) {
                const cell = row.querySelector(`.pl-forecast-cell[data-month="${month}"]`);
                if (cell) {
                    cell.textContent = Math.round(amount).toLocaleString();
                    console.log(` Updated ${accountCode} ${month}: ${Math.round(amount).toLocaleString()}`);
                    return true;
                } else {
                    console.log(` Cell not found: ${accountCode} ${month}`);
                    return false;
                }
            } else {
                console.log(` Row not found for account: ${accountCode}`);
                return false;
            }
        }
        
        // Helper function to get days remaining in current month
        function getDaysRemainingInMonth(year, month, currentDay) {
            const daysInMonth = getDaysInMonth(year, month);
            return daysInMonth - currentDay;
        }

        // Helper function to get account name
        function getAccountName(accountCode) {
            const account = window.glAccountsData?.find(acc => acc.account_code == accountCode);
            return account ? account.account_name : `Account ${accountCode}`;
        }
        
        // Helper function to get total days in a month
        function getDaysInMonth(year, month) {
            return new Date(year, month, 0).getDate();
        }

        // Apply AI forecast data to the P&L table - Updated with better error handling
        async function applyAIForecastToTable(forecastData, forecastPeriod) {
            console.log(' Applying forecast to table...', forecastData);
            
            if (!forecastData || !forecastData.monthly_forecasts) {
                console.error('Invalid forecast data structure');
                return;
            }
        
            let updatedCells = 0;
            let failedUpdates = 0;
        
            // Apply forecasts to each month in the forecast period
            forecastData.monthly_forecasts.forEach((monthData, index) => {
                if (index < forecastPeriod.forecast_months.length) {
                    const monthInfo = forecastPeriod.forecast_months[index];
                    const monthKey = monthInfo.month_key; // jul, aug, sep, etc.
                    
                    console.log(`Applying forecast for ${monthInfo.month_name} (${monthKey})`);
                    
                    // Apply revenue forecasts
                    if (monthData.revenue_accounts) {
                        Object.entries(monthData.revenue_accounts).forEach(([accountCode, amount]) => {
                            if (amount > 0) {
                                const success = updateForecastCell(accountCode, monthKey, amount);
                                if (success !== false) updatedCells++;
                                else failedUpdates++;
                            }
                        });
                    }
                    
                    // Apply COGS forecasts
                    if (monthData.cogs_accounts) {
                        Object.entries(monthData.cogs_accounts).forEach(([accountCode, amount]) => {
                            if (amount > 0) {
                                const success = updateForecastCell(accountCode, monthKey, amount);
                                if (success !== false) updatedCells++;
                                else failedUpdates++;
                            }
                        });
                    }
                    
                    // Apply OPEX forecasts
                    if (monthData.opex_accounts) {
                        Object.entries(monthData.opex_accounts).forEach(([accountCode, amount]) => {
                            if (amount > 0) {
                                const success = updateForecastCell(accountCode, monthKey, amount);
                                if (success !== false) updatedCells++;
                                else failedUpdates++;
                            }
                        });
                    }
                }
            });
            
            console.log(` Applied forecasts: ${updatedCells} cells updated, ${failedUpdates} failed`);
            
            if (failedUpdates > 0) {
                console.warn(` Some forecast cells could not be updated. This might mean those account codes don't exist in your P&L table.`);
            }
            // Show and generate trending chart
            document.getElementById('forecastTrendingContainer').style.display = 'block';
            generateForecastTrendingChart();
        }
        
        // Save forecast to Supabase with dynamic period
        async function saveForecastToSupabase(aiResponse, forecastPeriod) {
            try {
                console.log(' Saving AI forecast to Supabase...');
                
                const user = await supabase.auth.getUser();
                const userId = user?.data?.user?.id;
                
                if (!userId) {
                    console.log('No user found, skipping save');
                    return;
                }
                
                // Extract data from AI response
                const forecastData = aiResponse.forecast_data;
                const confidence = aiResponse.confidence;
                const insights = aiResponse.insights;
                const methodology = aiResponse.methodology;
                const generatedAt = aiResponse.generated_at;
                
                // Calculate period dates
                const startDate = `${forecastPeriod.current_year}-${String(forecastPeriod.start_month).padStart(2, '0')}-01`;
                const endDate = `${forecastPeriod.current_year}-12-31`;
                
                // Save forecast metadata to ai_forecasts_meridash
                const { data: forecastRecord, error: forecastError } = await supabase
                    .from('ai_forecasts_meridash')
                    .insert([{
                        user_id: userId,
                        forecast_date: generatedAt || new Date().toISOString(),
                        forecast_period_start: startDate,
                        forecast_period_end: endDate,
                        model_version: aiResponse.model_version || 'ai-agent-v1',
                        confidence_score: confidence,
                        industry_context: document.getElementById('forecastIndustrySelect').value,
                        forecast_data: {
                            forecast_data: forecastData,
                            insights: insights,
                            methodology: methodology,
                            period_info: forecastPeriod
                        }
                    }])
                    .select();
                    
                if (forecastError) {
                    console.error('Error saving forecast metadata:', forecastError);
                    throw forecastError;
                }

                trackLatestForecastId(forecastRecord[0].id, 'ai_forecasts_meridash');
                
                console.log(' Forecast metadata saved to Supabase');
                
                // Optionally save individual forecast transactions
                await saveForecastTransactions(forecastData, forecastPeriod, userId, forecastRecord[0].id);
                
                return forecastRecord[0];
                
            } catch (error) {
                console.error('Error saving forecast to Supabase:', error);
                // Don't throw - this shouldn't break the forecast display
                return null;
            }
        }

        // Save individual forecast transactions
        async function saveForecastTransactions(forecastData, forecastPeriod, userId, forecastId) {
            try {
                console.log(' Saving forecast transactions...');
                
                const transactions = [];
                
                // Generate transactions for each forecasted month
                forecastData.monthly_forecasts.forEach((monthData, index) => {
                    if (index < forecastPeriod.forecast_months.length) {
                        const monthInfo = forecastPeriod.forecast_months[index];
                        const transactionDate = `${monthInfo.year}-${String(monthInfo.month_number).padStart(2, '0')}-15`;
                        
                        // Revenue transactions
                        Object.entries(monthData.revenue_accounts).forEach(([accountCode, amount]) => {
                            if (amount > 0) {
                                transactions.push({
                                    user_id: userId,
                                    transaction_date: transactionDate,
                                    account_code: parseInt(accountCode),
                                    account_name: getAccountName(accountCode),
                                    description: `AI Forecast - ${monthInfo.month_name} ${monthInfo.year}`,
                                    debit_amount: 0,
                                    credit_amount: amount,
                                    source: 'AI_Forecast',
                                    category: 'Revenue',
                                    forecast_id: forecastId,
                                    notes: `Generated by AI agent on ${new Date().toISOString()}`
                                });
                            }
                        });
                        
                        // COGS transactions
                        Object.entries(monthData.cogs_accounts).forEach(([accountCode, amount]) => {
                            if (amount > 0) {
                                transactions.push({
                                    user_id: userId,
                                    transaction_date: transactionDate,
                                    account_code: parseInt(accountCode),
                                    account_name: getAccountName(accountCode),
                                    description: `AI Forecast - ${monthInfo.month_name} ${monthInfo.year}`,
                                    debit_amount: amount,
                                    credit_amount: 0,
                                    source: 'AI_Forecast',
                                    category: 'Expense',
                                    forecast_id: forecastId,
                                    notes: `Generated by AI agent on ${new Date().toISOString()}`
                                });
                            }
                        });
                        
                        // OPEX transactions
                        Object.entries(monthData.opex_accounts).forEach(([accountCode, amount]) => {
                            if (amount > 0) {
                                transactions.push({
                                    user_id: userId,
                                    transaction_date: transactionDate,
                                    account_code: parseInt(accountCode),
                                    account_name: getAccountName(accountCode),
                                    description: `AI Forecast - ${monthInfo.month_name} ${monthInfo.year}`,
                                    debit_amount: amount,
                                    credit_amount: 0,
                                    source: 'AI_Forecast',
                                    category: 'Expense',
                                    forecast_id: forecastId,
                                    notes: `Generated by AI agent on ${new Date().toISOString()}`
                                });
                            }
                        });
                    }
                });
                
                // Insert forecast transactions in batches
                if (transactions.length > 0) {
                    const { error: transactionError } = await supabase
                        .from('financial_transactions_meridash')
                        .insert(transactions);
                        
                    if (transactionError) {
                        console.error('Error saving forecast transactions:', transactionError);
                    } else {
                        console.log(` Saved ${transactions.length} forecast transactions`);
                    }
                }
                
            } catch (error) {
                console.error('Error saving forecast transactions:', error);
            }
        }
        
        function completeAIForecast(industry) {
            // Hide status panel
            document.getElementById('aiStatusPanel').style.display = 'none';
        
            // Show market context
            const marketContext = document.getElementById('marketContext');
            marketContext.style.display = 'block';
            updateMarketContext(industry);
        
            // Populate additional forecast tables (2026, multi-year, summary)
            populate2026Forecast();
            populateMultiYearForecast();
            populateAnnualSummary();
        
            // Show AI insights
            const aiInsights = document.getElementById('aiInsightsSummary');
            aiInsights.style.display = 'block';
            populateAIInsights(industry);
        
            // Update confidence levels (simulate AI confidence)
            updateConfidenceLevels();
        }

        // Function to display AI insights
        function displayAIInsights(forecastResponse) {
            const insightsContainer = document.getElementById('aiInsightsContainer');
            const insights = forecastResponse.insights;
            
            if (!insightsContainer || !insights) {
                console.log('Insights container or data not found');
                return;
            }
            
            // Update confidence badge
            const confidenceBadge = document.getElementById('confidenceBadge');
            if (confidenceBadge) {
                confidenceBadge.textContent = `Confidence: ${forecastResponse.confidence}%`;
                
                // Color code confidence level
                if (forecastResponse.confidence >= 80) {
                    confidenceBadge.style.background = 'rgba(34, 197, 94, 0.2)';
                    confidenceBadge.style.color = '#22c55e';
                    confidenceBadge.style.borderColor = 'rgba(34, 197, 94, 0.3)';
                } else if (forecastResponse.confidence >= 60) {
                    confidenceBadge.style.background = 'rgba(245, 158, 11, 0.2)';
                    confidenceBadge.style.color = '#f59e0b';
                    confidenceBadge.style.borderColor = 'rgba(245, 158, 11, 0.3)';
                } else {
                    confidenceBadge.style.background = 'rgba(239, 68, 68, 0.2)';
                    confidenceBadge.style.color = '#ef4444';
                    confidenceBadge.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                }
            }
            
            // Update forecast date
            const forecastDate = document.getElementById('forecastDate');
            if (forecastDate) {
                const date = new Date(forecastResponse.generated_at || new Date()).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                forecastDate.textContent = `Generated: ${date}`;
            }
            
            // Update insight texts with formatting support
            document.getElementById('keyTrendsText').innerHTML = formatInsightText(insights.key_trends || 'No trends analysis available.');
            document.getElementById('riskFactorsText').innerHTML = formatInsightText(insights.risk_factors || 'No risk factors identified.');
            document.getElementById('opportunitiesText').innerHTML = formatInsightText(insights.opportunities || 'No opportunities identified.');
            document.getElementById('methodologyText').innerHTML = formatInsightText(forecastResponse.methodology || 'AI-based analysis methodology.');
            
            // Show insights container
            insightsContainer.style.display = 'block';
            
            console.log(' AI insights displayed with formatting');
        }
        
        // Function to hide insights
        function hideInsights() {
            const insightsContainer = document.getElementById('aiInsightsContainer');
            if (insightsContainer) {
                insightsContainer.style.display = 'none';
            }
        }
        
        function populate2026Forecast() {
            const tbody = document.getElementById('forecast2026Body');
            tbody.innerHTML = `
                <tr class="section-header-row">
                    <td colspan="14" class="section-header">
                        <i class="fas fa-chart-line"></i> Revenue
                    </td>
                </tr>
                <tr class="editable-row">
                    <td class="line-item">Total Revenue</td>
                    <td class="forecast-cell" contenteditable="true">310,000,000</td>
                    <td class="forecast-cell" contenteditable="true">315,000,000</td>
                    <td class="forecast-cell" contenteditable="true">320,000,000</td>
                    <td class="forecast-cell" contenteditable="true">325,000,000</td>
                    <td class="forecast-cell" contenteditable="true">330,000,000</td>
                    <td class="forecast-cell" contenteditable="true">335,000,000</td>
                    <td class="forecast-cell" contenteditable="true">340,000,000</td>
                    <td class="forecast-cell" contenteditable="true">345,000,000</td>
                    <td class="forecast-cell" contenteditable="true">350,000,000</td>
                    <td class="forecast-cell" contenteditable="true">355,000,000</td>
                    <td class="forecast-cell" contenteditable="true">360,000,000</td>
                    <td class="forecast-cell" contenteditable="true">365,000,000</td>
                    <td class="total-cell">4,050,000,000</td>
                </tr>
                <!-- Add more rows for expenses, etc. -->
            `;
        }
        
        function populateMultiYearForecast() {
            const tbody = document.getElementById('forecastMultiyearBody');
            tbody.innerHTML = `
                <tr class="section-header-row">
                    <td colspan="11" class="section-header">
                        <i class="fas fa-chart-line"></i> Revenue
                    </td>
                </tr>
                <tr class="editable-row">
                    <td class="line-item">Total Revenue</td>
                    <td class="forecast-cell" contenteditable="true">1,100,000,000</td>
                    <td class="forecast-cell" contenteditable="true">1,150,000,000</td>
                    <td class="forecast-cell" contenteditable="true">1,200,000,000</td>
                    <td class="forecast-cell" contenteditable="true">1,250,000,000</td>
                    <td class="total-cell">4,700,000,000</td>
                    <td class="forecast-cell" contenteditable="true">1,300,000,000</td>
                    <td class="forecast-cell" contenteditable="true">1,350,000,000</td>
                    <td class="forecast-cell" contenteditable="true">1,400,000,000</td>
                    <td class="forecast-cell" contenteditable="true">1,450,000,000</td>
                    <td class="total-cell">5,500,000,000</td>
                </tr>
            `;
        }
        
        function populateAnnualSummary() {
            const tbody = document.getElementById('forecastSummaryBody');
            tbody.innerHTML = `
                <tr>
                    <td class="line-item">Total Revenue</td>
                    <td class="forecast-cell">3,575,000,000</td>
                    <td class="forecast-cell">4,050,000,000</td>
                    <td class="change-positive">+13.3% (+475M)</td>
                    <td class="forecast-cell">4,700,000,000</td>
                    <td class="change-positive">+16.0% (+650M)</td>
                    <td class="forecast-cell">5,500,000,000</td>
                    <td class="change-positive">+17.0% (+800M)</td>
                    <td class="forecast-cell">6,400,000,000</td>
                    <td class="change-positive">+16.4% (+900M)</td>
                    <td class="forecast-cell">7,500,000,000</td>
                    <td class="change-positive">+17.2% (+1.1B)</td>
                    <td class="total-cell">15.9%</td>
                </tr>
                <tr>
                    <td class="line-item">Net Income</td>
                    <td class="net-income-cell">411,250,000</td>
                    <td class="net-income-cell">526,500,000</td>
                    <td class="change-positive">+28.0% (+115M)</td>
                    <td class="net-income-cell">705,000,000</td>
                    <td class="change-positive">+33.9% (+179M)</td>
                    <td class="net-income-cell">935,000,000</td>
                    <td class="change-positive">+32.6% (+230M)</td>
                    <td class="net-income-cell">1,216,000,000</td>
                    <td class="change-positive">+30.1% (+281M)</td>
                    <td class="net-income-cell">1,575,000,000</td>
                    <td class="change-positive">+29.5% (+359M)</td>
                    <td class="total-cell">30.8%</td>
                </tr>
                <tr>
                    <td class="line-item">Net Margin</td>
                    <td class="margin-cell">11.5%</td>
                    <td class="margin-cell">13.0%</td>
                    <td class="change-positive">+1.5pp</td>
                    <td class="margin-cell">15.0%</td>
                    <td class="change-positive">+2.0pp</td>
                    <td class="margin-cell">17.0%</td>
                    <td class="change-positive">+2.0pp</td>
                    <td class="margin-cell">19.0%</td>
                    <td class="change-positive">+2.0pp</td>
                    <td class="margin-cell">21.0%</td>
                    <td class="change-positive">+2.0pp</td>
                    <td class="total-cell">12.7%</td>
                </tr>
            `;
        }
        
        function populateAIInsights(industry) {
            const insightsContent = document.getElementById('insightsContent');
            
            insightsContent.innerHTML = `
                <div class="insight-item">
                    <div class="insight-title">Revenue Growth Pattern</div>
                    <div class="insight-content">AI detects consistent 15% monthly growth trend. Market conditions support continued expansion through 2026.</div>
                </div>
                <div class="insight-item">
                    <div class="insight-title">Operating Leverage</div>
                    <div class="insight-content">Strong operational leverage detected. Every 1% revenue increase yields 2.2% net income growth.</div>
                </div>
                <div class="insight-item">
                    <div class="insight-title">Industry Benchmark</div>
                    <div class="insight-content">Your projected margins exceed industry average by 3-5pp. Consider scaling investments for market capture.</div>
                </div>
                <div class="insight-item">
                    <div class="insight-title">Risk Factors</div>
                    <div class="insight-content">Market saturation risk in 2028-2029. Diversification strategy recommended for sustained growth.</div>
                </div>
            `;
        }
        
        function updateConfidenceLevels() {
            // Simulate varying confidence levels based on forecast horizon
            const confidenceBars = document.querySelectorAll('.confidence-fill');
            confidenceBars.forEach((bar, index) => {
                const confidence = Math.max(50, 90 - (index * 2)); // Decreasing confidence over time
                bar.style.width = confidence + '%';
                
                const text = bar.parentElement.nextElementSibling;
                if (text && text.classList.contains('confidence-text')) {
                    text.textContent = confidence + '%';
                }
            });
        }
        
        function updateForecastTotals(changedCell) {
            const row = changedCell.closest('tr');
            const cells = row.querySelectorAll('.forecast-cell');
            const totalCell = row.querySelector('.total-cell');
            
            if (totalCell) {
                let total = 0;
                cells.forEach(cell => {
                    const value = parseFloat(cell.textContent.replace(/,/g, '')) || 0;
                    total += value;
                });
                totalCell.textContent = total.toLocaleString();
            }
        }
        
        function exportForecastTable(period) {
            // Placeholder for export functionality
            alert(`Export ${period} forecast table - Integration with your export system needed`);
        }

        // P&L Forecasting Functions - All Unique Names
        function initializePLForecasting() {
            // Initialize period tabs
            initializePeriodTabs();
            
            // Generate AI Forecast button
            const generateBtn = document.getElementById('generateAIForecast');
            if (generateBtn) {
                generateBtn.addEventListener('click', generateAIForecast);
            }
        
            // Industry selector change
            const industrySelect = document.getElementById('forecastIndustrySelect');
            if (industrySelect) {
                industrySelect.addEventListener('change', function() {
                    if (this.value) {
                        updatePLMarketContext(this.value);
                    }
                });
            }
        
            // Make forecast cells auto-calculate when edited
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('pl-forecast-cell')) {
                    recalculateEntirePL();
                }
            });
        
            // Format numbers on blur
            document.addEventListener('blur', function(e) {
                if (e.target.classList.contains('pl-forecast-cell')) {
                    formatPLCellValue(e.target);
                }
            }, true);
        
            // CRITICAL: Load GL accounts and build structure IMMEDIATELY
            buildTableStructureFromSupabase();
        }

        async function buildTableStructureFromSupabase() {
            console.log('Building P&L table structure from Supabase...');
            
            if (typeof supabase === 'undefined') {
                console.error('Supabase not available');
                return;
            }
            
            try {
                // Load GL accounts FIRST
                const { data: glAccounts, error: glError } = await supabase
                    .from('gl_accounts_meridash')
                    .select('*')
                    .eq('is_active', true)
                    .order('account_code');
                    
                if (glError) {
                    console.error('Error loading GL accounts:', glError);
                    return;
                }
                
                console.log('GL Accounts loaded:', glAccounts);
                
                // Build the proper P&L structure
                buildPLStructureFromGLAccounts(glAccounts);
                
                // THEN load actual transaction data with dynamic dates
                const dateContext = getDateContext();
                const { actualEndMonth, currentYear } = dateContext;
                const actualEndDate = `${currentYear}-${String(actualEndMonth + 1).padStart(2, '0')}-01`;
                
                const { data: actualTransactions, error: txError } = await supabase
                    .from('financial_transactions_meridash')
                    .select('*')
                    .gte('transaction_date', `${currentYear}-01-01`)
                    .lt('transaction_date', actualEndDate);
                    
                if (txError) {
                    console.error('Error loading transactions:', txError);
                } else {
                    console.log('Actual transactions loaded:', actualTransactions);
                    populatePLWithActualData(actualTransactions);
                }
                
            } catch (error) {
                console.error('Error in buildTableStructureFromSupabase:', error);
            }
        }
        
        function loadPLActualDataFromSupabase() {
            console.log('Loading actual Jan-Jun 2025 data from Supabase...');
            
            if (typeof supabase !== 'undefined') {
                // First, load GL accounts structure
                loadGLAccountsStructure().then(() => {
                    // Then load actual transaction data
                    loadActualTransactionData();
                });
            } else {
                console.error('Supabase not available');
            }
        }

        async function loadGLAccountsStructure() {
            try {
                const { data: glAccounts, error } = await supabase
                    .from('gl_accounts_meridash')
                    .select('*')
                    .eq('is_active', true)
                    .order('account_code');
                    
                if (error) {
                    console.error('Error loading GL accounts:', error);
                    return;
                }
                
                console.log('Loaded GL accounts:', glAccounts);
                
                // Store GL accounts for later use
                window.glAccountsData = glAccounts;
                
                // BUILD TABLE STRUCTURE IMMEDIATELY (this was missing!)
                buildPLStructureFromGLAccounts(glAccounts);
                
            } catch (error) {
                console.error('Error loading GL accounts:', error);
            }
        }

        async function loadActualTransactionData() {
            try {
                // Get dynamic date context to determine actual period
                const dateContext = getDateContext();
                const { actualEndMonth, currentYear } = dateContext;
                
                // Calculate end date for actuals (include completed months)
                const actualEndDate = `${currentYear}-${String(actualEndMonth + 1).padStart(2, '0')}-01`;
                
                console.log(`Loading actual transaction data from ${currentYear}-01-01 to ${actualEndDate}`);
                
                const { data: transactions, error } = await supabase
                    .from('financial_transactions_meridash')
                    .select('*')
                    .gte('transaction_date', `${currentYear}-01-01`)
                    .lt('transaction_date', actualEndDate); // Now includes July
                    
                if (error) {
                    console.error('Error loading actual data:', error);
                    return;
                }
                
                console.log(`Loaded ${transactions.length} transactions for actual period:`, transactions);
                
                // Process transactions and populate P&L
                populatePLWithActualData(transactions);
                
            } catch (error) {
                console.error('Error loading transaction data:', error);
            }
        }

        function buildPLStructureFromGLAccounts(glAccounts) {
            console.log(' Building P&L structure from GL accounts...');
            
            // CORRECTED: Categorize accounts based on broader COGS range
            const accountCategories = {
                revenue: glAccounts.filter(acc => acc.account_code >= 4000 && acc.account_code < 5000),
                cogs: glAccounts.filter(acc => 
                    acc.account_code >= 5000 && acc.account_code < 5100  // Changed to broader range
                ),
                opex: glAccounts.filter(acc => 
                    acc.account_code >= 5100 && acc.account_code < 6000  // Changed to start from 5100
                )
            };
            
            console.log(' Account categories:', {
                revenue: accountCategories.revenue.length,
                cogs: accountCategories.cogs.length,
                opex: accountCategories.opex.length
            });
            
            console.log(' COGS accounts:', accountCategories.cogs.map(acc => `${acc.account_code}: ${acc.account_name}`));
            console.log(' OPEX accounts:', accountCategories.opex.map(acc => `${acc.account_code}: ${acc.account_name}`));
            
            // Rebuild the P&L table structure dynamically
            rebuildPLTableStructure(accountCategories);
        }

        function rebuildPLTableStructure(accountCategories) {
            const tbody = document.getElementById('plForecastBody');
            if (!tbody) return;
            
            // Get dynamic date context
            const dateContext = getDateContext();
            const { actualEndMonth, monthNames, currentYear } = dateContext;
            
            let htmlContent = '';
            
            // REVENUE SECTION
            htmlContent += `
                <tr class="pl-section-header-row">
                    <td colspan="15" class="pl-section-header">
                        <i class="fas fa-chart-line"></i> REVENUE
                    </td>
                </tr>
            `;
            
            accountCategories.revenue.forEach(account => {
                htmlContent += `
                    <tr class="pl-data-row pl-revenue-row" data-account-code="${account.account_code}">
                        <td class="pl-line-item">${account.account_name}</td>`;
                
                // Generate dynamic month cells
                for (let month = 1; month <= 12; month++) {
                    const monthKey = monthNames[month - 1].toLowerCase();
                    const isActual = month <= actualEndMonth;
                    const cellClass = isActual ? 'pl-actual-cell' : 'pl-forecast-cell';
                    const editableAttr = isActual ? '' : 'contenteditable="true"';
                    
                    htmlContent += `<td class="${cellClass}" ${editableAttr} data-month="${monthKey}">0</td>`;
                }
                
                htmlContent += `
                        <td class="pl-total-cell" id="${account.account_code}-total">0</td>
                        <td class="pl-percentage-cell" id="${account.account_code}-pct">0.0%</td>
                    </tr>
                `;
            });
            
            // Revenue Total Row
            htmlContent += `
                <tr class="pl-total-row pl-revenue-total">
                    <td class="pl-line-item pl-total-line">Total Revenue</td>`;
            
            // Generate dynamic total cells
            for (let month = 1; month <= 12; month++) {
                htmlContent += `<td class="pl-calculated-cell">0</td>`;
            }
            
            htmlContent += `
                    <td class="pl-total-cell pl-total-prominent" id="totalRevenue-total">0</td>
                    <td class="pl-percentage-cell">100.0%</td>
                </tr>
            `;
            
            // COGS SECTION
            if (accountCategories.cogs.length > 0) {
                htmlContent += `
                    <tr class="pl-section-header-row">
                        <td colspan="15" class="pl-section-header">
                            <i class="fas fa-box"></i> COST OF GOODS SOLD
                        </td>
                    </tr>
                `;
                
                accountCategories.cogs.forEach(account => {
                    htmlContent += `
                        <tr class="pl-data-row pl-cogs-row" data-account-code="${account.account_code}">
                            <td class="pl-line-item">${account.account_name}</td>`;
                    
                    // Generate dynamic month cells
                    for (let month = 1; month <= 12; month++) {
                        const monthKey = monthNames[month - 1].toLowerCase();
                        const isActual = month <= actualEndMonth;
                        const cellClass = isActual ? 'pl-actual-cell' : 'pl-forecast-cell';
                        const editableAttr = isActual ? '' : 'contenteditable="true"';
                        
                        htmlContent += `<td class="${cellClass}" ${editableAttr} data-month="${monthKey}">0</td>`;
                    }
                    
                    htmlContent += `
                            <td class="pl-total-cell" id="${account.account_code}-total">0</td>
                            <td class="pl-percentage-cell" id="${account.account_code}-pct">0.0%</td>
                        </tr>
                    `;
                });
                
                // COGS Total Row
                htmlContent += `
                    <tr class="pl-total-row pl-cogs-total">
                        <td class="pl-line-item pl-total-line">Total COGS</td>`;
                
                // Generate dynamic total cells
                for (let month = 1; month <= 12; month++) {
                    htmlContent += `<td class="pl-calculated-cell">0</td>`;
                }
                
                htmlContent += `
                        <td class="pl-total-cell pl-total-prominent" id="totalCOGS-total">0</td>
                        <td class="pl-percentage-cell" id="totalCOGS-pct">0.0%</td>
                    </tr>
                `;
                
                // Gross Profit Row
                htmlContent += `
                    <tr class="pl-calculated-row pl-gross-profit">
                        <td class="pl-line-item pl-calculated-line">Gross Profit</td>`;
                
                // Generate dynamic gross profit cells
                for (let month = 1; month <= 12; month++) {
                    htmlContent += `<td class="pl-gross-cell">0</td>`;
                }
                
                htmlContent += `
                        <td class="pl-gross-cell pl-gross-prominent" id="grossProfit-total">0</td>
                        <td class="pl-percentage-cell" id="grossProfit-pct">0.0%</td>
                    </tr>
                `;
                
                // NEW: Gross Profit Margin % Row
                htmlContent += `
                    <tr class="pl-margin-row pl-gross-margin">
                        <td class="pl-line-item pl-margin-line">Gross Profit Margin %</td>`;
                
                // Generate dynamic margin cells
                for (let month = 1; month <= 12; month++) {
                    htmlContent += `<td class="pl-margin-cell">0.0%</td>`;
                }
                
                htmlContent += `
                        <td class="pl-margin-cell pl-margin-prominent" id="grossMargin-total">0.0%</td>
                        <td class="pl-percentage-cell">-</td>
                    </tr>
                `;
            }
            
            // OPERATING EXPENSES SECTION
            htmlContent += `
                <tr class="pl-section-header-row">
                    <td colspan="15" class="pl-section-header">
                        <i class="fas fa-calculator"></i> OPERATING EXPENSES
                    </td>
                </tr>
            `;
            
            accountCategories.opex.forEach(account => {
                htmlContent += `
                    <tr class="pl-data-row pl-opex-row" data-account-code="${account.account_code}">
                        <td class="pl-line-item">${account.account_name}</td>`;
                
                // Generate dynamic month cells
                for (let month = 1; month <= 12; month++) {
                    const monthKey = monthNames[month - 1].toLowerCase();
                    const isActual = month <= actualEndMonth;
                    const cellClass = isActual ? 'pl-actual-cell' : 'pl-forecast-cell';
                    const editableAttr = isActual ? '' : 'contenteditable="true"';
                    
                    htmlContent += `<td class="${cellClass}" ${editableAttr} data-month="${monthKey}">0</td>`;
                }
                
                htmlContent += `
                        <td class="pl-total-cell" id="${account.account_code}-total">0</td>
                        <td class="pl-percentage-cell" id="${account.account_code}-pct">0.0%</td>
                    </tr>
                `;
            });
            
            // OPEX Total Row
            htmlContent += `
                <tr class="pl-total-row pl-opex-total">
                    <td class="pl-line-item pl-total-line">Total Operating Expenses</td>`;
            
            // Generate dynamic total cells
            for (let month = 1; month <= 12; month++) {
                htmlContent += `<td class="pl-calculated-cell">0</td>`;
            }
            
            htmlContent += `
                    <td class="pl-total-cell pl-total-prominent" id="totalOPEX-total">0</td>
                    <td class="pl-percentage-cell" id="totalOPEX-pct">0.0%</td>
                </tr>
            `;
            
            // NEW: OPEX to Sales % Row
            htmlContent += `
                <tr class="pl-margin-row pl-opex-margin">
                    <td class="pl-line-item pl-margin-line">OPEX to Sales %</td>`;
            
            // Generate dynamic margin cells
            for (let month = 1; month <= 12; month++) {
                htmlContent += `<td class="pl-margin-cell">0.0%</td>`;
            }
            
            htmlContent += `
                    <td class="pl-margin-cell pl-margin-prominent" id="opexMargin-total">0.0%</td>
                    <td class="pl-percentage-cell">-</td>
                </tr>
            `;
            
            // NEW: EBITDA Row
            htmlContent += `
                <tr class="pl-calculated-row pl-ebitda">
                    <td class="pl-line-item pl-ebitda-line">EBITDA</td>`;
            
            // Generate dynamic EBITDA cells
            for (let month = 1; month <= 12; month++) {
                htmlContent += `<td class="pl-ebitda-cell">0</td>`;
            }
            
            htmlContent += `
                    <td class="pl-ebitda-cell pl-ebitda-prominent" id="ebitda-total">0</td>
                    <td class="pl-percentage-cell" id="ebitda-pct">0.0%</td>
                </tr>
            `;
            
            // NEW: EBITDA Margin % Row
            htmlContent += `
                <tr class="pl-margin-row pl-ebitda-margin">
                    <td class="pl-line-item pl-margin-line">EBITDA Margin %</td>`;
            
            // Generate dynamic margin cells
            for (let month = 1; month <= 12; month++) {
                htmlContent += `<td class="pl-margin-cell">0.0%</td>`;
            }
            
            htmlContent += `
                    <td class="pl-margin-cell pl-margin-prominent" id="ebitdaMargin-total">0.0%</td>
                    <td class="pl-percentage-cell">-</td>
                </tr>
            `;
            
            // NEW: EBIT Row
            htmlContent += `
                <tr class="pl-calculated-row pl-ebit">
                    <td class="pl-line-item pl-ebit-line">EBIT</td>`;
            
            // Generate dynamic EBIT cells
            for (let month = 1; month <= 12; month++) {
                htmlContent += `<td class="pl-ebit-cell">0</td>`;
            }
            
            htmlContent += `
                    <td class="pl-ebit-cell pl-ebit-prominent" id="ebit-total">0</td>
                    <td class="pl-percentage-cell" id="ebit-pct">0.0%</td>
                </tr>
            `;
            
            // NET INCOME Row
            htmlContent += `
                <tr class="pl-calculated-row pl-net-income">
                    <td class="pl-line-item pl-net-income-line">Net Income</td>`;
            
            // Generate dynamic net income cells
            for (let month = 1; month <= 12; month++) {
                htmlContent += `<td class="pl-net-cell">0</td>`;
            }
            
            htmlContent += `
                    <td class="pl-net-cell pl-net-prominent" id="netIncome-total">0</td>
                    <td class="pl-percentage-cell" id="netIncome-pct">0.0%</td>
                </tr>
            `;
            
            // NEW: Net Income Margin % Row
            htmlContent += `
                <tr class="pl-margin-row pl-net-margin">
                    <td class="pl-line-item pl-margin-line">Net Income Margin %</td>`;
            
            // Generate dynamic margin cells
            for (let month = 1; month <= 12; month++) {
                htmlContent += `<td class="pl-margin-cell">0.0%</td>`;
            }
            
            htmlContent += `
                    <td class="pl-margin-cell pl-margin-prominent" id="netMargin-total">0.0%</td>
                    <td class="pl-percentage-cell">-</td>
                </tr>
            `;
            
            // Update the table
            tbody.innerHTML = htmlContent;
        
            // Calculate derived metrics AFTER DOM is updated
            setTimeout(() => {
                recalculateEntirePL();
            }, 100);
        }

        function populatePLWithActualData(transactions) {
            console.log('Populating P&L with actual transaction data...');
            
            // Get dynamic date context
            const dateContext = getDateContext();
            const { actualEndMonth, monthNames } = dateContext;
            
            // Group transactions by account code and month
            const monthlyData = {};
            
            transactions.forEach(transaction => {
                const date = new Date(transaction.transaction_date);
                const month = date.getMonth(); // 0 = Jan, 1 = Feb, etc.
                const accountCode = transaction.account_code;
                
                if (!monthlyData[accountCode]) {
                    monthlyData[accountCode] = Array(12).fill(0);
                }
                
                const debitAmount = parseFloat(transaction.debit_amount || 0);
                const creditAmount = parseFloat(transaction.credit_amount || 0);
                
                // Revenue accounts (4000-4999): credits increase revenue
                if (accountCode >= 4000 && accountCode < 5000) {
                    monthlyData[accountCode][month] += (creditAmount - debitAmount);
                } 
                // COGS accounts (5000-5099): debits increase COGS
                else if (accountCode >= 5000 && accountCode < 5100) {
                    monthlyData[accountCode][month] += (debitAmount - creditAmount);
                } 
                // OPEX accounts (5100-5999): debits increase expenses
                else if (accountCode >= 5100 && accountCode < 6000) {
                    monthlyData[accountCode][month] += (debitAmount - creditAmount);
                }
            });
            
            // Populate the actual cells dynamically based on actualEndMonth
            Object.keys(monthlyData).forEach(accountCode => {
                const accountRow = document.querySelector(`tr[data-account-code="${accountCode}"]`);
                if (!accountRow) return;
                
                // Generate dynamic month names for actual period only
                const actualMonthNames = [];
                for (let i = 0; i < actualEndMonth; i++) {
                    actualMonthNames.push(monthNames[i].toLowerCase());
                }
                
                console.log(`Populating actuals for account ${accountCode}: ${actualMonthNames.join(', ')}`);
                
                actualMonthNames.forEach((monthName, index) => {
                    const cell = accountRow.querySelector(`.pl-actual-cell[data-month="${monthName}"]`);
                    if (cell) {
                        const amount = monthlyData[accountCode][index] || 0;
                        cell.textContent = Math.round(amount).toLocaleString();
                        console.log(`${accountCode} ${monthName}: ${Math.round(amount).toLocaleString()}`);
                    } else {
                        console.warn(`Cell not found for ${accountCode} ${monthName}`);
                    }
                });
            });
            
            // Recalculate everything ONCE with proper sequence
            setTimeout(() => {
                recalculateEntirePL();
            }, 100);
            
            console.log(`P&L populated with actual data for ${actualEndMonth} months!`);
        }
        
        function populatePLActualCells(data) {
            // This function will map your Supabase data to the actual cells
            // Adapt this based on your actual data structure
            console.log('Populating actual cells with:', data);
            
            // Example implementation - you'll need to adapt this
            // based on your actual data structure and mapping
        }
        
        // Add this function to your JavaScript section
        function hideZeroValueRows() {
            const dataRows = document.querySelectorAll('.pl-data-row');
            
            dataRows.forEach(row => {
                // Get all value cells (both actual and forecast)
                const valueCells = row.querySelectorAll('.pl-actual-cell, .pl-forecast-cell');
                let hasNonZeroValue = false;
                
                // Check if any cell has a non-zero value
                valueCells.forEach(cell => {
                    const value = parseFloat(cell.textContent.replace(/,/g, '')) || 0;
                    if (value !== 0) {
                        hasNonZeroValue = true;
                    }
                });
                
                // Hide the row if all values are zero
                if (!hasNonZeroValue) {
                    row.style.display = 'none';
                } else {
                    row.style.display = '';
                }
            });
        }

        // Call this function after updating the forecast table
        function recalculateEntirePL() {
            console.log(' Starting complete P&L recalculation...');
            
            // Step 1: Calculate row totals first
            calculatePLRowTotals();
            
            // Step 2: Calculate section totals (Revenue, COGS, OPEX)
            calculatePLSectionTotals();
            
            // Step 3: Calculate derived metrics (Gross Profit, EBITDA, EBIT, Net Income)
            calculatePLDerivedMetrics();
            
            // Step 4: Calculate derived metric totals
            calculateDerivedMetricTotals();
            
            // Step 5: Calculate all margin percentages (AFTER derived metrics are done)
            calculatePLMarginMetrics();
            
            // Step 6: Calculate percentages for revenue breakdown
            calculatePLPercentages();
            
            // Step 7: Hide rows with all zero values
            hideZeroValueRows();

            // Step 8: Update trending chart if container exists
            const trendingContainer = document.getElementById('forecastTrendingContainer');
            if (trendingContainer && trendingContainer.style.display !== 'none') {
                generateForecastTrendingChart();
            }
            
            console.log(' P&L recalculation complete!');
        }
        
        function calculatePLRowTotals() {
            const dataRows = document.querySelectorAll('.pl-data-row');
            
            dataRows.forEach(row => {
                const cells = row.querySelectorAll('.pl-actual-cell, .pl-forecast-cell');
                const totalCell = row.querySelector('.pl-total-cell');
                
                if (totalCell) {
                    let total = 0;
                    cells.forEach(cell => {
                        const value = parseFloat(cell.textContent.replace(/,/g, '')) || 0;
                        total += value;
                    });
                    totalCell.textContent = total.toLocaleString();
                }
            });
        }
        
        function calculatePLSectionTotals() {
            // Total Revenue
            const revenueRows = document.querySelectorAll('.pl-revenue-row');
            const totalRevenueRow = document.querySelector('.pl-revenue-total');
            calculatePLSectionTotal(revenueRows, totalRevenueRow);
            
            // Total COGS
            const cogsRows = document.querySelectorAll('.pl-cogs-row');
            const totalCogsRow = document.querySelector('.pl-cogs-total');
            calculatePLSectionTotal(cogsRows, totalCogsRow);
            
            // Total OPEX
            const opexRows = document.querySelectorAll('.pl-opex-row');
            const totalOpexRow = document.querySelector('.pl-opex-total');
            calculatePLSectionTotal(opexRows, totalOpexRow);
        }
        
        function calculatePLSectionTotal(rows, totalRow) {
            if (!totalRow) return;
            
            const monthCells = totalRow.querySelectorAll('td:not(.pl-line-item):not(.pl-total-cell):not(.pl-percentage-cell)');
            
            monthCells.forEach((totalCell, index) => {
                let monthTotal = 0;
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td:not(.pl-line-item):not(.pl-total-cell):not(.pl-percentage-cell)');
                    if (cells[index]) {
                        const value = parseFloat(cells[index].textContent.replace(/,/g, '')) || 0;
                        monthTotal += value;
                    }
                });
                totalCell.textContent = monthTotal.toLocaleString();
            });
            
            // Calculate annual total for section
            const annualTotalCell = totalRow.querySelector('.pl-total-prominent');
            if (annualTotalCell) {
                let annualTotal = 0;
                rows.forEach(row => {
                    const rowTotal = row.querySelector('.pl-total-cell');
                    if (rowTotal) {
                        const value = parseFloat(rowTotal.textContent.replace(/,/g, '')) || 0;
                        annualTotal += value;
                    }
                });
                annualTotalCell.textContent = annualTotal.toLocaleString();
            }
        }
        
        function calculatePLDerivedMetrics() {
            const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            
            months.forEach((month, index) => {
                // Get revenue and costs for this month
                const revenueCell = document.querySelector(`.pl-revenue-total td:nth-child(${index + 2})`);
                const cogsCell = document.querySelector(`.pl-cogs-total td:nth-child(${index + 2})`);
                const opexCell = document.querySelector(`.pl-opex-total td:nth-child(${index + 2})`);
                
                const revenue = parseFloat(revenueCell?.textContent?.replace(/,/g, '') || 0);
                const cogs = parseFloat(cogsCell?.textContent?.replace(/,/g, '') || 0);
                const opex = parseFloat(opexCell?.textContent?.replace(/,/g, '') || 0);
                
                // Calculate derived metrics
                const grossProfit = revenue - cogs;
                const ebitda = grossProfit - opex; 
                const ebit = ebitda; 
                const netIncome = ebit; 
                
                // Update Gross Profit cells
                const grossProfitCell = document.querySelector(`.pl-gross-profit td:nth-child(${index + 2})`);
                if (grossProfitCell) {
                    grossProfitCell.textContent = Math.round(grossProfit).toLocaleString();
                }
                
                // Update EBITDA cells
                const ebitdaCell = document.querySelector(`.pl-ebitda td:nth-child(${index + 2})`);
                if (ebitdaCell) {
                    ebitdaCell.textContent = Math.round(ebitda).toLocaleString();
                }
                
                // Update EBIT cells
                const ebitCell = document.querySelector(`.pl-ebit td:nth-child(${index + 2})`);
                if (ebitCell) {
                    ebitCell.textContent = Math.round(ebit).toLocaleString();
                }
                
                // Update Net Income cells
                const netIncomeCell = document.querySelector(`.pl-net-income td:nth-child(${index + 2})`);
                if (netIncomeCell) {
                    netIncomeCell.textContent = Math.round(netIncome).toLocaleString();
                }
            });
        }

        
        
        function calculatePLDerivedRow(row1, row2, resultRow, operation) {
            const row1Cells = row1.querySelectorAll('td:not(.pl-line-item):not(.pl-percentage-cell)');
            const row2Cells = row2.querySelectorAll('td:not(.pl-line-item):not(.pl-percentage-cell)');
            const resultCells = resultRow.querySelectorAll('td:not(.pl-line-item):not(.pl-percentage-cell)');
            
            resultCells.forEach((resultCell, index) => {
                if (row1Cells[index]) {
                    const value1 = parseFloat(row1Cells[index].textContent.replace(/,/g, '')) || 0;
                    const value2 = row2Cells[index] ? parseFloat(row2Cells[index].textContent.replace(/,/g, '')) || 0 : 0;
                    
                    let result;
                    if (operation === 'subtract') {
                        result = value1 - value2;
                    } else if (operation === 'add') {
                        result = value1 + value2;
                    } else if (operation === 'copy') {
                        result = value1;
                    }
                    
                    resultCell.textContent = result.toLocaleString();
                }
            });
        }
        
        function calculatePLPercentages() {
            const totalRevenueCell = document.querySelector('#totalRevenue-total');
            if (!totalRevenueCell) return;
            
            const totalRevenue = parseFloat(totalRevenueCell.textContent.replace(/,/g, '')) || 0;
            
            if (totalRevenue === 0) {
                // Set all percentages to 0% if no revenue
                const percentageCells = document.querySelectorAll('.pl-percentage-cell[id]');
                percentageCells.forEach(cell => {
                    if (cell.id !== 'totalRevenue-total') { // Don't change revenue percentage (always 100%)
                        cell.textContent = '0.0%';
                    }
                });
                return;
            }
            
            // Calculate percentage of total revenue for each line item
            const percentageCells = document.querySelectorAll('.pl-percentage-cell[id]');
            percentageCells.forEach(cell => {
                const id = cell.id.replace('-pct', '-total');
                const totalCell = document.getElementById(id);
                
                if (totalCell && totalRevenue > 0) {
                    const value = parseFloat(totalCell.textContent.replace(/,/g, '')) || 0;
                    
                    // CORRECTED: All percentages calculated as percentage of TOTAL REVENUE
                    const percentage = (value / totalRevenue) * 100;
                    cell.textContent = percentage.toFixed(1) + '%';
                }
            });
            
            // Ensure Total Revenue is always 100%
            const totalRevenuePercentage = document.querySelector('#totalRevenue-total').parentElement.querySelector('.pl-percentage-cell');
            if (totalRevenuePercentage) {
                totalRevenuePercentage.textContent = '100.0%';
            }
        }
        
        function formatPLCellValue(cell) {
            const value = parseFloat(cell.textContent.replace(/,/g, ''));
            if (!isNaN(value)) {
                cell.textContent = value.toLocaleString();
            }
        }
        
        function updatePLMarketContext(industry) {
            console.log(`Updating market context for ${industry} industry`);
            // This would integrate with web search for real market data
            // For now, just log the industry selection
        }
        
        function refreshActualData() {
            console.log('Refreshing actual data from Supabase...');
            loadActualTransactionData(); // Changed from loadPLActualDataFromSupabase()
        }
        
        // Auto-save functionality
        function autoSavePLForecast() {
            const forecastData = {};
            
            document.querySelectorAll('.pl-forecast-cell[contenteditable="true"]').forEach(cell => {
                const month = cell.dataset.month || 'unknown';
                const row = cell.closest('tr');
                const lineItem = row.querySelector('.pl-line-item');
                
                if (lineItem) {
                    const lineItemText = lineItem.textContent;
                    if (!forecastData[lineItemText]) {
                        forecastData[lineItemText] = {};
                    }
                    forecastData[lineItemText][month] = cell.textContent;
                }
            });
            
            localStorage.setItem('plForecastData_2025', JSON.stringify(forecastData));
        }
        
        function loadSavedPLForecast() {
            const savedData = localStorage.getItem('plForecastData_2025');
            if (savedData) {
                const forecastData = JSON.parse(savedData);
                
                Object.keys(forecastData).forEach(lineItem => {
                    Object.keys(forecastData[lineItem]).forEach(month => {
                        const cell = document.querySelector(
                            `.pl-forecast-cell[data-month="${month}"]`
                        );
                        if (cell) {
                            const row = cell.closest('tr');
                            const lineItemCell = row.querySelector('.pl-line-item');
                            if (lineItemCell && lineItemCell.textContent === lineItem) {
                                cell.textContent = forecastData[lineItem][month];
                            }
                        }
                    });
                });
                
                recalculateEntirePL();
            }
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Small delay to ensure other scripts are loaded
            setTimeout(function() {
                initializePLForecasting();
                loadSavedPLForecast();
            }, 1000);

            const generate2026Button = document.getElementById('generateAI2026Forecast');
            if (generate2026Button) {
                generate2026Button.addEventListener('click', generateAI2026Forecast);
            }
        });
        
        // Auto-save every 30 seconds
        setInterval(autoSavePLForecast, 30000);

        function initializePeriodTabs() {
            document.querySelectorAll('.period-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchForecastPeriod(this.dataset.period); 
                });
            });
        }

        function switchPLForecastPeriod(period) {
            // Update tab active state
            document.querySelectorAll('.period-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-period="${period}"]`).classList.add('active');
        
            // Hide all containers INCLUDING multi-year trending section
            document.querySelectorAll('.pl-forecast-container').forEach(container => {
                container.style.display = 'none';
            });
            
            // IMPORTANT: Hide multi-year trending section when switching away from multi-year
            const multiYearTrendingSection = document.getElementById('multiYearTrendingSection');
            if (multiYearTrendingSection && period !== 'multi-year') {
                multiYearTrendingSection.style.display = 'none';
            }
        
            // Show selected container
            const periodMap = {
                'current-year': '#current-year-container',
                'next-year': '#next-year-container',
                'multi-year': '#multi-year-container',
                'summary': '#summary-container'
            };
        
            const targetContainer = document.querySelector(periodMap[period]);
            if (targetContainer) {
                targetContainer.style.display = 'block';
            }
            
            // Show multi-year trending section only for multi-year tab
            if (period === 'multi-year' && multiYearTrendingSection) {
                // Only show if there's data (check if chart exists)
                if (window.multiYearTrendingChartInstance) {
                    multiYearTrendingSection.style.display = 'block';
                }
            }
        }

        // Store current year data when switching tabs
        function preserveCurrentYearData() {
            const currentYearData = {
                tableHTML: null,
                lastUpdated: Date.now()
            };
            
            const tbody = document.getElementById('plForecastBody');
            if (tbody && tbody.innerHTML) {
                currentYearData.tableHTML = tbody.innerHTML;
                window.currentYearTableData = currentYearData;
            }
        }
        
        // Restore current year data when switching back
        function restoreCurrentYearData() {
            if (window.currentYearTableData && window.currentYearTableData.tableHTML) {
                const tbody = document.getElementById('plForecastBody');
                if (tbody) {
                    tbody.innerHTML = window.currentYearTableData.tableHTML;
                    
                    // Re-attach event listeners for forecast cells
                    document.querySelectorAll('.pl-forecast-cell[contenteditable="true"]').forEach(cell => {
                        cell.addEventListener('input', function() {
                            recalculateEntirePL();
                        });
                        cell.addEventListener('blur', function() {
                            formatPLCellValue(this);
                        });
                    });
                }
            }
        }

        function calculatePLMarginMetrics() {
            console.log(' Starting margin calculations...');
            const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            
            months.forEach((month, index) => {
                const cellIndex = index + 2; // +2 because first column is line item
                
                // Get revenue for this month
                const revenueCell = document.querySelector(`.pl-revenue-total td:nth-child(${cellIndex})`);
                const revenue = parseFloat(revenueCell?.textContent?.replace(/,/g, '') || 0);
                
                console.log(`Month ${month}: Revenue = ${revenue}`);
                
                if (revenue === 0) {
                    // Set all margins to 0% if no revenue
                    updateMarginCell('.pl-gross-margin', cellIndex, '0.0%');
                    updateMarginCell('.pl-opex-margin', cellIndex, '0.0%');
                    updateMarginCell('.pl-ebitda-margin', cellIndex, '0.0%');
                    updateMarginCell('.pl-net-margin', cellIndex, '0.0%');
                    return;
                }
                
                // Get values for margin calculations
                const grossProfitCell = document.querySelector(`.pl-gross-profit td:nth-child(${cellIndex})`);
                const opexCell = document.querySelector(`.pl-opex-total td:nth-child(${cellIndex})`);
                const ebitdaCell = document.querySelector(`.pl-ebitda td:nth-child(${cellIndex})`);
                const netIncomeCell = document.querySelector(`.pl-net-income td:nth-child(${cellIndex})`);
                
                const grossProfit = parseFloat(grossProfitCell?.textContent?.replace(/,/g, '') || 0);
                const opex = parseFloat(opexCell?.textContent?.replace(/,/g, '') || 0);
                const ebitda = parseFloat(ebitdaCell?.textContent?.replace(/,/g, '') || 0);
                const netIncome = parseFloat(netIncomeCell?.textContent?.replace(/,/g, '') || 0);
                
                console.log(`${month} values:`, { revenue, grossProfit, opex, ebitda, netIncome });
                
                // Calculate margin percentages
                const grossMargin = (grossProfit / revenue) * 100;
                const opexMargin = (opex / revenue) * 100;
                const ebitdaMargin = (ebitda / revenue) * 100;
                const netMargin = (netIncome / revenue) * 100;
                
                console.log(`${month} margins:`, { grossMargin, opexMargin, ebitdaMargin, netMargin });
                
                // Update margin cells
                updateMarginCell('.pl-gross-margin', cellIndex, `${grossMargin.toFixed(1)}%`);
                updateMarginCell('.pl-opex-margin', cellIndex, `${opexMargin.toFixed(1)}%`);
                updateMarginCell('.pl-ebitda-margin', cellIndex, `${ebitdaMargin.toFixed(1)}%`);
                updateMarginCell('.pl-net-margin', cellIndex, `${netMargin.toFixed(1)}%`);
            });
            
            // Calculate margin totals
            calculateMarginTotals();
        }

        function updateMarginCell(rowSelector, cellIndex, value) {
            const row = document.querySelector(rowSelector);
            if (row) {
                const cell = row.querySelector(`td:nth-child(${cellIndex})`);
                if (cell) {
                    cell.textContent = value;
                    console.log(`Updated ${rowSelector} cell ${cellIndex} to ${value}`);
                } else {
                    console.log(`Cell not found: ${rowSelector} td:nth-child(${cellIndex})`);
                }
            } else {
                console.log(`Row not found: ${rowSelector}`);
            }
        }

        function calculateDerivedMetricTotals() {
            // Calculate Gross Profit Total: Total Revenue - Total COGS
            const totalRevenueCell = document.querySelector('#totalRevenue-total');
            const totalCogsCell = document.querySelector('#totalCOGS-total');
            const grossProfitTotalCell = document.querySelector('#grossProfit-total');
            
            if (totalRevenueCell && totalCogsCell && grossProfitTotalCell) {
                const totalRevenue = parseFloat(totalRevenueCell.textContent.replace(/,/g, '')) || 0;
                const totalCogs = parseFloat(totalCogsCell.textContent.replace(/,/g, '')) || 0;
                const grossProfitTotal = totalRevenue - totalCogs;
                
                grossProfitTotalCell.textContent = Math.round(grossProfitTotal).toLocaleString();
                console.log(` Gross Profit Total: ${totalRevenue.toLocaleString()} - ${totalCogs.toLocaleString()} = ${grossProfitTotal.toLocaleString()}`);
            }
            
            // Calculate EBITDA Total: Gross Profit - Total OPEX  
            const totalOpexCell = document.querySelector('#totalOPEX-total');
            const ebitdaTotalCell = document.querySelector('#ebitda-total');
            
            if (grossProfitTotalCell && totalOpexCell && ebitdaTotalCell) {
                const grossProfitTotal = parseFloat(grossProfitTotalCell.textContent.replace(/,/g, '')) || 0;
                const totalOpex = parseFloat(totalOpexCell.textContent.replace(/,/g, '')) || 0;
                const ebitdaTotal = grossProfitTotal - totalOpex;
                
                ebitdaTotalCell.textContent = Math.round(ebitdaTotal).toLocaleString();
            }
            
            // Calculate EBIT Total (same as EBITDA for simplicity)
            const ebitTotalCell = document.querySelector('#ebit-total');
            if (ebitdaTotalCell && ebitTotalCell) {
                ebitTotalCell.textContent = ebitdaTotalCell.textContent;
            }
            
            // Calculate Net Income Total (same as EBIT for simplicity) 
            const netIncomeTotalCell = document.querySelector('#netIncome-total');
            if (ebitTotalCell && netIncomeTotalCell) {
                netIncomeTotalCell.textContent = ebitTotalCell.textContent;
            }
        }
        
        // Updated helper function to set margin cell values
        function setMarginCellByClass(rowSelector, cellIndex, value) {
            const row = document.querySelector(rowSelector);
            if (row) {
                const cell = row.querySelector(`td:nth-child(${cellIndex})`);
                if (cell) {
                    cell.textContent = value;
                }
            }
        }

        function calculateMarginTotals() {
            // Calculate total revenue for margin calculations
            const totalRevenueCell = document.getElementById('totalRevenue-total');
            const totalRevenue = parseFloat(totalRevenueCell?.textContent?.replace(/,/g, '') || 0);
            
            if (totalRevenue === 0) {
                // Set all total margins to 0%
                setTotalMarginById('grossMargin-total', '0.0%');
                setTotalMarginById('opexMargin-total', '0.0%');
                setTotalMarginById('ebitdaMargin-total', '0.0%');
                setTotalMarginById('netMargin-total', '0.0%');
                return;
            }
            
            // Get total values for margin calculations
            const totalGrossProfitCell = document.getElementById('grossProfit-total');
            const totalOpexCell = document.getElementById('totalOPEX-total');
            const totalEbitdaCell = document.getElementById('ebitda-total');
            const totalNetIncomeCell = document.getElementById('netIncome-total');
            
            const totalGrossProfit = parseFloat(totalGrossProfitCell?.textContent?.replace(/,/g, '') || 0);
            const totalOpex = parseFloat(totalOpexCell?.textContent?.replace(/,/g, '') || 0);
            const totalEbitda = parseFloat(totalEbitdaCell?.textContent?.replace(/,/g, '') || 0);
            const totalNetIncome = parseFloat(totalNetIncomeCell?.textContent?.replace(/,/g, '') || 0);
            
            // CORRECTED: Calculate margin percentages as percentage of TOTAL REVENUE (not sum of monthly percentages)
            const grossMargin = (totalGrossProfit / totalRevenue) * 100;
            const opexMargin = (totalOpex / totalRevenue) * 100;
            const ebitdaMargin = (totalEbitda / totalRevenue) * 100;
            const netMargin = (totalNetIncome / totalRevenue) * 100;
            
            // Update total margin cells with corrected calculations
            setTotalMarginById('grossMargin-total', `${grossMargin.toFixed(1)}%`);
            setTotalMarginById('opexMargin-total', `${opexMargin.toFixed(1)}%`);
            setTotalMarginById('ebitdaMargin-total', `${ebitdaMargin.toFixed(1)}%`);
            setTotalMarginById('netMargin-total', `${netMargin.toFixed(1)}%`);
            
            console.log(' Margin totals calculated correctly:', {
                totalRevenue: totalRevenue.toLocaleString(),
                grossMargin: `${grossMargin.toFixed(1)}%`,
                opexMargin: `${opexMargin.toFixed(1)}%`,
                ebitdaMargin: `${ebitdaMargin.toFixed(1)}%`,
                netMargin: `${netMargin.toFixed(1)}%`
            });
        }
        
        // Updated helper function to set total margin values by ID
        function setTotalMarginById(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
            }
        }

        // Load latest AI forecast from Supabase on page load
        async function loadLatestForecastFromSupabase() {
            try {
                console.log(' Loading latest AI forecast from Supabase...');
                
                const user = await supabase.auth.getUser();
                const userId = user?.data?.user?.id;
                
                if (!userId) {
                    console.log('No authenticated user - skipping forecast load');
                    return;
                }
                
                // Get the latest forecast for this user
                const { data: latestForecast, error } = await supabase
                    .from('ai_forecasts_meridash')
                    .select('*')
                    .eq('user_id', userId)
                    .order('forecast_date', { ascending: false })
                    .limit(1);
                
                if (error) {
                    console.error('Error loading latest forecast:', error);
                    return;
                }
                
                if (!latestForecast || latestForecast.length === 0) {
                    console.log('No previous forecasts found');
                    return;
                }
                
                const forecast = latestForecast[0];
                console.log(' Found latest forecast:', forecast);
                
                // Extract forecast data
                const forecastData = forecast.forecast_data;
                
                // Apply the forecast to the P&L table
                if (forecastData && forecastData.forecast_data && forecastData.forecast_data.monthly_forecasts) {
                    await applyStoredForecastToTable(forecastData.forecast_data.monthly_forecasts);
                    
                    // Show insights if available
                    if (forecastData.insights) {
                        displayStoredAIInsights(forecastData, forecast);
                    }
                    
                    // Recalculate everything
                    recalculateEntirePL();
                    
                    console.log(' Latest forecast loaded and applied');
                    
                    // Show a subtle notification
                    showForecastLoadedNotification(forecast.forecast_date);
                    
                } else if (forecastData && forecastData.monthly_forecasts) {
                    // Handle direct structure (if the response was processed before storing)
                    await applyStoredForecastToTable(forecastData.monthly_forecasts);
                    
                    // Show insights if available
                    if (forecastData.insights) {
                        displayStoredAIInsights(forecastData, forecast);
                    }
                    
                    // Recalculate everything
                    recalculateEntirePL();
                    
                    console.log(' Latest forecast loaded and applied');
                    
                    // Show a subtle notification
                    showForecastLoadedNotification(forecast.forecast_date);
                }
                
            } catch (error) {
                console.error('Error loading latest forecast:', error);
            }
            
            // Generate forecast trending chart if container exists
            if (document.getElementById('forecastTrendingContainer')) {
                document.getElementById('forecastTrendingContainer').style.display = 'block';
                generateForecastTrendingChart();
            }
        }

        // Apply stored forecast data to P&L table
        async function applyStoredForecastToTable(monthlyForecasts) {
            console.log(' Applying stored forecast to table...', monthlyForecasts);
            
            if (!monthlyForecasts || !Array.isArray(monthlyForecasts)) {
                console.error('Invalid stored forecast data');
                return;
            }
        
            const monthKeyMap = {
                7: 'jul', 8: 'aug', 9: 'sep', 
                10: 'oct', 11: 'nov', 12: 'dec'
            };
        
            let updatedCells = 0;
        
            // Apply forecasts to each month
            monthlyForecasts.forEach((monthData) => {
                const monthKey = monthKeyMap[monthData.month];
                
                if (!monthKey) {
                    console.log(`Skipping month ${monthData.month} - not in forecast period`);
                    return;
                }
                
                console.log(`Applying stored forecast for ${monthData.month_name} (${monthKey})`);
                
                // Apply revenue forecasts
                if (monthData.revenue_accounts) {
                    Object.entries(monthData.revenue_accounts).forEach(([accountCode, amount]) => {
                        if (amount > 0) {
                            const success = updateForecastCell(accountCode, monthKey, amount);
                            if (success) updatedCells++;
                        }
                    });
                }
                
                // Apply COGS forecasts
                if (monthData.cogs_accounts) {
                    Object.entries(monthData.cogs_accounts).forEach(([accountCode, amount]) => {
                        if (amount > 0) {
                            const success = updateForecastCell(accountCode, monthKey, amount);
                            if (success) updatedCells++;
                        }
                    });
                }
                
                // Apply OPEX forecasts
                if (monthData.opex_accounts) {
                    Object.entries(monthData.opex_accounts).forEach(([accountCode, amount]) => {
                        if (amount > 0) {
                            const success = updateForecastCell(accountCode, monthKey, amount);
                            if (success) updatedCells++;
                        }
                    });
                }
            });
            
            console.log(` Applied stored forecast: ${updatedCells} cells updated`);
        }

        // Display stored AI insights
        function displayStoredAIInsights(forecastData, forecastRecord) {
            const insightsContainer = document.getElementById('aiInsightsContainer');
            const insights = forecastData.insights;
            
            if (!insightsContainer || !insights) {
                console.log('Insights container or data not found');
                return;
            }
            
            // Update confidence badge
            const confidenceBadge = document.getElementById('confidenceBadge');
            if (confidenceBadge) {
                const confidence = forecastRecord.confidence_score || 75;
                confidenceBadge.textContent = `Confidence: ${confidence}%`;
                
                // Color code confidence level
                if (confidence >= 80) {
                    confidenceBadge.style.background = 'rgba(34, 197, 94, 0.2)';
                    confidenceBadge.style.color = '#22c55e';
                    confidenceBadge.style.borderColor = 'rgba(34, 197, 94, 0.3)';
                } else if (confidence >= 60) {
                    confidenceBadge.style.background = 'rgba(245, 158, 11, 0.2)';
                    confidenceBadge.style.color = '#f59e0b';
                    confidenceBadge.style.borderColor = 'rgba(245, 158, 11, 0.3)';
                } else {
                    confidenceBadge.style.background = 'rgba(239, 68, 68, 0.2)';
                    confidenceBadge.style.color = '#ef4444';
                    confidenceBadge.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                }
            }
            
            // Update forecast date
            const forecastDate = document.getElementById('forecastDate');
            if (forecastDate) {
                const date = new Date(forecastRecord.forecast_date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                forecastDate.textContent = `Generated: ${date}`;
            }
            
            // Update insight texts with formatting support
            document.getElementById('keyTrendsText').innerHTML = formatInsightText(insights.key_trends || 'No trends analysis available.');
            document.getElementById('riskFactorsText').innerHTML = formatInsightText(insights.risk_factors || 'No risk factors identified.');
            document.getElementById('opportunitiesText').innerHTML = formatInsightText(insights.opportunities || 'No opportunities identified.');
            document.getElementById('methodologyText').innerHTML = formatInsightText(forecastData.methodology || 'AI-based analysis methodology.');
            
            // Show insights container
            insightsContainer.style.display = 'block';
            
            console.log(' Stored AI insights displayed with formatting');
        }

        function formatInsightText(text) {
            if (!text) return '';
            
            return text
                // Convert **bold** to <strong>
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Convert *italic* to <em>
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Convert line breaks to <br>
                .replace(/\n/g, '<br>')
                // Handle multiple spaces
                .replace(/  +/g, ' ')
                // Ensure proper paragraph spacing
                .replace(/\. ([A-Z])/g, '. <br><br>$1');
        }

        // Show a subtle notification that forecast was loaded
        function showForecastLoadedNotification(forecastDate, isGenerated = false) {
            const date = new Date(forecastDate).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const message = isGenerated ? 
                `AI forecast generated (${date})` : 
                `Latest forecast loaded (${date})`;
            
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #22c55e, #16a34a);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 1000;
                font-size: 14px;
                font-weight: 500;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-check-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 4000);
        }

        // Generate forecast trending chart using existing styling
        function generateForecastTrendingChart() {
            const canvas = document.getElementById('forecastTrendingChart');
            if (!canvas) return;
            
            // Destroy existing chart if it exists
            if (window.forecastTrendingChartInstance) {
                window.forecastTrendingChartInstance.destroy();
            }
            
            // Show FULL YEAR - all 12 months
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            const revenueData = [];
            const grossProfitData = [];
            const opexData = [];
            const ebitdaData = [];
            
            // Get data from total rows
            const totalRevenueRow = document.querySelector('#totalRevenue-total')?.closest('tr');
            const grossProfitRow = document.querySelector('#grossProfit-total')?.closest('tr');
            const totalOpexRow = document.querySelector('#totalOPEX-total')?.closest('tr');
            const ebitdaRow = document.querySelector('#ebitda-total')?.closest('tr');
            
            if (totalRevenueRow && grossProfitRow && totalOpexRow && ebitdaRow) {
                // Extract data for ALL 12 months (Jan-Dec)
                for (let i = 1; i <= 12; i++) {
                    const revenue = parseFloat(totalRevenueRow.cells[i]?.textContent.replace(/,/g, '')) || 0;
                    const grossProfit = parseFloat(grossProfitRow.cells[i]?.textContent.replace(/,/g, '')) || 0;
                    const opex = parseFloat(totalOpexRow.cells[i]?.textContent.replace(/,/g, '')) || 0;
                    const ebitda = parseFloat(ebitdaRow.cells[i]?.textContent.replace(/,/g, '')) || 0;
                    
                    revenueData.push(revenue / 1000000); // Convert to millions
                    grossProfitData.push(grossProfit / 1000000);
                    opexData.push(opex / 1000000);
                    ebitdaData.push(ebitda / 1000000);
                }
            }
            
            // Determine which months are actuals vs forecast for styling
            const now = new Date();
            const currentMonth = now.getMonth() + 1; // 1-12
            const currentDay = now.getDate();
            const includeCurrentMonth = currentDay <= 25;
            const actualEndMonth = includeCurrentMonth ? currentMonth : currentMonth - 1;
            
            const ctx = canvas.getContext('2d');
            window.forecastTrendingChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months, // All 12 months
                    datasets: [
                        {
                            label: 'Revenue (Net)',
                            data: revenueData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: months.map((_, i) => i < actualEndMonth ? '#1e40af' : '#93c5fd'), // Different colors for actual vs forecast
                            pointRadius: 4
                        },
                        {
                            label: 'Gross Profit',
                            data: grossProfitData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: months.map((_, i) => i < actualEndMonth ? '#047857' : '#6ee7b7')
                        },
                        {
                            label: 'OPEX',
                            data: opexData,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: months.map((_, i) => i < actualEndMonth ? '#d97706' : '#fcd34d')
                        },
                        {
                            label: 'EBITDA',
                            data: ebitdaData,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: months.map((_, i) => i < actualEndMonth ? '#7c3aed' : '#c4b5fd')
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '2025 Full Year Financial Trends (Actuals + Forecast)',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            position: 'top'
                        },
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    xMin: actualEndMonth - 0.5,
                                    xMax: actualEndMonth - 0.5,
                                    borderColor: '#ef4444',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: 'Actuals | Forecast',
                                        enabled: true,
                                        position: 'top'
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (Millions IDR)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: `Jan-${months[actualEndMonth-1]}: Actuals | ${months[actualEndMonth]}-Dec: Forecast`
                            }
                        }
                    }
                }
            });
            
            // Calculate and display summary metrics using original logic
            calculateForecastSummaryMetrics();
            
            console.log(' 2025 Full Year Chart Generated:', {
                totalMonths: 12,
                actualMonths: actualEndMonth,
                forecastMonths: 12 - actualEndMonth,
                revenueRange: `${Math.min(...revenueData).toFixed(1)}M - ${Math.max(...revenueData).toFixed(1)}M`
            });
        }

        function calculateForecastSummaryMetrics(revenueData, grossProfitData, opexData, ebitdaData, forecastMonths) {
            // Don't use the chart data - get from the actual P&L table totals like before
            
            // Revenue Growth - Calculate CMGR from table
            const totalRevenueCell = document.querySelector('#totalRevenue-total');
            const totalRevenueTotalCell = totalRevenueCell;
            
            let revenueCMGR = 0; // Declare outside the if block
            let revenueJan = 0;
            let revenueDec = 0;
            
            // Get first and last month revenue for CMGR calculation
            const totalRevenueRow = totalRevenueCell?.closest('tr');
            if (totalRevenueRow) {
                const cells = totalRevenueRow.querySelectorAll('td');
                revenueJan = parseFloat(cells[1]?.textContent.replace(/,/g, '')) || 0;
                revenueDec = parseFloat(cells[12]?.textContent.replace(/,/g, '')) || 0;
                
                // Calculate CMGR (Compound Monthly Growth Rate)
                revenueCMGR = revenueJan > 0 ? (Math.pow(revenueDec / revenueJan, 1/11) - 1) * 100 : 0;
                
                document.getElementById('forecastRevenueGrowth').textContent = `${revenueCMGR > 0 ? '+' : ''}${revenueCMGR.toFixed(1)}%`;
                document.getElementById('revenueGrowthDirection').textContent = 'CMGR (Jan-Dec)';
            }
            
            // Gross Margin - Get from P&L table "2025 Total" column percentage
            const grossProfitTotalCell = document.querySelector('#grossProfit-total');
            
            let fullYearGrossMargin = 0;
            if (grossProfitTotalCell && totalRevenueTotalCell) {
                const totalRevenue = parseFloat(totalRevenueTotalCell.textContent.replace(/,/g, '')) || 0;
                const totalGrossProfit = parseFloat(grossProfitTotalCell.textContent.replace(/,/g, '')) || 0;
                fullYearGrossMargin = totalRevenue > 0 ? (totalGrossProfit / totalRevenue) * 100 : 0;
            }
            
            document.getElementById('forecastGrossMargin').textContent = `${fullYearGrossMargin.toFixed(1)}%`;
            document.getElementById('grossMarginTrend').textContent = 'Full Year Total';
            
            // EBITDA Margin - Get from P&L table "2025 Total" column percentage  
            const ebitdaTotalCell = document.querySelector('#ebitda-total');
            
            let fullYearEbitdaMargin = 0;
            if (ebitdaTotalCell && totalRevenueTotalCell) {
                const totalRevenue = parseFloat(totalRevenueTotalCell.textContent.replace(/,/g, '')) || 0;
                const totalEbitda = parseFloat(ebitdaTotalCell.textContent.replace(/,/g, '')) || 0;
                fullYearEbitdaMargin = totalRevenue > 0 ? (totalEbitda / totalRevenue) * 100 : 0;
            }
            
            document.getElementById('forecastEbitdaMargin').textContent = `${fullYearEbitdaMargin.toFixed(1)}%`;
            document.getElementById('ebitdaMarginTrend').textContent = 'Full Year Total';
            
            console.log('Summary Card Calculations (from P&L table):', {
                revenueCMGR: revenueCMGR.toFixed(1) + '%',
                revenueJan: revenueJan.toLocaleString(),
                revenueDec: revenueDec.toLocaleString(),
                fullYearGrossMargin: fullYearGrossMargin.toFixed(1) + '%',
                fullYearEbitdaMargin: fullYearEbitdaMargin.toFixed(1) + '%'
            });
        }
        
        // Extract data from forecast table for the chart
        function extractForecastChartData() {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const labels = [];
            const revenue = [];
            const grossProfit = [];
            const cogs = [];
            const ebitda = [];
            
            // Get data from revenue total row
            const revenueRow = document.querySelector('.pl-revenue-total');
            const grossProfitRow = document.querySelector('.pl-gross-profit');
            const cogsRow = document.querySelector('.pl-cogs-total');
            const ebitdaRow = document.querySelector('.pl-ebitda');
            
            if (revenueRow && grossProfitRow && cogsRow && ebitdaRow) {
                for (let i = 1; i <= 12; i++) { // Skip first column (line item name)
                    const revenueCell = revenueRow.children[i];
                    const grossProfitCell = grossProfitRow.children[i];
                    const cogsCell = cogsRow.children[i];
                    const ebitdaCell = ebitdaRow.children[i];
                    
                    if (revenueCell && grossProfitCell && cogsCell && ebitdaCell) {
                        const revenueValue = parseFloat(revenueCell.textContent.replace(/,/g, '')) || 0;
                        const grossProfitValue = parseFloat(grossProfitCell.textContent.replace(/,/g, '')) || 0;
                        const cogsValue = parseFloat(cogsCell.textContent.replace(/,/g, '')) || 0;
                        const ebitdaValue = parseFloat(ebitdaCell.textContent.replace(/,/g, '')) || 0;
                        
                        // Only include months with data
                        if (revenueValue > 0 || grossProfitValue > 0 || cogsValue > 0 || ebitdaValue > 0) {
                            labels.push(months[i - 1]);
                            revenue.push(revenueValue);
                            grossProfit.push(grossProfitValue);
                            cogs.push(cogsValue);
                            ebitda.push(ebitdaValue);
                        }
                    }
                }
            }
            
            return { labels, revenue, grossProfit, cogs, ebitda };
        }
        
        // Updated summary cards calculation to match table data exactly
        function updateForecastSummaryCards(data) {
            if (data.revenue.length < 2) return;
            
            // 1. Revenue Growth - CMGR (Compound Monthly Growth Rate) Dec vs Jan
            const revenueJan = data.revenue[0]; // Jan (first month)
            const revenueDec = data.revenue[data.revenue.length - 1]; // Dec (last month)
            const months = 11; // Jan to Dec is 11 months progression
            
            let revenueCMGR = 0;
            if (revenueJan > 0 && revenueDec > 0 && months > 0) {
                revenueCMGR = (Math.pow(revenueDec / revenueJan, 1 / months) - 1) * 100;
            }
            
            document.getElementById('forecastRevenueGrowth').textContent = `${revenueCMGR >= 0 ? '+' : ''}${revenueCMGR.toFixed(1)}%`;
            document.getElementById('revenueGrowthDirection').textContent = 'CMGR (Monthly)';
            
            // 2. Gross Margin - Get from P&L table "2025 Total" column percentage
            const grossProfitTotalCell = document.querySelector('#grossProfit-total');
            const totalRevenueTotalCell = document.querySelector('#totalRevenue-total');
            
            let fullYearGrossMargin = 0;
            if (grossProfitTotalCell && totalRevenueTotalCell) {
                const totalRevenue = parseFloat(totalRevenueTotalCell.textContent.replace(/,/g, '')) || 0;
                const totalGrossProfit = parseFloat(grossProfitTotalCell.textContent.replace(/,/g, '')) || 0;
                fullYearGrossMargin = totalRevenue > 0 ? (totalGrossProfit / totalRevenue) * 100 : 0;
            }
            
            document.getElementById('forecastGrossMargin').textContent = `${fullYearGrossMargin.toFixed(1)}%`;
            document.getElementById('grossMarginTrend').textContent = 'Full Year Total';
            
            // 3. EBITDA Margin - Get from P&L table "2025 Total" column percentage  
            const ebitdaTotalCell = document.querySelector('#ebitda-total');
            
            let fullYearEbitdaMargin = 0;
            if (ebitdaTotalCell && totalRevenueTotalCell) {
                const totalRevenue = parseFloat(totalRevenueTotalCell.textContent.replace(/,/g, '')) || 0;
                const totalEbitda = parseFloat(ebitdaTotalCell.textContent.replace(/,/g, '')) || 0;
                fullYearEbitdaMargin = totalRevenue > 0 ? (totalEbitda / totalRevenue) * 100 : 0;
            }
            
            document.getElementById('forecastEbitdaMargin').textContent = `${fullYearEbitdaMargin.toFixed(1)}%`;
            document.getElementById('ebitdaMarginTrend').textContent = 'Full Year Total';
            
            console.log('Summary Card Calculations (from P&L table):', {
                revenueCMGR: revenueCMGR.toFixed(1) + '%',
                revenueJan: revenueJan.toLocaleString(),
                revenueDec: revenueDec.toLocaleString(),
                fullYearGrossMargin: fullYearGrossMargin.toFixed(1) + '%',
                fullYearEbitdaMargin: fullYearEbitdaMargin.toFixed(1) + '%'
            });
        }
        
        // Export function
        function exportForecastTrendingChart() {
            if (window.forecastTrendingChartInstance) {
                const link = document.createElement('a');
                link.download = 'forecast-trending-chart.png';
                link.href = window.forecastTrendingChartInstance.toBase64Image();
                link.click();
            }
        }

        // Update the generateAI2026Forecast function to calculate dynamic periods
        async function generateAI2026Forecast() {
            console.log(' Starting AI Forecast Generation for Next Year...');
            
            const industry = document.getElementById('forecast2026IndustrySelect').value;
            const additionalContext = document.getElementById('forecast2026Context').value;
            const forecastStyle = document.getElementById('forecast2026StyleSelect').value;
            
            if (!industry) {
                alert('Please select an industry for AI context');
                return;
            }
            
            // Show loading state
            const button = document.getElementById('generateAI2026Forecast');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Next Year Forecast...';
            button.disabled = true;
            
            try {
                // Get dynamic date context
                const dateContext = getDateContext();
                const { currentYear, actualEndMonth, years } = dateContext;
                
                // Extract current year data (both actuals and forecast)
                const currentYearData = extractFullYearData();
                
                if (!currentYearData) {
                    alert('Please generate the current year forecast first');
                    button.innerHTML = originalText;
                    button.disabled = false;
                    return;
                }
                
                // Calculate dynamic periods
                const monthNames = dateContext.monthNames;
                let actualsPeriod, forecastPeriod;
                
                if (actualEndMonth >= 1) {
                    actualsPeriod = actualEndMonth === 1 ? 
                        `${monthNames[0]} ${currentYear}` : 
                        `${monthNames[0]}-${monthNames[actualEndMonth - 1]} ${currentYear}`;
                } else {
                    actualsPeriod = `No actuals yet for ${currentYear}`;
                }
                
                const nextForecastStart = actualEndMonth + 1;
                if (nextForecastStart <= 12) {
                    forecastPeriod = nextForecastStart === 12 ? 
                        `${monthNames[11]} ${currentYear}` : 
                        `${monthNames[nextForecastStart - 1]}-${monthNames[11]} ${currentYear}`;
                } else {
                    forecastPeriod = `All months forecasted for ${currentYear}`;
                }
                
                console.log(' Dynamic periods calculated:', {
                    currentDate: `${currentYear}-${dateContext.currentMonth}-${dateContext.currentDay}`,
                    actualEndMonth,
                    nextForecastStart,
                    actualsPeriod,
                    forecastPeriod
                });
                
                // Prepare payload for next year forecast
                const payload = {
                    year: years.next,
                    industry: industry,
                    additionalContext: additionalContext,
                    forecastStyle: forecastStyle,
                    baselineData: {
                        [`year_${currentYear}_complete`]: currentYearData.monthlyData,
                        [`year_${currentYear}_totals`]: currentYearData.yearTotals,
                        actuals_period: actualsPeriod,
                        forecast_period: forecastPeriod,
                        actual_months_count: actualEndMonth,
                        forecast_months_count: 12 - actualEndMonth,
                        current_date: {
                            year: currentYear,
                            month: dateContext.currentMonth,
                            day: dateContext.currentDay,
                            include_current_month: dateContext.currentDay <= 25
                        }
                    },
                    requestType: `full_year_forecast_${years.next}`
                };
                
                console.log(` Sending ${years.next} forecast request:`, payload);
                
                // Call n8n webhook with updated endpoint
                const response = await fetch('https://n8n.srv909550.hstgr.cloud/webhook/ai-forecast-Y1', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log(` ${years.next} AI forecast response:`, result);
                
                // Handle array response format from backend
                const aiResult = Array.isArray(result) ? result[0] : result;
                
                // Process the AI result
                if (aiResult.success && aiResult.forecast_data) {
                    if (aiResult.forecast_data && aiResult.forecast_data.monthly_forecasts) {
                        console.log(` ${years.next} forecast generated successfully`);
                        
                        // Populate the next year table with correct data structure
                        populate2026TableWithAI(aiResult);
                        
                        // Update summary cards (optional - skip if function doesn't exist)
                        try {
                            if (typeof updateNextYearSummaryCards === 'function') {
                                updateNextYearSummaryCards(aiResult);
                            } else {
                                console.log(' updateNextYearSummaryCards function not found - skipping summary card update');
                            }
                        } catch (summaryError) {
                            console.warn(' Error updating summary cards:', summaryError);
                        }
                        
                        // Save to Supabase first, then show success
                        console.log(' About to save 2026 forecast to Supabase...', aiResult);
                        try {
                            await save2026ForecastToSupabase(aiResult);
                            console.log(' 2026 forecast saved to Supabase successfully');
                            
                            // Show success message only after successful save
                            alert(`${years.next} AI forecast generated and saved successfully!`);
                        } catch (saveError) {
                            console.error(' Error saving 2026 forecast to Supabase:', saveError);
                            console.error(' Save error details:', saveError.message, saveError.stack);
                            
                            // Still show success for the forecast generation, but warn about save issue
                            alert(`${years.next} AI forecast generated successfully, but there was an issue saving to database: ${saveError.message}`);
                        }
                        
                    } else {
                        throw new Error(aiResult?.message || `Failed to generate ${years.next} forecast - invalid response format`);
                    }
                    
                } else {
                    throw new Error(aiResult?.message || `Failed to generate ${years.next} forecast - invalid response format`);
                }
                
            } catch (error) {
                const dateContext = getDateContext(); // Define it here if needed
                console.error(` Error generating ${dateContext.years.next} forecast:`, error);
                alert(`Failed to generate next year forecast: ${error.message}`);
            } finally {
                // Reset button state
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        // Fix the extractFullYearData function with dynamic actual/forecast periods
        function extractFullYearData() {
            const monthlyBreakdown = [];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            // Calculate dynamic cutoff based on current date
            const now = new Date();
            const currentMonth = now.getMonth() + 1; // 1-12
            const currentDay = now.getDate();
            const includeCurrentMonth = currentDay <= 25;
            const actualEndMonth = includeCurrentMonth ? currentMonth : currentMonth - 1;
            
            // Get data directly from the total rows using their IDs
            const totalRevenueRow = document.querySelector('#totalRevenue-total')?.closest('tr');
            const totalCogsRow = document.querySelector('#totalCOGS-total')?.closest('tr');
            const totalOpexRow = document.querySelector('#totalOPEX-total')?.closest('tr');
            
            if (!totalRevenueRow || !totalCogsRow || !totalOpexRow) {
                console.error(' Could not find total rows. Please generate forecast first.');
                return null;
            }
            
            for (let i = 0; i < 12; i++) {
                const monthNumber = i + 1;
                const revenueCells = totalRevenueRow.querySelectorAll('td');
                const cogsCells = totalCogsRow.querySelectorAll('td');
                const opexCells = totalOpexRow.querySelectorAll('td');
                
                const revenue = parseFloat(revenueCells[i + 1]?.textContent.replace(/,/g, '')) || 0;
                const cogs = parseFloat(cogsCells[i + 1]?.textContent.replace(/,/g, '')) || 0;
                const opex = parseFloat(opexCells[i + 1]?.textContent.replace(/,/g, '')) || 0;
                
                monthlyBreakdown.push({
                    month: `2025-${String(monthNumber).padStart(2, '0')}`,
                    year: 2025,
                    month_number: monthNumber,
                    month_name: months[i],
                    revenue: revenue,
                    cogs: cogs,
                    opex: opex,
                    gross_profit: revenue - cogs,
                    ebitda: revenue - cogs - opex,
                    is_actual: monthNumber <= actualEndMonth,
                    is_forecast: monthNumber > actualEndMonth,
                    gross_margin: revenue > 0 ? ((revenue - cogs) / revenue) * 100 : 0,
                    ebitda_margin: revenue > 0 ? ((revenue - cogs - opex) / revenue) * 100 : 0
                });
            }
            
            // Calculate year totals
            const yearTotals = {
                totalRevenue: monthlyBreakdown.reduce((sum, month) => sum + month.revenue, 0),
                totalCogs: monthlyBreakdown.reduce((sum, month) => sum + month.cogs, 0),
                totalOpex: monthlyBreakdown.reduce((sum, month) => sum + month.opex, 0),
                totalGrossProfit: monthlyBreakdown.reduce((sum, month) => sum + month.gross_profit, 0),
                totalEbitda: monthlyBreakdown.reduce((sum, month) => sum + month.ebitda, 0)
            };
            
            yearTotals.grossMargin = (yearTotals.totalGrossProfit / yearTotals.totalRevenue) * 100;
            yearTotals.ebitdaMargin = (yearTotals.totalEbitda / yearTotals.totalRevenue) * 100;
            
            console.log(' Dynamic periods:', {
                currentMonth,
                actualEndMonth,
                actualsCount: monthlyBreakdown.filter(m => m.is_actual).length,
                forecastCount: monthlyBreakdown.filter(m => m.is_forecast).length
            });
            
            return {
                monthlyData: monthlyBreakdown,
                yearTotals: yearTotals
            };
        }
        
        // Update the populate2026TableWithAI function to handle the new backend response
        function populate2026TableWithAI(aiResult) {
            const tbody = document.getElementById('plForecast2026Body');
            if (!tbody) return;
            
            // Clear existing content
            tbody.innerHTML = '';
            
            if (!aiResult.forecast_data || !aiResult.forecast_data.monthly_forecasts) {
                console.error(' Invalid AI result format');
                return;
            }
            
            const monthlyForecasts = aiResult.forecast_data.monthly_forecasts;
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            // Calculate totals for each month and line item
            const salesRevenue = monthlyForecasts.map(m => Math.round(m.revenue_accounts['4010'] || 0));
            const serviceRevenue = monthlyForecasts.map(m => Math.round(m.revenue_accounts['4020'] || 0));
            const directCosts = monthlyForecasts.map(m => Math.round(m.cogs_accounts['5010'] || 0));
            const operatingExpenses = monthlyForecasts.map(m => Math.round(m.opex_accounts['5100'] || 0));
            
            // Calculate derived values
            const totalRevenue = salesRevenue.map((sr, i) => sr + serviceRevenue[i]);
            const totalCogs = directCosts;
            const grossProfit = totalRevenue.map((tr, i) => tr - totalCogs[i]);
            const totalOpex = operatingExpenses;
            const ebitda = grossProfit.map((gp, i) => gp - totalOpex[i]);
            
            // Calculate totals
            const salesRevenueTotal = salesRevenue.reduce((sum, val) => sum + val, 0);
            const serviceRevenueTotal = serviceRevenue.reduce((sum, val) => sum + val, 0);
            const totalRevenueTotal = totalRevenue.reduce((sum, val) => sum + val, 0);
            const totalCogsTotal = totalCogs.reduce((sum, val) => sum + val, 0);
            const grossProfitTotal = grossProfit.reduce((sum, val) => sum + val, 0);
            const totalOpexTotal = totalOpex.reduce((sum, val) => sum + val, 0);
            const ebitdaTotal = ebitda.reduce((sum, val) => sum + val, 0);
            
            // Build the table with exact same structure as 2025
            tbody.innerHTML = `
                <!-- REVENUE SECTION -->
                <tr class="section-header-row">
                    <td colspan="14" class="section-header">
                        <i class="fas fa-dollar-sign"></i> REVENUE
                    </td>
                </tr>
                <tr id="salesRevenue2026">
                    <td class="line-item">Sales Revenue</td>
                    ${salesRevenue.map(val => `<td class="forecast-cell">${val.toLocaleString()}</td>`).join('')}
                    <td class="total-cell" id="salesRevenue2026-total">${salesRevenueTotal.toLocaleString()}</td>
                </tr>
                <tr id="serviceRevenue2026">
                    <td class="line-item">Service Revenue</td>
                    ${serviceRevenue.map(val => `<td class="forecast-cell">${val.toLocaleString()}</td>`).join('')}
                    <td class="total-cell" id="serviceRevenue2026-total">${serviceRevenueTotal.toLocaleString()}</td>
                </tr>
                <tr id="totalRevenue2026" class="total-row">
                    <td class="line-item total-line">Total Revenue</td>
                    ${totalRevenue.map(val => `<td class="total-cell">${val.toLocaleString()}</td>`).join('')}
                    <td class="total-cell total-prominent" id="totalRevenue2026-total">${totalRevenueTotal.toLocaleString()}</td>
                </tr>
        
                <!-- COGS SECTION -->
                <tr class="section-header-row">
                    <td colspan="14" class="section-header">
                        <i class="fas fa-box"></i> COST OF GOODS SOLD (COGS)
                    </td>
                </tr>
                <tr id="directCosts2026">
                    <td class="line-item">Direct Costs</td>
                    ${directCosts.map(val => `<td class="forecast-cell">${val.toLocaleString()}</td>`).join('')}
                    <td class="total-cell" id="directCosts2026-total">${totalCogsTotal.toLocaleString()}</td>
                </tr>
                <tr id="totalCOGS2026" class="total-row">
                    <td class="line-item total-line">Total COGS</td>
                    ${totalCogs.map(val => `<td class="total-cell">${val.toLocaleString()}</td>`).join('')}
                    <td class="total-cell total-prominent" id="totalCOGS2026-total">${totalCogsTotal.toLocaleString()}</td>
                </tr>
                <tr id="grossProfit2026" class="calculated-row">
                    <td class="line-item calculated-line">Gross Profit</td>
                    ${grossProfit.map(val => `<td class="calculated-cell">${val.toLocaleString()}</td>`).join('')}
                    <td class="calculated-cell calculated-prominent" id="grossProfit2026-total">${grossProfitTotal.toLocaleString()}</td>
                </tr>
        
                <!-- OPEX SECTION -->
                <tr class="section-header-row">
                    <td colspan="14" class="section-header">
                        <i class="fas fa-cogs"></i> OPERATING EXPENSES (OPEX)
                    </td>
                </tr>
                <tr id="operatingExpenses2026">
                    <td class="line-item">Operating Expenses</td>
                    ${operatingExpenses.map(val => `<td class="forecast-cell">${val.toLocaleString()}</td>`).join('')}
                    <td class="total-cell" id="operatingExpenses2026-total">${totalOpexTotal.toLocaleString()}</td>
                </tr>
                <tr id="totalOPEX2026" class="total-row">
                    <td class="line-item total-line">Total OPEX</td>
                    ${totalOpex.map(val => `<td class="total-cell">${val.toLocaleString()}</td>`).join('')}
                    <td class="total-cell total-prominent" id="totalOPEX2026-total">${totalOpexTotal.toLocaleString()}</td>
                </tr>
                <tr id="ebitda2026" class="calculated-row">
                    <td class="line-item calculated-line">EBITDA</td>
                    ${ebitda.map(val => `<td class="calculated-cell">${val.toLocaleString()}</td>`).join('')}
                    <td class="calculated-cell calculated-prominent" id="ebitda2026-total">${ebitdaTotal.toLocaleString()}</td>
                </tr>
        
                <!-- MARGIN ANALYSIS -->
                <tr class="pl-margin-row">
                    <td class="pl-margin-line">Gross Margin %</td>
                    ${grossProfit.map((gp, i) => {
                        const margin = totalRevenue[i] > 0 ? (gp / totalRevenue[i] * 100).toFixed(1) : '0.0';
                        return `<td class="pl-margin-cell">${margin}%</td>`;
                    }).join('')}
                    <td class="pl-margin-cell pl-margin-prominent">${(grossProfitTotal / totalRevenueTotal * 100).toFixed(1)}%</td>
                </tr>
                <tr class="pl-margin-row">
                    <td class="pl-margin-line">EBITDA Margin %</td>
                    ${ebitda.map((eb, i) => {
                        const margin = totalRevenue[i] > 0 ? (eb / totalRevenue[i] * 100).toFixed(1) : '0.0';
                        return `<td class="pl-margin-cell">${margin}%</td>`;
                    }).join('')}
                    <td class="pl-margin-cell pl-margin-prominent">${(ebitdaTotal / totalRevenueTotal * 100).toFixed(1)}%</td>
                </tr>
        
                <!-- AI CONFIDENCE FOOTER -->
                <tr class="growth-assumptions-row">
                    <td colspan="14" style="background: #f0f9ff; padding: 1rem; text-align: center; font-weight: 600; color: #1e40af;">
                        <i class="fas fa-brain"></i> AI Forecast Confidence: ${aiResult.confidence || 'N/A'}% | ${aiResult.insights?.key_trends ? 'Based on historical trends &amp; additional context' : 'AI-generated forecast'}
                    </td>
                </tr>
            `;
            
            console.log(' 2026 forecast table populated with AI data - matching 2025 structure');
            
            // Show insights if available
            if (aiResult.insights) {
                show2026Insights(aiResult.insights, aiResult);
            }
        }
        
        // Fixed function to show 2026 insights with dynamic confidence and methodology
        function show2026Insights(insights, aiResult) {
            console.log(' Displaying 2026 AI Insights...', { insights, confidence: aiResult.confidence });
            
            // Create or find the insights container for 2026
            let insightsContainer = document.getElementById('ai2026InsightsContainer');
            
            if (!insightsContainer) {
                // Create the insights container after the 2026 table
                const table2026Container = document.getElementById('next-year-container');
                
                insightsContainer = document.createElement('div');
                insightsContainer.id = 'ai2026InsightsContainer';
                insightsContainer.className = 'ai-insights-container';
                insightsContainer.style.marginTop = '2rem';
                
                // Insert after the table container
                table2026Container.parentNode.insertBefore(insightsContainer, table2026Container.nextSibling);
            }
            
            // Get dynamic confidence and date
            const confidence = aiResult.confidence || 75;
            const generatedDate = new Date(aiResult.generated_at || new Date()).toLocaleDateString();
            
            // Populate with dynamic data
            insightsContainer.innerHTML = `
                <div class="insights-header-AIinsight">
                    <h4><i class="fas fa-brain"></i> 2026 AI Analysis & Insights</h4>
                    <div class="insights-meta">
                        <span class="confidence-badge">Confidence: ${confidence}%</span>
                        <span class="forecast-date">Generated: ${generatedDate}</span>
                    </div>
                </div>
                
                <div class="insights-content">
                    <div class="insight-card key-trends-card">
                        <div class="insight-header">
                            <i class="fas fa-chart-line insight-icon"></i>
                            <h5>Key Trends & Growth Drivers</h5>
                        </div>
                        <div class="insight-text">
                            ${formatInsightText(insights.key_trends || 'No key trends identified.')}
                        </div>
                    </div>
                    
                    <div class="insight-card risk-factors-card">
                        <div class="insight-header">
                            <i class="fas fa-exclamation-triangle insight-icon"></i>
                            <h5>Risk Factors & Considerations</h5>
                        </div>
                        <div class="insight-text">
                            ${formatInsightText(insights.risk_factors || 'No risk factors identified.')}
                        </div>
                    </div>
                    
                    <div class="insight-card opportunities-card">
                        <div class="insight-header">
                            <i class="fas fa-lightbulb insight-icon"></i>
                            <h5>Growth Opportunities</h5>
                        </div>
                        <div class="insight-text">
                            ${formatInsightText(insights.opportunities || 'No opportunities identified.')}
                        </div>
                    </div>
                    
                    <div class="insight-card methodology-card">
                        <div class="insight-header">
                            <i class="fas fa-cogs insight-icon"></i>
                            <h5>Forecast Methodology</h5>
                        </div>
                        <div class="insight-text">
                            ${formatInsightText(aiResult.methodology || insights.methodology || 'AI-based forecast methodology using historical trends and industry analysis.')}
                        </div>
                    </div>
                </div>
                
                <style>
                .insights-content {
                    padding: 2rem;
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 1.5rem;
                    background: #fafbfc;
                }
        
                @media (min-width: 1200px) {
                    .insights-content {
                        grid-template-columns: 1fr 1fr;
                    }
                }
                </style>
            `;
            
            // Show the insights container
            insightsContainer.style.display = 'block';
            
            console.log(' 2026 insights displayed with dynamic data');
            
            // Create separate trending chart container
            create2026TrendingContainer();
            
            // Generate the 2026 trending chart
            generate2026ForecastTrendingChart();
        }

        function create2026TrendingContainer() {
            let trendingContainer = document.getElementById('forecast2026TrendingContainer');
            
            if (!trendingContainer) {
                // Find where to insert the trending container
                const insightsContainer = document.getElementById('ai2026InsightsContainer');
                
                trendingContainer = document.createElement('div');
                trendingContainer.id = 'forecast2026TrendingContainer';
                trendingContainer.style.cssText = `
                    margin-top: 2rem;
                    background: white;
                    border: 1px solid #e5e7eb;
                    border-radius: 12px;
                    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
                `;
                
                // Insert after the insights container
                insightsContainer.parentNode.insertBefore(trendingContainer, insightsContainer.nextSibling);
            }
            
            // Populate the trending container
            trendingContainer.innerHTML = `
                <div class="trending-chart-header">
                    <div class="trending-title-section">
                        <h4>2026 Financial Trends Analysis</h4>
                        <p class="trending-subtitle">Monthly revenue, COGS, and OPEX projections with growth patterns</p>
                    </div>
                    <button class="btn btn-secondary" onclick="export2026TrendingChart()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
                <div class="trending-chart-divider"></div>
                <div class="trending-chart-container">
                    <canvas id="forecast2026TrendingChart" width="800" height="400"></canvas>
                </div>
                
                <!-- Enhanced Metrics Summary for 2026 -->
                <div class="breakdown-summary-row" style="margin-top: 1.5rem;">
                    <div class="summary-card revenue">
                        <div class="summary-header">
                            <h4>Projected Growth</h4>
                            <span class="summary-amount" id="forecast2026RevenueGrowth">+0%</span>
                        </div>
                        <div class="summary-change positive" id="revenue2026GrowthDirection">vs 2025</div>
                    </div>
                    <div class="summary-card efficiency">
                        <div class="summary-header">
                            <h4>Avg Gross Margin</h4>
                            <span class="summary-amount" id="forecast2026GrossMargin">0%</span>
                        </div>
                        <div class="summary-change" id="grossMargin2026Trend">2026 Average</div>
                    </div>
                    <div class="summary-card opex">
                        <div class="summary-header">
                            <h4>Avg EBITDA Margin</h4>
                            <span class="summary-amount" id="forecast2026EbitdaMargin">0%</span>
                        </div>
                        <div class="summary-change" id="ebitdaMargin2026Trend">2026 Average</div>
                    </div>
                </div>
            `;
            
            // Show the trending container
            trendingContainer.style.display = 'block';
        }

        function generate2026ForecastTrendingChart() {
            const canvas = document.getElementById('forecast2026TrendingChart');
            if (!canvas) return;
            
            // Destroy existing chart if it exists
            if (window.forecast2026TrendingChartInstance) {
                window.forecast2026TrendingChartInstance.destroy();
            }
            
            // Extract data from 2026 table
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const revenueData = [];
            const grossProfitData = [];
            const opexData = [];
            const ebitdaData = [];
            
            // Get data from total rows
            const totalRevenueRow = document.querySelector('#totalRevenue2026-total')?.closest('tr');
            const grossProfitRow = document.querySelector('#grossProfit2026-total')?.closest('tr');
            const totalOpexRow = document.querySelector('#totalOPEX2026-total')?.closest('tr');
            const ebitdaRow = document.querySelector('#ebitda2026-total')?.closest('tr');
            
            if (totalRevenueRow && grossProfitRow && totalOpexRow && ebitdaRow) {
                for (let i = 1; i <= 12; i++) {
                    const revenue = parseFloat(totalRevenueRow.cells[i]?.textContent.replace(/,/g, '')) || 0;
                    const grossProfit = parseFloat(grossProfitRow.cells[i]?.textContent.replace(/,/g, '')) || 0;
                    const opex = parseFloat(totalOpexRow.cells[i]?.textContent.replace(/,/g, '')) || 0;
                    const ebitda = parseFloat(ebitdaRow.cells[i]?.textContent.replace(/,/g, '')) || 0;
                    
                    revenueData.push(revenue / 1000000); // Convert to millions
                    grossProfitData.push(grossProfit / 1000000);
                    opexData.push(opex / 1000000);
                    ebitdaData.push(ebitda / 1000000);
                }
            }
            
            const ctx = canvas.getContext('2d');
            window.forecast2026TrendingChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Revenue (Net)',
                            data: revenueData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Gross Profit',
                            data: grossProfitData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'OPEX',
                            data: opexData,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'EBITDA',
                            data: ebitdaData,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '2026 Monthly Financial Projections',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (Millions IDR)'
                            }
                        }
                    }
                }
            });
            
            // Calculate and display summary metrics
            calculate2026SummaryMetrics(revenueData, grossProfitData, opexData, ebitdaData);
        }

        function calculate2026SummaryMetrics(revenueData, grossProfitData, opexData, ebitdaData) {
            if (revenueData.length === 0) return;
            
            const totalRevenue = revenueData.reduce((sum, val) => sum + val, 0);
            const totalGrossProfit = grossProfitData.reduce((sum, val) => sum + val, 0);
            const totalOpex = opexData.reduce((sum, val) => sum + val, 0);
            const totalEbitda = ebitdaData.reduce((sum, val) => sum + val, 0);
            
            // Calculate year-over-year growth (vs 2025)
            const revenueGrowth = 15; // You can calculate this from actual 2025 vs 2026 data
            
            const grossMargin = totalRevenue > 0 ? (totalGrossProfit / totalRevenue) * 100 : 0;
            const ebitdaMargin = totalRevenue > 0 ? (totalEbitda / totalRevenue) * 100 : 0;
            
            // Update summary cards
            document.getElementById('forecast2026RevenueGrowth').textContent = `+${revenueGrowth.toFixed(1)}%`;
            document.getElementById('forecast2026GrossMargin').textContent = `${grossMargin.toFixed(1)}%`;
            document.getElementById('forecast2026EbitdaMargin').textContent = `${ebitdaMargin.toFixed(1)}%`;
            
            // Update trend descriptions
            document.getElementById('revenue2026GrowthDirection').textContent = 'vs 2025';
            document.getElementById('grossMargin2026Trend').textContent = '2026 Average';
            document.getElementById('ebitdaMargin2026Trend').textContent = '2026 Average';
        }
        
        // Export function for 2026 chart
        function export2026TrendingChart() {
            if (window.forecast2026TrendingChartInstance) {
                const link = document.createElement('a');
                link.download = '2026-forecast-trending-chart.png';
                link.href = window.forecast2026TrendingChartInstance.toBase64Image();
                link.click();
            }
        }

        async function save2026ForecastToSupabase(aiResult) {
            try {
                console.log(' Saving 2026 forecast to Supabase...');
                
                // Get current user
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    throw new Error('User not authenticated');
                }
                
                if (!aiResult.forecast_data || !aiResult.forecast_data.monthly_forecasts) {
                    throw new Error('Invalid AI result format');
                }
                
                // Get form data
                const industry = document.getElementById('forecast2026IndustrySelect')?.value || '';
                const additionalContext = document.getElementById('forecast2026Context')?.value || '';
                const forecastStyle = document.getElementById('forecast2026StyleSelect')?.value || 'normal';
                
                const monthlyForecasts = aiResult.forecast_data.monthly_forecasts;
                
                // Calculate totals
                let totalRevenue = 0, totalCogs = 0, totalOpex = 0, totalGrossProfit = 0, totalEbitda = 0;
                
                const monthlyData = monthlyForecasts.map(month => {
                    const salesRevenue = month.revenue_accounts?.['4010'] || 0;
                    const serviceRevenue = month.revenue_accounts?.['4020'] || 0;
                    const directCosts = month.cogs_accounts?.['5010'] || 0;
                    const operatingExpenses = month.opex_accounts?.['5100'] || 0;
                    
                    const monthTotalRevenue = salesRevenue + serviceRevenue;
                    const monthTotalCogs = directCosts + (month.cogs_accounts?.['5020'] || 0);
                    const monthTotalOpex = operatingExpenses + (month.opex_accounts?.['5110'] || 0);
                    const monthGrossProfit = monthTotalRevenue - monthTotalCogs;
                    const monthEbitda = monthGrossProfit - monthTotalOpex;
                    
                    // Add to running totals
                    totalRevenue += monthTotalRevenue;
                    totalCogs += monthTotalCogs;
                    totalOpex += monthTotalOpex;
                    totalGrossProfit += monthGrossProfit;
                    totalEbitda += monthEbitda;
                    
                    return {
                        month_number: month.month,
                        month_name: month.month_name,
                        sales_revenue: salesRevenue,
                        service_revenue: serviceRevenue,
                        direct_costs: directCosts,
                        operating_expenses: operatingExpenses,
                        total_revenue: monthTotalRevenue,
                        total_cogs: monthTotalCogs,
                        total_opex: monthTotalOpex,
                        gross_profit: monthGrossProfit,
                        ebitda: monthEbitda
                    };
                });
                
                // Prepare forecast data matching the exact table structure
                const forecastData = {
                    user_id: user.id,
                    forecast_year: 2026,
                    forecast_type: 'full_year_ai_forecast',
                    industry_context: industry,
                    additional_context: additionalContext,
                    forecast_style: forecastStyle,
                    confidence_level: aiResult.confidence || 75,
                    generated_at: aiResult.generated_at || new Date().toISOString(),
                    monthly_data: monthlyData,
                    year_totals: {
                        total_revenue: totalRevenue,
                        total_cogs: totalCogs,
                        total_opex: totalOpex,
                        gross_margin: totalRevenue > 0 ? ((totalGrossProfit / totalRevenue) * 100) : 0,
                        gross_profit: totalGrossProfit,
                        ebitda_margin: totalRevenue > 0 ? ((totalEbitda / totalRevenue) * 100) : 0,
                        ebitda: totalEbitda
                    },
                    ai_insights: {
                        key_trends: aiResult.insights?.key_trends || '',
                        risk_factors: aiResult.insights?.risk_factors || '',
                        opportunities: aiResult.insights?.opportunities || '',
                        methodology: aiResult.methodology || aiResult.insights?.methodology || ''
                    },
                    baseline_year: 2025,
                    model_version: aiResult.model_version || 'ai-agent-v1',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                console.log(' Saving forecast data:', forecastData);
                
                // Save to Supabase
                const { data, error } = await supabase
                    .from('ai_forecasts_2026_meridash')
                    .insert([forecastData])
                    .select();
                
                if (error) {
                    console.error(' Supabase insert error:', error);
                    throw error;
                }
        
                if (data && data.length > 0) {
                    trackLatestForecastId(data[0].id, 'ai_forecasts_2026_meridash');
                    console.log(' 2026 forecast saved to Supabase:', data[0]);
                    return data[0];
                } else {
                    throw new Error('No data returned from Supabase insert');
                }
                
            } catch (error) {
                console.error(' Error saving 2026 forecast to Supabase:', error);
                throw error;
            }
        }
        
        // Helper function to populate table with forecast data
        function populateTableWithForecastData(tbody, forecastData, year) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            // Create rows based on forecast data structure
            Object.keys(forecastData).forEach(lineItem => {
                const monthlyData = forecastData[lineItem];
                const annual = monthlyData.reduce((sum, val) => sum + val, 0);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 500; padding: 0.5rem 1rem;">${lineItem}</td>
                    ${monthlyData.map(val => `<td style="text-align: right; padding: 0.5rem;">${Math.round(val).toLocaleString()}</td>`).join('')}
                    <td style="text-align: right; font-weight: 600; background: #fef3c7; padding: 0.5rem;">${Math.round(annual).toLocaleString()}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        async function loadLatest2026ForecastFromSupabase() {
            try {
                console.log(' Loading latest 2026 forecast from Supabase...');
                
                // Get current user
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    alert('Please log in to load forecasts');
                    return;
                }
                
                // Query the latest 2026 forecast
                const { data, error } = await supabase
                    .from('ai_forecasts_2026_meridash')
                    .select('*')
                    .eq('user_id', user.id)
                    .eq('forecast_year', 2026)
                    .order('generated_at', { ascending: false })
                    .limit(1);
                
                if (error) {
                    throw error;
                }
                
                if (!data || data.length === 0) {
                    alert('No 2026 forecasts found. Generate a forecast first.');
                    return;
                }
                
                const latestForecast = data[0];
                console.log(' Latest 2026 forecast loaded:', latestForecast);
                
                // Convert Supabase data back to AI result format
                const aiResult = {
                    success: true,
                    confidence: latestForecast.confidence_level,
                    forecast_data: {
                        monthly_forecasts: latestForecast.monthly_data.map(month => ({
                            month: month.month_number,
                            month_name: month.month_name,
                            revenue_accounts: {
                                '4010': month.sales_revenue,
                                '4020': month.service_revenue
                            },
                            cogs_accounts: {
                                '5010': month.direct_costs,
                                '5020': 0
                            },
                            opex_accounts: {
                                '5100': month.operating_expenses,
                                '5110': 0
                            }
                        }))
                    },
                    insights: latestForecast.ai_insights,
                    generated_at: latestForecast.generated_at,
                    model_version: latestForecast.model_version || 'ai-agent-v1'
                };
                
                // Populate the 2026 table with loaded data
                populate2026TableWithAI(aiResult);
                
                // Restore the form values
                document.getElementById('forecast2026IndustrySelect').value = latestForecast.industry_context || '';
                document.getElementById('forecast2026Context').value = latestForecast.additional_context || '';
                
                // Show success notification
                showForecastLoadedNotification(new Date(latestForecast.generated_at));
                
                console.log(' 2026 forecast loaded and displayed successfully');
                
            } catch (error) {
                console.error(' Error loading 2026 forecast:', error);
                alert('Failed to load 2026 forecast. Please try again.');
            }
        }

        async function show2026ForecastHistory() {
            try {
                console.log(' Loading 2026 forecast history...');
                
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    alert('Please log in to view forecast history');
                    return;
                }
                
                const { data, error } = await supabase
                    .from('ai_forecasts_2026_meridash')
                    .select('id, generated_at, confidence_level, industry_context, additional_context')
                    .eq('user_id', user.id)
                    .eq('forecast_year', 2026)
                    .order('generated_at', { ascending: false });
                
                if (error) {
                    throw error;
                }
                
                if (!data || data.length === 0) {
                    alert('No 2026 forecast history found.');
                    return;
                }
                
                console.log(' 2026 forecast history:', data);
                
                // You can implement a modal or dropdown to show the history
                // For now, just log it
                data.forEach((forecast, index) => {
                    console.log(`${index + 1}. ${new Date(forecast.generated_at).toLocaleDateString()} - ${forecast.industry_context} - ${forecast.confidence_level}%`);
                });
                
            } catch (error) {
                console.error(' Error loading 2026 forecast history:', error);
            }
        }

        async function generateAIMultiYearForecast() {
            console.log(' Starting Multi-Year AI Forecast Generation (2027-2030)...');
            
            const industry = document.getElementById('forecastMultiYearIndustrySelect').value;
            const additionalContext = document.getElementById('forecastMultiYearContext').value;
            const forecastStyle = document.getElementById('forecastMultiYearStyleSelect').value;
            
            if (!industry) {
                alert('Please select an industry for AI context');
                return;
            }
            
            // Show loading state
            const button = document.getElementById('generateAIMultiYearForecast');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Multi-Year Forecast...';
            button.disabled = true;
            
            try {
                // Extract baseline data from 2025 and 2026 forecasts
                const baselineData = extractMultiYearBaselineData();
                
                if (!baselineData) {
                    alert('Please generate 2025 and 2026 forecasts first to establish baseline data');
                    button.innerHTML = originalText;
                    button.disabled = false;
                    return;
                }
                
                // Prepare the API payload
                const payload = {
                    baseline_data: baselineData,
                    forecast_years: [2027, 2028, 2029, 2030],
                    forecast_period: 'quarterly',
                    industry_context: industry,
                    forecast_style: forecastStyle,
                    additional_context: additionalContext,
                    timestamp: new Date().toISOString()
                };
                
                console.log(' Sending multi-year forecast request:', payload);
                
                // Call the AI endpoint
                const response = await fetch('https://n8n.srv909550.hstgr.cloud/webhook/ai-forecast-Y2-Y5', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const responseData = await response.json();
                console.log(' Multi-year AI forecast response:', responseData);
                
                // Handle array response - extract first element if response is an array
                let aiResult;
                if (Array.isArray(responseData)) {
                    console.log(' Response is array, extracting first element...');
                    aiResult = responseData[0];
                } else {
                    aiResult = responseData;
                }
                
                console.log(' Processed AI result:', aiResult);
                
                if (aiResult && aiResult.success) {
                    // Populate the multi-year tables with AI data
                    populateMultiYearTablesWithAI(aiResult);
                    
                    // Create the multi-year trending chart
                    createMultiYearTrendingChart(aiResult);
                    
                    // Show insights if available
                    if (aiResult.insights) {
                        showMultiYearInsights(aiResult.insights, aiResult);
                    }
                    
                    // Save to Supabase
                    await saveMultiYearForecastToSupabase(aiResult);
                    
                    console.log(' Multi-year forecast generated and saved successfully');
                    
                    // Show success notification
                    showSuccessNotification('Multi-year forecast generated successfully!');
                    
                } else {
                    throw new Error(aiResult?.message || 'Failed to generate multi-year forecast - invalid response format');
                }
                
            } catch (error) {
                console.error(' Error generating multi-year forecast:', error);
                alert(`Failed to generate multi-year forecast: ${error.message}`);
            } finally {
                // Reset button state
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        function extractMultiYearBaselineData() {
            // Extract 2025 data from current year table
            const currentYearData = extractFullYearData();
            
            // Extract 2026 data from next year table
            const nextYearData = extract2026Data();
            
            if (!currentYearData || !nextYearData) {
                return null;
            }
            
            return {
                year_2025: currentYearData,
                year_2026: nextYearData,
                baseline_established: true
            };
        }
        
        function extract2026Data() {
            const tbody = document.getElementById('plForecast2026Body');
            if (!tbody || tbody.querySelector('.placeholder-row')) {
                return null;
            }
            
            const data = {
                year: 2026,
                monthly_data: [],
                year_totals: {}
            };
            
            // Extract monthly data from 2026 table (similar to existing extraction logic)
            const rows = tbody.querySelectorAll('tr:not(.placeholder-row)');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            // Initialize monthly data structure
            months.forEach((month, index) => {
                data.monthly_data.push({
                    month: index + 1,
                    month_name: month,
                    revenue: 0,
                    cogs: 0,
                    opex: 0,
                    gross_profit: 0,
                    ebitda: 0
                });
            });
            
            // Extract data from table rows
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 14) { // 12 months + line item + total
                    const lineItem = cells[0].textContent.trim();
                    
                    // Process revenue, cogs, opex based on line item
                    for (let i = 1; i <= 12; i++) {
                        const value = parseFloat(cells[i].textContent.replace(/,/g, '')) || 0;
                        const monthIndex = i - 1;
                        
                        if (lineItem.includes('Revenue') || lineItem.includes('Sales')) {
                            data.monthly_data[monthIndex].revenue += value;
                        } else if (lineItem.includes('COGS') || lineItem.includes('Cost')) {
                            data.monthly_data[monthIndex].cogs += value;
                        } else if (lineItem.includes('Operating') || lineItem.includes('OPEX')) {
                            data.monthly_data[monthIndex].opex += value;
                        }
                    }
                }
            });
            
            // Calculate derived metrics
            data.monthly_data.forEach(month => {
                month.gross_profit = month.revenue - month.cogs;
                month.ebitda = month.gross_profit - month.opex;
            });
            
            // Calculate year totals
            data.year_totals = {
                total_revenue: data.monthly_data.reduce((sum, month) => sum + month.revenue, 0),
                total_cogs: data.monthly_data.reduce((sum, month) => sum + month.cogs, 0),
                total_opex: data.monthly_data.reduce((sum, month) => sum + month.opex, 0),
                total_gross_profit: data.monthly_data.reduce((sum, month) => sum + month.gross_profit, 0),
                total_ebitda: data.monthly_data.reduce((sum, month) => sum + month.ebitda, 0)
            };
            
            return data;
        }
        
        function populateMultiYearTablesWithAI(aiResult) {
            console.log(' Populating multi-year tables with AI data...');
            
            const years = [2027, 2028, 2029, 2030];
            
            years.forEach(year => {
                const yearData = aiResult.forecast_data[`year_${year}`];
                if (yearData && yearData.quarterly_forecasts) {
                    populateYearTable(year, yearData.quarterly_forecasts);
                }
            });
            
            console.log(' Multi-year tables populated successfully');
        }
        
        function populateYearTable(year, quarterlyData) {
            const tbody = document.getElementById(`plForecast${year}Body`);
            if (!tbody) return;
            
            console.log(` Populating ${year} table with data:`, quarterlyData);
            
            // Clear placeholder
            tbody.innerHTML = '';
            
            // Define line items structure with percentages
            const lineItems = [
                { name: 'Sales Revenue', id: 'sales-revenue', type: 'revenue' },
                { name: 'Service Revenue', id: 'service-revenue', type: 'revenue' },
                { name: 'Total Revenue', id: 'total-revenue', type: 'revenue', isBold: true },
                { name: 'Direct Costs (COGS)', id: 'direct-costs', type: 'cogs' },
                { name: 'Total COGS', id: 'total-cogs', type: 'cogs', isBold: true },
                { name: 'Gross Profit', id: 'gross-profit', type: 'calculated', isBold: true },
                { name: 'Gross Profit Margin %', id: 'gross-profit-margin', type: 'percentage', isPercentage: true },
                { name: 'Operating Expenses', id: 'operating-expenses', type: 'opex' },
                { name: 'Total OPEX', id: 'total-opex', type: 'opex', isBold: true },
                { name: 'OPEX to Sales %', id: 'opex-to-sales', type: 'percentage', isPercentage: true },
                { name: 'EBITDA', id: 'ebitda', type: 'calculated', isBold: true },
                { name: 'EBITDA Margin %', id: 'ebitda-margin', type: 'percentage', isPercentage: true }
            ];
            
            // Extract and calculate quarterly data - FIXED DATA EXTRACTION
            const quarterlyCalculations = quarterlyData.map((quarter, index) => {
                console.log(` Processing Q${quarter.quarter} data:`, quarter);
                
                // Extract values directly from the quarter object
                const salesRevenue = quarter.revenue_accounts?.['4010'] || 0;
                const serviceRevenue = quarter.revenue_accounts?.['4020'] || 0;
                const totalRevenue = salesRevenue + serviceRevenue;
                
                const directCosts = quarter.cogs_accounts?.['5010'] || 0;
                const totalCogs = directCosts + (quarter.cogs_accounts?.['5020'] || 0);
                
                const operatingExpenses = quarter.opex_accounts?.['5100'] || 0;
                const totalOpex = operatingExpenses + (quarter.opex_accounts?.['5110'] || 0);
                
                const grossProfit = totalRevenue - totalCogs;
                const ebitda = grossProfit - totalOpex;
                
                // Calculate percentages
                const grossProfitMargin = totalRevenue > 0 ? (grossProfit / totalRevenue) * 100 : 0;
                const opexToSales = totalRevenue > 0 ? (totalOpex / totalRevenue) * 100 : 0;
                const ebitdaMargin = totalRevenue > 0 ? (ebitda / totalRevenue) * 100 : 0;
                
                const calculations = {
                    quarter: quarter.quarter,
                    salesRevenue,
                    serviceRevenue,
                    totalRevenue,
                    directCosts,
                    totalCogs,
                    grossProfit,
                    grossProfitMargin,
                    operatingExpenses,
                    totalOpex,
                    opexToSales,
                    ebitda,
                    ebitdaMargin
                };
                
                console.log(` Q${quarter.quarter} calculations:`, calculations);
                return calculations;
            });
            
            // Calculate year totals
            const yearTotals = quarterlyCalculations.reduce((totals, quarter) => {
                return {
                    salesRevenue: totals.salesRevenue + quarter.salesRevenue,
                    serviceRevenue: totals.serviceRevenue + quarter.serviceRevenue,
                    totalRevenue: totals.totalRevenue + quarter.totalRevenue,
                    directCosts: totals.directCosts + quarter.directCosts,
                    totalCogs: totals.totalCogs + quarter.totalCogs,
                    grossProfit: totals.grossProfit + quarter.grossProfit,
                    operatingExpenses: totals.operatingExpenses + quarter.operatingExpenses,
                    totalOpex: totals.totalOpex + quarter.totalOpex,
                    ebitda: totals.ebitda + quarter.ebitda
                };
            }, {
                salesRevenue: 0, serviceRevenue: 0, totalRevenue: 0,
                directCosts: 0, totalCogs: 0, grossProfit: 0,
                operatingExpenses: 0, totalOpex: 0, ebitda: 0
            });
            
            // Calculate year percentage totals
            yearTotals.grossProfitMargin = yearTotals.totalRevenue > 0 ? (yearTotals.grossProfit / yearTotals.totalRevenue) * 100 : 0;
            yearTotals.opexToSales = yearTotals.totalRevenue > 0 ? (yearTotals.totalOpex / yearTotals.totalRevenue) * 100 : 0;
            yearTotals.ebitdaMargin = yearTotals.totalRevenue > 0 ? (yearTotals.ebitda / yearTotals.totalRevenue) * 100 : 0;
            
            console.log(` ${year} Year totals:`, yearTotals);
            
            // Build table rows
            lineItems.forEach(item => {
                const row = document.createElement('tr');
                if (item.isBold) row.classList.add('forecast-total-row');
                if (item.isPercentage) row.classList.add('percentage-row');
                
                let rowHTML = `<td class="pl-line-item ${item.isBold ? 'bold' : ''}">${item.name}</td>`;
                
                // Add quarterly data - FIXED VALUE MAPPING
                quarterlyCalculations.forEach(quarter => {
                    let value = 0;
                    
                    // Map the item.id to the correct property name
                    switch(item.id) {
                        case 'sales-revenue':
                            value = quarter.salesRevenue;
                            break;
                        case 'service-revenue':
                            value = quarter.serviceRevenue;
                            break;
                        case 'total-revenue':
                            value = quarter.totalRevenue;
                            break;
                        case 'direct-costs':
                            value = quarter.directCosts;
                            break;
                        case 'total-cogs':
                            value = quarter.totalCogs;
                            break;
                        case 'gross-profit':
                            value = quarter.grossProfit;
                            break;
                        case 'gross-profit-margin':
                            value = quarter.grossProfitMargin;
                            break;
                        case 'operating-expenses':
                            value = quarter.operatingExpenses;
                            break;
                        case 'total-opex':
                            value = quarter.totalOpex;
                            break;
                        case 'opex-to-sales':
                            value = quarter.opexToSales;
                            break;
                        case 'ebitda':
                            value = quarter.ebitda;
                            break;
                        case 'ebitda-margin':
                            value = quarter.ebitdaMargin;
                            break;
                        default:
                            value = 0;
                    }
                    
                    if (item.isPercentage) {
                        rowHTML += `<td class="pl-forecast-cell">${value.toFixed(1)}%</td>`;
                    } else {
                        rowHTML += `<td class="pl-forecast-cell ${item.isBold ? 'bold' : ''}">${value.toLocaleString()}</td>`;
                    }
                });
                
                // Add year total - FIXED VALUE MAPPING
                let yearValue = 0;
                switch(item.id) {
                    case 'sales-revenue':
                        yearValue = yearTotals.salesRevenue;
                        break;
                    case 'service-revenue':
                        yearValue = yearTotals.serviceRevenue;
                        break;
                    case 'total-revenue':
                        yearValue = yearTotals.totalRevenue;
                        break;
                    case 'direct-costs':
                        yearValue = yearTotals.directCosts;
                        break;
                    case 'total-cogs':
                        yearValue = yearTotals.totalCogs;
                        break;
                    case 'gross-profit':
                        yearValue = yearTotals.grossProfit;
                        break;
                    case 'gross-profit-margin':
                        yearValue = yearTotals.grossProfitMargin;
                        break;
                    case 'operating-expenses':
                        yearValue = yearTotals.operatingExpenses;
                        break;
                    case 'total-opex':
                        yearValue = yearTotals.totalOpex;
                        break;
                    case 'opex-to-sales':
                        yearValue = yearTotals.opexToSales;
                        break;
                    case 'ebitda':
                        yearValue = yearTotals.ebitda;
                        break;
                    case 'ebitda-margin':
                        yearValue = yearTotals.ebitdaMargin;
                        break;
                    default:
                        yearValue = 0;
                }
                
                if (item.isPercentage) {
                    rowHTML += `<td class="pl-total-cell">${yearValue.toFixed(1)}%</td>`;
                } else {
                    rowHTML += `<td class="pl-total-cell">${yearValue.toLocaleString()}</td>`;
                }
                
                row.innerHTML = rowHTML;
                tbody.appendChild(row);
            });
            
            console.log(` ${year} table populated successfully`);
        }
        
        function createMultiYearTrendingChart(aiResult) {
            console.log(' Creating multi-year trending chart...');
            
            // Find or create the trending section
            let trendingSection = document.getElementById('multiYearTrendingSection');
        
            if (!trendingSection) {
                trendingSection = document.createElement('div');
                trendingSection.id = 'multiYearTrendingSection';
                trendingSection.className = 'ro-analysis-panel-full';
                trendingSection.style.marginTop = '2rem';
                
                const multiYearContainer = document.getElementById('multi-year-container');
                multiYearContainer.parentNode.insertBefore(trendingSection, multiYearContainer.nextSibling);
            }
            
            // Set the correct HTML structure - INCLUDING summary cards
            trendingSection.innerHTML = `
                <div class="trending-chart-header">
                    <div class="trending-title-section">
                        <h4>Multi-Year Quarterly Trending Analysis (2027-2030)</h4>
                        <p class="trending-subtitle">Quarterly performance projection across 4 years</p>
                    </div>
                    <button class="btn btn-secondary" onclick="exportMultiYearTrendingChart()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
                <div class="trending-chart-divider"></div>
                <div class="trending-chart-container">
                    <canvas id="multiYearTrendingChart" width="800" height="400"></canvas>
                </div>
                
                <!-- Enhanced Metrics Summary for Multi-Year -->
                <div class="breakdown-summary-row" style="margin-top: 1.5rem;">
                    <div class="summary-card revenue">
                        <div class="summary-header">
                            <h4>CAGR (2027-2030)</h4>
                            <span class="summary-amount" id="multiYearRevenueCAGR">+0%</span>
                        </div>
                        <div class="summary-change positive" id="multiYearCAGRDirection">Compound Growth</div>
                    </div>
                    <div class="summary-card efficiency">
                        <div class="summary-header">
                            <h4>Avg Gross Margin</h4>
                            <span class="summary-amount" id="multiYearGrossMargin">0%</span>
                        </div>
                        <div class="summary-change" id="multiYearGrossMarginTrend">4-Year Average</div>
                    </div>
                    <div class="summary-card opex">
                        <div class="summary-header">
                            <h4>Avg EBITDA Margin</h4>
                            <span class="summary-amount" id="multiYearEbitdaMargin">0%</span>
                        </div>
                        <div class="summary-change" id="multiYearEbitdaMarginTrend">4-Year Average</div>
                    </div>
                </div>
            `;
            
            // Show the trending section
            trendingSection.style.display = 'block';
            
            const ctx = document.getElementById('multiYearTrendingChart').getContext('2d');
            
            // Prepare quarterly data for all 4 years (16 quarters)
            const quarters = [];
            const revenueData = [];
            const grossProfitData = [];
            const opexData = [];
            const ebitdaData = [];
            
            const years = [2027, 2028, 2029, 2030];
            
            years.forEach(year => {
                const yearData = aiResult.forecast_data[`year_${year}`];
                if (yearData && yearData.quarterly_forecasts) {
                    yearData.quarterly_forecasts.forEach((quarter, index) => {
                        quarters.push(`Q${index + 1} ${year}`);
                        
                        const revenue = (quarter.revenue_accounts?.['4010'] || 0) + (quarter.revenue_accounts?.['4020'] || 0);
                        const cogs = (quarter.cogs_accounts?.['5010'] || 0) + (quarter.cogs_accounts?.['5020'] || 0);
                        const opex = (quarter.opex_accounts?.['5100'] || 0) + (quarter.opex_accounts?.['5110'] || 0);
                        const grossProfit = revenue - cogs;
                        const ebitda = grossProfit - opex;
                        
                        revenueData.push(revenue);
                        grossProfitData.push(grossProfit);
                        opexData.push(opex);
                        ebitdaData.push(ebitda);
                    });
                }
            });
            
            // Destroy existing chart if it exists
            if (window.multiYearTrendingChartInstance) {
                window.multiYearTrendingChartInstance.destroy();
            }
            
            // Create the chart
            window.multiYearTrendingChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: quarters,
                    datasets: [
                        {
                            label: 'Revenue',
                            data: revenueData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.3)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        },
                        {
                            label: 'Gross Profit',
                            data: grossProfitData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.3)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            pointBackgroundColor: '#10b981',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        },
                        {
                            label: 'OPEX',
                            data: opexData,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.3)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            pointBackgroundColor: '#f59e0b',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        },
                        {
                            label: 'EBITDA',
                            data: ebitdaData,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.3)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            pointBackgroundColor: '#8b5cf6',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Multi-Year Quarterly Performance Trends (2027-2030)',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            color: '#374151',
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'center',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'rect',
                                padding: 20,
                                font: {
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#374151',
                            bodyColor: '#374151',
                            borderColor: '#e5e7eb',
                            borderWidth: 1,
                            cornerRadius: 8,
                            titleFont: {
                                weight: '600'
                            },
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(156, 163, 175, 0.2)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    // Format large numbers (billions)
                                    if (value >= 1000000000) {
                                        return (value / 1000000000).toFixed(1) + 'B';
                                    } else if (value >= 1000000) {
                                        return (value / 1000000).toFixed(0) + 'M';
                                    }
                                    return value.toLocaleString();
                                }
                            },
                            border: {
                                display: false
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(156, 163, 175, 0.2)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    size: 11
                                },
                                maxRotation: 45,
                                minRotation: 0
                            },
                            border: {
                                display: false
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    elements: {
                        point: {
                            hoverRadius: 6,
                            hoverBorderWidth: 3
                        }
                    }
                }
            });
            
            // Update summary metrics (now the elements exist)
            updateMultiYearSummaryMetrics(aiResult);
            
            console.log(' Multi-year trending chart created successfully');
        }
        
        function updateMultiYearSummaryMetrics(aiResult) {
            // Calculate CAGR from 2027 to 2030
            const year2027Data = aiResult.forecast_data.year_2027;
            const year2030Data = aiResult.forecast_data.year_2030;
            
            if (year2027Data && year2030Data) {
                const revenue2027 = year2027Data.year_totals.total_revenue;
                const revenue2030 = year2030Data.year_totals.total_revenue;
                const years = 3; // 2027 to 2030 is 3 years
                const cagr = ((revenue2030 / revenue2027) ** (1/years) - 1) * 100;
                
                document.getElementById('multiYearRevenueCAGR').textContent = `+${cagr.toFixed(1)}%`;
            }
            
            // Calculate average margins across all years
            const years = [2027, 2028, 2029, 2030];
            let totalGrossMargin = 0;
            let totalEbitdaMargin = 0;
            let validYears = 0;
            
            years.forEach(year => {
                const yearData = aiResult.forecast_data[`year_${year}`];
                if (yearData && yearData.year_totals) {
                    const grossMargin = (yearData.year_totals.total_gross_profit / yearData.year_totals.total_revenue) * 100;
                    const ebitdaMargin = (yearData.year_totals.total_ebitda / yearData.year_totals.total_revenue) * 100;
                    
                    totalGrossMargin += grossMargin;
                    totalEbitdaMargin += ebitdaMargin;
                    validYears++;
                }
            });
            
            if (validYears > 0) {
                const avgGrossMargin = totalGrossMargin / validYears;
                const avgEbitdaMargin = totalEbitdaMargin / validYears;
                
                document.getElementById('multiYearGrossMargin').textContent = `${avgGrossMargin.toFixed(1)}%`;
                document.getElementById('multiYearEbitdaMargin').textContent = `${avgEbitdaMargin.toFixed(1)}%`;
            }
        }
        
        function showMultiYearInsights(insights, aiResult) {
            console.log(' Displaying multi-year AI insights...');
            
            // Create or find the insights container for multi-year
            let insightsContainer = document.getElementById('aiMultiYearInsightsContainer');
            
            if (!insightsContainer) {
                // Create the insights container after the multi-year tables
                const multiYearContainer = document.getElementById('multi-year-container');
                
                insightsContainer = document.createElement('div');
                insightsContainer.id = 'aiMultiYearInsightsContainer';
                insightsContainer.className = 'ai-insights-container';
                insightsContainer.style.marginTop = '2rem';
                
                // Insert after the multi-year container
                multiYearContainer.parentNode.insertBefore(insightsContainer, multiYearContainer.nextSibling);
            }
            
            // Populate the insights
            insightsContainer.innerHTML = `
                <div class="insights-header-AIinsight">
                    <h4><i class="fas fa-brain"></i> Multi-Year AI Analysis & Strategic Insights (2027-2030)</h4>
                    <div class="insights-meta">
                        <span class="confidence-badge">Confidence: ${aiResult.confidence || '85'}%</span>
                        <span class="forecast-date">Generated: ${new Date().toLocaleDateString()}</span>
                    </div>
                </div>
                
                <div class="insights-content">
                    <div class="insight-card key-trends-card">
                        <div class="insight-header">
                            <i class="fas fa-chart-line"></i>
                            <span>Long-term Growth Trends</span>
                        </div>
                        <div class="insight-content">
                            ${insights.key_trends || 'Multi-year analysis shows consistent growth patterns with seasonal variations across quarters.'}
                        </div>
                    </div>
                    
                    <div class="insight-card risk-factors-card">
                        <div class="insight-header">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Strategic Risk Factors</span>
                        </div>
                        <div class="insight-content">
                            ${insights.risk_factors || 'Market volatility and competitive pressure may impact long-term projections.'}
                        </div>
                    </div>
                    
                    <div class="insight-card opportunities-card">
                        <div class="insight-header">
                            <i class="fas fa-lightbulb"></i>
                            <span>Strategic Opportunities</span>
                        </div>
                        <div class="insight-content">
                            ${insights.opportunities || 'Multi-year planning enables strategic investments and market expansion opportunities.'}
                        </div>
                    </div>
                    
                    <div class="insight-card methodology-card">
                        <div class="insight-header">
                            <i class="fas fa-cogs"></i>
                            <span>Forecast Methodology</span>
                        </div>
                        <div class="insight-content">
                            ${insights.methodology || 'Quarterly projections based on historical trends, industry patterns, and strategic context provided.'}
                        </div>
                    </div>
                </div>
            `;
            
            console.log(' Multi-year insights displayed successfully');
        }
        
        async function saveMultiYearForecastToSupabase(aiResult) {
            try {
                console.log(' Saving multi-year forecast to Supabase...');
                
                // Get current user
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    throw new Error('User not authenticated');
                }
                
                if (!aiResult.forecast_data) {
                    throw new Error('Invalid AI result format');
                }
                
                // Prepare the forecast data for Supabase
                const forecastData = {
                    user_id: user.id,
                    forecast_period: 'multi_year_quarterly',
                    forecast_years: [2027, 2028, 2029, 2030],
                    industry_context: document.getElementById('forecastMultiYearIndustrySelect').value,
                    additional_context: document.getElementById('forecastMultiYearContext').value,
                    forecast_style: document.getElementById('forecastMultiYearStyleSelect').value,
                    confidence_level: aiResult.confidence,
                    generated_at: new Date().toISOString(),
                    model_version: aiResult.model_version || 'ai-agent-v1',
                    
                    // Multi-year quarterly data
                    forecast_data: {
                        year_2027: aiResult.forecast_data.year_2027,
                        year_2028: aiResult.forecast_data.year_2028,
                        year_2029: aiResult.forecast_data.year_2029,
                        year_2030: aiResult.forecast_data.year_2030
                    },
                    
                    // AI insights
                    ai_insights: {
                        key_trends: aiResult.insights?.key_trends || '',
                        risk_factors: aiResult.insights?.risk_factors || '',
                        opportunities: aiResult.insights?.opportunities || '',
                        methodology: aiResult.insights?.methodology || ''
                    }
                };
                
                // Save to Supabase (assuming you have a table for multi-year forecasts)
                const { data, error } = await supabase
                    .from('ai_forecasts_multiyear_meridash')
                    .insert([forecastData])
                    .select();
                
                if (error) {
                    throw error;
                }

                trackLatestForecastId(data[0].id, 'ai_forecasts_multiyear_meridash');
                
                console.log(' Multi-year forecast saved to Supabase:', data);
                return data;
                
            } catch (error) {
                console.error(' Error saving multi-year forecast to Supabase:', error);
                throw error;
            }
        }
        
        async function loadLatestMultiYearForecastFromSupabase() {
            try {
                console.log(' Loading latest multi-year forecast from Supabase...');
                
                // Get current user
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    throw new Error('User not authenticated');
                }
                
                // Fetch the latest multi-year forecast
                const { data, error } = await supabase
                    .from('ai_forecasts_multiyear_meridash')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('generated_at', { ascending: false })
                    .limit(1);
                
                if (error) {
                    throw error;
                }
                
                if (!data || data.length === 0) {
                    alert('No saved multi-year forecasts found. Generate a forecast first.');
                    return;
                }
                
                const latestForecast = data[0];
                console.log(' Latest multi-year forecast loaded:', latestForecast);
                
                // Convert Supabase data back to AI result format
                const aiResult = {
                    success: true,
                    confidence: latestForecast.confidence_level,
                    forecast_data: latestForecast.forecast_data,
                    insights: latestForecast.ai_insights,
                    generated_at: latestForecast.generated_at,
                    model_version: latestForecast.model_version || 'ai-agent-v1'
                };
                
                // Populate the multi-year tables with loaded data
                populateMultiYearTablesWithAI(aiResult);
                
                // Create the trending chart
                createMultiYearTrendingChart(aiResult);
                
                // Show insights
                if (aiResult.insights) {
                    showMultiYearInsights(aiResult.insights, aiResult);
                }
                
                // Restore the form values
                document.getElementById('forecastMultiYearIndustrySelect').value = latestForecast.industry_context || '';
                document.getElementById('forecastMultiYearContext').value = latestForecast.additional_context || '';
                document.getElementById('forecastMultiYearStyleSelect').value = latestForecast.forecast_style || '';
                
                // Show success notification
                showForecastLoadedNotification(new Date(latestForecast.generated_at));
                
                console.log(' Multi-year forecast loaded and displayed successfully');
                
            } catch (error) {
                console.error(' Error loading multi-year forecast:', error);
                alert('Failed to load multi-year forecast. Please try again.');
            }
        }

        function showSuccessNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'success-notification';
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-check-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            
            // Add styles if not already present
            if (!document.getElementById('notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    .success-notification {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #10b981;
                        color: white;
                        padding: 1rem 1.5rem;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 1000;
                        animation: slideInRight 0.3s ease-out;
                    }
                    
                    .notification-content {
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                    }
                    
                    @keyframes slideInRight {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Add to page
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function exportMultiYearTrendingChart() {
            if (window.multiYearTrendingChartInstance) {
                const link = document.createElement('a');
                link.download = 'multi-year-quarterly-trending-chart.png';
                link.href = window.multiYearTrendingChartInstance.toBase64Image();
                link.click();
            }
        }
        
        // Initialize multi-year forecast functionality
        document.addEventListener('DOMContentLoaded', function() {
            const generateMultiYearButton = document.getElementById('generateAIMultiYearForecast');
            if (generateMultiYearButton) {
                generateMultiYearButton.addEventListener('click', generateAIMultiYearForecast);
            }
        });

        // Annual Summary Table Population Function
        function populateAnnualSummaryTable() {
            console.log(' Populating Annual Summary table...');
            
            // Collect data from all forecast periods
            const summaryData = {
                2025: extractYearlyData('current-year'),
                2026: extractYearlyData('next-year'),
                2027: extractMultiYearData(2027),
                2028: extractMultiYearData(2028),
                2029: extractMultiYearData(2029),
                2030: extractMultiYearData(2030)
            };
            
            console.log(' Summary data collected:', summaryData);
            
            // Populate the table rows
            populateSummaryRow('total-revenue', summaryData);
            populateSummaryRow('total-cogs', summaryData);
            populateSummaryRow('gross-profit', summaryData);
            populateSummaryRow('gross-margin', summaryData);
            populateSummaryRow('total-opex', summaryData);
            populateSummaryRow('ebitda', summaryData);
            populateSummaryRow('ebitda-margin', summaryData);

            populateAnnualSummaryInsights(summaryData);
        }
        
        // Extract yearly totals from current year (2025) table
        function extractYearlyData(containerId) {
            const container = document.getElementById(containerId + '-container');
            if (!container) {
                console.log(` Container not found: ${containerId}-container`);
                return null;
            }
            
            const data = {};
            
            if (containerId === 'current-year') {
                // 2025 data extraction - RESTORED ORIGINAL WORKING VERSION
                const totalRevenueCell = container.querySelector('#totalRevenue-total');
                data['total-revenue'] = totalRevenueCell ? parseFloat(totalRevenueCell.textContent.replace(/,/g, '')) || 0 : 0;
                
                const totalCogsCell = container.querySelector('#totalCOGS-total');
                data['total-cogs'] = totalCogsCell ? parseFloat(totalCogsCell.textContent.replace(/,/g, '')) || 0 : 0;
                
                const totalOpexCell = container.querySelector('#totalOPEX-total');
                data['total-opex'] = totalOpexCell ? parseFloat(totalOpexCell.textContent.replace(/,/g, '')) || 0 : 0;
                
            } else if (containerId === 'next-year') {
                // 2026 data extraction - Try multiple approaches
                const table2026 = container.querySelector('#plForecast2026Table');
                if (!table2026) {
                    console.log(' 2026 table not found');
                    return null;
                }
                
                let totalRevenue = 0;
                let totalCogs = 0;
                let totalOpex = 0;
                
                // Method 1: Look for total summary rows
                const totalRevenueRow = table2026.querySelector('.pl-revenue-total');
                const totalCogsRow = table2026.querySelector('.pl-cogs-total');  
                const totalOpexRow = table2026.querySelector('.pl-opex-total');
                
                if (totalRevenueRow) {
                    const totalCell = totalRevenueRow.querySelector('td:last-child');
                    totalRevenue = totalCell ? parseFloat(totalCell.textContent.replace(/,/g, '')) || 0 : 0;
                }
                
                if (totalCogsRow) {
                    const totalCell = totalCogsRow.querySelector('td:last-child');
                    totalCogs = totalCell ? parseFloat(totalCell.textContent.replace(/,/g, '')) || 0 : 0;
                }
                
                if (totalOpexRow) {
                    const totalCell = totalOpexRow.querySelector('td:last-child');
                    totalOpex = totalCell ? parseFloat(totalCell.textContent.replace(/,/g, '')) || 0 : 0;
                }
                
                // Method 2: If no total rows, sum individual account rows
                if (totalRevenue === 0 && totalCogs === 0 && totalOpex === 0) {
                    const rows = table2026.querySelectorAll('tbody tr[data-account-code]');
                    rows.forEach(row => {
                        const accountCode = parseInt(row.getAttribute('data-account-code'));
                        const totalCell = row.querySelector('td:last-child'); // 2026 Total column
                        const value = totalCell ? parseFloat(totalCell.textContent.replace(/,/g, '')) || 0 : 0;
                        
                        if (accountCode >= 4000 && accountCode < 5000) {
                            totalRevenue += value;
                        } else if (accountCode >= 5000 && accountCode < 5100) {
                            totalCogs += value;
                        } else if (accountCode >= 5100 && accountCode < 6000) {
                            totalOpex += value;
                        }
                    });
                }
                
                // Method 3: If still nothing, try looking for specific ID patterns
                if (totalRevenue === 0 && totalCogs === 0 && totalOpex === 0) {
                    // Try 2026-specific IDs
                    const totalRevenueCell2026 = container.querySelector('#totalRevenue2026-total');
                    const totalCogsCell2026 = container.querySelector('#totalCOGS2026-total');
                    const totalOpexCell2026 = container.querySelector('#totalOPEX2026-total');
                    
                    totalRevenue = totalRevenueCell2026 ? parseFloat(totalRevenueCell2026.textContent.replace(/,/g, '')) || 0 : 0;
                    totalCogs = totalCogsCell2026 ? parseFloat(totalCogsCell2026.textContent.replace(/,/g, '')) || 0 : 0;
                    totalOpex = totalOpexCell2026 ? parseFloat(totalOpexCell2026.textContent.replace(/,/g, '')) || 0 : 0;
                }
                
                console.log(' 2026 extracted totals:', { totalRevenue, totalCogs, totalOpex });
                
                data['total-revenue'] = totalRevenue;
                data['total-cogs'] = totalCogs;
                data['total-opex'] = totalOpex;
            }
            
            // Calculate derived metrics
            data['gross-profit'] = data['total-revenue'] - data['total-cogs'];
            data['gross-margin'] = data['total-revenue'] > 0 ? (data['gross-profit'] / data['total-revenue']) * 100 : 0;
            data['ebitda'] = data['gross-profit'] - data['total-opex'];
            data['ebitda-margin'] = data['total-revenue'] > 0 ? (data['ebitda'] / data['total-revenue']) * 100 : 0;
            
            console.log(` ${containerId} data extracted:`, data);
            return data;
        }
        
        // Extract data from multi-year quarterly tables
        function extractMultiYearData(year) {
            const tableId = `plForecast${year}Table`;
            const table = document.getElementById(tableId);
            
            if (!table) {
                console.log(` Table not found: ${tableId}`);
                return null;
            }
            
            // Check if table has data (not placeholder)
            if (table.querySelector('.placeholder-row')) {
                console.log(` ${year} table not populated yet - still has placeholder`);
                return null;
            }
            
            const data = {};
            let totalRevenue = 0;
            let totalCogs = 0;
            let totalOpex = 0;
            
            // Method 1: Look for "Total Revenue", "Total COGS", "Total OPEX" rows by text content
            const allRows = table.querySelectorAll('tbody tr');
            
            allRows.forEach(row => {
                const firstCell = row.querySelector('td:first-child');
                if (!firstCell) return;
                
                const lineItemText = firstCell.textContent.trim().toLowerCase();
                const totalCell = row.querySelector('td:last-child'); // Last column is year total
                const value = totalCell ? parseFloat(totalCell.textContent.replace(/,/g, '')) || 0 : 0;
                
                if (lineItemText.includes('total revenue')) {
                    totalRevenue = value;
                    console.log(` ${year} Total Revenue found:`, value);
                } else if (lineItemText.includes('total cogs')) {
                    totalCogs = value;
                    console.log(` ${year} Total COGS found:`, value);
                } else if (lineItemText.includes('total opex')) {
                    totalOpex = value;
                    console.log(` ${year} Total OPEX found:`, value);
                }
            });
            
            // Method 2: If no totals found, look for data-line attributes or IDs
            if (totalRevenue === 0 && totalCogs === 0 && totalOpex === 0) {
                const totalRevenueRow = table.querySelector('tr[data-line="total-revenue"], tr[id*="total-revenue"]');
                const totalCogsRow = table.querySelector('tr[data-line="total-cogs"], tr[id*="total-cogs"]');
                const totalOpexRow = table.querySelector('tr[data-line="total-opex"], tr[id*="total-opex"]');
                
                if (totalRevenueRow) {
                    const totalCell = totalRevenueRow.querySelector('td:last-child');
                    totalRevenue = totalCell ? parseFloat(totalCell.textContent.replace(/,/g, '')) || 0 : 0;
                }
                
                if (totalCogsRow) {
                    const totalCell = totalCogsRow.querySelector('td:last-child');
                    totalCogs = totalCell ? parseFloat(totalCell.textContent.replace(/,/g, '')) || 0 : 0;
                }
                
                if (totalOpexRow) {
                    const totalCell = totalOpexRow.querySelector('td:last-child');
                    totalOpex = totalCell ? parseFloat(totalCell.textContent.replace(/,/g, '')) || 0 : 0;
                }
            }
            
            // Method 3: If still no data, look for bold/summary rows
            if (totalRevenue === 0 && totalCogs === 0 && totalOpex === 0) {
                const boldRows = table.querySelectorAll('tbody tr.forecast-total-row, tbody tr.pl-total-row');
                
                boldRows.forEach(row => {
                    const firstCell = row.querySelector('td:first-child');
                    if (!firstCell) return;
                    
                    const lineItemText = firstCell.textContent.trim().toLowerCase();
                    const totalCell = row.querySelector('td:last-child');
                    const value = totalCell ? parseFloat(totalCell.textContent.replace(/,/g, '')) || 0 : 0;
                    
                    if (lineItemText.includes('revenue')) {
                        totalRevenue += value;
                    } else if (lineItemText.includes('cogs') || lineItemText.includes('cost')) {
                        totalCogs += value;
                    } else if (lineItemText.includes('opex') || lineItemText.includes('operating')) {
                        totalOpex += value;
                    }
                });
            }
            
            console.log(` ${year} final extracted totals:`, { totalRevenue, totalCogs, totalOpex });
            
            data['total-revenue'] = totalRevenue;
            data['total-cogs'] = totalCogs;
            data['gross-profit'] = totalRevenue - totalCogs;
            data['gross-margin'] = totalRevenue > 0 ? ((totalRevenue - totalCogs) / totalRevenue) * 100 : 0;
            data['total-opex'] = totalOpex;
            data['ebitda'] = (totalRevenue - totalCogs) - totalOpex;
            data['ebitda-margin'] = totalRevenue > 0 ? (((totalRevenue - totalCogs) - totalOpex) / totalRevenue) * 100 : 0;
            
            console.log(` ${year} data extracted:`, data);
            return data;
        }
        
        // Populate individual summary row with calculations
        function populateSummaryRow(accountType, summaryData) {
            const row = document.querySelector(`tr[data-account="${accountType}"]`);
            if (!row) return;
            
            const years = [2025, 2026, 2027, 2028, 2029, 2030];
            const values = [];
            
            // Populate year values and calculate growth
            years.forEach((year, index) => {
                const yearData = summaryData[year];
                const value = yearData ? yearData[accountType] : 0;
                values.push(value);
                
                // Update year cell
                const yearCell = row.querySelector(`[data-year="${year}"]`);
                if (yearCell) {
                    if (accountType.includes('margin')) {
                        yearCell.textContent = value.toFixed(1);
                    } else {
                        yearCell.textContent = Math.round(value).toLocaleString();
                    }
                }
                
                // Calculate and update growth cell (except for first year)
                if (index > 0) {
                    const previousValue = values[index - 1];
                    const growthCell = row.querySelector(`[data-growth="${year}"]`);
                    
                    if (growthCell && previousValue !== 0) {
                        let growthPercent, displayValue;
                        
                        if (accountType.includes('margin')) {
                            // For margins, use percentage points (simple subtraction)
                            growthPercent = value - previousValue;
                            displayValue = `${growthPercent >= 0 ? '+' : ''}${growthPercent.toFixed(1)}pp`;
                        } else {
                            // For absolute values, use percentage change
                            growthPercent = ((value - previousValue) / Math.abs(previousValue)) * 100;
                            displayValue = `${growthPercent >= 0 ? '+' : ''}${growthPercent.toFixed(1)}%`;
                        }
                        
                        growthCell.textContent = displayValue;
                        
                        // Add color coding
                        growthCell.className = growthCell.className.replace(/positive|negative/g, '');
                        growthCell.classList.add(growthPercent >= 0 ? 'positive' : 'negative');
                    }
                }
            });
            
            // Calculate and populate CAGR
            const startValue = values[0]; // 2025
            const endValue = values[5];   // 2030
            const cagrCell = row.querySelector(`[data-cagr="${accountType}"]`);
            
            if (cagrCell && startValue > 0 && endValue > 0) {
                const cagr = (Math.pow(endValue / startValue, 1/5) - 1) * 100; // 5 years growth
                cagrCell.textContent = `${cagr >= 0 ? '+' : ''}${cagr.toFixed(1)}%`;
                cagrCell.className = cagrCell.className.replace(/positive|negative/g, '');
                cagrCell.classList.add(cagr >= 0 ? 'positive' : 'negative');
            }
        }

        // Calculate and populate annual summary insights
        function populateAnnualSummaryInsights(summaryData) {
            const years = [2025, 2026, 2027, 2028, 2029, 2030];
            const revenueValues = years.map(year => summaryData[year]?.['total-revenue'] || 0).filter(v => v > 0);
            const ebitdaValues = years.map(year => summaryData[year]?.['ebitda'] || 0).filter(v => v !== 0);
            const grossMargins = years.map(year => summaryData[year]?.['gross-margin'] || 0).filter(v => v > 0);
            const ebitdaMargins = years.map(year => summaryData[year]?.['ebitda-margin'] || 0).filter(v => v !== 0);
            
            if (revenueValues.length < 2) return;
            
            // Calculate 6-Year Revenue CAGR
            const startRevenue = revenueValues[0];
            const endRevenue = revenueValues[revenueValues.length - 1];
            const yearsCount = revenueValues.length - 1;
            const cagr = ((Math.pow(endRevenue / startRevenue, 1 / yearsCount) - 1) * 100);
            
            // Calculate Total Growth (2025 vs 2030)
            const totalGrowth = ((endRevenue - startRevenue) / startRevenue) * 100;
            
            // Calculate Average Margins
            const avgGrossMargin = grossMargins.reduce((a, b) => a + b, 0) / grossMargins.length;
            const avgEbitdaMargin = ebitdaMargins.reduce((a, b) => a + b, 0) / ebitdaMargins.length;
            
            // Calculate Operating Leverage (Revenue growth vs OPEX growth)
            const startOpex = summaryData[2025]?.['total-opex'] || 0;
            const endOpex = summaryData[2030]?.['total-opex'] || 0;
            const opexGrowth = startOpex > 0 ? ((endOpex - startOpex) / startOpex) * 100 : 0;
            const operatingLeverage = opexGrowth > 0 ? (totalGrowth / opexGrowth) : 0;
            
            // Calculate EBITDA CAGR
            const startEbitda = ebitdaValues[0];
            const endEbitda = ebitdaValues[ebitdaValues.length - 1];
            const ebitdaCagr = startEbitda > 0 && endEbitda > 0 ? ((Math.pow(Math.abs(endEbitda) / Math.abs(startEbitda), 1 / yearsCount) - 1) * 100) : 0;
            
            // Update summary cards
            document.getElementById('annualSummaryCAGR').textContent = `${cagr >= 0 ? '+' : ''}${cagr.toFixed(1)}%`;
            document.getElementById('annualSummaryGrossMargin').textContent = `${avgGrossMargin.toFixed(1)}%`;
            document.getElementById('annualSummaryEbitdaMargin').textContent = `${avgEbitdaMargin.toFixed(1)}%`;
            document.getElementById('annualSummaryTotalGrowth').textContent = `${totalGrowth >= 0 ? '+' : ''}${totalGrowth.toFixed(1)}%`;
            document.getElementById('annualSummaryOpLeverage').textContent = `${operatingLeverage.toFixed(1)}x`;
            document.getElementById('annualSummaryProfitGrowth').textContent = `${ebitdaCagr >= 0 ? '+' : ''}${ebitdaCagr.toFixed(1)}%`;
            
            // Generate insights text
            generateAnnualSummaryInsights(cagr, totalGrowth, avgGrossMargin, avgEbitdaMargin, operatingLeverage);
        }
        
        // Generate insights text for annual summary
        function generateAnnualSummaryInsights(cagr, totalGrowth, avgGrossMargin, avgEbitdaMargin, operatingLeverage) {
            const growthTrends = `The company demonstrates ${cagr > 10 ? 'exceptional' : cagr > 5 ? 'strong' : 'moderate'} growth with a ${cagr.toFixed(1)}% revenue CAGR over the 6-year period. Total revenue is projected to grow ${totalGrowth.toFixed(1)}% from 2025 to 2030, indicating ${totalGrowth > 100 ? 'aggressive expansion' : totalGrowth > 50 ? 'solid growth trajectory' : 'steady development'}.`;
            
            const opportunities = `Key opportunities include ${avgGrossMargin > 65 ? 'maintaining premium pricing power' : avgGrossMargin > 50 ? 'optimizing product mix and pricing' : 'improving operational efficiency'}. With an average gross margin of ${avgGrossMargin.toFixed(1)}%, there's potential for ${avgGrossMargin < 60 ? 'margin expansion through cost optimization' : 'maintaining competitive positioning'}.`;
            
            const highlights = `Operating leverage of ${operatingLeverage.toFixed(1)}x demonstrates ${operatingLeverage > 1.5 ? 'excellent operational efficiency' : operatingLeverage > 1 ? 'good cost control' : 'opportunity for better expense management'}. Average EBITDA margin of ${avgEbitdaMargin.toFixed(1)}% reflects ${avgEbitdaMargin > 25 ? 'strong profitability' : avgEbitdaMargin > 15 ? 'healthy operations' : 'developing profitability'}.`;
            
            document.getElementById('annualGrowthTrends').textContent = growthTrends;
            document.getElementById('annualStrategicOpportunities').textContent = opportunities;
            document.getElementById('annualPerformanceHighlights').textContent = highlights;
        }
        
        // Export functions (placeholders)
        function exportAnnualSummaryToPDF() {
            alert('Export Annual Summary to PDF - Feature coming soon!');
        }
        
        function copyAnnualSummaryToClipboard() {
            alert('Copy Annual Summary - Feature coming soon!');
        }

        // ====== COPY FUNCTIONS ======

        // Universal copy function for P&L forecast tables
        function copyPLForecastTable(tableType) {
            let tableData = '';
            let table = null;
            let title = '';
            
            switch(tableType) {
                case 'summary':
                    table = document.getElementById('plForecastSummaryTable');
                    title = 'Annual Growth Summary (2025-2030)';
                    break;
                case '2026':
                    table = document.getElementById('plForecast2026Table');
                    title = '2026 Full Year Forecast';
                    break;
                case 'multiyear':
                    // For multi-year, we'll copy all year tables
                    copyMultiYearTables();
                    return;
                default:
                    table = document.getElementById('plForecastTable');
                    title = '2025 P&L Forecast - Actual vs Budget';
            }
            
            if (!table) {
                alert('Table not found for copying');
                return;
            }
            
            tableData = convertTableToText(table, title);
            copyToClipboard(tableData, `${title} copied to clipboard!`);
        }
        
        // Copy multi-year tables (all years 2027-2030)
        function copyMultiYearTables() {
            let allTablesData = 'MULTI-YEAR QUARTERLY FORECAST (2027-2030)\n';
            allTablesData += '='.repeat(60) + '\n\n';
            
            const years = [2027, 2028, 2029, 2030];
            
            years.forEach(year => {
                const table = document.getElementById(`plForecast${year}Table`);
                if (table && !table.querySelector('.placeholder-row')) {
                    allTablesData += convertTableToText(table, `${year} Quarterly Forecast`);
                    allTablesData += '\n' + '-'.repeat(40) + '\n\n';
                }
            });
            
            copyToClipboard(allTablesData, 'Multi-year forecast data copied to clipboard!');
        }
        
        // Convert HTML table to formatted text
        function convertTableToText(table, title) {
            let text = `${title.toUpperCase()}\n`;
            text += '='.repeat(title.length) + '\n\n';
            
            // Add current date
            text += `Generated: ${new Date().toLocaleString()}\n\n`;
            
            const rows = table.querySelectorAll('tr');
            
            rows.forEach((row, index) => {
                const cells = row.querySelectorAll('th, td');
                let rowText = '';
                
                cells.forEach((cell, cellIndex) => {
                    let cellText = cell.textContent.trim();
                    
                    // Clean up text
                    cellText = cellText.replace(/\s+/g, ' ');
                    
                    // Handle section headers
                    if (cell.classList.contains('pl-section-header')) {
                        rowText = '\n' + cellText + '\n' + '-'.repeat(cellText.length);
                        return;
                    }
                    
                    // Pad text for alignment
                    const width = cellIndex === 0 ? 25 : 15;
                    rowText += cellText.padEnd(width);
                });
                
                if (rowText.trim()) {
                    text += rowText + '\n';
                }
            });
            
            return text;
        }
        
        // Copy Annual Summary with insights
        async function copyAnnualSummaryToClipboard() {
            const table = document.getElementById('plForecastSummaryTable');
            if (!table) {
                alert('Annual Summary table not found');
                return;
            }
            
            let summaryText = convertTableToText(table, 'Annual Growth Summary (2025-2030)');
            
            // Add summary cards data
            summaryText += '\n\nKEY METRICS SUMMARY\n';
            summaryText += '='.repeat(20) + '\n';
            
            const metrics = [
                { label: '6-Year CAGR', id: 'annualSummaryCAGR' },
                { label: 'Avg Gross Margin', id: 'annualSummaryGrossMargin' },
                { label: 'Avg EBITDA Margin', id: 'annualSummaryEbitdaMargin' },
                { label: 'Total Growth', id: 'annualSummaryTotalGrowth' },
                { label: 'Operating Leverage', id: 'annualSummaryOpLeverage' },
                { label: 'Profit Growth', id: 'annualSummaryProfitGrowth' }
            ];
            
            metrics.forEach(metric => {
                const element = document.getElementById(metric.id);
                if (element) {
                    summaryText += `${metric.label}: ${element.textContent}\n`;
                }
            });
            
            // Add insights
            const insights = [
                { label: 'Growth Trajectory', id: 'annualGrowthTrends' },
                { label: 'Strategic Opportunities', id: 'annualStrategicOpportunities' },
                { label: 'Performance Highlights', id: 'annualPerformanceHighlights' }
            ];
            
            summaryText += '\n\nSTRATEGIC INSIGHTS\n';
            summaryText += '='.repeat(18) + '\n';
            
            insights.forEach(insight => {
                const element = document.getElementById(insight.id);
                if (element && element.textContent.trim()) {
                    summaryText += `\n${insight.label.toUpperCase()}:\n`;
                    summaryText += element.textContent.trim() + '\n';
                }
            });
            
            summaryText += '\n\nGenerated by MontPro Financial Intelligence Dashboard';
            
            copyToClipboard(summaryText, 'Annual Summary with insights copied to clipboard!');
        }
        
        // Copy insights to clipboard (generic function)
        async function copyInsightsToClipboard() {
            // Try to find the active insights container
            const containers = [
                'aiInsightsContainer',
                'ai2026InsightsContainer', 
                'aiMultiYearInsightsContainer',
                'annualSummaryInsightsContainer'
            ];
            
            let activeContainer = null;
            for (const containerId of containers) {
                const container = document.getElementById(containerId);
                if (container && container.style.display !== 'none') {
                    activeContainer = container;
                    break;
                }
            }
            
            if (!activeContainer) {
                alert('No active insights found to copy');
                return;
            }
            
            const insights = activeContainer.querySelectorAll('.insight-card');
            let insightsText = 'AI FINANCIAL FORECAST ANALYSIS\n';
            insightsText += '='.repeat(35) + '\n\n';
            insightsText += `Generated: ${new Date().toLocaleString()}\n\n`;
            
            insights.forEach(card => {
                const header = card.querySelector('.insight-header h5, .insight-header span');
                const content = card.querySelector('.insight-text, .insight-content');
                
                if (header && content) {
                    insightsText += `${header.textContent.toUpperCase()}\n`;
                    insightsText += '-'.repeat(header.textContent.length) + '\n';
                    insightsText += content.textContent.trim() + '\n\n';
                }
            });
            
            insightsText += 'Generated by MontPro Financial Intelligence Dashboard';
            
            copyToClipboard(insightsText, 'AI insights copied to clipboard!');
        }
        
        // ====== EXPORT FUNCTIONS ======
        
        // Universal export function for P&L forecast tables
        function exportPLForecast(tableType) {
            let table = null;
            let filename = '';
            
            switch(tableType) {
                case 'summary':
                    table = document.getElementById('plForecastSummaryTable');
                    filename = 'Annual_Growth_Summary_2025-2030';
                    break;
                case '2026':
                    table = document.getElementById('plForecast2026Table');
                    filename = '2026_Full_Year_Forecast';
                    break;
                case 'multiyear':
                    exportMultiYearTables();
                    return;
                default:
                    table = document.getElementById('plForecastTable');
                    filename = '2025_PL_Forecast';
            }
            
            if (!table) {
                alert('Table not found for export');
                return;
            }
            
            exportTableAsCSV(table, filename);
        }
        
        // Export multi-year tables as separate CSV files
        function exportMultiYearTables() {
            const years = [2027, 2028, 2029, 2030];
            let hasData = false;
            
            years.forEach(year => {
                const table = document.getElementById(`plForecast${year}Table`);
                if (table && !table.querySelector('.placeholder-row')) {
                    exportTableAsCSV(table, `${year}_Quarterly_Forecast`);
                    hasData = true;
                }
            });
            
            if (!hasData) {
                alert('No multi-year forecast data available for export');
            } else {
                alert(`Multi-year forecasts exported as separate CSV files`);
            }
        }
        
        // Export Annual Summary as PDF (formatted)
        function exportAnnualSummaryToPDF() {
            // For now, we'll create a comprehensive text export that can be converted to PDF
            const table = document.getElementById('plForecastSummaryTable');
            if (!table) {
                alert('Annual Summary table not found');
                return;
            }
            
            let pdfContent = generateAnnualSummaryReport();
            
            // Create a downloadable text file that can be converted to PDF
            const blob = new Blob([pdfContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Annual_Growth_Summary_Report.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Annual Summary report downloaded! You can convert the .txt file to PDF using any online converter.');
        }
        
        // Export insights as PDF
        function exportInsightsToPDF() {
            const insightsText = generateInsightsReport();
            
            const blob = new Blob([insightsText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'AI_Financial_Insights_Report.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('AI Insights report downloaded! You can convert the .txt file to PDF using any online converter.');
        }
        
        // ====== HELPER FUNCTIONS ======
        
        // Generic copy to clipboard function
        async function copyToClipboard(text, successMessage) {
            try {
                await navigator.clipboard.writeText(text);
                
                // Show success notification
                showCopyNotification(successMessage);
            } catch (err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                showCopyNotification(successMessage);
            }
        }
        
        // Show copy success notification
        function showCopyNotification(message) {
            // Create or update notification
            let notification = document.getElementById('copyNotification');
            
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'copyNotification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #28a745;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 6px;
                    z-index: 10000;
                    font-weight: 500;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    transform: translateX(400px);
                    transition: transform 0.3s ease;
                `;
                document.body.appendChild(notification);
            }
            
            notification.innerHTML = `<i class="fas fa-check"></i> ${message}`;
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Animate out
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // Export table as CSV
        function exportTableAsCSV(table, filename) {
            let csv = '';
            const rows = table.querySelectorAll('tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('th, td');
                const rowData = [];
                
                cells.forEach(cell => {
                    let cellText = cell.textContent.trim();
                    // Clean up text and handle commas
                    cellText = cellText.replace(/,/g, '');
                    cellText = cellText.replace(/"/g, '""');
                    
                    // Skip section headers or format them differently
                    if (cell.classList.contains('pl-section-header')) {
                        rowData.push(`"=== ${cellText} ==="`);
                        // Add empty cells for remaining columns
                        for (let i = 1; i < cells.length; i++) {
                            rowData.push('');
                        }
                        return;
                    }
                    
                    rowData.push(`"${cellText}"`);
                });
                
                if (rowData.some(cell => cell.trim() !== '""')) {
                    csv += rowData.join(',') + '\n';
                }
            });
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showCopyNotification(`${filename}.csv downloaded successfully!`);
        }
        
        // Generate comprehensive annual summary report
        function generateAnnualSummaryReport() {
            const table = document.getElementById('plForecastSummaryTable');
            let report = 'ANNUAL GROWTH SUMMARY REPORT (2025-2030)\n';
            report += '='.repeat(50) + '\n\n';
            report += `Generated: ${new Date().toLocaleString()}\n`;
            report += `Company: [Your Company Name]\n\n`;
            
            // Add executive summary
            report += 'EXECUTIVE SUMMARY\n';
            report += '-'.repeat(17) + '\n';
            
            const cagr = document.getElementById('annualSummaryCAGR')?.textContent || 'N/A';
            const totalGrowth = document.getElementById('annualSummaryTotalGrowth')?.textContent || 'N/A';
            
            report += ` Revenue CAGR (2025-2030): ${cagr}\n`;
            report += ` Total Growth: ${totalGrowth}\n`;
            report += ` Average Gross Margin: ${document.getElementById('annualSummaryGrossMargin')?.textContent || 'N/A'}\n`;
            report += ` Average EBITDA Margin: ${document.getElementById('annualSummaryEbitdaMargin')?.textContent || 'N/A'}\n\n`;
            
            // Add table data
            report += convertTableToText(table, 'DETAILED ANNUAL COMPARISON');
            
            // Add insights
            report += '\n\nSTRATEGIC ANALYSIS\n';
            report += '='.repeat(18) + '\n\n';
            
            const insights = [
                { title: 'Growth Trajectory Analysis', id: 'annualGrowthTrends' },
                { title: 'Strategic Opportunities', id: 'annualStrategicOpportunities' },
                { title: 'Performance Highlights', id: 'annualPerformanceHighlights' }
            ];
            
            insights.forEach(insight => {
                const element = document.getElementById(insight.id);
                if (element && element.textContent.trim()) {
                    report += `${insight.title.toUpperCase()}\n`;
                    report += '-'.repeat(insight.title.length) + '\n';
                    report += element.textContent.trim() + '\n\n';
                }
            });
            
            report += '\n\nDISCLAIMER\n';
            report += '-'.repeat(10) + '\n';
            report += 'This forecast is based on AI analysis of historical data and assumptions.\n';
            report += 'Actual results may vary. Please consult with financial advisors for\n';
            report += 'investment and business decisions.\n\n';
            report += 'Generated by MontPro Financial Intelligence Dashboard';
            
            return report;
        }
        
        // Generate insights report
        function generateInsightsReport() {
            let report = 'AI FINANCIAL INSIGHTS REPORT\n';
            report += '='.repeat(30) + '\n\n';
            report += `Generated: ${new Date().toLocaleString()}\n\n`;
            
            // Find active insights
            const containers = document.querySelectorAll('.ai-insights-container[style*="block"], .ai-insights-container:not([style*="none"])');
            
            containers.forEach((container, index) => {
                if (container.style.display !== 'none') {
                    const title = container.querySelector('.insights-header-AIinsight h4')?.textContent || `Insights Section ${index + 1}`;
                    report += `${title.toUpperCase()}\n`;
                    report += '='.repeat(title.length) + '\n\n';
                    
                    const insights = container.querySelectorAll('.insight-card');
                    insights.forEach(card => {
                        const header = card.querySelector('.insight-header h5, .insight-header span');
                        const content = card.querySelector('.insight-text, .insight-content');
                        
                        if (header && content) {
                            report += `${header.textContent}\n`;
                            report += '-'.repeat(header.textContent.length) + '\n';
                            report += content.textContent.trim() + '\n\n';
                        }
                    });
                }
            });
            
            report += 'Generated by MontPro Financial Intelligence Dashboard';
            return report;
        }

        // Initialize scenario analysis when page loads
        function initializeScenarioAnalysis() {
            // Get base case data from existing forecast
            scenarioState.baseCase = getBaseCaseData();
            scenarioState.currentScenario = JSON.parse(JSON.stringify(scenarioState.baseCase));
            updateScenarioComparison();
        }
        
        // Get base case data from existing annual summary
        function getBaseCaseData() {
            console.log(' Getting base case data...');
            
            const baseData = {};
            const years = [2026, 2027, 2028, 2029, 2030];
            
            years.forEach(year => {
                let data = null;
                
                if (year === 2026) {
                    // Try to get from the loaded forecast data first
                    if (window.latest2026Forecast && window.latest2026Forecast.year_totals) {
                        const forecast = window.latest2026Forecast.year_totals;
                        data = {
                            'total-revenue': forecast.total_revenue,
                            'total-cogs': forecast.total_cogs,
                            'gross-profit': forecast.gross_profit,
                            'total-opex': forecast.total_opex,
                            'ebitda': forecast.ebitda
                        };
                    } else {
                        // Fallback to extractYearlyData
                        data = extractYearlyData('next-year');
                    }
                } else {
                    data = extractMultiYearData(year);
                }
                
                console.log(` Year ${year} data:`, data);
                
                if (data && data['total-revenue'] && data['total-revenue'] > 0) {
                    baseData[year] = {
                        revenue: data['total-revenue'],
                        cogs: data['total-cogs'] || 0,
                        grossProfit: data['gross-profit'] || 0,
                        opex: data['total-opex'] || 0,
                        netIncome: data['ebitda'] || 0
                    };
                } else {
                    // Use realistic fallback for Indonesia
                    const baseRevenue = 2400000000; // 2.4B IDR
                    const growthRate = 0.2;
                    const yearIndex = year - 2026;
                    
                    baseData[year] = {
                        revenue: baseRevenue * Math.pow(1 + growthRate, yearIndex),
                        cogs: baseRevenue * Math.pow(1 + growthRate, yearIndex) * 0.5,
                        grossProfit: baseRevenue * Math.pow(1 + growthRate, yearIndex) * 0.5,
                        opex: baseRevenue * Math.pow(1 + growthRate, yearIndex) * 0.33,
                        netIncome: baseRevenue * Math.pow(1 + growthRate, yearIndex) * 0.17
                    };
                }
            });
            
            console.log(' Final base case data:', baseData);
            return baseData;
        }
        
        // Toggle year selection
        function toggleYear(year) {
            console.log(' Toggling year:', year);
            
            // Ensure scenarioState is initialized
            if (!scenarioState || !scenarioState.baseCase) {
                console.log(' Scenario state not initialized, initializing...');
                initializeScenarioAnalysis();
            }
            
            // Use more specific selector for buttons only
            const yearBtn = document.querySelector(`button[data-year="${year}"]`);
            if (!yearBtn) {
                console.log(' Year button not found for:', year);
                return;
            }
            
            const index = scenarioState.affectedYears.indexOf(year);
            
            if (index > -1) {
                scenarioState.affectedYears.splice(index, 1);
                yearBtn.classList.remove('active');
                console.log(' Removed year from affected years:', year);
            } else {
                scenarioState.affectedYears.push(year);
                yearBtn.classList.add('active');
                console.log(' Added year to affected years:', year);
            }
            
            console.log(' Current affected years:', scenarioState.affectedYears);
            
            // ADD THIS LINE - update all button visual indicators
            updateYearButtons();
            
            recalculateScenario();
        }
        
        // Apply quick scenario actions
        function applyQuickScenario(scenarioType) {
            // Reset sliders but DON'T clear logged events
            scenarioState.adjustments = { revenue: 0, cogs: 0, opex: 0 };
            scenarioState.scenarioName = 'Base Case';
            
            // Reset sliders and inputs
            document.getElementById('revenueSlider').value = 0;
            document.getElementById('cogsSlider').value = 0;
            document.getElementById('opexSlider').value = 0;
            
            document.getElementById('revenueInput').value = 0;
            document.getElementById('cogsInput').value = 0;
            document.getElementById('opexInput').value = 0;
            
            const scenarios = {
                revenue_boost: {
                    name: 'Revenue Boost +20%',
                    adjustments: { revenue: 20, cogs: 0, opex: 0 }
                },
                cost_reduction: {
                    name: 'Cost Reduction -10%',
                    adjustments: { revenue: 0, cogs: -10, opex: -10 }
                },
                new_product: {
                    name: 'New Product Launch',
                    adjustments: { revenue: 15, cogs: 5, opex: 8 }
                },
                market_expansion: {
                    name: 'Market Expansion',
                    adjustments: { revenue: 25, cogs: 10, opex: 15 }
                },
                price_drop: {
                    name: 'Price Drop -15%',
                    adjustments: { revenue: -15, cogs: 0, opex: 0 }
                },
                supply_constraints: {
                    name: 'Supply Constraints +25%',
                    adjustments: { revenue: 0, cogs: 25, opex: 0 }
                },
                contract_lost: {
                    name: 'Key Contract Lost -30%',
                    adjustments: { revenue: -30, cogs: -15, opex: 0 }
                },
                economic_downturn: {
                    name: 'Economic Downturn -20%',
                    adjustments: { revenue: -20, cogs: 0, opex: 5 }
                }
            };
            
            const scenario = scenarios[scenarioType];
            if (scenario) {
                scenarioState.scenarioName = scenario.name;
                scenarioState.adjustments = scenario.adjustments;
                
                // Update sliders and inputs
                document.getElementById('revenueSlider').value = scenario.adjustments.revenue;
                document.getElementById('cogsSlider').value = scenario.adjustments.cogs;
                document.getElementById('opexSlider').value = scenario.adjustments.opex;
                
                document.getElementById('revenueInput').value = scenario.adjustments.revenue;
                document.getElementById('cogsInput').value = scenario.adjustments.cogs;
                document.getElementById('opexInput').value = scenario.adjustments.opex;
                
                recalculateScenario();
            }
        }
        
        // Update custom scenario adjustments
        function updateCustomScenario(type, value) {
            console.log(' Updating custom scenario:', type, value);
            
            // Ensure scenarioState is initialized
            if (!scenarioState || !scenarioState.baseCase) {
                console.log(' Scenario state not initialized, initializing...');
                initializeScenarioAnalysis();
            }
            
            scenarioState.adjustments[type] = parseFloat(value);
            scenarioState.scenarioName = 'Custom Scenario';
            
            // Update displays
            const inputField = document.getElementById(type + 'Input');
            
            if (inputField) {
                inputField.value = value;
                console.log(' Updated input field for', type);
            }
            
            recalculateScenario();
        }

        function updateCustomScenarioFromInput(type, value) {
            const numValue = parseFloat(value) || 0;
            const clampedValue = Math.max(-50, Math.min(100, numValue));
            
            scenarioState.adjustments[type] = clampedValue;
            scenarioState.scenarioName = 'Custom Scenario';
            
            // Update displays
            const valueDisplay = document.getElementById(type + 'Value');
            const slider = document.getElementById(type + 'Slider');
            const inputField = document.getElementById(type + 'Input');
            
            if (valueDisplay) valueDisplay.textContent = clampedValue + '%';
            if (slider) slider.value = clampedValue;
            if (inputField) inputField.value = clampedValue;
            
            recalculateScenario();
        }
        
        // Add one-time event
        function addOneTimeEvent() {
            const description = document.getElementById('eventDescription').value;
            const plLine = document.getElementById('eventPLLine').value;
            const amount = parseFloat(document.getElementById('eventAmount').value);
            const year = parseInt(document.getElementById('eventYear').value);
            
            if (description && amount && year) {
                scenarioState.oneTimeEvents.push({
                    description,
                    plLine,
                    amount,
                    percentage: 0, // One-time events are absolute amounts
                    year,
                    id: Date.now(),
                    type: 'oneTime'
                });
                
                // Clear inputs
                document.getElementById('eventDescription').value = '';
                document.getElementById('eventAmount').value = '';
                
                updateEventsList();
                recalculateScenario();
            }
        }
        
        // Update events list display
        function updateEventsList() {
            const eventsList = document.getElementById('eventsList');
            const eventsContainer = document.getElementById('oneTimeEvents');
            
            if (scenarioState.oneTimeEvents.length === 0) {
                eventsContainer.style.display = 'none';
                return;
            }
            
            eventsContainer.style.display = 'block';
            eventsList.innerHTML = scenarioState.oneTimeEvents.map(event => {
                let impactText = '';
                
                if (event.percentage && event.percentage !== 0) {
                    // Calculate actual impact for percentage-based events
                    const baseValue = scenarioState.baseCase[event.year];
                    let impact = 0;
                    
                    if (event.plLine === 'revenue' && baseValue) {
                        impact = baseValue.revenue * (event.percentage / 100);
                    } else if (event.plLine === 'cogs' && baseValue) {
                        impact = baseValue.cogs * (event.percentage / 100);
                    } else if (event.plLine === 'opex' && baseValue) {
                        impact = baseValue.opex * (event.percentage / 100);
                    }
                    
                    impactText = `${impact >= 0 ? '+' : ''}Rp ${Math.abs(impact).toLocaleString()}`;
                } else {
                    // Absolute amount events
                    impactText = `${event.amount >= 0 ? '+' : ''}Rp ${Math.abs(event.amount).toLocaleString()}`;
                }
                
                return `
                    <div class="event-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #f8fafc; border-radius: 4px; margin-bottom: 0.5rem;">
                        <div style="flex: 1;">
                            <strong>${event.description}</strong> - ${event.year} - ${impactText}
                        </div>
                        <button class="btn btn-outline" onclick="removeOneTimeEvent(${event.id})" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        // Remove one-time event
        function removeOneTimeEvent(eventId) {
            scenarioState.oneTimeEvents = scenarioState.oneTimeEvents.filter(event => event.id !== eventId);
            updateEventsList();
            recalculateScenario();
        }
        
        // Reset scenario to base case
        function resetScenario() {
            scenarioState.adjustments = { revenue: 0, cogs: 0, opex: 0 };
            scenarioState.oneTimeEvents = [];
            scenarioState.scenarioName = 'Base Case';
            scenarioState.currentScenario = JSON.parse(JSON.stringify(scenarioState.baseCase));
            
            // Reset sliders and inputs
            document.getElementById('revenueSlider').value = 0;
            document.getElementById('cogsSlider').value = 0;
            document.getElementById('opexSlider').value = 0;
            
            document.getElementById('revenueInput').value = 0;
            document.getElementById('cogsInput').value = 0;
            document.getElementById('opexInput').value = 0;
            
            updateEventsList();
            updateScenarioComparison();
        }
        
        // Recalculate scenario based on current adjustments
        function recalculateScenario() {
            scenarioState.currentScenario = JSON.parse(JSON.stringify(scenarioState.baseCase));
            
            // Apply percentage adjustments ONLY to affected years
            Object.keys(scenarioState.currentScenario).forEach(year => {
                const yearNum = parseInt(year);
                
                // Only apply changes to years that are selected in affectedYears
                if (scenarioState.affectedYears.includes(yearNum)) {
                    const data = scenarioState.currentScenario[year];
                    
                    // Apply adjustments
                    data.revenue *= (1 + scenarioState.adjustments.revenue / 100);
                    data.cogs *= (1 + scenarioState.adjustments.cogs / 100);
                    data.opex *= (1 + scenarioState.adjustments.opex / 100);
                    
                    // Recalculate derived values
                    data.grossProfit = data.revenue - data.cogs;
                    data.netIncome = data.grossProfit - data.opex;
                    
                    // Apply one-time events for this year
                    scenarioState.oneTimeEvents.forEach(event => {
                        if (event.year === yearNum) {
                            const data = scenarioState.currentScenario[year];
                            
                            if (event.percentage && event.percentage !== 0) {
                                // Percentage-based events from Apply Scenario
                                if (event.plLine === 'revenue') {
                                    data.revenue *= (1 + event.percentage / 100);
                                } else if (event.plLine === 'cogs') {
                                    data.cogs *= (1 + event.percentage / 100);
                                } else if (event.plLine === 'opex') {
                                    data.opex *= (1 + event.percentage / 100);
                                }
                            } else {
                                // Absolute amount events from One-time Events
                                if (event.plLine === 'revenue') {
                                    data.revenue += event.amount;
                                } else if (event.plLine === 'cogs') {
                                    data.cogs += event.amount;
                                } else if (event.plLine === 'opex') {
                                    data.opex += event.amount;
                                } else {
                                    // Default to net income for 'other' or legacy events
                                    data.netIncome += event.amount;
                                }
                            }
                            
                            // Recalculate derived values after applying events
                            data.grossProfit = data.revenue - data.cogs;
                            data.netIncome = data.grossProfit - data.opex;
                        }
                    });
                }
            });
            
            updateScenarioComparison();
        }
        
        // Update scenario comparison display
        function updateScenarioComparison() {
            const headerTbody = document.getElementById('scenarioComparisonHeader');
            const bodyTbody = document.getElementById('scenarioComparisonBody');
            const years = [2026, 2027, 2028, 2029, 2030];
        
            // 1. Generate the grouped header
            let headerHTML = `
                <tr class="year-header">
                    <th>Financial Item</th>
                    ${years.map(year => `<th colspan="3">${year}</th>`).join('')}
                </tr>
                <tr class="sub-header">
                    <th></th>
                    ${years.map(() => `
                        <th>Base</th>
                        <th>Scenario</th>
                        <th>Change</th>
                    `).join('')}
                </tr>
            `;
            headerTbody.innerHTML = headerHTML;
        
            // 2. Generate the table body with conditional coloring
            const lineItems = [
                { key: 'revenue', label: 'Revenue' },
                { key: 'cogs', label: 'Cost of Goods Sold' },
                { key: 'grossProfit', label: 'Gross Profit' },
                { key: 'opex', label: 'Operating Expenses' },
                { key: 'netIncome', label: 'Net Income' }
            ];
        
            bodyTbody.innerHTML = lineItems.map(item => {
                let rowHTML = `<tr><td>${item.label}</td>`;
        
                years.forEach(year => {
                    const base = scenarioState.baseCase[year] ? scenarioState.baseCase[year][item.key] : 0;
                    const scenario = scenarioState.currentScenario[year] ? scenarioState.currentScenario[year][item.key] : 0;
                    const change = scenario - base;
                    const changePercent = base !== 0 ? (change / Math.abs(base)) * 100 : 0;
        
                    // --- CONDITIONAL COLORING LOGIC ---
                    let changeClass = '';
                    // For COGS and OPEX, an increase is negative (bad).
                    if (item.key === 'cogs' || item.key === 'opex') {
                        if (change > 0) changeClass = 'negative';
                        else if (change < 0) changeClass = 'positive';
                        else changeClass = 'neutral';
                    } 
                    // For Revenue and Profit, an increase is positive (good).
                    else {
                        if (change > 0) changeClass = 'positive';
                        else if (change < 0) changeClass = 'negative';
                        else changeClass = 'neutral';
                    }
                    // --- END OF NEW LOGIC ---
        
                    rowHTML += `
                        <td class="base-col">Rp ${formatNumber(base)}</td>
                        <td class="scenario-col">Rp ${formatNumber(scenario)}</td>
                        <td class="change-col ${changeClass}">
                            ${change >= 0 ? '+' : ''}Rp ${formatNumber(change)}
                            <br><small>(${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(1)}%)</small>
                        </td>
                    `;
                });
        
                rowHTML += '</tr>';
                return rowHTML;
            }).join('');
            
            // Update active scenario name display
            document.getElementById('activeScenarioName').textContent = scenarioState.scenarioName;
        
            // Update the summary cards
            updateSummaryCards();
        }
        
        // Update summary impact cards
        function updateSummaryCards() {
            if (!scenarioState || !scenarioState.baseCase || !scenarioState.currentScenario) {
                console.error("Scenario data not initialized.");
                return;
            }
        
            const years = scenarioState.affectedYears.sort();
            let overallImpact = { revenue: 0, netIncome: 0 };
            let perYearImpacts = {};
        
            // --- 1. Calculate Per-Year and Overall Impacts ---
            years.forEach(year => {
                const base = scenarioState.baseCase[year];
                const scenario = scenarioState.currentScenario[year];
                if (!base || !scenario) return;
        
                const revenueChange = scenario.revenue - base.revenue;
                const netIncomeChange = scenario.netIncome - base.netIncome;
        
                const baseEbitdaMargin = base.revenue !== 0 ? ((base.revenue - base.cogs - base.opex) / base.revenue) * 100 : 0;
                const scenarioEbitdaMargin = scenario.revenue !== 0 ? ((scenario.revenue - scenario.cogs - scenario.opex) / scenario.revenue) * 100 : 0;
                const marginChange = scenarioEbitdaMargin - baseEbitdaMargin;
        
                perYearImpacts[year] = { revenueChange, netIncomeChange, marginChange, scenarioEbitdaMargin };
        
                overallImpact.revenue += revenueChange;
                overallImpact.netIncome += netIncomeChange;
            });
        
            const overallBaseRevenue = years.reduce((sum, year) => sum + (scenarioState.baseCase[year]?.revenue || 0), 0);
            const overallRevenuePercent = overallBaseRevenue !== 0 ? (overallImpact.revenue / Math.abs(overallBaseRevenue)) * 100 : 0;
        
            const overallBaseNetIncome = years.reduce((sum, year) => sum + (scenarioState.baseCase[year]?.netIncome || 0), 0);
            const overallNetIncomePercent = overallBaseNetIncome !== 0 ? (overallImpact.netIncome / Math.abs(overallBaseNetIncome)) * 100 : 0;
        
            const overallBaseEbitda = years.reduce((sum, year) => sum + (scenarioState.baseCase[year]?.ebitda || 0), 0);
            const overallScenarioEbitda = years.reduce((sum, year) => sum + (scenarioState.currentScenario[year]?.ebitda || 0), 0);
            const overallBaseEbitdaMargin = overallBaseRevenue !== 0 ? (overallBaseEbitda / overallBaseRevenue) * 100 : 0;
            const overallScenarioEbitdaMargin = (overallBaseRevenue + overallImpact.revenue) !== 0 ? (overallScenarioEbitda / (overallBaseRevenue + overallImpact.revenue)) * 100 : 0;
            const overallMarginChange = overallScenarioEbitdaMargin - overallBaseEbitdaMargin;
        
        
            // --- 2. Populate Main Values in Cards ---
            document.getElementById('overallRevenueImpact').textContent = `${overallImpact.revenue >= 0 ? '+' : ''}Rp ${formatNumber(overallImpact.revenue)}`;
            document.getElementById('overallRevenueImpactPercent').textContent = `${overallRevenuePercent >= 0 ? '+' : ''}${overallRevenuePercent.toFixed(1)}%`;
            document.getElementById('overallRevenueImpactPercent').className = `metric-change ${getChangeClass(overallImpact.revenue)}`;
        
            document.getElementById('overallNetIncomeImpact').textContent = `${overallImpact.netIncome >= 0 ? '+' : ''}Rp ${formatNumber(overallImpact.netIncome)}`;
            document.getElementById('overallNetIncomeImpactPercent').textContent = `${overallNetIncomePercent >= 0 ? '+' : ''}${overallNetIncomePercent.toFixed(1)}%`;
            document.getElementById('overallNetIncomeImpactPercent').className = `metric-change ${getChangeClass(overallImpact.netIncome)}`;
            
            document.getElementById('overallMarginValue').textContent = `${overallScenarioEbitdaMargin.toFixed(1)}%`;
            document.getElementById('overallMarginImpact').textContent = `${overallMarginChange >= 0 ? '+' : ''}${overallMarginChange.toFixed(1)}pp`;
            document.getElementById('overallMarginImpact').className = `metric-change ${getChangeClass(overallMarginChange)}`;
        
            // --- 3. Build and Inject Yearly Breakdown HTML ---
            const revenueBreakdownContainer = document.getElementById('revenueImpactBreakdown');
            const netIncomeBreakdownContainer = document.getElementById('netIncomeImpactBreakdown');
            const marginBreakdownContainer = document.getElementById('marginImpactBreakdown');
        
            revenueBreakdownContainer.innerHTML = '';
            netIncomeBreakdownContainer.innerHTML = '';
            marginBreakdownContainer.innerHTML = '';
        
            Object.keys(perYearImpacts).forEach(year => {
                const impact = perYearImpacts[year];
                revenueBreakdownContainer.innerHTML += createBreakdownItem(year, impact.revenueChange);
                netIncomeBreakdownContainer.innerHTML += createBreakdownItem(year, impact.netIncomeChange);
                marginBreakdownContainer.innerHTML += createBreakdownItem(year, impact.marginChange, true); // True for percentage points
            });
        
            // --- 4. Helper Functions ---
            function createBreakdownItem(year, value, isMargin = false) {
                const valueClass = getChangeClass(value);
                let formattedValue;
        
                if (isMargin) {
                    formattedValue = `${value >= 0 ? '+' : ''}${value.toFixed(1)}pp`;
                } else {
                    formattedValue = `${value >= 0 ? '+' : ''}Rp ${formatNumber(value)}`;
                }
        
                return `
                    <div class="breakdown-year-item">
                        <span class="breakdown-year-label">${year}:</span>
                        <span class="breakdown-year-value ${valueClass}">${formattedValue}</span>
                    </div>
                `;
            }
        
            function getChangeClass(value) {
                return value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
            }
        
            function formatNumber(num) {
                if (num === 0) return '0';
                const absNum = Math.abs(num);
                if (absNum >= 1e9) return (num / 1e9).toFixed(1) + 'B';
                if (absNum >= 1e6) return (num / 1e6).toFixed(1) + 'M';
                if (absNum >= 1e3) return (num / 1e3).toFixed(0) + 'K';
                return num.toLocaleString('id-ID');
            }
        }
        
        // Format number for display
        function formatNumber(num) {
            if (num === 0) return '0';
            const absNum = Math.abs(num);
            // Use 'B' for billion and 'M' for million for shorter text
            if (absNum >= 1e9) return (num / 1e9).toFixed(1) + 'B';
            if (absNum >= 1e6) return (num / 1e6).toFixed(1) + 'M';
            if (absNum >= 1e3) return (num / 1e3).toFixed(0) + 'K';
            return num.toFixed(0);
        }
        
        // Save scenario functions
        function saveCurrentScenario() {
            const modal = document.getElementById('saveScenarioModal');
            modal.style.display = 'flex';
            modal.classList.add('show');
            document.getElementById('scenarioName').value = scenarioState.scenarioName;
        }
        
        function closeSaveScenarioModal() {
            const modal = document.getElementById('saveScenarioModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300); // Wait for transition to finish
        }
        
        async function confirmSaveScenario() {
            const name = document.getElementById('scenarioName').value;
            const description = document.getElementById('scenarioDescription').value;
            
            if (!name.trim()) {
                alert('Please enter a scenario name');
                return;
            }
            
            try {
                // Get current user
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    throw new Error('User not authenticated');
                }
                
                const scenarioToSave = {
                    user_id: user.id,
                    name: name.trim(),
                    description: description.trim(),
                    adjustments: scenarioState.adjustments,
                    one_time_events: scenarioState.oneTimeEvents,
                    affected_years: scenarioState.affectedYears,
                    current_scenario: scenarioState.currentScenario
                };
                
                // Save to Supabase
                const { data, error } = await supabase
                    .from('scenario_analysis')
                    .insert([scenarioToSave])
                    .select();
                
                if (error) {
                    throw error;
                }
                
                console.log(' Scenario saved to Supabase:', data[0]);
                
                // Also save to localStorage for quick access
                const savedScenarios = JSON.parse(localStorage.getItem('montpro_scenarios') || '[]');
                savedScenarios.push({
                    id: data[0].id,
                    name: data[0].name,
                    description: data[0].description,
                    adjustments: data[0].adjustments,
                    oneTimeEvents: data[0].one_time_events,
                    affectedYears: data[0].affected_years,
                    createdAt: data[0].created_at,
                    currentScenario: data[0].current_scenario
                });
                localStorage.setItem('montpro_scenarios', JSON.stringify(savedScenarios));
                
                closeSaveScenarioModal();
                showSuccessMessage('Scenario saved successfully to cloud!');
                
            } catch (error) {
                console.error('Error saving scenario:', error);
                showErrorMessage('Failed to save scenario: ' + error.message);
            }
        }
        
        // Load saved scenarios
        async function loadSavedScenarios() {
            try {
                // Get current user
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    showErrorMessage('Please log in to access saved scenarios');
                    return;
                }
                
                // Load from Supabase
                const { data, error } = await supabase
                    .from('scenario_analysis')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    throw error;
                }
                
                if (data.length === 0) {
                    showInfoMessage('No saved scenarios found');
                    return;
                }
                
                // Convert Supabase format to expected format
                const scenarios = data.map(scenario => ({
                    id: scenario.id,
                    name: scenario.name,
                    description: scenario.description,
                    adjustments: scenario.adjustments,
                    oneTimeEvents: scenario.one_time_events,
                    affectedYears: scenario.affected_years,
                    createdAt: scenario.created_at,
                    currentScenario: scenario.current_scenario
                }));
                
                showSavedScenariosModal(scenarios);
                
            } catch (error) {
                console.error('Error loading scenarios:', error);
                showErrorMessage('Failed to load scenarios: ' + error.message);
            }
        }
        
        // Show saved scenarios modal
        function showSavedScenariosModal(scenarios) {
            // Create modal HTML dynamically with new classes
            const modalHTML = `
                <div id="loadScenariosModal" class="load-scenarios-overlay">
                    <div class="load-scenarios-modal">
                        <div class="load-scenarios-header">
                            <h3 class="load-scenarios-title">Load Saved Scenario</h3>
                            <button class="load-scenarios-close" onclick="closeLoadScenariosModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="load-scenarios-body">
                            ${scenarios.map(scenario => `
                                <div class="scenario-list-item" onclick="loadScenario('${scenario.id}')">
                                    <div class="scenario-item-header">
                                        <div class="scenario-item-name">${scenario.name}</div>
                                        <div class="scenario-item-date">${new Date(scenario.createdAt).toLocaleDateString()}</div>
                                    </div>
                                    <div class="scenario-item-description">${scenario.description || 'No description'}</div>
                                    <div class="scenario-item-actions" onclick="event.stopPropagation()">
                                        <button class="scenario-action-btn scenario-load-btn" onclick="loadScenario('${scenario.id}')">
                                            <i class="fas fa-download"></i> Load
                                        </button>
                                        <button class="scenario-action-btn scenario-delete-btn" onclick="deleteScenario('${scenario.id}')">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal
            const existingModal = document.getElementById('loadScenariosModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = document.getElementById('loadScenariosModal');
            modal.classList.add('show');
        }
        
        // Load specific scenario
        async function loadScenario(scenarioId) {
            try {
                let scenario = null;
                
                // Convert scenarioId to number for consistent comparison
                const idAsNumber = Number(scenarioId);
                
                // First try to find in localStorage
                const savedScenarios = JSON.parse(localStorage.getItem('montpro_scenarios') || '[]');
                scenario = savedScenarios.find(s => Number(s.id) === idAsNumber);
                
                // If not found in localStorage, fetch from Supabase
                if (!scenario) {
                    const { data: { user } } = await supabase.auth.getUser();
                    if (!user) {
                        showErrorMessage('Please log in to load scenarios');
                        return;
                    }
                    
                    const { data, error } = await supabase
                        .from('scenario_analysis')
                        .select('*')
                        .eq('id', idAsNumber)
                        .single();
                    
                    if (error) {
                        throw error;
                    }
                    
                    if (data) {
                        // Convert Supabase format to expected format
                        scenario = {
                            id: data.id,
                            name: data.name,
                            description: data.description,
                            adjustments: data.adjustments,
                            oneTimeEvents: data.one_time_events, // Convert field name
                            affectedYears: data.affected_years,
                            createdAt: data.created_at,
                            currentScenario: data.current_scenario
                        };
                    }
                }
                
                if (!scenario) {
                    showErrorMessage('Scenario not found');
                    return;
                }
                
                console.log('Loading scenario:', scenario); // Debug log
                
                // Load scenario data with proper defaults
                scenarioState.adjustments = scenario.adjustments || { revenue: 0, cogs: 0, opex: 0 };
                scenarioState.oneTimeEvents = scenario.oneTimeEvents || [];
                scenarioState.affectedYears = scenario.affectedYears || [2026, 2027, 2028, 2029, 2030];
                scenarioState.scenarioName = scenario.name;
                
                // Update UI
                updateYearButtons();
                updateSliders();
                updateEventsList();
                recalculateScenario();
                
                closeLoadScenariosModal();
                showSuccessMessage(`Loaded scenario: ${scenario.name}`);
                
            } catch (error) {
                console.error('Error loading scenario:', error);
                showErrorMessage('Failed to load scenario: ' + error.message);
            }
        }
        
        // Update year buttons based on affected years
        function updateYearButtons() {
            [2026, 2027, 2028, 2029, 2030].forEach(year => {
                const btn = document.querySelector(`button[data-year="${year}"]`);  //  Add "button"
                if (btn) {
                    if (scenarioState.affectedYears.includes(year)) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                }
            });
        }
        
        // Update sliders based on current adjustments
        function updateSliders() {
            document.getElementById('revenueSlider').value = scenarioState.adjustments.revenue;
            document.getElementById('cogsSlider').value = scenarioState.adjustments.cogs;
            document.getElementById('opexSlider').value = scenarioState.adjustments.opex;
            
            document.getElementById('revenueInput').value = scenarioState.adjustments.revenue;
            document.getElementById('cogsInput').value = scenarioState.adjustments.cogs;
            document.getElementById('opexInput').value = scenarioState.adjustments.opex;
        }
        
        // Delete saved scenario
        async function deleteScenario(scenarioId) {
            if (!confirm('Are you sure you want to delete this scenario?')) {
                return;
            }
            
            try {
                // Delete from Supabase
                const { error } = await supabase
                    .from('scenario_analysis')
                    .delete()
                    .eq('id', scenarioId);
                
                if (error) {
                    throw error;
                }
                
                // Also remove from localStorage
                const savedScenarios = JSON.parse(localStorage.getItem('montpro_scenarios') || '[]');
                const filteredScenarios = savedScenarios.filter(s => s.id !== scenarioId);
                localStorage.setItem('montpro_scenarios', JSON.stringify(filteredScenarios));
                
                // Refresh the modal
                closeLoadScenariosModal();
                setTimeout(() => loadSavedScenarios(), 100);
                
                showSuccessMessage('Scenario deleted successfully');
                
            } catch (error) {
                console.error('Error deleting scenario:', error);
                showErrorMessage('Failed to delete scenario: ' + error.message);
            }
        }
        
        // Close load scenarios modal
        function closeLoadScenariosModal() {
            const modal = document.getElementById('loadScenariosModal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }
        
        // Utility functions for messages
        function showSuccessMessage(message) {
            showToast(message, 'success');
        }
        
        function showErrorMessage(message) {
            showToast(message, 'error');
        }
        
        function showInfoMessage(message) {
            showToast(message, 'info');
        }
        
        // Add CSS for scenario-specific styles if needed
        function addScenarioStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .scenario-slider {
                    width: 100%;
                    margin: 0.5rem 0;
                }
                
                .slider-value {
                    text-align: center;
                    font-weight: 600;
                    color: #1f2937;
                }
                
                .positive {
                    color: #059669;
                }
                
                .negative {
                    color: #dc2626;
                }
                
                .events-list {
                    max-height: 200px;
                    overflow-y: auto;
                }
                
                .modal-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                }
                
                .saved-scenarios-list {
                    max-height: 400px;
                    overflow-y: auto;
                }
                
                .scenario-item:hover {
                    background: #f8fafc;
                    border-color: #3b82f6 !important;
                }
        
                /* MISSING CSS - Add this for year button active state */
                .scenario-year-btn.active {
                    background: #1e40af !important;
                    color: white !important;
                    border-color: #1e40af !important;
                }
        
                .scenario-year-btn {
                    transition: all 0.2s ease;
                }
        
                /* Fix z-index issues */
                .metric-card .metric-icon.icon-calendar {
                    pointer-events: none;
                    z-index: 1;
                }
        
                .scenario-year-selector {
                    position: relative;
                    z-index: 10;
                }
        
                .scenario-year-btn {
                    position: relative;
                    z-index: 10;
                }

                .metric-icon {
                    pointer-events: none !important;
                    z-index: 1;
                }
                
                .scenario-slider {
                    pointer-events: auto !important;
                    position: relative;
                    z-index: 10;
                }
                
                .filter-section {
                    position: relative;
                    z-index: 10;
                }
                
                .metric-content {
                    position: relative;
                    z-index: 10;
                }

                .content-card + .content-card {
                    margin-top: 2rem;
                }
    
                /* Enhanced percentage input styling - target actual classes */
                input.filter-input[type="number"] {
                    text-align: center !important;
                    font-weight: 700 !important;
                    font-size: 1.1rem !important;
                    color: #1e40af !important;
                    background: #f0f9ff !important;
                    border: 2px solid #bfdbfe !important;
                    border-radius: 8px !important;
                    padding: 0.5rem !important;
                    transition: all 0.2s ease !important;
                }
                
                input.filter-input[type="number"]:focus {
                    outline: none !important;
                    border-color: #3b82f6 !important;
                    background: #ffffff !important;
                    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
                }
                
                /* Style the % symbol next to sliders */
                .metric-content div[style*="display: flex"] span {
                    font-weight: 700 !important;
                    font-size: 1.1rem !important;
                    color: #1e40af !important;
                    background: #dbeafe !important;
                    padding: 0.5rem 0.75rem !important;
                    border-radius: 6px !important;
                    border: 1px solid #bfdbfe !important;
                }

                .filter-input {
                    font-weight: 600 !important;
                    font-size: 1rem !important;
                    color: #1e40af !important;
                    background: #f0f9ff !important;
                    border: 2px solid #bfdbfe !important;
                    border-radius: 8px !important;
                    padding: 0.5rem 0.75rem !important;
                    transition: all 0.2s ease !important;
                }
                
                .filter-input:focus {
                    outline: none !important;
                    border-color: #3b82f6 !important;
                    background: #ffffff !important;
                    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
                }
                
                .filter-input::placeholder {
                    color: #64748b !important;
                    font-weight: 400 !important;
                }
                
                /* Special styling for number inputs (percentage fields) */
                input.filter-input[type="number"] {
                    text-align: center !important;
                    font-weight: 700 !important;
                    font-size: 1.1rem !important;
                    width: 80px !important;
                }
                
                /* Select dropdown specific styling */
                select.filter-input {
                    cursor: pointer !important;
                    appearance: none !important;
                    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e") !important;
                    background-position: right 0.5rem center !important;
                    background-repeat: no-repeat !important;
                    background-size: 1.5em 1.5em !important;
                    padding-right: 2.5rem !important;
                }
            `;
            
            document.head.appendChild(style);
        }
        
        // Initialize everything when the scenarios section is first shown
        function initializeScenarios() {
            console.log(' Initializing scenarios...');
            
            // Always reinitialize to get fresh data
            initializeScenarioAnalysis();
            addScenarioStyles();
            
            // Force a recalculation to populate the table
            setTimeout(() => {
                if (scenarioState.baseCase) {
                    updateScenarioComparison();
                }
            }, 100);
        }

        function applyCurrentScenario() {
            const hasAdjustments = scenarioState.adjustments.revenue !== 0 || 
                                  scenarioState.adjustments.cogs !== 0 || 
                                  scenarioState.adjustments.opex !== 0;
            
            if (!hasAdjustments) {
                alert('No adjustments to apply. Please set some values in the sliders first.');
                return;
            }
            
            // Create events for each affected year and each non-zero adjustment
            scenarioState.affectedYears.forEach(year => {
                if (scenarioState.adjustments.revenue !== 0) {
                    scenarioState.oneTimeEvents.push({
                        description: `Revenue ${scenarioState.adjustments.revenue >= 0 ? 'increase' : 'decrease'} ${Math.abs(scenarioState.adjustments.revenue)}%`,
                        plLine: 'revenue',
                        amount: 0, // Percentage-based, not absolute amount
                        percentage: scenarioState.adjustments.revenue,
                        year: year,
                        id: Date.now() + Math.random(),
                        type: 'scenario'
                    });
                }
                
                if (scenarioState.adjustments.cogs !== 0) {
                    scenarioState.oneTimeEvents.push({
                        description: `COGS ${scenarioState.adjustments.cogs >= 0 ? 'increase' : 'decrease'} ${Math.abs(scenarioState.adjustments.cogs)}%`,
                        plLine: 'cogs',
                        amount: 0,
                        percentage: scenarioState.adjustments.cogs,
                        year: year,
                        id: Date.now() + Math.random(),
                        type: 'scenario'
                    });
                }
                
                if (scenarioState.adjustments.opex !== 0) {
                    scenarioState.oneTimeEvents.push({
                        description: `OpEx ${scenarioState.adjustments.opex >= 0 ? 'increase' : 'decrease'} ${Math.abs(scenarioState.adjustments.opex)}%`,
                        plLine: 'opex',
                        amount: 0,
                        percentage: scenarioState.adjustments.opex,
                        year: year,
                        id: Date.now() + Math.random(),
                        type: 'scenario'
                    });
                }
            });
            
            // Reset sliders but DON'T clear events
            scenarioState.adjustments = { revenue: 0, cogs: 0, opex: 0 };
            scenarioState.scenarioName = 'Base Case';
            
            // Reset sliders and inputs
            document.getElementById('revenueSlider').value = 0;
            document.getElementById('cogsSlider').value = 0;
            document.getElementById('opexSlider').value = 0;
            
            document.getElementById('revenueInput').value = 0;
            document.getElementById('cogsInput').value = 0;
            document.getElementById('opexInput').value = 0;
            
            // Update events list
            updateEventsList();
            
            showSuccessMessage('Scenario applied to selected years!');
        }

        // Function to reset everything including logged events
        function resetAllScenarios() {
            scenarioState.adjustments = { revenue: 0, cogs: 0, opex: 0 };
            scenarioState.oneTimeEvents = [];
            scenarioState.scenarioName = 'Base Case';
            scenarioState.currentScenario = JSON.parse(JSON.stringify(scenarioState.baseCase));
            
            // Reset sliders and inputs
            document.getElementById('revenueSlider').value = 0;
            document.getElementById('cogsSlider').value = 0;
            document.getElementById('opexSlider').value = 0;
            
            document.getElementById('revenueInput').value = 0;
            document.getElementById('cogsInput').value = 0;
            document.getElementById('opexInput').value = 0;
            
            updateEventsList();
            updateScenarioComparison();
        }

        // Convert current forecast to budget
        async function convertForecastToBudget(event) {
            // Check if forecast exists
            const forecastTable = document.getElementById('plForecastTable');
            if (!forecastTable || forecastTable.rows.length <= 1) {
                alert('Please generate a forecast first');
                return;
            }
            
            const industry = document.getElementById('forecastIndustrySelect')?.value || 'saas';
            const forecastStyle = document.getElementById('forecastStyleSelect')?.value || 'normal';
            const currentYear = new Date().getFullYear();
            const budgetYear = currentYear;
            
            // Check if budget already exists and show appropriate message
            const existingBudget = await checkExistingBudget(budgetYear);
            const actionText = existingBudget ? 'replace existing' : 'create new';
            
            if (!confirm(`Convert current forecast to ${actionText} budget for ${budgetYear}?`)) {
                return;
            }
            
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Converting...';
            button.disabled = true;
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');
                
                const latestForecastId = localStorage.getItem('latest_2025_forecast_id') || localStorage.getItem('latest_forecast_id') || '1';
                const forecastTableName = 'ai_forecasts_meridash';
                
                const { data, error } = await supabase.rpc('convert_forecast_to_budget', {
                    p_user_id: user.id,
                    p_forecast_id: latestForecastId,
                    p_forecast_table: forecastTableName,
                    p_budget_year: budgetYear,
                    p_budget_name: `Budget ${budgetYear} (${industry} - ${forecastStyle})`,
                    p_description: `Budget converted from AI forecast on ${new Date().toLocaleDateString()}`
                });
                
                if (error) throw error;
                
                console.log(' Forecast converted to budget successfully');
                
                // Update budget year selector and switch to budgets
                document.getElementById('budgetYearSelect').value = budgetYear;
                showSection('budgets');
                await loadBudgetYear();
                
                const resultText = existingBudget ? 'replaced' : 'created';
                showSuccessMessage(`${budgetYear} budget ${resultText} successfully from forecast!`);
                
            } catch (error) {
                console.error('Error converting forecast:', error);
                showErrorMessage('Failed to convert forecast: ' + error.message);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        async function convert2026ForecastToBudget(event) {
            const forecastTable = document.getElementById('plForecast2026Table');
            if (!forecastTable || forecastTable.rows.length <= 1) {
                alert('Please generate a 2026 forecast first');
                return;
            }
            
            const industry = document.getElementById('forecast2026IndustrySelect')?.value || 'saas';
            const forecastStyle = document.getElementById('forecast2026StyleSelect')?.value || 'normal';
            
            const existingBudget = await checkExistingBudget(2026);
            const actionText = existingBudget ? 'replace existing' : 'create new';
            
            if (!confirm(`Convert 2026 forecast to ${actionText} budget?`)) {
                return;
            }
            
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Converting...';
            button.disabled = true;
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');
                
                // Get the latest 2026 forecast ID
                let latest2026ForecastId = localStorage.getItem('latest_2026_forecast_id');
                
                if (!latest2026ForecastId) {
                    const { data: forecasts, error: fetchError } = await supabase
                        .from('ai_forecasts_2026_meridash')
                        .select('id')
                        .eq('user_id', user.id)
                        .eq('forecast_year', 2026)
                        .order('generated_at', { ascending: false })
                        .limit(1);
                    
                    if (fetchError) throw fetchError;
                    
                    if (forecasts && forecasts.length > 0) {
                        latest2026ForecastId = forecasts[0].id.toString();
                        localStorage.setItem('latest_2026_forecast_id', latest2026ForecastId);
                    } else {
                        throw new Error('No 2026 forecast found. Please generate a 2026 forecast first.');
                    }
                }
                
                console.log(` Converting 2026 forecast ID: ${latest2026ForecastId} to budget`);
                
                // Use direct conversion instead of RPC
                await convert2026ForecastToBudgetDirect(latest2026ForecastId, industry, forecastStyle);
                
                console.log(' 2026 forecast converted to budget successfully');
                
                document.getElementById('budgetYearSelect').value = 2026;
                showSection('budgets');
                await loadBudgetYear(2026);
                
                const resultText = existingBudget ? 'replaced' : 'created';
                showSuccessMessage(`2026 budget ${resultText} successfully from forecast!`);
                
            } catch (error) {
                console.error('Error converting 2026 forecast:', error);
                showErrorMessage('Failed to convert 2026 forecast: ' + error.message);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Dynamic conversion function for 2026 forecasts
        async function convert2026ForecastToBudgetDirect(forecastId = null, industry = 'saas', forecastStyle = 'normal') {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');
                
                // Use provided forecast ID or get from localStorage
                const latest2026ForecastId = forecastId || localStorage.getItem('latest_2026_forecast_id');
                if (!latest2026ForecastId) {
                    throw new Error('No 2026 forecast ID available');
                }
                
                console.log(' Starting dynamic 2026 forecast to budget conversion...');
                
                // Get the 2026 forecast data
                const { data: forecastData, error: forecastError } = await supabase
                    .from('ai_forecasts_2026_meridash')
                    .select('*')
                    .eq('user_id', user.id)
                    .eq('id', latest2026ForecastId)
                    .single();
                    
                if (forecastError) throw forecastError;
                if (!forecastData || !forecastData.monthly_data) {
                    throw new Error('No 2026 forecast data found');
                }
                
                // Get user's GL accounts for mapping
                const { data: glAccounts, error: glError } = await supabase
                    .from('gl_accounts_meridash')
                    .select('account_code, account_name, category')
                    .eq('user_id', user.id)
                    .eq('is_active', true)
                    .order('account_code');
                    
                if (glError) throw glError;
                
                console.log(' Found', glAccounts.length, 'active GL accounts');
                
                // Create account mapping helper
                const getAccountByCode = (code) => glAccounts.find(acc => acc.account_code === code.toString());
                const getAccountsByCategory = (category) => glAccounts.filter(acc => acc.category === category);
                
                // Delete existing 2026 budget data
                const { error: deleteError } = await supabase
                    .from('budgets')
                    .delete()
                    .eq('user_id', user.id)
                    .eq('budget_year', 2026);
                    
                if (deleteError) throw deleteError;
                
                // Delete existing 2026 budget metadata
                const { error: deleteMetaError } = await supabase
                    .from('budget_metadata')
                    .delete()
                    .eq('user_id', user.id)
                    .eq('budget_year', 2026);
                    
                if (deleteMetaError) throw deleteMetaError;
                
                console.log(' Cleared existing 2026 budget data');
                
                // Convert monthly data to budget entries dynamically
                const budgetEntries = [];
                
                forecastData.monthly_data.forEach((monthData, index) => {
                    const month = index + 1;
                    
                    // REVENUE MAPPING
                    // Map sales_revenue to account 4010 if it exists
                    if (monthData.sales_revenue && monthData.sales_revenue > 0) {
                        const salesAccount = getAccountByCode('4010');
                        if (salesAccount) {
                            budgetEntries.push({
                                user_id: user.id,
                                budget_year: 2026,
                                budget_month: month,
                                category: 'revenue',
                                account_code: parseInt(salesAccount.account_code),
                                line_item_name: salesAccount.account_code,
                                amount: monthData.sales_revenue,
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            });
                        }
                    }
                    
                    // Map service_revenue to account 4020 if it exists
                    if (monthData.service_revenue && monthData.service_revenue > 0) {
                        const serviceAccount = getAccountByCode('4020');
                        if (serviceAccount) {
                            budgetEntries.push({
                                user_id: user.id,
                                budget_year: 2026,
                                budget_month: month,
                                category: 'revenue',
                                account_code: parseInt(serviceAccount.account_code),
                                line_item_name: serviceAccount.account_code,
                                amount: monthData.service_revenue,
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            });
                        }
                    }
                    
                    // If no specific revenue breakdown, use total_revenue in first available revenue account
                    if (monthData.total_revenue && monthData.total_revenue > 0 && !monthData.sales_revenue && !monthData.service_revenue) {
                        const revenueAccounts = getAccountsByCategory('Revenue');
                        if (revenueAccounts.length > 0) {
                            const primaryRevenue = revenueAccounts.find(acc => acc.account_code === '4010') || revenueAccounts[0];
                            budgetEntries.push({
                                user_id: user.id,
                                budget_year: 2026,
                                budget_month: month,
                                category: 'revenue',
                                account_code: parseInt(primaryRevenue.account_code),
                                line_item_name: primaryRevenue.account_code,
                                amount: monthData.total_revenue,
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            });
                        }
                    }
                    
                    // COGS MAPPING
                    // Map direct_costs to COGS account (5010 preferred, or first available expense account starting with 50xx)
                    if (monthData.direct_costs && monthData.direct_costs > 0) {
                        const cogsAccount = getAccountByCode('5010') || glAccounts.find(acc => 
                            acc.category === 'Expense' && acc.account_code.startsWith('50')
                        );
                        if (cogsAccount) {
                            budgetEntries.push({
                                user_id: user.id,
                                budget_year: 2026,
                                budget_month: month,
                                category: 'cogs',
                                account_code: parseInt(cogsAccount.account_code),
                                line_item_name: cogsAccount.account_code,
                                amount: monthData.direct_costs,
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            });
                        }
                    }
                    
                    // If no direct_costs but has total_cogs, use that
                    if (monthData.total_cogs && monthData.total_cogs > 0 && !monthData.direct_costs) {
                        const cogsAccount = getAccountByCode('5010') || glAccounts.find(acc => 
                            acc.category === 'Expense' && acc.account_code.startsWith('50')
                        );
                        if (cogsAccount) {
                            budgetEntries.push({
                                user_id: user.id,
                                budget_year: 2026,
                                budget_month: month,
                                category: 'cogs',
                                account_code: parseInt(cogsAccount.account_code),
                                line_item_name: cogsAccount.account_code,
                                amount: monthData.total_cogs,
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            });
                        }
                    }
                    
                    // OPEX MAPPING
                    // Map operating_expenses to OpEx account (5100 preferred, or distribute across available expense accounts)
                    if (monthData.operating_expenses && monthData.operating_expenses > 0) {
                        const opexAccount = getAccountByCode('5100') || getAccountByCode('5200') || glAccounts.find(acc => 
                            acc.category === 'Expense' && (acc.account_code.startsWith('51') || acc.account_code.startsWith('52'))
                        );
                        if (opexAccount) {
                            budgetEntries.push({
                                user_id: user.id,
                                budget_year: 2026,
                                budget_month: month,
                                category: 'opex',
                                account_code: parseInt(opexAccount.account_code),
                                line_item_name: opexAccount.account_code,
                                amount: monthData.operating_expenses,
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            });
                        }
                    }
                    
                    // If no operating_expenses but has total_opex, use that
                    if (monthData.total_opex && monthData.total_opex > 0 && !monthData.operating_expenses) {
                        const opexAccount = getAccountByCode('5100') || getAccountByCode('5200') || glAccounts.find(acc => 
                            acc.category === 'Expense' && (acc.account_code.startsWith('51') || acc.account_code.startsWith('52'))
                        );
                        if (opexAccount) {
                            budgetEntries.push({
                                user_id: user.id,
                                budget_year: 2026,
                                budget_month: month,
                                category: 'opex',
                                account_code: parseInt(opexAccount.account_code),
                                line_item_name: opexAccount.account_code,
                                amount: monthData.total_opex,
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            });
                        }
                    }
                });
                
                console.log(` Inserting ${budgetEntries.length} budget entries using dynamic GL account mapping...`);
                
                // Insert budget entries
                const { error: insertError } = await supabase
                    .from('budgets')
                    .insert(budgetEntries);
                    
                if (insertError) throw insertError;
                
                // Create budget metadata with calculated totals
                const totalRevenue = forecastData.year_totals?.total_revenue || 0;
                const totalExpenses = (forecastData.year_totals?.total_cogs || 0) + (forecastData.year_totals?.total_opex || 0);
                const netProfit = totalRevenue - totalExpenses;
                
                const { error: metaError } = await supabase
                    .from('budget_metadata')
                    .insert({
                        user_id: user.id,
                        budget_year: 2026,
                        budget_name: `Budget 2026 (${industry} - ${forecastStyle})`,
                        description: `Budget converted from 2026 AI forecast on ${new Date().toLocaleDateString()}`,
                        status: 'draft',
                        source_type: 'ai_forecast_2026',
                        total_revenue: totalRevenue,
                        total_expenses: totalExpenses,
                        net_profit: netProfit,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                    
                if (metaError) throw metaError;
                
                console.log(' Dynamic 2026 budget conversion completed successfully!');
                console.log(` Mapped to ${new Set(budgetEntries.map(e => e.account_code)).size} different GL accounts`);
                return true;
                
            } catch (error) {
                console.error(' Error in dynamic 2026 conversion:', error);
                throw error;
            }
        }
        
        // Updated multi-year conversion function
        async function convertMultiYearForecastToBudget(event) {
            const selectedYear = prompt('Which year do you want to convert to budget?\nEnter: 2027, 2028, 2029, or 2030');
            const year = parseInt(selectedYear);
            
            if (!year || year < 2027 || year > 2030) {
                alert('Please enter a valid year (2027-2030)');
                return;
            }
            
            const industry = document.getElementById('forecastMultiYearIndustrySelect')?.value || 'saas';
            const forecastStyle = document.getElementById('forecastMultiYearStyleSelect')?.value || 'normal';
            
            const existingBudget = await checkExistingBudget(year);
            const actionText = existingBudget ? 'replace existing' : 'create new';
            
            if (!confirm(`Convert ${year} forecast to ${actionText} budget?`)) {
                return;
            }
            
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Converting...';
            button.disabled = true;
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');
                
                let latestMultiYearForecastId = localStorage.getItem('latest_multiyear_forecast_id');
                
                if (!latestMultiYearForecastId) {
                    const { data: forecasts, error } = await supabase
                        .from('ai_forecasts_multiyear_meridash')
                        .select('id')
                        .eq('user_id', user.id)
                        .order('created_at', { ascending: false })
                        .limit(1);
                    
                    if (error) throw error;
                    
                    if (forecasts && forecasts.length > 0) {
                        latestMultiYearForecastId = forecasts[0].id;
                        localStorage.setItem('latest_multiyear_forecast_id', latestMultiYearForecastId);
                    } else {
                        throw new Error('No multi-year forecast found. Please generate a multi-year forecast first.');
                    }
                }
                
                const { data, error } = await supabase.rpc('convert_forecast_to_budget', {
                    p_user_id: user.id,
                    p_forecast_id: latestMultiYearForecastId,
                    p_forecast_table: 'ai_forecasts_multiyear_meridash',
                    p_budget_year: year,
                    p_budget_name: `Budget ${year} (${industry} - ${forecastStyle})`,
                    p_description: `Budget converted from multi-year forecast on ${new Date().toLocaleDateString()}`
                });
                
                if (error) throw error;
                
                // Add the year to budget selector if not present
                const budgetYearSelect = document.getElementById('budgetYearSelect');
                if (!Array.from(budgetYearSelect.options).some(option => option.value == year)) {
                    const newOption = document.createElement('option');
                    newOption.value = year;
                    newOption.textContent = `Budget ${year}`;
                    budgetYearSelect.appendChild(newOption);
                }
                
                budgetYearSelect.value = year;
                showSection('budgets');
                await loadBudgetYear();
                
                const resultText = existingBudget ? 'replaced' : 'created';
                showSuccessMessage(`${year} budget ${resultText} successfully from multi-year forecast!`);
                
            } catch (error) {
                console.error(`Error converting ${year} forecast:`, error);
                showErrorMessage(`Failed to convert ${year} forecast: ` + error.message);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        async function checkExistingBudget(year) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return false;
                
                const { data, error } = await supabase
                    .from('budget_metadata')
                    .select('budget_year')
                    .eq('user_id', user.id)
                    .eq('budget_year', year)
                    .single();
                    
                return data ? true : false;
            } catch (error) {
                return false;
            }
        }
        
        // Helper function to track latest forecast ID
        function trackLatestForecastId(forecastId, forecastTable) {
            // Store the general latest forecast info (keep your existing functionality)
            localStorage.setItem('latest_forecast_id', forecastId);
            localStorage.setItem('latest_forecast_table', forecastTable);
            
            // Also store specific forecast type IDs for easier retrieval
            switch(forecastTable) {
                case 'ai_forecasts_meridash':
                    localStorage.setItem('latest_2025_forecast_id', forecastId);
                    break;
                case 'ai_forecasts_2026_meridash':
                    localStorage.setItem('latest_2026_forecast_id', forecastId);
                    break;
                case 'ai_forecasts_multiyear_meridash':
                    localStorage.setItem('latest_multiyear_forecast_id', forecastId);
                    break;
            }
            
            console.log(` Tracked forecast ID: ${forecastId} for table: ${forecastTable}`);
        }
        
        function extractForecastData() {
            // Extract data from your current forecast table
            const table = document.getElementById('plForecastTable');
            // Implementation depends on your current forecast table structure
            return forecastData;
        }
        
        function convertToDetailedBudget(forecastData) {
            // Convert forecast data to detailed budget structure
            const budgetData = [];
            const currentYear = new Date().getFullYear() + 1; // Next year
            
            // For each month, create detailed budget entries
            for (let month = 1; month <= 12; month++) {
                budgetData.push({
                    budget_year: currentYear,
                    budget_month: month,
                    source: 'ai_forecast',
                    // Revenue breakdown (start with forecast total, allow editing)
                    revenue_total: forecastData.revenue[month] || 0,
                    revenue_products: forecastData.revenue[month] * 0.6 || 0, // Default splits
                    revenue_services: forecastData.revenue[month] * 0.3 || 0,
                    revenue_subscriptions: forecastData.revenue[month] * 0.1 || 0,
                    // COGS
                    cogs_total: forecastData.cogs[month] || 0,
                    // OpEx breakdown
                    opex_total: forecastData.opex[month] || 0,
                    opex_salaries: forecastData.opex[month] * 0.6 || 0, // Default splits
                    opex_marketing: forecastData.opex[month] * 0.2 || 0,
                    opex_office: forecastData.opex[month] * 0.1 || 0,
                    opex_technology: forecastData.opex[month] * 0.1 || 0,
                    status: 'draft'
                });
            }
            
            return budgetData;
        }

        async function saveBudget() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    alert('Please log in to save budget');
                    return;
                }
        
                const selectedYear = parseInt(document.getElementById('budgetYearSelect').value);
                if (!selectedYear) {
                    alert('Please select a budget year first');
                    return;
                }
        
                console.log(` Saving budget for year: ${selectedYear}`);
        
                // Show loading state
                const saveButton = document.querySelector('.btn-save-budget');
                const originalText = saveButton.innerHTML;
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveButton.disabled = true;
        
                // Collect budget data from the table
                const budgetData = [];
                const lineRows = document.querySelectorAll('.budget-line-row');
        
                lineRows.forEach(row => {
                    const accountCode = row.dataset.accountCode;
                    const category = row.dataset.parentCategory;
                    const lineName = row.dataset.lineName;
        
                    // Get monthly amounts from input fields
                    for (let month = 1; month <= 12; month++) {
                        const input = row.querySelector(`input[data-month="${month}"]`);
                        const amount = parseFloat(input?.value || 0);
        
                        if (amount > 0) { // Only save non-zero amounts
                            budgetData.push({
                                budget_year: selectedYear,
                                budget_month: month,
                                category: category,
                                account_code: parseInt(accountCode),
                                line_item_name: lineName,
                                amount: amount
                            });
                        }
                    }
                });
        
                if (budgetData.length === 0) {
                    alert('No budget data to save. Please add some budget line items first.');
                    return;
                }
        
                // Use your existing saveBudgetToSupabase function
                await saveBudgetToSupabase(budgetData);
        
                // Calculate totals for metadata
                const totals = calculateBudgetTotals();
                const totalRevenue = totals.revenue.reduce((sum, month) => sum + month, 0);
                const totalExpenses = totals.cogs.reduce((sum, month) => sum + month, 0) + 
                                     totals.opex.reduce((sum, month) => sum + month, 0);
                const netProfit = totalRevenue - totalExpenses;
        
                // Save budget metadata
                const { error: metaError } = await supabase
                    .from('budget_metadata')
                    .upsert({
                        user_id: user.id,
                        budget_year: selectedYear,
                        budget_name: `Budget ${selectedYear}`,
                        description: `Budget saved on ${new Date().toLocaleDateString()}`,
                        status: 'active',
                        source_type: 'manual',
                        total_revenue: totalRevenue,
                        total_expenses: totalExpenses,
                        net_profit: netProfit,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id,budget_year'
                    });
        
                if (metaError) throw metaError;
        
                // Update status badge
                updateBudgetStatus('active');
        
                console.log(` Budget saved successfully: ${budgetData.length} entries`);
                
                // Use your existing showSuccessNotification function
                showSuccessNotification(`Budget ${selectedYear} saved successfully!`);
        
            } catch (error) {
                console.error(' Error saving budget:', error);
                alert(`Failed to save budget: ${error.message}`);
            } finally {
                // Reset button state
                const saveButton = document.querySelector('.btn-save-budget');
                if (saveButton) {
                    saveButton.innerHTML = '<i class="fas fa-save"></i> Save Budget';
                    saveButton.disabled = false;
                }
            }
        }

        function calculateBudgetTotals(budgetData) {
            const totals = { revenue: 0, cogs: 0, opex: 0, ebitda: 0 };
            
            budgetData.forEach(entry => {
                const amount = parseFloat(entry.amount) || 0;
                const category = entry.budget_account_mapping?.category;
                
                switch(category) {
                    case 'Revenue':
                        totals.revenue += amount;
                        break;
                    case 'COGS':
                        totals.cogs += amount;
                        break;
                    case 'OPEX':
                        totals.opex += amount;
                        break;
                }
            });
            
            totals.ebitda = totals.revenue - totals.cogs - totals.opex;
            return totals;
        }

        function calculateDashboardIndustryPosition() {
            console.log('=== DEBUG: calculateDashboardIndustryPosition ===');
            console.log('companyFinancialMetrics:', window.companyFinancialMetrics);
            console.log('industryBenchmarkData:', window.industryBenchmarkData);
            console.log('selectedIndustries:', window.selectedIndustries);
            
            // Check if we have company metrics first
            if (!window.companyFinancialMetrics) {
                return { percentile: 0, status: 'No financial data' };
            }
            
            // Check if industry benchmarking data is available
            if (!window.industryBenchmarkData || !window.selectedIndustries || window.selectedIndustries.length === 0) {
                console.log('No industry benchmark data - user needs to set up benchmarking');
                return { percentile: 0, status: 'Set up benchmarking' };
            }
            
            try {
                // Calculate average percentile across key financial metrics
                const keyMetrics = ['ebitda_margin', 'gross_margin', 'net_margin', 'roe', 'current_ratio'];
                let totalPercentile = 0;
                let validMetrics = 0;
                
                keyMetrics.forEach(metric => {
                    const companyValue = window.companyFinancialMetrics[metric];
                    console.log(`Checking metric ${metric}:`, companyValue);
                    
                    if (companyValue !== undefined && companyValue !== null && !isNaN(companyValue)) {
                        const percentile = calculateMetricPercentile(metric, companyValue);
                        console.log(`${metric} percentile:`, percentile);
                        
                        if (percentile > 0) { // Only count valid percentiles
                            totalPercentile += percentile;
                            validMetrics++;
                        }
                    }
                });
                
                console.log(`Total percentile: ${totalPercentile}, Valid metrics: ${validMetrics}`);
                
                if (validMetrics === 0) {
                    return { percentile: 0, status: 'Insufficient data' };
                }
                
                // Calculate average percentile
                const avgPercentile = Math.round(totalPercentile / validMetrics);
                console.log('Average percentile:', avgPercentile);
                
                // Determine status based on average percentile
                let status;
                if (avgPercentile >= 75) {
                    status = 'Top Performer';
                } else if (avgPercentile >= 60) {
                    status = 'Above Average';
                } else if (avgPercentile >= 40) {
                    status = 'Average';
                } else if (avgPercentile >= 25) {
                    status = 'Below Average';
                } else {
                    status = 'Needs Improvement';
                }
                
                return { percentile: avgPercentile, status };
                
            } catch (error) {
                console.error('Error calculating industry position:', error);
                return { percentile: 0, status: 'Calculation error' };
            }
        }

        // Save budget data to Supabase
        async function saveBudgetToSupabase(budgetData) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    throw new Error('User not authenticated');
                }
        
                // Add user_id to each budget entry
                const budgetEntries = budgetData.map(entry => ({
                    ...entry,
                    user_id: user.id,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }));
        
                // First, delete existing budget entries for this year
                const { error: deleteError } = await supabase
                    .from('budgets')
                    .delete()
                    .eq('user_id', user.id)
                    .eq('budget_year', budgetEntries[0].budget_year);
        
                if (deleteError) throw deleteError;
        
                // Then insert the new entries
                const { data, error } = await supabase
                    .from('budgets')
                    .insert(budgetEntries);
        
                if (error) throw error;
                
                console.log('Budget saved successfully:', data);
                return data;
                
            } catch (error) {
                console.error('Error saving budget:', error);
                throw error;
            }
        }
        
        // Load budget data from Supabase
        async function loadBudgetFromSupabase(year) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    throw new Error('User not authenticated');
                }
        
                const { data, error } = await supabase
                    .from('budgets')
                    .select('*')
                    .eq('user_id', user.id)
                    .eq('budget_year', year)
                    .order('budget_month');
        
                if (error) throw error;
                
                return data || [];
                
            } catch (error) {
                console.error('Error loading budget:', error);
                return [];
            }
        }

        // Toggle budget category expand/collapse
        function toggleBudgetCategory(category) {
            const categoryRows = document.querySelectorAll(`tr[data-parent-category="${category}"]`);
            const toggleIcon = document.querySelector(`tr[data-category="${category}"] .budget-category-toggle i`);
            
            categoryRows.forEach(row => {
                if (row.classList.contains('hidden')) {
                    row.classList.remove('hidden');
                    toggleIcon.style.transform = 'rotate(0deg)';
                } else {
                    row.classList.add('hidden');
                    toggleIcon.style.transform = 'rotate(-90deg)';
                }
            });
        }
        
        // Add new budget line item
        async function addBudgetLine() {
            // Make sure GL accounts are loaded
            if (!window.glAccounts || window.glAccounts.length === 0) {
                await loadGLAccounts();
            }
            
            const modal = document.getElementById('addBudgetLineModal');
            const container = document.getElementById('glAccountListContainer');
            container.innerHTML = ''; 
        
            const categories = { 
                revenue: "Revenue Accounts", 
                cogs: "Cost of Goods Sold", 
                opex: "Operating Expenses" 
            };
        
            Object.entries(categories).forEach(([key, title]) => {
                const header = document.createElement('h4');
                header.textContent = title;
                header.style.cssText = 'margin-top: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e2e8f0; color: #374151;';
                container.appendChild(header);
        
                const accountGrid = document.createElement('div');
                accountGrid.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem;';
                
                let accounts = [];
                if (key === 'revenue') {
                    // Revenue accounts start with 4xxx
                    accounts = window.glAccounts.filter(acc => 
                        acc.account_code && acc.account_code.startsWith('4')
                    );
                } else if (key === 'cogs') {
                    // COGS is typically account 5010 and other cost-related accounts
                    accounts = window.glAccounts.filter(acc => 
                        acc.account_code && (
                            acc.account_code === '5010' || // Cost of Goods Sold
                            acc.account_code === '5020' || // Purchase Discounts  
                            acc.account_code === '5030'    // Freight In
                        )
                    );
                } else if (key === 'opex') {
                    // All other 5xxx accounts except COGS
                    accounts = window.glAccounts.filter(acc => 
                        acc.account_code && acc.account_code.startsWith('5') && 
                        !['5010', '5020', '5030'].includes(acc.account_code)
                    );
                }
                
                if (accounts.length > 0) {
                    accounts.forEach(account => {
                        const button = document.createElement('button');
                        button.className = 'btn btn-secondary';
                        button.style.cssText = 'text-align: left; padding: 0.5rem; font-size: 0.875rem;';
                        button.textContent = `${account.account_code} - ${account.account_name}`;
                        button.onclick = () => {
                            // Check if account already exists (any row with this account code)
                            const existingBudgetRow = document.querySelector(`tr.budget-line-row[data-account-code="${account.account_code}"]`);
                            if (existingBudgetRow) {
                                alert('This line item already exists in the budget.');
                                return;
                            }
                            
                            addBudgetLineToTable(key, `${account.account_code} - ${account.account_name}`, {}, account.account_code);
                            closeAddBudgetLineModal();
                            updateBudgetCalculations();
                        };
                        accountGrid.appendChild(button);
                    });
                } else {
                    accountGrid.innerHTML = `<p style="grid-column: 1 / -1; color: #64748b; font-style: italic;">No ${title} accounts found.</p>`;
                }
                container.appendChild(accountGrid);
            });
            
            modal.style.display = 'flex';
            modal.classList.add('show');
        }
        
        function closeAddBudgetLineModal() {
            const modal = document.getElementById('addBudgetLineModal');
            modal.classList.remove('show');
            // Optional: Set display to none after the CSS transition completes
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300); // 300ms matches the CSS transition duration
        }
        
        function addBudgetLineToTable(category, displayName, values = {}, accountCode) {
            const tableBody = document.getElementById('budgetTableBody');
            const categoryRow = document.querySelector(`tr[data-category="${category}"]`);
            
            // Check if row already exists
            let row = document.querySelector(`tr.budget-line-row[data-account-code="${accountCode}"]`);
            
            // If the row doesn't exist, create it
            if (!row) {
                row = document.createElement('tr');
                row.className = 'budget-line-row';
                row.dataset.parentCategory = category;
                row.dataset.lineName = displayName;
                row.dataset.accountCode = accountCode;
                
                // Insert after the category row
                if (categoryRow) {
                    categoryRow.parentNode.insertBefore(row, categoryRow.nextSibling);
                } else {
                    tableBody.appendChild(row);
                }
            }
        
            let inputsHTML = '';
            for(let i = 1; i <= 12; i++) {
                const monthKey = getMonthKey(i);
                inputsHTML += `<td class="budget-line-cell"><input type="number" class="budget-amount-input" data-month="${i}" value="${values[monthKey] || 0}" oninput="updateBudgetCalculations()"></td>`;
            }
        
            row.innerHTML = `
                <td class="budget-line-cell">
                    <div class="budget-line-name">${displayName}</div>
                </td>
                ${inputsHTML}
                <td class="budget-line-cell budget-line-total">Rp 0</td>
                <td class="budget-line-cell">
                    <div class="budget-line-actions">
                        <button class="budget-action-btn delete" onclick="deleteBudgetLine(this)" title="Delete"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            `;
            
            updateBudgetCalculations();
        }
        
        function clearBudgetTable() {
            document.querySelectorAll('.budget-line-row').forEach(row => row.remove());
            document.querySelectorAll('.budget-category-subtotal').forEach(row => row.remove()); // Remove existing subtotals
            addCategorySubtotals();  // Add fresh subtotals
            updateBudgetCalculations(); // Recalculate to zero out totals
        }

        function deleteBudgetLine(button) {
            if (confirm('Delete this budget line item?')) {
                button.closest('tr').remove();
                updateBudgetCalculations();
            }
        }

        // Update all budget calculations
        function updateBudgetCalculations() {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const totals = { revenue: Array(12).fill(0), cogs: Array(12).fill(0), opex: Array(12).fill(0) };
        
            // Calculate line totals and category totals
            document.querySelectorAll('.budget-line-row').forEach(row => {
                const category = row.dataset.parentCategory;
                let lineTotal = 0;
                row.querySelectorAll('.budget-amount-input').forEach((input, index) => {
                    const value = parseFloat(input.value) || 0;
                    totals[category][index] += value;
                    lineTotal += value;
                });
                row.querySelector('.budget-line-total').textContent = formatCurrencyFull(lineTotal, 'IDR');
            });
        
            // Calculate category subtotals
            const categories = ['revenue', 'cogs', 'opex'];
            categories.forEach(category => {
                const categoryLines = document.querySelectorAll(`tr[data-parent-category="${category}"]`);
                const subtotalRow = document.querySelector(`tr[data-subtotal="true"][data-category="${category}"]`);
                
                if (subtotalRow) {
                    let yearlyTotal = 0;
                    
                    // Calculate monthly subtotals
                    for (let month = 1; month <= 12; month++) {
                        let monthlyTotal = 0;
                        
                        categoryLines.forEach(line => {
                            const input = line.querySelector(`input[data-month="${month}"]`);
                            if (input) {
                                monthlyTotal += parseFloat(input.value) || 0;
                            }
                        });
                        
                        const subtotalCell = subtotalRow.querySelector(`td[data-month="${month}"]`);
                        if (subtotalCell) {
                            subtotalCell.textContent = formatCurrencyFull(monthlyTotal, 'IDR');
                        }
                        
                        yearlyTotal += monthlyTotal;
                    }
                    
                    // Update yearly subtotal
                    const yearlyCell = subtotalRow.querySelector(`td[data-category-total="${category}"]`);
                    if (yearlyCell) {
                        yearlyCell.textContent = formatCurrencyFull(yearlyTotal, 'IDR');
                    }
                }
            });
        
            // Update main category totals
            ['revenue', 'cogs', 'opex'].forEach(category => {
                const total = totals[category].reduce((s, v) => s + v, 0);
                const element = document.getElementById(`${category}CategoryTotal`);
                if (element) {
                    element.textContent = formatCurrencyFull(total, 'IDR');
                }
            });
        
            // Calculate gross profit and net profit for each month
            months.forEach((month, index) => {
                const gp = totals.revenue[index] - totals.cogs[index];
                const np = gp - totals.opex[index];
                
                const grossProfitElement = document.getElementById(`grossProfit${month}`);
                const netProfitElement = document.getElementById(`netProfit${month}`);
                
                if (grossProfitElement) {
                    grossProfitElement.textContent = formatCurrencyFull(gp, 'IDR');
                }
                if (netProfitElement) {
                    netProfitElement.textContent = formatCurrencyFull(np, 'IDR');
                }
            });
        
            // Calculate total gross profit and net profit
            const totalGrossProfit = totals.revenue.reduce((sum, val, i) => sum + (val - totals.cogs[i]), 0);
            const totalNetProfit = totalGrossProfit - totals.opex.reduce((s, v) => s + v, 0);
            
            const grossProfitTotalElement = document.getElementById('grossProfitTotal');
            const netProfitTotalElement = document.getElementById('netProfitTotal');
            
            if (grossProfitTotalElement) {
                grossProfitTotalElement.textContent = formatCurrencyFull(totalGrossProfit, 'IDR');
            }
            if (netProfitTotalElement) {
                netProfitTotalElement.textContent = formatCurrencyFull(totalNetProfit, 'IDR');
            }
        
            // Update budget summary totals
            const budgetTotalRevenueElement = document.getElementById('budgetTotalRevenue');
            const budgetTotalExpensesElement = document.getElementById('budgetTotalExpenses');
            const budgetNetProfitElement = document.getElementById('budgetNetProfit');
            
            if (budgetTotalRevenueElement) {
                budgetTotalRevenueElement.textContent = formatCurrencyFull(totals.revenue.reduce((s, v) => s + v, 0), 'IDR');
            }
            if (budgetTotalExpensesElement) {
                budgetTotalExpensesElement.textContent = formatCurrencyFull(
                    totals.cogs.reduce((s, v) => s + v, 0) + totals.opex.reduce((s, v) => s + v, 0), 
                    'IDR'
                );
            }
            if (budgetNetProfitElement) {
                budgetNetProfitElement.textContent = formatCurrencyFull(totalNetProfit, 'IDR');
            }
        }
        
        function updateCategoryTotals(totals) {
            ['revenue', 'cogs', 'opex'].forEach(category => {
                const categoryTotal = totals[category].reduce((sum, month) => sum + month, 0);
                const categoryTotalCell = document.getElementById(`${category}CategoryTotal`);
                if (categoryTotalCell) {
                    categoryTotalCell.textContent = formatCurrencyFull(categoryTotal, 'IDR');
                }
            });
        }
        
        function updateSummaryCalculations(totals, months) {
            months.forEach((month, index) => {
                const monthKey = month.toLowerCase();
                
                // Gross Profit = Revenue - COGS
                const grossProfit = totals.revenue[index] - totals.cogs[index];
                const grossProfitCell = document.getElementById(`grossProfit${month}`);
                if (grossProfitCell) {
                    grossProfitCell.textContent = formatCurrencyFull(grossProfit, 'IDR');
                }
                
                // Net Profit = Gross Profit - OpEx
                const netProfit = grossProfit - totals.opex[index];
                const netProfitCell = document.getElementById(`netProfit${month}`);
                if (netProfitCell) {
                    netProfitCell.textContent = formatCurrencyFull(netProfit, 'IDR');
                }
            });
            
            // Update totals
            const totalGrossProfit = totals.revenue.reduce((sum, rev, i) => sum + (rev - totals.cogs[i]), 0);
            const totalNetProfit = totalGrossProfit - totals.opex.reduce((sum, opex) => sum + opex, 0);
            
            document.getElementById('grossProfitTotal').textContent = formatCurrencyFull(totalGrossProfit, 'IDR');
            document.getElementById('netProfitTotal').textContent = formatCurrencyFull(totalNetProfit, 'IDR');
        }
        
        function updateBudgetDashboardCards(totals) {
            const totalRevenue = totals.revenue.reduce((sum, month) => sum + month, 0);
            const totalExpenses = totals.cogs.reduce((sum, month) => sum + month, 0) + 
                                 totals.opex.reduce((sum, month) => sum + month, 0);
            const netProfit = totalRevenue - totalExpenses;
            
            document.getElementById('budgetTotalRevenue').textContent = formatCurrencyFull(totalRevenue, 'IDR');
            document.getElementById('budgetTotalExpenses').textContent = formatCurrencyFull(totalExpenses, 'IDR');
            document.getElementById('budgetNetProfit').textContent = formatCurrencyFull(netProfit, 'IDR');
        }

        // Load budget for selected year
        async function loadBudgetYear() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');

                const selectedYear = parseInt(document.getElementById('budgetYearSelect').value);
                
                clearBudgetTable();

                if (!selectedYear || isNaN(selectedYear)) {
                    updateBudgetStatus('draft');
                    document.getElementById('budgetSource').textContent = 'No budget selected';
                    updateBudgetCalculations();
                    return;
                }

                console.log(` Loading budget for year: ${selectedYear}`);
                
                const { data: budgetMeta, error: metaError } = await supabase
                    .from('budget_metadata').select('*').eq('user_id', user.id).eq('budget_year', selectedYear).single();
                
                if (metaError && metaError.code !== 'PGRST116') throw metaError;
                
                if (budgetMeta) {
                    updateBudgetStatus(budgetMeta.status);
                    const { data: budgetItems, error: itemsError } = await supabase
                        .from('budgets').select('*').eq('user_id', user.id).eq('budget_year', selectedYear);
                    if (itemsError) throw itemsError;
                    if (budgetItems && budgetItems.length > 0) {
                        populateBudgetTable(budgetItems);
                    }
                } else {
                    updateBudgetStatus('draft');
                    document.getElementById('budgetSource').textContent = 'No budget created yet';
                }
            } catch (error) {
                console.error('Error loading budget year:', error);
            }
        }
        
        function populateBudgetTable(budgetItems) {
            const groupedItems = {};
            budgetItems.forEach(item => {
                const key = `${item.category}_${item.account_code}`;
                if (!groupedItems[key]) {
                    const account = glAccounts.find(acc => acc.account_code == item.account_code) || { account_name: `Account ${item.account_code}` };
                    groupedItems[key] = {
                        category: item.category,
                        account_code: item.account_code,
                        line_item_name: `${account.account_code} - ${account.account_name}`,
                        months: {}
                    };
                }
                groupedItems[key].months[item.budget_month] = item.amount;
            });
        
            Object.values(groupedItems).forEach(itemGroup => {
                // Use the correct function to RENDER the line, not the one for adding from UI
                renderBudgetLine(itemGroup.category, itemGroup.line_item_name, itemGroup.months, itemGroup.account_code);
            });
            addCategorySubtotals();
            updateBudgetCalculations();
        }

        function renderBudgetLine(category, displayName, values, accountCode) {
            const tableBody = document.getElementById('budgetTableBody');
            const categoryRow = document.querySelector(`tr[data-category="${category}"]`);
            
            const newRow = document.createElement('tr');
            newRow.className = 'budget-line-row';
            newRow.dataset.parentCategory = category;
            newRow.dataset.lineName = displayName;
            newRow.dataset.accountCode = accountCode;
            
            let inputsHTML = '';
            for(let i = 1; i <= 12; i++) {
                inputsHTML += `<td class="budget-line-cell"><input type="number" class="budget-amount-input" data-month="${i}" value="${values[i] || 0}" oninput="updateBudgetCalculations()"></td>`;
            }
        
            newRow.innerHTML = `
                <td class="budget-line-cell"><div class="budget-line-name">${displayName}</div></td>
                ${inputsHTML}
                <td class="budget-line-cell budget-line-total">Rp 0</td>
                <td class="budget-line-cell">
                    <div class="budget-line-actions">
                        <button class="budget-action-btn delete" onclick="deleteBudgetLine(this)" title="Delete"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            `;
            
            categoryRow.parentNode.insertBefore(newRow, categoryRow.nextSibling);
        }

        async function populateBudgetYearSelector() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;

                const { data: budgets, error } = await supabase
                    .from('budget_metadata')
                    .select('budget_year')
                    .eq('user_id', user.id);
                    
                if (error) throw error;

                const selector = document.getElementById('budgetYearSelect');
                selector.innerHTML = '<option value="">Select Budget Year</option>'; 

                const yearsToDisplay = new Set();
                const currentYear = new Date().getFullYear();
                const existingBudgetYears = new Set(budgets ? budgets.map(b => b.budget_year) : []);
                
                existingBudgetYears.forEach(year => yearsToDisplay.add(year));
                yearsToDisplay.add(currentYear);
                yearsToDisplay.add(currentYear + 1);
                
                const sortedYears = Array.from(yearsToDisplay).sort((a, b) => a - b);
                
                sortedYears.forEach(year => {
                    const budgetExists = existingBudgetYears.has(year);
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = `Budget ${year}${!budgetExists ? ' (New)' : ''}`;
                    if (!budgetExists) option.style.color = '#64748b';
                    selector.appendChild(option);
                });

            } catch (error) {
                console.error('Error populating budget selector:', error);
            }
        }
        
        // Call this when the budgets section is loaded
        function initializeBudgetsSection() {
            populateBudgetYearSelector();
            loadBudgetYear();
        }

        function getMonthKey(monthNumber) {
            return ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'][monthNumber - 1];
        }
        
        function updateBudgetStatus(status) {
            const statusBadge = document.getElementById('budgetStatus');
            statusBadge.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            statusBadge.className = `priority-badge ${status === 'approved' ? 'low-priority' : 'medium-priority'}`;
        }

        function showSection(sectionName) {
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show the target section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            
            // Add active class to the corresponding nav link
            const targetLink = document.querySelector(`[data-section="${sectionName}"]`);
            if (targetLink) {
                targetLink.classList.add('active');
            }
            
            // Initialize specific sections
            if (sectionName === 'budgets') {
                initializeBudgetsSection();
            }
            
            console.log(`Switched to section: ${sectionName}`);
        }

        function addCategorySubtotals() {
            // Remove existing subtotal rows first
            document.querySelectorAll('.budget-category-subtotal').forEach(row => row.remove());
            
            const categories = ['revenue', 'cogs', 'opex'];
            
            categories.forEach(category => {
                const categoryRow = document.querySelector(`tr[data-category="${category}"]`);
                if (!categoryRow) return;
                
                // Find the last line item in this category
                let lastLineItem = categoryRow.nextElementSibling;
                while (lastLineItem && lastLineItem.dataset.parentCategory === category) {
                    lastLineItem = lastLineItem.nextElementSibling;
                }
                
                // Create subtotal row
                const subtotalRow = document.createElement('tr');
                subtotalRow.className = 'budget-category-subtotal';
                subtotalRow.dataset.category = category;
                subtotalRow.dataset.subtotal = 'true';
                
                let subtotalHTML = `<td class="budget-line-cell">Total ${getCategoryDisplayName(category)}</td>`;
                
                // Add monthly subtotals
                for (let i = 1; i <= 12; i++) {
                    subtotalHTML += `<td class="budget-line-cell" data-month="${i}">Rp 0</td>`;
                }
                
                // Add yearly total
                subtotalHTML += `<td class="budget-total-cell" data-category-total="${category}">Rp 0</td>`;
                subtotalHTML += `<td class="budget-line-cell"></td>`; // Actions column
                
                subtotalRow.innerHTML = subtotalHTML;
                
                // Insert before the next category or summary rows
                if (lastLineItem) {
                    lastLineItem.parentNode.insertBefore(subtotalRow, lastLineItem);
                } else {
                    document.getElementById('budgetTableBody').appendChild(subtotalRow);
                }
            });
        }
        
        function getCategoryDisplayName(category) {
            const names = {
                'revenue': 'Revenue',
                'cogs': 'Cost of Goods Sold', 
                'opex': 'Operating Expenses'
            };
            return names[category] || category;
        }
        
        async function getCurrentBusinessContext() {
            // Gather real business data dynamically
            const currentFinancials = await getCurrentFinancialSnapshot();
            const historicalTrends = await getHistoricalTrends();
            const userProfile = await getUserBusinessProfile();
            
            return {
                // Financial Context
                current_revenue: currentFinancials.revenue,
                current_expenses: currentFinancials.expenses,
                cash_position: currentFinancials.cash,
                growth_rate: historicalTrends.growth_rate,
                
                // Business Profile
                industry: userProfile.industry || 'general',
                business_stage: userProfile.stage || 'growth',
                employee_count: userProfile.employees || 'unknown',
                business_model: userProfile.model || 'unknown',
                
                // Market Context
                current_date: new Date().toISOString(),
                fiscal_year: new Date().getFullYear(),
                quarter: Math.ceil((new Date().getMonth() + 1) / 3),
                
                // Historical Performance
                last_year_performance: historicalTrends.last_year,
                seasonal_patterns: historicalTrends.seasonality,
                
                // Strategic Context
                budget_variance: calculateCurrentVariance(),
                cash_runway: calculateCashRunway(),
                growth_initiatives: getActiveGrowthInitiatives()
            };
        }
        
        async function getCurrentFinancialSnapshot() {
            // Get real data from your existing functions
            return {
                revenue: await getTotalRevenue(),
                expenses: await getTotalExpenses(),
                cash: await getCurrentCashPosition(),
                margins: await getCurrentMargins()
            };
        }
        
        async function getHistoricalTrends() {
            // Analyze historical data patterns
            return {
                growth_rate: await calculateGrowthRate(),
                seasonality: await identifySeasonalPatterns(),
                last_year: await getLastYearPerformance()
            };
        }

        async function aiAllocateCategory(category) {
            const targetAmount = parseFloat(document.getElementById(`${category}Target`).value);
            if (!targetAmount) {
                alert('Please enter a target amount first');
                return;
            }
            
            showAIAllocationProgress(category);
            
            try {
                // Get current user and budget context
                const { data: { user } } = await supabase.auth.getUser();
                const selectedYear = parseInt(document.getElementById('budgetYearSelect').value);
                
                const response = await fetch('https://n8n.srv909550.hstgr.cloud/webhook/budget-reallocation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: user?.id,
                        budget_year: selectedYear,
                        category: category,
                        target_amount: targetAmount,
                        industry: 'general',
                        business_stage: 'growth',
                        current_date: new Date().toISOString()
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const responseData = await response.json();
                console.log('Backend response:', responseData);
                
                // Handle the response safely
                let aiResult;
                if (Array.isArray(responseData)) {
                    aiResult = responseData[0];  // Take first element from array
                } else {
                    aiResult = responseData;     // Use direct object
                }
                
                console.log('Parsed AI result:', aiResult);
                
                // Validate the response structure
                if (!aiResult || !aiResult.allocations) {
                    throw new Error('Invalid response from backend - missing allocations');
                }
                
                // Clear existing lines and create new ones
                clearCategoryLines(category);
                await createAIBudgetLines(category, aiResult);
                
                // Show AI rationale (only if we have the data)
                showAIRationaleBelow(category, aiResult);
                
                // Update calculations
                updateBudgetCalculations();
                
                console.log(` AI allocated ${formatCurrency(targetAmount)} for ${category}`);
                
            } catch (error) {
                console.error('AI allocation failed:', error);
                showAIError(category, error.message);
            } finally {
                hideAIAllocationProgress(category);
            }
        }

        function showAIRationaleBelow(category, aiResult) {
            // Remove only the existing rationale for THIS category (if it exists)
            const existingRationale = document.getElementById(`ai-rationale-${category}`);
            if (existingRationale) {
                existingRationale.remove();
            }
            
            // Create the rationale section with unique ID per category
            const rationaleSection = document.createElement('div');
            rationaleSection.id = `ai-rationale-${category}`; // Unique ID per category
            rationaleSection.className = 'ai-rationale-explanation';
            
            const targetAmount = parseFloat(document.getElementById(`${category}Target`).value);
            const accountCount = aiResult.allocations ? Object.keys(aiResult.allocations).length : 0;
            
            rationaleSection.innerHTML = `
                <div class="rationale-container">
                    <div class="rationale-header">
                        <h4><i class="fas fa-brain"></i> AI Allocation Explanation - ${category.toUpperCase()}</h4>
                        <div class="allocation-summary-info">
                            <span class="summary-item"><strong>Target:</strong> ${formatCurrency(targetAmount)}</span>
                            <span class="summary-item"><strong>Accounts:</strong> ${accountCount}</span>
                            <span class="summary-item"><strong>Strategy:</strong> AI Optimized</span>
                        </div>
                    </div>
                    
                    <div class="rationale-content">
                        ${aiResult.rationale ? `
                            <div class="rationale-section">
                                <h5><i class="fas fa-lightbulb"></i> Strategic Rationale</h5>
                                <p>${aiResult.rationale}</p>
                            </div>
                        ` : ''}
                        
                        ${aiResult.selection_reasoning ? `
                            <div class="rationale-section">
                                <h5><i class="fas fa-list"></i> Account Selection</h5>
                                <p>${aiResult.selection_reasoning}</p>
                            </div>
                        ` : ''}
                        
                        ${aiResult.key_assumptions && aiResult.key_assumptions.length ? `
                            <div class="rationale-section">
                                <h5><i class="fas fa-info-circle"></i> Key Assumptions</h5>
                                <ul class="assumptions-list">
                                    ${aiResult.key_assumptions.map(assumption => `<li>${assumption}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${aiResult.allocation_percentages ? `
                            <div class="rationale-section">
                                <h5><i class="fas fa-chart-pie"></i> Allocation Breakdown</h5>
                                <div class="allocation-breakdown-grid">
                                    ${Object.entries(aiResult.allocation_percentages).map(([accountCode, percentage]) => {
                                        const account = window.glAccounts.find(acc => acc.account_code === accountCode);
                                        const accountName = account ? account.account_name : accountCode;
                                        const annualTotal = aiResult.allocations[accountCode] ? 
                                            aiResult.allocations[accountCode].reduce((sum, amount) => sum + amount, 0) : 0;
                                        
                                        return `
                                            <div class="breakdown-item">
                                                <span class="account-info">${accountCode} - ${accountName}</span>
                                                <span class="percentage">${percentage}%</span>
                                                <span class="amount">${formatCurrency(annualTotal)}</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // Insert the rationale section after the budget table
            const budgetTableWrapper = document.querySelector('.budget-table-wrapper');
            if (budgetTableWrapper) {
                // Find the best insertion point - after any existing rationale sections
                const existingRationales = document.querySelectorAll('.ai-rationale-explanation');
                const lastRationale = existingRationales[existingRationales.length - 1];
                
                if (lastRationale) {
                    // Insert after the last existing rationale
                    lastRationale.parentNode.insertBefore(rationaleSection, lastRationale.nextSibling);
                } else {
                    // Insert after the budget table (first rationale)
                    budgetTableWrapper.parentNode.insertBefore(rationaleSection, budgetTableWrapper.nextSibling);
                }
            }
        }
        
        function showAIRationale(category, aiResult) {
            // Create or get rationale panel
            let rationalePanel = document.getElementById('aiRationalePanel');
            if (!rationalePanel) {
                rationalePanel = document.createElement('div');
                rationalePanel.id = 'aiRationalePanel';
                rationalePanel.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 1000;
                    display: none;
                    align-items: center;
                    justify-content: center;
                `;
                document.body.appendChild(rationalePanel);
            }
            
            const targetAmount = parseFloat(document.getElementById(`${category}Target`).value);
            const accountCount = aiResult.allocations ? Object.keys(aiResult.allocations).length : 0;
            
            rationalePanel.innerHTML = `
                <div class="ai-rationale-container" style="background: white; border-radius: 12px; padding: 2rem; max-width: 800px; max-height: 80vh; overflow-y: auto;">
                    <div class="rationale-header">
                        <h4><i class="fas fa-brain"></i> AI Allocation Analysis - ${category.toUpperCase()}</h4>
                        <div class="allocation-summary">
                            Target: ${formatCurrency(targetAmount)} | 
                            Accounts: ${accountCount} | 
                            Strategy: AI Optimized
                        </div>
                        <button class="btn-close" onclick="closeRationale()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                    </div>
                    
                    <div class="rationale-content">
                        ${aiResult.rationale ? `
                            <div class="ai-analysis">
                                <h5><i class="fas fa-lightbulb"></i> Strategic Rationale</h5>
                                <p>${aiResult.rationale}</p>
                            </div>
                        ` : ''}
                        
                        ${aiResult.selection_reasoning ? `
                            <div class="account-selection">
                                <h5><i class="fas fa-list"></i> Account Selection</h5>
                                <p>${aiResult.selection_reasoning}</p>
                            </div>
                        ` : ''}
                        
                        ${aiResult.key_assumptions ? `
                            <div class="key-assumptions">
                                <h5><i class="fas fa-info-circle"></i> Key Assumptions</h5>
                                <ul>
                                    ${aiResult.key_assumptions.map(assumption => `<li>${assumption}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${aiResult.allocation_percentages ? `
                            <div class="allocation-breakdown">
                                <h5><i class="fas fa-chart-pie"></i> Allocation Breakdown</h5>
                                ${generateAllocationTable(aiResult)}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="rationale-actions" style="margin-top: 2rem; text-align: center;">
                        <button class="btn btn-primary" onclick="closeRationale()" style="padding: 0.5rem 1rem; background: #fbbf24; color: #1e293b; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-check"></i> Close
                        </button>
                    </div>
                </div>
            `;
            
            rationalePanel.style.display = 'flex';
        }

        function closeRationale() {
            const panel = document.getElementById('aiRationalePanel');
            if (panel) {
                panel.style.display = 'none';
            }
        }

        function generateAllocationTable(aiResult) {
            if (!aiResult.allocations || !aiResult.allocation_percentages) {
                return '<p>No allocation details available</p>';
            }
            
            const { allocations, allocation_percentages } = aiResult;
            
            let tableHTML = '<table style="width: 100%; border-collapse: collapse; margin-top: 1rem;"><thead><tr><th style="border: 1px solid #ddd; padding: 0.5rem;">Account</th><th style="border: 1px solid #ddd; padding: 0.5rem;">Percentage</th><th style="border: 1px solid #ddd; padding: 0.5rem;">Annual Total</th></tr></thead><tbody>';
            
            for (const [accountCode, monthlyAmounts] of Object.entries(allocations)) {
                const account = window.glAccounts.find(acc => acc.account_code === accountCode);
                const annualTotal = Array.isArray(monthlyAmounts) ? monthlyAmounts.reduce((sum, amount) => sum + (amount || 0), 0) : 0;
                const percentage = allocation_percentages[accountCode] || 0;
                
                tableHTML += `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 0.5rem;">${account?.account_name || accountCode}</td>
                        <td style="border: 1px solid #ddd; padding: 0.5rem;">${percentage}%</td>
                        <td style="border: 1px solid #ddd; padding: 0.5rem;">${formatCurrency(annualTotal)}</td>
                    </tr>
                `;
            }
            
            tableHTML += '</tbody></table>';
            return tableHTML;
        }
        
        function formatAIRationale(rationale) {
            // Let AI's natural language response flow naturally
            return rationale
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
        }

        async function createAIBudgetLines(category, aiResult) {
            // Safety check
            if (!aiResult || !aiResult.allocations) {
                console.error('No allocations in AI result');
                return;
            }
            
            const { allocations } = aiResult;
            
            // Safety check for allocations
            if (!allocations || typeof allocations !== 'object') {
                console.error('Invalid allocations structure');
                return;
            }
            
            for (const [accountCode, monthlyAmounts] of Object.entries(allocations)) {
                // Safety check for monthly amounts
                if (!Array.isArray(monthlyAmounts) || monthlyAmounts.length !== 12) {
                    console.warn(`Invalid monthly amounts for account ${accountCode}`);
                    continue;
                }
                
                // Find account in GL accounts and create description
                const account = window.glAccounts.find(acc => acc.account_code === accountCode);
                if (!account) {
                    console.warn(`Account ${accountCode} not found in GL accounts`);
                    continue;
                }
                
                // Create display name using GL account data
                const displayName = `${account.account_code} - ${account.account_name}`;
                const monthlyValues = {};
                
                // Convert monthly amounts to the expected format
                monthlyAmounts.forEach((amount, index) => {
                    monthlyValues[getMonthKey(index + 1)] = amount || 0;
                });
                
                // Create the budget line
                addBudgetLineToTable(category, displayName, monthlyValues, accountCode);
                
                console.log(` Created budget line: ${displayName}`);
            }
        }

        function enableAIReallocation() {
            // Enable AI Allocate buttons when target values are entered
            const revenueTarget = document.getElementById('revenueTarget').value;
            const cogsTarget = document.getElementById('cogsTarget').value;
            const opexTarget = document.getElementById('opexTarget').value;
            
            // Enable/disable buttons based on input values
            const revenueBtn = document.querySelector('button[onclick="aiAllocateCategory(\'revenue\')"]');
            const cogsBtn = document.querySelector('button[onclick="aiAllocateCategory(\'cogs\')"]');
            const opexBtn = document.querySelector('button[onclick="aiAllocateCategory(\'opex\')"]');
            
            if (revenueBtn) revenueBtn.disabled = !revenueTarget;
            if (cogsBtn) cogsBtn.disabled = !cogsTarget;
            if (opexBtn) opexBtn.disabled = !opexTarget;
        }

        function showAIAllocationProgress(category) {
            // Show loading state
            const button = document.querySelector(`button[onclick="aiAllocateCategory('${category}')"]`);
            if (button) {
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AI Working...';
                button.disabled = true;
            }
        }

        function hideAIAllocationProgress(category) {
            // Reset button to normal state
            const button = document.querySelector(`button[onclick="aiAllocateCategory('${category}')"]`);
            if (button) {
                button.innerHTML = '<i class="fas fa-magic"></i> AI Allocate';
                button.disabled = false;
            }
        }

        function showAIError(category, errorMessage) {
            alert(`AI allocation failed for ${category}: ${errorMessage}`);
            hideAIAllocationProgress(category);
        }

        function clearCategoryLines(category) {
            const existingLines = document.querySelectorAll(`tr[data-parent-category="${category}"]`);
            existingLines.forEach(line => line.remove());
        }

        function toggleSuggestions() {
            const container = document.getElementById('suggestionsContainer');
            const toggle = document.getElementById('suggestionsToggle');
            
            container.classList.toggle('collapsed');
            
            // Store the collapsed state in localStorage
            const isCollapsed = container.classList.contains('collapsed');
            localStorage.setItem('suggestions_collapsed', isCollapsed);
            
            // Optional: Add a subtle animation to the chat messages area
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.style.transition = 'height 0.3s ease';
            }
        }
        
        // Add this to restore the collapsed state when chat is opened
        function restoreSuggestionsState() {
            const container = document.getElementById('suggestionsContainer');
            const isCollapsed = localStorage.getItem('suggestions_collapsed') === 'true';
            
            if (isCollapsed) {
                container.classList.add('collapsed');
            }
        }

        // Industry Benchmarking Variables
        let industryBenchmarkData = {};
        let companyFinancialMetrics = {};
        let selectedIndustries = [];
        let currentBenchmarkPeriod = 'YTD';
        
        // Initialize Industry Benchmarking when tab is switched
        function initializeIndustryBenchmarking() {
            console.log('Initializing Industry Benchmarking...');
            
            // Check all industry checkboxes by default
            const checkboxes = document.querySelectorAll('.industry-checkbox input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            
            // Trigger the initial selection
            updateIndustrySelection();
            
            // Calculate initial company metrics
            calculateCompanyMetrics();
            
            // Load latest benchmark update date
            loadBenchmarkUpdateDate();

            setTimeout(() => {
                const insightsLoaded = displayStoredInsights();
                if (insightsLoaded) {
                    console.log('Restored AI insights from previous session');
                }
            }, 1000); 
        }
        
        // Calculate company financial metrics from trial balance
        function calculateCompanyMetrics() {
            const period = document.getElementById('benchmarkPeriodSelect').value;
            currentBenchmarkPeriod = period;
            
            console.log('Calculating company metrics for period:', period);
            
            // Get trial balance data
            const balances = calculateAccountBalances();
            
            if (!balances || !financialTransactions) {
                document.getElementById('companyMetricsSummary').innerHTML = 
                    '<div class="metric-loading">No financial data available</div>';
                return;
            }
            
            // Get period-specific transactions
            const periodTransactions = getTransactionsForPeriod(period);
            
            // Generate a period key for the current selection
            const today = new Date();
            let periodKey;
            switch(period) {
                case 'MTD':
                    periodKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                    break;
                case 'QTD':
                    const currentQuarter = Math.floor(today.getMonth() / 3) + 1;
                    periodKey = `${today.getFullYear()}-Q${currentQuarter}`;
                    break;
                case 'YTD':
                    periodKey = `${today.getFullYear()}-YTD`;
                    break;
                case 'YEARLY':
                    periodKey = `${today.getFullYear() - 1}-YEARLY`;
                    break;
                default:
                    periodKey = `${today.getFullYear()}-YTD`;
            }
            
            const periodFinancials = calculateFinancialDataFromTransactions(periodTransactions, periodKey, period);
            
            // Calculate all 9 key ratios
            companyFinancialMetrics = {
                // Profitability & Returns
                roe: calculateROE(balances, periodFinancials),
                roa: calculateROA(balances, periodFinancials),
                ebitda_margin: calculateEBITDAMargin(periodFinancials),
                
                // Margins & Efficiency  
                net_margin: calculateNetMargin(periodFinancials),
                gross_margin: calculateGrossMargin(periodFinancials),
                asset_turnover: calculateAssetTurnover(balances, periodFinancials),
                
                // Financial Health & Risk
                current_ratio: calculateCurrentRatio(balances),
                quick_ratio: calculateQuickRatio(balances),
                debt_to_equity: calculateDebtToEquity(balances)
            };
            
            console.log('Company metrics calculated:', companyFinancialMetrics);
            
            // Update summary display
            updateCompanyMetricsSummary();
            
            // If industries are selected, update comparison
            if (selectedIndustries.length > 0) {
                loadIndustryBenchmarks();
            }
        }

        // Helper function to get account balance by code
        function getAccountBalanceForBenchmarking(accountCode, balances) {
            if (!balances || !balances.accountBalances) return 0;
            
            const account = balances.accountBalances.find(acc => acc.account_code === accountCode);
            return account ? account.net_balance : 0;
        }
        
        // Financial ratio calculation functions
        function calculateROE(balances, financials) {
            const totalEquity = balances.totalEquity || 1;
            const netIncome = financials.netIncome || 0;
            return totalEquity > 0 ? (netIncome / totalEquity) * 100 : 0;
        }
        
        function calculateROA(balances, financials) {
            const totalAssets = balances.totalAssets || 1;
            const netIncome = financials.netIncome || 0;
            return totalAssets > 0 ? (netIncome / totalAssets) * 100 : 0;
        }
        
        function calculateEBITDAMargin(financials) {
            const netRevenue = financials.netRevenue || 1;
            const ebitda = financials.ebitda || 0;
            return netRevenue > 0 ? (ebitda / netRevenue) * 100 : 0;
        }
        
        function calculateNetMargin(financials) {
            const netRevenue = financials.netRevenue || 1;
            const netIncome = financials.netIncome || 0;
            return netRevenue > 0 ? (netIncome / netRevenue) * 100 : 0;
        }
        
        function calculateGrossMargin(financials) {
            const netRevenue = financials.netRevenue || 1;
            const grossProfit = financials.grossProfit || 0;
            return netRevenue > 0 ? (grossProfit / netRevenue) * 100 : 0;
        }
        
        function calculateAssetTurnover(balances, financials) {
            const totalAssets = balances.totalAssets || 1;
            const netRevenue = financials.netRevenue || 0;
            return totalAssets > 0 ? netRevenue / totalAssets : 0;
        }
        
        function calculateCurrentRatio(balances) {
            const currentAssets = calculateCurrentAssets(balances);
            const currentLiabilities = calculateCurrentLiabilities(balances);
            return currentLiabilities > 0 ? currentAssets / currentLiabilities : 0;
        }
        
        function calculateQuickRatio(balances) {
            const currentAssets = calculateCurrentAssets(balances);
            const inventory = getAccountBalanceForBenchmarking('1300', balances) || 0; // Inventory account
            const currentLiabilities = calculateCurrentLiabilities(balances);
            const quickAssets = currentAssets - inventory;
            return currentLiabilities > 0 ? quickAssets / currentLiabilities : 0;
        }
        
        function calculateDebtToEquity(balances) {
            const totalLiabilities = balances.totalLiabilities || 0;
            const totalEquity = balances.totalEquity || 1;
            return totalEquity > 0 ? totalLiabilities / totalEquity : 0;
        }
        
        // Helper function to get transactions for specific period
        function getTransactionsForPeriod(periodType) {
            const today = new Date();
            let startDate, endDate;
            
            switch(periodType) {
                case 'MTD':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = today;
                    break;
                case 'QTD':
                    const currentQuarter = Math.floor(today.getMonth() / 3);
                    startDate = new Date(today.getFullYear(), currentQuarter * 3, 1);
                    endDate = today;
                    break;
                case 'YTD':
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = today;
                    break;
                case 'YEARLY':
                    startDate = new Date(today.getFullYear() - 1, 0, 1);
                    endDate = new Date(today.getFullYear() - 1, 11, 31);
                    break;
                default:
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = today;
            }
            
            return financialTransactions.filter(transaction => {
                const transactionDate = new Date(transaction.transaction_date);
                return transactionDate >= startDate && transactionDate <= endDate;
            });
        }
        
        // Update company metrics summary display
        function updateCompanyMetricsSummary() {
            const container = document.getElementById('companyMetricsSummary');
            
            const metricsCount = Object.keys(companyFinancialMetrics).length;
            const period = currentBenchmarkPeriod;
            
            container.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">
                        ${metricsCount}
                    </div>
                    <div style="color: #6b7280; font-size: 0.875rem;">
                        Key ratios calculated<br>
                        for ${period} period
                    </div>
                </div>
            `;
        }
        
        // Handle industry selection changes
        function updateIndustrySelection() {
            const checkboxes = document.querySelectorAll('.industry-checkbox input[type="checkbox"]');
            selectedIndustries = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedIndustries.push(checkbox.value);
                }
            });
            
            console.log('Selected industries:', selectedIndustries);
            
            if (selectedIndustries.length > 0) {
                loadIndustryBenchmarks();
            } else {
                // Hide comparison sections if no industries selected
                document.getElementById('benchmarkGaugesSection').style.display = 'none';
                document.getElementById('benchmarkTableSection').style.display = 'none';
                document.getElementById('strategicAdvisorSection').style.display = 'none';
            }
        }
        
        // Load industry benchmark data from Supabase
        async function loadIndustryBenchmarks() {
            if (selectedIndustries.length === 0) return;
            
            console.log('Loading industry benchmarks for:', selectedIndustries);
            
            try {
                const { data, error } = await supabase
                    .from('industry_benchmarks')
                    .select('*')
                    .in('industry', selectedIndustries)
                    .eq('is_active', true);
                    
                if (error) throw error;
                
                // Organize data by industry
                window.industryBenchmarkData = {};
                selectedIndustries.forEach(industry => {
                    window.industryBenchmarkData[industry] = data.filter(d => d.industry === industry);
                });

                window.selectedIndustries = [...selectedIndustries];
                
                console.log('Industry benchmark data loaded:', industryBenchmarkData);

                debugIndustryData();
                
                // Update UI components
                generateBenchmarkGauges();
                generateBenchmarkTable();

                if (typeof updateDashboardMetrics === 'function') {
                    updateDashboardMetrics();
                }
                
                // Show comparison sections
                document.getElementById('benchmarkGaugesSection').style.display = 'block';
                document.getElementById('benchmarkTableSection').style.display = 'block';
                document.getElementById('strategicAdvisorSection').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading industry benchmarks:', error);
                alert('Error loading industry benchmarks. Please try again.');
            }
        }

        // Add this debug function and call it after loading industry benchmarks
        function debugIndustryData() {
            console.log('=== INDUSTRY BENCHMARK DEBUG ===');
            console.log('selectedIndustries:', window.selectedIndustries);
            console.log('industryBenchmarkData:', window.industryBenchmarkData);
            
            if (window.industryBenchmarkData) {
                Object.keys(window.industryBenchmarkData).forEach(industry => {
                    console.log(`Industry: ${industry}`);
                    console.log('Metrics available:', window.industryBenchmarkData[industry].map(d => d.metric_name));
                    console.log('Sample data:', window.industryBenchmarkData[industry][0]);
                });
            }
        }
        
        // Generate gauge charts for each metric
        function generateBenchmarkGauges() {
            const metrics = [
                'roe', 'roa', 'ebitda_margin',
                'net_margin', 'gross_margin', 'asset_turnover', 
                'current_ratio', 'quick_ratio', 'debt_to_equity'
            ];
            
            metrics.forEach(metric => {
                const companyValue = companyFinancialMetrics[metric];
                const percentile = calculateMetricPercentile(metric, companyValue);
                const performanceClass = getPerformanceClass(percentile);
                
                // Update gauge value
                const valueElement = document.getElementById(`${metric.replace('_', '-')}-value`);
                if (valueElement) {
                    const isPercentage = ['roe', 'roa', 'ebitda_margin', 'net_margin', 'gross_margin'].includes(metric);
                    valueElement.textContent = isPercentage ? 
                        `${companyValue.toFixed(1)}%` : 
                        companyValue.toFixed(2);
                }
                
                // Update percentile display
                const percentileElement = document.getElementById(`${metric.replace('_', '-')}-percentile`);
                if (percentileElement) {
                    percentileElement.textContent = `${Math.round(percentile)}th percentile`;
                    percentileElement.className = `gauge-percentile ${performanceClass}`;
                }
                
                // Create simple gauge visualization
                createSimpleGauge(`${metric.replace('_', '-')}-gauge`, percentile);
            });
        }
        
        // Create simple gauge chart
        function createSimpleGauge(containerId, percentile) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const color = percentile >= 75 ? '#10b981' : 
                          percentile >= 25 ? '#f59e0b' : '#ef4444';
            
            container.innerHTML = `
                <div style="position: relative; height: 100%; display: flex; align-items: center; justify-content: center;">
                    <div style="
                        width: 80px; 
                        height: 80px; 
                        border-radius: 50%; 
                        background: conic-gradient(
                            ${color} 0deg ${(percentile * 3.6)}deg,
                            #e5e7eb ${(percentile * 3.6)}deg 360deg
                        );
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        position: relative;
                    ">
                        <div style="
                            width: 60px; 
                            height: 60px; 
                            background: white; 
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 0.875rem;
                            font-weight: 600;
                            color: #1e293b;
                        ">
                            ${Math.round(percentile)}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Calculate percentile for a specific metric
        function calculateMetricPercentile(metricName, companyValue) {
            console.log(`=== ADAPTIVE PERCENTILE for ${metricName} ===`);
            console.log('Company value:', companyValue);
            
            // Safety checks
            if (!window.selectedIndustries || !Array.isArray(window.selectedIndustries) || window.selectedIndustries.length === 0) {
                return 50;
            }
            
            if (!window.industryBenchmarkData) {
                return 50;
            }
            
            const metricNameMapping = {
                'roe': 'return_on_equity',
                'roa': 'return_on_assets',
                'ebitda_margin': 'ebitda_margin',
                'net_margin': 'net_margin',
                'gross_margin': 'gross_margin',
                'asset_turnover': 'asset_turnover',
                'current_ratio': 'current_ratio',
                'quick_ratio': 'quick_ratio',
                'debt_to_equity': 'debt_to_equity'
            };
            
            const dbMetricName = metricNameMapping[metricName] || metricName;
            
            // Collect only AVAILABLE benchmark data (filter out zeros)
            const validBenchmarks = [];
            window.selectedIndustries.forEach(industry => {
                const industryData = window.industryBenchmarkData[industry];
                const metricData = industryData?.find(d => d.metric_name === dbMetricName);
                if (metricData) {
                    // Only add non-zero values to create realistic distribution
                    const values = [
                        parseFloat(metricData.min_value),
                        parseFloat(metricData.q1_value),
                        parseFloat(metricData.median_value),
                        parseFloat(metricData.q3_value),
                        parseFloat(metricData.max_value)
                    ].filter(v => v > 0); // Filter out zeros
                    
                    validBenchmarks.push(...values);
                }
            });
            
            console.log('Valid benchmark values (zeros filtered):', validBenchmarks);
            
            if (validBenchmarks.length === 0) {
                console.log('No valid benchmark data found');
                return 50;
            }
            
            // Sort the values
            validBenchmarks.sort((a, b) => a - b);
            
            // ADAPTIVE PERCENTILE CALCULATION
            let percentile;
            
            if (validBenchmarks.length <= 3) {
                // Very limited data - use simple comparison
                console.log('Limited data - using simple comparison');
                const median = validBenchmarks[Math.floor(validBenchmarks.length / 2)];
                const min = Math.min(...validBenchmarks);
                const max = Math.max(...validBenchmarks);
                
                if (companyValue <= min) percentile = 10;
                else if (companyValue >= max) percentile = 90;
                else if (companyValue < median) percentile = 25;
                else if (companyValue > median) percentile = 75;
                else percentile = 50;
                
            } else {
                // Standard percentile calculation for adequate data
                const belowCount = validBenchmarks.filter(value => value < companyValue).length;
                const equalCount = validBenchmarks.filter(value => value === companyValue).length;
                const rawPercentile = ((belowCount + 0.5 * equalCount) / validBenchmarks.length) * 100;
                
                // Smooth extreme values for small datasets
                if (validBenchmarks.length < 10) {
                    if (rawPercentile <= 5) percentile = 10;
                    else if (rawPercentile >= 95) percentile = 90;
                    else percentile = rawPercentile;
                } else {
                    percentile = rawPercentile;
                }
            }
            
            console.log(`Final percentile: ${Math.round(percentile)}`);
            return Math.max(5, Math.min(95, Math.round(percentile))); // Cap between 5th-95th percentile
        }
        
        // Get performance class based on percentile
        function getPerformanceClass(percentile) {
            if (percentile >= 75) return 'excellent';
            if (percentile >= 25) return 'good';
            return 'needs-improvement';
        }
        
        // Generate detailed comparison table
        function generateBenchmarkTable() {
            const tableHeader = document.querySelector('#benchmarkComparisonTable thead tr');
            const tableBody = document.getElementById('benchmarkTableBody');
            
            if (!tableHeader || !tableBody || !window.selectedIndustries || window.selectedIndustries.length === 0) {
                console.log('Missing table elements or no selected industries');
                return;
            }
            
            // Debug the available data
            console.log('Generating benchmark table with:', window.selectedIndustries);
            console.log('Available industry data:', window.industryBenchmarkData);
            
            // Clear existing content
            tableBody.innerHTML = '';
            
            // Build header dynamically for selected industries
            let headerHTML = `
                <th>Financial Metric</th>
                <th>Your Company</th>
                <th>Percentile</th>
            `;
            
            window.selectedIndustries.forEach(industry => {
                const industryName = industry.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                headerHTML += `<th>${industryName}<br>Median</th>`;
            });
            
            tableHeader.innerHTML = headerHTML;
            
            // Define metrics with correct database mapping
            const metrics = [
                { key: 'roe', label: 'Return on Equity (%)', isPercent: true, dbName: 'return_on_equity' },
                { key: 'roa', label: 'Return on Assets (%)', isPercent: true, dbName: 'return_on_assets' },
                { key: 'ebitda_margin', label: 'EBITDA Margin (%)', isPercent: true, dbName: 'ebitda_margin' },
                { key: 'net_margin', label: 'Net Profit Margin (%)', isPercent: true, dbName: 'net_margin' },
                { key: 'gross_margin', label: 'Gross Profit Margin (%)', isPercent: true, dbName: 'gross_margin' },
                { key: 'asset_turnover', label: 'Asset Turnover', isPercent: false, dbName: 'asset_turnover' },
                { key: 'current_ratio', label: 'Current Ratio', isPercent: false, dbName: 'current_ratio' },
                { key: 'quick_ratio', label: 'Quick Ratio', isPercent: false, dbName: 'quick_ratio' },
                { key: 'debt_to_equity', label: 'Debt-to-Equity', isPercent: false, dbName: 'debt_to_equity' }
            ];
            
            let tableHTML = '';
            
            metrics.forEach(metric => {
                const companyValue = window.companyFinancialMetrics[metric.key];
                console.log(`Processing ${metric.key}:`, companyValue);
                
                if (companyValue === undefined || companyValue === null) {
                    console.log(`Skipping ${metric.key} - no company data`);
                    return; // Skip metrics without company data
                }
                
                const percentile = calculateMetricPercentile(metric.key, companyValue);
                const performanceClass = getPerformanceClass(percentile);
                
                let rowHTML = `
                    <tr>
                        <td style="font-weight: 600;">${metric.label}</td>
                        <td style="font-weight: 600; color: #1e293b;">
                            ${metric.isPercent ? `${companyValue.toFixed(1)}%` : companyValue.toFixed(2)}
                        </td>
                        <td class="gauge-percentile ${performanceClass}" style="font-weight: 600;">
                            ${Math.round(percentile)}th
                        </td>
                `;
                
                // Add industry benchmark values
                window.selectedIndustries.forEach(industry => {
                    const industryData = window.industryBenchmarkData[industry];
                    console.log(`Looking for ${metric.dbName} in ${industry}:`, industryData);
                    
                    // Find the metric in industry data using the database name
                    const metricData = industryData?.find(d => d.metric_name === metric.dbName);
                    console.log(`Found metric data for ${metric.dbName}:`, metricData);
                    
                    const medianValue = metricData?.median_value || 0;
                    
                    rowHTML += `
                        <td style="text-align: center; color: #6b7280;">
                            ${metric.isPercent ? `${parseFloat(medianValue).toFixed(1)}%` : parseFloat(medianValue).toFixed(2)}
                        </td>
                    `;
                });
                
                rowHTML += `</tr>`;
                tableHTML += rowHTML;
            });
            
            tableBody.innerHTML = tableHTML;
            console.log('Benchmark table generated successfully');
        }
        
        // Generate strategic insights using AI
        async function generateStrategicInsights() {
            const advisorContent = document.getElementById('advisorContent');
            const advisorLoading = document.getElementById('advisorLoading');
            const generateBtn = document.getElementById('generateInsightsBtn');
            
            // Update button state
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            
            advisorLoading.style.display = 'block';
            advisorContent.style.display = 'none';
            
            try {
                // Your existing API call code...
                const payload = {
                    company_metrics: companyFinancialMetrics,
                    selected_industries: selectedIndustries,
                    industry_benchmarks: industryBenchmarkData,
                    time_period: currentBenchmarkPeriod,
                    company_context: {
                        total_assets: calculateAccountBalances().totalAssets,
                        total_revenue: companyFinancialMetrics.net_margin * companyFinancialMetrics.asset_turnover,
                        business_type: "general"
                    }
                };
                
                const response = await fetch('https://n8n.srv909550.hstgr.cloud/webhook/get-actionable-insight', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error('Failed to get AI insights');
                
                const insights = await response.json();
                
                // Format and display insights
                const formattedInsights = formatAIInsights(insights);
                advisorContent.innerHTML = formattedInsights;
                
                // SAVE TO LOCALSTORAGE (ADD THIS)
                saveAIInsights(formattedInsights);
                
                // Update button to "Regenerate"
                generateBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Regenerate Insights';
                
            } catch (error) {
                console.error('Error generating strategic insights:', error);
                advisorContent.innerHTML = `
                    <div style="text-align: center; color: #ef4444; padding: 2rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Unable to generate insights at this time.</p>
                        <p style="font-size: 0.875rem; color: #6b7280;">Please try again later.</p>
                    </div>
                `;
                
                generateBtn.innerHTML = '<i class="fas fa-brain"></i> Generate AI Insights';
            } finally {
                advisorLoading.style.display = 'none';
                advisorContent.style.display = 'block';
                generateBtn.disabled = false;
            }
        }
        
        // Format AI insights for display - handles multiple response formats
        function formatAIInsights(insights) {
            console.log('Raw insights received:', insights);
            
            // Handle different response formats
            let data;
            
            // If it's an array, take the first element
            if (Array.isArray(insights)) {
                data = insights[0] || {};
            } 
            // If it's a string, try to parse it
            else if (typeof insights === 'string') {
                try {
                    const parsed = JSON.parse(insights);
                    data = Array.isArray(parsed) ? parsed[0] : parsed;
                } catch (e) {
                    // If parsing fails, treat as plain text
                    return `<div style="line-height: 1.6; padding: 1rem;">${insights}</div>`;
                }
            }
            // If it's already an object, use it directly
            else if (typeof insights === 'object' && insights !== null) {
                data = insights;
            }
            // Fallback for any other type
            else {
                return `<div style="line-height: 1.6; padding: 1rem;">Strategic analysis completed.</div>`;
            }
            
            console.log('Processed data:', data);
            
            let html = '<div class="ai-insights">';
            
            // Overall Score Section
            if (data.overall_score || data.overall_score === 0) {
                const score = data.overall_score;
                const confidence = data.confidence_level || '';
                
                html += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; color: white; text-align: center;">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1.2rem;">Overall Financial Health Score</h3>
                        <div style="font-size: 3rem; font-weight: 700; margin: 1rem 0;">${score}/100</div>
                        ${confidence ? `<p style="margin: 0; opacity: 0.9;">Confidence Level: ${confidence}%</p>` : ''}
                    </div>
                `;
            }
            
            // Executive Summary
            if (data.executive_summary) {
                html += `
                    <div style="background: #f8fafc; border-left: 4px solid #3b82f6; padding: 1.5rem; margin-bottom: 2rem; border-radius: 8px;">
                        <h4 style="margin: 0 0 1rem 0; color: #1e293b; display: flex; align-items: center;">
                            <i class="fas fa-chart-line" style="margin-right: 0.5rem; color: #3b82f6;"></i>
                            Executive Summary
                        </h4>
                        <p style="margin: 0; line-height: 1.6; color: #374151; font-size: 1rem;">${data.executive_summary}</p>
                    </div>
                `;
            }
            
            // Recommendations Section
            if (data.recommendations && Array.isArray(data.recommendations) && data.recommendations.length > 0) {
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #1e293b; display: flex; align-items: center;">
                            <i class="fas fa-lightbulb" style="margin-right: 0.5rem; color: #f59e0b;"></i>
                            Strategic Recommendations
                        </h4>
                `;
                
                data.recommendations.forEach((rec, index) => {
                    const priorityColor = {
                        'high': '#ef4444',
                        'medium': '#f59e0b',
                        'low': '#10b981'
                    }[rec.priority] || '#6b7280';
                    
                    const priorityBg = {
                        'high': '#fef2f2',
                        'medium': '#fffbeb',
                        'low': '#f0fdf4'
                    }[rec.priority] || '#f9fafb';
                    
                    html += `
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                <h5 style="margin: 0; color: #1e293b; font-size: 1.1rem;">${rec.title}</h5>
                                <span style="background: ${priorityBg}; color: ${priorityColor}; padding: 0.25rem 0.75rem; border-radius: 16px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">
                                    ${rec.priority} Priority
                                </span>
                            </div>
                            <p style="margin: 0; line-height: 1.6; color: #6b7280;">${rec.description}</p>
                            ${rec.category ? `<div style="margin-top: 0.75rem;"><span style="background: #f3f4f6; color: #374151; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${rec.category}</span></div>` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            // Key Insights
            if (data.key_insights && Array.isArray(data.key_insights) && data.key_insights.length > 0) {
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #1e293b; display: flex; align-items: center;">
                            <i class="fas fa-key" style="margin-right: 0.5rem; color: #8b5cf6;"></i>
                            Key Insights
                        </h4>
                        <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.8;">
                `;
                
                data.key_insights.forEach(insight => {
                    html += `<li style="margin-bottom: 0.5rem; color: #374151;">${insight}</li>`;
                });
                
                html += '</ul></div>';
            }
            
            // Strengths and Areas for Improvement in a grid
            if ((data.strengths && data.strengths.length > 0) || (data.areas_for_improvement && data.areas_for_improvement.length > 0)) {
                html += `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                `;
                
                // Strengths
                if (data.strengths && data.strengths.length > 0) {
                    html += `
                        <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 1.5rem;">
                            <h5 style="margin: 0 0 1rem 0; color: #166534; display: flex; align-items: center;">
                                <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i>
                                Strengths
                            </h5>
                            <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.6;">
                    `;
                    
                    data.strengths.forEach(strength => {
                        html += `<li style="margin-bottom: 0.5rem; color: #166534;">${strength}</li>`;
                    });
                    
                    html += '</ul></div>';
                }
                
                // Areas for Improvement
                if (data.areas_for_improvement && data.areas_for_improvement.length > 0) {
                    html += `
                        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1.5rem;">
                            <h5 style="margin: 0 0 1rem 0; color: #dc2626; display: flex; align-items: center;">
                                <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>
                                Areas for Improvement
                            </h5>
                            <ul style="margin: 0; padding-left: 1.5rem; line-height: 1.6;">
                    `;
                    
                    data.areas_for_improvement.forEach(area => {
                        html += `<li style="margin-bottom: 0.5rem; color: #dc2626;">${area}</li>`;
                    });
                    
                    html += '</ul></div>';
                }
                
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }
        
        // Refresh benchmark data
        async function refreshBenchmarkData() {
            const refreshBtn = document.getElementById('refreshBenchmarkBtn');
            const originalText = refreshBtn.innerHTML;
            
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
            refreshBtn.disabled = true;
            
            try {
                // Trigger n8n workflow to get fresh industry benchmark data
                const response = await fetch('https://n8n.srv909550.hstgr.cloud/webhook/get-industry-benchmark', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) throw new Error('Failed to refresh benchmark data');
                
                // Wait a moment for the workflow to complete
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Reload benchmark data if industries are selected
                if (selectedIndustries.length > 0) {
                    await loadIndustryBenchmarks();
                }
                
                // Update last updated date
                await loadBenchmarkUpdateDate();
                
                alert('Benchmark data refreshed successfully! Note: Market data typically updates monthly.');
                
            } catch (error) {
                console.error('Error refreshing benchmark data:', error);
                alert('Error refreshing data. This may take a few minutes to process. Please try again later.');
            } finally {
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
            }
        }
        
        // Load last benchmark update date
        async function loadBenchmarkUpdateDate() {
            try {
                const { data, error } = await supabase
                    .from('industry_benchmarks')
                    .select('extraction_date')
                    .eq('is_active', true)
                    .order('extraction_date', { ascending: false })
                    .limit(1);
                    
                if (error) throw error;
                
                if (data && data.length > 0) {
                    const lastUpdate = new Date(data[0].extraction_date).toLocaleDateString();
                    document.getElementById('lastBenchmarkUpdate').textContent = lastUpdate;
                } else {
                    document.getElementById('lastBenchmarkUpdate').textContent = 'Never';
                }
                
            } catch (error) {
                console.error('Error loading benchmark update date:', error);
                document.getElementById('lastBenchmarkUpdate').textContent = 'Unknown';
            }
        }
        
        // Update the main switchReportsTab function to handle benchmarking
        function switchReportsTab(tabName) {
            // Store current comparisonData state before switching
            const savedComparisonData = comparisonData;
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.reports-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
            }
            
            // Hide all tab contents
            document.querySelectorAll('.reports-tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            // Show selected tab content (try both naming conventions)
            let targetTab = document.getElementById(`${tabName}-tab`);
            if (!targetTab) {
                targetTab = document.getElementById(`${tabName}-content`);
            }
            
            if (targetTab) {
                targetTab.classList.add('active');
                targetTab.style.display = 'block';
                
                // Restore comparisonData
                if (savedComparisonData) {
                    comparisonData = savedComparisonData;
                }
                
                // Initialize specific tab functionality
                if (tabName === 'revenue-opex-breakdown') {
                    if (comparisonData && comparisonData.current) {
                        renderRevenueOpexBreakdown();
                    } else {
                        targetTab.innerHTML = '<div class="no-data-message">Please generate a comparison report first from the P&L Comparison tab.</div>';
                    }
                } else if (tabName === 'trending-analysis') {
                    generateTrendingAnalysis();
                } else if (tabName === 'industry-benchmarking') {
                    initializeIndustryBenchmarking();
                } else if (tabName === 'pnl-comparison') {
                    // P&L comparison tab - ensure waterfall charts are displayed if comparisonData exists
                    if (comparisonData && comparisonData.current) {
                        renderWaterfallCharts();
                        renderExecutiveSummary();
                    }
                }
            }
        }

        // Export Functions for Industry Benchmarking
        async function exportBenchmarkPDF() {
            console.log('Generating PDF export...');
            
            if (selectedIndustries.length === 0) {
                alert('Please select at least one industry for comparison before exporting.');
                return;
            }
            
            // Show loading state
            const originalBtn = document.querySelector('button[onclick="exportBenchmarkPDF()"]');
            const originalText = originalBtn.innerHTML;
            originalBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
            originalBtn.disabled = true;
            
            try {
                // Create PDF content
                const pdfContent = generatePDFContent();
                
                // Generate PDF using jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // Add content to PDF
                await addContentToPDF(doc, pdfContent);
                
                // Generate filename
                const companyName = 'YourCompany'; // You can make this dynamic
                const date = new Date().toISOString().split('T')[0];
                const filename = `${companyName}_Industry_Benchmark_${date}.pdf`;
                
                // Save PDF
                doc.save(filename);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. Please try again.');
            } finally {
                originalBtn.innerHTML = originalText;
                originalBtn.disabled = false;
            }
        }
        
        // Generate PDF content structure
        function generatePDFContent() {
            const industries = selectedIndustries.map(ind => 
                ind.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())
            ).join(', ');
            
            return {
                title: 'Industry Benchmarking Report',
                subtitle: `Financial Performance Analysis vs ${industries}`,
                period: currentBenchmarkPeriod,
                date: new Date().toLocaleDateString(),
                companyMetrics: companyFinancialMetrics,
                industries: selectedIndustries,
                benchmarkData: industryBenchmarkData,
                summary: generateExecutiveSummary()
            };
        }
        
        // Add content to PDF with professional formatting
        async function addContentToPDF(doc, content) {
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            let yPosition = 20;
            
            // Header with company branding
            doc.setFillColor(30, 41, 59); // Dark blue
            doc.rect(0, 0, pageWidth, 40, 'F');
            
            // Company logo area (you can add actual logo later)
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('MontPro Financier', 20, 25);
            
            // Report title
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('INDUSTRY BENCHMARKING REPORT', pageWidth - 80, 25);
            doc.text(content.date, pageWidth - 80, 32);
            
            yPosition = 50;
            
            // Main title
            doc.setTextColor(30, 41, 59);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text(content.title, 20, yPosition);
            
            yPosition += 10;
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(content.subtitle, 20, yPosition);
            
            yPosition += 8;
            doc.setFontSize(10);
            doc.setTextColor(107, 114, 128);
            doc.text(`Analysis Period: ${content.period} | Generated: ${content.date}`, 20, yPosition);
            
            yPosition += 20;
            
            // Executive Summary Section
            doc.setTextColor(30, 41, 59);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Executive Summary', 20, yPosition);
            
            yPosition += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            // Add executive summary content
            const summaryLines = doc.splitTextToSize(content.summary, pageWidth - 40);
            doc.text(summaryLines, 20, yPosition);
            yPosition += summaryLines.length * 5 + 10;
            
            // Key Metrics Table
            yPosition = addKeyMetricsTable(doc, yPosition, content);
            
            // Performance Analysis
            yPosition = addPerformanceAnalysis(doc, yPosition, content);
            
            // Recommendations (if space allows)
            if (yPosition < pageHeight - 60) {
                addRecommendations(doc, yPosition, content);
            }
            
            // Footer
            addPDFFooter(doc);
        }
        
        // Add key metrics comparison table to PDF
        function addKeyMetricsTable(doc, startY, content) {
            let yPosition = startY;
            
            // Section header
            doc.setTextColor(30, 41, 59);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Key Financial Metrics Comparison', 20, yPosition);
            
            yPosition += 15;
            
            // Table setup
            const tableData = [
                ['Metric', 'Your Company', 'Percentile', 'Industry Median', 'Performance']
            ];
            
            const metrics = [
                { key: 'roe', label: 'Return on Equity', isPercent: true },
                { key: 'roa', label: 'Return on Assets', isPercent: true },
                { key: 'ebitda_margin', label: 'EBITDA Margin', isPercent: true },
                { key: 'net_margin', label: 'Net Margin', isPercent: true },
                { key: 'gross_margin', label: 'Gross Margin', isPercent: true },
                { key: 'current_ratio', label: 'Current Ratio', isPercent: false },
                { key: 'debt_to_equity', label: 'Debt-to-Equity', isPercent: false }
            ];
            
            metrics.forEach(metric => {
                const companyValue = content.companyMetrics[metric.key];
                const percentile = calculateMetricPercentile(metric.key, companyValue);
                const industryMedian = getIndustryMedianValue(metric.key);
                const performance = percentile >= 75 ? 'Excellent' : 
                                  percentile >= 25 ? 'Good' : 'Needs Improvement';
                
                const valueStr = metric.isPercent ? `${companyValue.toFixed(1)}%` : companyValue.toFixed(2);
                const medianStr = metric.isPercent ? `${industryMedian.toFixed(1)}%` : industryMedian.toFixed(2);
                
                tableData.push([
                    metric.label,
                    valueStr,
                    `${Math.round(percentile)}th`,
                    medianStr,
                    performance
                ]);
            });
            
            // Draw table
            doc.autoTable({
                head: [tableData[0]],
                body: tableData.slice(1),
                startY: yPosition,
                theme: 'grid',
                styles: {
                    fontSize: 9,
                    cellPadding: 3
                },
                headStyles: {
                    fillColor: [30, 41, 59],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 40 },
                    1: { halign: 'center', cellWidth: 25 },
                    2: { halign: 'center', cellWidth: 20 },
                    3: { halign: 'center', cellWidth: 25 },
                    4: { halign: 'center', cellWidth: 30 }
                }
            });
            
            return doc.lastAutoTable.finalY + 15;
        }
        
        // Add performance analysis section
        function addPerformanceAnalysis(doc, startY, content) {
            let yPosition = startY;
            
            doc.setTextColor(30, 41, 59);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Performance Analysis', 20, yPosition);
            
            yPosition += 10;
            
            // Generate key insights
            const insights = generateKeyInsights(content);
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            insights.forEach(insight => {
                const lines = doc.splitTextToSize(` ${insight}`, 170);
                doc.text(lines, 25, yPosition);
                yPosition += lines.length * 5 + 2;
            });
            
            return yPosition + 10;
        }
        
        // Add recommendations section
        function addRecommendations(doc, startY, content) {
            doc.setTextColor(30, 41, 59);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Strategic Recommendations', 20, startY);
            
            // Add placeholder recommendations
            const recommendations = [
                'Focus on improving operational efficiency to enhance EBITDA margins',
                'Review capital structure to optimize debt-to-equity ratio',
                'Implement working capital management strategies to improve liquidity ratios'
            ];
            
            let yPos = startY + 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            recommendations.forEach((rec, index) => {
                const lines = doc.splitTextToSize(`${index + 1}. ${rec}`, 170);
                doc.text(lines, 25, yPos);
                yPos += lines.length * 5 + 3;
            });
        }
        
        // Add PDF footer
        function addPDFFooter(doc) {
            const pageHeight = doc.internal.pageSize.getHeight();
            const pageWidth = doc.internal.pageSize.getWidth();
            
            doc.setFillColor(248, 250, 252);
            doc.rect(0, pageHeight - 20, pageWidth, 20, 'F');
            
            doc.setTextColor(107, 114, 128);
            doc.setFontSize(8);
            doc.text('Generated by MontPro Financier - Industry Benchmarking Module', 20, pageHeight - 10);
            doc.text(`Page 1 of 1`, pageWidth - 30, pageHeight - 10);
        }
        
        // Excel export function
        async function exportBenchmarkExcel() {
            console.log('Generating Excel export...');
            
            if (selectedIndustries.length === 0) {
                alert('Please select at least one industry for comparison before exporting.');
                return;
            }
            
            // Show loading state
            const originalBtn = document.querySelector('button[onclick="exportBenchmarkExcel()"]');
            const originalText = originalBtn.innerHTML;
            originalBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Excel...';
            originalBtn.disabled = true;
            
            try {
                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Create summary sheet
                const summaryData = createSummarySheetData();
                const summaryWS = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summaryWS, "Summary");
                
                // Create detailed metrics sheet
                const metricsData = createMetricsSheetData();
                const metricsWS = XLSX.utils.aoa_to_sheet(metricsData);
                XLSX.utils.book_append_sheet(wb, metricsWS, "Detailed Metrics");
                
                // Create industry benchmarks sheet
                const benchmarksData = createBenchmarksSheetData();
                const benchmarksWS = XLSX.utils.aoa_to_sheet(benchmarksData);
                XLSX.utils.book_append_sheet(wb, benchmarksWS, "Industry Benchmarks");
                
                // Generate filename
                const companyName = 'YourCompany';
                const date = new Date().toISOString().split('T')[0];
                const filename = `${companyName}_Industry_Benchmark_${date}.xlsx`;
                
                // Save file
                XLSX.writeFile(wb, filename);
                
            } catch (error) {
                console.error('Error generating Excel:', error);
                alert('Error generating Excel file. Please try again.');
            } finally {
                originalBtn.innerHTML = originalText;
                originalBtn.disabled = false;
            }
        }
        
        // Create summary sheet data for Excel
        function createSummarySheetData() {
            const data = [
                ['Industry Benchmarking Report'],
                [''],
                ['Generated:', new Date().toLocaleDateString()],
                ['Period:', currentBenchmarkPeriod],
                ['Industries:', selectedIndustries.join(', ')],
                [''],
                ['KEY METRICS SUMMARY'],
                ['Metric', 'Your Company', 'Percentile', 'Performance Rating'],
            ];
            
            const metrics = [
                { key: 'roe', label: 'Return on Equity (%)', isPercent: true },
                { key: 'roa', label: 'Return on Assets (%)', isPercent: true },
                { key: 'ebitda_margin', label: 'EBITDA Margin (%)', isPercent: true },
                { key: 'net_margin', label: 'Net Margin (%)', isPercent: true },
                { key: 'gross_margin', label: 'Gross Margin (%)', isPercent: true },
                { key: 'asset_turnover', label: 'Asset Turnover', isPercent: false },
                { key: 'current_ratio', label: 'Current Ratio', isPercent: false },
                { key: 'quick_ratio', label: 'Quick Ratio', isPercent: false },
                { key: 'debt_to_equity', label: 'Debt-to-Equity', isPercent: false }
            ];
            
            metrics.forEach(metric => {
                const companyValue = companyFinancialMetrics[metric.key];
                const percentile = calculateMetricPercentile(metric.key, companyValue);
                const performance = percentile >= 75 ? 'Excellent' : 
                                  percentile >= 25 ? 'Good' : 'Needs Improvement';
                
                const valueStr = metric.isPercent ? `${companyValue.toFixed(1)}%` : companyValue.toFixed(2);
                
                data.push([
                    metric.label,
                    valueStr,
                    `${Math.round(percentile)}th`,
                    performance
                ]);
            });
            
            return data;
        }
        
        // Create detailed metrics sheet data
        function createMetricsSheetData() {
            const data = [
                ['DETAILED INDUSTRY COMPARISON'],
                [''],
                ['Metric', 'Your Company', 'Percentile', ...selectedIndustries.map(ind => `${ind.replace('_', ' ')} Median`)]
            ];
            
            const metrics = [
                { key: 'roe', label: 'Return on Equity (%)', isPercent: true },
                { key: 'roa', label: 'Return on Assets (%)', isPercent: true },
                { key: 'ebitda_margin', label: 'EBITDA Margin (%)', isPercent: true },
                { key: 'net_margin', label: 'Net Margin (%)', isPercent: true },
                { key: 'gross_margin', label: 'Gross Margin (%)', isPercent: true },
                { key: 'asset_turnover', label: 'Asset Turnover', isPercent: false },
                { key: 'current_ratio', label: 'Current Ratio', isPercent: false },
                { key: 'quick_ratio', label: 'Quick Ratio', isPercent: false },
                { key: 'debt_to_equity', label: 'Debt-to-Equity', isPercent: false }
            ];
            
            metrics.forEach(metric => {
                const companyValue = companyFinancialMetrics[metric.key];
                const percentile = calculateMetricPercentile(metric.key, companyValue);
                const valueStr = metric.isPercent ? `${companyValue.toFixed(1)}%` : companyValue.toFixed(2);
                
                const row = [
                    metric.label,
                    valueStr,
                    `${Math.round(percentile)}th`
                ];
                
                // Add industry benchmark values
                selectedIndustries.forEach(industry => {
                    const industryData = industryBenchmarkData[industry];
                    const metricData = industryData?.find(d => d.metric_name === metric.key);
                    const medianValue = metricData?.median_value || 0;
                    const medianStr = metric.isPercent ? `${medianValue.toFixed(1)}%` : medianValue.toFixed(2);
                    row.push(medianStr);
                });
                
                data.push(row);
            });
            
            return data;
        }
        
        // Create benchmarks reference sheet
        function createBenchmarksSheetData() {
            const data = [
                ['INDUSTRY BENCHMARKS REFERENCE'],
                [''],
                ['Industry', 'Metric', 'Min', '25th %ile', 'Median', '75th %ile', 'Max']
            ];
            
            selectedIndustries.forEach(industry => {
                const industryData = industryBenchmarkData[industry];
                
                industryData.forEach(metric => {
                    data.push([
                        industry.replace('_', ' '),
                        metric.metric_name.replace('_', ' '),
                        metric.min_value.toFixed(2),
                        metric.q1_value.toFixed(2),
                        metric.median_value.toFixed(2),
                        metric.q3_value.toFixed(2),
                        metric.max_value.toFixed(2)
                    ]);
                });
            });
            
            return data;
        }
        
        // Helper functions for exports
        function generateExecutiveSummary() {
            const strongMetrics = [];
            const weakMetrics = [];
            
            Object.keys(companyFinancialMetrics).forEach(metric => {
                const percentile = calculateMetricPercentile(metric, companyFinancialMetrics[metric]);
                if (percentile >= 75) {
                    strongMetrics.push(metric.replace('_', ' '));
                } else if (percentile < 25) {
                    weakMetrics.push(metric.replace('_', ' '));
                }
            });
            
            let summary = `This analysis compares your company's financial performance against ${selectedIndustries.length} industry benchmark(s) for the ${currentBenchmarkPeriod} period. `;
            
            if (strongMetrics.length > 0) {
                summary += `Your company shows strong performance in: ${strongMetrics.join(', ')}. `;
            }
            
            if (weakMetrics.length > 0) {
                summary += `Areas for improvement include: ${weakMetrics.join(', ')}. `;
            }
            
            summary += 'Review the detailed metrics and recommendations below for specific action items.';
            
            return summary;
        }
        
        function generateKeyInsights(content) {
            const insights = [];
            
            // ROE insight
            const roePercentile = calculateMetricPercentile('roe', content.companyMetrics.roe);
            if (roePercentile >= 75) {
                insights.push('Your Return on Equity is in the top quartile, indicating excellent shareholder value creation.');
            } else if (roePercentile < 25) {
                insights.push('Return on Equity is below industry standards. Consider strategies to improve profitability or optimize capital structure.');
            }
            
            // Margin insight
            const netMarginPercentile = calculateMetricPercentile('net_margin', content.companyMetrics.net_margin);
            if (netMarginPercentile < 25) {
                insights.push('Net profit margins are below industry benchmarks. Focus on cost optimization and operational efficiency.');
            }
            
            // Liquidity insight
            const currentRatioPercentile = calculateMetricPercentile('current_ratio', content.companyMetrics.current_ratio);
            if (currentRatioPercentile < 25) {
                insights.push('Current ratio suggests potential liquidity concerns. Review working capital management strategies.');
            }
            
            return insights;
        }
        
        function getIndustryMedianValue(metricName) {
            if (selectedIndustries.length === 0) return 0;
            
            const medians = [];
            selectedIndustries.forEach(industry => {
                const industryData = industryBenchmarkData[industry];
                const metricData = industryData?.find(d => d.metric_name === metricName);
                if (metricData) {
                    medians.push(metricData.median_value);
                }
            });
            
            return medians.length > 0 ? medians.reduce((sum, val) => sum + val, 0) / medians.length : 0;
        }

        // NEW: Risk & Alert Management Functions
        function generateRiskAlerts() {
            console.log('=== GENERATING RISK ALERTS ===');
            console.log('aparTransactions length:', aparTransactions?.length || 'undefined');
            console.log('financialTransactions length:', financialTransactions?.length || 'undefined');
            
            try {
                // Cash Flow Alerts
                console.log('Generating cash flow alerts...');
                const cashFlowAlerts = generateCashFlowAlerts();
                console.log('Cash flow alerts generated:', cashFlowAlerts.length);
                updateAlertUI('cashFlowAlerts', 'cashFlowAlertCount', cashFlowAlerts);
                
                // AP/AR Alerts
                console.log('Generating AP/AR alerts...');
                const aparAlerts = generateAPARAlerts();
                console.log('AP/AR alerts generated:', aparAlerts.length);
                updateAlertUI('aparAlerts', 'aparAlertCount', aparAlerts);
                
                // Financial Health Alerts
                console.log('Generating financial health alerts...');
                const healthAlerts = generateFinancialHealthAlerts();
                console.log('Health alerts generated:', healthAlerts.length);
                updateAlertUI('healthAlerts', 'healthAlertCount', healthAlerts);
                
                // Budget alerts (async)
                console.log('Generating budget alerts...');
                generateBudgetAlertsAsync();
                
                console.log('Risk alerts generated successfully');
            } catch (error) {
                console.error('Error generating risk alerts:', error);
                
                // Set all to "No alerts" if there's an error
                updateAlertUI('cashFlowAlerts', 'cashFlowAlertCount', []);
                updateAlertUI('aparAlerts', 'aparAlertCount', []);
                updateAlertUI('healthAlerts', 'healthAlertCount', []);
                updateAlertUI('budgetAlerts', 'budgetAlertCount', []);
            }
        }

        async function generateBudgetAlertsAsync() {
            try {
                const budgetVariance = await calculateDashboardBudgetVariance();
                const alerts = [];
                
                if (budgetVariance.details) {
                    const { revenueVariance, opexVariance, ebitdaVariance } = budgetVariance.details;
                    
                    if (Math.abs(revenueVariance) > 15) {
                        alerts.push({
                            severity: revenueVariance < -15 ? 'high' : 'medium',
                            title: 'Revenue Variance Alert',
                            description: `YTD revenue ${revenueVariance >= 0 ? 'exceeds' : 'below'} budget`,
                            value: `${revenueVariance >= 0 ? '+' : ''}${revenueVariance.toFixed(1)}%`
                        });
                    }
                    
                    if (opexVariance > 20) {
                        alerts.push({
                            severity: 'medium',
                            title: 'OPEX Overspend Alert',
                            description: 'Operating expenses significantly over budget',
                            value: `+${opexVariance.toFixed(1)}%`
                        });
                    }
                    
                    if (ebitdaVariance < -25) {
                        alerts.push({
                            severity: 'high',
                            title: 'EBITDA Warning',
                            description: 'EBITDA significantly below budget target',
                            value: `${ebitdaVariance.toFixed(1)}%`
                        });
                    }
                }
                
                updateAlertUI('budgetAlerts', 'budgetAlertCount', alerts);
            } catch (error) {
                console.error('Error generating budget alerts:', error);
                updateAlertUI('budgetAlerts', 'budgetAlertCount', []);
            }
        }
        
        // Generate Cash Flow Alerts
        function generateCashFlowAlerts() {
            const alerts = [];
            
            try {
                // Check if we have the required data
                if (!aparTransactions || aparTransactions.length === 0) {
                    console.log('No AP/AR data available for cash flow alerts');
                    return alerts;
                }
                
                // Get cash flow forecast data - use existing cash flow chart data
                let forecastData = [];
                if (window.forecastData && window.forecastData.length > 0) {
                    forecastData = window.forecastData;
                } else {
                    // Generate simple forecast if not available
                    console.log('No forecast data available, skipping cash flow alerts');
                    return alerts;
                }
                
                // Check for negative cash positions in next 4 weeks
                const criticalWeeks = forecastData.slice(0, 4);
                criticalWeeks.forEach((week, index) => {
                    if (week.cashPosition < 0) {
                        alerts.push({
                            severity: 'high',
                            title: `Cash Shortfall in Week ${index + 1}`,
                            description: `Projected negative cash position`,
                            value: formatCurrencyFull(week.cashPosition, 'IDR')
                        });
                    } else if (week.cashPosition < 50000000) { // Less than 50M IDR
                        alerts.push({
                            severity: 'medium',
                            title: `Low Cash Warning - Week ${index + 1}`,
                            description: `Cash position below minimum threshold`,
                            value: formatCurrencyFull(week.cashPosition, 'IDR')
                        });
                    }
                });
                
                // If no specific alerts, add a general cash flow status
                if (alerts.length === 0) {
                    const currentCash = forecastData[0]?.cashPosition || 0;
                    if (currentCash > 100000000) {
                        alerts.push({
                            severity: 'low',
                            title: 'Cash Flow Healthy',
                            description: 'Sufficient cash reserves projected',
                            value: formatCurrencyFull(currentCash, 'IDR')
                        });
                    }
                }
                
            } catch (error) {
                console.error('Error generating cash flow alerts:', error);
            }
            
            return alerts.slice(0, 5); // Limit to 5 most critical alerts
        }
        
        // Generate AP/AR Alerts
        function generateAPARAlerts() {
            const alerts = [];
            
            try {
                if (!aparTransactions || aparTransactions.length === 0) {
                    console.log('No AP/AR transactions available for alerts');
                    return alerts;
                }
                
                // Find overdue AR
                const overdueAR = aparTransactions.filter(t => 
                    t.type === 'AR' && t.status === 'Overdue'
                );
                
                // Find overdue AP
                const overdueAP = aparTransactions.filter(t => 
                    t.type === 'AP' && t.status === 'Overdue'
                );
                
                // Add alerts for severely overdue AR (over 60 days)
                const severelyOverdueAR = overdueAR.filter(t => {
                    const daysOverdue = calculateDaysOverdue(t);
                    return daysOverdue > 60;
                }).slice(0, 2);
                
                severelyOverdueAR.forEach(transaction => {
                    alerts.push({
                        severity: 'high',
                        title: `Severely Overdue Invoice`,
                        description: `${transaction.company} - ${calculateDaysOverdue(transaction)} days overdue`,
                        value: formatCurrencyFull(transaction.amount, 'IDR')
                    });
                });
                
                // Add alerts for large overdue AP
                const largeOverdueAP = overdueAP.filter(t => Math.abs(t.amount) > 50000000).slice(0, 2);
                
                largeOverdueAP.forEach(transaction => {
                    alerts.push({
                        severity: 'medium',
                        title: `Large Overdue Payment`,
                        description: `${transaction.company} - ${calculateDaysOverdue(transaction)} days overdue`,
                        value: formatCurrencyFull(transaction.amount, 'IDR')
                    });
                });
                
                // Summary alert for total overdue amounts
                const totalOverdueAR = overdueAR.reduce((sum, t) => sum + Math.abs(t.amount), 0);
                const totalOverdueAP = overdueAP.reduce((sum, t) => sum + Math.abs(t.amount), 0);
                
                if (totalOverdueAR > 200000000) {
                    alerts.push({
                        severity: 'medium',
                        title: `High Total AR Overdue`,
                        description: `${overdueAR.length} overdue invoices`,
                        value: formatCurrencyFull(totalOverdueAR, 'IDR')
                    });
                }
                
                if (totalOverdueAP > 100000000) {
                    alerts.push({
                        severity: 'medium',
                        title: `High Total AP Overdue`,
                        description: `${overdueAP.length} overdue payments`,
                        value: formatCurrencyFull(totalOverdueAP, 'IDR')
                    });
                }
                
                // If no alerts, add positive message
                if (alerts.length === 0) {
                    alerts.push({
                        severity: 'low',
                        title: 'AP/AR Status Good',
                        description: 'No critical overdue items',
                        value: 'All accounts current'
                    });
                }
                
            } catch (error) {
                console.error('Error generating AP/AR alerts:', error);
            }
            
            return alerts.slice(0, 5);
        }
        
        // Generate Budget Alerts
        function generateBudgetAlerts() {
            const alerts = [];
            
            try {
                // Use the budget variance data we already calculated
                calculateDashboardBudgetVariance().then(budgetVariance => {
                    if (budgetVariance.details) {
                        const { revenueVariance, opexVariance, ebitdaVariance } = budgetVariance.details;
                        
                        // Revenue variance alert
                        if (Math.abs(revenueVariance) > 15) {
                            alerts.push({
                                severity: revenueVariance < -15 ? 'high' : 'medium',
                                title: 'Revenue Variance Alert',
                                description: `YTD revenue ${revenueVariance >= 0 ? 'exceeds' : 'below'} budget`,
                                value: `${revenueVariance >= 0 ? '+' : ''}${revenueVariance.toFixed(1)}%`
                            });
                        }
                        
                        // OPEX variance alert
                        if (opexVariance > 20) {
                            alerts.push({
                                severity: 'medium',
                                title: 'OPEX Overspend Alert',
                                description: 'Operating expenses significantly over budget',
                                value: `+${opexVariance.toFixed(1)}%`
                            });
                        }
                        
                        // EBITDA variance alert
                        if (ebitdaVariance < -25) {
                            alerts.push({
                                severity: 'high',
                                title: 'EBITDA Warning',
                                description: 'EBITDA significantly below budget target',
                                value: `${ebitdaVariance.toFixed(1)}%`
                            });
                        }
                    }
                    
                    // Update the budget alerts UI
                    updateAlertUI('budgetAlerts', 'budgetAlertCount', alerts);
                });
                
            } catch (error) {
                console.error('Error generating budget alerts:', error);
            }
            
            return []; // Return empty for now, will be populated async
        }
        
        // Generate Financial Health Alerts
        function generateFinancialHealthAlerts() {
            const alerts = [];
            
            try {
                // Calculate current financial health metrics
                const zScore = calculateAltmanZScore();
                const industryPosition = calculateDashboardIndustryPosition();
                
                // Altman Z-Score alerts
                if (zScore < 1.8) {
                    alerts.push({
                        severity: 'high',
                        title: 'Financial Distress Risk',
                        description: 'Altman Z-Score indicates distress zone',
                        value: `Score: ${zScore.toFixed(1)}`
                    });
                } else if (zScore < 3.0) {
                    alerts.push({
                        severity: 'medium',
                        title: 'Financial Health Caution',
                        description: 'Altman Z-Score in grey zone',
                        value: `Score: ${zScore.toFixed(1)}`
                    });
                }
                
                // Industry position alerts
                if (industryPosition.percentile < 25 && industryPosition.percentile > 0) {
                    alerts.push({
                        severity: 'medium',
                        title: 'Industry Performance Alert',
                        description: 'Below industry average performance',
                        value: `${industryPosition.percentile}th percentile`
                    });
                }
                
                // Calculate current financial metrics for additional alerts
                const currentYearData = calculateFinancialDataFromTransactions(
                    getTransactionsForPeriodFixed('YTD', 'custom'), 'YTD', 'custom'
                );
                
                // Low profitability alert
                const profitMargin = currentYearData.netRevenue > 0 ? 
                    ((currentYearData.netRevenue - currentYearData.opex) / currentYearData.netRevenue) * 100 : 0;
                
                if (profitMargin < 5 && profitMargin > -100) {
                    alerts.push({
                        severity: profitMargin < 0 ? 'high' : 'medium',
                        title: 'Low Profitability Warning',
                        description: 'Profit margin below healthy threshold',
                        value: `${profitMargin.toFixed(1)}%`
                    });
                }
                
            } catch (error) {
                console.error('Error generating financial health alerts:', error);
            }
            
            return alerts.slice(0, 5);
        }
        
        // Helper function to calculate days overdue
        function calculateDaysOverdue(transaction) {
            const today = new Date();
            let dueDate;
            
            if (transaction.due_date) {
                dueDate = new Date(transaction.due_date);
            } else if (transaction.invoice_date && transaction.payment_terms) {
                const invoiceDate = new Date(transaction.invoice_date);
                dueDate = new Date(invoiceDate);
                dueDate.setDate(dueDate.getDate() + (transaction.payment_terms || 30));
            } else {
                return 0;
            }
            
            const diffTime = today - dueDate;
            return Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
        }
        
        // Update Alert UI
        function updateAlertUI(containerId, countId, alerts) {
            const container = document.getElementById(containerId);
            const countElement = document.getElementById(countId);
            
            if (!container || !countElement) return;
            
            // Update count
            countElement.textContent = alerts.length > 0 ? `${alerts.length} alert${alerts.length !== 1 ? 's' : ''}` : 'No alerts';
            
            // Update content
            if (alerts.length === 0) {
                container.innerHTML = `
                    <div class="no-alerts">
                        <i class="fas fa-check-circle"></i>
                        All clear!
                    </div>
                `;
            } else {
                container.innerHTML = alerts.map(alert => `
                    <div class="alert-item">
                        <div class="alert-severity ${alert.severity}"></div>
                        <div class="alert-content">
                            <div class="alert-title">${alert.title}</div>
                            <div class="alert-description">${alert.description}</div>
                            <div class="alert-value">${alert.value}</div>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        // Refresh all risk alerts
        function refreshRiskAlerts() {
            console.log('Refreshing risk alerts...');
            
            // Show loading state
            ['cashFlowAlertCount', 'aparAlertCount', 'budgetAlertCount', 'healthAlertCount'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = 'Loading...';
            });
            
            // Generate alerts after a short delay
            setTimeout(() => {
                generateRiskAlerts();
            }, 500);
        }

        // NEW: Simplified P&L Functions for Dashboard
        async function updateDashboardPL() {
            const periodType = document.getElementById('dashboardPeriodSelect').value;
            
            try {
                // Get current period actual data
                const currentPeriodTransactions = getTransactionsForPeriodFixed(periodType, 'custom');
                const actualData = calculateFinancialDataFromTransactions(currentPeriodTransactions, periodType, 'custom');
                
                // Get budget data for the same period
                const budgetData = await getDashboardBudgetData(periodType);
                
                // Populate the simplified P&L table
                populateSimplifiedPLTable(actualData, budgetData, periodType);
                
            } catch (error) {
                console.error('Error updating dashboard P&L:', error);
            }
        }
        
        async function getDashboardBudgetData(periodType) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return null;
                
                const today = new Date();
                const currentYear = today.getFullYear();
                let monthsToInclude = [];
                
                // Determine which months to include based on period type
                switch(periodType) {
                    case 'MTD':
                        monthsToInclude = [today.getMonth() + 1];
                        break;
                    case 'QTD':
                        const currentQuarter = Math.floor(today.getMonth() / 3);
                        for (let i = 0; i < 3; i++) {
                            const month = currentQuarter * 3 + i + 1;
                            if (month <= today.getMonth() + 1) {
                                monthsToInclude.push(month);
                            }
                        }
                        break;
                    case 'YTD':
                    default:
                        for (let i = 1; i <= today.getMonth() + 1; i++) {
                            monthsToInclude.push(i);
                        }
                        break;
                }
                
                // Get budget data from the correct table (budgets)
                const { data: budgetData, error } = await supabase
                    .from('budgets')
                    .select('*')
                    .eq('user_id', user.id)
                    .eq('budget_year', currentYear)
                    .in('budget_month', monthsToInclude);
                    
                if (error) {
                    console.error('Error fetching dashboard budget data:', error);
                    return null;
                }
                
                return calculateBudgetTotalsFromBudgetsTable(budgetData || [], periodType);
                
            } catch (error) {
                console.error('Error in getDashboardBudgetData:', error);
                return null;
            }
        }
        
        function populateSimplifiedPLTable(actualData, budgetData, periodType) {
            const tbody = document.getElementById('simplifiedPLBody');
            if (!tbody) return;
            
            // Define the key P&L line items
            const lineItems = [
                {
                    label: 'Total Revenue',
                    actual: actualData.netRevenue,
                    budget: budgetData?.revenue || 0,
                    type: 'revenue'
                },
                {
                    label: 'Cost of Goods Sold',
                    actual: actualData.cogs,
                    budget: budgetData?.cogs || 0,
                    type: 'expense'
                },
                {
                    label: 'Gross Profit',
                    actual: actualData.grossProfit,
                    budget: (budgetData?.revenue || 0) - (budgetData?.cogs || 0),
                    type: 'profit'
                },
                {
                    label: 'Operating Expenses',
                    actual: actualData.opex,
                    budget: budgetData?.opex || 0,
                    type: 'expense'
                },
                {
                    label: 'EBITDA',
                    actual: actualData.ebitda,
                    budget: budgetData?.ebitda || 0,
                    type: 'profit'
                }
            ];
            
            // Generate table rows
            const rows = lineItems.map(item => {
                const variance = item.actual - item.budget;
                const variancePercent = item.budget !== 0 ? (variance / Math.abs(item.budget)) * 100 : 0;
                
                // Determine variance class based on item type
                let varianceClass = 'neutral';
                if (Math.abs(variancePercent) > 5) {
                    if (item.type === 'revenue' || item.type === 'profit') {
                        varianceClass = variance >= 0 ? 'positive' : 'negative';
                    } else { // expense
                        varianceClass = variance <= 0 ? 'positive' : 'negative';
                    }
                }
                
                return `
                    <tr>
                        <td class="pl-line-item">${item.label}</td>
                        <td class="pl-value">${formatCurrencyFull(item.actual, 'IDR')}</td>
                        <td class="pl-value">${formatCurrencyFull(item.budget, 'IDR')}</td>
                        <td class="pl-variance ${varianceClass}">${formatCurrencyFull(variance, 'IDR')}</td>
                        <td class="pl-variance ${varianceClass}">${variancePercent >= 0 ? '+' : ''}${variancePercent.toFixed(1)}%</td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows;
        }
        
        // NEW: Dashboard Trending Chart Functions
        function generateDashboardTrendingChart() {
            try {
                // Reuse existing trending logic but adapt for dashboard
                const monthsToInclude = 6; // Fixed to 6 months for dashboard
                
                // Calculate trending data using existing function
                const trendingData = calculateTrendingData(monthsToInclude);
                
                if (!trendingData || !trendingData.periods || trendingData.periods.length === 0) {
                    console.log('No trending data available for dashboard chart');
                    return;
                }
                
                // Find if there's an existing chart element in the dashboard
                // Look for common chart element IDs that might exist
                const possibleChartIds = [
                    'dashboardTrendingChart', 
                    'dashboardChart', 
                    'mainDashboardChart',
                    'overviewChart'
                ];
                
                let chartElement = null;
                for (const id of possibleChartIds) {
                    chartElement = document.getElementById(id);
                    if (chartElement) {
                        console.log(`Found chart element: ${id}`);
                        break;
                    }
                }
                
                if (!chartElement) {
                    console.log('No chart element found in dashboard - skipping trending chart');
                    return;
                }
                
                // Use existing renderTrendingChart function but with dashboard element
                const originalChart = document.getElementById('trendingChart');
                if (originalChart) {
                    // Temporarily point to dashboard element
                    originalChart.id = 'tempTrendingChart';
                    chartElement.id = 'trendingChart';
                    
                    // Render using existing function
                    renderTrendingChart(trendingData);
                    
                    // Restore original IDs
                    chartElement.id = possibleChartIds[0];
                    originalChart.id = 'trendingChart';
                }
                
                console.log('Dashboard trending chart generated successfully');
                
            } catch (error) {
                console.error('Error generating dashboard trending chart:', error);
            }
        }
        
        function generateDashboardTrendingInsights(data) {
            const container = document.getElementById('dashboardTrendingInsights');
            if (!container || !data || data.periods.length < 2) return;
            
            const insights = [];
            
            // Revenue trend analysis
            const revenueStart = data.revenue[0];
            const revenueEnd = data.revenue[data.revenue.length - 1];
            const revenueGrowth = revenueStart > 0 ? ((revenueEnd - revenueStart) / revenueStart) * 100 : 0;
            
            if (Math.abs(revenueGrowth) > 5) {
                insights.push({
                    icon: 'revenue',
                    text: `Revenue ${revenueGrowth >= 0 ? 'increased' : 'decreased'} by ${Math.abs(revenueGrowth).toFixed(1)}% over the last ${data.periods.length} periods`
                });
            }
            
            // OPEX trend analysis
            const opexStart = data.opex[0];
            const opexEnd = data.opex[data.opex.length - 1];
            const opexGrowth = opexStart > 0 ? ((opexEnd - opexStart) / opexStart) * 100 : 0;
            
            if (Math.abs(opexGrowth) > 5) {
                insights.push({
                    icon: 'expense',
                    text: `Operating expenses ${opexGrowth >= 0 ? 'increased' : 'decreased'} by ${Math.abs(opexGrowth).toFixed(1)}% over the same period`
                });
            }
            
            // Efficiency analysis
            const latestRevenue = revenueEnd;
            const latestOpex = opexEnd;
            const efficiency = latestRevenue > 0 ? (latestOpex / latestRevenue) * 100 : 0;
            
            if (efficiency > 0) {
                insights.push({
                    icon: 'trend',
                    text: `Current operating efficiency: ${efficiency.toFixed(1)}% OPEX-to-Revenue ratio ${efficiency < 70 ? '(Good)' : efficiency < 85 ? '(Monitor)' : '(Needs attention)'}`
                });
            }
            
            // Render insights
            container.innerHTML = `
                <h5><i class="fas fa-lightbulb"></i> Key Insights</h5>
                ${insights.map(insight => `
                    <div class="insight-item-dashboard">
                        <div class="insight-icon-dashboard ${insight.icon}">
                            <i class="fas fa-${insight.icon === 'revenue' ? 'arrow-up' : insight.icon === 'expense' ? 'arrow-down' : 'chart-line'}"></i>
                        </div>
                        <div class="insight-text-dashboard">${insight.text}</div>
                    </div>
                `).join('')}
            `;
        }
        
        // Export function for dashboard trending chart
        function exportDashboardTrendingChart() {
            if (window.dashboardTrendingChartInstance) {
                const url = window.dashboardTrendingChartInstance.toBase64Image();
                const link = document.createElement('a');
                link.download = 'dashboard-trending-chart.png';
                link.href = url;
                link.click();
            }
        }
        
        // Initialize dashboard components
        function initializeDashboardComponents() {
            try {
                // Initialize risk alerts
                generateRiskAlerts();
                
                // Initialize simplified P&L
                updateDashboardPL();
                
                // Initialize trending chart
                setTimeout(() => {
                    generateDashboardTrendingChart();
                }, 1000); // Delay to ensure data is loaded
                
            } catch (error) {
                console.error('Error initializing dashboard components:', error);
            }
        }

        // Export Revenue Breakdown function
        function exportRevenueBreakdown() {
            if (!comparisonData || !comparisonData.current) {
                alert('Please generate a comparison report first.');
                return;
            }
            
            try {
                const { current, previous } = comparisonData;
                
                // Create CSV content
                let csvContent = "Revenue Source,Current Period,Previous Period,Change,Percentage Contribution\n";
                
                // Helper function to get account balance from transactions
                function getAccountBalanceFromTransactions(periodData, accountCode) {
                    if (!periodData.transactions) return 0;
                    
                    return periodData.transactions
                        .filter(t => t.account_code === accountCode)
                        .reduce((sum, t) => sum + (t.credit_amount || 0) - (t.debit_amount || 0), 0);
                }
                
                // All revenue accounts
                const revenueAccounts = [
                    { name: 'Sales Revenue', code: '4010' },
                    { name: 'Service Revenue', code: '4020' },
                    { name: 'Interest Income', code: '4030' },
                    { name: 'Rental Income', code: '4040' },
                    { name: 'Other Income', code: '4050' },
                    { name: 'Sales Discounts', code: '4060' },
                    { name: 'Sales Returns and Allowances', code: '4070' },
                    { name: 'Gain on Sale of Assets', code: '4110' },
                    { name: 'Dividend Income', code: '4120' },
                    { name: 'Foreign Exchange Gain', code: '4130' }
                ];
                
                revenueAccounts.forEach(account => {
                    const currentAmount = getAccountBalanceFromTransactions(current, account.code);
                    const previousAmount = getAccountBalanceFromTransactions(previous, account.code);
                    
                    if (currentAmount !== 0 || previousAmount !== 0) {
                        const change = currentAmount - previousAmount;
                        const percentage = current.netRevenue > 0 ? 
                            ((Math.abs(currentAmount) / current.netRevenue) * 100).toFixed(1) : '0.0';
                        
                        csvContent += `${account.name},${formatCurrencyForExport(currentAmount)},${formatCurrencyForExport(previousAmount)},${formatCurrencyForExport(change)},${percentage}%\n`;
                    }
                });
                
                // Add total row
                const totalChange = current.netRevenue - previous.netRevenue;
                csvContent += `Total Revenue,${formatCurrencyForExport(current.netRevenue)},${formatCurrencyForExport(previous.netRevenue)},${formatCurrencyForExport(totalChange)},100.0%\n`;
                
                downloadCSVFile(csvContent, 'Revenue_Breakdown_Analysis.csv');
                
            } catch (error) {
                console.error('Error exporting revenue breakdown:', error);
                alert('Error exporting revenue breakdown: ' + error.message);
            }
        }
        
        // Export OPEX Breakdown function
        function exportOpexBreakdown() {
            if (!comparisonData || !comparisonData.current) {
                alert('Please generate a comparison report first.');
                return;
            }
            
            try {
                const { current, previous } = comparisonData;
                
                // Create CSV content
                let csvContent = "OPEX Category,Current Period,Previous Period,Change,Percentage Contribution\n";
                
                // Helper function to get account balance from transactions
                function getAccountBalanceFromTransactions(periodData, accountCodes) {
                    if (!periodData.transactions) return 0;
                    
                    return periodData.transactions
                        .filter(t => accountCodes.includes(t.account_code))
                        .reduce((sum, t) => sum + (t.debit_amount || 0) - (t.credit_amount || 0), 0);
                }
                
                // Expense categories with account codes
                const expenseCategories = [
                    {
                        name: 'Cost of Goods Sold',
                        accounts: ['5010', '5020', '5030']
                    },
                    {
                        name: 'Payroll & Benefits',
                        accounts: ['5100', '5110', '5120', '5130']
                    },
                    {
                        name: 'Facilities & Operations',
                        accounts: ['5200', '5210', '5220', '5230', '5240', '5250']
                    },
                    {
                        name: 'Marketing & Sales',
                        accounts: ['5300', '5310', '5320', '5330']
                    },
                    {
                        name: 'Professional Services',
                        accounts: ['5400', '5410', '5420', '5430', '5440']
                    },
                    {
                        name: 'Office & Administration',
                        accounts: ['5500', '5510', '5520', '5530', '5540', '5550']
                    },
                    {
                        name: 'Depreciation & Amortization',
                        accounts: ['5600', '5610']
                    },
                    {
                        name: 'Financial Expenses',
                        accounts: ['5700', '5710', '5720']
                    },
                    {
                        name: 'Travel & Transportation',
                        accounts: ['5800', '5810', '5820', '5830']
                    },
                    {
                        name: 'Training & Development',
                        accounts: ['5900', '5910', '5920']
                    },
                    {
                        name: 'Other Expenses',
                        accounts: ['5950', '5960', '5970']
                    },
                    {
                        name: 'Tax & Extraordinary',
                        accounts: ['6010', '6020', '6030']
                    }
                ];
                
                expenseCategories.forEach(category => {
                    const currentTotal = getAccountBalanceFromTransactions(current, category.accounts);
                    const previousTotal = getAccountBalanceFromTransactions(previous, category.accounts);
                    
                    if (currentTotal !== 0 || previousTotal !== 0) {
                        const change = currentTotal - previousTotal;
                        const percentage = current.opex > 0 ? 
                            ((currentTotal / current.opex) * 100).toFixed(1) : '0.0';
                        
                        csvContent += `${category.name},${formatCurrencyForExport(currentTotal)},${formatCurrencyForExport(previousTotal)},${formatCurrencyForExport(change)},${percentage}%\n`;
                    }
                });
                
                // Add total row
                const totalChange = current.opex - previous.opex;
                csvContent += `Total OPEX,${formatCurrencyForExport(current.opex)},${formatCurrencyForExport(previous.opex)},${formatCurrencyForExport(totalChange)},100.0%\n`;
                
                downloadCSVFile(csvContent, 'OPEX_Breakdown_Analysis.csv');
                
            } catch (error) {
                console.error('Error exporting OPEX breakdown:', error);
                alert('Error exporting OPEX breakdown: ' + error.message);
            }
        }
        
        // Helper function to format currency for CSV export
        function formatCurrencyForExport(amount) {
            return amount.toFixed(2);
        }

        // Save AI insights to localStorage
        function saveAIInsights(insights, timestamp = null) {
            try {
                const insightData = {
                    content: insights,
                    timestamp: timestamp || new Date().toISOString(),
                    company_metrics: companyFinancialMetrics,
                    selected_industries: selectedIndustries
                };
                
                localStorage.setItem('ai_strategic_insights', JSON.stringify(insightData));
                console.log('AI insights saved to localStorage');
            } catch (error) {
                console.error('Error saving AI insights:', error);
            }
        }
        
        // Load AI insights from localStorage
        function loadStoredAIInsights() {
            try {
                const storedData = localStorage.getItem('ai_strategic_insights');
                if (!storedData) return null;
                
                const insightData = JSON.parse(storedData);
                
                // Check if insights are not too old (optional - you can remove this check)
                const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 days in milliseconds
                const insightAge = new Date() - new Date(insightData.timestamp);
                
                if (insightAge > maxAge) {
                    console.log('Stored insights are too old, clearing...');
                    localStorage.removeItem('ai_strategic_insights');
                    return null;
                }
                
                return insightData;
            } catch (error) {
                console.error('Error loading stored AI insights:', error);
                return null;
            }
        }
        
        // Display stored insights
        function displayStoredInsights() {
            const storedInsights = loadStoredAIInsights();
            if (!storedInsights) return false;
            
            const advisorContent = document.getElementById('advisorContent');
            const generateBtn = document.getElementById('generateInsightsBtn');
            
            if (advisorContent && storedInsights.content) {
                // Display the stored insights
                advisorContent.innerHTML = storedInsights.content;
                advisorContent.style.display = 'block';
                
                // Update button to show it's regenerating
                if (generateBtn) {
                    generateBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Regenerate Insights';
                    generateBtn.disabled = false;
                }
                
                // Add a small indicator showing when insights were generated
                const timestampDiv = document.createElement('div');
                timestampDiv.style.cssText = `
                    text-align: center; 
                    color: #6b7280; 
                    font-size: 0.75rem; 
                    margin-top: 1rem; 
                    padding-top: 1rem; 
                    border-top: 1px solid #e5e7eb;
                `;
                timestampDiv.innerHTML = `<i class="fas fa-clock"></i> Generated: ${new Date(storedInsights.timestamp).toLocaleString()}`;
                advisorContent.appendChild(timestampDiv);
                
                console.log('Loaded stored AI insights');
                return true;
            }
            
            return false;
        }
        
        // Clear stored insights (optional function for user to clear manually)
        function clearStoredInsights() {
            localStorage.removeItem('ai_strategic_insights');
            const advisorContent = document.getElementById('advisorContent');
            const generateBtn = document.getElementById('generateInsightsBtn');
            
            if (advisorContent) {
                advisorContent.style.display = 'none';
            }
            
            if (generateBtn) {
                generateBtn.innerHTML = '<i class="fas fa-brain"></i> Generate AI Insights';
                generateBtn.disabled = false;
            }
            
            console.log('Cleared stored AI insights');
        }
        
    </script>

    <!-- Add Transaction Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Transaction</h3>
                <button class="modal-close" onclick="closeAddModal()">&times;</button>
            </div>
            <form id="addTransactionForm" onsubmit="addTransaction(event)">
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select class="form-select" id="transactionType" required>
                        <option value="">Select Type</option>
                        <option value="AR">Accounts Receivable (Money Coming In)</option>
                        <option value="AP">Accounts Payable (Money Going Out)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Currency</label>
                    <div class="currency-toggle">
                        <button type="button" class="currency-option active" data-currency="IDR" onclick="selectCurrency('IDR')">IDR (Rp )</button>
                        <button type="button" class="currency-option" data-currency="USD" onclick="selectCurrency('USD')">USD (Rp )</button>
                    </div>
                    <input type="hidden" id="transactionCurrency" value="IDR">
                </div>
                <div class="form-group">
                    <label class="form-label">Reference</label>
                    <input type="text" class="form-input" id="transactionReference" placeholder="INV-001 or BILL-001" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Company</label>
                    <input type="text" class="form-input" id="transactionCompany" placeholder="Customer or Vendor Name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-input" id="transactionDescription" placeholder="What is this for?" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Amount (Rp )</label>
                    <input type="number" class="form-input" id="transactionAmount" placeholder="0.00" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Invoice Date</label>
                    <input type="date" class="form-input" id="transactionInvoiceDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date <span style="color: #94a3b8; font-size: 0.75rem;">(optional - will auto-calculate if blank)</span></label>
                    <input type="date" class="form-input" id="transactionDueDate">
                </div>
                <div class="form-group">
                    <label class="form-label">Payment Terms (Days)</label>
                    <select class="form-select" id="transactionPaymentTerms">
                        <option value="0">Due on Receipt</option>
                        <option value="7">Net 7</option>
                        <option value="14">Net 14</option>
                        <option value="30" selected>Net 30</option>
                        <option value="60">Net 60</option>
                        <option value="90">Net 90</option>
                        <option value="custom">Custom</option>
                    </select>
                    <input type="number" class="form-input" id="customPaymentTerms" placeholder="Enter days" style="display: none; margin-top: 0.5rem;" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="transactionStatus" required>
                        <option value="Unpaid">Unpaid</option>
                        <option value="Paid">Paid</option>
                        <option value="Overdue">Overdue</option>
                        <option value="Partial">Partial</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Add Transaction</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Upload CSV Modal -->
    <div class="modal-overlay" id="uploadModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Upload CSV/Excel File</h3>
                <button class="modal-close" onclick="closeUploadModal()">&times;</button>
            </div>
            <div>
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #cbd5e1; margin-bottom: 1rem;"></i>
                    <p style="margin-bottom: 0.5rem; font-weight: 500;">Click to upload or drag and drop</p>
                    <p style="color: #64748b; font-size: 0.875rem;">CSV or Excel files only</p>
                    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleFileUpload(event)">
                </div>
                <div style="margin-top: 1.5rem;">
                    <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">Required Columns:</h4>
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 6px; font-size: 0.875rem;">
                        <code>Type, Description, Amount, Invoice_Date, Due_Date, Company, Status, Reference</code>
                    </div>
                    <button class="btn btn-secondary" onclick="downloadTemplate()" style="width: 100%; margin-top: 1rem;">
                        <i class="fas fa-download"></i>
                        Download Template
                    </button>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeUploadModal()" style="flex: 1;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Financing Modal - Fixed -->
    <div class="modal-overlay" id="financingModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="financingModalTitle">Add Financing/Investment</h3>
                <button class="modal-close" onclick="closeFinancingModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="financingForm">
                    <div class="form-group">
                        <label class="form-label">Financing Type</label>
                        <select class="form-select" id="financingType" onchange="updateFinancingDefaults()" required>
                            <option value="">Select Type</option>
                            <option value="loan">Bank Loan</option>
                            <option value="credit_line">Credit Line</option>
                            <option value="invoice_factoring">Invoice Factoring</option>
                            <option value="equity">Equity Injection</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Amount (IDR)</label>
                            <input type="number" class="form-input" id="financingAmount" step="1000000" min="1000000" required placeholder="50000000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Term (months)</label>
                            <input type="number" class="form-input" id="financingTerm" min="0" max="120" required placeholder="12">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Interest Rate (%)</label>
                            <input type="number" class="form-input" id="financingRate" step="0.1" min="0" max="50" required placeholder="8.5">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Available Date</label>
                            <input type="date" class="form-input" id="financingAvailableDate" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Purpose</label>
                        <input type="text" class="form-input" id="financingPurpose" required placeholder="Working capital, expansion, etc.">
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeFinancingModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Park for Scenario</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="addBudgetLineModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Budget Line Item</h3>
                <button class="modal-close" onclick="closeAddBudgetLineModal()">&times;</button>
            </div>
            <div class="modal-content" id="glAccountListContainer" style="max-height: 60vh; overflow-y: auto;">
                </div>
        </div>
    </div>
    
</body>
</html>
